<section class="tab scroll-area {{#if (eq tabs.primary 'combat')}}active{{/if}}" data-tab="combat" data-group="primary">

    {{!-- 1. 顶部：七维属性 (保持不变) --}}
    <div class="combat-header-seals">
        <div class="attr-group left">
            {{#each combatStats.attributesLeft as |stat|}}
            <div class="seal-box">
                <div class="seal-stamp" data-tooltip="{{stat.tooltip}}">
                    <span class="seal-label">{{stat.label}}</span>
                    <span class="seal-val">{{stat.total}}</span>
                </div>
                <div class="seal-assign" data-tooltip="{{localize 'XJZL.Combat.AssignHint'}}">
                    <input type="number" class="seal-assign-input" data-prop="system.stats.{{stat.key}}.assigned"
                        value="{{stat.assigned}}" placeholder="0">
                </div>
            </div>
            {{/each}}
        </div>

        <div class="wuxing-wrapper">
            {{#with combatStats.wuxing}}
            <div class="seal-box wuxing" data-tooltip="{{tooltip}}">
                <div class="wuxing-taiji"></div>
                <div class="wuxing-content">
                    <span class="wuxing-label">{{localize "XJZL.Stats.Wuxing"}}</span>
                    <span class="wuxing-num">{{total}}</span>
                </div>
            </div>
            {{/with}}

            {{#if system.stats.freePoints.total}}
            <div class="free-points-pill" data-tooltip="{{localize 'XJZL.Stats.FreePoints'}}">
                <i class="fas fa-plus-circle"></i> {{localize "XJZL.Combat.FreePointsRemaining"}}:
                {{system.stats.freePoints.total}}
            </div>
            {{/if}}
        </div>

        <div class="attr-group right">
            {{#each combatStats.attributesRight as |stat|}}
            <div class="seal-box">
                <div class="seal-stamp" data-tooltip="{{stat.tooltip}}">
                    <span class="seal-label">{{stat.label}}</span>
                    <span class="seal-val">{{stat.total}}</span>
                </div>
                <div class="seal-assign" data-tooltip="{{localize 'XJZL.Combat.AssignHint'}}">
                    <input type="number" class="seal-assign-input" data-prop="system.stats.{{stat.key}}.assigned"
                        value="{{stat.assigned}}" placeholder="0">
                </div>
            </div>
            {{/each}}
        </div>
    </div>

    {{!-- 2. 核心战斗仪表盘 --}}
    <div class="combat-dashboard">
        <div class="dashboard-bg"></div>

        {{!-- 罗盘布局容器 --}}
        <div class="compass-layout">

            {{!-- [左侧列：外功系 + 闪避] --}}
            <div class="compass-side-col left">

                {{!-- 概览视图 --}}
                <div class="dashboard-view main-view">
                    <!-- 1. 外功命中 -->
                    <div class="sat-card atk" data-tooltip="{{combatStats.hitWaigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.HitWaigong"}}</div>
                        <div class="sat-val">{{combatStats.hitWaigong.val}}</div>
                    </div>
                    <!-- 2. 外功暴击 -->
                    <div class="sat-card atk" data-tooltip="{{combatStats.critWaigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.CritWaigong"}}</div>
                        <div class="sat-val">{{combatStats.critWaigong.val}}</div>
                    </div>
                    <!-- 3. 外功防御 (从右边移过来) -->
                    <div class="sat-card def" data-tooltip="{{combatStats.defWaigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.DefWaigong"}}</div>
                        <div class="sat-val">{{combatStats.defWaigong.val}}</div>
                    </div>
                    <!-- 4. 闪避 (从右边移过来) -->
                    <div class="sat-card blk" data-tooltip="{{combatStats.dodge.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.Dodge"}}</div>
                        <div class="sat-val">{{combatStats.dodge.val}}</div>
                    </div>
                </div>

                {{!-- 详细视图 (切换显示) --}}
                <div class="dashboard-view detail-view">
                    <div class="detail-header">{{localize "XJZL.Combat.ResList"}}</div>
                    <div class="detail-scroll-container">
                        {{#each combatStats.resistances as |res|}}
                        <div class="detail-strip">
                            <span class="lbl">{{res.label}}</span>
                            <span class="val">{{res.total}}</span>
                        </div>
                        {{/each}}
                        {{!-- 这里的元素多了会自动滚动，且绝不会遮挡 Header --}}
                    </div>
                </div>
            </div>

            {{!-- [中间核心：切换按钮] --}}
            <div class="compass-core clickable"
                onclick="this.closest('.combat-dashboard').classList.toggle('details-mode')"
                data-tooltip="{{localize 'XJZL.Combat.ToggleDetailView'}}">

                <div class="core-content-normal">
                    <div class="core-stat-main">
                        <div class="core-label">{{localize "XJZL.Combat.Initiative"}}</div>
                        <div class="core-val">{{combatStats.initiative.val}}</div>
                    </div>
                    <div class="core-sub-stats">
                        <div class="sub-stat">
                            <div class="sub-val">{{combatStats.speed.val}}</div>
                            <div style="font-size:10px;">{{localize "XJZL.Combat.Speed"}}</div>
                        </div>
                        <div class="sub-stat">
                            <div class="sub-val">{{combatStats.kanpo.val}}</div>
                            <div style="font-size:10px;">{{localize "XJZL.Combat.Kanpo"}}</div>
                        </div>
                    </div>
                </div>

                <div class="core-content-detail">
                    <i class="fas fa-undo-alt" style="font-size:24px; color:var(--c-cinnabar); margin-bottom:5px;"></i>
                    <div style="font-weight:bold; font-size:14px; color:#555;">{{localize "XJZL.Combat.Return"}}</div>
                </div>
            </div>

            {{!-- [右侧列：内功系 + 格挡] --}}
            <div class="compass-side-col right">

                {{!-- 概览视图 --}}
                <div class="dashboard-view main-view">
                    <!-- 1. 内功命中 (从左边移过来) -->
                    <div class="sat-card atk" data-tooltip="{{combatStats.hitNeigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.HitNeigong"}}</div>
                        <div class="sat-val">{{combatStats.hitNeigong.val}}</div>
                    </div>
                    <!-- 2. 内功暴击 (从左边移过来) -->
                    <div class="sat-card atk" data-tooltip="{{combatStats.critNeigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.CritNeigong"}}</div>
                        <div class="sat-val">{{combatStats.critNeigong.val}}</div>
                    </div>
                    <!-- 3. 内功防御 -->
                    <div class="sat-card def" data-tooltip="{{combatStats.defNeigong.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.DefNeigong"}}</div>
                        <div class="sat-val">{{combatStats.defNeigong.val}}</div>
                    </div>
                    <!-- 4. 格挡 -->
                    <div class="sat-card blk" data-tooltip="{{combatStats.block.tooltip}}">
                        <div class="sat-label">{{localize "XJZL.Combat.Block"}}</div>
                        <div class="sat-val">{{combatStats.block.val}}</div>
                    </div>
                </div>

                {{!-- 详细视图 --}}
                <div class="dashboard-view detail-view">
                    <div class="detail-header">{{localize "XJZL.Combat.DmgList"}}</div>
                    <div class="detail-scroll-container">
                        {{#each combatStats.damages as |dmg|}}
                        <div class="detail-strip">
                            <span class="lbl">{{dmg.label}}</span>
                            <span class="val">{{dmg.total}}</span>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>

        </div>

        {{!-- 临时状态栏 (保持不变) --}}
        <div class="active-effects-row">
            {{#if temporaryEffects.length}}
            {{#each temporaryEffects as |effect|}}
            <div class="effect-chip {{#if effect.isSuppressed}}suppressed{{/if}}" data-tooltip="{{effect.description}}">
                <img src="{{effect.img}}" class="effect-icon">
                <span class="effect-label">{{effect.name}}</span>
                {{#if effect.duration.rounds}}
                <span class="effect-rounds">({{effect.duration.rounds}})</span>
                {{/if}}
                <a class="effect-delete" data-action="deleteEffect" data-id="{{effect.id}}"><i
                        class="fas fa-times"></i></a>
            </div>
            {{/each}}
            {{else}}
            <div class="no-effects-hint">{{localize "XJZL.Combat.NoEffects"}}</div>
            {{/if}}
        </div>

        {{!-- 武器等级条 (保持不变) --}}
        <div class="weapon-ranks-bar">
            {{#each combatStats.weaponRanks as |rank|}}
            <div class="rank-item" data-tooltip="{{rank.label}} {{localize 'XJZL.Combat.RankLevel'}}: {{rank.val}}">
                <span class="rank-char">{{rank.char}}</span>
                <span class="rank-val">{{rank.val}}</span>
            </div>
            {{/each}}
        </div>
    </div>

    {{!-- 3. 架招与被动 + 士气 --}}
    <div class="hud-bottom-row">

        {{!-- 左侧容器：靠右对齐 --}}
        <div class="hud-side-wrapper left">
            {{#if activeStance}}
            <div class="stance-small-card"
                data-tooltip="{{#if activeStance.description}}{{activeStance.description}}{{else}}{{activeStance.automationNote}}{{/if}}">
                <div class="stance-icon"><i class="fas fa-user-shield"></i></div>
                <div class="stance-content">
                    <div class="label">{{localize "XJZL.Martial.Stance"}}</div>
                    <div class="name">{{activeStance.name}}</div>
                </div>
                <a class="stop-stance-btn" data-action="stopStance" title="{{localize 'XJZL.Martial.StopStance'}}"><i
                        class="fas fa-times"></i></a>
            </div>
            {{else}}
            <div class="stance-small-card empty">
                <div class="stance-icon"><i class="fas fa-user-shield"></i></div>
                <div class="stance-content">
                    <div class="label">{{localize "XJZL.Martial.NoStance"}}</div>
                </div>
            </div>
            {{/if}}
        </div>

        {{!-- 中间：战意 (Morale) - 绝对居中 --}}
        <div class="morale-trigger {{#if (gt system.resources.morale.value 0)}}active{{/if}}"
            data-tooltip="{{localize 'XJZL.Combat.MoraleHint'}}">

            {{!-- 火焰图标 --}}
            <div class="fire-icon-wrapper">
                <i class="fas fa-fire-alt"></i>
            </div>

            {{!-- 数值输入框 (直接作为显示体) --}}
            <input type="number" class="morale-input" name="system.resources.morale.value"
                value="{{system.resources.morale.value}}" min="0" max="100">
        </div>

        {{!-- 右侧容器：靠左对齐 --}}
        <div class="hud-side-wrapper right">
            {{#if passiveEffects.length}}
            <details class="passive-effects-pill">
                <summary>
                    <i class="fas fa-shield-alt"></i> {{localize "XJZL.Combat.PassiveLabel"}}
                    ({{passiveEffects.length}})
                </summary>
                <div class="passive-list">
                    {{#each passiveEffects as |effect|}}
                    <div class="passive-item {{#if effect.isSuppressed}}suppressed{{/if}}"
                        data-tooltip="{{#if effect.isSuppressed}}{{localize 'XJZL.UI.StatusDisabled'}}{{else}}{{effect.name}}: {{effect.description}}{{/if}}">
                        <img src="{{effect.img}}">
                        <span>{{effect.name}}</span>
                    </div>
                    {{/each}}
                </div>
            </details>
            {{/if}}
        </div>
    </div>

    {{!-- 4. 底部战术区 (保持不变) --}}
    <div class="combat-actions-area">
        <div class="action-buttons-row">
            <button type="button" class="action-btn-large attack" data-action="rollBasicAttack">
                <div class="btn-bg"></div>
                <span class="btn-label">{{localize "XJZL.Combat.BasicAttack"}}</span>
            </button>
            <button type="button" class="action-btn-large opportunity" data-action="rollOpportunityAttack">
                <div class="btn-bg"></div>
                <span class="btn-label">{{localize "XJZL.Combat.OpportunityAttack"}}</span>
            </button>
        </div>

        <div class="section-title-row">
            <span class="title-text" style="font-size:16px;">{{localize "XJZL.Combat.PinnedMoves"}}</span>
            <div class="title-line"></div>
        </div>

        <div class="pinned-moves-grid">
            {{#each pinnedMoves as |move|}}
            <!-- 复用 .move-card 实现样式统一 -->
            <div class="move-card" data-type="{{move.type}}" data-is-ultimate="{{move.isUltimate}}"
                data-tooltip="{{{move.tooltip}}}">

                <!-- 1. 顶部: 名字与所属武学 -->
                <div class="move-top">
                    <div class="move-name clickable-link" data-action="editItem" data-item-id="{{move.itemId}}"
                        data-tooltip="{{localize 'XJZL.Cultivation.EditWuxue'}}">
                        {{move.name}}
                    </div>
                    <!-- 右上角显示所属武学名字 (淡色) -->
                    <div
                        style="font-size:9px; color:rgba(0,0,0,0.4); margin-left:4px; max-width:60px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        {{move.parentName}}
                    </div>
                </div>

                <!-- 2. 信息行: 等级 & 伤害 -->
                <div class="move-stats">
                    <span>Lv.{{move.computedLevel}}</span>
                    {{#if move.derived.damage}}
                    <span class="move-dmg-preview" data-tooltip="{{{move.derived.breakdownTooltip}}}">
                        {{localize "XJZL.Combat.DmgPreview"}}: {{move.derived.damage}}
                    </span>
                    {{/if}}
                </div>

                <!-- 3. 消耗图标 -->
                <div class="move-cost-row">
                    {{#if move.currentCost.mp}}
                    <span style="color:#3498db" data-tooltip="{{localize 'XJZL.Wuxue.Cost.MP'}}"><i
                            class="fas fa-tint"></i>
                        {{move.currentCost.mp}}</span>
                    {{/if}}
                    {{#if move.currentCost.rage}}
                    <span style="color:#e74c3c" data-tooltip="{{localize 'XJZL.Wuxue.Cost.Rage'}}"><i
                            class="fas fa-fire"></i>
                        {{move.currentCost.rage}}</span>
                    {{/if}}
                </div>

                <!-- 4. 底部工具栏 (简化版) -->
                <!-- margin-top: auto 确保按钮始终沉底 -->
                <div class="move-toolbar"
                    style="margin-top: auto; padding-top:6px; border-top:1px dashed rgba(0,0,0,0.1);">

                    <!-- 发招 -->
                    <a class="btn-icon-action roll" data-action="rollMove" data-item-id="{{move.itemId}}"
                        data-move-id="{{move.moveId}}" data-tooltip="{{localize 'XJZL.Cultivation.RollMove'}}">
                        <i class="fas fa-dice-d20"></i>
                    </a>

                    <!-- 发送详情 -->
                    <a class="btn-icon-action" data-action="postMove" data-item-id="{{move.itemId}}"
                        data-move-id="{{move.moveId}}" data-tooltip="{{localize 'XJZL.Cultivation.PostItem'}}">
                        <i class="fas fa-comment-alt"></i>
                    </a>

                    <!-- 占位符挤开 -->
                    <div style="flex:1;"></div>

                    <!-- 取消常用 (Unpin) -->
                    <a class="btn-icon-action" data-action="togglePin" data-item-id="{{move.itemId}}"
                        data-move-id="{{move.moveId}}" data-tooltip="{{localize 'XJZL.Combat.Unpin'}}">
                        <i class="fas fa-times" style="color: #e74c3c;"></i>
                    </a>
                </div>
            </div>
            {{else}}
            <div class="empty-pinned-hint">
                {{localize "XJZL.Combat.NoPinnedMoves"}}
            </div>
            {{/each}}
        </div>
    </div>
</section>