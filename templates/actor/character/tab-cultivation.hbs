<section class="tab scroll-area {{#if (eq tabs.primary 'cultivation')}}active{{/if}}" data-tab="cultivation"
    data-group="primary">

    <div class="cultivation-container">
        <div class="cultivation-bg"></div>

        {{!-- 1. 顶部 Header (保持不变) --}}
        <div class="cultivation-header">
            <div class="pools-container">
                <div class="xp-pool general" data-tooltip="XJZL.Cultivation.General">
                    <span class="pool-label">通用</span>
                    <span class="pool-val">{{system.cultivation.general}}</span>
                </div>
                <div class="xp-pool neigong" data-tooltip="XJZL.Cultivation.Neigong">
                    <span class="pool-label">内修</span>
                    <span class="pool-val">{{system.cultivation.neigong}}</span>
                </div>
                <div class="xp-pool wuxue" data-tooltip="XJZL.Cultivation.Wuxue">
                    <span class="pool-label">武修</span>
                    <span class="pool-val">{{system.cultivation.wuxue}}</span>
                </div>
                <div class="xp-pool arts" data-tooltip="XJZL.Cultivation.Arts">
                    <span class="pool-label">艺修</span>
                    <span class="pool-val">{{system.cultivation.arts}}</span>
                </div>
            </div>
            <div class="cultivation-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="cultivation-search-input" placeholder="搜索..." />
                </div>
                <button class="btn-manage-xp" data-action="manageXP" data-tooltip="手动修改修为 & 审计">
                    <i class="fas fa-book-medical"></i>
                </button>
            </div>
        </div>

        {{!-- 2. 内功心法 (Neigong) --}}
        <div class="cultivation-section">
            <details open>
                <summary class="section-title-row clickable">
                    <span class="title-text">内功心法</span>
                    <div class="title-line"></div>
                    <i class="fas fa-minus collapse-icon"></i>
                </summary>

                <div class="neigong-grid">
                    {{#each neigongs as |item|}}
                    <div class="neigong-card {{#if item.isRunning}}active{{/if}}" data-element="{{item.system.element}}"
                        data-tier="{{item.system.tier}}" data-tooltip="{{{item.xpTooltip}}}">

                        <div class="ng-icon-wrapper" data-action="editItem" data-item-id="{{item.id}}">
                            <img class="ng-icon-bg" src="{{item.img}}" />
                            {{!-- 进度条高度 --}}
                            <div class="ng-icon-fill-container" style="height: {{item.system.progressData.percent}}%;">
                                <img class="ng-icon-fill" src="{{item.img}}" />
                            </div>

                            {{#if item.isRunning}}
                            <div class="ng-active-glow"></div>
                            {{/if}}
                        </div>

                        <div class="ng-content">
                            <span class="ng-name" data-action="editItem" data-item-id="{{item.id}}">{{item.name}}</span>
                            <div class="ng-meta">
                                {{item.system.xpInvested}} / {{item.system.progressData.absoluteMax}}
                            </div>
                        </div>

                        <div class="ng-actions">
                            <a class="btn-icon-circle toggle" data-action="toggleNeigong" data-item-id="{{item.id}}"
                                data-tooltip="{{#if item.isRunning}}停止运功{{else}}开始运功{{/if}}">
                                <i class="fas {{#if item.isRunning}}fa-snowflake{{else}}fa-fire{{/if}}"></i>
                            </a>
                            <a class="btn-icon-circle" data-action="investXP" data-item-id="{{item.id}}"
                                data-tooltip="修炼 (+XP)">
                                <i class="fas fa-arrow-up"></i>
                            </a>
                            <a class="btn-icon-circle" data-action="refundXP" data-item-id="{{item.id}}"
                                data-tooltip="散功 (-XP)">
                                <i class="fas fa-undo"></i>
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </details>
        </div>

        {{!-- 3. 武学招式 (Wuxue) --}}
        <div class="cultivation-section">
            <details open>
                <summary class="section-title-row clickable">
                    <span class="title-text">武学招式</span>
                    <div class="title-line"></div>
                    <i class="fas fa-minus collapse-icon"></i>
                </summary>

                <div class="wuxue-list">
                    {{#each wuxues as |wuxue|}}
                    <div class="wuxue-group" data-name="{{wuxue.name}}">
                        <details open>
                            <summary class="wuxue-header">
                                <h3 class="wuxue-name-link" data-action="editItem" data-item-id="{{wuxue.id}}"
                                    data-tooltip="查看武学详情">
                                    {{wuxue.name}}
                                </h3>
                                <span class="realm-badge">{{wuxue.system.tierLabel}}</span>
                            </summary>

                            <div class="moves-grid">
                                {{#each wuxue.system.moves as |move|}}
                                <div class="move-card" data-name="{{move.name}}">
                                    <div class="move-top">
                                        <div class="move-name">{{move.name}}</div>
                                        <a class="move-pin {{#if move.isPinned}}active{{/if}}" data-action="togglePin"
                                            data-item-id="{{wuxue.id}}" data-move-id="{{move.id}}">
                                            <i class="fas {{#if move.isPinned}}fa-star{{else}}fa-star{{/if}}"></i>
                                        </a>
                                    </div>
                                    <div class="move-stats">
                                        <span>Lv.{{move.computedLevel}}</span>
                                        {{#if move.derived.damage}}<span>Dmg: {{move.derived.damage}}</span>{{/if}}
                                    </div>
                                    <div class="move-progress" data-tooltip="XP: {{move.xpInvested}}">
                                        <div class="fill" style="width: {{move.percent}}%;"></div>
                                    </div>
                                    <div class="move-toolbar">
                                        <a class="btn-icon-action roll" data-action="rollMove"
                                            data-item-id="{{wuxue.id}}" data-move-id="{{move.id}}" data-tooltip="发招">
                                            <i class="fas fa-dice-d20"></i> 发招
                                        </a>
                                        <div style="flex:1;"></div>
                                        <a class="btn-icon-action" data-action="investMoveXP"
                                            data-item-id="{{wuxue.id}}" data-move-id="{{move.id}}" data-tooltip="修炼">
                                            <i class="fas fa-arrow-up"></i>
                                        </a>
                                        <a class="btn-icon-action" data-action="refundMoveXP"
                                            data-item-id="{{wuxue.id}}" data-move-id="{{move.id}}" data-tooltip="散功">
                                            <i class="fas fa-undo"></i>
                                        </a>
                                    </div>
                                </div>
                                {{/each}}
                            </div>
                        </details>
                    </div>
                    {{/each}}
                </div>
            </details>
        </div>

        {{!-- 4. 技艺研读 (Arts) --}}
        <div class="cultivation-section">
            <details open>
                <summary class="section-title-row clickable">
                    <span class="title-text">技艺经籍</span>
                    <div class="title-line"></div>
                    <i class="fas fa-minus collapse-icon"></i>
                </summary>

                <div class="inventory-grid-container"
                    style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                    {{#each artBooks as |item|}}
                    <div class="item-grid-card">
                        <div class="card-icon" data-action="editItem" data-item-id="{{item.id}}" data-tooltip="查看详情">
                            <img src="{{item.img}}" />
                        </div>
                        <div class="card-info">
                            <div class="item-name" data-action="editItem" data-item-id="{{item.id}}">{{item.name}}</div>
                            <div class="quality-text">XP: {{item.system.xpInvested}}</div>
                        </div>
                        <div class="card-actions" style="display:flex;">
                            <a data-action="investArtXP" data-item-id="{{item.id}}" data-tooltip="研读"><i
                                    class="fas fa-book-reader"></i></a>
                            <a data-action="refundArtXP" data-item-id="{{item.id}}" data-tooltip="放弃"><i
                                    class="fas fa-undo"></i></a>
                            <a data-action="postItem" data-item-id="{{item.id}}"><i class="fas fa-comment"></i></a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </details>
        </div>

    </div>
</section>