{{!-- templates/actor/character/header.hbs --}}
<div>
  {{!-- 1. 顶部身份区 --}}
  <div class="sidebar-identity-v2">

    {{!-- A. 立绘区 --}}
    <div class="portrait-area-v2">
      {{!-- 立绘本体 (点击触发编辑) --}}
      <div class="portrait-box realm-{{system.cultivation.realmLevel}}" data-action="editImage"
        data-tooltip="{{localize 'XJZL.UI.EditImage'}}">
        <img src="{{document.img}}" class="portrait-img">
        <div class="portrait-gradient"></div>
        <div class="portrait-glow"></div>
      </div>

      {{!-- [修复] 称号挂牌 (移出 portrait-box，独立响应点击) --}}
      <div class="portrait-title-tag" data-tooltip="{{localize 'XJZL.Info.Title'}}">
        <input type="text" name="system.info.title" value="{{system.info.title}}"
          placeholder="{{localize 'XJZL.Info.Title'}}">
      </div>

      {{!-- 印章行 --}}
      <div class="stamps-row-overlay">
        <div class="sect-seal-wrapper" data-tooltip="{{localize 'XJZL.Info.Sect'}}">
          <select name="system.info.sect" class="sect-select">
            {{selectOptions choices.sects selected=system.info.sect localize=true}}
          </select>
        </div>

        <div class="realm-tag" data-tooltip="{{localize 'XJZL.Cultivation.Realm'}}">
          {{#if (gte system.cultivation.realmLevel 0)}}
          {{localize (concat "XJZL.Realm." system.cultivation.realmLevel)}}
          {{else}}
          {{localize "XJZL.Realm.0"}}
          {{/if}}
        </div>
      </div>
    </div>

    {{!-- B. 文本信息区 --}}
    <div class="identity-details-v2">
      <div class="char-info-row">
        <input type="text" name="name" class="char-name-input" value="{{document.name}}"
          placeholder="{{localize 'XJZL.Info.Name'}}">
        <input type="text" name="system.info.zi" class="char-zi-input" value="{{system.info.zi}}"
          placeholder="{{localize 'XJZL.Info.Zi'}}">
        <select name="system.info.gender" class="char-gender-select" data-tooltip="{{localize 'XJZL.Info.Gender'}}">
          {{selectOptions choices.genders selected=system.info.gender localize=true}}
        </select>
      </div>
    </div>
  </div>

  {{!-- 2. 核心维生区 --}}
  <div class="sidebar-vitals">
    <div class="vital-group hp-group">
      <div class="vital-label-row">
        <label><i class="fas fa-heartbeat"></i> {{localize "XJZL.Resources.HP"}}</label>
        <div class="life-tools-inline">
          <a data-action="queryDisability" data-tooltip="{{localize 'XJZL.Disability.QueryTitle'}}"><i
              class="fas fa-search"></i></a>
          <a data-action="rollDisability" class="danger"
            data-tooltip="{{localize 'XJZL.UI.Chat.DeathCard.RollDisability'}}"><i class="fas fa-crutch"></i></a>
          <a data-action="rollDeathSave" class="critical"
            data-tooltip="{{localize 'XJZL.UI.Chat.DeathCard.DeathSave'}}"><i class="fas fa-skull"></i></a>
        </div>
        <div class="vital-values">
          <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}" class="val-input">
          <span class="sep">/</span>
          <input type="number" class="val-input max readonly" value="{{system.resources.hp.max}}" readonly>
        </div>
      </div>
      <div class="ink-track">
        {{#if (gt system.resources.huti 0)}}
        <div class="huti-overlay" style="width: {{percents.hp}}%;"
          data-tooltip="{{localize 'XJZL.Resources.Huti'}}: {{system.resources.huti}}"></div>
        {{/if}}
        <div class="ink-fill red" style="width: {{percents.hp}}%;"></div>
      </div>
    </div>

    <div class="vital-group mp-group">
      <div class="vital-label-row">
        <label><i class="fas fa-yin-yang"></i> {{localize "XJZL.Resources.MP"}}</label>
        <div class="vital-values">
          <input type="number" name="system.resources.mp.value" value="{{system.resources.mp.value}}" class="val-input">
          <span class="sep">/</span>
          <input type="number" class="val-input max readonly" value="{{system.resources.mp.max}}" readonly>
        </div>
      </div>
      <div class="ink-track">
        <div class="ink-fill blue" style="width: {{percents.mp}}%;"></div>
      </div>
    </div>

    <div class="vital-group rage-group">
      <div class="vital-label-row">
        <label><i class="fas fa-fire"></i> {{localize "XJZL.Resources.Rage"}}</label>
        <div class="vital-values">
          <input type="number" name="system.resources.rage.value" value="{{system.resources.rage.value}}"
            class="val-input">
          <span class="sep">/</span>
          <span class="max-val">10</span>
        </div>
      </div>
      <div class="rage-track">
        <div class="rage-fill" style="width: {{percents.rage}}%;"></div>
      </div>
    </div>
  </div>

  {{!-- 3. 状态监控 --}}
  <div class="sidebar-states">
    <details class="state-details-box">
      <summary>
        <div class="state-icon"><i class="fas fa-bahai"></i></div>
        <div class="state-info">
          <label>{{localize "XJZL.Resources.ActiveNeigong"}}</label>
          <div class="val">{{#if activeNeigongName}}{{activeNeigongName}}{{else}}{{localize
            "XJZL.Resources.ActiveNeigongNone"}}{{/if}}</div>
        </div>
        <i class="fas fa-caret-down toggle-icon"></i>
      </summary>
      <div class="details-content">
        {{#if activeNeigongName}}
        <p>{{activeNeigongDesc}}</p>
        {{else}}
        <p class="empty-hint">{{localize "XJZL.Neigong.NoActiveDescription"}}</p>
        {{/if}}
      </div>
    </details>

    <details class="state-details-box">
      <summary>
        <div class="state-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="state-info">
          <label>{{localize "XJZL.Martial.Stance"}}</label>
          <div class="val {{#if activeStance}}highlight{{/if}}">
            {{#if activeStance}}{{activeStance.name}}{{else}}{{localize "XJZL.Martial.NoStance"}}{{/if}}
          </div>
        </div>
        {{#if activeStance}}
        <a data-action="stopStance" class="stop-btn"><i class="fas fa-times"></i></a>
        {{/if}}
      </summary>
      {{#if activeStance}}
      <div class="details-content">
        <p>{{activeStance.description}}</p>
      </div>
      {{/if}}
    </details>
  </div>
</div>