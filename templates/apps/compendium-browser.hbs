<div class="xjzl-cb-root">
    {{#if isLoaded}}

    <!-- 1. 导航栏 -->
    <nav class="xjzl-cb-nav">
        {{#each tabs}}
        <button type="button" class="xjzl-cb-tab-btn {{#if (eq ../activeTab this.id)}}active{{/if}}"
            data-action="changeTab" data-tab="{{this.id}}">
            <i class="{{this.icon}}"></i> {{this.label}}
        </button>
        {{/each}}

        <button type="button" data-action="refresh" class="xjzl-cb-tab-btn" style="margin-left: auto;" title="刷新数据">
            <i class="fas fa-sync-alt"></i>
        </button>
    </nav>

    <div class="xjzl-cb-body">

        <!-- 2. 左侧筛选栏 -->
        <aside class="xjzl-cb-sidebar">
            <!-- 搜索框 -->
            <div class="xjzl-cb-search-box">
                <i class="fas fa-search"></i>
                <input type="text" name="search" value="{{searchQuery}}" placeholder="搜索名称..." autocomplete="off">
                {{#if searchQuery}}
                <a data-action="resetFilters" title="清除"><i class="fas fa-times"></i></a>
                {{/if}}
            </div>

            <div class="xjzl-cb-filter-header">
                <span><i class="fas fa-filter"></i> 筛选</span>
                <a class="reset-link" data-action="resetFilters">重置</a>
            </div>

            <!-- 动态生成筛选器 -->
            <div class="xjzl-cb-filters-list">
                {{#each filterList}}
                <div class="filter-group">
                    <div class="filter-title">{{this.label}}</div>
                    <div class="filter-options">
                        {{#each this.options}}
                        <label class="checkbox-label {{#if this.checked}}checked{{/if}}">
                            <input type="checkbox" class="xjzl-filter-checkbox" data-filter="{{../key}}"
                                value="{{this.val}}" {{checked this.checked}}>
                            {{this.label}}
                        </label>
                        {{/each}}
                    </div>
                </div>
                {{else}}
                <p class="no-filters">当前分类无高级筛选</p>
                {{/each}}
            </div>

            <!-- 随机按钮区域 -->
            <div class="xjzl-cb-sidebar-footer">
                <button type="button" class="random-btn" data-action="randomize">
                    <i class="fas fa-dice-d20"></i> 随机抽取
                </button>
            </div>
        </aside>

        <!-- 3. 右侧结果 -->
        <main class="xjzl-cb-content">
            <div class="xjzl-cb-stats-bar">
                <span>共找到 <strong>{{totalCount}}</strong> 件物品
                    {{#if isClipped}}<span class="warning">(仅显示前 {{displayCount}} 件)</span>{{/if}}
                </span>
            </div>

            <div class="xjzl-cb-grid">
                {{#each items}}
                <div class="xjzl-cb-card" data-uuid="{{this.uuid}}" data-action="openSheet"
                    data-quality="{{this.system.quality}}" draggable="true"
                    data-drag-data='{ "type": "Item", "uuid": "{{this.uuid}}" }'>

                    <img src="{{this.img}}" loading="lazy" />
                    <div class="xjzl-cb-card-info">
                        <div class="name">{{this.name}}</div>
                        {{#if this.packLabel}}
                        <div class="source">{{this.packLabel}}</div>
                        {{/if}}
                    </div>
                </div>
                {{/each}}

                {{#unless totalCount}}
                <div class="no-results">
                    <p>没有找到符合条件的物品。</p>
                </div>
                {{/unless}}
            </div>
        </main>
    </div>

    {{else}}
    <div class="xjzl-cb-loading">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <p>正在读取江湖图谱...</p>
    </div>
    {{/if}}
</div>