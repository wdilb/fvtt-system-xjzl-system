<div class="xjzl-chat-card move-card" data-item-id="{{item.id}}" data-move-id="{{move.id}}">

    {{!-- 1. 头部 (完全分离写法，保证结构清晰) --}}
    {{#if isHeal}}
    {{!-- A. 治疗/绿色模式 --}}
    <header class="card-header"
        style="border-bottom: 2px solid #27ae60; padding-bottom: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
        <img src="{{move.img}}" width="40" height="40"
            style="border:1px solid #1e8449; background:#000; border-radius: 4px;" />
        <div style="flex: 1;">
            <h3 style="margin: 0; font-weight: 900; border: none; color: #1e8449; font-size: 1.2em;">
                <i class="fas fa-heart-pulse" style="font-size:0.8em; margin-right:4px;"></i> {{move.name}}
            </h3>
            <div style="font-size: 0.8em; color: #555;">
                <span style="background: #333; color: #fff; padding: 0 4px; border-radius: 2px;">
                    {{localize (concat "XJZL.Wuxue.Type." move.type)}}
                </span>
                - {{item.name}}
            </div>
        </div>
    </header>
    {{else if isStance}}
    {{!-- B. 架招/蓝色模式 (新增) --}}
    <header class="card-header"
        style="border-bottom: 2px solid #2980b9; padding-bottom: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
        <img src="{{move.img}}" width="40" height="40"
            style="border:1px solid #2471a3; background:#000; border-radius: 4px;" />
        <div style="flex: 1;">
            <h3 style="margin: 0; font-weight: 900; border: none; color: #2980b9; font-size: 1.2em;">
                <i class="fas fa-shield-alt" style="font-size:0.8em; margin-right:4px;"></i> {{move.name}}
            </h3>
            <div style="font-size: 0.8em; color: #555;">
                <span style="background: #333; color: #fff; padding: 0 4px; border-radius: 2px;">
                    {{localize (concat "XJZL.Wuxue.Type." move.type)}}
                </span>
                - {{item.name}}
            </div>
        </div>
    </header>
    {{else}}
    {{!-- C. 默认/攻击/红色模式 --}}
    <header class="card-header"
        style="border-bottom: 2px solid var(--xjzl-gold); padding-bottom: 5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
        <img src="{{move.img}}" width="40" height="40"
            style="border:1px solid #333; background:#000; border-radius: 4px;" />
        <div style="flex: 1;">
            <h3 style="margin: 0; font-weight: 900; border: none; color: #8b0000; font-size: 1.2em;">{{move.name}}</h3>
            <div style="font-size: 0.8em; color: #555;">
                <span style="background: #333; color: #fff; padding: 0 4px; border-radius: 2px;">
                    {{localize (concat "XJZL.Wuxue.Type." move.type)}}
                </span>
                - {{item.name}}
            </div>
        </div>
    </header>
    {{/if}}

    {{!-- 2. 描述与详情 (可折叠区域) --}}
    {{!-- 架招默认展开 (open)，其他默认折叠 --}}
    {{#if (or move.description move.automationNote)}}
    <details class="card-details" style="margin-bottom: 10px;" {{#if isStance}}open{{/if}}>
        <summary style="cursor: pointer; font-size: 0.85em; color: #666; outline: none;">
            <i class="fas fa-book-open"></i> {{localize "XJZL.UI.Chat.MoveCard.ShowDetails"}}
        </summary>
        <div
            style="margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.03); border-radius: 4px; font-size: 0.9em; color: #444;">
            {{#if move.description}}
            <div style="font-style: italic; margin-bottom: 5px;">{{{move.description}}}</div>
            {{/if}}

            {{!-- 自动化提示 --}}
            {{#if move.automationNote}}
            <div
                style="border-top: 1px dashed #ccc; padding-top: 4px; margin-top: 4px; color: #2c3e50; font-size: 0.85em;">
                <i class="fas fa-robot"></i> <b>{{localize "XJZL.Wuxue.AutomationNote"}}:</b>
                {{move.automationNote}}
            </div>
            {{/if}}
        </div>
    </details>
    {{/if}}

    {{!-- 3. 命中检定 (架招不显示) --}}
    {{#unless isStance}}
    {{#if attackRoll}}
    <div class="card-roll" style="margin-bottom: 10px;">
        <div class="roll-header"
            style="background: #eee; padding: 5px; border-radius: 4px; text-align: center; cursor: pointer; border: 1px solid #ccc;">
            <div style="font-size: 0.8em; color: #666;">{{localize "XJZL.UI.Chat.MoveCard.RollHeader"
                type=damageTypeLabel}}</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #333;">
                {{displayTotal}}
            </div>
            <div style="font-size: 0.7em; color: #888;">
                {{attackRoll.formula}} {{localize "XJZL.UI.Chat.MoveCard.RollHint"}}
            </div>
        </div>

        <div class="dice-tooltip" style="display: none; margin-top: 5px;">
            {{{rollTooltip}}}
        </div>

        {{!-- 目标预判列表 (攻击模式) --}}
        {{#if hasTargets}}
        <div style="margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px; font-size: 0.85em;">
            {{#each targetsResults as |res id|}}
            <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                <span style="font-weight:bold; color:#444;">{{res.name}}</span>
                <span>
                    <b style="color: {{#if res.isHit}}green{{else}}red{{/if}};">
                        {{res.total}}
                    </b>
                    vs {{res.dodge}}
                    <span style="font-size:0.8em; color:#999;">({{res.stateLabel}})</span>
                </span>
            </div>
            {{/each}}
        </div>
        {{/if}}
    </div>

    {{else}}

    {{!-- 无需检定模式 (治疗/Buff/精神攻击) --}}
    {{#if hasTargets}}
    <div
        style="margin-bottom: 10px; font-size: 0.85em; background: rgba(0,0,0,0.02); padding: 5px; border-radius: 4px;">
        <div style="font-weight: bold; border-bottom: 1px dashed #ccc; margin-bottom: 3px;">
            {{localize "XJZL.UI.Chat.MoveCard.Targets"}}
        </div>
        {{#each targetsResults as |res id|}}
        <div style="display: flex; justify-content: space-between;">
            <span>{{res.name}}</span>
            <span style="color: #666;">
                {{#if ../isHeal}}
                <i class="fas fa-check" style="color:green; font-size:0.8em;"></i> {{localize
                "XJZL.UI.Chat.MoveCard.TargetReady"}}
                {{else}}
                <i class="fas fa-crosshairs" style="color:#666; font-size:0.8em;"></i> {{localize
                "XJZL.UI.Chat.MoveCard.TargetSelected"}}
                {{/if}}
            </span>
        </div>
        {{/each}}
    </div>
    {{else}}
    {{!-- 隐式自身提示 (仅在Buff模式且没选目标时) --}}
    {{#if isBuff}}
    <div style="margin-bottom: 10px; font-size: 0.8em; color: #666; font-style: italic; text-align: center;">
        {{localize "XJZL.UI.Chat.MoveCard.NoTargetSelfHint"}}
    </div>
    {{/if}}
    {{/if}}

    {{/if}}
    {{/unless}}

    {{!-- 4. 核心数值展示 (架招只显示消耗，不显示0伤害) --}}
    {{!-- 只要有任意一个数值或者消耗，就渲染这个块 --}}
    {{#if (or (gt calc.damage 0) (gt calc.feint 0) cost.mp cost.rage cost.hp)}}
    <div class="card-stats"
        style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; background: #fff; border: 1px dashed #ccc; padding: 5px; border-radius: 4px;">

        {{!-- 伤害 / 治疗 (架招通常不显示，除非有数值) --}}
        {{#if (gt calc.damage 0)}}
        <div style="text-align: center;">
            <div style="font-size: 0.8em; color: #666;">
                {{#if isHeal}}
                {{localize "XJZL.UI.Chat.MoveCard.HealAmount"}}
                {{else}}
                {{localize "XJZL.UI.Chat.MoveCard.Damage"}}
                {{/if}}
            </div>

            <div style="font-size: 1.8em; font-weight: 900; line-height: 1; color: {{#if isHeal}}#27ae60{{else}}var(--xjzl-accent){{/if}};"
                title="{{calc.breakdown}}">
                {{calc.damage}}
            </div>
        </div>
        {{/if}}

        {{!-- 虚招 --}}
        {{#if (gt calc.feint 0)}}
        <div style="text-align: center;">
            <div style="font-size: 0.8em; color: #666;">{{localize "XJZL.UI.Chat.MoveCard.FeintVal"}}</div>
            <div style="font-size: 1.8em; font-weight: 900; color: #9370db; line-height: 1;"
                title="{{calc.feintBreakdown}}">
                {{calc.feint}}
            </div>
        </div>
        {{/if}}

        {{!-- 消耗 (文字版) --}}
        {{#if (or cost.mp cost.rage cost.hp)}}
        <div style="text-align: left; font-size: 0.85em; color: #555; border-left: 1px solid #eee; padding-left: 10px;">
            {{#if cost.mp}}<div><b style="color:#2b4c7e">{{localize "XJZL.UI.Chat.MoveCard.Cost.MP"}}:</b> {{cost.mp}}
            </div>{{/if}}
            {{#if cost.rage}}<div><b style="color:#c5a059">{{localize "XJZL.UI.Chat.MoveCard.Cost.Rage"}}:</b>
                {{cost.rage}}</div>{{/if}}
            {{#if cost.hp}}<div><b style="color:#8b0000">{{localize "XJZL.UI.Chat.MoveCard.Cost.HP"}}:</b> {{cost.hp}}
            </div>{{/if}}
        </div>
        {{/if}}
    </div>
    {{/if}}

    {{!-- 5. 交互按钮组 (架招无需按钮，因为已经立即生效) --}}
    {{#unless isStance}}
    <div class="card-buttons" style="display: flex; flex-direction: column; gap: 5px;">

        {{!-- 虚招对抗 --}}
        {{#if isFeint}}
        {{#if showFeintBtn}}
        <button data-action="rollFeintContest" style="background: #483d8b; color: white;">
            <i class="fas fa-dice-d20"></i> {{localize "XJZL.UI.Chat.MoveCard.FeintContest"}}
        </button>
        {{else}}
        <div style="text-align:center; font-size:0.8em; color:#666; background:#eee; padding:4px; border-radius:4px;">
            {{localize "XJZL.UI.Chat.MoveCard.NoStanceHint"}}
        </div>
        {{/if}}
        {{/if}}

        {{!-- 数值应用按钮 (分流) --}}
        {{#if (gt calc.damage 0)}}
        {{#if isHeal}}
        <button data-action="applyHeal" style="background: #27ae60; color: white;"
            title="{{localize 'XJZL.UI.Chat.MoveCard.ApplyHealTitle'}}">
            <i class="fas fa-heart"></i> {{localize "XJZL.UI.Chat.MoveCard.ApplyHeal"}}
        </button>
        {{else}}
        <button data-action="applyDamage" style="background: var(--xjzl-accent); color: white;"
            title="{{localize 'XJZL.UI.Chat.MoveCard.ApplyDamageTitle'}}">
            <i class="fas fa-tint"></i> {{localize "XJZL.UI.Chat.MoveCard.ApplyDamage"}}
        </button>
        {{/if}}
        {{else}}
        {{!-- 纯Buff应用 (数值为0时) --}}
        {{#if (or isHeal isBuff)}}
        <button data-action="applyHeal" style="background: #2c3e50; color: white;">
            <i class="fas fa-magic"></i> {{localize "XJZL.UI.Chat.MoveCard.ApplyEffect"}}
        </button>
        {{/if}}
        {{/if}}

    </div>
    {{/unless}}

</div>