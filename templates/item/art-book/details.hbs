<section class="xjzl-body xjzl-body-scroll" data-application-part="details">

    <div class="xjzl-bg-deco">{{localize "XJZL.ArtBook.BgDeco"}}</div>

    {{!-- 1. 简介 (保留云纹标题) --}}
    <div class="xjzl-card">
        <h3 class="cloud-header">{{localize "XJZL.ArtBook.Description"}}</h3>
        <textarea name="system.description" rows="3"
            style="width:100%; background:rgba(0,0,0,0.03); border:1px solid rgba(0,0,0,0.1); border-radius:4px; padding:10px;">{{system.description}}</textarea>
    </div>

    {{!-- 2. 章节列表 --}}
    <div style="margin-top: 30px;">

        {{!-- 标题栏：改为工具栏样式，解决重叠问题 --}}
        <div class="xjzl-flex-row"
            style="align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid var(--c-theme-border); padding-bottom: 8px;">
            <span style="font-family: var(--font-title); font-size: 24px; color: var(--c-theme-main);">
                {{localize "XJZL.ArtBook.Chapters"}}
            </span>
            <button type="button" data-action="addChapter" class="xjzl-btn-seal"
                style="width: auto; padding: 2px 10px; border-color: var(--c-theme-main); color: var(--c-theme-main);">
                <i class="fas fa-plus"></i> {{localize "XJZL.UI.Add"}}
            </button>
        </div>

        {{!-- 章节卡片循环 --}}
        <div class="xjzl-flex-col" style="gap: 15px;">
            {{#each system.chapters as |chapter i|}}
            <div class="chapter-card">

                {{!-- 头部 --}}
                <div class="chapter-header">
                    <img src="{{chapter.img}}" width="32" height="32">
                    <input type="text" name="system.chapters.{{i}}.name" value="{{chapter.name}}"
                        placeholder="{{localize 'XJZL.ArtBook.ChapterNamePlaceholder'}}" style="flex:1;">
                    <a data-action="deleteChapter" data-idx="{{i}}" style="color:#999; cursor:pointer;">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>

                {{!-- 内容：两列布局 --}}
                <div class="chapter-body">
                    {{!-- 左侧：数值配置 --}}
                    <div class="xjzl-flex-col" style="gap: 10px;">

                        {{!-- 消耗 --}}
                        <div class="xjzl-ink-field" style="margin-bottom:0; padding:5px; border-left-color: #888;">
                            <label>{{localize "XJZL.ArtBook.ChapterCost"}}</label>
                            <input type="number" name="system.chapters.{{i}}.cost" value="{{chapter.cost}}">
                        </div>

                        {{!-- 奖励：等级 + 检定 --}}
                        <div class="xjzl-flex-row" style="gap: 5px;">
                            <div class="xjzl-ink-field"
                                style="margin-bottom:0; padding:5px; flex:1; border-left-color: var(--c-theme-main);">
                                <label>{{localize "XJZL.ArtBook.RewardLevel"}}</label>
                                <input type="number" name="system.chapters.{{i}}.reward.level"
                                    value="{{chapter.reward.level}}">
                            </div>
                            <div class="xjzl-ink-field"
                                style="margin-bottom:0; padding:5px; flex:1; border-left-color: var(--c-theme-main);">
                                <label>{{localize "XJZL.ArtBook.RewardCheck"}}</label>
                                <input type="number" name="system.chapters.{{i}}.reward.check"
                                    value="{{chapter.reward.check}}">
                            </div>
                        </div>

                        {{!-- 消耗系数折叠 (内功卡同款样式) --}}
                        {{#with chapter.xpCostRatio as |ratio|}}
                        <div class="xjzl-details-box" style="margin:0;">
                            <details {{#if (ne ratio 1)}}open{{/if}}>
                                <summary style="padding:5px;">
                                    <i class="fas fa-coins" style="margin-right: 5px;"></i>
                                    {{localize "XJZL.ArtBook.XPCostRatio"}}

                                    {{!-- 状态指示器 --}}
                                    <span class="status {{#if (ne ratio 1)}}modified{{/if}}"
                                        style="font-size:10px; margin-left: auto;">
                                        {{#if (ne ratio 1)}}
                                        {{!-- 这里复用内功的本地化 Key，或者你在语言包里加对应的 ArtBook Key --}}
                                        {{localize "XJZL.Neigong.Ratio"}}: x{{ratio}}
                                        {{else}}
                                        ({{localize "XJZL.Neigong.DefaultRatio"}} 1.0)
                                        {{/if}}
                                    </span>
                                </summary>

                                <div class="content" style="padding:5px;">
                                    <label style="white-space:nowrap;">{{localize
                                        "XJZL.Neigong.XPCostRatioLabel"}}:</label>

                                    {{!-- 注意 name 的写法，必须包含 index {{i}} --}}
                                    <input type="number" name="system.chapters.{{i}}.xpCostRatio" value="{{ratio}}"
                                        min="0.1" step="0.1" placeholder="1.0"
                                        style="width: 60px; text-align: center; border-bottom: 1px solid var(--c-cinnabar) !important;">

                                    <span style="color:#999; font-size: 10px;">{{localize
                                        "XJZL.ArtBook.RatioStandardHint"}}</span>
                                </div>
                            </details>
                        </div>
                        {{/with}}
                    </div>

                    {{!-- 右侧：描述 --}}
                    <div class="xjzl-flex-col" style="height: 100%;">
                        <label style="font-size:11px; color:#888; margin-bottom:2px; display:block;">
                            {{localize "XJZL.ArtBook.ChapterDesc"}}
                        </label>
                        <textarea name="system.chapters.{{i}}.description"
                            placeholder="{{localize 'XJZL.ArtBook.ChapterContentPlaceholder'}}">{{chapter.description}}</textarea>
                    </div>
                </div>
            </div>
            {{else}}
            <div
                style="text-align: center; color: #999; padding: 30px; border: 2px dashed rgba(0,0,0,0.1); border-radius: 8px;">
                {{localize "XJZL.ArtBook.EmptyChaptersHint"}}
            </div>
            {{/each}}
        </div>
    </div>

</section>