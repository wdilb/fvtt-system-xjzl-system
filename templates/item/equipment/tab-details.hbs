<section class="tab scroll-area {{#if (eq tabs.primary 'details')}}active{{/if}}" data-tab="details"
    data-group="primary">

    <div class="xjzl-flex-col">

        {{!-- 1. 类型特定属性 (保持不变) --}}
        <fieldset class="xjzl-card">
            <legend class="xjzl-card-header">基础属性</legend>

            <div class="xjzl-grid-2">
                {{#if isWeapon}}
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Wuxue.Moves.WeaponType"}}</label>
                    <select name="system.type" class="xjzl-input">
                        {{selectOptions choices.weaponTypes selected=system.type}}
                    </select>
                </div>
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Wuxue.Moves.WeaponSubtype"}}</label>
                    <input type="text" name="system.subtype" value="{{system.subtype}}" class="xjzl-input"
                        placeholder="如: 重剑" />
                </div>
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Equipment.Damage"}}</label>
                    <input type="number" name="system.damage" value="{{system.damage}}" class="xjzl-input" />
                </div>
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Equipment.Block"}}</label>
                    <input type="number" name="system.block" value="{{system.block}}" class="xjzl-input" />
                </div>
                {{/if}}

                {{#if isArmor}}
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Armor.Category"}}</label>
                    <select name="system.type" class="xjzl-input">
                        {{selectOptions choices.armorTypes selected=system.type}}
                    </select>
                </div>
                {{/if}}

                {{#if isQizhen}}
                <div class="xjzl-flex-col">
                    <label>{{localize "XJZL.Equipment.Acupoint"}}</label>

                    {{!-- 只读显示区域 --}}
                    <div class="xjzl-input"
                        style="background: rgba(0,0,0,0.05); color: #555; pointer-events: none; user-select: none; display: flex; align-items: center; justify-content: center;">
                        {{acupointLabel}}
                    </div>
                    <p style="font-size: 0.8em; color: #999; margin: 2px 0 0 0; text-align: center;">
                        * 请在角色卡 [行囊] 中点击装备图标进行镶嵌
                    </p>
                </div>
                {{/if}}
            </div>
        </fieldset>

        {{!-- 2. 描述与脚本 (上移) --}}
        <div class="xjzl-card">
            <div class="xjzl-flex-col">
                <label style="font-weight:bold;">{{localize "XJZL.Equipment.Description"}}</label>
                <textarea name="system.description" rows="4" class="xjzl-input"
                    style="text-align:left; height:auto;">{{system.description}}</textarea>
            </div>
        </div>

        {{!-- 3. 脚本列表 (替换了原来的 system.equipScript) --}}
        <div class="xjzl-card" style="margin-top: 10px;">
            <div class="xjzl-flex-row"
                style="align-items: center; justify-content: space-between; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px;">
                <label style="font-weight: bold;">{{localize "XJZL.Script.ScriptList"}}</label>
                <a class="item-control" data-action="addScript" title="添加新特效">
                    <i class="fas fa-plus"></i> 添加特效
                </a>
            </div>

            {{!-- 遍历 scripts 数组 --}}
            <div class="xjzl-flex-col" style="gap: 10px;">
                {{#each system.scripts as |script i|}}
                <div class="xjzl-script-item"
                    style="border: 1px solid #ddd; padding: 8px; border-radius: 4px; background: rgba(0,0,0,0.02);">

                    {{!-- 第一行：控制栏 --}}
                    <div class="xjzl-flex-row" style="gap: 5px; margin-bottom: 5px; align-items: center;">
                        {{!-- 名称 --}}
                        <input type="text" name="system.scripts.{{i}}.label" value="{{script.label}}" placeholder="特效名称"
                            class="xjzl-input" style="flex: 2; font-weight: bold;" />

                        {{!-- 触发时机 --}}
                        <select name="system.scripts.{{i}}.trigger" style="flex: 1.5;">
                            {{!-- 使用上层上下文传来的 scriptTriggerChoices --}}
                            {{selectOptions ../scriptTriggerChoices selected=script.trigger localize=false}}
                        </select>

                        {{!-- 激活开关 --}}
                        <div style="display: flex; align-items: center;" title="是否启用">
                            <input type="checkbox" name="system.scripts.{{i}}.active" {{checked script.active}} />
                        </div>

                        {{!-- 删除按钮 --}}
                        <a data-action="deleteScript" data-index="{{i}}" style="color: #999; padding: 0 5px;">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>

                    {{!-- 第二行：代码编辑器 --}}
                    <textarea name="system.scripts.{{i}}.script" rows="2" class="xjzl-input script-editor"
                        style="font-family: 'Consolas', 'Courier New', monospace; font-size: 0.9em; background: #fff;"
                        placeholder="// JS 代码...">{{script.script}}</textarea>
                </div>
                {{else}}
                <div style="text-align: center; color: #999; font-style: italic; padding: 10px;">
                    暂无脚本特效，点击右上角添加。
                </div>
                {{/each}}
            </div>
        </div>

    </div>
</section>