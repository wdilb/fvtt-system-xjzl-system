<section class="tab xjzl-body xjzl-body-scroll {{#if (eq tabs.primary 'details')}}active{{/if}}" data-tab="details"
    data-group="primary" data-application-part="details">

    <div class="xjzl-bg-deco">招</div>

    <div class="xjzl-flex-col">
        {{#each system.moves as |move i|}}
        <div class="move-card {{move._uiClass}}" data-move-index="{{i}}">

            {{!-- 1. 标题栏 --}}
            <div class="move-header">
                <img src="{{move.img}}" />
                <input type="text" name="system.moves.{{i}}.name" value="{{move.name}}" class="move-name"
                    placeholder="招式名称" style="flex:1;">

                <select name="system.moves.{{i}}.type" style="width: 80px;">
                    {{selectOptions @root.choices.moveTypes selected=move.type}}
                </select>

                {{#if (eq move.type "qi")}}
                <select name="system.moves.{{i}}.actionType" style="width: 75px;" title="功能">
                    {{selectOptions @root.choices.actionTypes selected=move.actionType}}
                </select>
                {{/if}}

                <div class="xjzl-checkbox-wrapper" title="绝招"
                    style="display:flex; align-items:center; gap:2px; margin-left:10px;">
                    <label style="font-weight:900; color:#b7950b;">绝</label>
                    <input type="checkbox" name="system.moves.{{i}}.isUltimate" {{checked move.isUltimate}}>
                </div>

                <a data-action="deleteMove" data-id="{{move.id}}" style="color:#999; margin-left:10px; cursor:pointer;">
                    <i class="fas fa-trash"></i>
                </a>
            </div>

            {{!-- 2. 头部配置区 (垂直排列) --}}

            {{!-- (A) 消耗系数 (使用内功本地化) --}}
            <div style="margin-bottom: 10px;">
                {{#with move.xpCostRatio as |ratio|}}
                <div class="xjzl-details-box" style="margin:0;">
                    <details {{#if (ne ratio 1)}}open{{/if}}>
                        <summary style="padding:5px;">
                            <i class="fas fa-coins" style="margin-right: 5px;"></i>
                            {{localize "XJZL.Neigong.XPCostRatio"}}

                            <span class="status {{#if (ne ratio 1)}}modified{{/if}}"
                                style="font-size:10px; margin-left:auto;">
                                {{#if (ne ratio 1)}}
                                {{localize "XJZL.Neigong.Ratio"}}: x{{ratio}}
                                {{else}}
                                ({{localize "XJZL.Neigong.DefaultRatio"}} 1.0)
                                {{/if}}
                            </span>
                        </summary>
                        <div class="content" style="padding:5px;">
                            <label style="white-space:nowrap;">{{localize "XJZL.Neigong.XPCostRatioLabel"}}:</label>
                            <input type="number" name="system.moves.{{i}}.xpCostRatio" value="{{ratio}}" min="0.1"
                                step="0.01" style="width:60px; text-align:center;">
                            <span style="font-size: 0.8em; color: #888; margin-left: 10px;">(1.0 = 标准)</span>
                        </div>
                    </details>
                </div>
                {{/with}}
            </div>

            {{!-- (B) 自动化说明 (单独一行) --}}
            <div class="xjzl-ink-field" style="margin-bottom: 15px; padding:5px; border-left-color:var(--c-mp-blue);">
                <label><i class="fas fa-robot"></i> {{localize "XJZL.AutomationNote"}}</label>
                <input type="text" name="system.moves.{{i}}.automationNote" value="{{move.automationNote}}"
                    placeholder="{{localize 'XJZL.Neigong.AutomationPlaceholder'}}" style="font-size:12px; width:100%;">
            </div>

            {{!-- 3. 主体内容布局 (Grid: 左消耗 | 右加成+脚本) --}}
            <div class="move-body">

                {{!-- ================= 左侧：基础参数 & 消耗表 ================= --}}
                <div class="xjzl-flex-col" style="gap: 10px;">

                    {{!-- 基础参数 (2x2 Grid) --}}
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.WeaponType"}}</label>
                            <select name="system.moves.{{i}}.weaponType">
                                {{selectOptions @root.choices.weaponTypes selected=move.weaponType}}
                            </select>
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>子类型</label>
                            <input type="text" name="system.moves.{{i}}.weaponSubtype" value="{{move.weaponSubtype}}"
                                placeholder="如: 重剑">
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>伤害类型</label>
                            <select name="system.moves.{{i}}.damageType">
                                {{selectOptions @root.choices.damageTypes selected=move.damageType}}
                            </select>
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>五行属性</label>
                            <select name="system.moves.{{i}}.element">
                                {{selectOptions @root.choices.elements selected=move.element}}
                            </select>
                        </div>
                    </div>

                    {{!-- 消耗表 --}}
                    <div>
                        <label style="font-weight:bold; font-size:11px; color:#666;">消耗配置</label>
                        <div class="cost-table {{#if (eq ../system.tier 3)}}tier-3{{/if}}">
                            <div class="label"></div>
                            {{#each move._ui.costLabels as |label|}}<div>{{label}}</div>{{/each}}

                            <div class="label">内</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.mp.{{lvlIdx}}"
                                value="{{lookup move.costs.mp lvlIdx}}">
                            {{/each}}

                            <div class="label">怒</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.rage.{{lvlIdx}}"
                                value="{{lookup move.costs.rage lvlIdx}}">
                            {{/each}}

                            <div class="label">血</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.hp.{{lvlIdx}}"
                                value="{{lookup move.costs.hp lvlIdx}}">
                            {{/each}}
                        </div>
                    </div>
                </div>

                <div class="xjzl-flex-col" style="gap: 15px;">

                    {{!-- A. 属性加成 --}}
                    <div class="scaling-box">
                        <div class="xjzl-flex-row" style="justify-content:space-between; margin-bottom:5px;">
                            <label style="font-weight:bold; font-size:11px;">加成属性 (Scalings)</label>
                            <a data-action="addScaling" title="添加"><i class="fas fa-plus"></i></a>
                        </div>

                        <div class="xjzl-grid-inline" style="margin-bottom:8px;">
                            <label style="font-size:11px; white-space:nowrap;">基</label>
                            <input type="number" name="system.moves.{{i}}.calculation.base"
                                value="{{move.calculation.base}}" class="xjzl-input xjzl-input-short" placeholder="0">

                            <label style="font-size:11px; margin-left:10px; white-space:nowrap;">长</label>
                            <input type="number" name="system.moves.{{i}}.calculation.growth"
                                value="{{move.calculation.growth}}" class="xjzl-input xjzl-input-short" placeholder="0">
                        </div>

                        {{#each move.calculation.scalings as |scale idx|}}
                        <div class="scaling-row">
                            <select name="system.moves.{{i}}.calculation.scalings.{{idx}}.prop">
                                {{selectOptions @root.choices.attributes selected=scale.prop}}
                            </select>
                            <span class="x-mark">×</span>
                            <input type="number" name="system.moves.{{i}}.calculation.scalings.{{idx}}.ratio"
                                value="{{scale.ratio}}" step="0.1">
                            <a data-action="deleteScaling" data-idx="{{idx}}" class="delete-btn"><i
                                    class="fas fa-times"></i></a>
                        </div>
                        {{/each}}
                    </div>

                    {{!-- B. 脚本列表 (移回右侧栏) --}}
                    <div>
                        <div class="xjzl-flex-row" style="justify-content:space-between; margin-bottom:5px;">
                            <label style="font-weight:bold; font-size:11px;">{{localize
                                "XJZL.Script.ScriptList"}}</label>
                            <a data-action="addMoveScript" title="添加"><i class="fas fa-plus"></i></a>
                        </div>

                        {{#each move.scripts as |script sIdx|}}
                        <div class="xjzl-script-item">
                            <div class="xjzl-flex-row" style="gap:5px; margin-bottom:5px;">
                                <input type="text" name="system.moves.{{i}}.scripts.{{sIdx}}.label"
                                    value="{{script.label}}" placeholder="名称" style="flex:2; font-weight:bold;">

                                <select name="system.moves.{{i}}.scripts.{{sIdx}}.trigger"
                                    style="flex:1.5; font-size:11px;">
                                    {{selectOptions @root.scriptTriggerChoices selected=script.trigger localize=false}}
                                </select>

                                <input type="checkbox" name="system.moves.{{i}}.scripts.{{sIdx}}.active" {{checked
                                    script.active}}>
                                <a data-action="deleteMoveScript" data-idx="{{sIdx}}" style="color:#999;"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                            <textarea name="system.moves.{{i}}.scripts.{{sIdx}}.script" class="script-editor"
                                placeholder="// Code...">{{script.script}}</textarea>
                        </div>
                        {{/each}}
                    </div>

                </div> {{!-- 右侧结束 --}}

            </div>
        </div>
        {{/each}}

        <button type="button" data-action="addMove" class="xjzl-btn-seal" style="margin-top:10px;">
            <i class="fas fa-plus"></i> {{localize "XJZL.Wuxue.Moves.AddMove"}}
        </button>
    </div>

</section>