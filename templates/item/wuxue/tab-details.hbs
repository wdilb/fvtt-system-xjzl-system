{{!-- templates/item/wuxue/tab-details.hbs --}}
<section class="tab scroll-area {{#if (eq tabs.primary 'details')}}active{{/if}}" data-tab="details"
    data-group="primary">

    <div class="xjzl-flex-col">
        {{#each system.moves as |move i|}}
        {{!-- 加上 data-move-index 方便 JS 查找父级 --}}
        <div class="xjzl-card" style="position: relative; margin-bottom: 15px;" data-move-index="{{i}}">

            {{!-- 1. 标题栏 --}}
            <div class="xjzl-flex-row" style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">
                <img src="{{move.img}}" width="32" height="32" style="border:1px solid #000; background:#333;" />

                {{!-- 招式名称 --}}
                <input type="text" name="system.moves.{{i}}.name" value="{{move.name}}" class="xjzl-input"
                    style="font-weight:bold; font-size:1.2em; text-align:left; flex:1;" placeholder="招式名称" />

                {{!-- 类型选择 --}}
                <select name="system.moves.{{i}}.type" class="xjzl-input" style="width: 80px;">
                    {{selectOptions ../choices.moveTypes selected=move.type}}
                </select>

                {{!-- 删除按钮 --}}
                <a data-action="deleteMove" data-id="{{move.id}}" style="color:#999; margin-left:5px;"><i
                        class="fas fa-trash"></i></a>
            </div>

            {{!-- 2. 基础配置 (Grid) --}}
            <div class="xjzl-grid-2">
                {{!-- 左侧：标签 --}}
                <div class="xjzl-flex-col">
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.WeaponType"}}</label>
                        <select name="system.moves.{{i}}.weaponType" class="xjzl-input">
                            {{selectOptions ../choices.weaponTypes selected=move.weaponType}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.WeaponSubtype"}}</label>
                        <input type="text" name="system.moves.{{i}}.weaponSubtype" value="{{move.weaponSubtype}}"
                            class="xjzl-input" placeholder="如: 重剑" />
                    </div>
                    {{!-- 伤害类型 --}}
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.DamageType"}}</label>
                        <select name="system.moves.{{i}}.damageType" class="xjzl-input">
                            {{selectOptions ../choices.damageTypes selected=move.damageType}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.Element"}}</label>
                        <select name="system.moves.{{i}}.element" class="xjzl-input">
                            {{selectOptions ../choices.elements selected=move.element}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.ActionCost"}}</label>
                        <input type="text" name="system.moves.{{i}}.actionCost" value="{{move.actionCost}}"
                            class="xjzl-input" />
                    </div>
                </div>

                {{!-- 右侧：数值公式 (动态列表) --}}
                <div class="xjzl-flex-col" style="background: rgba(0,0,0,0.03); padding: 5px; border-radius: 4px;">
                    <div class="xjzl-flex-row" style="border-bottom:1px dashed #ccc;">
                        <label style="font-weight:bold;">{{localize "XJZL.Wuxue.Calc.Base"}} / {{localize
                            "XJZL.Wuxue.Calc.Growth"}}</label>
                        <a data-action="addScaling" title="添加加成属性"><i class="fas fa-plus"></i></a>
                    </div>

                    <div class="xjzl-flex-row">
                        <label>基础伤害</label>
                        <input type="number" name="system.moves.{{i}}.calculation.base"
                            value="{{move.calculation.base}}" class="xjzl-input" />
                        <label>成长伤害</label>
                        <input type="number" name="system.moves.{{i}}.calculation.growth"
                            value="{{move.calculation.growth}}" class="xjzl-input" />
                    </div>

                    {{!-- 动态加成列表 --}}
                    {{#each move.calculation.scalings as |scale idx|}}
                    <div class="xjzl-flex-row">
                        <select name="system.moves.{{i}}.calculation.scalings.{{idx}}.prop" class="xjzl-input">
                            {{selectOptions ../../choices.attributes selected=scale.prop}}
                        </select>
                        <span>×</span>
                        <input type="number" name="system.moves.{{i}}.calculation.scalings.{{idx}}.ratio"
                            value="{{scale.ratio}}" class="xjzl-input" step="0.1" />
                        <a data-action="deleteScaling" data-idx="{{idx}}" style="color:#999;"><i
                                class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                </div>
            </div>

            <hr style="border-color: #ddd; margin: 10px 0;">

            {{!-- 3. 消耗配置 (手动三行版) --}}
            <div class="xjzl-flex-col">
                <label style="font-weight:bold;">{{localize "XJZL.Wuxue.Cost.Table"}}</label>
                <div class="xjzl-flex-row" style="font-size:0.8em; text-align:center;">
                    <div style="width:40px;"></div>
                    {{#each ../levelLabels as |label|}}
                    <div style="flex:1;">{{label}}</div>
                    {{/each}}
                </div>

                {{!-- MP --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.MP"}}</label>
                    {{#each ../maxMoveLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.mp.{{lvlIdx}}"
                        value="{{lookup move.costs.mp lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
                {{!-- Rage --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.Rage"}}</label>
                    {{#each ../maxMoveLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.rage.{{lvlIdx}}"
                        value="{{lookup move.costs.rage lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
                {{!-- HP --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.HP"}}</label>
                    {{#each ../maxMoveLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.hp.{{lvlIdx}}"
                        value="{{lookup move.costs.hp lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
            </div>

            <hr style="border-color: #ddd; margin: 10px 0;">

            {{!-- 4. 描述与脚本列表 (Grid) --}}
            <div class="xjzl-grid-2" style="align-items: start; gap: 15px;">

                {{!-- 左侧：描述 --}}
                <div class="xjzl-flex-col">
                    <label style="font-weight:bold; font-size:0.9em;">描述文本</label>
                    <textarea name="system.moves.{{i}}.description" rows="8" class="xjzl-input"
                        style="text-align:left; height:auto; background: rgba(255,255,255,0.5);">{{move.description}}</textarea>
                </div>

                {{!-- 右侧：脚本列表 (【新增】核心改动) --}}
                <div class="xjzl-flex-col">
                    <div class="xjzl-flex-row"
                        style="align-items: center; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-weight:bold; font-size:0.9em;">{{localize "XJZL.Script.ScriptList"}}</label>
                        <a class="item-control" data-action="addMoveScript" title="添加新特效">
                            <i class="fas fa-plus"></i> 添加
                        </a>
                    </div>

                    {{!-- 遍历该招式的脚本 --}}
                    {{#each move.scripts as |script sIdx|}}
                    <div class="xjzl-script-item"
                        style="border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; border-radius: 4px; background: rgba(0,0,0,0.02);">
                        <div class="xjzl-flex-row" style="gap: 5px; margin-bottom: 5px;">
                            <input type="text" name="system.moves.{{i}}.scripts.{{sIdx}}.label" value="{{script.label}}"
                                placeholder="特效名称" class="xjzl-input" style="flex: 2;" />

                            <select name="system.moves.{{i}}.scripts.{{sIdx}}.trigger" style="flex: 2;">
                                {{selectOptions ../../scriptTriggerChoices selected=script.trigger localize=false}}
                            </select>

                            <div style="display: flex; align-items: center;" title="是否启用">
                                <input type="checkbox" name="system.moves.{{i}}.scripts.{{sIdx}}.active" {{checked
                                    script.active}} />
                            </div>

                            <a data-action="deleteMoveScript" data-idx="{{sIdx}}" style="color: #999;">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>

                        <textarea name="system.moves.{{i}}.scripts.{{sIdx}}.script" rows="2"
                            class="xjzl-input script-editor"
                            style="font-family: monospace; font-size: 0.9em; background: #fff;"
                            placeholder="// JS 代码...">{{script.script}}</textarea>
                    </div>
                    {{else}}
                    <div
                        style="text-align: center; color: #999; font-size: 0.9em; padding: 10px; border: 1px dashed #ddd;">
                        无特效脚本
                    </div>
                    {{/each}}
                </div>
            </div>

        </div>
        {{/each}}

        <button type="button" data-action="addMove" style="margin-top:10px;">
            <i class="fas fa-plus"></i> 添加新招式
        </button>
    </div>

</section>