<section class="tab xjzl-body xjzl-body-scroll {{#if (eq tabs.primary 'details')}}active{{/if}}" data-tab="details"
    data-group="primary" data-application-part="details">

    <div class="xjzl-bg-deco">{{localize "XJZL.Wuxue.BgDeco"}}</div>

    <div class="xjzl-flex-col">
        {{#each system.moves as |move i|}}
        <div class="move-card {{move._uiClass}}" data-move-index="{{i}}">

            <!-- ================================================== -->
            <!-- 数据保护区 (Hidden Inputs)                  -->
            <!-- 必须存在！否则每次编辑武学，修为、等级都会被归零       -->
            <!-- ================================================== -->

            <!-- 1. 唯一标识符 -->
            <input type="hidden" name="system.moves.{{i}}.id" value="{{move.id}}">

            <!-- 2. 核心成长数据 (最关键的部分) -->
            <input type="hidden" name="system.moves.{{i}}.xpInvested" value="{{move.xpInvested}}">
            <input type="hidden" name="system.moves.{{i}}.level" value="{{move.level}}">

            <!-- 3. 修为来源成分 -->
            <input type="hidden" name="system.moves.{{i}}.sourceBreakdown.general"
                value="{{move.sourceBreakdown.general}}">
            <input type="hidden" name="system.moves.{{i}}.sourceBreakdown.specific"
                value="{{move.sourceBreakdown.specific}}">
            <!-- 4. 其他没有显示在界面上的字段 (防止被意外覆盖) -->
            <input type="hidden" name="system.moves.{{i}}.img" value="{{move.img}}"> <!-- 虽然我们没加招式图片，但是确实定义了这个字段，先这样放着 -->

            {{!-- 1. 标题栏 --}}
            <div class="move-header">
                <img src="{{move.img}}" />
                <input type="text" name="system.moves.{{i}}.name" value="{{move.name}}" class="move-name"
                    placeholder="{{localize 'XJZL.Wuxue.Moves.Name'}}" style="flex:1;">

                <select name="system.moves.{{i}}.type" style="width: 80px;">
                    {{selectOptions @root.choices.moveTypes selected=move.type}}
                </select>

                {{#if (eq move.type "qi")}}
                <select name="system.moves.{{i}}.actionType" style="width: 75px;"
                    data-tooltip="{{localize 'XJZL.Wuxue.Moves.ActionTypeHint'}}">
                    {{selectOptions @root.choices.actionTypes selected=move.actionType}}
                </select>
                {{/if}}

                <div class="xjzl-checkbox-wrapper" title="{{localize 'XJZL.Wuxue.Moves.IsUltimate'}}"
                    style="display:flex; align-items:center; gap:2px; margin-left:10px;">
                    <label style="font-weight:900; color:#b7950b;">{{localize "XJZL.Wuxue.Moves.UltimateChar"}}</label>
                    <input type="checkbox" name="system.moves.{{i}}.isUltimate" {{checked move.isUltimate}}>
                </div>

                <a data-action="deleteMove" data-id="{{move.id}}" style="color:#999; margin-left:10px; cursor:pointer;">
                    <i class="fas fa-trash"></i>
                </a>
            </div>

            {{!-- 2. [核心调整] 消耗系数：独占一行，放在标题下 --}}
            {{#with move.xpCostRatio as |ratio|}}
            <div class="xjzl-details-box" style="margin-bottom: 15px;">
                <details {{#if (ne ratio 1)}}open{{/if}}>
                    <summary style="padding:5px;">
                        <span><i class="fas fa-coins"></i> {{localize "XJZL.Wuxue.Moves.XPCostRatio"}}</span>
                        <span class="status {{#if (ne ratio 1)}}modified{{/if}}" style="font-size:10px;">
                            {{#if (ne ratio 1)}}x{{ratio}}{{else}}(1.0){{/if}}
                        </span>
                    </summary>
                    <div class="content" style="padding:5px;">
                        <label style="white-space:nowrap;">{{localize "XJZL.Neigong.XPCostRatioLabel"}}:</label>
                        <input type="number" name="system.moves.{{i}}.xpCostRatio" value="{{ratio}}" min="0.1"
                            step="0.01" style="width:60px; text-align:center;">
                        <span style="font-size: 0.8em; color: #888; margin-left: 10px;">{{localize
                            "XJZL.ArtBook.RatioStandardHint"}}</span>
                    </div>
                </details>
            </div>
            {{/with}}

            {{!-- 3. 核心双栏布局 --}}
            <div class="move-body">

                {{!-- === 左侧：基础属性 + 消耗表 === --}}
                <div class="xjzl-flex-col" style="gap: 15px;">

                    {{!-- A. 基础参数 --}}
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.WeaponType"}}</label>
                            <select name="system.moves.{{i}}.weaponType">
                                {{selectOptions @root.choices.weaponTypes selected=move.weaponType}}
                            </select>
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.WeaponSubtypeLabel"}}</label>
                            <input type="text" name="system.moves.{{i}}.weaponSubtype" value="{{move.weaponSubtype}}"
                                placeholder="{{localize 'XJZL.Wuxue.Moves.SubtypePlaceholder'}}">
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.DamageType"}}</label>
                            <select name="system.moves.{{i}}.damageType">
                                {{selectOptions @root.choices.damageTypes selected=move.damageType}}
                            </select>
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.ElementLabel"}}</label>
                            <select name="system.moves.{{i}}.element">
                                {{selectOptions @root.choices.elements selected=move.element}}
                            </select>
                        </div>
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Tier"}}</label> <!-- 复用 "武学品阶" 的翻译 -->
                            <select name="system.moves.{{i}}.tier">
                                {{!-- value="" 代表继承，selected=move.tier 会自动匹配 null 或 数字 --}}
                                {{selectOptions @root.choices.moveTiers selected=move.tier}}
                            </select>
                        </div>

                        {{!-- 2. 动作消耗 (去掉 grid-column: span 2) --}}
                        <div class="xjzl-ink-field" style="margin:0; padding:5px;">
                            <label>{{localize "XJZL.Wuxue.Moves.ActionCost"}}</label>
                            <input type="text" name="system.moves.{{i}}.actionCost" value="{{move.actionCost}}">
                        </div>
                    </div>

                    {{!-- B. 消耗表 --}}
                    <div>
                        <label style="font-weight:bold; font-size:11px; color:#666;">{{localize
                            "XJZL.Wuxue.Cost.Label"}}</label>
                        <div class="cost-table"
                            style="grid-template-columns: 30px repeat({{move._ui.costLevels.length}}, 1fr);">
                            <div class="label"></div>
                            {{#each move._ui.costLabels as |label|}}<div>{{label}}</div>{{/each}}

                            <div class="label">内</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.mp.{{lvlIdx}}"
                                value="{{lookup move.costs.mp lvlIdx}}">
                            {{/each}}

                            <div class="label">怒</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.rage.{{lvlIdx}}"
                                value="{{lookup move.costs.rage lvlIdx}}">
                            {{/each}}

                            <div class="label">血</div>
                            {{#each move._ui.costLevels as |lvlIdx|}}
                            <input type="number" name="system.moves.{{i}}.costs.hp.{{lvlIdx}}"
                                value="{{lookup move.costs.hp lvlIdx}}">
                            {{/each}}
                        </div>
                    </div>
                </div>

                {{!-- === 右侧：自动化 + 进阶 + 加成 === --}}
                <div class="xjzl-flex-col" style="gap: 10px;">

                    {{!-- C. 自动化说明 (移到这里) --}}
                    <div class="xjzl-ink-field" style="margin:0; padding:5px; border-left-color:var(--c-mp-blue);">
                        <label><i class="fas fa-robot"></i> {{localize "XJZL.AutomationNote"}}</label>
                        <input type="text" name="system.moves.{{i}}.automationNote" value="{{move.automationNote}}"
                            placeholder="{{localize 'XJZL.Wuxue.AutomationNotePlaceholder'}}"
                            style="font-size:12px; width:100%;">
                    </div>

                    {{!-- D. 进阶配置 --}}
                    <div class="xjzl-card"
                        style="margin:0; padding:8px; background:rgba(0,0,0,0.03); border:1px dashed #ccc;">
                        <div class="xjzl-flex-row" style="justify-content:space-between; margin-bottom:5px;">
                            <label style="font-weight:bold; font-size:11px;">{{localize
                                "XJZL.Wuxue.Progression.Title"}}</label>
                            <select name="system.moves.{{i}}.progression.mode"
                                style="height:20px; font-size:11px; width:auto; background:transparent; border:none;">
                                {{selectOptions @root.choices.progressionModes selected=move.progression.mode}}
                            </select>
                        </div>

                        {{#if (eq move.progression.mode "custom")}}
                        <div class="xjzl-flex-col" style="margin-bottom:5px;">
                            <input type="text" name="temp.thresholds.{{i}}"
                                value="{{move.progression.customThresholds}}" class="xjzl-input"
                                placeholder="1000, 3000" style="font-size:11px; border-bottom:1px dashed #999;">
                            <p class="notes" style="font-size:0.7em; color:#888; margin:0;">{{localize
                                "XJZL.Wuxue.Progression.ThresholdsHint"}}
                        </div>
                        {{/if}}

                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            {{!-- 1. 标签部分 --}}
                            <label style="font-size:11px; white-space:nowrap; cursor:help; margin:0;"
                                data-tooltip="{{localize 'XJZL.Wuxue.Progression.MappedStageDesc'}}">
                                {{localize "XJZL.Wuxue.Progression.MappedStage"}}:
                                <i class="fas fa-circle-question"
                                    style="color:var(--c-ink-light); font-size:0.9em;"></i>
                            </label>
                            {{!-- 2. 下拉框部分 (现在会紧跟在冒号后面) --}}
                            <select name="system.moves.{{i}}.progression.mappedStage"
                                style="height:20px; font-size:11px; width:auto; background:transparent; border:none;">
                                {{selectOptions @root.choices.mappedStages selected=move.progression.mappedStage}}
                            </select>

                        </div>
                        <p class="notes" style="font-size:0.7em; color:#888; margin:0;">{{localize
                            "XJZL.Wuxue.Progression.MappedStageHint"}}</p>
                    </div>

                    {{!-- E. 属性加成 --}}
                    <div class="scaling-box">
                        <div class="xjzl-flex-row" style="justify-content:space-between; margin-bottom:5px;">
                            <label style="font-weight:bold; font-size:11px;">{{localize
                                "XJZL.Wuxue.Calc.Label"}}</label>
                            <a data-action="addScaling" title="{{localize 'XJZL.UI.Add'}}"><i
                                    class="fas fa-plus"></i></a>
                        </div>

                        <div class="xjzl-grid-inline" style="margin-bottom:8px;">
                            <label style="font-size:11px; white-space:nowrap;">{{localize
                                "XJZL.Wuxue.Calc.BaseShort"}}</label>
                            <input type="number" name="system.moves.{{i}}.calculation.base"
                                value="{{move.calculation.base}}" class="xjzl-input xjzl-input-short" placeholder="0">

                            <label style="font-size:11px; margin-left:10px; white-space:nowrap;">{{localize
                                "XJZL.Wuxue.Calc.GrowthShort"}}</label>
                            <input type="number" name="system.moves.{{i}}.calculation.growth"
                                value="{{move.calculation.growth}}" class="xjzl-input xjzl-input-short" placeholder="0">
                        </div>

                        {{#each move.calculation.scalings as |scale idx|}}
                        <div class="scaling-row">
                            <select name="system.moves.{{i}}.calculation.scalings.{{idx}}.prop">
                                {{selectOptions @root.choices.attributes selected=scale.prop}}
                            </select>
                            <span class="x-mark">×</span>
                            <input type="number" name="system.moves.{{i}}.calculation.scalings.{{idx}}.ratio"
                                value="{{scale.ratio}}" step="0.1">
                            <a data-action="deleteScaling" data-idx="{{idx}}" class="delete-btn"><i
                                    class="fas fa-times"></i></a>
                        </div>
                        {{/each}}
                    </div>

                </div> {{!-- 右侧结束 --}}
            </div>

            {{!-- 4. 底部通栏：脚本列表 --}}
            <div style="margin-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 10px;">
                <div class="xjzl-flex-row"
                    style="justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight:bold; font-size:12px; color:#555;">
                        <i class="fas fa-code"></i> {{localize "XJZL.Script.ScriptList"}}
                    </label>
                    <a data-action="addMoveScript" style="font-size:11px; color:var(--c-theme-main); cursor:pointer;">
                        <i class="fas fa-plus"></i> {{localize "XJZL.Wuxue.Moves.ScriptAdd"}}
                    </a>
                </div>

                {{#each move.scripts as |script sIdx|}}
                <div class="xjzl-script-item">
                    {{!-- 头部行：名称(自动填充) | 触发器 | 激活 | 删除 --}}
                    <div class="script-header-row">
                        <i class="fas fa-code script-icon"></i>

                        {{!-- 1. 脚本名称：占据剩余空间 --}}
                        <input type="text" name="system.moves.{{i}}.scripts.{{sIdx}}.label" value="{{script.label}}"
                            class="script-name-input"
                            placeholder="{{localize 'XJZL.Wuxue.Moves.ScriptNamePlaceholder'}}">

                        {{!-- 2. 触发时机：固定宽度 --}}
                        <select name="system.moves.{{i}}.scripts.{{sIdx}}.trigger" class="script-trigger-select">
                            {{selectOptions @root.scriptTriggerChoices selected=script.trigger localize=false}}
                        </select>

                        {{!-- 3. 右侧工具：激活勾选 + 删除 --}}
                        <div class="script-tools">
                            <label class="active-label" data-tooltip="{{localize 'XJZL.UI.ToggleEnable'}}">
                                <span style="font-size:10px; color:#666;">{{localize "XJZL.UI.Enable"}}</span>
                                <input type="checkbox" name="system.moves.{{i}}.scripts.{{sIdx}}.active" {{checked
                                    script.active}}>
                            </label>

                            <a data-action="deleteMoveScript" data-idx="{{sIdx}}" class="delete-btn"
                                title="{{localize 'XJZL.UI.Delete'}}">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>

                    {{!-- 代码输入框：全宽 + 更高 --}}
                    <textarea name="system.moves.{{i}}.scripts.{{sIdx}}.script" class="script-editor"
                        placeholder="// JS Code... (e.g. args.actor, args.item)">{{script.script}}</textarea>
                </div>
                {{/each}}
            </div>

            {{!-- 5. 底部通栏：描述 --}}
            <div style="margin-top: 10px;">
                <div class="xjzl-move-editor">
                    <prose-mirror name="system.moves.{{i}}.description" data-document-u-u-i-d="{{../document.uuid}}"
                        value="{{move.description}}" toggled="false" button="true">
                        {{{move.enrichedDescription}}}
                    </prose-mirror>
                </div>
            </div>

        </div>
        {{/each}}

        <button type="button" data-action="addMove" class="xjzl-btn-seal" style="margin-top:10px;">
            <i class="fas fa-plus"></i> {{localize "XJZL.Wuxue.Moves.AddMove"}}
        </button>
    </div>

</section>