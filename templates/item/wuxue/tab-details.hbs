{{!-- templates/item/wuxue/tab-details.hbs --}}
<section class="tab scroll-area {{#if (eq tabs.primary 'details')}}active{{/if}}" data-tab="details"
    data-group="primary">

    <div class="xjzl-flex-col">
        {{#each system.moves as |move i|}}
        <div class="xjzl-card" style="position: relative; margin-bottom: 15px;" data-move-index="{{i}}">

            {{!-- 1. 标题栏 --}}
            <div class="xjzl-flex-row" style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">
                <img src="{{move.img}}" width="32" height="32" style="border:1px solid #000; background:#333;" />

                <input type="text" name="system.moves.{{i}}.name" value="{{move.name}}" class="xjzl-input"
                    style="font-weight:bold; font-size:1.2em; text-align:left; flex:1;"
                    placeholder="{{localize 'XJZL.Wuxue.Moves.Name'}}" />

                <select name="system.moves.{{i}}.type" class="xjzl-input" style="width: 80px;">
                    {{selectOptions ../choices.moveTypes selected=move.type}}
                </select>

                {{!-- 绝招勾选 --}}
                <div class="xjzl-checkbox-wrapper"
                    style="display: flex; align-items: center; margin-left: 10px; font-size: 0.8em;"
                    title="{{localize 'XJZL.Wuxue.Moves.IsUltimate'}}">
                    <label style="margin-right: 2px; font-weight: bold; color: #8b0000;">绝</label>
                    <input type="checkbox" name="system.moves.{{i}}.isUltimate" {{checked move.isUltimate}} />
                </div>

                <a data-action="deleteMove" data-id="{{move.id}}" style="color:#999; margin-left:5px;"><i
                        class="fas fa-trash"></i></a>
            </div>

            {{!-- 2. 基础配置 (Grid) --}}
            <div class="xjzl-grid-2">
                {{!-- 左侧 --}}
                <div class="xjzl-flex-col">
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.WeaponType"}}</label>
                        <select name="system.moves.{{i}}.weaponType" class="xjzl-input">
                            {{selectOptions ../choices.weaponTypes selected=move.weaponType}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.WeaponSubtype"}}</label>
                        <input type="text" name="system.moves.{{i}}.weaponSubtype" value="{{move.weaponSubtype}}"
                            class="xjzl-input" placeholder="如: 重剑" />
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.DamageType"}}</label>
                        <select name="system.moves.{{i}}.damageType" class="xjzl-input">
                            {{selectOptions ../choices.damageTypes selected=move.damageType}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.Element"}}</label>
                        <select name="system.moves.{{i}}.element" class="xjzl-input">
                            {{selectOptions ../choices.elements selected=move.element}}
                        </select>
                    </div>
                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Moves.ActionCost"}}</label>
                        <input type="text" name="system.moves.{{i}}.actionCost" value="{{move.actionCost}}"
                            class="xjzl-input" />
                    </div>
                    {{!-- 消耗系数 (优化版) --}}
                    <details style="margin-top: 5px; border-top: 1px dotted #ccc; padding-top: 5px;" {{#if (ne
                        move.xpCostRatio 1)}}open{{/if}}>

                        <summary
                            style="cursor: pointer; color: #555; font-size: 0.9em; outline: none; user-select: none; display: flex; align-items: center;">
                            {{!-- 图标与标题 --}}
                            <i class="fas fa-percentage" style="width: 20px; text-align: center;"></i>
                            <span style="font-weight: bold;">{{localize "XJZL.Wuxue.Moves.XPCostRatio"}}</span>

                            {{!-- 状态指示文本 --}}
                            <span
                                style="margin-left: auto; font-size: 0.9em; color: {{#if (ne move.xpCostRatio 1)}}#8b0000{{else}}#999{{/if}};">
                                {{#if (ne move.xpCostRatio 1)}}
                                (当前: {{move.xpCostRatio}})
                                {{else}}
                                (默认 1.0)
                                {{/if}}
                            </span>
                        </summary>

                        {{!-- 展开后的内容：包含提示语和输入框 --}}
                        <div class="xjzl-flex-row"
                            style="margin-top: 5px; align-items: center; justify-content: flex-end; gap: 5px; background: rgba(0,0,0,0.02); padding: 5px; border-radius: 4px;">

                            <span style="font-size: 0.8em; color: #666; margin-right: auto;">
                                1 = 100%, 0.8 = 8折
                            </span>

                            <input type="number" name="system.moves.{{i}}.xpCostRatio" value="{{move.xpCostRatio}}"
                                class="xjzl-input" min="0.1" step="0.01" placeholder="1"
                                style="width: 60px; text-align: center; color: #8b0000; font-weight: bold; border: 1px solid #ddd;"
                                title="1.0 = 100%消耗, 0.8 = 80%消耗, 1.2 = 120%消耗" />
                        </div>
                    </details>
                </div>

                {{!-- 右侧 --}}
                <div class="xjzl-flex-col" style="background: rgba(0,0,0,0.03); padding: 5px; border-radius: 4px;">
                    <div class="xjzl-flex-row" style="border-bottom:1px dashed #ccc;">
                        <label style="font-weight:bold;">{{localize "XJZL.Wuxue.Calc.Base"}} / {{localize
                            "XJZL.Wuxue.Calc.Growth"}}</label>
                        <a data-action="addScaling" title="添加加成属性"><i class="fas fa-plus"></i></a>
                    </div>

                    <div class="xjzl-flex-row">
                        <label>{{localize "XJZL.Wuxue.Calc.Base"}}</label>
                        <input type="number" name="system.moves.{{i}}.calculation.base"
                            value="{{move.calculation.base}}" class="xjzl-input" />
                        <label>{{localize "XJZL.Wuxue.Calc.Growth"}}</label>
                        <input type="number" name="system.moves.{{i}}.calculation.growth"
                            value="{{move.calculation.growth}}" class="xjzl-input" />
                    </div>

                    {{#each move.calculation.scalings as |scale idx|}}
                    <div class="xjzl-flex-row">
                        <select name="system.moves.{{i}}.calculation.scalings.{{idx}}.prop" class="xjzl-input">
                            {{selectOptions ../../choices.attributes selected=scale.prop}}
                        </select>
                        <span>×</span>
                        <input type="number" name="system.moves.{{i}}.calculation.scalings.{{idx}}.ratio"
                            value="{{scale.ratio}}" class="xjzl-input" step="0.1" />
                        <a data-action="deleteScaling" data-idx="{{idx}}" style="color:#999;"><i
                                class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                </div>
            </div>

            {{!-- 3. 进阶配置 (Localize) --}}
            <div class="xjzl-card" style="margin-top: 10px; background: rgba(0,0,0,0.02); border: 1px dashed #ccc;">
                <div class="xjzl-flex-row" style="justify-content: space-between;">
                    <label style="font-weight:bold; font-size: 0.9em; color: #555;">{{localize
                        "XJZL.Wuxue.Progression.Title"}}</label>

                    <div class="xjzl-flex-row" style="gap: 5px;">
                        <label>{{localize "XJZL.Wuxue.Progression.Mode"}}:</label>
                        <select name="system.moves.{{i}}.progression.mode" class="xjzl-input"
                            style="height: 22px; font-size: 0.8em;">
                            {{selectOptions ../choices.progressionModes selected=move.progression.mode}}
                        </select>
                    </div>
                </div>

                {{#if (eq move.progression.mode "custom")}}
                <div class="xjzl-flex-col" style="margin-top: 5px;">
                    <label style="font-size: 0.8em;">{{localize "XJZL.Wuxue.Progression.Thresholds"}}</label>
                    {{!-- 使用 temp.thresholds 绕过自动解析 --}}
                    <input type="text" name="temp.thresholds.{{i}}" value="{{move.progression.customThresholds}}"
                        class="xjzl-input" placeholder="1000, 3000" />
                    <p class="notes" style="font-size: 0.7em; color: #888; margin: 0;">{{localize
                        "XJZL.Wuxue.Progression.ThresholdsHint"}}</p>
                </div>
                {{/if}}

                <div class="xjzl-flex-row" style="margin-top: 5px; align-items: center;">
                    <label style="font-size: 0.8em; flex: 1;">{{localize "XJZL.Wuxue.Progression.MappedStage"}}:</label>
                    <select name="system.moves.{{i}}.progression.mappedStage" class="xjzl-input" style="flex: 1;">
                        {{selectOptions ../choices.mappedStages selected=move.progression.mappedStage}}
                    </select>
                </div>
                <p class="notes" style="font-size: 0.7em; color: #888; margin: 0;">{{localize
                    "XJZL.Wuxue.Progression.MappedStageHint"}}</p>
            </div>

            <hr style="border-color: #ddd; margin: 10px 0;">

            {{!-- 4. 消耗配置 --}}
            <div class="xjzl-flex-col">
                <label style="font-weight:bold;">{{localize "XJZL.Wuxue.Cost.Table"}}</label>
                <div class="xjzl-flex-row" style="font-size:0.8em; text-align:center;">
                    <div style="width:40px;"></div>
                    {{#each move._ui.costLabels as |label|}}
                    <div style="flex:1;">{{label}}</div>
                    {{/each}}
                </div>

                {{!-- MP --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.MP"}}</label>
                    {{#each move._ui.costLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.mp.{{lvlIdx}}"
                        value="{{lookup move.costs.mp lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
                {{!-- Rage --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.Rage"}}</label>
                    {{#each move._ui.costLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.rage.{{lvlIdx}}"
                        value="{{lookup move.costs.rage lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
                {{!-- HP --}}
                <div class="xjzl-flex-row">
                    <label style="width:40px; font-size:0.8em;">{{localize "XJZL.Wuxue.Cost.HP"}}</label>
                    {{#each move._ui.costLevels as |lvlIdx|}}
                    <input type="number" name="system.moves.{{i}}.costs.hp.{{lvlIdx}}"
                        value="{{lookup move.costs.hp lvlIdx}}" class="xjzl-input" />
                    {{/each}}
                </div>
            </div>

            <hr style="border-color: #ddd; margin: 10px 0;">

            {{!-- 5. 描述与脚本 --}}
            <div class="xjzl-grid-2" style="align-items: start; gap: 15px;">
                <div class="xjzl-flex-col">
                    <label style="font-weight:bold; font-size:0.9em;">{{localize "XJZL.Equipment.Description"}}</label>
                    <textarea name="system.moves.{{i}}.description" rows="8" class="xjzl-input"
                        style="text-align:left; height:auto; background: rgba(255,255,255,0.5);">{{move.description}}</textarea>
                </div>

                <div class="xjzl-flex-col">
                    <div class="xjzl-flex-row"
                        style="align-items: center; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-weight:bold; font-size:0.9em;">{{localize "XJZL.Script.ScriptList"}}</label>
                        <a class="item-control" data-action="addMoveScript" title="{{localize 'XJZL.UI.CreateNew'}}">
                            <i class="fas fa-plus"></i> 添加
                        </a>
                    </div>

                    {{#each move.scripts as |script sIdx|}}
                    <div class="xjzl-script-item"
                        style="border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; border-radius: 4px; background: rgba(0,0,0,0.02);">
                        <div class="xjzl-flex-row" style="gap: 5px; margin-bottom: 5px;">
                            <input type="text" name="system.moves.{{i}}.scripts.{{sIdx}}.label" value="{{script.label}}"
                                placeholder="特效名称" class="xjzl-input" style="flex: 2;" />

                            <select name="system.moves.{{i}}.scripts.{{sIdx}}.trigger" style="flex: 2;">
                                {{selectOptions ../../scriptTriggerChoices selected=script.trigger localize=false}}
                            </select>

                            <div style="display: flex; align-items: center;" title="是否启用">
                                <input type="checkbox" name="system.moves.{{i}}.scripts.{{sIdx}}.active" {{checked
                                    script.active}} />
                            </div>

                            <a data-action="deleteMoveScript" data-idx="{{sIdx}}" style="color: #999;">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>

                        <textarea name="system.moves.{{i}}.scripts.{{sIdx}}.script" rows="2"
                            class="xjzl-input script-editor"
                            style="font-family: monospace; font-size: 0.9em; background: #fff;"
                            placeholder="// JS 代码...">{{script.script}}</textarea>
                    </div>
                    {{else}}
                    <div
                        style="text-align: center; color: #999; font-size: 0.9em; padding: 10px; border: 1px dashed #ddd;">
                        {{localize "XJZL.Wuxue.Moves.NoScript"}}
                    </div>
                    {{/each}}
                </div>
            </div>

        </div>
        {{/each}}

        <button type="button" data-action="addMove" style="margin-top:10px;">
            <i class="fas fa-plus"></i> {{localize "XJZL.Wuxue.Moves.AddMove"}}
        </button>
    </div>

</section>