<section class="tab xjzl-body xjzl-body-scroll {{#if (eq tabs.primary 'config')}}active{{/if}}" data-tab="config"
    data-group="primary" data-application-part="config">

    <div class="xjzl-bg-deco">功</div>

    {{#each stages as |stage|}}
    <div class="xjzl-card" style="margin-bottom: 30px; position: relative; z-index: 1;">

        <h3
            style="font-family: var(--font-title); font-size: 24px; color: var(--c-cinnabar); margin-bottom: 15px; border-bottom: 2px solid var(--c-ink-faint); padding-bottom: 5px;">
            {{localize stage.label}}
        </h3>

        {{!-- 1. 属性印章矩阵 (改为 6列) --}}
        <div class="xjzl-stats-grid" style="grid-template-columns: repeat(6, 1fr); gap: 5px;">
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Liliang"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.liliang"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'liliang'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Shenfa"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shenfa"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shenfa'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Tipo"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.tipo"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'tipo'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Neixi"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.neixi"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'neixi'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Qigan"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.qigan"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'qigan'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Shencai"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shencai"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shencai'}}">
            </div>
        </div>

        {{!-- 脚本区域 --}}
        <div class="xjzl-flex-col" style="margin-top: 15px;">
            <div class="xjzl-flex-row" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-family: var(--font-deco); color: var(--c-ink-light);">脚本特效</label>
                <a class="item-control" data-action="addStageScript" data-stage="{{stage.key}}"
                    style="font-size: 12px; color: var(--c-cinnabar);">
                    <i class="fas fa-plus"></i> 添加脚本
                </a>
            </div>

            {{#each (lookup (lookup ../system.config stage.key) 'scripts') as |script i|}}
            <div
                style="background: rgba(255,255,255,0.5); border: 1px solid var(--c-ink-faint); padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                <div class="xjzl-flex-row" style="gap: 5px; margin-bottom: 5px;">
                    <input type="text" class="xjzl-input-clean" name="system.config.{{stage.key}}.scripts.{{i}}.label"
                        value="{{script.label}}"
                        style="flex: 1; font-weight: bold; border-bottom: 1px dashed var(--c-ink-light) !important;">

                    <select name="system.config.{{stage.key}}.scripts.{{i}}.trigger"
                        style="background: transparent; border: none !important; font-size: 12px;">
                        {{selectOptions ../../scriptTriggerChoices selected=script.trigger localize=false}}
                    </select>

                    <a data-action="deleteStageScript" data-stage="{{stage.key}}" data-index="{{i}}"
                        style="color: var(--c-ink-light);">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
                {{!-- 使用新的 script-editor 类 --}}
                <textarea name="system.config.{{stage.key}}.scripts.{{i}}.script" rows="3"
                    class="script-editor">{{script.script}}</textarea>
            </div>
            {{/each}}
        </div>
    </div>
    {{/each}}

    {{!-- 圆满境界 --}}
    <div class="xjzl-card"
        style="border: 2px solid var(--c-highlight); background: rgba(203, 160, 82, 0.05); padding: 15px; margin-top: 30px;">
        <div class="xjzl-flex-row" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="color: var(--c-highlight); font-family: var(--font-title); margin: 0;">圆满境界</h3>
            <button type="button" data-action="addMasteryChange"
                style="width: auto; padding: 2px 8px; font-size: 12px; background: rgba(255,255,255,0.5);">
                <i class="fas fa-plus"></i> 添加修正
            </button>
        </div>

        <p style="color: #666; font-size: 12px; margin-bottom: 10px;">此处配置圆满后的永久加成。</p>

        {{#each system.masteryChanges as |change i|}}
        <div class="xjzl-flex-row" style="margin-top: 5px; gap: 5px; align-items: center;">
            {{!-- Key --}}
            <input type="text" name="system.masteryChanges.{{i}}.key" value="{{change.key}}"
                placeholder="Key (e.g. system.stats.liliang)"
                style="border-bottom: 1px solid #ccc !important; flex: 3; font-size: 12px;">

            {{!-- Value --}}
            <input type="number" name="system.masteryChanges.{{i}}.value" value="{{change.value}}" placeholder="Val"
                style="border-bottom: 1px solid #ccc !important; flex: 1; text-align: center;">

            {{!-- Label (恢复此字段) --}}
            <input type="text" name="system.masteryChanges.{{i}}.label" value="{{change.label}}" placeholder="备注"
                style="border-bottom: 1px solid #ccc !important; flex: 2; font-size: 12px;">

            <a data-action="deleteMasteryChange" data-index="{{i}}" style="color: #999; padding: 5px;"><i
                    class="fas fa-trash"></i></a>
        </div>
        {{/each}}

        {{!-- 圆满特效脚本 --}}
        <div class="xjzl-flex-col" style="margin-top: 10px;">
            <label style="font-weight: bold; color: var(--c-highlight);">圆满特效脚本</label>
            <textarea name="system.masteryEffect" rows="3" class="script-editor">{{system.masteryEffect}}</textarea>
        </div>
    </div>

</section>