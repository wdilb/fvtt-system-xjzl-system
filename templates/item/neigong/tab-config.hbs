<section class="tab xjzl-body xjzl-body-scroll {{#if (eq tabs.primary 'config')}}active{{/if}} {{elementClass}}"
    data-tab="config" data-group="primary" data-application-part="config">

    <div class="xjzl-bg-deco">功</div>

    {{#each stages as |stage|}}
    <div class="xjzl-card" style="margin-bottom: 30px; position: relative; z-index: 1;">

        <h3
            style="font-family: var(--font-title); font-size: 24px; color: var(--c-cinnabar); margin-bottom: 15px; border-bottom: 2px solid var(--c-ink-faint); padding-bottom: 5px;">
            {{localize stage.label}}
        </h3>

        {{!-- 1. 属性印章矩阵 (改为 6列) --}}
        <div class="xjzl-stats-grid" style="grid-template-columns: repeat(6, 1fr); gap: 5px;">
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Liliang"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.liliang"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'liliang'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Shenfa"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shenfa"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shenfa'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Tipo"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.tipo"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'tipo'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Neixi"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.neixi"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'neixi'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Qigan"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.qigan"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'qigan'}}">
            </div>
            <div class="xjzl-seal-box compact">
                <label>{{localize "XJZL.Stats.Shencai"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shencai"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shencai'}}">
            </div>
        </div>

        {{!-- 使用 lookup 动态获取当前 stage 的 xpCostRatio --}}
        {{#with (lookup (lookup ../system.config stage.key) 'xpCostRatio') as |ratio|}}
        <div class="xjzl-details-box">
            {{!-- 只有当数值不为 1 时才默认展开 --}}
            <details {{#if (ne ratio 1)}}open{{/if}}>
                <summary>
                    <i class="fas fa-coins" style="margin-right: 5px;"></i>
                    {{localize "XJZL.Neigong.XPCostRatio"}}

                    {{!-- 状态指示器 --}}
                    <span class="status {{#if (ne ratio 1)}}modified{{/if}}">
                        {{#if (ne ratio 1)}}
                        {{localize "XJZL.Neigong.Ratio"}}: x{{ratio}}
                        {{else}}
                        ({{localize "XJZL.Neigong.DefaultRatio"}} 1.0)
                        {{/if}}
                    </span>
                </summary>

                <div class="content">
                    <label>{{localize "XJZL.Neigong.XPCostRatioLabel"}}:</label>
                    <input type="number" name="system.config.{{stage.key}}.xpCostRatio" value="{{ratio}}" min="0.1"
                        step="0.1" placeholder="1.0"
                        style="width: 60px; text-align: center; border-bottom: 1px solid var(--c-cinnabar) !important;">
                    <span style="color:#999;">(1.0 = 标准, 0.8 = 8折)</span>
                </div>
            </details>
        </div>
        {{/with}}

        {{!-- 脚本区域 --}}
        <div class="xjzl-flex-col" style="margin-top: 15px;">
            <div class="xjzl-flex-row" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-family: var(--font-deco); color: var(--c-ink-light);">{{localize
                    "XJZL.Neigong.ScriptLabel"}}</label>
                <a class="item-control" data-action="addStageScript" data-stage="{{stage.key}}"
                    style="font-size: 12px; color: var(--c-cinnabar);">
                    <i class="fas fa-plus"></i> {{localize "XJZL.Neigong.AddScript"}}
                </a>
            </div>

            {{#each (lookup (lookup ../system.config stage.key) 'scripts') as |script i|}}
            <div class="xjzl-script-item">
                {{!-- 头部：图标 | 名称 | 触发器 | 工具(开关+删除) --}}
                <div class="script-header-row">
                    <i class="fas fa-seedling script-icon"></i>

                    {{!-- 1. 名称：自动填满 --}}
                    <input type="text" name="system.config.{{stage.key}}.scripts.{{i}}.label" value="{{script.label}}"
                        class="script-name-input" placeholder="{{localize 'XJZL.Script.NamePlaceholder'}}">

                    {{!-- 2. 触发器：固定宽 --}}
                    <select name="system.config.{{stage.key}}.scripts.{{i}}.trigger" class="script-trigger-select">
                        {{selectOptions ../../scriptTriggerChoices selected=script.trigger localize=false}}
                    </select>

                    {{!-- 3. 工具组 --}}
                    <div class="script-tools">
                        <label class="active-toggle" title="{{localize 'XJZL.UI.ToggleEnable'}}">
                            <span class="label-text">On</span>
                            <input type="checkbox" name="system.config.{{stage.key}}.scripts.{{i}}.active" {{checked
                                script.active}}>
                        </label>

                        <a data-action="deleteStageScript" data-stage="{{stage.key}}" data-index="{{i}}"
                            class="delete-btn">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>

                {{!-- 代码框 --}}
                <textarea name="system.config.{{stage.key}}.scripts.{{i}}.script" class="script-editor"
                    placeholder="// JS Code...">{{script.script}}</textarea>
            </div>
            {{/each}}
        </div>
    </div>
    {{/each}}

    {{!-- 圆满境界 --}}
    <div class="xjzl-card"
        style="border: 2px solid var(--c-highlight); background: rgba(203, 160, 82, 0.05); padding: 15px; margin-top: 30px;">
        <div class="xjzl-flex-row" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="color: var(--c-highlight); font-family: var(--font-title); margin: 0;">{{localize
                "XJZL.Neigong.MasteryTitle"}}</h3>
            <button type="button" data-action="addMasteryChange"
                style="width: auto; padding: 2px 8px; font-size: 12px; background: rgba(255,255,255,0.5);">
                <i class="fas fa-plus"></i> {{localize "XJZL.Neigong.MasteryAddChange"}}
            </button>
        </div>

        <p style="color: #666; font-size: 12px; margin-bottom: 10px;">{{localize "XJZL.Neigong.MasteryHint"}}</p>

        {{!-- 表头 (可选，为了对齐好看) --}}
        <div class="mastery-grid-row" style="font-size: 11px; color: #999; margin-bottom: 5px;">
            <div>{{localize "XJZL.Neigong.HeaderKey"}}</div>
            <div style="text-align: center;">{{localize "XJZL.Neigong.HeaderValue"}}</div>
            <div>{{localize "XJZL.Neigong.Note"}}</div>
            <div></div>
        </div>

        {{#each system.masteryChanges as |change i|}}
        <div class="mastery-grid-row"
            style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 30px; gap: 8px; align-items: center; margin-bottom: 5px;">

            {{!-- 1. Key (修改为下拉框) --}}
            <div style="position: relative;">
                <select name="system.masteryChanges.{{i}}.key"
                    style="width: 100%; border: 0; border-bottom: 1px solid #ccc !important; font-size: 12px; background: transparent; height: 24px; padding: 0;">
                    {{!-- 注意：这里使用 @root.modifierChoices，因为你在 ItemJS 的 _prepareContext 里定义的是 modifierChoices --}}
                    {{selectOptionsGrouped @root.modifierChoices selected=change.key}}
                </select>
            </div>

            {{!-- 2. Value (数值) --}}
            <input type="number" name="system.masteryChanges.{{i}}.value" value="{{change.value}}" placeholder="0"
                style="border: 0; border-bottom: 1px solid #ccc !important; text-align: center; width: 100%; background: transparent;">

            {{!-- 3. Label (备注) --}}
            <input type="text" name="system.masteryChanges.{{i}}.label" value="{{change.label}}"
                placeholder="{{localize 'XJZL.Neigong.Note'}}"
                style="border: 0; border-bottom: 1px solid #ccc !important; font-size: 12px; width: 100%; background: transparent;">

            {{!-- 4. Delete (删除) --}}
            <a data-action="deleteMasteryChange" data-index="{{i}}"
                style="color: #999; text-align: center; cursor: pointer;">
                <i class="fas fa-trash"></i>
            </a>
        </div>
        {{/each}}

        {{!-- 圆满特效脚本
        <div class="xjzl-flex-col" style="margin-top: 15px;">
            <label style="font-weight: bold; color: var(--c-highlight); font-size: 12px;">{{localize
                "XJZL.Neigong.MasteryScript"}}</label>
            <textarea name="system.masteryEffect" rows="3" class="script-editor"
                placeholder="// JavaScript Code...">{{system.masteryEffect}}</textarea>
        </div> 暂时感觉是用不到的，先注释掉--}}
    </div>

</section>