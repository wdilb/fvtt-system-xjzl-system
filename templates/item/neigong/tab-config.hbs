{{!-- 添加 xjzl-body 类以应用内边距 --}}
<section class="tab xjzl-body xjzl-body-scroll {{#if (eq tabs.primary 'config')}}active{{/if}}" data-tab="config"
    data-group="primary">

    {{!-- 背景装饰字 --}}
    <div class="xjzl-bg-deco">功</div>

    {{#each stages as |stage|}}
    <div class="xjzl-card" style="margin-bottom: 30px; position: relative; z-index: 1;">

        {{!-- 阶段标题 --}}
        <h3
            style="font-family: var(--font-title); font-size: 24px; color: var(--c-cinnabar); margin-bottom: 15px; border-bottom: 2px solid var(--c-ink-faint); padding-bottom: 5px;">
            {{localize stage.label}}
        </h3>

        {{!-- 1. 属性印章矩阵 (3x2) --}}
        <div class="xjzl-stats-grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px;">
            {{!-- 力量 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Liliang"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.liliang"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'liliang'}}">
            </div>
            {{!-- 身法 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Shenfa"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shenfa"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shenfa'}}">
            </div>
            {{!-- 根骨 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Tipo"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.tipo"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'tipo'}}">
            </div>
            {{!-- 内息 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Neixi"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.neixi"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'neixi'}}">
            </div>
            {{!-- 气感 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Qigan"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.qigan"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'qigan'}}">
            </div>
            {{!-- 神采 --}}
            <div class="xjzl-seal-box">
                <label>{{localize "XJZL.Stats.Shencai"}}</label>
                <input type="number" name="system.config.{{stage.key}}.stats.shencai"
                    value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shencai'}}">
            </div>
        </div>

        {{!-- 2. 特效脚本编辑器 --}}
        <div class="xjzl-flex-col" style="margin-top: 15px;">
            <div class="xjzl-flex-row" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-family: var(--font-deco); color: var(--c-ink-light);">脚本特效</label>
                <a class="item-control" data-action="addStageScript" data-stage="{{stage.key}}"
                    style="font-size: 12px; color: var(--c-cinnabar);">
                    <i class="fas fa-plus"></i> 添加脚本
                </a>
            </div>

            {{#each (lookup (lookup ../system.config stage.key) 'scripts') as |script i|}}
            <div
                style="background: rgba(255,255,255,0.5); border: 1px solid var(--c-ink-faint); padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                <div class="xjzl-flex-row" style="gap: 5px; margin-bottom: 5px;">
                    <input type="text" class="xjzl-input-clean" name="system.config.{{stage.key}}.scripts.{{i}}.label"
                        value="{{script.label}}"
                        style="flex: 1; font-weight: bold; border-bottom: 1px dashed var(--c-ink-light);">

                    <select name="system.config.{{stage.key}}.scripts.{{i}}.trigger"
                        style="background: transparent; border: none; font-size: 12px;">
                        {{selectOptions ../../scriptTriggerChoices selected=script.trigger localize=false}}
                    </select>

                    <a data-action="deleteStageScript" data-stage="{{stage.key}}" data-index="{{i}}"
                        style="color: var(--c-ink-light);">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
                <textarea name="system.config.{{stage.key}}.scripts.{{i}}.script" rows="2"
                    style="width:100%; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.03); border: none; padding: 5px;">{{script.script}}</textarea>
            </div>
            {{/each}}
        </div>
    </div>
    {{/each}}

    {{!-- 圆满境界 --}}
    <div class="xjzl-card"
        style="border: 2px solid var(--c-highlight); background: rgba(203, 160, 82, 0.05); padding: 15px; margin-top: 30px;">
        <h3 style="color: var(--c-highlight); font-family: var(--font-title); margin-top: 0;">圆满境界</h3>
        {{!-- 这里可以复用上面的结构，为了简洁暂时省略，逻辑是一样的 --}}
        <p style="color: #666; font-size: 12px;">此处配置圆满后的永久加成。</p>
        <button type="button" data-action="addMasteryChange">添加修正</button>
        {{#each system.masteryChanges as |change i|}}
        {{!-- 渲染代码... --}}
        <div class="xjzl-flex-row" style="margin-top: 5px;">
            <input type="text" name="system.masteryChanges.{{i}}.key" value="{{change.key}}" placeholder="Key"
                style="border-bottom: 1px solid #ccc; flex: 2;">
            <input type="number" name="system.masteryChanges.{{i}}.value" value="{{change.value}}" placeholder="Val"
                style="border-bottom: 1px solid #ccc; flex: 1;">
            <a data-action="deleteMasteryChange" data-index="{{i}}"><i class="fas fa-trash"></i></a>
        </div>
        {{/each}}
    </div>

</section>