{{!-- templates/item/neigong/sheet.hbs --}}

<div class="xjzl-item-wrapper">

    {{!-- 1. 头部区域 --}}
    <header class="xjzl-header">
        <img class="char-portrait" src="{{document.img}}" data-edit="img" style="flex: 0 0 64px; height: 64px;"/>
        
        <div class="xjzl-flex-col xjzl-grow">
            <input type="text" name="name" value="{{document.name}}" class="xjzl-input" style="font-size: 1.5em; text-align: left; width: 100%;"/>
            
            <div class="xjzl-grid-2">
                <div class="xjzl-flex-col" style="gap: 2px;">
                    <label>{{localize "XJZL.Neigong.Tier"}}</label>
                    <select name="system.tier">
                        {{selectOptions tierChoices selected=system.tier}}
                    </select>
                </div>
                
                <div class="xjzl-flex-col" style="gap: 2px;">
                    <label>{{localize "XJZL.Neigong.Element"}}</label>
                    <select name="system.element">
                        {{selectOptions elementChoices selected=system.element}}
                    </select>
                </div>
            </div>
        </div>
    </header>

    {{!-- 2. 导航条 --}}
    <nav class="xjzl-tabs">
        <a class="xjzl-tab-item active" style="cursor: default;">
            <i class="fas fa-cogs"></i> {{localize "XJZL.Neigong.StatsConfig"}}
        </a>
    </nav>

    {{!-- 3. 内容滚动区域 --}}
    <div class="scroll-area">
        <div class="xjzl-flex-col">
          
          {{#each stages as |stage|}}
          <fieldset class="xjzl-card" style="margin-bottom: 10px;">
            <legend class="xjzl-card-header">{{localize stage.label}} (Stage {{stage.id}})</legend>
            
            {{!-- 属性加成 --}}
            <div class="xjzl-grid-3">
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Liliang"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.liliang" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'liliang'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Shenfa"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.shenfa" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shenfa'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                 <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Tipo"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.tipo" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'tipo'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Neixi"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.neixi" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'neixi'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                 <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Shencai"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.shencai" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shencai'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
            </div>

            <hr style="border-color: #aaa; opacity: 0.3; margin: 10px 0;">
            
            {{!-- 特效描述 (之前这里报错) --}}
            <div class="xjzl-flex-col">
                <label style="font-weight: bold;">{{localize "XJZL.Neigong.EffectConfig"}}</label>
                {{!-- 【修复】：去掉了多余的一层 lookup --}}
                <textarea name="system.config.{{stage.key}}.effect" rows="2" 
                          class="xjzl-input script-editor" 
                          style="font-family: inherit; font-size: 14px; color: #000 !important; background: rgba(255,255,255,0.5);"
                          placeholder="在此输入特效描述...">{{lookup (lookup ../system.config stage.key) 'effect'}}</textarea>
            </div>

            <div style="height: 5px;"></div>

            {{!-- 脚本编辑器 --}}
            <div class="xjzl-flex-col">
                <label style="font-weight: bold;">{{localize "XJZL.Neigong.ScriptLabel"}}</label>
                <p style="font-size: 0.8em; color: #666; font-style: italic; margin:0;">
                    {{localize "XJZL.Neigong.ScriptHint"}}
                </p>
                <textarea name="system.config.{{stage.key}}.script" rows="3" 
                          class="xjzl-input script-editor" 
                          placeholder="// 输入 JS 代码...">{{lookup (lookup ../system.config stage.key) 'script'}}</textarea>
            </div>

          </fieldset>
          {{/each}}
          
        </div>
    </div>

</div>