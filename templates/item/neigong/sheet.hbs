{{!-- templates/item/neigong/sheet.hbs --}}

<div class="xjzl-item-wrapper">

    {{!-- 1. 头部区域 --}}
    <header class="xjzl-header">
        <img class="char-portrait" src="{{document.img}}" data-edit="img" style="flex: 0 0 64px; height: 64px;"/>
        
        <div class="xjzl-flex-col xjzl-grow">
            <input type="text" name="name" value="{{document.name}}" class="xjzl-input" style="font-size: 1.5em; text-align: left; width: 100%;"/>
            
            <div class="xjzl-grid-2">
                <div class="xjzl-flex-col" style="gap: 2px;">
                    <label>{{localize "XJZL.Neigong.Tier"}}</label>
                    <select name="system.tier">
                        {{selectOptions tierChoices selected=system.tier}}
                    </select>
                </div>
                
                <div class="xjzl-flex-col" style="gap: 2px;">
                    <label>{{localize "XJZL.Neigong.Element"}}</label>
                    <select name="system.element">
                        {{selectOptions elementChoices selected=system.element}}
                    </select>
                </div>
            </div>
        </div>
    </header>

    {{!-- 2. 导航条 --}}
    <nav class="xjzl-tabs">
        <a class="xjzl-tab-item active" style="cursor: default;">
            <i class="fas fa-cogs"></i> {{localize "XJZL.Neigong.StatsConfig"}}
        </a>
    </nav>

    {{!-- 3. 内容滚动区域 --}}
    <div class="scroll-area">
        <div class="xjzl-flex-col">
          
          {{#each stages as |stage|}}
          <fieldset class="xjzl-card" style="margin-bottom: 10px;">
            <legend class="xjzl-card-header">{{localize stage.label}} (Stage {{stage.id}})</legend>
            
            {{!-- 属性加成 --}}
            <div class="xjzl-grid-3">
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Liliang"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.liliang" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'liliang'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Shenfa"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.shenfa" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shenfa'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                 <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Tipo"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.tipo" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'tipo'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Neixi"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.neixi" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'neixi'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Qigan"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.qigan" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'qigan'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
                 <div class="xjzl-flex-col xjzl-center">
                    <label>{{localize "XJZL.Stats.Shencai"}}</label>
                    <input type="number" name="system.config.{{stage.key}}.stats.shencai" 
                           value="{{lookup (lookup (lookup ../system.config stage.key) 'stats') 'shencai'}}" 
                           class="xjzl-input" style="width: 50px;"/>
                </div>
            </div>

            <hr style="border-color: #aaa; opacity: 0.3; margin: 10px 0;">
            
            {{!-- 特效描述 (之前这里报错) --}}
            <div class="xjzl-flex-col">
                <label style="font-weight: bold;">{{localize "XJZL.Neigong.EffectConfig"}}</label>
                {{!-- 【修复】：去掉了多余的一层 lookup --}}
                <textarea name="system.config.{{stage.key}}.effect" rows="2" 
                          class="xjzl-input script-editor" 
                          style="font-family: inherit; font-size: 14px; color: #000 !important; background: rgba(255,255,255,0.5);"
                          placeholder="在此输入特效描述...">{{lookup (lookup ../system.config stage.key) 'effect'}}</textarea>
            </div>

            <div style="height: 5px;"></div>

            {{!-- 脚本编辑器 --}}
            <div class="xjzl-flex-col">
                <label style="font-weight: bold;">{{localize "XJZL.Neigong.ScriptLabel"}}</label>
                <p style="font-size: 0.8em; color: #666; font-style: italic; margin:0;">
                    {{localize "XJZL.Neigong.ScriptHint"}}
                </p>
                <textarea name="system.config.{{stage.key}}.script" rows="3" 
                          class="xjzl-input script-editor" 
                          placeholder="// 输入 JS 代码...">{{lookup (lookup ../system.config stage.key) 'script'}}</textarea>
            </div>

          </fieldset>
          {{/each}}

          {{!-- =========================== --}}
          {{!-- 新增：圆满永久属性配置区域 --}}
          {{!-- =========================== --}}
          <fieldset class="xjzl-card" style="border-color: var(--xjzl-gold); background: rgba(255, 215, 0, 0.05);">
            <legend class="xjzl-card-header" style="color: var(--xjzl-gold) !important; border-bottom-color: var(--xjzl-gold);">
                <i class="fas fa-crown"></i> 圆满境界 (永久加成)
            </legend>
            
            <p style="font-size: 0.8em; color: #666; text-align: center; margin: 0 0 10px 0;">
                此处属性在内功达到圆满后<b>永久生效</b>，无需运功。
            </p>

            {{!-- 动态修改列表 --}}
            <div class="xjzl-flex-col">
                {{!-- 表头 --}}
                <div class="xjzl-flex-row" style="font-weight:bold; font-size:0.8em; color:#555; border-bottom:1px solid #ccc; padding-bottom:4px;">
                    <div style="flex: 2;">属性 Key (如 system.stats.liliang.mod)</div>
                    <div style="flex: 1; text-align:center;">数值</div>
                    <div style="flex: 1;">备注</div>
                    <div style="width: 30px;"></div>
                </div>

                {{!-- 循环渲染行 --}}
                {{#each system.masteryChanges as |change i|}}
                <div class="xjzl-flex-row">
                    {{!-- Key 输入框 --}}
                    <input type="text" name="system.masteryChanges.{{i}}.key" value="{{change.key}}" 
                           class="xjzl-input" style="flex: 2; text-align: left;" placeholder="system.stats..."/>
                    
                    {{!-- Value 输入框 --}}
                    <input type="number" name="system.masteryChanges.{{i}}.value" value="{{change.value}}" 
                           class="xjzl-input" style="flex: 1;"/>
                    
                    {{!-- Label 输入框 --}}
                    <input type="text" name="system.masteryChanges.{{i}}.label" value="{{change.label}}" 
                           class="xjzl-input" style="flex: 1;" placeholder="例如: 力量"/>

                    {{!-- 删除按钮 --}}
                    <a data-action="deleteMasteryChange" data-index="{{i}}" style="color: #999; width: 30px; text-align: center;">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
                {{/each}}

                {{!-- 新增按钮 --}}
                <button type="button" data-action="addMasteryChange" style="margin-top: 5px; border: 1px dashed #999; background: transparent; color: #555;">
                    <i class="fas fa-plus"></i> 添加一条修正
                </button>
            </div>

            <hr style="border-color: var(--xjzl-gold); opacity: 0.3; margin: 10px 0;">

            {{!-- 圆满特效描述 --}}
            <div class="xjzl-flex-col">
                <label style="font-weight: bold;">{{localize "XJZL.Neigong.MasteryEffect"}}</label>
                <textarea name="system.masteryEffect" rows="2" 
                          class="xjzl-input script-editor" 
                          style="font-family: inherit; font-size: 14px; color: #000 !important; background: rgba(255,255,255,0.5);"
                          placeholder="描述圆满后的特殊效果...">{{system.masteryEffect}}</textarea>
            </div>

          </fieldset>
          
        </div>
    </div>

</div>