/* =========================================================
   通用物品 (General) 物品卡专用样式 - Final Fixed Version
   ========================================================= */

/* 1. 局部变量定义 */
.xjzl-window.item.general {
    /* 通用物品主题色：铁灰/靛蓝 */
    --c-theme-main: #4a5c6a;
    --c-theme-light: rgba(74, 92, 106, 0.1);
    --c-theme-border: rgba(74, 92, 106, 0.3);
}

/* 秘籍 (Manual) 特化配色：古籍黄 */
.xjzl-window.item.general.type-manual {
    --c-theme-main: #8a6d3b;
    --c-theme-light: rgba(138, 109, 59, 0.1);
    --c-theme-border: rgba(138, 109, 59, 0.3);
}

/* =========================================
   2. Grid 区域映射 & Tab 切换修复
   ========================================= */
.xjzl-window.item.general [data-application-part="header"] {
    grid-column: 1 / 2;
    grid-row: 1 / 2;
}

.xjzl-window.item.general [data-application-part="details"],
.xjzl-window.item.general [data-application-part="effects"] {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    height: 100%;
}

.xjzl-window.item.general [data-application-part="tabs"] {
    grid-column: 3 / 4;
    grid-row: 1 / 2;
}

/* [关键修复] 强制隐藏非激活的 Tab，解决切换点击问题 */
.xjzl-window.item.general .tab {
    display: none;
    height: 100%;
    /* 确保激活时撑满高度 */
    overflow-y: auto;
    /* 内容溢出滚动 */
}

.xjzl-window.item.general .tab.active {
    display: block;
}

/* =========================================
   3. 输入框视觉皮肤 (Visual Skin)
   ========================================= */

/* 1. 针对所有单行输入框：去除黑底，保留虚线 */
.xjzl-window.item.general input:not([type="checkbox"]) {
    background: transparent !important;
    border: none !important;
    border-bottom: 1px dashed rgba(0, 0, 0, 0.2) !important;
    border-radius: 2px !important;
    color: var(--c-ink-dark) !important;
    box-shadow: none !important;
    font-family: var(--font-serif);
    transition: all 0.2s;
}

/* 2. [重点修复] 文本域 (Textarea - 物品描述)：盒子化 */
.xjzl-window.item.general textarea {
    width: 100% !important;
    /* 强制占满宽度 */
    min-height: 150px;
    /* 最小高度 */

    /* 样式：淡色纸张背景，实线边框 */
    background: rgba(0, 0, 0, 0.03) !important;
    border: 1px solid var(--c-theme-border) !important;
    border-radius: 4px !important;

    padding: 10px !important;
    /* 内边距，防止字贴边 */
    color: var(--c-ink-dark) !important;
    font-family: var(--font-serif);
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
    /* 允许垂直拉伸 */
    box-sizing: border-box;
    /* 防止 padding 撑破宽度 */
}

/* Textarea 聚焦状态 */
.xjzl-window.item.general textarea:focus {
    background: #fff !important;
    border-color: var(--c-theme-main) !important;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.05) !important;
    outline: none !important;
}

/* 3. 头部大标题特殊处理 */
.xjzl-window.item.general .xjzl-sidebar input[name="name"] {
    font-family: var(--font-title);
    font-size: 28px !important;
    text-align: center;
    border-bottom: 2px solid var(--c-theme-main) !important;
    height: 50px !important;
    margin-bottom: 15px;
    color: var(--c-theme-main) !important;
}

/* 4. 下拉框修正 */
.xjzl-window.item.general select {
    background: transparent !important;
    border: none !important;
    border-bottom: 1px dashed rgba(0, 0, 0, 0.2) !important;
    padding-left: 5px;
    cursor: pointer;
    color: var(--c-ink-dark) !important;
}

.xjzl-window.item.general select option {
    background-color: var(--c-paper);
    color: var(--c-ink-dark);
}

/* =========================================
   4. 侧边栏图片 (Sidebar Portrait)
   ========================================= */
.xjzl-window.item.general .portrait-wrapper {
    width: 100%;
    max-width: 140px;
    aspect-ratio: 1/1;
    margin: 20px auto;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    border: 3px solid var(--c-theme-border);
    background: rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.xjzl-window.item.general .portrait-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: none;
    transform: none;
}

/* =========================================
   5. 秘籍拖拽区域 (Manual Drop Zone) - [修复作用域]
   ========================================= */
/* [修复] 增加前缀，防止污染 */
.xjzl-window.item.general .manual-drop-zone {
    border: 2px dashed var(--c-theme-border);
    border-radius: 8px;
    padding: 30px 20px;
    text-align: center;
    background: var(--c-theme-light);
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 20px;
}

.xjzl-window.item.general .manual-drop-zone:hover {
    background: #fff;
    border-color: var(--c-theme-main);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.xjzl-window.item.general .manual-drop-zone i {
    color: var(--c-theme-main);
    margin-bottom: 10px;
    opacity: 0.8;
}

.xjzl-window.item.general .manual-drop-zone .hint-text {
    font-size: 12px;
    color: #888;
}

/* =========================================
   6. 脚本编辑器 (Script Editor - 消耗品专用)
   ========================================= */
.xjzl-window.item.general textarea.script-editor {
    font-family: "Consolas", "Monaco", monospace !important;
    font-size: 12px !important;
    background: rgba(0, 0, 0, 0.03) !important;
    color: #333 !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    min-height: 80px;
}

/* =========================================
   7. 标题样式分级 (Header Styles)
   ========================================= */

/* (A) 一级标题 (h3): 使用云纹装饰 (用于消耗品属性、秘籍内容) */
.xjzl-window.item.general h3 {
    font-family: var(--font-title);
    font-size: 26px;
    border-bottom: none !important;

    display: flex;
    justify-content: center;
    align-items: center;

    position: relative;
    padding-bottom: 10px;
    margin-top: 10px;
    margin-bottom: 25px;
    color: var(--c-theme-main);
}

.xjzl-window.item.general h3::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 260px;
    height: 50px;
    background: url('../../assets/ui/header-divider.png') no-repeat center center;
    background-size: 100% 100%;
    opacity: 0.6;
    z-index: -1;
    pointer-events: none;
}

/* (B) 二级标题 (.xjzl-section-header): 使用简洁下划线 (用于物品描述) */
.xjzl-window.item.general .xjzl-section-header {
    font-family: var(--font-title);
    font-size: 22px;
    color: var(--c-theme-main);

    /* 简洁风格：实线底部 */
    border-bottom: 2px solid var(--c-theme-border);

    display: flex;
    align-items: center;
    padding-bottom: 5px;
    margin-top: 20px;
    margin-bottom: 10px;
}

/* 移除二级标题的伪元素 (如果有残留) */
.xjzl-window.item.general .xjzl-section-header::after {
    display: none;
}

/* 图标微调 */
.xjzl-window.item.general .xjzl-section-header i {
    margin-right: 8px;
    font-size: 0.9em;
    opacity: 0.8;
}

/* =========================================
   8. 属性印章网格修复 (Stats Grid Fix)
   ========================================= */
.xjzl-window.item.general .xjzl-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 10px;
    width: 100%;
}

.xjzl-window.item.general .xjzl-seal-box input {
    background: transparent !important;
    border-bottom: none !important;
    font-size: 24px !important;
    font-weight: 900;
    color: var(--c-theme-main) !important;
}

/* =========================================
   9. 动态品级配色系统 (Dynamic Ranks)
   ========================================= */

/* --- 定义颜色变量 --- */
/* 消耗品/杂物 */
.xjzl-window.item.general.rank-fan {
    --c-rank: #5f5f5f;
    --c-rank-bg: rgba(0, 0, 0, 0.05);
}

/* 凡: 铁灰 */
.xjzl-window.item.general.rank-tong {
    --c-rank: #b87333;
    --c-rank-bg: rgba(184, 115, 51, 0.1);
}

/* 铜: 古铜 */
.xjzl-window.item.general.rank-yin {
    --c-rank: #718093;
    --c-rank-bg: rgba(113, 128, 147, 0.1);
}

/* 银: 亮银灰 */
.xjzl-window.item.general.rank-jin {
    --c-rank: #d4af37;
    --c-rank-bg: rgba(212, 175, 55, 0.1);
}

/* 金: 奢华金 */
.xjzl-window.item.general.rank-yu {
    --c-rank: #2ecc71;
    --c-rank-bg: rgba(46, 204, 113, 0.1);
}

/* 玉: 翡翠绿 */

/* 秘籍 */
.xjzl-window.item.general.rank-ren {
    --c-rank: #7f8c8d;
    --c-rank-bg: rgba(127, 140, 141, 0.1);
}

/* 人: 墨灰 */
.xjzl-window.item.general.rank-di {
    --c-rank: #8d6e63;
    --c-rank-bg: rgba(141, 110, 99, 0.1);
}

/* 地: 大地褐 */
.xjzl-window.item.general.rank-tian {
    --c-rank: #ffa502;
    --c-rank-bg: rgba(255, 165, 2, 0.1);
}

/* 天: 皇室金 */


/* --- 应用配色 --- */

/* 1. 头像框 (Portrait) */
.xjzl-window.item.general .portrait-wrapper {
    border-color: var(--c-rank) !important;
    background: var(--c-rank-bg) !important;
    transition: 0.3s;
}

/* 高级物品特效 (金/玉/天) */
.xjzl-window.item.general.rank-jin .portrait-wrapper,
.xjzl-window.item.general.rank-yu .portrait-wrapper,
.xjzl-window.item.general.rank-tian .portrait-wrapper {
    box-shadow: 0 0 15px var(--c-rank);
    /* 外发光 */
    border-width: 2px;
}

/* 2. 头部名称输入框 (Title Input) */
.xjzl-window.item.general .xjzl-sidebar input[name="name"] {
    color: var(--c-rank) !important;
    border-bottom-color: var(--c-rank) !important;
}

/* 3. 导航栏 Logo (Nav Logo) */
.xjzl-window.item.general .xjzl-nav__logo {
    color: var(--c-rank) !important;
    border-color: var(--c-rank) !important;
    box-shadow: 0 0 10px var(--c-rank-bg) !important;
}

/* 4. 中间云纹标题 (Cloud Header) */
.xjzl-window.item.general h3 {
    color: var(--c-rank) !important;
}

/* 5. 秘籍拖拽区 (Drop Zone) */
/* [修复] 加上前缀 */
.xjzl-window.item.general .manual-drop-zone i {
    color: var(--c-rank) !important;
}

/* [修复] 加上前缀 */
.xjzl-window.item.general .manual-drop-zone:hover {
    border-color: var(--c-rank) !important;
    box-shadow: inset 0 0 10px var(--c-rank-bg);
}

/* 6. 特殊光效动画 (针对 玉 & 天) */
/* [优化] 加上命名前缀 */
@keyframes xjzl-jade-pulse {
    0% {
        box-shadow: 0 0 5px var(--c-rank);
    }

    100% {
        box-shadow: 0 0 15px var(--c-rank), inset 0 0 10px rgba(255, 255, 255, 0.5);
    }
}

.xjzl-window.item.general.rank-yu .portrait-wrapper,
.xjzl-window.item.general.rank-tian .portrait-wrapper {
    animation: xjzl-jade-pulse 3s infinite alternate;
}

/* =========================================
   XJZL - 物品(通用)富文本编辑器样式
   作用域: .xjzl-window.item.general
   ========================================= */

/* 1. 外层容器
   提供定位基准，并处理 hover 感应区 */
.xjzl-window.item.general .xjzl-description-editor {
    position: relative;
    margin-top: 15px;
    /* 这个间距是为了配合上方"物品描述"标题栏 */
    padding: 0 2px;
}

/* 2. ProseMirror 组件本体 (通用设置) */
.xjzl-window.item.general prose-mirror {
    display: block;
    width: 100%;
    box-sizing: border-box;

    /* 继承古风字体 */
    font-family: inherit;
    font-size: 14px;
    line-height: 1.6;

    /* 默认继承，但在下文中我们会分状态强制覆盖颜色 */
    color: inherit;

    /* 平滑过渡效果 */
    transition: all 0.2s ease-in-out;
}

/* =========================================
   状态 A: 阅读模式 (没有 open 属性)
   目标：完全像印在书页上的文字
   ========================================= */
.xjzl-window.item.general prose-mirror:not([open]) {
    /* 【核心】强制高度自适应，覆盖默认行为 */
    height: auto !important;
    min-height: 60px;

    /* 【核心】必须设为 visible，禁止出现滚动条，让内容完全铺开 */
    overflow: visible !important;

    /* 透明背景，无边框 */
    background: transparent;
    border: 1px solid transparent;
    padding: 0 5px;

    /* 强制阅读模式下的普通文字颜色 */
    color: #333 !important;
}

/* 强制内部元素也不限制高度 */
.xjzl-window.item.general prose-mirror:not([open]) .editor-content,
.xjzl-window.item.general prose-mirror:not([open]) .ProseMirror {
    height: auto !important;
    overflow: visible !important;
    padding: 0;
}

/* 阅读时的排版优化 (中文书写习惯) */
.xjzl-window.item.general prose-mirror:not([open]) p {
    margin: 0 0 0.5em 0;
    text-indent: 2em;
    /* 首行缩进 */
    text-align: justify;
    /* 两端对齐 */
}

/* 强制阅读模式下的标题和粗体为深色 (防止继承系统金/白亮色) */
.xjzl-window.item.general prose-mirror:not([open]) :is(h1, h2, h3, h4, h5, h6) {
    color: #222 !important;
    text-shadow: none !important;
    border-bottom-color: #ccc !important;
    font-weight: bold !important;
    margin-top: 0.5em;
    margin-bottom: 0.3em;
}

.xjzl-window.item.general prose-mirror:not([open]) :is(strong, b, em, i, code) {
    color: #000 !important;
    text-shadow: none !important;
}

/* =========================================
   状态 B: 编辑模式 (有 open 属性)
   目标：提供独立的写作空间，防遮挡
   ========================================= */
.xjzl-window.item.general prose-mirror[open] {
    /* 【特有设置】针对物品卡的固定高度 300px */
    height: 300px !important;

    /* 【核心】开启 Flex 垂直布局 */
    display: flex !important;
    flex-direction: column;

    /* 外观：白底卡片 */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--color-border-light-2);
    border-radius: 4px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    z-index: 100;

    /* 【修复】容器级别强制深色，去阴影 */
    color: #333 !important;
    text-shadow: none !important;
}

/* B1. 工具栏 (Menu) */
.xjzl-window.item.general prose-mirror[open] .editor-menu {
    flex: 0 0 auto;
    background: #f1ebd8;
    border-bottom: 1px solid #d0c8b6;
    border-radius: 4px 4px 0 0;
    padding: 2px;

    /* 工具栏文字颜色 */
    color: #333;
}

/* B2. 内容包裹器 */
.xjzl-window.item.general prose-mirror[open] .editor-container {
    flex: 1;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* B3. 真正的输入区 */
.xjzl-window.item.general prose-mirror[open] .ProseMirror {
    flex: 1;
    overflow-y: auto;
    padding: 10px 15px;
    height: 100%;

    /* 强制正文黑字 */
    color: #000 !important;
    text-shadow: none !important;
}

/* 编辑模式下的标题 (H1-H6) 颜色修复 */
.xjzl-window.item.general prose-mirror[open] .ProseMirror :is(h1, h2, h3, h4, h5, h6) {
    color: #111 !important;
    /* 强制黑色 */
    text-shadow: none !important;
    /* 去除阴影 */
    border-bottom-color: #aaa !important;
    /* 修复下划线颜色 */
    font-family: inherit !important;
}

/* 编辑模式下的格式 (粗体/斜体/代码/链接) */
.xjzl-window.item.general prose-mirror[open] .ProseMirror :is(strong, b, em, i, code) {
    color: #000 !important;
    text-shadow: none !important;
}

.xjzl-window.item.general prose-mirror[open] .ProseMirror a {
    color: #0000ee !important;
    /* 深蓝色链接 */
    text-shadow: none !important;
}

/* =========================================
   UI 细节：编辑按钮 & 保存高亮
   ========================================= */

/* --- 1. 阅读模式下的按钮 (强制常亮) --- */
.xjzl-window.item.general prose-mirror:not([open]) .toggle {
    position: absolute;
    /* 定位到“物品描述”标题栏右侧 */
    top: -28px;
    right: 0;

    background: none;
    border: none;
    cursor: pointer;

    /* 强制显示 */
    display: block !important;
    visibility: visible !important;
    opacity: 0.8 !important;

    color: var(--color-text-dark-primary);
    z-index: 10;
    padding: 0 5px;
    transition: all 0.2s;
}

/* 鼠标移上去变得完全不透明、放大 */
.xjzl-window.item.general prose-mirror:not([open]) .toggle:hover {
    opacity: 1 !important;
    transform: scale(1.2);
    text-shadow: 0 0 3px currentColor;
}

/* --- 2. 编辑模式 (直接隐藏右上角那个没用的开关) --- */
.xjzl-window.item.general prose-mirror[open]>.toggle {
    display: none !important;
}

/* --- 3. 保存按钮高亮 --- */
.xjzl-window.item.general prose-mirror[open] .editor-menu button[data-action="save"] {
    color: #333 !important;
    /* 强制深色 */
    font-weight: bold;
}

/* 鼠标悬停在保存按钮上时 */
.xjzl-window.item.general prose-mirror[open] .editor-menu button[data-action="save"]:hover {
    color: #000 !important;
    transform: scale(1.1);
}