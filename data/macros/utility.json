[
    {
        "name": "ğŸ§¹ [è°ƒè¯•] æ¸…ç†è§’è‰²æ ‡è®° (Flags)",
        "type": "script",
        "img": "icons/svg/net.svg",
        "command": "(async () => {\n    const { DialogV2 } = foundry.applications.api;\n\n    // 1. è·å–ç›®æ ‡\n    const actor = token?.actor || game.user.character;\n    if (!actor) return ui.notifications.warn(\"è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰² (Token)ï¼\");\n\n    const SYSTEM_ID = \"xjzl-system\";\n    const allFlags = actor.flags[SYSTEM_ID] || {};\n\n    // 2. æ‰«æå¹¶åˆ†ç±» Flags\n    const categories = {\n        \"neigong_\": \"ğŸ§˜ å†…åŠŸç›¸å…³\",\n        \"wuxue_\": \"âš”ï¸ æ­¦å­¦ç›¸å…³\",\n        \"weapon_\": \"ğŸ—¡ï¸ æ­¦å™¨çŠ¶æ€\",\n        \"armor_\": \"ğŸ›¡ï¸ é˜²å…·çŠ¶æ€\",\n        \"consumed_\": \"ğŸ’Š æ¶ˆè€—å“è®°å½•\",\n        \"other\": \"ğŸ“‚ å…¶ä»–æ•°æ®\"\n    };\n\n    const grouped = {\n        \"neigong_\": [], \"wuxue_\": [], \"weapon_\": [], \"armor_\": [], \"consumed_\": [], \"other\": []\n    };\n\n    let totalCount = 0;\n\n    for (const [key, value] of Object.entries(allFlags)) {\n        let matched = false;\n        for (const prefix of [\"neigong_\", \"wuxue_\", \"weapon_\", \"armor_\", \"consumed_\"]) {\n            if (key.startsWith(prefix)) {\n                grouped[prefix].push({ key, val: value });\n                matched = true;\n                break;\n            }\n        }\n        if (!matched) {\n            grouped[\"other\"].push({ key, val: value });\n        }\n        totalCount++;\n    }\n\n    if (totalCount === 0) {\n        return ui.notifications.info(`${actor.name} èº«ä¸Šæ²¡æœ‰ä»»ä½•ç³»ç»Ÿæ ‡è®°ã€‚`);\n    }\n\n    // 3. æ„å»º HTML\n    let content = `\n    <style>\n        .xjzl-flag-group { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }\n        .xjzl-flag-header { background: rgba(0,0,0,0.05); padding: 5px 8px; font-weight: bold; font-size: 0.9em; border-bottom: 1px solid #eee; }\n        .xjzl-flag-item { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px dashed rgba(0,0,0,0.05); font-size: 0.85em; }\n        .xjzl-flag-item:last-child { border-bottom: none; }\n        .xjzl-flag-item label { margin-left: 8px; flex: 1; cursor: pointer; word-break: break-all; }\n        .xjzl-flag-val { font-family: monospace; background: rgba(0,0,0,0.05); padding: 0 4px; border-radius: 2px; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n    </style>\n    <p>æ£€æµ‹åˆ° <strong>${actor.name}</strong> å…±æœ‰ ${totalCount} æ¡è®°å½•ã€‚</p>\n    <form class=\"xjzl-flag-form\">`;\n\n    for (const [prefix, list] of Object.entries(grouped)) {\n        if (list.length === 0) continue;\n        \n        content += `<div class=\"xjzl-flag-group\">\n            <div class=\"xjzl-flag-header\">${categories[prefix]} (${list.length})</div>`;\n        \n        for (const item of list) {\n            let displayVal = JSON.stringify(item.val);\n            if(displayVal.length > 20) displayVal = displayVal.substring(0, 20) + \"...\";\n            \n            // ã€ä¿®å¤ã€‘è½¬ä¹‰åŒå¼•å·ï¼Œé˜²æ­¢ HTML å±æ€§æˆªæ–­å¯¼è‡´ InvalidCharacterError\n            const safeTitle = JSON.stringify(item.val).replace(/\"/g, '&quot;');\n\n            content += `\n            <div class=\"xjzl-flag-item\">\n                <input type=\"checkbox\" id=\"${item.key}\" name=\"${item.key}\" checked>\n                <label for=\"${item.key}\">${item.key}</label>\n                <span class=\"xjzl-flag-val\" title=\"${safeTitle}\">${displayVal}</span>\n            </div>`;\n        }\n        content += `</div>`;\n    }\n    content += `</form>`;\n\n    // 4. å¼¹çª—ç¡®è®¤\n    const result = await DialogV2.wait({\n        window: { title: `ğŸ§¹ æ¸…ç†æ ‡è®°: ${actor.name}`, icon: \"fas fa-trash-alt\", width: 400 },\n        content: content,\n        buttons: [{\n            action: \"delete\",\n            label: \"åˆ é™¤é€‰ä¸­é¡¹\",\n            icon: \"fas fa-check\",\n            class: \"damage-tool-btn\", \n            callback: (event, button, dialog) => {\n                const form = dialog.element.querySelector(\".xjzl-flag-form\");\n                const checked = form.querySelectorAll('input[type=\"checkbox\"]:checked');\n                return Array.from(checked).map(input => input.name);\n            }\n        }],\n        close: () => []\n    });\n\n    // 5. æ‰§è¡Œåˆ é™¤\n    if (result && result.length > 0) {\n        for (const key of result) {\n            await actor.unsetFlag(SYSTEM_ID, key);\n        }\n        ui.notifications.info(`å·²æ¸…ç† ${result.length} æ¡æ•°æ®è®°å½•ã€‚`);\n    }\n})();"
    },
    {
        "name": "â­• [å¿«æ·] åˆ›å»ºè·Ÿéšå…‰ç¯",
        "type": "script",
        "scope": "global",
        "img": "icons/svg/aura.svg",
        "command": "(async () => {\n    // --- é…ç½®åŒºåŸŸ ---\n    const CONFIG = {\n        label: \"æ°”æµ·çœŸè¯€\",   // é»˜è®¤æ˜¾ç¤ºçš„æ–‡å­—\n        distance: 10,        // åŠå¾„ (æ ¼)\n        color: \"#FFD700\"    // é¢œè‰² (é‡‘é»„è‰²)\n    };\n\n    const scene = canvas.scene;\n    if (!scene) return ui.notifications.warn(\"å½“å‰æ²¡æœ‰åœºæ™¯ï¼\");\n\n    // 1. è·å–é€‰ä¸­Token\n    const token = canvas.tokens.controlled[0];\n    if (!token) return ui.notifications.warn(\"è¯·å…ˆé€‰ä¸­ä¸€ä¸ªè§’è‰²(Token)æ¥ä½¿ç”¨è·Ÿéšå…‰ç¯ã€‚\");\n\n    // 2. è®¡ç®—ä½ç½® (Tokenä¸­å¿ƒ)\n    const { x, y } = token.center;\n\n    // 3. è®¡ç®—å®é™…è·ç¦»\n    const finalDistance = CONFIG.distance * (canvas.dimensions.distance || 1);\n\n    // 4. åˆ›å»ºæ¨¡æ¿\n    await scene.createEmbeddedDocuments(\"MeasuredTemplate\", [{\n        t: \"circle\",\n        user: game.user.id,\n        distance: finalDistance,\n        direction: 0,\n        x: x,\n        y: y,\n        fillColor: CONFIG.color,\n        flags: {\n            \"xjzl-system\": {\n                label: CONFIG.label,\n                sourceToken: token.id,\n                sticky: true  // å¼€å¯è·Ÿéš\n            }\n        }\n    }]);\n})();"
    },
    {
        "name": "ğŸ¯ [å¿«æ·] é¼ æ ‡ä½ç½®åˆ›å»ºåŒºåŸŸ",
        "type": "script",
        "scope": "global",
        "img": "icons/svg/target.svg",
        "command": "(async () => {\n    // --- é…ç½®åŒºåŸŸ ---\n    const CONFIG = {\n        label: \"æ‹­å‰‘å¬é£\",   // é»˜è®¤æ˜¾ç¤ºçš„æ–‡å­—\n        distance: 3,        // åŠå¾„ (æ ¼)\n        color: \"#DC143C\"    // é¢œè‰² (çŒ©çº¢è‰²)\n    };\n\n    const scene = canvas.scene;\n    if (!scene) return ui.notifications.warn(\"å½“å‰æ²¡æœ‰åœºæ™¯ï¼\");\n\n    // 1. è·å–é¼ æ ‡ä½ç½® (V13 API)\n    const mousePos = canvas.mousePosition;\n    if (!mousePos) return;\n\n    // 2. å¯¹é½ç½‘æ ¼ä¸­å¿ƒ\n    const grid = canvas.grid;\n    const offset = grid.getOffset(mousePos);\n    const center = grid.getCenterPoint(offset);\n\n    // 3. è®¡ç®—å®é™…è·ç¦»\n    const finalDistance = CONFIG.distance * (canvas.dimensions.distance || 1);\n\n    // 4. åˆ›å»ºæ¨¡æ¿\n    await scene.createEmbeddedDocuments(\"MeasuredTemplate\", [{\n        t: \"circle\",\n        user: game.user.id,\n        distance: finalDistance,\n        direction: 0,\n        x: center.x,\n        y: center.y,\n        fillColor: CONFIG.color,\n        flags: {\n            \"xjzl-system\": {\n                label: CONFIG.label,\n                sourceToken: null,\n                sticky: false // é™æ€ä¸è·Ÿéš\n            }\n        }\n    }]);\n})();"
    },
    {
        "name": "âš”ï¸ [èŒƒä¾‹] è‡ªåŠ¨åŒ–å¯¹æŠ— (å¸æ˜Ÿå¤§æ³•)",
        "type": "script",
        "scope": "global",
        "img": "icons/magic/life/heart-shadow-red.webp",
        "command": "(async () => {\n    // 1. è·å–å®åŠ©æ‰‹\n    const Macros = game.xjzl.Macros;\n    if (!Macros) return ui.notifications.error(\"ç³»ç»Ÿæ ¸å¿ƒæœªåŠ è½½ã€‚\");\n\n    // 2. è·å–é€‰ä¸­ç›®æ ‡ (éœ€é€‰ä¸­2ä¸ª)\n    const tokens = canvas.tokens.controlled;\n    if (tokens.length < 2) return ui.notifications.warn(\"è¯·é€‰ä¸­ä¸¤ä¸ªTokenï¼š\\n1. å‘èµ·è€… (å¸å–æ–¹)\\n2. å¯¹æŠ—è€… (è¢«å¸æ–¹)\");\n\n    const attacker = tokens[0].actor;\n    const defender = tokens[1].actor;\n\n    // 3. å‘èµ·è¯·æ±‚\n    await Macros.requestContest({\n        attacker: attacker,\n        defender: defender,\n        type: \"neixi\",     // æ”»æ–¹å±æ€§: å†…æ¯\n        defType: \"dingli\", // å®ˆæ–¹å±æ€§: å®šåŠ›\n        label: \"å¸æ˜Ÿå¤§æ³•\",\n        \n        // ğŸ† è‡ªåŠ¨åŒ–ç»“æœé…ç½®\n        outcome: {\n            // å‘èµ·è€…èƒœåˆ©\n            win: {\n                text: \"ä½ çš„ä¸¹ç”°å¦‚é»‘æ´èˆ¬åå™¬äº†å¯¹æ–¹çš„å†…åŠ›ï¼\",\n                selfRecovery: { value: 50, type: \"mp\" }, // è‡ªå·±å› 50 å†…åŠ›\n                targetDamage: { value: 50, type: \"mp\" }, // å¯¹æ–¹æ‰£ 50 å†…åŠ›\n                targetEffect: \"weak\" // ç»™å¯¹æ–¹ä¸Šè™šå¼± (éœ€ç³»ç»Ÿå†…æœ‰æ­¤çŠ¶æ€ID)\n            },\n            // å‘èµ·è€…å¤±è´¥\n            lose: {\n                text: \"å¯¹æ–¹å†…åŠ›æµ‘åšï¼Œä½ å¸å–ä¸æˆåé­çœŸæ°”åå™¬ï¼\",\n                selfDamage: { value: 20, type: \"hp\" }, // è‡ªå·±æ‰£ 20 è¡€\n                selfEffect: \"prone\" // è‡ªå·±å€’åœ°\n            }\n        }\n    });\n})();"
    }
]