[
    {
        "name": "ğŸ§¹ [è°ƒè¯•] æ¸…ç†è§’è‰²æ ‡è®° (Flags)",
        "type": "script",
        "img": "icons/svg/net.svg",
        "command": "(async () => {\n    const { DialogV2 } = foundry.applications.api;\n\n    // 1. è·å–ç›®æ ‡\n    const actor = token?.actor || game.user.character;\n    if (!actor) return ui.notifications.warn(\"è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰² (Token)ï¼\");\n\n    const SYSTEM_ID = \"xjzl-system\";\n    const allFlags = actor.flags[SYSTEM_ID] || {};\n\n    // 2. æ‰«æå¹¶åˆ†ç±» Flags\n    const categories = {\n        \"neigong_\": \"ğŸ§˜ å†…åŠŸç›¸å…³\",\n        \"wuxue_\": \"âš”ï¸ æ­¦å­¦ç›¸å…³\",\n        \"weapon_\": \"ğŸ—¡ï¸ æ­¦å™¨çŠ¶æ€\",\n        \"armor_\": \"ğŸ›¡ï¸ é˜²å…·çŠ¶æ€\",\n        \"consumed_\": \"ğŸ’Š æ¶ˆè€—å“è®°å½•\",\n        \"other\": \"ğŸ“‚ å…¶ä»–æ•°æ®\"\n    };\n\n    const grouped = {\n        \"neigong_\": [], \"wuxue_\": [], \"weapon_\": [], \"armor_\": [], \"consumed_\": [], \"other\": []\n    };\n\n    let totalCount = 0;\n\n    for (const [key, value] of Object.entries(allFlags)) {\n        let matched = false;\n        for (const prefix of [\"neigong_\", \"wuxue_\", \"weapon_\", \"armor_\", \"consumed_\"]) {\n            if (key.startsWith(prefix)) {\n                grouped[prefix].push({ key, val: value });\n                matched = true;\n                break;\n            }\n        }\n        if (!matched) {\n            grouped[\"other\"].push({ key, val: value });\n        }\n        totalCount++;\n    }\n\n    if (totalCount === 0) {\n        return ui.notifications.info(`${actor.name} èº«ä¸Šæ²¡æœ‰ä»»ä½•ç³»ç»Ÿæ ‡è®°ã€‚`);\n    }\n\n    // 3. æ„å»º HTML\n    let content = `\n    <style>\n        .xjzl-flag-group { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }\n        .xjzl-flag-header { background: rgba(0,0,0,0.05); padding: 5px 8px; font-weight: bold; font-size: 0.9em; border-bottom: 1px solid #eee; }\n        .xjzl-flag-item { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px dashed rgba(0,0,0,0.05); font-size: 0.85em; }\n        .xjzl-flag-item:last-child { border-bottom: none; }\n        .xjzl-flag-item label { margin-left: 8px; flex: 1; cursor: pointer; word-break: break-all; }\n        .xjzl-flag-val { font-family: monospace; background: rgba(0,0,0,0.05); padding: 0 4px; border-radius: 2px; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n    </style>\n    <p>æ£€æµ‹åˆ° <strong>${actor.name}</strong> å…±æœ‰ ${totalCount} æ¡è®°å½•ã€‚</p>\n    <form class=\"xjzl-flag-form\">`;\n\n    for (const [prefix, list] of Object.entries(grouped)) {\n        if (list.length === 0) continue;\n        \n        content += `<div class=\"xjzl-flag-group\">\n            <div class=\"xjzl-flag-header\">${categories[prefix]} (${list.length})</div>`;\n        \n        for (const item of list) {\n            let displayVal = JSON.stringify(item.val);\n            if(displayVal.length > 20) displayVal = displayVal.substring(0, 20) + \"...\";\n            \n            // ã€ä¿®å¤ã€‘è½¬ä¹‰åŒå¼•å·ï¼Œé˜²æ­¢ HTML å±æ€§æˆªæ–­å¯¼è‡´ InvalidCharacterError\n            const safeTitle = JSON.stringify(item.val).replace(/\"/g, '&quot;');\n\n            content += `\n            <div class=\"xjzl-flag-item\">\n                <input type=\"checkbox\" id=\"${item.key}\" name=\"${item.key}\" checked>\n                <label for=\"${item.key}\">${item.key}</label>\n                <span class=\"xjzl-flag-val\" title=\"${safeTitle}\">${displayVal}</span>\n            </div>`;\n        }\n        content += `</div>`;\n    }\n    content += `</form>`;\n\n    // 4. å¼¹çª—ç¡®è®¤\n    const result = await DialogV2.wait({\n        window: { title: `ğŸ§¹ æ¸…ç†æ ‡è®°: ${actor.name}`, icon: \"fas fa-trash-alt\", width: 400 },\n        content: content,\n        buttons: [{\n            action: \"delete\",\n            label: \"åˆ é™¤é€‰ä¸­é¡¹\",\n            icon: \"fas fa-check\",\n            class: \"damage-tool-btn\", \n            callback: (event, button, dialog) => {\n                const form = dialog.element.querySelector(\".xjzl-flag-form\");\n                const checked = form.querySelectorAll('input[type=\"checkbox\"]:checked');\n                return Array.from(checked).map(input => input.name);\n            }\n        }],\n        close: () => []\n    });\n\n    // 5. æ‰§è¡Œåˆ é™¤\n    if (result && result.length > 0) {\n        for (const key of result) {\n            await actor.unsetFlag(SYSTEM_ID, key);\n        }\n        ui.notifications.info(`å·²æ¸…ç† ${result.length} æ¡æ•°æ®è®°å½•ã€‚`);\n    }\n})();"
    }
]