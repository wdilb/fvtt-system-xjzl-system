[
    {
        "name": "《华山心法》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/华山.png",
        "system": {
            "tier": 1,
            "element": "yin",
            "sect": "huashanpai",
            "description": "<p>华山派入门内功，注重锻炼华山弟子基础，较为均衡，特殊之处在于蕴养“剑心”，打磨手中剑，积蓄剑意。</p>",
            "requirement": "<p>悟性需求：1</p>",
            "automationNote": "完全自动化。剑法伤害加成与剑等级加成已实现。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 3,
                        "shenfa": 3,
                        "tipo": 3,
                        "neixi": 4,
                        "qigan": 3,
                        "shencai": 2
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 7,
                        "shenfa": 6,
                        "tipo": 6,
                        "neixi": 8,
                        "qigan": 5,
                        "shencai": 4
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage3": {
                    "stats": {
                        "liliang": 11,
                        "shenfa": 8,
                        "tipo": 9,
                        "neixi": 12,
                        "qigan": 8,
                        "shencai": 6
                    },
                    "description": "<p>圆满运功特效：使用剑法套路时，招式伤害+5。<br>·你的[剑]等级+1。<br>修满特效：修满[永久]：气血+10，内力+10。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "华山心法-剑法增伤",
                            "trigger": "calc",
                            "script": "if (args.move.weaponType === 'sword') {\n    args.output.damage += 5;\n    args.output.bonusDesc.push('华山心法 +5');\n}",
                            "active": true
                        },
                        {
                            "label": "华山心法-剑等级提升",
                            "trigger": "passive",
                            "script": "S.combat.weaponRanks.sword.mod += 1;",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "<p>修满[永久]：气血+10，内力+10。</p>",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 10,
                    "label": "气血"
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 10,
                    "label": "内力"
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《抱元功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/华山.png",
        "system": {
            "tier": 2,
            "element": "yin",
            "sect": "huashanpai",
            "description": "<p>华山派核心内功心法。排除杂念，保持清静，以打坐练形，追求至知行、身心合一的境界，圆满后功力醇厚，内劲难当。</p>",
            "requirement": "<p>悟性需求：4</p>",
            "automationNote": "完全自动化。减伤效果通过 preTake 时机实现。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 14,
                        "shenfa": 5,
                        "tipo": 9,
                        "neixi": 6,
                        "qigan": 7,
                        "shencai": 7
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 27,
                        "shenfa": 14,
                        "tipo": 18,
                        "neixi": 13,
                        "qigan": 13,
                        "shencai": 11
                    },
                    "description": "<p>小成运功特效：被攻击时减少10点内外功伤害。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "抱元功-小成减伤",
                            "trigger": "preTake",
                            "script": "if (['waigong', 'neigong'].includes(args.type)) {\n    args.output.damage = Math.max(0, args.output.damage - 10);\n    ui.notifications.info('抱元功抵消了 10 点伤害');\n}",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 40,
                        "shenfa": 21,
                        "tipo": 25,
                        "neixi": 22,
                        "qigan": 21,
                        "shencai": 15
                    },
                    "description": "<p>圆满运功特效：被攻击时减少15点内外功伤害。<br>修满特效：修满[永久]：气血+40，内力+20，内功防御+5。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "抱元功-圆满减伤",
                            "trigger": "preTake",
                            "script": "if (['waigong', 'neigong'].includes(args.type)) {\n    args.output.damage = Math.max(0, args.output.damage - 15);\n    ui.notifications.info('抱元功抵消了 15 点伤害');\n}",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "<p>修满[永久]：气血+40，内力+20，内功防御+5。</p>",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 40,
                    "label": "气血"
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 20,
                    "label": "内力"
                },
                {
                    "key": "combat.def_neigong",
                    "value": 5,
                    "label": "内防"
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《混元功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/华山.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "huashanpai",
            "description": "<p>混元功在传统开合功的基础上几经提炼、深化而形成，为万法之基础，和混元掌相辅相成。修行大成后，可治病健身，延年益寿。</p>",
            "requirement": "<p>悟性需求：5</p>",
            "automationNote": "部分自动化。混元状态下的受击回血已实现（通过预设AE实现回合末自动回复）。圆满特效中“被添加状态时投掷d20移除”无法自动触发，请玩家手动执行。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 6,
                        "shenfa": 4,
                        "tipo": 9,
                        "neixi": 14,
                        "qigan": 11,
                        "shencai": 4
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 12,
                        "shenfa": 8,
                        "tipo": 18,
                        "neixi": 28,
                        "qigan": 22,
                        "shencai": 8
                    },
                    "description": "<p>小成运功特效：你有怒气时，进入“混元”状态。<br>混元：当你处于下盘不稳、倒地、禁足、目盲、耳鸣时被攻击，在该回合末回复20点气血。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元功-混元回血(小成)",
                            "trigger": "damaged",
                            "script": "const rage = S.resources.rage.value;\nconst s = actor.xjzlStatuses;\nif (rage > 0 && (s.unstable || s.prone || s.root || s.blind || s.deaf)) {\n    const sourceEffect = thisItem.effects.getName(\"混元回血\");\n    if (sourceEffect) {\n        const effectData = sourceEffect.toObject();\n        delete effectData._id;\n        effectData.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(actor, effectData);\n        ui.notifications.info(\"混元功触发：回合末将回复20点气血\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 18,
                        "shenfa": 12,
                        "tipo": 27,
                        "neixi": 42,
                        "qigan": 33,
                        "shencai": 12
                    },
                    "description": "<p>圆满运功特效：你有怒气时，获得“混元”。<br>混元：当你处于下盘不稳、倒地、禁足、目盲、耳鸣时被攻击，在该回合末回复20点气血。<br>你每次被敌人添加状态时，投掷一个d20，如果大于10，移除该状态。<br>修满特效：修满[永久]：气血+30，内力+30，气感+5。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元功-混元回血(圆满)",
                            "trigger": "damaged",
                            "script": "const rage = S.resources.rage.value;\nconst s = actor.xjzlStatuses;\nif (rage > 0 && (s.unstable || s.prone || s.root || s.blind || s.deaf)) {\n    const sourceEffect = thisItem.effects.getName(\"混元回血\");\n    if (sourceEffect) {\n        const effectData = sourceEffect.toObject();\n        delete effectData._id;\n        effectData.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(actor, effectData);\n        ui.notifications.info(\"混元功触发：回合末将回复20点气血\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "<p>修满[永久]：气血+30，内力+30，气感+5。</p>",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 30,
                    "label": "气血"
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 30,
                    "label": "内力"
                },
                {
                    "key": "stats.qigan.mod",
                    "value": 5,
                    "label": "气感"
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "混元回血",
                "icon": "icons/svg/heal.svg",
                "transfer": false,
                "disabled": false,
                "duration": {
                    "rounds": 1
                },
                "changes": [
                    {
                        "key": "flags.xjzl-system.regenHpTurnEnd",
                        "mode": 2,
                        "value": "20"
                    }
                ],
                "description": "混元功触发：回合结束时回复20点气血。"
            }
        ]
    },
    {
        "name": "《紫极功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/华山.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "huashanpai",
            "description": "<p>华山派祖师所创，为道家修炼心法，技击之无上玄功。发功时脸上满布紫气，内劲铺天盖地，可以内力震伤外敌，势不可当。</p>",
            "requirement": "<p>悟性需求：10</p>",
            "automationNote": "完全自动化。内力上限增伤、命中后吸取内力效果均已实现。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 35,
                        "shenfa": 20,
                        "tipo": 25,
                        "neixi": 15,
                        "qigan": 15,
                        "shencai": 10
                    },
                    "description": "<p>领悟运功特效：出招提升内力上限10%的伤害。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "紫极功-内力增伤",
                            "trigger": "calc",
                            "script": "const bonus = Math.floor(S.resources.mp.max * 0.1);\nif (bonus > 0) {\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`紫极功 +${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 65,
                        "shenfa": 40,
                        "tipo": 55,
                        "neixi": 30,
                        "qigan": 30,
                        "shencai": 20
                    },
                    "description": "<p>小成运功特效：出招提升内力上限10%的伤害。<br>攻击命中后，对方流失5内力，你回复5内力。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "紫极功-内力增伤",
                            "trigger": "calc",
                            "script": "const bonus = Math.floor(S.resources.mp.max * 0.1);\nif (bonus > 0) {\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`紫极功 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "紫极功-吸星(小成)",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    // 自身回复\n    await args.attacker.applyHealing({amount: 5, type: 'mp'});\n    // 敌方流失\n    const tMp = args.target.system.resources.mp.value;\n    if (tMp > 0) {\n        await args.target.update({\"system.resources.mp.value\": Math.max(0, tMp - 5)});\n        ui.notifications.info(`${args.target.name} 流失了 5 点内力`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 95,
                        "shenfa": 60,
                        "tipo": 75,
                        "neixi": 50,
                        "qigan": 50,
                        "shencai": 30
                    },
                    "description": "<p>圆满运功特效：出招提升内力上限10%的伤害。<br>攻击命中后，对方流失10内力，你回复10内力。<br>修满特效：修满[永久]：气血+60，内力+60，内息+10。</p>",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "紫极功-内力增伤",
                            "trigger": "calc",
                            "script": "const bonus = Math.floor(S.resources.mp.max * 0.1);\nif (bonus > 0) {\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`紫极功 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "紫极功-吸星(圆满)",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    // 自身回复\n    await args.attacker.applyHealing({amount: 10, type: 'mp'});\n    // 敌方流失\n    const tMp = args.target.system.resources.mp.value;\n    if (tMp > 0) {\n        await args.target.update({\"system.resources.mp.value\": Math.max(0, tMp - 10)});\n        ui.notifications.info(`${args.target.name} 流失了 10 点内力`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "<p>修满[永久]：气血+60，内力+60，内息+10。</p>",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 60,
                    "label": "气血"
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 60,
                    "label": "内力"
                },
                {
                    "key": "stats.neixi.mod",
                    "value": 10,
                    "label": "内息"
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    }
]