[
    {
        "name": "《兽吼功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/万兽.png",
        "system": {
            "tier": 1,
            "element": "yang",
            "sect": "wanshoushanzhuang",
            "description": "万兽山庄入门内功，模仿野兽吼叫时的姿态和吐气呼气来练习吐纳，模拟兽音，练成后声震山林，可与野兽交流。",
            "requirement": "悟性需求: 1",
            "automationNote": "完全自动化。兽吼范围伤害通过Hit脚本自动遍历场景Token实现。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 4,
                        "shenfa": 3,
                        "tipo": 4,
                        "neixi": 3,
                        "qigan": 1,
                        "shencai": 3
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 8,
                        "shenfa": 6,
                        "tipo": 8,
                        "neixi": 6,
                        "qigan": 2,
                        "shencai": 6
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage3": {
                    "stats": {
                        "liliang": 12,
                        "shenfa": 9,
                        "tipo": 12,
                        "neixi": 9,
                        "qigan": 3,
                        "shencai": 9
                    },
                    "description": "圆满运功特效：你出招命中目标时，可消耗反应动作发出兽吼，使周围3米的敌人流失5点气血。<br>修满特效：修满[永久]：气血+10，内力+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "兽吼震慑",
                            "trigger": "hit",
                            "script": "if (args.type === 'attack' && args.isHit) { const enemies = canvas.tokens.placeables.filter(t => t.actor && t.actor.id !== actor.id && (Math.hypot(t.x - actor.token.object.x, t.y - actor.token.object.y) / canvas.grid.size * canvas.dimensions.distance) <= 3); for (let e of enemies) { await e.actor.applyDamage({amount: 5, type: 'liushi', isHit: true}); } ui.notifications.info(`兽吼：震伤了 ${enemies.length} 个目标`); }",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "",
            "masteryChanges": [
                {
                    "key": "system.resources.hp.max",
                    "value": 10
                },
                {
                    "key": "system.resources.mp.max",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《五禽戏》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/万兽.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "wanshoushanzhuang",
            "description": "万兽核心内功，传为华佗所作奇特功法，分别仿效虎之威猛、鸟之轻灵、熊之沉稳、鹿之安舒、猿之灵觉，史家兄弟日夜相伴野兽，悟出此功，可强身健体，导引养生。",
            "requirement": "悟性需求: 4",
            "automationNote": "暴击骰修正已自动应用。释放距离增加需玩家手动判断。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 10,
                        "shenfa": 10,
                        "tipo": 8,
                        "neixi": 6,
                        "qigan": 10,
                        "shencai": 4
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 20,
                        "shenfa": 20,
                        "tipo": 16,
                        "neixi": 12,
                        "qigan": 20,
                        "shencai": 8
                    },
                    "description": "小成运功特效：你的招式释放距离+1，暴击骰-1。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "五禽灵动(小成)",
                            "trigger": "passive",
                            "script": "S.combat.crit_waigong -= 1; S.combat.crit_neigong -= 1;",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 32,
                        "shenfa": 30,
                        "tipo": 24,
                        "neixi": 18,
                        "qigan": 30,
                        "shencai": 10
                    },
                    "description": "圆满运功特效：你的招式释放距离+2，暴击骰-2。<br>修满特效：修满[永久]：气血+40，内力+20，格挡值+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "五禽灵动(圆满)",
                            "trigger": "passive",
                            "script": "S.combat.crit_waigong -= 2; S.combat.crit_neigong -= 2;",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "",
            "masteryChanges": [
                {
                    "key": "system.resources.hp.max",
                    "value": 40
                },
                {
                    "key": "system.resources.mp.max",
                    "value": 20
                },
                {
                    "key": "system.combat.block",
                    "value": 5
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《伏气功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/万兽.png",
        "system": {
            "tier": 2,
            "element": "yang",
            "sect": "wanshoushanzhuang",
            "description": "万兽山庄核心功法，以呼吸调养生息，内力生生不息，全身筋脉，意到气到，意之所至，坚于铁石。",
            "requirement": "悟性需求: 4",
            "automationNote": "完全自动化。每3次出招触发'伏气充盈'特效(免耗回蓝)已提取为ItemEffect。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 12,
                        "shenfa": 11,
                        "tipo": 7,
                        "neixi": 6,
                        "qigan": 6,
                        "shencai": 6
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 27,
                        "shenfa": 21,
                        "tipo": 15,
                        "neixi": 12,
                        "qigan": 12,
                        "shencai": 9
                    },
                    "description": "小成运功特效：进战后，每出招三次后，下次出招不消耗内力，并恢复10点内力。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "伏气循环",
                            "trigger": "hit",
                            "script": "let count = actor.getFlag('xjzl-system', 'neigong_fuqi_count') || 0; count++; if (count >= 3) { const eff = thisItem.effects.getName('伏气充盈(小成)'); if(eff) { const data = eff.toObject(); delete data._id; await game.xjzl.api.effects.addEffect(actor, data); ui.notifications.info('伏气功：气息流转，下次出招免耗回蓝。'); count = 0; } } await actor.setFlag('xjzl-system', 'neigong_fuqi_count', count);",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 40,
                        "shenfa": 31,
                        "tipo": 25,
                        "neixi": 18,
                        "qigan": 18,
                        "shencai": 12
                    },
                    "description": "圆满运功特效：进战后，每出招三次后，下次出招不消耗内力，并恢复20点内力。<br>·自身气血低于最大值30%时，进入“伏气”，持续到你的气血高于30%。<br>伏气：受到内外功伤害时，可以消耗1点内力抵消3点伤害。（但至少会受到1点伤害）<br>修满特效：修满[永久]：内力+40，外功防御+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "伏气循环(圆满)",
                            "trigger": "hit",
                            "script": "let count = actor.getFlag('xjzl-system', 'neigong_fuqi_count') || 0; count++; if (count >= 3) { const eff = thisItem.effects.getName('伏气充盈(圆满)'); if(eff) { const data = eff.toObject(); delete data._id; await game.xjzl.api.effects.addEffect(actor, data); ui.notifications.info('伏气功：气息流转，下次出招免耗回蓝。'); count = 0; } } await actor.setFlag('xjzl-system', 'neigong_fuqi_count', count);",
                            "active": true
                        },
                        {
                            "label": "伏气护体",
                            "trigger": "preTake",
                            "script": "if (S.resources.hp.value < (S.resources.hp.max * 0.3) && args.type.match(/waigong|neigong/) && S.resources.mp.value > 0 && args.output.damage > 1) { const original = args.output.damage; const absorb = Math.floor((original - 1) / 3); const cost = absorb; if (S.resources.mp.value >= cost) { await actor.update({'system.resources.mp.value': S.resources.mp.value - cost}); args.output.damage -= (cost * 3); ui.notifications.info(`伏气护体：消耗 ${cost} 内力抵消 ${cost * 3} 伤害`); } }",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "",
            "masteryChanges": [
                {
                    "key": "system.resources.mp.max",
                    "value": 40
                },
                {
                    "key": "system.combat.def_waigong",
                    "value": 5
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "伏气充盈(小成)",
                "icon": "systems/xjzl-system/assets/icons/neigong/万兽.png",
                "transfer": false,
                "description": "下次出招不消耗内力，并恢复10点内力。",
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_fuqi_buff",
                        "stackable": false
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.costs.neili.mod",
                        "mode": 2,
                        "value": "999"
                    }
                ],
                "scripts": [
                    {
                        "label": "伏气回蓝",
                        "trigger": "attack",
                        "script": "await attacker.applyHealing({amount: 10, type: 'mp'}); await thisEffect.delete();",
                        "active": true
                    }
                ]
            },
            {
                "name": "伏气充盈(圆满)",
                "icon": "systems/xjzl-system/assets/icons/neigong/万兽.png",
                "transfer": false,
                "description": "下次出招不消耗内力，并恢复20点内力。",
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_fuqi_buff",
                        "stackable": false
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.costs.neili.mod",
                        "mode": 2,
                        "value": "999"
                    }
                ],
                "scripts": [
                    {
                        "label": "伏气回蓝",
                        "trigger": "attack",
                        "script": "await attacker.applyHealing({amount: 20, type: 'mp'}); await thisEffect.delete();",
                        "active": true
                    }
                ]
            }
        ]
    },
    {
        "name": "《伏龙诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/万兽.png",
        "system": {
            "tier": 3,
            "element": "yang",
            "sect": "wanshoushanzhuang",
            "description": "传上古有恶龙，兴风作浪，造生灵涂炭。上苍震怒，派仙人一怒斩龙，龙首坠于渤海。为防止再生事端，仙人传下口诀，名伏龙。万兽山庄以此研习出顶级法门，练至大成，气盖八方，威震寰宇，可赦天下万兽，不在话下。",
            "requirement": "悟性需求: 11",
            "automationNote": "受重伤回血已自动化(没有限制一回合一次)。圆满光环需手动处理（可手动应用内置的‘伏龙威压’特效）。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 32,
                        "shenfa": 24,
                        "tipo": 22,
                        "neixi": 12,
                        "qigan": 12,
                        "shencai": 18
                    },
                    "description": "领悟运功特效：当你受到一次超过200点的伤害时（计算防御格挡之前），你在攻击者的回合末回复10点气血。(一回合一次)",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "伏龙回生",
                            "trigger": "preDefense",
                            "script": "if (args.baseDamage > 200) { await actor.applyHealing({amount: 10, type: 'hp', showScrolling: true}); ui.notifications.info('伏龙诀触发：重伤回血'); }",
                            "active": true
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 64,
                        "shenfa": 48,
                        "tipo": 44,
                        "neixi": 24,
                        "qigan": 24,
                        "shencai": 36
                    },
                    "description": "小成运功特效：当你受到一次超过150点的伤害时（计算防御格挡之前），你在攻击者的回合末回复10点气血。(一回合一次)",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "伏龙回生",
                            "trigger": "preDefense",
                            "script": "if (args.baseDamage > 150) { await actor.applyHealing({amount: 10, type: 'hp', showScrolling: true}); ui.notifications.info('伏龙诀触发：重伤回血'); }",
                            "active": true
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 96,
                        "shenfa": 72,
                        "tipo": 66,
                        "neixi": 36,
                        "qigan": 36,
                        "shencai": 54
                    },
                    "description": "圆满运功特效：当你受到一次超过100点的伤害时（计算防御格挡之前），你在攻击者的回合末回复20点气血。(一回合一次)<br>·进入战斗后，内力气化震慑群雄，若你未濒死，周围20米内所有敌人的虚招对抗检定结果-2。<br>修满特效：修满[永久]：气血+80，内力+40，体魄+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "伏龙回生",
                            "trigger": "preDefense",
                            "script": "if (args.baseDamage > 100) { await actor.applyHealing({amount: 20, type: 'hp', showScrolling: true}); ui.notifications.info('伏龙诀触发：重伤回血'); }",
                            "active": true
                        }
                    ]
                }
            },
            "masteryEffect": "",
            "masteryChanges": [
                {
                    "key": "system.resources.hp.max",
                    "value": 80
                },
                {
                    "key": "system.resources.mp.max",
                    "value": 40
                },
                {
                    "key": "system.stats.tipo.mod",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "伏龙威压",
                "icon": "icons/svg/fear.svg",
                "transfer": false,
                "description": "虚招对抗检定-2。",
                "duration": {
                    "rounds": 1
                },
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_fulong_debuff",
                        "stackable": false
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.kanpo",
                        "mode": 2,
                        "value": "-2"
                    }
                ]
            }
        ]
    }
]