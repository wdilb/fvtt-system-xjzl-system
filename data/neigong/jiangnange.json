[
    {
        "name": "《慧心功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/江南阁.png",
        "system": {
            "tier": 1,
            "element": "yin",
            "sect": "jiangnange",
            "description": "江南阁入门内功，静慧开念，定乾坤宇内，方能达于其道，练至大成后可开拓思维，使人耳目清明，不受纷扰。",
            "requirement": "悟性需求：1",
            "automationNote": "完全自动化。永久增加的技艺等级无法自动选择，请玩家手动修改人物卡。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 4,
                        "shenfa": 2,
                        "tipo": 4,
                        "neixi": 4,
                        "qigan": 2,
                        "shencai": 2
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 8,
                        "shenfa": 3,
                        "tipo": 8,
                        "neixi": 10,
                        "qigan": 3,
                        "shencai": 4
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage3": {
                    "stats": {
                        "liliang": 11,
                        "shenfa": 5,
                        "tipo": 11,
                        "neixi": 15,
                        "qigan": 5,
                        "shencai": 7
                    },
                    "description": "圆满运功特效：每次出招时恢复1点内力。\n\n修满特效：气血+10，内力+10，选择[书写][作画][演奏][棋术]其中一个技艺等级+1。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "慧心功-回内",
                            "trigger": "passive",
                            "active": true,
                            "script": "this.xjzlStatuses.regenMpAttack += 1;"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+10，内力+10，选择[书写][作画][演奏][棋术]其中一个技艺等级+1。",
            "masteryChanges": [
                {
                    "key": "resources.hp.max",
                    "value": 10
                },
                {
                    "key": "resources.mp.max",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《四艺诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/江南阁.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "jiangnange",
            "description": "四艺者，琴棋书画也，此为文人推崇掌握之道，也是江南阁核心功法。练至大成后，琴棋书画皆通，才气过人。",
            "requirement": "悟性需求：4",
            "automationNote": "命中加成完全自动化。招式距离增加仅为文本提示，需玩家在战斗地图上自行判断距离。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 12,
                        "shenfa": 4,
                        "tipo": 8,
                        "neixi": 10,
                        "qigan": 6,
                        "shencai": 8
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 24,
                        "shenfa": 8,
                        "tipo": 16,
                        "neixi": 20,
                        "qigan": 12,
                        "shencai": 16
                    },
                    "description": "小成运功特效：你施展笔/乐器/棋类的招式时，招式距离+1，命中+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "四艺诀-小成",
                            "trigger": "attack",
                            "active": true,
                            "script": "// 判定武器类型：乐器(instrument)、暗器/棋子(hidden)、奇门/笔(special)\nconst wType = args.move.weaponType;\nconst validTypes = [\"instrument\", \"hidden\", \"special\"];\n\nif (validTypes.includes(wType)) {\n    args.flags.bonusHit += 5;\n    // 距离增加无法自动修改，需玩家手动执行\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 36,
                        "shenfa": 12,
                        "tipo": 24,
                        "neixi": 30,
                        "qigan": 18,
                        "shencai": 24
                    },
                    "description": "圆满运功特效：你施展笔/乐器/棋类的招式时，招式距离+3，命中+10。\n\n修满特效：气血+40，内力+20。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "四艺诀-圆满",
                            "trigger": "attack",
                            "active": true,
                            "script": "// 判定武器类型：乐器(instrument)、暗器/棋子(hidden)、奇门/笔(special)\nconst wType = args.move.weaponType;\nconst validTypes = [\"instrument\", \"hidden\", \"special\"];\n\nif (validTypes.includes(wType)) {\n    args.flags.bonusHit += 10;\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+40，内力+20。",
            "masteryChanges": [
                {
                    "key": "resources.hp.max",
                    "value": 40
                },
                {
                    "key": "resources.mp.max",
                    "value": 20
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《风雅颂》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/江南阁.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "jiangnange",
            "description": "\"夫唯大雅，卓尔不群，君子风流，芳泽万古。\n君子炼心功法，清心问幽，养气寻雅，避凡尘杂事，觅人生之趣。练至大成宠辱不惊，去留无意。\"",
            "requirement": "悟性需求：4",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 10,
                        "shenfa": 4,
                        "tipo": 12,
                        "neixi": 9,
                        "qigan": 6,
                        "shencai": 7
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 20,
                        "shenfa": 8,
                        "tipo": 24,
                        "neixi": 18,
                        "qigan": 12,
                        "shencai": 14
                    },
                    "description": "小成运功特效：进战后，你获得【[书写][作画][演奏][棋术]等级之和】*3的护体真气，持续到战斗脱离。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "风雅颂-护体",
                            "trigger": "combatStart",
                            "active": true,
                            "script": "const artKeys = [\"shuxie\", \"zuohua\", \"yanzou\", \"qishu\"];\nlet totalLevels = 0;\nartKeys.forEach(k => {\n    totalLevels += (actor.system.arts[k]?.total || 0);\n});\nconst shield = totalLevels * 3;\n\nif (shield > 0) {\n    await actor.applyHealing({ amount: shield, type: \"huti\" });\n    ui.notifications.info(`${actor.name} 运起风雅颂，获得 ${shield} 点护体真气。`);\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 30,
                        "shenfa": 12,
                        "tipo": 36,
                        "neixi": 27,
                        "qigan": 18,
                        "shencai": 21
                    },
                    "description": "圆满运功特效：进战后，你获得【[书写][作画][演奏][棋术]等级之和】*6的护体真气，持续到战斗脱离。\n\n修满特效：气血+40，内力+20。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "风雅颂-护体",
                            "trigger": "combatStart",
                            "active": true,
                            "script": "const artKeys = [\"shuxie\", \"zuohua\", \"yanzou\", \"qishu\"];\nlet totalLevels = 0;\nartKeys.forEach(k => {\n    totalLevels += (actor.system.arts[k]?.total || 0);\n});\nconst shield = totalLevels * 6;\n\nif (shield > 0) {\n    await actor.applyHealing({ amount: shield, type: \"huti\" });\n    ui.notifications.info(`${actor.name} 运起风雅颂，获得 ${shield} 点护体真气。`);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+40，内力+20。",
            "masteryChanges": [
                {
                    "key": "resources.hp.max",
                    "value": 40
                },
                {
                    "key": "resources.mp.max",
                    "value": 20
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《灵玉功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/江南阁.png",
        "system": {
            "tier": 2,
            "element": "yin",
            "sect": "jiangnange",
            "description": "江南阁核心内功。修百样玲珑力道，散置于人体百骸，内劲阴柔长绵，不断沉淀于丹田，一旦迸发可伤敌于无形之中。",
            "requirement": "悟性需求：4",
            "automationNote": "完全自动化。属性加成通过被动实现，击倒效果通过命中检测自动发起请求。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 5,
                        "shenfa": 4,
                        "tipo": 12,
                        "neixi": 14,
                        "qigan": 6,
                        "shencai": 7
                    },
                    "description": "",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 10,
                        "shenfa": 11,
                        "tipo": 24,
                        "neixi": 28,
                        "qigan": 12,
                        "shencai": 11
                    },
                    "description": "小成运功特效：速度+1，招式伤害+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "灵玉功-属性",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.combat.speed += 1;\nS.combat.damages.skill.mod += 5;"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 13,
                        "shenfa": 12,
                        "tipo": 36,
                        "neixi": 46,
                        "qigan": 19,
                        "shencai": 18
                    },
                    "description": "圆满运功特效：速度+2，招式伤害+10。\n你每次出招命中无架招目标后，对方需要进行一个[角力]检定难度14，成功无事，失败则被击倒。\n\n修满特效：气血+40，内力+20。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "灵玉功-属性",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.combat.speed += 2;\nS.combat.damages.skill.mod += 10;"
                        },
                        {
                            "label": "灵玉功-击倒",
                            "trigger": "hit",
                            "active": true,
                            "script": "// 检查：是攻击、命中、且目标未开架招\nif (args.type === 'attack' && args.isHit && !args.target.system.martial?.stanceActive) {\n    // 获取系统预设的“倒地”状态数据\n    const proneEffect = CONFIG.statusEffects.find(e => e.id === \"prone\");\n    \n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"jiaoli\",\n        dc: 14,\n        label: \"角力 (灵玉功)\",\n        onFail: proneEffect\n    });\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+40，内力+20。",
            "masteryChanges": [
                {
                    "key": "resources.hp.max",
                    "value": 40
                },
                {
                    "key": "resources.mp.max",
                    "value": 20
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": []
    },
    {
        "name": "《念情诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/江南阁.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "jiangnange",
            "description": "气因“情”而发，由“形”而变，此功修心，琢磨情感，使形气如一，不可撼动。练至大成时，情不乱于心，身不执于念。",
            "requirement": "悟性需求：10",
            "automationNote": "完全自动化。圆满特效中的击飞位移（强制移动Token）需玩家手动操作，状态会自动应用。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 20,
                        "shenfa": 19,
                        "tipo": 18,
                        "neixi": 35,
                        "qigan": 10,
                        "shencai": 18
                    },
                    "description": "领悟运功特效：招式伤害+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "念情诀-增伤",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.combat.damages.skill.mod += 5;"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 39,
                        "shenfa": 38,
                        "tipo": 35,
                        "neixi": 71,
                        "qigan": 27,
                        "shencai": 30
                    },
                    "description": "小成运功特效：招式伤害+10。\n进入战斗后，每回合初获得一层“念情”，至多三层，持续到战斗脱离。\n念情：命中目标时移除一层念情，将目标击倒。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "念情诀-增伤",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.combat.damages.skill.mod += 10;"
                        },
                        {
                            "label": "念情诀-获得念情",
                            "trigger": "combatStart",
                            "active": true,
                            "script": "const nianqingSource = thisItem.effects.getName(\"念情\");\nif (nianqingSource) {\n    await game.xjzl.api.effects.addEffect(actor, nianqingSource);\n    ChatMessage.create({content: `${actor.name} 运转念情诀，情意暗生。`, speaker: ChatMessage.getSpeaker({actor: actor})});\n}"
                        },
                        {
                            "label": "念情诀-回合回复",
                            "trigger": "turnStart",
                            "active": true,
                            "script": "// 只要内功运功，每回合初自动补充/叠加一层\nconst nianqingSource = thisItem.effects.getName(\"念情\");\nif (nianqingSource) {\n    await game.xjzl.api.effects.addEffect(actor, nianqingSource);\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 62,
                        "shenfa": 60,
                        "tipo": 52,
                        "neixi": 100,
                        "qigan": 42,
                        "shencai": 44
                    },
                    "description": "圆满运功特效：招式伤害+15。\n进入战斗后，每回合初获得一层“念情”，至多三层，持续到战斗脱离。\n念情：命中目标时移除一层念情，将目标击飞1米后倒地。\n\n修满特效：气血+60，内力+60，内息+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "念情诀-增伤",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.combat.damages.skill.mod += 15;"
                        },
                        {
                            "label": "念情诀-获得念情",
                            "trigger": "combatStart",
                            "active": true,
                            "script": "const nianqingSource = thisItem.effects.getName(\"念情\");\nif (nianqingSource) {\n    await game.xjzl.api.effects.addEffect(actor, nianqingSource);\n    ChatMessage.create({content: `${actor.name} 运转念情诀，情意暗生。`, speaker: ChatMessage.getSpeaker({actor: actor})});\n}"
                        },
                        {
                            "label": "念情诀-回合回复",
                            "trigger": "turnStart",
                            "active": true,
                            "script": "// 只要内功运功，每回合初自动补充/叠加一层\nconst nianqingSource = thisItem.effects.getName(\"念情\");\nif (nianqingSource) {\n    await game.xjzl.api.effects.addEffect(actor, nianqingSource);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+60，内力+60，内息+10。",
            "masteryChanges": [
                {
                    "key": "resources.hp.max",
                    "value": 60
                },
                {
                    "key": "resources.mp.max",
                    "value": 60
                },
                {
                    "key": "stats.neixi.value",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "念情",
                "icon": "icons/svg/aura.svg",
                "description": "念情诀特殊状态。每回合增加一层（上限3层）。命中敌人时消耗一层，触发击倒/击飞效果。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "nianqing",
                        "stackable": true,
                        "maxStacks": 3,
                        "scripts": [
                            {
                                "label": "念情-命中爆发",
                                "trigger": "hit",
                                "active": true,
                                "script": "if (args.type === 'attack' && args.isHit) {\n    // 1. 消耗一层\n    await game.xjzl.api.effects.removeEffect(actor, \"nianqing\", 1);\n    \n    // 2. 施加倒地\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    \n    // 3. 判断境界并发送卡片\n    const ng = actor.items.getName(\"《念情诀》\");\n    const isStage3 = ng && ng.system.stage === 3;\n    const effectText = isStage3 ? \"击退1米并击倒\" : \"击倒\";\n    \n    ChatMessage.create({\n        speaker: ChatMessage.getSpeaker({ actor: actor }),\n        content: `<div class=\"xjzl-chat-card\"><div class=\"card-header\" style=\"border-bottom:1px solid #ccc; margin-bottom:5px;\"><h3>念情爆发</h3></div><div class=\"card-content\">${actor.name} 消耗一层念情，将 <b>${args.target.name}</b> ${effectText}。</div></div>`\n    });\n}"
                            }
                        ]
                    }
                },
                "changes": []
            }
        ]
    }
]