[
    {
        "name": "《两仪心法》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 1,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "真武教入门内功，“易有太极，始生两仪”，此功集阴阳于一身，冶刚柔于一炉，二合如一。",
            "requirement": "悟性 1",
            "automationNote": "部分自动化。进战自动获得护体；护体归零时的Debuff请玩家手动给周围敌人添加。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 5,
                        "shenfa": 1,
                        "tipo": 4,
                        "neixi": 5,
                        "qigan": 1,
                        "shencai": 2
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 10,
                        "shenfa": 3,
                        "tipo": 7,
                        "neixi": 9,
                        "qigan": 3,
                        "shencai": 4
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage3": {
                    "stats": {
                        "liliang": 14,
                        "shenfa": 5,
                        "tipo": 10,
                        "neixi": 14,
                        "qigan": 5,
                        "shencai": 6
                    },
                    "description": "圆满运功特效：进入战斗时，获得20点护体真气，持续到战斗脱离。该护体真气归零时，为周围3米范围内的敌方添加“下盘不稳”，持续三回合。\n修满特效：气血+10，内力+10，[道法]+1",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "两仪护体",
                            "trigger": "combatStart",
                            "active": true,
                            "script": "await actor.applyHealing({ amount: 20, type: 'huti' });\nui.notifications.info(`${actor.name} 运转两仪心法，获得护体真气。`);"
                        },
                        {
                            "label": "护体破碎提示",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.hutiLost > 0 && S.resources.huti === 0) {\n    ui.notifications.warn(`${actor.name} 的两仪护体被击破！请手动为周围3米内的敌人添加“下盘不稳”。`);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "气血+10，内力+10，[道法]+1",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 10
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 10
                },
                {
                    "key": "arts.daofa.value",
                    "value": 1
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《一字混元桩功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "真武教核心内功，以桩式站定吐纳，练就胎息之感。大成后丹田内劲绵长，意气合一。",
            "requirement": "悟性 4",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 8,
                        "shenfa": 4,
                        "tipo": 10,
                        "neixi": 14,
                        "qigan": 8,
                        "shencai": 4
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 16,
                        "shenfa": 8,
                        "tipo": 20,
                        "neixi": 28,
                        "qigan": 16,
                        "shencai": 8
                    },
                    "description": "小成运功特效：每个回合末，若自身不处于濒死状态，获得10点护体真气，持续到战斗脱离。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元桩回气",
                            "trigger": "turnEnd",
                            "active": true,
                            "script": "if (!actor.hasEffect(\"dying\")) {\n    await actor.applyHealing({ amount: 10, type: 'huti' });\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 24,
                        "shenfa": 12,
                        "tipo": 30,
                        "neixi": 42,
                        "qigan": 24,
                        "shencai": 12
                    },
                    "description": "圆满运功特效：每个回合末，若自身不处于濒死状态，获得10点护体真气，持续到战斗脱离。\n自身具有护体真气时，格挡值提高10点。\n修满特效：气血+40，内力+20。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元桩回气",
                            "trigger": "turnEnd",
                            "active": true,
                            "script": "if (!actor.hasEffect(\"dying\")) {\n    await actor.applyHealing({ amount: 10, type: 'huti' });\n}"
                        },
                        {
                            "label": "护体强化格挡",
                            "trigger": "passive",
                            "active": true,
                            "script": "if (S.resources.huti > 0) {\n    S.combat.block += 10;\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "气血+40，内力+20。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 40
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 20
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《真武三阳功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 1,
            "element": "yang",
            "sect": "zhenwujiao",
            "description": "武当山先祖自一至阳绝阳神功残篇当中领悟而得的一门神功，得神功之纯。",
            "requirement": "悟性 1",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 2,
                        "shenfa": 1,
                        "tipo": 4,
                        "neixi": 6,
                        "qigan": 3,
                        "shencai": 2
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 4,
                        "shenfa": 2,
                        "tipo": 8,
                        "neixi": 12,
                        "qigan": 6,
                        "shencai": 4
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage3": {
                    "stats": {
                        "liliang": 6,
                        "shenfa": 3,
                        "tipo": 12,
                        "neixi": 18,
                        "qigan": 9,
                        "shencai": 6
                    },
                    "description": "圆满运功特效：你受到伤害时减少5点，同时反弹攻击者，使他流失5点气血。\n修满特效：修满[永久]：气血+15，内力+15。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "三阳护体减伤",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.output.damage > 0) {\n    args.output.damage = Math.max(0, args.output.damage - 5);\n}"
                        },
                        {
                            "label": "三阳反震",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.attacker) {\n    // 标记为反伤来源，防止死循环 (虽然applyDamage internal handling should cover it, but strict adherence)\n    args.attacker.runtimeFlags = args.attacker.runtimeFlags || {};\n    if (args.attacker.runtimeFlags.isReflecting) return;\n\n    actor.runtimeFlags = actor.runtimeFlags || {};\n    actor.runtimeFlags.isReflecting = true;\n    try {\n        await args.attacker.applyDamage({\n            amount: 5,\n            type: 'liushi',\n            isHit: true\n        });\n        ui.notifications.info(`${actor.name} 真武三阳功反震！`);\n    } finally {\n        actor.runtimeFlags.isReflecting = false;\n    }\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+15，内力+15。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 15
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 15
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《纯阳功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 2,
            "element": "yang",
            "sect": "zhenwujiao",
            "description": "道家功法之精华，吸气腾飞，呼气沉海，气形合二为一，内外双修，外炼拍打体躯，内练五脏六腑，凝成阳烈真气，却邪扶正。",
            "requirement": "悟性 4",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 9,
                        "shenfa": 2,
                        "tipo": 8,
                        "neixi": 18,
                        "qigan": 7,
                        "shencai": 4
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 18,
                        "shenfa": 4,
                        "tipo": 16,
                        "neixi": 36,
                        "qigan": 14,
                        "shencai": 8
                    },
                    "description": "小成运功特效：对目标造成伤害后给目标添加“震伤”，持续两回合。\n震伤：每次被攻击都会流失10点气血。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "施加震伤",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.type === 'attack' && args.isHit) {\n    const effectData = thisItem.effects.getName(\"震伤\").toObject();\n    // 移除内伤转化脚本 (小成没有转化逻辑)\n    effectData.flags[\"xjzl-system\"].scripts = effectData.flags[\"xjzl-system\"].scripts.filter(s => s.label !== \"内伤计数\");\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 27,
                        "shenfa": 10,
                        "tipo": 24,
                        "neixi": 50,
                        "qigan": 21,
                        "shencai": 12
                    },
                    "description": "圆满运功特效：对目标造成伤害后给目标添加“震伤”，持续两回合。\n震伤：每次被攻击都会流失10点气血，若在此期间出招三次后，还会被添加“内伤”两回合。\n内伤：陷入“禁实”“禁虚”“禁足”。\n修满特效：气血+30，内力+30，体魄+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "施加高级震伤",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.type === 'attack' && args.isHit) {\n    const effectData = thisItem.effects.getName(\"震伤\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "气血+30，内力+30，体魄+5。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 30
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 30
                },
                {
                    "key": "stats.tipo.mod",
                    "value": 5
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "震伤",
                "icon": "icons/svg/ruins.svg",
                "duration": {
                    "rounds": 2
                },
                "description": "每次被攻击流失10血。圆满阶段出招3次后转为内伤。",
                "flags": {
                    "xjzl-system": {
                        "slug": "zhenshang",
                        "stackable": false,
                        "neigong_chunyang_count": 0,
                        "scripts": [
                            {
                                "label": "震伤流血",
                                "trigger": "damaged",
                                "script": "await actor.applyDamage({ amount: 10, type: 'liushi', isHit: true });"
                            },
                            {
                                "label": "内伤计数",
                                "trigger": "attack",
                                "script": "let count = thisEffect.getFlag('xjzl-system', 'neigong_chunyang_count') || 0;\ncount++;\nawait thisEffect.setFlag('xjzl-system', 'neigong_chunyang_count', count);\n\nif (count >= 3) {\n    ui.notifications.warn(`${actor.name} 震伤发作，转为内伤！`);\n    // 查找并应用内伤特效 (需要先找到源物品)\n    const sourceItem = await fromUuid(thisEffect.origin);\n    if (sourceItem) {\n        const neishangData = sourceItem.effects.getName(\"内伤\").toObject();\n        neishangData.origin = thisEffect.origin;\n        await game.xjzl.api.effects.addEffect(actor, neishangData);\n    }\n    await thisEffect.delete();\n}"
                            }
                        ]
                    }
                }
            },
            {
                "name": "内伤",
                "icon": "icons/svg/skull.svg",
                "duration": {
                    "rounds": 2
                },
                "description": "陷入“禁实”“禁虚”“禁足”。",
                "changes": [
                    {
                        "key": "flags.xjzl-system.blockShiZhao",
                        "mode": 5,
                        "value": "true"
                    },
                    {
                        "key": "flags.xjzl-system.blockXuZhao",
                        "mode": 5,
                        "value": "true"
                    },
                    {
                        "key": "flags.xjzl-system.forceSpeedZero",
                        "mode": 5,
                        "value": "true"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "neishang_chunyang"
                    }
                }
            }
        ]
    },
    {
        "name": "《太极神功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "道家内功心法之极高点，所谓：“易有太极，始生两仪，两仪生四象，四象生八卦，八卦推衍万物。”此内功讲究熟练运用“太极阴阳二气”转化相生之理，练至大成，力御万物，处于不败之地！",
            "requirement": "悟性 11",
            "automationNote": "部分自动化。受击自动获得化劲；化劲的消耗和增伤需玩家在出招配置弹窗中手动调整。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 18,
                        "shenfa": 10,
                        "tipo": 21,
                        "neixi": 42,
                        "qigan": 19,
                        "shencai": 10
                    },
                    "description": "领悟运功特效：被攻击时减少5点内外功伤害。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "太极减伤",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'waigong' || args.type === 'neigong') {\n    args.output.damage = Math.max(0, args.output.damage - 5);\n}"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 46,
                        "shenfa": 18,
                        "tipo": 41,
                        "neixi": 82,
                        "qigan": 35,
                        "shencai": 18
                    },
                    "description": "小成运功特效：被攻击时减少10点内外功伤害，获得一层“化劲”，持续到脱战，至多叠加十层。\n化劲：出招时每消耗一层化劲招式伤害+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "太极减伤",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'waigong' || args.type === 'neigong') {\n    args.output.damage = Math.max(0, args.output.damage - 10);\n}"
                        },
                        {
                            "label": "获得化劲",
                            "trigger": "preTake",
                            "active": true,
                            "script": "const effectData = thisItem.effects.getName(\"化劲\").toObject();\neffectData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effectData);"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 70,
                        "shenfa": 27,
                        "tipo": 60,
                        "neixi": 122,
                        "qigan": 55,
                        "shencai": 26
                    },
                    "description": "圆满运功特效：被攻击时减少10点内外功伤害，获得两层“化劲”，持续到脱战，至多叠加十层。\n化劲：出招时每消耗一层化劲招式伤害+10。\n修满特效：气血+80，内力+40，内息+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "太极减伤",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'waigong' || args.type === 'neigong') {\n    args.output.damage = Math.max(0, args.output.damage - 10);\n}"
                        },
                        {
                            "label": "获得化劲(2层)",
                            "trigger": "preTake",
                            "active": true,
                            "script": "const effectData = thisItem.effects.getName(\"化劲\").toObject();\neffectData.origin = thisItem.uuid;\n// 添加两次\nawait game.xjzl.api.effects.addEffect(actor, effectData);\nawait game.xjzl.api.effects.addEffect(actor, effectData);"
                        }
                    ]
                }
            },
            "masteryEffect": "气血+80，内力+40，内息+10。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 80
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 40
                },
                {
                    "key": "stats.neixi.mod",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "化劲",
                "icon": "icons/svg/aura.svg",
                "description": "每层化劲可手动消耗以增加10点招式伤害。",
                "flags": {
                    "xjzl-system": {
                        "stackable": true,
                        "maxStacks": 10,
                        "slug": "huajin"
                    }
                }
            }
        ]
    },
    {
        "name": "《先天诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "传说中道家独门不传之秘，武学之源。以“道生一，一生二，二生三，三生万物”的理念激发潜能，凝聚先天真气，祛百病、调虚实、治内伤，内劲周而复始生生不息，步入深不可测之化境。",
            "requirement": "悟性 25",
            "automationNote": "部分自动化。免疫自动；概率双倍治疗需玩家自行投骰判定，圆满阶段双倍治疗自动。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 28,
                        "shenfa": 14,
                        "tipo": 15,
                        "neixi": 24,
                        "qigan": 26,
                        "shencai": 13
                    },
                    "description": "领悟运功特效：你免疫毒素伤害。\n当你出招回复气血时，投掷一个D20，如果小于等于10，可回复双倍气血。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "免疫毒素",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'poison') {\n    args.output.abort = true;\n    ui.notifications.info(`${actor.name} 先天真气护体，百毒不侵！`);\n}"
                        },
                        {
                            "label": "概率治疗提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHeal && args.finalAmount > 0) {\n    ui.notifications.info(\"先天诀：请投D20，若<=10，请手动额外回复等量气血。\");\n}"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 56,
                        "shenfa": 28,
                        "tipo": 30,
                        "neixi": 48,
                        "qigan": 52,
                        "shencai": 26
                    },
                    "description": "小成运功特效：你免疫毒素伤害和效果。\n当你出招回复气血时，投掷一个D20，如果小于等于15，可回复双倍气血。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "免疫毒素",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'poison') {\n    args.output.abort = true;\n    ui.notifications.info(`${actor.name} 先天真气护体，百毒不侵！`);\n}"
                        },
                        {
                            "label": "概率治疗提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHeal && args.finalAmount > 0) {\n    ui.notifications.info(\"先天诀：请投D20，若<=15，请手动额外回复等量气血。\");\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 84,
                        "shenfa": 42,
                        "tipo": 45,
                        "neixi": 72,
                        "qigan": 78,
                        "shencai": 39
                    },
                    "description": "圆满运功特效：你免疫毒素伤害和效果。\n当你出招回复气血时，回复双倍气血。\n修满特效：修满[永久]：气血+100，内力+80。\n你以任意形式获得的修为提高三成。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "免疫毒素",
                            "trigger": "preTake",
                            "active": true,
                            "script": "if (args.type === 'poison') {\n    args.output.abort = true;\n    ui.notifications.info(`${actor.name} 先天真气护体，百毒不侵！`);\n}"
                        },
                        {
                            "label": "稳定双倍治疗",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHeal && args.finalAmount > 0) {\n    ui.notifications.info(\"先天诀生效，双倍治疗！\");\n    await args.target.applyHealing({ amount: args.finalAmount, type: 'hp' });\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+100，内力+80。\n你以任意形式获得的修为提高三成。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 100
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 80
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《九天真罡》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 2,
            "element": "yin",
            "sect": "zhenwujiao",
            "description": "道家核心内功，由默庵真人所创，扬混元道化之妙，亦为当世武林绝学之一。修炼之人内力精纯厚重，且遇敌能浑身生出一股柔而无匹的罡气，既纯且柔，攻守兼备。",
            "requirement": "悟性 4",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 14,
                        "shenfa": 2,
                        "tipo": 8,
                        "neixi": 14,
                        "qigan": 7,
                        "shencai": 3
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 28,
                        "shenfa": 5,
                        "tipo": 18,
                        "neixi": 28,
                        "qigan": 10,
                        "shencai": 7
                    },
                    "description": "小成运功特效：出招后获得10点护体真气，持续到战斗脱离。\n·每当护体真气受到攻击归零后，给攻击者造成10点气血流失。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "九天护体",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "if (args.type === 'attack') {\n    await actor.applyHealing({ amount: 10, type: 'huti' });\n}"
                        },
                        {
                            "label": "罡气破裂反伤",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.hutiLost > 0 && S.resources.huti === 0 && args.attacker) {\n    ui.notifications.warn(`${actor.name} 的九天罡气破裂！`);\n    await args.attacker.applyDamage({ amount: 10, type: 'liushi', isHit: true });\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 38,
                        "shenfa": 9,
                        "tipo": 32,
                        "neixi": 38,
                        "qigan": 13,
                        "shencai": 14
                    },
                    "description": "圆满运功特效：出招后获得10点护体真气，持续到战斗脱离。\n·每当护体真气受到攻击归零后，给攻击者造成20点气血流失。\n修满特效：气血+30，内力+30，气感+5。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "九天护体",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "if (args.type === 'attack') {\n    await actor.applyHealing({ amount: 10, type: 'huti' });\n}"
                        },
                        {
                            "label": "罡气破裂反伤",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.hutiLost > 0 && S.resources.huti === 0 && args.attacker) {\n    ui.notifications.warn(`${actor.name} 的九天罡气破裂！`);\n    await args.attacker.applyDamage({ amount: 20, type: 'liushi', isHit: true });\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "气血+30，内力+30，气感+5。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 30
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 30
                },
                {
                    "key": "stats.qigan.mod",
                    "value": 5
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《正一心诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "正一道顶级功法，阐述“正以治邪，一以统万”，以道家玄学思想包罗万象，为张天师所创。此功法注重内炼，需静存元神，采日、月、星三光之气纳入己身，炼至大成时天地感召，长生不老。",
            "requirement": "悟性 11",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 35,
                        "shenfa": 10,
                        "tipo": 20,
                        "neixi": 25,
                        "qigan": 20,
                        "shencai": 10
                    },
                    "description": "领悟运功特效：每次消耗内力时回复5点气血。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "耗内回血",
                            "trigger": "attack",
                            "active": true,
                            "script": "// 估算消耗：招式消耗 - 减耗\nconst cost = Math.max(0, (args.move.currentCost?.mp || 0) - (S.combat.costs.neili.total || 0));\nif (cost > 0) {\n    await actor.applyHealing({ amount: 5, type: 'hp' });\n}"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 70,
                        "shenfa": 20,
                        "tipo": 40,
                        "neixi": 50,
                        "qigan": 40,
                        "shencai": 20
                    },
                    "description": "小成运功特效：每次消耗内力时回复10点气血。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "耗内回血",
                            "trigger": "attack",
                            "active": true,
                            "script": "const cost = Math.max(0, (args.move.currentCost?.mp || 0) - (S.combat.costs.neili.total || 0));\nif (cost > 0) {\n    await actor.applyHealing({ amount: 10, type: 'hp' });\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 105,
                        "shenfa": 30,
                        "tipo": 60,
                        "neixi": 75,
                        "qigan": 60,
                        "shencai": 30
                    },
                    "description": "圆满运功特效：每次消耗内力时回复20点气血。当气血低于上限一半时，你获得“正一”，持续到气血高于上限的一半。\n正一：你的格挡值和招式伤害提高10点；出招命中目标后，还会为其添加一回合“迟滞”。\n修满特效：修满[永久]：气血+80，内力+40，体魄+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "耗内回血",
                            "trigger": "attack",
                            "active": true,
                            "script": "const cost = Math.max(0, (args.move.currentCost?.mp || 0) - (S.combat.costs.neili.total || 0));\nif (cost > 0) {\n    await actor.applyHealing({ amount: 20, type: 'hp' });\n}"
                        },
                        {
                            "label": "正一加持(属性)",
                            "trigger": "passive",
                            "active": true,
                            "script": "if (S.resources.hp.value < (S.resources.hp.max / 2)) {\n    S.combat.block += 10;\n    S.combat.damages.skill.mod += 10;\n}"
                        },
                        {
                            "label": "正一加持(特效)",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (S.resources.hp.value < (S.resources.hp.max / 2) && args.type === 'attack' && args.isHit) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"chizhi\", true);\n    ui.notifications.info(`${actor.name} 正一显威，使目标迟滞！`);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+80，内力+40，体魄+10。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 80
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 40
                },
                {
                    "key": "stats.tipo.mod",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        }
    },
    {
        "name": "《混元一气功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 3,
            "element": "yang",
            "sect": "zhenwujiao",
            "description": "内外兼修，形、神、气、技合一的惊世功法。在人谓之元精、元气、元神三者合一。纯一不杂为精，融通血脉为气，虚灵活动为神，大成后可无形生形，无质生质，不惧衰老。",
            "requirement": "悟性 11",
            "automationNote": "部分自动化。格挡成功需手动添加“混元一气”BUFF。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 20,
                        "shenfa": 20,
                        "tipo": 20,
                        "neixi": 20,
                        "qigan": 20,
                        "shencai": 20
                    },
                    "description": "领悟运功特效：格挡成功后获得“混元一气”，持续到脱离战斗。混元一气：下次出招提升招式伤害10点。\n出招前也可纳气入体，移除“混元一气”，放弃伤害，使这次攻击的命中提高10点。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元一气/纳气入体",
                            "trigger": "attack",
                            "active": true,
                            "script": "const buff = actor.effects.getName(\"混元一气\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"纳气入体?\" },\n        content: \"是否消耗混元一气，放弃伤害以提高10点命中？\",\n        yes: { label: \"纳气\" },\n        no: { label: \"仅增伤\" }\n    });\n    \n    if (confirm) {\n        args.flags.bonusHit += 10;\n        args.flags.bonusDamage = -999;\n        ui.notifications.info(\"纳气入体：命中大增，伤害放弃。\");\n    } else {\n        ui.notifications.info(\"混元一气：伤害提升。\");\n    }\n    await buff.delete();\n}"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 40,
                        "shenfa": 40,
                        "tipo": 40,
                        "neixi": 40,
                        "qigan": 40,
                        "shencai": 40
                    },
                    "description": "小成运功特效：格挡成功后获得“混元一气”，持续到脱离战斗。混元一气：下次出招提升招式伤害20点。\n出招前也可纳气入体，移除“混元一气”，放弃伤害，使这次攻击的命中提高20点。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元一气/纳气入体",
                            "trigger": "attack",
                            "active": true,
                            "script": "const buff = actor.effects.getName(\"混元一气\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"纳气入体?\" },\n        content: \"是否消耗混元一气，放弃伤害以提高20点命中？\",\n        yes: { label: \"纳气\" },\n        no: { label: \"仅增伤\" }\n    });\n    if (confirm) {\n        args.flags.bonusHit += 20;\n        args.flags.bonusDamage = -999;\n        ui.notifications.info(\"纳气入体：命中大增，伤害放弃。\");\n    } else {\n        ui.notifications.info(\"混元一气：伤害提升。\");\n    }\n    await buff.delete();\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 60,
                        "shenfa": 60,
                        "tipo": 60,
                        "neixi": 60,
                        "qigan": 60,
                        "shencai": 60
                    },
                    "description": "圆满运功特效：格挡成功后获得“混元一气”，持续到脱离战斗。混元一气：下次出招提升招式伤害30点。\n出招前也可纳气入体，移除“混元一气”，放弃伤害，使这次攻击的命中提高30点。\n修满特效：修满[永久]：气血+60，内力+60，气感+10。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "混元一气/纳气入体",
                            "trigger": "attack",
                            "active": true,
                            "script": "const buff = actor.effects.getName(\"混元一气\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"纳气入体?\" },\n        content: \"是否消耗混元一气，放弃伤害以提高30点命中？\",\n        yes: { label: \"纳气\" },\n        no: { label: \"仅增伤\" }\n    });\n    if (confirm) {\n        args.flags.bonusHit += 30;\n        args.flags.bonusDamage = -999;\n        ui.notifications.info(\"纳气入体：命中大增，伤害放弃。\");\n    } else {\n        ui.notifications.info(\"混元一气：伤害提升。\");\n    }\n    await buff.delete();\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+60，内力+60，气感+10。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 60
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 60
                },
                {
                    "key": "stats.qigan.mod",
                    "value": 10
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "混元一气",
                "icon": "icons/svg/aura.svg",
                "description": "下次出招伤害提升。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": "10"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "stackable": false
                    }
                }
            }
        ]
    },
    {
        "name": "《三清真气》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/真武.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "zhenwujiao",
            "description": "道家心法，所谓一气化三清，“三清者，玉清、上清、太清也”，功法修成之后，阴阳调和，气血内劲充盈，更可化去敌方之力。",
            "requirement": "悟性 4",
            "automationNote": "完全自动化。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 8,
                        "shenfa": 8,
                        "tipo": 8,
                        "neixi": 8,
                        "qigan": 8,
                        "shencai": 8
                    },
                    "description": "无",
                    "xpCostRatio": 1,
                    "scripts": []
                },
                "stage2": {
                    "stats": {
                        "liliang": 16,
                        "shenfa": 16,
                        "tipo": 16,
                        "neixi": 16,
                        "qigan": 16,
                        "shencai": 16
                    },
                    "description": "小成运功特效：出招时获得“清气”，至多三层，持续到战斗脱离。\n清气：每层使自身回合末回复5点气血、内力。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "获得清气",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "if (args.type === 'attack') {\n    const effectData = thisItem.effects.getName(\"清气\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effectData);\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 24,
                        "shenfa": 24,
                        "tipo": 24,
                        "neixi": 24,
                        "qigan": 24,
                        "shencai": 24
                    },
                    "description": "圆满运功特效：出招时获得“清气”，至多三层，持续到战斗脱离。\n清气：每层使自身回合末回复5点气血、内力。\n被攻击后，为目标添加“化力”，持续三回合。\n化力：招式伤害降低10点，暴击骰+1。\n修满特效：修满[永久]：气血+40，内力+20。",
                    "xpCostRatio": 1,
                    "scripts": [
                        {
                            "label": "获得清气",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "if (args.type === 'attack') {\n    const effectData = thisItem.effects.getName(\"清气\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effectData);\n}"
                        },
                        {
                            "label": "施加化力",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.attacker) {\n    const effectData = thisItem.effects.getName(\"化力\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, effectData);\n    ui.notifications.info(`已给攻击者 ${args.attacker.name} 施加化力。`);\n}"
                        }
                    ]
                }
            },
            "masteryEffect": "修满[永久]：气血+40，内力+20。",
            "masteryChanges": [
                {
                    "key": "resources.hp.bonus",
                    "value": 40
                },
                {
                    "key": "resources.mp.bonus",
                    "value": 20
                }
            ],
            "xpInvested": 0,
            "active": false,
            "sourceBreakdown": {
                "general": 0,
                "specific": 0
            }
        },
        "effects": [
            {
                "name": "清气",
                "icon": "icons/svg/light.svg",
                "description": "每层使自身回合末回复5点气血、内力。",
                "flags": {
                    "xjzl-system": {
                        "stackable": true,
                        "maxStacks": 3,
                        "slug": "qingqi",
                        "scripts": [
                            {
                                "label": "清气回复",
                                "trigger": "turnEnd",
                                "script": "const stacks = thisEffect.getFlag('xjzl-system', 'stacks') || 1;\nawait actor.applyHealing({ amount: 5 * stacks, type: 'hp' });\nawait actor.applyHealing({ amount: 5 * stacks, type: 'mp' });"
                            }
                        ]
                    }
                }
            },
            {
                "name": "化力",
                "icon": "icons/svg/downgrade.svg",
                "duration": {
                    "rounds": 3
                },
                "description": "招式伤害降低10点，暴击骰+1。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": "-10"
                    },
                    {
                        "key": "system.combat.crit_waigong",
                        "mode": 2,
                        "value": "1"
                    },
                    {
                        "key": "system.combat.crit_neigong",
                        "mode": 2,
                        "value": "1"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "stackable": false,
                        "slug": "huali"
                    }
                }
            }
        ]
    }
]