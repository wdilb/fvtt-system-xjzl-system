[
    {
        "name": "《拜火功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 1,
            "element": "yang",
            "sect": "mingjiao",
            "description": "<p>明教入门内功心法，源于波斯拜火教，旨在控制心火，为之后修习更为高深的内功打下抵御心魔的基础，练至大成心火收发自如，伤敌于无形。</p>",
            "requirement": "悟性1",
            "automationNote": "完全自动化。招式伤害计算时会自动检测当前已损失气血。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 4,
                        "shenfa": 2,
                        "tipo": 4,
                        "neixi": 4,
                        "qigan": 2,
                        "shencai": 2
                    },
                    "description": ""
                },
                "stage2": {
                    "stats": {
                        "liliang": 9,
                        "shenfa": 4,
                        "tipo": 7,
                        "neixi": 9,
                        "qigan": 4,
                        "shencai": 3
                    },
                    "description": ""
                },
                "stage3": {
                    "stats": {
                        "liliang": 13,
                        "shenfa": 6,
                        "tipo": 11,
                        "neixi": 13,
                        "qigan": 6,
                        "shencai": 5
                    },
                    "description": "<p>圆满运功特效：你的气血每减少5点，招式伤害+1。（至多20点）</p><p>修满特效：修满[永久]：气血+10，内力+10，力量+2，内息+2。</p>",
                    "scripts": [
                        {
                            "label": "拜火功-血量换伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const hpMax = system.resources.hp.max;\nconst hpVal = system.resources.hp.value;\nconst lost = Math.max(0, hpMax - hpVal);\nconst bonus = Math.min(20, Math.floor(lost / 5));\nif (bonus > 0) {\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`拜火功 +${bonus}`);\n}"
                        }
                    ]
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 10
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 10
                },
                {
                    "key": "system.stats.liliang.value",
                    "value": 2
                },
                {
                    "key": "system.stats.neixi.value",
                    "value": 2
                }
            ]
        }
    },
    {
        "name": "《大光明心法》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 1,
            "element": "taiji",
            "sect": "mingjiao",
            "description": "<p>波斯明教内功心法，阐欲望困锁，人崇尚光明，应破除之。此功讲究如禅法般节制苦禁欲，日夜锤炼，苦修肉体，最终不受任何外界虚无引诱，身心纯净如光明。</p>",
            "requirement": "悟性1",
            "automationNote": "完全自动化。检测身上是否有任何ActiveEffect。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 3,
                        "shenfa": 3,
                        "tipo": 5,
                        "neixi": 3,
                        "qigan": 2,
                        "shencai": 2
                    }
                },
                "stage2": {
                    "stats": {
                        "liliang": 6,
                        "shenfa": 6,
                        "tipo": 10,
                        "neixi": 6,
                        "qigan": 4,
                        "shencai": 4
                    }
                },
                "stage3": {
                    "stats": {
                        "liliang": 9,
                        "shenfa": 9,
                        "tipo": 15,
                        "neixi": 9,
                        "qigan": 6,
                        "shencai": 6
                    },
                    "description": "<p>圆满运功特效：你具有任何状态时，格挡值+5。</p><p>修满特效：修满[永久]：气血+10，内力+10。</p>",
                    "scripts": [
                        {
                            "label": "大光明-状态加格挡",
                            "trigger": "passive",
                            "active": true,
                            "script": "// 检测身上是否有临时特效或状态\nconst hasStatus = actor.appliedEffects.some(e => e.isTemporary);\nif (hasStatus) {\n    system.combat.block += 5;\n}"
                        }
                    ]
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 10
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 10
                }
            ]
        }
    },
    {
        "name": "《五行心法》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 2,
            "element": "taiji",
            "sect": "mingjiao",
            "description": "<p>明教五行旗心法，天有五行，分时化育，以成万物，此心法循天地机理，可化万物灵气，纳之己用，慧藏气海，使运气如涓涓溪水，绵而不绝。</p>",
            "requirement": "悟性4",
            "automationNote": "半自动化。对敌人施加“五行”减伤Debuff是自动的。自身根据场上层数获得“五行共鸣”Buff需玩家手动添加。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 9,
                        "shenfa": 9,
                        "tipo": 9,
                        "neixi": 9,
                        "qigan": 9,
                        "shencai": 3
                    }
                },
                "stage2": {
                    "stats": {
                        "liliang": 18,
                        "shenfa": 18,
                        "tipo": 18,
                        "neixi": 18,
                        "qigan": 18,
                        "shencai": 6
                    },
                    "description": "<p>小成运功特效：<br>招式命中无架招目标时，为其添加一层“五行”，在战斗脱离后消失，最多叠加三层。<br>五行：每层减少招式伤害5点。</p>",
                    "scripts": [
                        {
                            "label": "五行心法-施加五行(小成)",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (!args.isHit) return;\n// 检查目标是否有架招\nconst targetStance = args.target.system?.martial?.stanceActive;\nif (targetStance) return;\n\nconst sourceEffect = thisItem.effects.getName(\"五行\");\nif (sourceEffect) {\n    const effData = sourceEffect.toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 27,
                        "shenfa": 27,
                        "tipo": 27,
                        "neixi": 27,
                        "qigan": 27,
                        "shencai": 9
                    },
                    "description": "<p>圆满运功特效：<br>招式命中目标时，为其添加一层“五行”，在战斗脱离后消失，最多叠加三层。<br>五行：每层减少招式伤害5点。<br>·战斗场景内每有一层“五行”，自身招式伤害提升5点。（至多+30）</p><p>修满特效：修满[永久]：气血+40，内力+20，全属性+2。</p>",
                    "scripts": [
                        {
                            "label": "五行心法-施加五行(圆满)",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (!args.isHit) return;\nconst sourceEffect = thisItem.effects.getName(\"五行\");\nif (sourceEffect) {\n    const effData = sourceEffect.toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}"
                        }
                    ]
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 40
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 20
                },
                {
                    "key": "system.stats.liliang.value",
                    "value": 2
                },
                {
                    "key": "system.stats.shenfa.value",
                    "value": 2
                },
                {
                    "key": "system.stats.tipo.value",
                    "value": 2
                },
                {
                    "key": "system.stats.neixi.value",
                    "value": 2
                },
                {
                    "key": "system.stats.qigan.value",
                    "value": 2
                },
                {
                    "key": "system.stats.shencai.value",
                    "value": 2
                }
            ]
        },
        "effects": [
            {
                "name": "五行",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "每层减少招式伤害5点。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": -5
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_wuxing",
                        "stackable": true,
                        "maxStacks": 3
                    }
                }
            },
            {
                "name": "五行共鸣",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "战斗场景内每有一层“五行”，自身招式伤害提升5点。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": 5
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_wuxing_buff",
                        "stackable": true,
                        "maxStacks": 6
                    }
                }
            }
        ]
    },
    {
        "name": "《明王金策》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 2,
            "element": "yang",
            "sect": "mingjiao",
            "description": "<p>明教核心内功，源于摩尼教，其经文迥异于中原武林内功心法，修炼条件苛刻，除修炼体之苦，兼悟佛法之意，功成有若金刚护体，诸害不侵。</p>",
            "requirement": "悟性4",
            "automationNote": "手动。内功中已包含“不动明王”和“大轮明王”的特效数据，请玩家在特效栏手动拖拽应用或移除。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 16,
                        "shenfa": 7,
                        "tipo": 7,
                        "neixi": 7,
                        "qigan": 6,
                        "shencai": 5
                    }
                },
                "stage2": {
                    "stats": {
                        "liliang": 30,
                        "shenfa": 17,
                        "tipo": 15,
                        "neixi": 12,
                        "qigan": 12,
                        "shencai": 10
                    },
                    "description": "<p>小成运功特效：<br>脱离战斗后，进入“不动明王”状态。<br>不动明王：下一次受到攻击时减免20点伤害。</p>"
                },
                "stage3": {
                    "stats": {
                        "liliang": 44,
                        "shenfa": 25,
                        "tipo": 24,
                        "neixi": 18,
                        "qigan": 18,
                        "shencai": 15
                    },
                    "description": "<p>圆满运功特效：<br>脱离战斗后，进入“不动明王”状态。<br>不动明王：下一次受到攻击时减免30点伤害。<br>进入战斗后，进入“大轮明王”状态，<br>大轮明王：你的招式伤害提高10点，且免疫“下盘不稳”状态。</p><p>修满特效：修满[永久]：气血+40，内力+20，[佛法]+1。</p>"
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 40
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 20
                },
                {
                    "key": "system.arts.fofa.value",
                    "value": 1
                }
            ]
        },
        "effects": [
            {
                "name": "不动明王",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "护盾：下一次受到攻击时减免伤害（小成20/圆满30）。触发后自动移除。",
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_budong"
                    }
                },
                "scripts": [
                    {
                        "trigger": "preTake",
                        "label": "不动明王-护盾",
                        "script": "// 护盾逻辑：脚本根据当前内功境界判断减免量，或者我们可以简单点做两个AE，这里为了灵活做成一个AE\n// 假设是圆满(30)，小成需要玩家手动调整或接受30\n// 更稳妥的方式是：玩家手动选择添加“不动明王(小成)”或“不动明王(圆满)”\n// 这里脚本里写死30，若需20请玩家自行修正或GM处理\nargs.output.damage = Math.max(0, args.output.damage - 30);\nui.notifications.info(\"不动明王抵挡了伤害！\");\nawait thisEffect.delete();"
                    }
                ]
            },
            {
                "name": "大轮明王",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "招式伤害提高10点，且免疫“下盘不稳”状态。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": 10
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_dalun"
                    },
                    "scripts": [
                        {
                            "trigger": "passive",
                            "script": "actor.xjzlStatuses.unstable = false;"
                        }
                    ]
                }
            }
        ]
    },
    {
        "name": "《焚天诀》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 3,
            "element": "yang",
            "sect": "mingjiao",
            "description": "<p>明教不世神功，至最高境界，周身气血流转全凭心意，有迁经移络之能，聚气卸力之功，颠倒刚柔、扭转阴阳之威，非悟性极高者实难尽览奥妙</p>",
            "requirement": "悟性11",
            "automationNote": "完全自动化。通过 attack 阶段检测绝招施放。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 35,
                        "shenfa": 20,
                        "tipo": 20,
                        "neixi": 18,
                        "qigan": 15,
                        "shencai": 12
                    },
                    "description": "<p>领悟运功特效：每次施展绝招后，获得“明王”，持续三回合。<br>明王：招式伤害+10点。</p>",
                    "scripts": [
                        {
                            "label": "焚天诀-明王触发(10)",
                            "trigger": "attack",
                            "active": true,
                            "script": "if (args.move.isUltimate) {\n    const sourceEffect = thisItem.effects.getName(\"明王\");\n    if (sourceEffect) {\n        const effData = sourceEffect.toObject();\n        delete effData._id;\n        effData.origin = thisItem.uuid;\n        effData.changes[0].value = 10; // 动态修改数值\n        await game.xjzl.api.effects.addEffect(actor, effData);\n    }\n}"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 70,
                        "shenfa": 42,
                        "tipo": 42,
                        "neixi": 36,
                        "qigan": 30,
                        "shencai": 20
                    },
                    "description": "<p>小成运功特效：每次施展绝招后，获得“明王”，持续三回合。<br>明王：招式伤害+20点。</p>",
                    "scripts": [
                        {
                            "label": "焚天诀-明王触发(20)",
                            "trigger": "attack",
                            "active": true,
                            "script": "if (args.move.isUltimate) {\n    const sourceEffect = thisItem.effects.getName(\"明王\");\n    if (sourceEffect) {\n        const effData = sourceEffect.toObject();\n        delete effData._id;\n        effData.origin = thisItem.uuid;\n        effData.changes[0].value = 20;\n        await game.xjzl.api.effects.addEffect(actor, effData);\n    }\n}"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 104,
                        "shenfa": 60,
                        "tipo": 68,
                        "neixi": 55,
                        "qigan": 45,
                        "shencai": 28
                    },
                    "description": "<p>圆满运功特效：每次施展绝招后，获得“明王”，持续三回合。<br>明王：招式伤害+40点。</p><p>修满特效：修满[永久]：气血+60，内力+60。<br>释放绝招的怒气消耗减少1点（至少1点）</p>",
                    "scripts": [
                        {
                            "label": "焚天诀-明王触发(40)",
                            "trigger": "attack",
                            "active": true,
                            "script": "if (args.move.isUltimate) {\n    const sourceEffect = thisItem.effects.getName(\"明王\");\n    if (sourceEffect) {\n        const effData = sourceEffect.toObject();\n        delete effData._id;\n        effData.origin = thisItem.uuid;\n        effData.changes[0].value = 40;\n        await game.xjzl.api.effects.addEffect(actor, effData);\n    }\n}"
                        }
                    ]
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 60
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 60
                },
                {
                    "key": "system.combat.costs.rage.value",
                    "value": 1
                }
            ]
        },
        "effects": [
            {
                "name": "明王",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "绝招后增伤。",
                "duration": {
                    "rounds": 3
                },
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": 0
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_mingwang"
                    }
                }
            }
        ]
    },
    {
        "name": "《四寂法尊功》",
        "type": "neigong",
        "img": "systems/xjzl-system/assets/icons/neigong/明教.png",
        "system": {
            "tier": 3,
            "element": "taiji",
            "sect": "mingjiao",
            "description": "<p>波斯明教传世心法，记载于圣火令中。<br>“真妄归根，明既归于大明，暗亦归于积暗，两者交归”，此功修炼清净、光明、威神、智慧四大法身境界，大成之后，十德俱全，内外皆通，不惧任何左道之术。</p>",
            "requirement": "悟性11",
            "automationNote": "部分自动化。光/暗层数自动叠加。主动消耗层数换取效果需玩家手动操作。",
            "config": {
                "stage1": {
                    "stats": {
                        "liliang": 30,
                        "shenfa": 10,
                        "tipo": 25,
                        "neixi": 25,
                        "qigan": 18,
                        "shencai": 12
                    },
                    "description": "<p>领悟运功特效：<br>积暗：每回合初获得一层“暗”，持续到脱战。<br>光明：你出招时获得一层“光”，持续到脱战。</p>",
                    "scripts": [
                        {
                            "label": "四寂-积暗",
                            "trigger": "turnStart",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"暗\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); }"
                        },
                        {
                            "label": "四寂-光明",
                            "trigger": "attack",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"光\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); }"
                        }
                    ]
                },
                "stage2": {
                    "stats": {
                        "liliang": 60,
                        "shenfa": 20,
                        "tipo": 50,
                        "neixi": 50,
                        "qigan": 36,
                        "shencai": 24
                    },
                    "description": "<p>小成运功特效：<br>积暗：每回合初获得两层“暗”，持续到脱战。<br>光明：你出招时获得两层“光”，持续到脱战。</p>",
                    "scripts": [
                        {
                            "label": "四寂-积暗(2)",
                            "trigger": "turnStart",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"暗\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); }"
                        },
                        {
                            "label": "四寂-光明(2)",
                            "trigger": "attack",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"光\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); }"
                        }
                    ]
                },
                "stage3": {
                    "stats": {
                        "liliang": 90,
                        "shenfa": 30,
                        "tipo": 75,
                        "neixi": 75,
                        "qigan": 54,
                        "shencai": 36
                    },
                    "description": "<p>圆满运功特效：<br>积暗：每回合初获得三层“暗”，持续到脱战。<br>光明：你出招时获得三层“光”，持续到脱战。<br>·你可以花费反应动作，移除对应层数的光和暗，获得以下效果之一：<br>净（一光、一暗）：为自身回复30点气血内力。<br>明（四光、一暗）：获得2点怒气。<br>威（一光、四暗）：本回合招式伤害提高30点。<br>慧（四光、四暗）：为自身移除一个状态。</p><p>修满特效：修满[永久]：气血+80，内力+40。</p>",
                    "scripts": [
                        {
                            "label": "四寂-积暗(3)",
                            "trigger": "turnStart",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"暗\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); }"
                        },
                        {
                            "label": "四寂-光明(3)",
                            "trigger": "attack",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"光\"); if(source) { const d = source.toObject(); delete d._id; d.origin = thisItem.uuid; await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); await game.xjzl.api.effects.addEffect(actor, d); }"
                        }
                    ]
                }
            },
            "masteryChanges": [
                {
                    "key": "system.resources.hp.bonus",
                    "value": 80
                },
                {
                    "key": "system.resources.mp.bonus",
                    "value": 40
                }
            ]
        },
        "effects": [
            {
                "name": "暗",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "积暗层数。",
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_an",
                        "stackable": true
                    }
                }
            },
            {
                "name": "光",
                "icon": "systems/xjzl-system/assets/icons/neigong/明教.png",
                "transfer": false,
                "description": "光明层数。",
                "flags": {
                    "xjzl-system": {
                        "slug": "neigong_guang",
                        "stackable": true
                    }
                }
            }
        ]
    }
]