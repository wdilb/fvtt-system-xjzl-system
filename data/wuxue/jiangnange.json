[
    {
        "name": "烟雨剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>江南烟雨朦胧，芳草鲜美，江南阁便是这样一处地方，此剑法以春水落花为意，美轮美奂。</p>",
            "requirements": "剑 属性：阴",
            "moves": [
                {
                    "name": "风花雪月",
                    "type": "real",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>全回合动作，可移动释放，旋身舞剑，对周围敌人造成 0.3 力量点外功伤害。<br>·此招可移动释放，对移动路径上周围 2 米范围内的敌人造成伤害。（不会重复造成伤害）</p>",
                    "automationNote": "移动路径上的伤害需手动结算。",
                    "scripts": []
                },
                {
                    "name": "飞花似梦",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，瞬刺上挑，对目标造成 0.3 力量点外功伤害，若命中无架招目标，将其击飞 1 米。</p>",
                    "automationNote": "击飞效果需手动处理。",
                    "scripts": []
                },
                {
                    "name": "春雨绵绵",
                    "type": "stance",
                    "element": "yin",
                    "weaponType": "sword",
                    "range": "自身/3",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "description": "<p>次要动作，抚剑轻吟，开启架招。架招开启期间，在自身回合初为 3 米范围内未陷入濒死的友方单位回复 5 点气血。</p>",
                    "automationNote": "回合初治疗需手动执行。",
                    "scripts": []
                },
                {
                    "name": "镜花水月",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，空灵舞剑，剑射寒光，对目标造成 0.6 力量点外功伤害。<br>若目标无架招，为其添加“禁实”，持续一回合。</p>",
                    "scripts": [
                        {
                            "label": "添加禁实",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, \"jinshi\");\n}"
                        }
                    ]
                }
            ]
        },
        "effects": []
    },
    {
        "name": "汉宫秋月",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>琴阁特定武学，“清风低诉些些事，昨月始从今日圆”，倾诉哀怨悲愁，无可奈何，寂寥清冷之意。</p>",
            "requirements": "乐器 属性：阴",
            "moves": [
                {
                    "name": "清冷月",
                    "type": "stance",
                    "element": "yin",
                    "weaponType": "instrument",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "description": "<p>次要动作，静默音清，开启架招。格挡成功后，自身获得“清音”，持续一回合。<br>清音：你的[演奏]检定结果+1。</p>",
                    "scripts": [
                        {
                            "label": "格挡触发清音",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const bonus = 1 + (args.move.computedLevel - 1);\n    const rounds = 1 + (args.move.computedLevel - 1);\n    const effect = thisItem.effects.getName(\"清音\").toObject();\n    effect.duration.rounds = rounds;\n    effect.changes[0].value = bonus;\n    await game.xjzl.api.effects.addEffect(actor, effect);\n}"
                        }
                    ]
                },
                {
                    "name": "玉叶坠",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>蓄力动作，思物心伤，一音三叹，对范围内所有敌造成 0.3 内息点内功伤害。<br>·若目标的侠恶标签与你不同，招式暴击骰-2。<br>·若目标的性别与你不同，招式伤害+10。</p>",
                    "scripts": [
                        {
                            "label": "侠恶与性别判断",
                            "trigger": "check",
                            "script": "const myXiayi = actor.system.social.xiayi; const myExing = actor.system.social.exing;\nconst tXiayi = args.target.system.social.xiayi; const tExing = args.target.system.social.exing;\nconst myTag = (myXiayi >= 100 && myExing <= 50) ? 'good' : (myExing >= 100 && myXiayi <= 50 ? 'evil' : 'neutral');\nconst tTag = (tXiayi >= 100 && tExing <= 50) ? 'good' : (tExing >= 100 && tXiayi <= 50 ? 'evil' : 'neutral');\nif (myTag !== tTag) {\n    args.flags.critThresholdMod += 2;\n}"
                        },
                        {
                            "label": "性别伤害修正",
                            "trigger": "preDamage",
                            "script": "if (actor.system.info.gender !== args.target.system.info.gender) {\n    args.config.amount += 10;\n}"
                        }
                    ]
                },
                {
                    "name": "泪无声",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，情已死，奏短促顿音，对敌方造成 0.3 内息点内功伤害。击破架招时，为其添加“不怒”，持续两回合。<br>不怒：你无法获得怒气。</p>",
                    "scripts": [
                        {
                            "label": "击破添加不怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.isBroken) {\n    const effect = game.xjzl.api.effects.getEffectData(\"bunu\");\n    if (effect) {\n        effect.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, effect);\n    } else {\n       // Fallback for system effect ID if getEffectData helper is not available, use addEffect directly\n       const sysEffect = CONFIG.statusEffects.find(e => e.id === 'bunu');\n       if(sysEffect) {\n           const data = foundry.utils.deepClone(sysEffect);\n           data.duration = { rounds: 2 };\n           await game.xjzl.api.effects.addEffect(args.target, data);\n       }\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "照尘凡",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>蓄力动作，清怨抑郁待天明，音色委婉痛人心，对周围敌人造成 0.5 内息点内功伤害。<br>·若目标存在任意乐器武学、乐谱散手给予的状态，每有一个，招式伤害+10。</p>",
                    "automationNote": "目标身上的乐器状态加成需手动计算并修正伤害。",
                    "scripts": []
                }
            ]
        },
        "effects": [
            {
                "name": "清音",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你的[演奏]检定结果+1。",
                "changes": [
                    {
                        "key": "arts.yanzou.checkMod",
                        "mode": 2,
                        "value": "1"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "醉梦笔录",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>书阁特定武学，“凭君满酌酒，听我醉中吟”，酒逢知己千杯少，把酒共论天与地。</p>",
            "requirements": "匕首-笔 属性：太极",
            "moves": [
                {
                    "name": "诗酒风流",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>全回合动作，吟风弄月，消耗一壶美酒，一边痛饮，一边以笔蘸酒，获得美酒效果的同时，你进入“诗酒”，持续十回合。<br>诗酒：你的《醉梦笔录》招式命中后，给目标添加 5 醉意值。</p>",
                    "scripts": [
                        {
                            "label": "应用诗酒",
                            "trigger": "hit",
                            "script": "const effect = thisItem.effects.getName(\"诗酒\");\nawait game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ],
                    "automationNote": "美酒效果需手动消耗物品获得。"
                },
                {
                    "name": "雾里探花",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，醉意朦胧，笔寻良人，对目标造成 0.3 内息点内功伤害。命中无架招目标时，为其添加一层“失准”，至多三层，持续到战斗脱离。<br>失准：每层使你的命中-5。</p>",
                    "scripts": [
                        {
                            "label": "添加失准",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effect = CONFIG.statusEffects.find(e => e.id === 'shizhun');\n    const data = foundry.utils.deepClone(effect);\n    data.flags['xjzl-system'].maxStacks = 3;\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}"
                        }
                    ]
                },
                {
                    "name": "尊酒相逢",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "2",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>蓄力动作，移笔劝酒，对周围目标造成 0.3 内息点内功伤害。<br>·若周围有目标处于“醉倒”，可消耗反应动作再次释放此招。</p>",
                    "automationNote": "反应动作追击需手动执行。",
                    "scripts": []
                },
                {
                    "name": "对酒当歌",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，酒过三巡，神采奕奕，你对目标造成 0.5 内息点内功伤害，并使目标进行[酒艺]检定（难度 13），失败则醉意值+20。<br>·若目标因此陷入醉倒，还会陷入“呕吐”。<br>呕吐：失去所有动作，大口呕出胃中食物，持续一个回合，呕吐后饱食度-50。</p>",
                    "scripts": [
                        {
                            "label": "酒艺检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"jiuyi\",\n        dc: 13,\n        label: \"抵抗醉意\",\n        onFail: async () => {\n            if (args.target.system.resources?.alcohol) {\n                const cur = args.target.system.resources.alcohol.value;\n                const max = args.target.system.resources.alcohol.max;\n                await args.target.update({ 'system.resources.alcohol.value': cur + 20 });\n                ui.notifications.warn(`${args.target.name} 醉意猛增！`);\n                \n                if (args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'zuidao') || (cur + 20) > max) {\n                     const stun = CONFIG.statusEffects.find(e => e.id === 'stun');\n                     if (stun) {\n                         const vomit = foundry.utils.deepClone(stun);\n                         vomit.name = \"呕吐\";\n                         vomit.img = \"icons/svg/acid.svg\"; \n                         vomit.duration = { rounds: 1 };\n                         await game.xjzl.api.effects.addEffect(args.target, vomit);\n                         if (args.target.system.resources?.satiety) {\n                             const food = args.target.system.resources.satiety.value;\n                             await args.target.update({'system.resources.satiety.value': Math.max(0, food - 50)});\n                         }\n                         ui.notifications.warn(`${args.target.name} 呕吐不止！`);\n                     }\n                }\n            }\n        }\n    });\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "诗酒",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你的《醉梦笔录》招式命中后，给目标添加 5 醉意值。",
                "duration": {
                    "rounds": 10
                },
                "flags": {
                    "xjzl-system": {
                        "slug": "shijiu"
                    }
                },
                "scripts": [
                    {
                        "label": "诗酒触发",
                        "trigger": "hit",
                        "script": "if (args.isHit && args.item.name === '醉梦笔录' && args.target.system.resources?.alcohol) {\n    const cur = args.target.system.resources.alcohol.value;\n    await args.target.update({ 'system.resources.alcohol.value': cur + 5 });\n    ui.notifications.info(`${args.target.name} 醉意 +5`);\n}"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "四君子画",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>画阁特定武学，环翠山庄遍植梅、兰、竹、菊，谓之四君子也。</p>",
            "requirements": "匕首-笔 属性：太极",
            "moves": [
                {
                    "name": "画梅诀",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，枝中要求曲，叠花似品字，对目标造成 0.4 力量点外功伤害。<br>·自身获得“梅”，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "获得梅",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effect = thisItem.effects.getName(\"梅\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "画兰诀",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，一笔长二笔短，三笔破凤眼，对目标造成 0.4 力量点内功伤害。<br>·自身获得“兰”，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "获得兰",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effect = thisItem.effects.getName(\"兰\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "画竹诀",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，晴竹仰叶多，雨竹枝略弯，对目标造成 0.4 内息点外功伤害。<br>·自身获得“竹”，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "获得竹",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effect = thisItem.effects.getName(\"竹\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "画菊诀",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，花瓣相错位，外瓣参差展，对目标造成 0.4 内息点内功伤害。<br>·自身获得“菊”，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "获得菊",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effect = thisItem.effects.getName(\"菊\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "谦谦君子",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "taiji",
                    "actionType": "heal",
                    "damageType": "none",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>主要动作，借物喻志，消耗任意“梅、兰、竹、菊”状态，每消耗一个为目标回复 10 气血，然后为自身添加“四君子”，持续到战斗脱离。<br>四君子：当你受到伤害时，可消耗反应动作释放《四君子画》的招式。<br>·若同时消耗“梅、兰、竹、菊”四种状态，可额外回复与气血等额的内力。</p>",
                    "scripts": [
                        {
                            "label": "消耗状态治疗",
                            "trigger": "hit",
                            "script": "const buffs = [\"mei\", \"lan\", \"zhu\", \"ju\"];\nlet count = 0;\n// 提示玩家输入消耗数量\nconst input = await foundry.applications.api.DialogV2.prompt({\n    window: { title: \"消耗状态数量\" },\n    content: `<p>请输入你要消耗的状态数量 (0-4):</p><input type='number' name='count' min='0' max='4' value='0'>`,\n    ok: { callback: (event, button, dialog) => button.form.elements.count.value }\n});\ncount = parseInt(input) || 0;\n\nconst healPerStack = 10 + (args.move.computedLevel - 1) * 10;\nconst totalHeal = count * healPerStack;\n\nif (totalHeal > 0) {\n    await args.target.applyHealing({ amount: totalHeal, type: 'hp', showScrolling: true });\n    if (count === 4) {\n        await args.target.applyHealing({ amount: totalHeal, type: 'mp', showScrolling: true });\n        ui.notifications.info(\"四君子齐聚，额外回复内力！\");\n    }\n}\nconst effect = thisItem.effects.getName(\"四君子\");\nawait game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ],
                    "automationNote": "状态需手动删除。"
                }
            ]
        },
        "effects": [
            {
                "name": "梅",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "四君子之一。",
                "flags": {
                    "xjzl-system": {
                        "slug": "mei"
                    }
                },
                "transfer": false
            },
            {
                "name": "兰",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "四君子之一。",
                "flags": {
                    "xjzl-system": {
                        "slug": "lan"
                    }
                },
                "transfer": false
            },
            {
                "name": "竹",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "四君子之一。",
                "flags": {
                    "xjzl-system": {
                        "slug": "zhu"
                    }
                },
                "transfer": false
            },
            {
                "name": "菊",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "四君子之一。",
                "flags": {
                    "xjzl-system": {
                        "slug": "ju"
                    }
                },
                "transfer": false
            },
            {
                "name": "四君子",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "当你受到伤害时，可消耗反应动作释放《四君子画》的招式。",
                "flags": {
                    "xjzl-system": {
                        "slug": "sijunzi"
                    }
                },
                "transfer": false
            }
        ]
    },
    {
        "name": "无声棋局",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>棋阁特定武学，水落、松涛、鸟啼，静心落子，不乱我棋。</p>",
            "requirements": "暗器-弹丸 属性：阴",
            "moves": [
                {
                    "name": "观棋不语",
                    "type": "stance",
                    "element": "yin",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "description": "<p>次要动作，执双子，观战局，开启架招。格挡成功后，获得一层“不语”，至多三层，持续到脱战。<br>不语：每层使命中+5；当不语叠加满三层，可在出招命中时移除所有不语，使招式伤害提升 20 点。</p>",
                    "scripts": [
                        {
                            "label": "格挡叠加不语",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"不语\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        },
                        {
                            "label": "消耗不语增伤",
                            "trigger": "calc",
                            "script": "const buyu = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'buyu');\nif (buyu && buyu.getFlag('xjzl-system', 'stacks') === 3) {\n    args.output.damage += 20;\n    args.output.bonusDesc.push(\"消耗不语 +20\");\n}"
                        },
                        {
                            "label": "移除不语",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const buyu = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'buyu');\n    if (buyu && buyu.getFlag('xjzl-system', 'stacks') === 3) {\n        await buyu.delete();\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "黑白交错",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，局半开，弹二子，射向范围内的一个敌人和一名其他友方。<br>对该敌人造成 0.4 内息点内功伤害；为友方添加一层“不语”，至多三层，持续到脱战。</p>",
                    "automationNote": "请在攻击敌人时，手动给友方添加'不语'层数。",
                    "scripts": []
                },
                {
                    "name": "难分胜负",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 5
                    },
                    "description": "<p>主要动作，思如潮，风云变，对敌方造成 0.3 内息点内功伤害。命中无架招目标时，自身获得一层“不语”，至多三层，持续到脱战。<br>·你可以与目标进行一个[棋术]对抗，若你获胜，虚招值+2。</p>",
                    "scripts": [
                        {
                            "label": "命中加不语",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effect = thisItem.effects.getName(\"不语\");\n    await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ],
                    "automationNote": "棋术对抗及虚招值加成需手动处理。"
                },
                {
                    "name": "一子定音",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ],
                        "growth": 20
                    },
                    "description": "<p>主要动作，子落枰，定乾坤，对目标造成 0.6 内息点内功伤害。<br>·若自身具有三层“不语”，进行一个[棋术]检定（难度 10），成功则棋子破空，清脆击打在目标身上，给目标添加“禁实”，持续两回合。</p>",
                    "scripts": [
                        {
                            "label": "三层不语检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const buyu = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'buyu');\n    if (buyu && buyu.getFlag('xjzl-system', 'stacks') === 3) {\n        const roll = await actor.rollAttributeTest('qishu');\n        if (roll.total >= 10) {\n            await game.xjzl.api.effects.addEffect(args.target, \"jinshi\");\n        }\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "不语",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "每层使命中+5；当不语叠加满三层，可在出招命中时移除所有不语，使招式伤害提升 20 点。",
                "flags": {
                    "xjzl-system": {
                        "slug": "buyu",
                        "stackable": true,
                        "maxStacks": 3
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.hit_waigong",
                        "mode": 2,
                        "value": "5"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "龙蛇笔法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>江南阁书法绝技，下笔如龙蛇飞动，笔力劲健，变化多端，意领神悟。</p>",
            "requirements": "匕首-笔 属性：柔",
            "moves": [
                {
                    "name": "颜筋柳骨",
                    "type": "qi",
                    "actionType": "default",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>主要动作，雄强圆厚，挺拔见功，自身获得“颜体”，持续到战斗脱离或获得“柳体”。<br>颜体：你的下一次招式伤害提升[书写]等级*1 的数值，然后获得“柳体”，持续到战斗脱离或进入“颜体”。<br>柳体：你受到内外功伤害时，减少[书写]等级*1 的数值，然后获得“颜体”，持续到战斗脱离或获得“柳体”。</p>",
                    "scripts": [
                        {
                            "label": "获得颜体",
                            "trigger": "attack",
                            "script": "const effect = thisItem.effects.getName(\"颜体\");\nawait game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ],
                    "automationNote": "颜体/柳体自动循环转化逻辑复杂，若自动失效请手动切换。"
                },
                {
                    "name": "力透纸背",
                    "type": "stance",
                    "element": "rou",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "自身/1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "description": "<p>次要动作，提蓄笔力，开启架招。格挡成功后，可消耗反应动作，对其施展【笔下生风】。</p>",
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"触发力透纸背：可反应释放【笔下生风】\");\n}"
                        }
                    ],
                    "automationNote": "反应释放需手动操作。"
                },
                {
                    "name": "笔下生风",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "3",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，笔画狂放，龙蛇飞腾，奔至目标周围空格处，对其造成 0.4 力量点外功伤害。命中无架招目标时，为其添加“目盲”，持续两回合。</p>",
                    "scripts": [
                        {
                            "label": "添加目盲",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, \"blind\");\n}"
                        }
                    ],
                    "automationNote": "移动至目标周围空格需手动操作。"
                },
                {
                    "name": "龙飞凤舞",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "2",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ],
                        "growth": 20
                    },
                    "description": "<p>蓄力动作，千回百转，迂回盘绕，对周围敌人造成 0.6 力量点外功伤害。<br>若你处于“颜体”，招式击飞所有敌人 3 米。<br>若你处于“柳体”，自身和周围友方获得 20 点护体真气，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "颜柳特效",
                            "trigger": "hit",
                            "script": "const hasYanti = actor.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'yanti');\nconst hasLiuti = actor.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'liuti');\n\nif (hasYanti && args.isHit) {\n    ui.notifications.info(`${args.target.name} 被击飞 3 米！`);\n}\nif (hasLiuti) {\n    // 友方护体需手动，此处给自身加\n    await actor.applyHealing({ amount: 20, type: 'huti', showScrolling: true });\n    ui.notifications.info(\"柳体触发：自身及周围友方获得 20 护体（友方需手动）\");\n}"
                        }
                    ],
                    "automationNote": "击飞及友方护体需手动处理。"
                }
            ]
        },
        "effects": [
            {
                "name": "颜体",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你的下一次招式伤害提升[书写]等级*1 的数值，然后获得“柳体”。",
                "flags": {
                    "xjzl-system": {
                        "slug": "yanti"
                    }
                },
                "scripts": [
                    {
                        "label": "颜体增伤",
                        "trigger": "calc",
                        "script": "const skillLevel = actor.system.arts.shuxie.total || 0;\nconst level = args.move.computedLevel || 1;\nconst ratio = 1 + (level - 1);\nconst bonus = skillLevel * ratio;\nargs.output.damage += bonus; args.output.bonusDesc.push(`颜体 +${bonus}`);"
                    }
                ],
                "transfer": false
            },
            {
                "name": "柳体",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你受到内外功伤害时，减少[书写]等级*1 的数值，然后获得“颜体”。",
                "flags": {
                    "xjzl-system": {
                        "slug": "liuti"
                    }
                },
                "scripts": [
                    {
                        "label": "柳体减伤",
                        "trigger": "preTake",
                        "script": "if(['waigong','neigong'].includes(args.type)) {\n    const skillLevel = actor.system.arts.shuxie.total || 0;\n    // 这里没有 level 参数，暂时取1或者读取来源武学等级，这里简化取1\n    const bonus = skillLevel * 1;\n    args.output.damage = Math.max(0, args.output.damage - bonus);\n}"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "墨韵流芳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>江南阁丹青绝技，绘宫阙雄奇，勾山水浩瀚，观之醉心画中，自叹弗如。</p>",
            "requirements": "匕首-笔 属性：太极",
            "moves": [
                {
                    "name": "雕梁画栋",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "3",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，翠瓦朱楹，飞檐翘角，对目标造成 0.5 内息点内功伤害。<br>然后进行一个[作画]检定（难度 10），成功则在目标所处空格处绘下‘琼楼’，持续到战斗脱离。<br>琼楼：处于此区域的目标视作处于半空中。</p>",
                    "scripts": [
                        {
                            "label": "作画检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const roll = await actor.rollAttributeTest('zuohua');\n    if (roll.total >= 10) {\n        ui.notifications.info(\"作画成功，在目标脚下生成‘琼楼’（请放置模板）\");\n    }\n}"
                        }
                    ],
                    "automationNote": "琼楼区域效果需手动处理。"
                },
                {
                    "name": "落纸烟云",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "5",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>蓄力动作，挥墨行水，泼天浩渺，对直线路径所有敌人造成 0.3 内息点内功伤害，命中无架招目标时为其添加一层“乏力”，至多三层，持续到脱战。<br>乏力：每层使招式伤害降低 10 点。<br>·直线路径上若有‘琼楼’，虚招值+1。</p>",
                    "scripts": [
                        {
                            "label": "添加乏力",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effect = CONFIG.statusEffects.find(e => e.id === 'fali');\n    const data = foundry.utils.deepClone(effect);\n    data.flags['xjzl-system'].maxStacks = 3;\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}"
                        }
                    ],
                    "automationNote": "琼楼对虚招值的加成需手动修正。"
                },
                {
                    "name": "高屋建瓴",
                    "type": "stance",
                    "element": "taiji",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "description": "<p>次要动作，笔墨飞扬，翠峰倚天，开启架招。格挡成功后，在攻击者所处空格处绘下‘琼楼’，持续到战斗脱离。</p>",
                    "scripts": [
                        {
                            "label": "生成琼楼",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功，在攻击者脚下生成‘琼楼’（请放置模板）\");\n}"
                        }
                    ],
                    "automationNote": "琼楼区域效果需手动处理。"
                },
                {
                    "name": "醉墨淋漓",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "3",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ],
                        "growth": 20
                    },
                    "description": "<p>蓄力动作，放肆纵横，泼墨晕染，对周围敌人造成 0.6 内息点内功伤害。<br>周围若有‘琼楼’，墨劲震荡，将其全部移除，每移除一个，本招式伤害+10，若有人正处于‘琼楼’区域，还会陷入倒地。</p>",
                    "automationNote": "琼楼移除伤害加成及倒地效果需手动处理。",
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "弈理指归",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>弈之为道，数叶天垣，理参河洛，阴阳之体用，奇正之经权，无不寓焉。以“五行源奥”“八卦渊微”录棋图二十四式，寓意玄奥，晦涩难懂。</p>",
            "requirements": "暗器-弹丸 属性：太极",
            "moves": [
                {
                    "name": "关飞封角",
                    "type": "stance",
                    "element": "taiji",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "description": "<p>次要动作，执子待守，尤虑虚攻，开启架招。格挡成功后获得“弈理”，持续到脱战或解除架招。<br>弈理：你的属性技能、技艺检定结果+1。</p>",
                    "scripts": [
                        {
                            "label": "获得弈理",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"弈理\");\n    const bonus = 1 + (args.move.computedLevel - 1);\n    const data = effect.toObject();\n    data.changes[0].value = bonus;\n    await game.xjzl.api.effects.addEffect(actor, data);\n}"
                        }
                    ]
                },
                {
                    "name": "飞联气贯",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，小侵虚顶，行机应变，对目标造成 0.5 内息点内功伤害。命中无架招目标时，将其朝任意方向击飞 2 米。</p>",
                    "scripts": [
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击飞 2 米！`);\n}"
                        }
                    ],
                    "automationNote": "击飞效果需手动处理。"
                },
                {
                    "name": "变胜先手",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，运棋无形，制胜无相，对目标造成 0.4 内息点内功伤害。击破架招时，为目标添加“迟滞”，持续三回合。<br>·若你虚招对抗失败，可以与目标进行一次[棋术]对抗检定，若你获胜，为目标添加“迟滞”，持续一回合。</p>",
                    "scripts": [
                        {
                            "label": "添加迟滞",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"chizhi\");\n}"
                        }
                    ],
                    "automationNote": "对抗失败后的棋术检定需手动进行。"
                },
                {
                    "name": "弈理天问",
                    "type": "qi",
                    "isUltimate": true,
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "weaponSubtype": "弹丸",
                    "range": "5",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>蓄力动作，尽变之义，极变之致，消耗“弈理”，在自身周围内布下‘渊微’，持续一回合。<br>渊微：区域内的敌人无法离开此范围，只能在区域范围内移动。<br>·你处于区域内时每回合初额外获得一个主要动作。<br>·渊微形成在原地，不会跟随你移动，你只能拥有一个渊微，如果你布下新的渊微，之前的消失。</p>",
                    "scripts": [
                        {
                            "label": "消耗弈理",
                            "trigger": "attack",
                            "script": "const yili = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'yili');\nif (yili) { await yili.delete(); } else { ui.notifications.warn(\"未检测到弈理状态\"); }"
                        }
                    ],
                    "automationNote": "渊微区域效果需手动处理。"
                }
            ]
        },
        "effects": [
            {
                "name": "弈理",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你的属性技能、技艺检定结果+1。",
                "flags": {
                    "xjzl-system": {
                        "slug": "yili"
                    }
                },
                "changes": [
                    {
                        "key": "flags.xjzl-system.globalCheckLevel",
                        "mode": 2,
                        "value": "1"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "姑苏行",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "wuxue",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>悠悠春水，姑苏情意，此曲以昆曲为旋律音调，典雅秀美，别具一番江南风味。</p>",
            "requirements": "乐器-笛 属性：柔",
            "moves": [
                {
                    "name": "粉墙黛瓦",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "weaponSubtype": "笛",
                    "range": "10",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>蓄力动作，笛音宽厚圆润，直线上敌方进行[定力]检定（难度 15），失败陷入“禁足”一回合。<br>·若目标已处于禁足状态，则其眼中出现白墙黑瓦迷乱视野，陷入“目盲”一回合。</p>",
                    "scripts": [
                        {
                            "label": "定力检定",
                            "trigger": "hit",
                            "script": "const diff = 15 + (args.move.computedLevel - 1);\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: diff,\n    label: \"抵抗粉墙黛瓦\",\n    onFail: async () => {\n        const hasRoot = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'root');\n        let effectId = hasRoot ? 'blind' : 'root';\n        const effect = CONFIG.statusEffects.find(e => e.id === effectId);\n        if (effect) {\n            const data = foundry.utils.deepClone(effect);\n            data.duration = { rounds: 1 + (args.move.computedLevel - 1) };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n});"
                        }
                    ]
                },
                {
                    "name": "小桥流水",
                    "type": "stance",
                    "element": "rou",
                    "weaponType": "instrument",
                    "weaponSubtype": "笛",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "description": "<p>次要动作，旋律灵动，开启架招。格挡成功后，为自身及周围 1 米范围内的友方回复 5 点内力。</p>",
                    "scripts": [
                        {
                            "label": "回内",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    await actor.applyHealing({ amount: 5, type: 'mp', showScrolling: true });\n    ui.notifications.info(\"小桥流水触发：自身及周围1米友方回内5点（友方需手动）\");\n}"
                        }
                    ],
                    "automationNote": "友方回内需手动处理。"
                },
                {
                    "name": "江枫渔火",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "weaponSubtype": "笛",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ],
                        "growth": 10
                    },
                    "description": "<p>主要动作，长音短音错错落落，对目标造成 0.4 内息点内功伤害，之后目标进行[定力]检定（难度 15），失败则陷入“剧痛”，持续五回合。<br>击破架招时，目标进行的[定力]检定必定失败。</p>",
                    "scripts": [
                        {
                            "label": "剧痛判定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    if (args.isBroken) {\n        const effect = CONFIG.statusEffects.find(e => e.id === 'pain');\n        const data = foundry.utils.deepClone(effect);\n        data.duration = { rounds: 5 + (args.move.computedLevel - 1) * 5 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    } else {\n        await Macros.requestSave({\n            target: args.target,\n            attacker: actor,\n            type: \"dingli\",\n            dc: 15,\n            label: \"抵抗剧痛\",\n            onFail: async () => {\n                const effect = CONFIG.statusEffects.find(e => e.id === 'pain');\n                const data = foundry.utils.deepClone(effect);\n                data.duration = { rounds: 5 + (args.move.computedLevel - 1) * 5 };\n                await game.xjzl.api.effects.addEffect(args.target, data);\n            }\n        });\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "锦绣江南",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "weaponSubtype": "笛",
                    "range": "10",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ],
                        "growth": 20
                    },
                    "description": "<p>主要动作，曲调华美秀丽，使人迷醉，流连忘返，对目标造成 0.7 内息点内功伤害。<br>·范围内所有友方获得“锦绣”，持续三回合。<br>锦绣：免疫下盘不稳、禁足、缚身、流血、剧痛，且受到《趁虚而入》攻击后速度不会归零。</p>",
                    "scripts": [
                        {
                            "label": "添加锦绣",
                            "trigger": "hit",
                            "script": "const effect = thisItem.effects.getName(\"锦绣\");\nawait game.xjzl.api.effects.addEffect(actor, effect.toObject());\nui.notifications.info(\"已为自身添加锦绣，请手动为范围内友方添加。\");"
                        }
                    ],
                    "automationNote": "友方状态需手动添加。"
                }
            ]
        },
        "effects": [
            {
                "name": "锦绣",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "免疫下盘不稳、禁足、缚身、流血、剧痛，且受到《趁虚而入》攻击后速度不会归零。",
                "flags": {
                    "xjzl-system": {
                        "slug": "jinxiu"
                    }
                },
                "transfer": false
            }
        ]
    },
    {
        "name": "书香江南",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "sanshou",
            "sect": "jiangnange",
            "tier": 1,
            "description": "<p>乌篷船头，青石板上，风光旖旎，花红柳绿，遍地绮罗，温柔如梦，令人神往。</p>",
            "requirements": "匕首-笔 属性：柔",
            "moves": [
                {
                    "name": "书香江南",
                    "type": "qi",
                    "actionType": "default",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "weaponSubtype": "笔",
                    "range": "5",
                    "costs": {
                        "mp": [
                            1
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>蓄力动作，一缕书墨香回忆，获得“江南”状态，持续到战斗脱离。<br>江南：你与周围 5 米内友方招式伤害+5。<br>·你每个回合初必须再次消耗 1 点内力维持“江南”，否则移除江南。</p>",
                    "scripts": [
                        {
                            "label": "添加江南",
                            "trigger": "attack",
                            "script": "const effect = thisItem.effects.getName(\"江南\");\nawait game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ],
                    "automationNote": "对友方的光环效果需手动添加。"
                }
            ]
        },
        "effects": [
            {
                "name": "江南",
                "icon": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
                "description": "你与周围 5 米内友方招式伤害+5。回合初消耗1内力维持。",
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": "5"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "jiangnan"
                    }
                },
                "scripts": [
                    {
                        "label": "维持消耗",
                        "trigger": "turnStart",
                        "script": "if (actor.system.resources.mp.value >= 1) { await actor.update({'system.resources.mp.value': actor.system.resources.mp.value - 1}); ui.notifications.info('消耗1内力维持江南'); } else { await thisEffect.delete(); ui.notifications.warn('内力不足，江南失效'); }"
                    }
                ],
                "transfer": false
            }
        ]
    },
    {
        "name": "妙趣横生",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "sanshou",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>吟诗作对，挥画成风，丝竹和鸣，以棋会友，日夜沉醉于琴棋书画，方知其中乐趣。</p>",
            "requirements": "《四艺诀》修炼圆满",
            "moves": [
                {
                    "name": "妙趣横生",
                    "type": "qi",
                    "actionType": "default",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>吟诗作对，挥画成风，丝竹和鸣，以棋会友，日夜沉醉于琴棋书画，方知其中乐趣。</p>",
                    "scripts": [
                        {
                            "label": "被动加成",
                            "trigger": "passive",
                            "script": "S.arts.yanzou.checkMod += 1; S.arts.qishu.checkMod += 1; S.arts.shuxie.checkMod += 1; S.arts.zuohua.checkMod += 1;"
                        }
                    ]
                }
            ],
            "automationNote": "修为增加和购买折扣需手动处理。"
        }
    },
    {
        "name": "大雅之堂",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江南阁.png",
        "system": {
            "category": "sanshou",
            "sect": "jiangnange",
            "tier": 2,
            "description": "<p>众人皆醉我独醒，举世皆俗我独清。身处红尘不沾世俗，凡夫俗子难为知音，曲高和寡，遗世独立。</p>",
            "requirements": "《风雅颂》修炼圆满",
            "moves": [
                {
                    "name": "大雅之堂",
                    "type": "qi",
                    "actionType": "default",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0
                    },
                    "description": "<p>众人皆醉我独醒，举世皆俗我独清。身处红尘不沾世俗，凡夫俗子难为知音，曲高和寡，遗世独立。</p>",
                    "scripts": [
                        {
                            "label": "清雅与高雅",
                            "trigger": "passive",
                            "script": "const arts = ['yanzou', 'qishu', 'shuxie', 'zuohua'];\nlet count = 0;\narts.forEach(k => { if ((actor.system.arts[k]?.total || 0) >= 5) count++; });\nS.stats.shencai.mod += count * 5;"
                        },
                        {
                            "label": "高雅增伤",
                            "trigger": "calc",
                            "script": "if (['dagger', 'instrument', 'hidden'].includes(args.move.weaponType)) {\n    const bonus = Math.floor(actor.system.stats.shencai.total / 10);\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`高雅 +${bonus}`);\n}"
                        },
                        {
                            "label": "高雅命中",
                            "trigger": "attack",
                            "script": "if (['dagger', 'instrument', 'hidden'].includes(args.move.weaponType)) {\n    const bonus = Math.floor(actor.system.stats.shencai.total / 10);\n    args.flags.bonusHit += bonus;\n}"
                        }
                    ]
                }
            ]
        }
    }
]