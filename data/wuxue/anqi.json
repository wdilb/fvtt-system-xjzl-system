[
    {
        "name": "遮山镖",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>劲力极大的暗器，练得精深时让人看不出来。</p><p><strong>需求：</strong>暗器-飞镖</p><p><strong>属性：</strong>阳</p>",
            "requirements": "暗器-飞镖",
            "moves": [
                {
                    "name": "碎影连连",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "6米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>抛洒出大量暗器，遮天蔽日，其中多是无效的粉尘碎渣，造成 0.3 力量点外功伤害，击破架招使对手目盲一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破施加目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破目盲",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"blind\");\n    ui.notifications.info(`${args.target.name} 被致盲！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "泪人回首",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "6米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>从口中喷出飞镖，对目标造成 0.4 力量点外功伤害，此招无视目标的格挡值。</p><p>·你每次需要提前花费一个次要动作，含入一枚飞镖才可释放此招。</p><p>·你只能同时含入一枚飞镖。</p><p>·若飞镖抹毒，你视作服用了该种毒药。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无视格挡自动。其他手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无视格挡",
                            "trigger": "preDamage",
                            "script": "args.config.ignoreBlock = true;",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "声杀一目",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>飞出三枚飞镖，连成一线，对目标造成 0.3 力量+0.3 身法点外功伤害，命中无架招目标时，他需要进行[韧性]检定（难度 11），失败则瞎掉随机一只眼睛。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "命中无架招请求检定自动。瞎眼效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "韧性检定",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"renxing\",\n        dc: 11,\n        label: \"声杀一目-护眼\",\n        onFail: {\n             name: \"单目失明\",\n             icon: \"icons/svg/blind.svg\",\n             description: \"瞎掉随机一只眼睛(RP效果)\"\n        }\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "阴沟石",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖下作人士学习的飞石伤人套路。</p><p><strong>需求：</strong>暗器</p><p><strong>属性：</strong>阴</p>",
            "requirements": "暗器",
            "moves": [
                {
                    "name": "漫天飞射",
                    "type": "real",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>撒出数枚碎石子，投向目标周围 1 米的友方，再反弹至目标身上，对其造成 0.4 身法点外功伤害。</p><p>·每有一个友方被投中，招式伤害+5。</p><p>·友方不会因此格挡成功，也不会获得怒气。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "友方弹射伤害手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "趁其不备",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一颗石头从指尖弹出，防不胜防，对目标造成 0.3 身法点外功伤害。</p><p>·若此次攻击是本场战斗进行的第一次攻击，这次虚招对抗获得优势，并且结果+1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "首攻优势手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "飞石乱弹",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，弹出十颗石子，击中目标全身，对目标造成 0.5 身法点外功伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "静夜石出",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>出其不备，丢出暗子，对目标造成 0.6 身法点外功伤害。</p><p>若在夜晚施展，则给目标添加“目盲”，持续 3 回合。</p><p>若范围内有敌人处于半空中，可消耗反应动作释放此招，站于原地出招伤敌。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "夜晚致盲手动。半空反应手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "方圆黑白",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>棋子圆以法天，棋局方以类地，此棋之形。</p><p><strong>需求：</strong>暗器-弹丸</p><p><strong>属性：</strong>太极</p><p><strong>注：</strong>你每有 1 级[棋术]，此武学招式释放距离+1。</p>",
            "requirements": "暗器-弹丸",
            "moves": [
                {
                    "name": "忘忧清乐",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>清乐脱俗，乐以忘忧，开启架招。格挡成功后，进入“方圆”，持续一回合。</p><p><strong>方圆：</strong>获得此状态时，你选择太极、阴、柔、阳、刚五个中的一个属性，你受到该属性招式伤害时减少 10 点。</p><p>·每次新获得该状态时，回合数叠加，且可以重新选择减伤的属性。</p><p><strong>升级：</strong>格挡值+5，可额外减少 5 点，内力消耗+1。</p>",
                    "automationNote": "格挡获方圆自动。选择属性手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "方圆-选择抗性",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\nconst reduceAmount = 10 + (lvl - 1) * 5;\n\nconst element = await foundry.applications.api.DialogV2.prompt({\n    window: { title: \"方圆 - 选择减伤属性\" },\n    content: `\n    <div class=\"form-group\">\n        <label>选择属性:</label>\n        <select name=\"element\">\n            <option value=\"taiji\">太极</option>\n            <option value=\"yin\">阴</option>\n            <option value=\"yang\">阳</option>\n            <option value=\"gang\">刚</option>\n            <option value=\"rou\">柔</option>\n        </select>\n    </div>`,\n    ok: { callback: (event, button) => button.form.elements[\"element\"].value }\n});\n\nif (element) {\n    await game.xjzl.api.effects.removeEffect(actor, \"fangyuan_buff\", 999);\n    const effData = thisItem.effects.getName(\"方圆\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    effData.flags[\"xjzl-system\"].selectedElement = element;\n    effData.flags[\"xjzl-system\"].reduceAmount = reduceAmount;\n    effData.description = `受到 [${element}] 属性伤害减少 ${reduceAmount} 点。`;\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "手谈一局",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>弹出数子，与范围内每一个敌人进行一次[棋术]对抗，若敌人失败，则他被添加“黑白”三回合。</p><p><strong>黑白：</strong>他所有招式的属性对你来说视为太极。</p><p><strong>升级：</strong>该招式棋术对抗结果+2，内力消耗+2。</p>",
                    "automationNote": "自动请求对抗。胜利自动应用物品内的“黑白”特效。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求棋术对抗",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = (lvl - 1) * 2;\n\n// 读取物品自身携带的 AE 模板\nconst effectName = \"黑白\";\nconst effectRef = thisItem.effects.getName(effectName)?.toObject();\n\nif (effectRef) {\n    delete effectRef._id;\n    effectRef.origin = thisItem.uuid;\n    effectRef.duration = { rounds: 3 }; // 确保时长正确\n}\n\nawait Macros.requestContest({\n    attacker: actor,\n    defender: args.target,\n    type: 'qishu',\n    label: `手谈一局 (我方棋术应+${bonus})`,\n    outcome: {\n        win: {\n            text: '对抗胜利：应用 [黑白] (3回合)。',\n            targetEffect: effectRef || null\n        },\n        lose: { text: '对抗失败：目标识破了棋局。' }\n    }\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "坐隐红尘",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>棋局如红尘，静思破之，对目标造成 0.3 力量点外功伤害。击破架招时，将目标击倒，同时使其失去 1 点怒气。</p><p>·若自身具有“方圆”，目标额外失去 1 怒气。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破倒地/扣怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破特效",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    let rageLoss = 1;\n    const hasFangyuan = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fangyuan_buff\");\n    if (hasFangyuan) rageLoss += 1;\n    const targetRage = args.target.system.resources.rage.value;\n    if (targetRage > 0) {\n        const newRage = Math.max(0, targetRage - rageLoss);\n        await args.target.update({\"system.resources.rage.value\": newRage});\n        ui.notifications.info(`${args.target.name} 失去 ${rageLoss} 点怒气`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "烂柯一梦",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>人生苦短，万物皆空，洒出棋子对周围敌人造成 0.5 力量点外功伤害。命中无架招目标时，若敌人还具有“黑白”，使敌人陷入“缚身”“禁足”，持续三回合。</p><p><strong>升级：</strong>伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中黑白目标控制自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "烂柯控制",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const hasHeibai = args.target.effects.some(e => e.name === \"黑白\");\n    if (hasHeibai) {\n        await game.xjzl.api.effects.addEffect(args.target, \"root\");\n        await game.xjzl.api.effects.addEffect(args.target, \"fushen\");\n        ui.notifications.info(`${args.target.name} 陷入烂柯一梦！`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "方圆",
                    "icon": "icons/magic/defensive/shield-barrier-blue.webp",
                    "description": "减少特定属性伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fangyuan_buff",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "减伤",
                                    "trigger": "preTake",
                                    "active": true,
                                    "script": "const el = thisEffect.getFlag(\"xjzl-system\", \"selectedElement\");\nconst amt = thisEffect.getFlag(\"xjzl-system\", \"reduceAmount\") || 0;\nif (args.element === el) {\n    args.output.damage = Math.max(0, args.output.damage - amt);\n    ui.notifications.info(`方圆触发：减免 ${amt} 点 [${el}] 伤害`);\n}"
                                }
                            ]
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "绝影狂手",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>绝影狂手出招极快，中者往往应声便倒，难觅暗器踪影，仿佛暗器快到不见影子，故称绝影。</p><p><strong>需求：</strong>暗器</p><p><strong>属性：</strong>阴</p>",
            "requirements": "暗器",
            "moves": [
                {
                    "name": "影过留痕",
                    "type": "real",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>指尖轻弹，快速将手中暗器射出，对目标造成 0.4 身法点外功伤害。命中无架招的目标，使自身获得一层“乘风”状态，最多三层，持续到战斗脱离。</p><p><strong>乘风：</strong>每层使你移动速度+1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中获乘风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得乘风",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"chengfeng\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.flags[\"xjzl-system\"].maxStacks = 3;\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "含沙射影",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>子母双暗器，出手奇快，难分先后，造成 0.3 身法点外功伤害。若你当前的速度为目标的两倍及以上，此次虚招对抗具有优势。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "速度优势自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "速度优势",
                            "trigger": "check",
                            "script": "const mySpeed = actor.system.combat.speedTotal || 0;\nconst targetSpeed = args.target.system.combat.speedTotal || 0;\nif (targetSpeed > 0 && mySpeed >= targetSpeed * 2) {\n    args.flags.feintLevel += 1;\n    ui.notifications.info(\"速度压制：获得虚招优势\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无影无踪",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>隐藏身形，开启架招，格挡成功时，使自身获得一层“乘风”状态，持续到战斗脱离。</p><p><strong>乘风：</strong>每层使你移动速度+1。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获乘风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获乘风",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nawait game.xjzl.api.effects.addEffect(actor, \"chengfeng\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "流光分影",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>暗器快速划过阴影，如同一道道闪光，对范围内最多 3 名敌人造成 0.3 身法点外功伤害，如果你的身上存在三层“乘风”状态，此招伤害提高相当于你速度的数值，并且你可以让其中两次攻击选择同一个敌人作为目标。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "乘风加伤自动。多次攻击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "乘风加伤",
                            "trigger": "calc",
                            "script": "const chengfeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chengfeng\");\nconst stacks = chengfeng ? (chengfeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (stacks >= 3) {\n    const speed = actor.system.combat.speedTotal || 0;\n    args.output.damage += speed;\n    args.output.bonusDesc.push(`流光分影：速度加伤 +${speed}`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "水纹球",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>使用油布纸包水的球作为武器，内力蕴含其中，常人往往小看其威力。</p><p><strong>需求：</strong>暗器-弹丸</p><p><strong>属性：</strong>太极</p>",
            "requirements": "暗器-弹丸",
            "moves": [
                {
                    "name": "旋无定手",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>掌中起波纹，开启架招，格挡成功后，获得一层“螺旋”，至多十层，持续到战斗脱离。</p><p><strong>螺旋：</strong>每层使《水纹球》施放距离+1。</p><p><strong>升级：</strong>格挡值+5，额外获得一层螺旋，内力消耗+1。</p>",
                    "automationNote": "格挡获螺旋自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获螺旋",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n// 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\nconst amount = lvl;\nconst eff = thisItem.effects.getName(\"螺旋\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nfor(let i=0; i<amount; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "泼水难收",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>泼洒出球，造成 0.3 内息点内功伤害。击破架招后，为自己增加三层“螺旋”。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破获螺旋自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获螺旋",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"螺旋\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "涡卷江河",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>丢出小水球，造成 0.4 内息点内功伤害。若击中无架招敌人，为自己添加一层螺旋。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中获螺旋自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中获螺旋",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"螺旋\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "疾如旋踵",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>甩出一颗高速旋转的水球，造成 0.6 内息点内功伤害。</p><p>·你可以消耗所有螺旋，每层螺旋击飞目标 3 米，击飞过程中撞击到建筑物则停止，招式伤害提升【剩余击飞米数*1】的数值。</p><p><strong>升级：</strong>招式伤害+10，提升伤害系数+1，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "消耗螺旋提示自动。击飞/加伤手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗螺旋提示",
                            "trigger": "attack",
                            "script": "const luoxuan = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"luoxuan\");\nif (luoxuan) {\n    const stacks = luoxuan.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const coef = 1 + (lvl - 1);\n    \n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"疾如旋踵\" },\n        content: `<p>当前拥有 ${stacks} 层 [螺旋]。</p><p>消耗所有层数，每层击飞 3 米。</p><p>每 1 米未击飞距离转化为 ${coef} 点伤害。</p><p>是否消耗？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"保留\", icon: \"fas fa-times\" }\n    });\n\n    if (confirm) {\n        await luoxuan.delete();\n        const maxDist = stacks * 3;\n        const msg = `已消耗 ${stacks} 层螺旋。理论击飞 ${maxDist} 米。<br><b>请手动计算撞墙剩余距离并乘以 ${coef}，通过右键【手动应用伤害】附加数值。</b>`;\n        ChatMessage.create({content: msg, speaker: ChatMessage.getSpeaker({actor: actor})});\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "螺旋",
                    "icon": "icons/magic/water/projectile-water-ball.webp",
                    "description": "增加水纹球招式距离。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "luoxuan",
                            "stackable": true,
                            "maxStacks": 10
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "干泗镖",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>恶臭老人成名绝技，以内力飞射干泗，既恶心又恐怖。</p><p><strong>需求：</strong>暗器</p><p><strong>属性：</strong>刚</p><p><strong>注：</strong>该武学所用暗器都必须沾染你特制的“泗”。</p>",
            "requirements": "暗器",
            "moves": [
                {
                    "name": "水养四方",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>双指连弹，暗器分散射出，对周围敌人造成 0.3 内息点内功伤害，击破任意一人架招后可以使用次要动作施展一次【干涸大地】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破提示连招。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连招提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招！可消耗次要动作施展【干涸大地】\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "干涸大地",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>用手指飞射出暗器，造成 0.3 内息点内功伤害。</p><p>·若目标无架招，为其添加一层“乏力”，至多三层，持续到战斗脱离。</p><p><strong>乏力：</strong>每层使你招式伤害-10。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中施加乏力自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加乏力",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fali\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.flags[\"xjzl-system\"].maxStacks = 3;\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血如泉涌",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，原地后空翻（半空中），暗器飞射入眼，造成 0.5 内息点内功伤害，目标陷入目盲，持续三回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中施加目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "致盲",
                            "trigger": "hit",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"blind\");\nif (eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "混沌一击",
                    "type": "qi",
                    "actionType": "buff",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "全回合动作",
                    "description": "<p>抠挖揉搓，全部甩出！对目标同时施展【干涸大地】、【水养四方】、【血如泉涌】。</p><p>然后自身陷入以下状态：1 禁足、2 错骨、3 定身、4 封招、5 自闭、6 眩晕，持续到自己下个回合结束。</p><p>·投掷一个 D6，根据数字减少一个不良状态。</p><p><strong>升级：</strong>额外投掷一个 D6，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "已改为气招以便点击应用。点击后自动施加所有6种负面状态。发送卡片提示玩家：手动施展3个子招式、手动投掷D6并移除对应的状态。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "混沌一击流程",
                            "trigger": "hit",
                            "script": "const debuffs = [\n    {id: 1, slug: \"root\", name: \"禁足\"},\n    {id: 2, slug: \"cuogu\", name: \"错骨\"},\n    {id: 3, slug: \"stun\", name: \"定身\"},\n    {id: 4, slug: \"fengzhao\", name: \"封招\"},\n    {id: 5, slug: \"zibi\", name: \"自闭\"},\n    {id: 6, slug: \"xuanyun\", name: \"眩晕\"}\n];\n\n// 1. 自动应用所有负面状态\nfor (const db of debuffs) {\n    const eff = CONFIG.statusEffects.find(e => e.id === db.slug);\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n}\n\n// 2. 计算投掷数量\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst diceCount = 1 + (lvl - 1);\n\n// 3. 发送引导卡片\nconst content = `\n<div class=\"xjzl-chat-card\">\n    <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold; color:#8b0000; margin-bottom:5px; padding-bottom:2px;\">\n        <i class=\"fas fa-skull\"></i> 混沌一击 - 结算指引\n    </div>\n    <div style=\"padding:5px; font-size:0.9em;\">\n        <p style=\"margin-bottom:5px;\"><strong>第一步：</strong>请依次手动施展以下招式（不消耗额外动作）：</p>\n        <ul style=\"margin-bottom:10px;\">\n            <li>【干涸大地】</li>\n            <li>【水养四方】</li>\n            <li>【血如泉涌】</li>\n        </ul>\n        <hr style=\"border: 0; border-top: 1px dashed #ccc; margin: 5px 0;\">\n        <p style=\"margin-bottom:5px;\"><strong>第二步：</strong>你已获得全部 6 种负面状态。</p>\n        <p style=\"margin-bottom:5px;\">请手动投掷 <b>${diceCount}d6</b>。</p>\n        <p style=\"margin-bottom:5px;\">根据点数，<b>手动移除</b>对应的状态：</p>\n        <ul style=\"font-size:0.85em; color:#555; column-count: 2; margin: 0;\">\n            <li>1: 禁足</li> <li>2: 错骨</li>\n            <li>3: 定身</li> <li>4: 封招</li>\n            <li>5: 自闭</li> <li>6: 眩晕</li>\n        </ul>\n    </div>\n</div>`;\n\nChatMessage.create({\n    content: content,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "流星镖",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>快如闪电，防不胜防。</p><p><strong>需求：</strong>暗器-飞镖</p><p><strong>属性：</strong>柔</p><p><strong>注：</strong>该套路可以用特制流星镖施展，其材质特殊而昂贵，一枚一买，而不是通常的一次性 20 枚。</p>",
            "requirements": "暗器-飞镖",
            "moves": [
                {
                    "name": "碎玉榛",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>手擒星玉，开启架招。格挡成功后可立即消耗反应动作施展【星如雨】。</p><p><strong>流星镖施展：</strong>此次【星如雨】虚招值+2。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "反击提示自动。特制流星镖效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功！可施展【星如雨】\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "星如雨",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>射出一枚飞镖，虚实相生，造成 0.3 内息点内功伤害，击破架招则使目标禁足一回合。</p><p><strong>流星镖施展：</strong>招式距离+15。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一线惊",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>射出两枚飞镖，一前一后，宛如流星瞬间击出，对目标造成 2 次 0.2 内息点内功伤害，若目标无架招，使其陷入“禁足”一回合。</p><p><strong>流星镖施展：</strong>本次出招的武器伤害翻倍。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中禁足自动。两次伤害/流星镖加成手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中禁足",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "流星落",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>射出一枚飞镖，炫光夺目，造成 0.6 内息点内功伤害。若击中无架招目标，目标需进行难度 11 的[韧性]检定，失败被击碎一根手指。</p><p><strong>流星镖施展：</strong>目标的韧性检定必定失败。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "检定请求自动。流星镖必杀判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "韧性检定",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"renxing\",\n        dc: 11,\n        label: \"流星落-碎指\",\n        onFail: {\n            name: \"手指碎裂\",\n            icon: \"icons/svg/bone-broken.svg\",\n            description: \"一根手指被击碎 (RP效果)\"\n        }\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "回阳九针",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>出自《针灸聚英》，刺激九大穴位，治晕厥、肢冷脉伏，阳虚欲脱。</p><p><strong>需求：</strong>暗器-针</p><p><strong>属性：</strong>太极</p>",
            "requirements": "暗器-针",
            "moves": [
                {
                    "name": "金针取穴",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>煮针守气，开启架招。格挡成功后，为自身添加一层“回阳”，至多 3 层，持续到战斗脱离。</p><p><strong>升级：</strong>格挡值+10，叠加上限+1，内力消耗+2。</p>",
                    "automationNote": "格挡获回阳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获回阳",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"回阳\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n// 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\nconst maxStacks = 3 + (lvl - 1);\neff.flags[\"xjzl-system\"].maxStacks = maxStacks;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "通经活络",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>针耀而匀，为目标添加“活血”，持续两回合。</p><p><strong>活血：</strong>你的回合初回复 5 点气血。</p><p>·你每有一层“回阳”，提高活血 5 点气血回复。</p><p>·你每有一级[医术]，提高活血 5 点气血回复。</p><p><strong>升级：</strong>活血额外回复 10 气血，内力消耗+2。</p>",
                    "automationNote": "施加活血自动。回复量快照机制。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加活血",
                            "trigger": "hit",
                            "script": "const huiyang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huiyang\");\nconst stacks = huiyang ? (huiyang.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nconst yishu = actor.system.arts.yishu.total || 0;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst upgradeBonus = (lvl - 1) * 10;\nconst totalRegen = 5 + (stacks * 5) + (yishu * 5) + upgradeBonus;\nconst eff = thisItem.effects.getName(\"活血\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.flags[\"xjzl-system\"].regenAmount = totalRegen;\neff.description = `回合初回复 ${totalRegen} 点气血。`;\nawait game.xjzl.api.effects.addEffect(args.target, eff);\nui.notifications.info(`${args.target.name} 获得活血 (每回合 +${totalRegen})`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "金针续魂",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刺虚者实，刺实者虚，对目标造成 0.4 力量点外功伤害。命中无架招目标时，为其添加一层“失准”，至多三层，持续到战斗脱离。</p><p><strong>失准：</strong>每层使你的命中-5。</p><p>·每层“回阳”提高此招 5 点招式伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中施加失准自动。回阳加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回阳加伤",
                            "trigger": "calc",
                            "script": "const huiyang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huiyang\");\nif (huiyang) {\n    const stacks = huiyang.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 5;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`回阳加伤 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "施加失准",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"shizhun\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.flags[\"xjzl-system\"].maxStacks = 3;\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "神针绝命",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>远近如一，获得“神针”状态，持续一回合。在你下回合的回合初，你失去“神针”状态时，你可以消耗主要动作对范围内的一个目标造成 0.6 力量点外功伤害，同时击退对方 1 米。</p><p>·若目标的气血超过 50%，招式伤害提升 50 点。</p><p>·你身上每层“回阳”增加击退距离 1 米。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获得神针状态自动。神针二段伤害手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得神针",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"神针\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"已获得 [神针]，下回合初可发动绝命一击\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "回阳",
                    "icon": "icons/svg/sun.svg",
                    "description": "增强针法威力。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huiyang",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "活血",
                    "icon": "icons/svg/heal.svg",
                    "description": "回合初回复气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huoxue",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "持续回复",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "const amt = thisEffect.getFlag(\"xjzl-system\", \"regenAmount\") || 0;\nif (amt > 0) {\n    await actor.applyHealing({amount: amt, type: \"hp\", showScrolling: true});\n}"
                                }
                            ]
                        }
                    },
                    "duration": {
                        "rounds": 2
                    },
                    "changes": []
                },
                {
                    "name": "神针",
                    "icon": "icons/svg/target.svg",
                    "description": "蓄力中，下回合可发动攻击。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shenzhen",
                            "stackable": false
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "玲珑骰",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>玲珑骰子安红豆，入骨相思知不知。</p><p>流传自唐代，制作复杂，需用象牙雕刻镂空，把红豆镶嵌进去，一名侠客将其融入天九后创出此功。</p><p><strong>注：</strong>该套路可以用特制玲珑骰子施展，其材质特殊而昂贵，一枚一买，而不是通常的一次性 20 枚。</p><p><strong>需求：</strong>暗器-弹丸</p><p><strong>属性：</strong>太极</p>",
            "requirements": "暗器-弹丸",
            "moves": [
                {
                    "name": "天王盖地虎",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>掷出弹丸，对目标造成 0.5 身法点外功伤害。若拥有“庄”，可投掷一个 D6，额外对目标造成数字*10 的气血流失。</p><p><strong>玲珑骰子施展：</strong>如果出现奇数，招式还可让目标陷入下盘不稳，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "投掷D6及伤害流失自动。特殊效果需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "庄家投掷",
                            "trigger": "hit",
                            "script": "const zhuang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhuang\");\nif (zhuang && args.isHit) {\n    const r = await new Roll(\"1d6\").evaluate();\n    if (game.dice3d) game.dice3d.showForRoll(r, game.user, true);\n    const val = r.total;\n    const loss = val * 10;\n    await args.target.applyHealing({amount: -loss, type: \"hp\", showScrolling: true});\n    ui.notifications.info(`天王盖地虎：点数 ${val} -> 流失 ${loss} 气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "执位垫牌",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>上家不打，下家不垫，开启架招。施展后进入“庄”，持续到战斗脱离。</p><p><strong>庄：</strong>因【天王盖地虎】【双天双地】【至尊宝】而投掷 D6 时，可额外投掷一个 D6，任选其中一个作为结果，然后移除“庄”。</p><p><strong>玲珑骰子施展：</strong>无需移除“庄”。</p><p><strong>升级：</strong>格挡值+10，额外投掷一个 D6，消耗+2。</p>",
                    "automationNote": "开启获庄自动。庄的效果需玩家手动执行，脚本仅提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得庄",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"庄\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "文武双全",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你因《玲珑骰》而投掷多个 D6 并出现相同数字时，可消耗反应动作施展此招，骰子落地，让此次出招具有额外效果:</p><p>2 个相同:招式伤害提高 10 点。</p><p>3 个相同:招式伤害提高 15 点。</p><p>4 个相同:招式伤害提高 20 点，同时将敌人击退 1 米，并倒地。</p><p><strong>玲珑骰子施展：</strong>你可以将任意一个 D6+1 或-1，再判定有几个数字相同，来结算此招的伤害。</p><p><strong>升级：</strong>出现相同时招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "反应动作纯手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "双天双地",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>大牌在手，对目标造成 0.4 身法点外功伤害。击破架招时，若拥有“庄”，可投掷一个 D6，如果出现 6，给目标添加“禁实”一回合。</p><p><strong>玲珑骰子施展：</strong>禁实改为封招。</p><p><strong>升级：</strong>招式伤害+10。内力消耗+2。</p>",
                    "automationNote": "击破投掷自动。状态施加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破骰子",
                            "trigger": "hit",
                            "script": "const zhuang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhuang\");\nif (args.isBroken && zhuang) {\n    const r = await new Roll(\"1d6\").evaluate();\n    if (game.dice3d) game.dice3d.showForRoll(r, game.user, true);\n    if (r.total === 6) {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"jinshi\");\n        if(eff) {\n            const data = foundry.utils.deepClone(eff);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n            ui.notifications.info(\"双天双地(6点) -> 禁实\");\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "至尊宝",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>搏运一击，丁三配二四，绝配！对周围敌人造成 0.7 身法点外功伤害。</p><p>若拥有“庄”，投掷一个 D6，使招式具有以下效果：</p><p>1－2:使目标陷入禁足一回合。</p><p>3－4:招式必定暴击。</p><p>5－6:使目标失去反应动作。</p><p><strong>玲珑骰子施展：</strong>施放距离+5。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "出招前投骰子自动。效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "至尊宝骰子",
                            "trigger": "attack",
                            "script": "const zhuang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhuang\");\nif (zhuang) {\n    const r = await new Roll(\"1d6\").evaluate();\n    if (game.dice3d) game.dice3d.showForRoll(r, game.user, true);\n    const val = r.total;\n    ui.notifications.info(`至尊宝点数: ${val}`);\n    ChatMessage.create({content: `至尊宝点数: <b>${val}</b><br>1-2: 禁足<br>3-4: 必爆<br>5-6: 失去反应`, speaker: ChatMessage.getSpeaker({actor: actor})});\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "庄",
                    "icon": "icons/sundry/gaming/dice-pair-white.webp",
                    "description": "投掷D6时可双骰取优。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhuang",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "自在无想飞针",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>放空思想，无念无想，由本能催动内力操控暗器，使暗器仿佛有灵性一般，漂浮在操控者周围。</p><p><strong>需求：</strong>暗器-针</p><p><strong>属性：</strong>柔</p>",
            "requirements": "暗器-针",
            "moves": [
                {
                    "name": "无心",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>针灵寻器，开启架招。同时，内劲灌注一组暗器，使其随真气在周身盘旋，你获得 20 层“锁”，附着于每根暗器之上，持续到战斗脱离或被解除架招。</p><p><strong>锁：</strong>该暗器施展《自在无想飞针》时必定命中。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得锁",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"锁\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.flags[\"xjzl-system\"].stacks = 20;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无念",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>暗器自然而动，攻向敌手，对敌人造成伤害，命中无架招目标时，你拥有“锁”的那组暗器获得“灵”，持续三回合或解除架招。</p><p><strong>灵：</strong>该暗器的伤害提高 10 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "检测锁-必中",
                            "trigger": "attack",
                            "script": "const lock = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suo\");\nif (lock && lock.getFlag(\"xjzl-system\", \"stacks\") > 0) {\n    args.flags.forceHit = true;\n    ui.notifications.info(\"[锁] 生效：本次攻击必中\");\n}",
                            "active": true
                        },
                        {
                            "label": "获得灵",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"灵\").toObject();\n    eff.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        },
                        {
                            "label": "灵-增伤",
                            "trigger": "calc",
                            "script": "const ling = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"ling\");\nif (ling) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"灵 +10\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无想",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>盘旋于周身的暗器一齐发射，对目标造成伤害，若你开启架招时盘旋的该组暗器具有“灵”，则每射出一根，招式伤害提升一次武器伤害的数值。</p><p>·若暗器不具备“灵”，则只射出 1 根。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "必中、增伤自动。若无灵需手动调整伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "检测锁与灵",
                            "trigger": "attack",
                            "script": "const lock = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suo\");\nif (lock) {\n    args.flags.forceHit = true;\n    await lock.delete();\n    ui.notifications.info(\"[锁] 耗尽：万针如瀑！\");\n} else {\n    ui.notifications.warn(\"未检测到 [锁]，无法发射暗器流！\");\n}",
                            "active": true
                        },
                        {
                            "label": "计算爆发伤害",
                            "trigger": "calc",
                            "script": "const lock = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suo\");\nconst ling = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"ling\");\nif (lock) {\n    const stacks = lock.getFlag(\"xjzl-system\", \"stacks\") || 0;\n    if (ling) {\n        const weaponDmg = args.baseData.weapon || 0;\n        const bonus = stacks * weaponDmg;\n        args.output.damage += bonus;\n        args.output.bonusDesc.push(`灵·万针齐发 (${stacks} x ${weaponDmg})`);\n    } else {\n        args.output.bonusDesc.push(\"无灵：仅射出 1 根 (伤害可能需手动调整)\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "锁",
                    "icon": "icons/tools/fasteners/screw-flat-slotted-steel.webp",
                    "description": "施展本套路必定命中。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "suo",
                            "stackable": true,
                            "maxStacks": 20
                        }
                    },
                    "changes": []
                },
                {
                    "name": "灵",
                    "icon": "icons/magic/light/explosion-star-small-blue-yellow.webp",
                    "description": "暗器伤害提高。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "ling",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "逆龙鳞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>龙喉之下有逆鳞径尺，人有婴之，则必杀人。</p><p>此技融阳刚于静谧，安守内心，平日引而不发，若遇敌挑衅，则如龙出海，烈阳融雪，焚尽万物。</p><p><strong>需求：</strong>暗器</p><p><strong>属性：</strong>阳</p>",
            "requirements": "暗器",
            "moves": [
                {
                    "name": "潜龙隐渊",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>气息敛藏，开启架招。同时进行一次[敛息]检定，这次检定结果+6 并获得“隐渊”，持续到你解除架招。</p><p><strong>隐渊：</strong>若在场敌人没有洞察出你真正的内功等级，在你的每回合初，你获得 1 点怒气。</p><p><strong>升级：</strong>格挡值+10，敛息结果+3，内力消耗+4。</p>",
                    "automationNote": "检定、BUFF自动。若被洞察请手动移除BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "敛息与隐渊",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 6 + (lvl - 1) * 3;\nawait actor.rollAttributeTest(\"lianxi\", { bonus: bonus, flavor: \"潜龙隐渊 - 敛息检定\" });\n\nconst eff = thisItem.effects.getName(\"隐渊\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "龙战于野",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "hidden",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "无",
                    "description": "<p>当你受到内外功伤害时，不消耗动作，暴怒长啸，龙血四溅，为自身周围 1 米范围的所有敌人添加“触龙”，持续一回合或你陷入濒死。</p><p><strong>触龙：</strong>你的命中、虚招对抗具有劣势，在你的每回合初，你减少 1 点怒气。</p><p><strong>升级：</strong>距离+1，触龙持续回合数+1，内力消耗+4。</p>",
                    "automationNote": "请在受伤后手动施展。施加BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加触龙",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"触龙\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(args.target, eff);\nui.notifications.info(`${args.target.name} 沾染龙血 (触龙)`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "腾龙起势",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "20米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，身似银光，突进至目标周围空格，对其造成伤害，并为其添加“触龙”，持续三回合或你陷入濒死。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "突进手动。施加BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击-触龙",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"触龙\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "龙曜九天",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>选择一个敌人，龙鳞暗器遁空，化作银龙，盘旋高飞，在该目标的下个回合初降击裂地，对目标及其周围 5 米范围内的敌人造成伤害，并将该范围地面破坏，成为困难地形。</p><p>·若敌人没有怒气，招式必定暴击。</p><p>·若敌人具有“触龙”，将其“眩晕”一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "伤害、暴击、眩晕自动（立即结算）。困难地形手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "判定暴击与眩晕",
                            "trigger": "check",
                            "script": "if (args.target.system.resources.rage.value <= 0) {\n    args.flags.critThresholdMod = 20;\n}",
                            "active": true
                        },
                        {
                            "label": "触发眩晕",
                            "trigger": "hit",
                            "script": "const hasChulong = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chulong\");\nif (hasChulong && args.isHit) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"xuanyun\");\n    if(eff) {\n       const data = foundry.utils.deepClone(eff);\n       data.duration = { rounds: 1 };\n       await game.xjzl.api.effects.addEffect(args.target, data);\n       ui.notifications.info(`${args.target.name} 被眩晕 (因触龙)!`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "隐渊",
                    "icon": "icons/magic/nature/root-vine-thorn-fire-purple.webp",
                    "description": "若未被洞察，回合初获得怒气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinyuan",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "隐渊回怒",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\nui.notifications.info(`${actor.name} 隐渊生效：怒气 +1`);"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "触龙",
                    "icon": "icons/creatures/reptiles/dragon-horned-blue.webp",
                    "description": "命中/虚招对抗劣势。回合初减少怒气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chulong",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "触龙减怒",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "const current = actor.system.resources.rage.value;\nif (current > 0) {\n    await actor.update({\"system.resources.rage.value\": current - 1});\n    ui.notifications.info(`${actor.name} 触龙生效：怒气 -1`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.attackLevel",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "flags.xjzl-system.feintLevel",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "血滴子",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>江湖血腥暗器套路，以革为囊，内藏无数利刃，趁人不备，首级立取，极为恐怖残暴。</p><p>注：该套路必须用特制暗器血滴子施展。</p><p><strong>需求：</strong>暗器-血滴子</p><p><strong>属性：</strong>太极</p>",
            "requirements": "暗器-血滴子",
            "moves": [
                {
                    "name": "血迹斑斑",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>细刃无声，静谧飞转，开启架招。格挡成功后，给目标添加一层“血滴”，持续到脱战。</p><p><strong>血滴：</strong>受内外功伤害时每层使自己流失 10 气血。</p><p>·每累积十层血滴，还会被添加一层“失血”。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-血滴",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (!args.attacker) return;\nconst eff = thisItem.effects.getName(\"血滴\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.attacker, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血流如注",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "12米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>尖啸旋出，弧形飞剐，对目标造成伤害。击破架招时，割开目标喉部动脉，鲜血狂涌，使其流失 100 点气血，然后再为其添加三层“血滴”，持续到脱战。</p><p>·若目标已经具有“血滴”，可以移除一层，使招式虚招值+2。</p><p><strong>升级：</strong>招式伤害+10，虚招值+1，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "吞噬血滴增强",
                            "trigger": "check",
                            "script": "const bloodDrop = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nif (bloodDrop && bloodDrop.getFlag(\"xjzl-system\", \"stacks\") > 0) {\n    args.flags.grantFeint += 2;\n}",
                            "active": true
                        },
                        {
                            "label": "执行吞噬与击破",
                            "trigger": "hit",
                            "script": "const bloodDrop = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nif (bloodDrop && bloodDrop.getFlag(\"xjzl-system\", \"stacks\") > 0) {\n    await game.xjzl.api.effects.removeEffect(args.target, \"xuedi\", 1);\n    ui.notifications.info(`已吞噬 ${args.target.name} 1层血滴，虚招增强生效。`);\n}\n\nif (args.isBroken) {\n    await args.target.applyDamage({ amount: 100, type: \"liushi\", attacker: actor });\n    const eff = thisItem.effects.getName(\"血滴\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    for(let i=0; i<3; i++) {\n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    }\n    ui.notifications.info(`${args.target.name} 动脉割裂！流失100血，叠加3层血滴。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "流血浮丘",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "15米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>环身旋转，飞甩而出，对周围敌人造成伤害。</p><p>若命中造成伤害后，还使目标流失气血，则将其击倒，再为其添加一层“血滴”，持续到脱战。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "流血追击",
                            "trigger": "hit",
                            "script": "const hasBloodDrop = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nif (args.isHit && args.hpLost > 0 && hasBloodDrop) {\n    const prone = CONFIG.statusEffects.find(e => e.id === \"prone\");\n    await game.xjzl.api.effects.addEffect(args.target, prone);\n    const eff = thisItem.effects.getName(\"血滴\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 因流失不止而倒地！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "椎心泣血",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "special",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>暗刃切割，发出刺耳哀痛之声，范围内具有“血滴”的敌人，陷入“禁疗”，持续一回合，再为他们添加一层“血滴”，持续到脱战。</p><p><strong>禁疗：</strong>你无法回复气血。</p><p><strong>升级：</strong>禁疗持续回合数+1，内力消耗+8。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁疗与叠层",
                            "trigger": "hit",
                            "script": "const hasBloodDrop = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nif (hasBloodDrop) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const rounds = 1 + (lvl - 1);\n    const jinliao = CONFIG.statusEffects.find(e => e.id === \"jinliao\");\n    const jData = foundry.utils.deepClone(jinliao);\n    jData.duration = { rounds: rounds };\n    await game.xjzl.api.effects.addEffect(args.target, jData);\n    const eff = thisItem.effects.getName(\"血滴\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血肉模糊",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，压制对方虚招，刃绞其脏腑，造成伤害，若命中造成伤害后，还使目标流失气血，则为你自身回复与流失气血等额的气血。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "吸血",
                            "trigger": "hit",
                            "script": "const hasBloodDrop = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nif (args.isHit && args.hpLost > 0 && hasBloodDrop) {\n    await actor.applyHealing({ amount: args.hpLost, type: \"hp\", showScrolling: true });\n    ui.notifications.info(`${actor.name} 沐浴鲜血，回复 ${args.hpLost} 气血。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "斩颈浴血",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "25米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>手中刃囊嗡嗡巨啸，飞射而出，缠头断颈，取其性命，造成伤害，目标因此招而进行的残疾检定，结果-10（最低 1）。</p><p>·若目标具有十层“血滴”，则需要进行一次死亡检定，且每超过十层一层，该次死亡检定结果-1。</p><p>·若你以此招杀死一名敌人，你获得“血锋”，持续到战斗脱离。</p><p><strong>血锋：</strong>每当有场上敌人流失气血时，你回复等额的气血。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "残疾/死亡检定手动。击杀获BUFF自动。BUFF回血效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "死亡检定提示",
                            "trigger": "hit",
                            "script": "const bloodDrop = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuedi\");\nconst stacks = bloodDrop ? (bloodDrop.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\n\nlet msg = `<p>目标残疾检定: <b>-10</b></p>`;\n\nif (stacks >= 10) {\n    const penalty = stacks - 10;\n    msg += `<hr><p style=\"color:red; font-weight:bold;\">触发死亡检定！</p><p>修正值: <b>-${penalty}</b> (层数 ${stacks})</p>`;\n}\n\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\"><div class=\"card-content-wrapper\">${msg}</div></div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});\n\nif (args.isDead) {\n    const eff = thisItem.effects.getName(\"血锋\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "血滴",
                    "icon": "icons/magic/blood/drop-splash-red.webp",
                    "description": "受击流失气血，满10层转为失血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xuedi",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "受击流失",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "if ([\"waigong\", \"neigong\"].includes(args.type)) {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const loss = 10 * stacks;\n    await actor.applyDamage({ amount: loss, type: \"liushi\", attacker: args.attacker });\n\n    if (stacks >= 10) {\n        const bloodLoss = CONFIG.statusEffects.find(e => e.id === \"bloodloss\");\n        await game.xjzl.api.effects.addEffect(actor, bloodLoss);\n        ui.notifications.warn(`${actor.name} 血滴攻心，引发失血！`);\n    }\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "血锋",
                    "icon": "icons/weapons/swords/sword-red-skull.webp",
                    "description": "敌人流失气血时回复等额气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xuefeng",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]