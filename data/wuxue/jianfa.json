[
    {
        "name": "八卦剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>又称游身八卦连环剑，需有八卦掌基础。使用略重、剑柄较长的剑，身行如游龙、剑走似飞凤。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>太极</p><p>注：若你精通整套《八卦掌》，《八卦剑法》的招式伤害+10。</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "寒风裹衣",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>顺彼架势，出剑伺其薄弱，造成伤害，若击破架招，自身获得“八卦”，持续三回合。</p><p><strong>八卦：</strong>招式伤害+10，受到内外功伤害减免 10 点。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破获BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得八卦",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"八卦\").toObject();\n    eff.duration = { rounds: 3 };\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "青龙返首",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>行云流水，挑剑穿云，对目标造成伤害，命中无架招目标将其击飞 1 米。</p><p>·若自身具有“八卦”，当范围内有敌人处于半空中时，可以消耗反应动作跃至半空中释放，飞流直下，造成伤害并将其击倒。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击飞/击倒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasBagua = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bagua\");\n    if (hasBagua) {\n        ui.notifications.info(`[八卦]生效：若目标在空中，可将其击倒。`);\n    } else if (!args.target.system.martial.stanceActive) {\n        ui.notifications.info(`命中无架招：击飞 1 米。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白猿托桃",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>架剑平置，剑刃向上托起，开启架招。格挡成功后，若敌人在 2 米范围内，还会出剑抹敌手腕，使其流失 5 气血。</p><p>·若自身具有“八卦”，还会使对方陷入“下盘不稳”，持续一回合。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "流失气血自动。施加下盘不稳自动。距离判断需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡反击",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (!args.attacker) return;\n\n// 提示检测距离\nui.notifications.info(\"格挡成功！请检查目标是否在2米内，若是，则触发流失。\");\n\n// 流失\nawait args.attacker.applyDamage({amount: 5, type: \"liushi\", attacker: actor});\n\n// 八卦特效\nconst hasBagua = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bagua\");\nif (hasBagua) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.attacker, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "乾坤日月",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>快而不乱，静而不滞，诀满天地之间，对周围敌人造成伤害，自身获得“八卦”，持续三回合。</p><p><strong>八卦：</strong>招式伤害+10，受到内外功伤害减免 10 点。</p><p>·你每有 1 级[道法]，招式暴击骰-1。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获得BUFF自动。道法修正暴击自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "道法修正暴击",
                            "trigger": "attack",
                            "script": "const daofa = actor.system.arts.daofa.total || 0;\nif (daofa > 0) {\n    args.flags.critThresholdMod += daofa;\n}",
                            "active": true
                        },
                        {
                            "label": "获得八卦",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"八卦\").toObject();\neff.duration = { rounds: 3 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "八卦",
                    "icon": "icons/magic/symbols/yin-yang-white.webp",
                    "description": "招式伤害+10，受到内外功伤害减免 10 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bagua",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.resistances.global.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "玩火剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>“少年啊，你这是在玩火，要尿床的。”使用此剑招，必须携带火油，以燃烧剑身后挥舞。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "添油加火",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>浇油点火，开启架招。自身获得 1 层“火油”，最多 5 层，持续到战斗脱离后。</p><p><strong>升级：</strong>格挡值+5，火油再+1 层，内力消耗+1。</p>",
                    "automationNote": "获得火油自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得火油",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"火油\").toObject();\neff.origin = thisItem.uuid;\n\n// 升级增加层数\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst amount = 1 + (lvl - 1);\n\nfor(let i=0; i<amount; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}\nui.notifications.info(`获得 ${amount} 层火油`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "火烧屁股",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>攻其臀部，造成伤害。击破架招时，还可消耗一层火油“引燃”目标。</p><p><strong>引燃：</strong>你在自己的每回合初受到 10 点火焰伤害。每经过五回合，你身上的防具、包裹物品随机损毁一件/套/份。</p><p>·如果你在其他“引燃”的角色身边（距离 1 米）结束自己的回合，你也会被添加“引燃”。</p><p>·你可以花费一个主要动作扑灭身上的火焰。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破消耗火油并点燃自动。点燃伤害自动。物品损毁/传火/灭火手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "引燃",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const oil = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huoyou\");\n    if (oil) {\n        await game.xjzl.api.effects.removeEffect(actor, \"huoyou\", 1);\n        const burn = thisItem.effects.getName(\"引燃\").toObject();\n        burn.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.target, burn);\n        ui.notifications.info(`消耗火油，引燃了 ${args.target.name}！`);\n    } else {\n        ui.notifications.warn(\"没有火油，无法引燃！\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "烈火无情",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>横劈火焰之剑，造成伤害。击中无架招敌人可消耗一层火油，“引燃”目标。若击中已经被引燃的无架招目标，可直接烧毁对方随机一件品质银/铜级别的防具。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "消耗火油点燃自动。烧毁防具手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "点燃与烧毁",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const isBurning = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yinran\");\n    \n    if (isBurning) {\n        // 已点燃 -> 烧装备\n        ui.notifications.info(`[烈火无情] 击中已引燃目标！请手动处理 ${args.target.name} 防具损毁。`);\n    } else {\n        // 未点燃 -> 尝试点燃\n        const oil = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huoyou\");\n        if (oil) {\n            await game.xjzl.api.effects.removeEffect(actor, \"huoyou\", 1);\n            const burn = thisItem.effects.getName(\"引燃\").toObject();\n            burn.origin = thisItem.uuid;\n            await game.xjzl.api.effects.addEffect(args.target, burn);\n            ui.notifications.info(`消耗火油，引燃了 ${args.target.name}！`);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "大火熊熊",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>烧烧烧！转身肆意挥洒剑身火焰！对周围 3 米敌人造成伤害。</p><p>可以消耗剑身火油，每层火油提升 5 点招式伤害。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "预览时自动计算火油加成。出招时询问是否消耗全部火油。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "火油加伤预览",
                            "trigger": "calc",
                            "script": "const oil = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huoyou\");\nconst stacks = oil ? (oil.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nif (stacks > 0) {\n    const bonus = stacks * 5;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`火油加伤 +${bonus} (需消耗全部)`);\n}",
                            "active": true
                        },
                        {
                            "label": "消耗火油",
                            "trigger": "attack",
                            "script": "const oil = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huoyou\");\nif (oil) {\n    const stacks = oil.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 5;\n    \n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"大火熊熊\" },\n        content: `<p>当前有 ${stacks} 层火油，预计算伤害已包含 <b>+${bonus}</b> 加成。</p><p>是否消耗全部火油？</p>`,\n        yes: { label: \"消耗 (保留加成)\", icon: \"fas fa-fire\" },\n        no: { label: \"不消耗 (移除加成)\", icon: \"fas fa-times\" }\n    });\n\n    if (confirm) {\n        await oil.delete();\n        ui.notifications.info(`已消耗全部火油，火力全开！`);\n    } else {\n        args.flags.damageResult.damage -= bonus;\n        args.flags.damageResult.breakdown += `\\n- 未消耗火油：移除加成 (-${bonus})`;\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "火油",
                    "icon": "icons/commodities/materials/liquid-red.webp",
                    "description": "剑身燃烧火油。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huoyou",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": []
                },
                {
                    "name": "引燃",
                    "icon": "icons/magic/fire/flame-burning-skeleton-orange.webp",
                    "description": "每回合流失气血，可能损毁物品。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinran",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnStart",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "风流枯骨剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>身染邪柳的剑客遗作，剑法悲凉萧瑟。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "雨打风吹",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>看似在身前随手挥舞，实则暗藏杀机。对目标造成伤害，若击中无架招目标，则进入“风流”状态，持续一回合。</p><p><strong>风流：</strong>你对“枯骨”目标的招式伤害提升【自身神采数值】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得风流自动。风流的伤害加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得风流",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"风流\").toObject();\n    eff.duration = { rounds: 1 };\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        },
                        {
                            "label": "风流加伤",
                            "trigger": "preDamage",
                            "script": "if (args.outcome.isHit) {\n    const hasFengliu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengliu\");\n    const targetHasKugu = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\n    \n    if (hasFengliu && targetHasKugu) {\n        const bonus = actor.system.stats.shencai.total;\n        args.config.amount += bonus;\n        // 神鸦鸣古翻倍逻辑在神鸦鸣古脚本中处理\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "斜阳旧墓",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>垂剑开启架招。格挡成功给目标添加一层“枯骨”状态，持续到战斗脱离。</p><p><strong>枯骨：</strong>每层使外功防御-5，满十层时陷入禁足。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡施加枯骨自动。枯骨满层禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加枯骨",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    const eff = thisItem.effects.getName(\"枯骨\").toObject();\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, eff);\n    \n    // 检查层数应用禁足\n    const kugu = args.attacker.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\n    if (kugu && (kugu.getFlag(\"xjzl-system\", \"stacks\") || 1) >= 10) {\n        await game.xjzl.api.effects.addEffect(args.attacker, \"root\");\n        ui.notifications.info(`${args.attacker.name} 枯骨满层，陷入禁足！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "苍狼啸",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>长啸摆剑造成伤害，若击破架招，自身获得“风流”，持续三回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得风流自动。风流加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得风流",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"风流\").toObject();\n    eff.duration = { rounds: 3 };\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        },
                        {
                            "label": "风流加伤",
                            "trigger": "preDamage",
                            "script": "if (args.outcome.isHit) {\n    const hasFengliu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengliu\");\n    const targetHasKugu = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\n    \n    if (hasFengliu && targetHasKugu) {\n        const bonus = actor.system.stats.shencai.total;\n        args.config.amount += bonus;\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "烽火万里",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，长剑飞刺对手胸膛，造成伤害，自己获得“风流”状态，持续三回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得风流自动。风流加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得风流",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"风流\").toObject();\neff.duration = { rounds: 3 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "风流加伤",
                            "trigger": "preDamage",
                            "script": "if (args.outcome.isHit) {\n    const hasFengliu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengliu\");\n    const targetHasKugu = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\n    \n    if (hasFengliu && targetHasKugu) {\n        const bonus = actor.system.stats.shencai.total;\n        args.config.amount += bonus;\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "神鸦鸣古",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>对目标造成伤害，此招若触发“风流”对“枯骨”的神采伤害加成，这个加成翻倍。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "翻倍风流加伤",
                            "trigger": "preDamage",
                            "script": "if (args.outcome.isHit) {\n    const hasFengliu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengliu\");\n    const targetHasKugu = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\n    \n    if (hasFengliu && targetHasKugu) {\n        const bonus = actor.system.stats.shencai.total;\n        args.config.amount += (bonus * 2); // 原本应加1倍，这里直接加2倍覆盖掉原本逻辑？不，每个招式都写了preDamage，这里是专有脚本。\n        // 注意：其他招式的脚本不会运行在当前招式上，所以直接加2倍即可。\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "风流",
                    "icon": "icons/magic/air/wind-stream-purple.webp",
                    "description": "对“枯骨”目标伤害增加（神采值）。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fengliu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "枯骨",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "外功防御-5，满10层禁足。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "kugu",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "-5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "长河剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>全名大漠孤烟直长河落日圆剑法，由于江湖中人觉得拗口难记，逐渐改变称呼。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "征蓬出汉塞",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>身影飘忽，移动至目标身前，直刺一剑，造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "归雁入胡天",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>长剑挥前，开启架招。格挡成功后，可飞快侧移身形到目标身后（至多移 5 米）。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "大漠孤烟直",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，一剑直刺，造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无特效。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "长河落日圆",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3*3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>攻击面前 3*3 米范围内敌人，造成伤害，并给他们添加“禁足”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中施加禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加禁足",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": []
        }
    },
    {
        "name": "秋水剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>施展时隐隐闪着秋水，极为好看。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "舸舰弥津",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑横扫，开启架招。格挡成功时，荡开敌人攻击，将其击退 1 米。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "云销雨霁",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑尖轻点敌人皮肤，造成伤害，击破架招时，获得一层“聚气”，至多三层，持续到脱战。</p><p><strong>聚气：</strong>每层使你回合末回复 5 点内力。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破获聚气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得聚气",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"juqi\");\n    if(eff) {\n       const data = foundry.utils.deepClone(eff);\n       foundry.utils.setProperty(data, \"flags.xjzl-system.maxStacks\", 3);\n       await game.xjzl.api.effects.addEffect(actor, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "渔舟唱晚",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>高歌一曲，气灌全身，立即回复气血并解除自身毒药状态，进入“唱晚”一回合。</p><p><strong>唱晚：</strong>下次攻击若造成暴击，则将目标击倒。</p><p><strong>升级：</strong>回复生命值额外+2，内力消耗+1。</p>",
                    "automationNote": "治疗自动。获得唱晚自动。解毒手动。",
                    "calculation": {
                        "base": 1,
                        "growth": 2
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得唱晚",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"唱晚\").toObject();\neff.duration = { rounds: 1 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雁阵惊寒",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招，伤其手臂，造成伤害，使对手一只手陷入“惊寒”，持续三回合。</p><p><strong>惊寒：</strong>此手无法持握武器。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中施加惊寒自动。具体手部限制需手动处理（如卸下武器）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加惊寒",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"惊寒\").toObject();\neff.duration = { rounds: 3 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "落霞与孤鹜齐飞，秋水共长天一色",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>飞身跃起（半空中），对目标造成伤害，并在其脸上留下一条不可磨灭的伤口。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "无特效。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "唱晚",
                    "icon": "icons/magic/sonic/explosion-shock-wave-teal.webp",
                    "description": "下次暴击将目标击倒。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "changwan",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "惊寒",
                    "icon": "icons/svg/ice-aura.svg",
                    "description": "手臂受伤，无法持握武器。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jinghan",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "一心剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖常见，平平无奇，但天不负人，“不悔剑”一生只练一剑，练成天下第一剑，所向无敌。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "剑扫六合",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>普普通通，一剑横斩，造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            },
                            {
                                "prop": "qigan",
                                "ratio": 0.3
                            },
                            {
                                "prop": "shencai",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "鱼入浅滩",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>长剑平放，开启架招，平心静气。获得等同于最低属性等级的额外格挡值。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "开启时自动计算最低属性并增加格挡。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "最低属性格挡",
                            "trigger": "attack",
                            "script": "const stats = actor.system.stats;\nconst values = [\n    stats.liliang.total,\n    stats.shenfa.total,\n    stats.neixi.total,\n    stats.tipo.total,\n    stats.qigan.total,\n    stats.shencai.total\n];\n// 属性等级 = 数值 / 10 (向下取整)\nconst levels = values.map(v => Math.floor(v / 10));\nconst minLevel = Math.min(...levels);\n\nconst eff = thisItem.effects.getName(\"鱼入浅滩\").toObject();\neff.origin = thisItem.uuid;\neff.changes[0].value = String(minLevel);\nawait game.xjzl.api.effects.addEffect(actor, eff);\n",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "飞鸟入怀",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>单手持剑，剑气飞刺。造成伤害。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            },
                            {
                                "prop": "shencai",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "鱼入浅滩",
                    "icon": "icons/creatures/fish/fish-swimming-orange.webp",
                    "description": "基于最低属性获得额外格挡。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuruqiantan",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "白驹剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>人生天地之间，若白驹之过隙，忽然而已。此剑法飘逸飒然，招式极快，倏然而逝。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "白驹化形",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑横扫，刃光闪烁，开启架招。格挡成功后，进入“白驹”，持续一回合。</p><p><strong>白驹：</strong>你的速度+3。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获白驹",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"白驹\").toObject();\neff.duration = { rounds: 1 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白驹轻嘶",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑身震荡，甩出一道剑光，对目标造成伤害，击破架招时，使目标陷入“禁足”状态，持续三回合。</p><p>·若处于“白驹”，可使本次招式距离增加自身当前速度的数值，然后移除白驹。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破禁足自动。距离加成与移除白驹手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗白驹提示",
                            "trigger": "attack",
                            "script": "const baiju = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"baiju\");\nif (baiju) {\n    const speed = actor.system.combat.speedTotal || 0;\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"白驹轻嘶\" },\n        content: `<p>当前处于 [白驹] 状态。</p><p>是否消耗该状态使攻击距离增加 <b>${speed}米</b>？</p>`,\n        yes: { label: \"消耗 (增加距离)\" },\n        no: { label: \"保留\" }\n    });\n    if (confirm) {\n        await baiju.delete();\n        ui.notifications.info(`已消耗 [白驹]，请手动视为距离增加 ${speed} 米。`);\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "施加禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    // 需要强制持续3回合\n    const root = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"root\");\n    if (root) await root.update({ \"duration.rounds\": 3 });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白驹御风",
                    "type": "real",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>持剑扫荡周围，剑势奇快，对周围敌人造成伤害，若击中无架招的敌人，使目标陷入“目盲”状态，持续 1 回合。</p><p>·若处于“白驹”，可额外使其目盲 2 回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "目盲应用自动，时长根据白驹状态自动判断。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加目盲",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const hasBaiju = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"baiju\");\n    const duration = hasBaiju ? 3 : 1; // 1+2 = 3回合\n    \n    const eff = CONFIG.statusEffects.find(e => e.id === \"blind\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: duration };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白驹过隙",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持剑飞刺，越过敌人并到达目标身后，对其造成伤害，若你的速度大于等于 10，招式伤害+10，并回复 5 点内力值。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "移动手动。速度判定加伤自动。回内自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "速度判定",
                            "trigger": "calc",
                            "script": "if (actor.system.combat.speedTotal >= 10) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"极速加成 +10\");\n}",
                            "active": true
                        },
                        {
                            "label": "极速回内",
                            "trigger": "attack",
                            "script": "if (actor.system.combat.speedTotal >= 10) {\n    await actor.applyHealing({amount: 5, type: \"mp\", showScrolling: true});\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "白驹",
                    "icon": "icons/creatures/mammals/horse-white-running.webp",
                    "description": "速度+3。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "baiju",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "3"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "无涯双剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>生有涯，剑无涯，此剑法气力柔长，善缠斗。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "碧水依心",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>身势回旋，开启架招。格挡成功时，恢复自身 3 点内力。</p><p><strong>升级：</strong>格挡值+5，内力额外回复+1，内力消耗+1。</p>",
                    "automationNote": "格挡回内自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡回内",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 计算回复量 (基础3 + Lv-1)\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst amount = 3 + (lvl - 1);\n\nawait actor.applyHealing({amount: amount, type: \"mp\", showScrolling: true});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "荡然皆空",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑气彻空，对目标造成伤害。</p><p>若有目标处于空中，可消耗反应动作原地激发剑气对其造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "反应/空中判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "偏安一乡",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破对方虚招后，消耗反应动作压制对方虚招，剑走一线，对目标造成伤害。</p><p>·然后为其添加“荡然”，持续三回合。</p><p><strong>荡然：</strong>每次受伤后被击倒。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "施加荡然自动。击倒需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加荡然",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"荡然\").toObject();\neff.duration = { rounds: 3 };\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "海天涛怒",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>御剑产生雄浑‘无涯’气场，持续三回合。</p><p><strong>无涯：</strong>区域内友方招式伤害+5，每回合末回复 5 点内力。</p><p>·无涯以你为中心跟随你移动，你只能拥有一个无涯，如果你形成新的无涯，之前的消失。</p><p>·无涯的效果不可叠加。</p><p><strong>升级：</strong>招式范围+1，招式伤害再+5 点，持续回合数+1，怒气消耗-1。</p>",
                    "automationNote": "纯手动。请使用区域模板，并手动管理BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "rage": [
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "荡然",
                    "icon": "icons/magic/air/wind-tornado-wall-blue.webp",
                    "description": "每次受伤后被击倒。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "dangran",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "西风剑舞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>原为宫廷剑舞，舞风翩飞，长剑飞扬。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "惊鹊飞",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>飞身（视作半空中）跃至目标身前，双剑左右合并斩向敌人，造成伤害，击破架招时，可以使用次要动作施展【染鸣蝉】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。击破连招提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连招提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招：可接续 [染鸣蝉] (次要动作)\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "染鸣蝉",
                    "type": "real",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双剑刺向目标，造成伤害，同时飞身（视作半空中）向后退后两米。</p><p>·若击中无架招敌人，则可以使用次要动作施展【惊鹊飞】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。命中连招提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连招提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"命中无架招：可接续 [惊鹊飞] (次要动作)\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "星天点点",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你在一个回合内同时对一个目标施展过【惊鹊飞】接【染鸣蝉】，则可消耗反应动作释放此招，剑身如暴雨般疾刺，对目标造成伤害，同时需要进行[韧性]检定（难度 15），失败则禁足，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "检定请求自动。失败禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"renxing\",\n        dc: 15,\n        label: \"抵抗星天点点\",\n        onFail: \"root\"\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "转溪吻雪",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你在一个回合内同时对一个目标施展过【染鸣蝉】接【惊鹊飞】，则可消耗反应动作释放此招，双剑如飘絮般轻扫周身关节大穴，对目标造成伤害，同时需要进[韧性]检定（难度 15），失败则缚身，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "检定请求自动。失败缚身自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"renxing\",\n        dc: 15,\n        label: \"抵抗转溪吻雪\",\n        onFail: \"fushen\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": []
        }
    },
    {
        "name": "归去来兮剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>百年前侠士阅仙人逸事，有感而创。归去来兮剑以精湛内力，使剑脱手仍受控制，心念一动，便可召回万剑，潇洒飘逸。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "白云出岫",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>剑飞射而出，如江河赴海，势不可挡，对直线目标造成伤害。</p><p>·你手持的剑类武器视作脱手，在终点处悬浮于 2 米高的半空中，可以消耗主要动作拾取，以下用“浮空剑”代指此招式脱手的剑。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "武器脱手提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "无冀帝乡",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>盼归红尘，无望仙乡，开启架招，格挡成功时，场上每有一柄“浮空剑”，你回复 1 点内力。</p><p><strong>升级：</strong>格挡值+5，每一柄剑回复的内力+1，内力消耗+1。</p>",
                    "automationNote": "回内需手动计算。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回内提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst perSword = 1 + (lvl - 1);\nui.notifications.info(`格挡成功：请根据场上浮空剑数量手动回复内力 (每柄 ${perSword} 点)。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "归鸟入林",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>万剑归宗，使范围内你所有在半空中的剑回到你的背包，每把剑都会对路径上的所有敌人造成 0.1 内息点内功伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "剑回归手动。伤害结算需根据剑数量手动多次应用或调整数值。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.1
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "归去来兮",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>指挥浮空剑不断跃动，不断斩击目标，对目标造成伤害。</p><p>·如果你的浮空剑数量达到 5，则剑气震荡，对每一把浮空剑周围敌人造成 20 点气血流失。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "剑阵流血效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": []
        }
    },
    {
        "name": "赤心永照剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>数十年前一位极情于剑，却毫无天分的剑客，于将死之际，终于结合一生所得，创出此剑。剑法投入全身赤诚之血，以真情与敌搏命。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "丹心如血",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>以赤诚之心挥舞手中剑，对目标造成伤害。</p><p>·若你为[侠]，命中无架招的目标时，你还可以消耗最多 10 点气血，对目标造成与你消耗气血等额的气血流失。</p><p><strong>升级：</strong>招式伤害+5，可消耗最大气血+10，内力消耗+1。</p>",
                    "automationNote": "侠义判定自动。献血伤敌自动（通过弹窗交互）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "赤诚献血",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const isXia = (actor.system.social.xiayi >= 100 && actor.system.social.exing <= 50);\n    if (isXia) {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const maxCost = 10 + (lvl - 1) * 10;\n        const hp = actor.system.resources.hp.value;\n        const limit = Math.min(hp, maxCost);\n\n        const confirm = await foundry.applications.api.DialogV2.prompt({\n            window: { title: \"丹心如血\" },\n            content: `<p>你是[侠]，可消耗气血造成额外流失伤害。</p><div class=\"form-group\"><label>消耗气血 (最大 ${limit})</label><input type=\"number\" name=\"cost\" value=\"0\" min=\"0\" max=\"${limit}\"></div>`,\n            ok: {\n                label: \"献祭\",\n                callback: (event, button) => button.form.elements.cost.value\n            }\n        });\n\n        const cost = parseInt(confirm) || 0;\n        if (cost > 0) {\n            await actor.applyHealing({amount: -cost, type: \"hp\", showScrolling: true});\n            await args.target.applyDamage({amount: cost, type: \"liushi\", attacker: actor});\n            ui.notifications.info(`${actor.name} 消耗 ${cost} 气血，造成等额流失！`);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "永照汗青",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>秉持信念，奇正相生，造成伤害。若击破架招，则获得一层“赤心”状态，至多三层，持续到战斗脱离。</p><p><strong>赤心：</strong>你流失气血时，每层使你回复 5 点气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得赤心自动。赤心效果需手动（因为流失目前不触发特定钩子，或需GM判定）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得赤心",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"赤心\").toObject();\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "行剑如龙",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑影如龙，开启架招。被击破架招后，获得一层“养血”，至多三层，持续到战斗脱离。</p><p>·若被击破的同时陷入濒死，则额外添加一层。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "击破获养血自动。濒死额外层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获益",
                            "trigger": "damaged",
                            "script": "if (args.isBroken) {\n    // 击破时获得养血\n    const eff = CONFIG.statusEffects.find(e => e.id === \"yangxue\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        foundry.utils.setProperty(data, \"flags.xjzl-system.maxStacks\", 3);\n        await game.xjzl.api.effects.addEffect(actor, data);\n\n        // 濒死额外加一层\n        if (args.isDying) {\n            await game.xjzl.api.effects.addEffect(actor, data);\n            ui.notifications.info(\"濒死被破架，额外获得一层 [养血]\");\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "丹漆随梦",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>精气神合一，笔直刺出一剑，对目标造成伤害。</p><p>·若你为[侠]，给予目标【本场战斗中自身流失气血的次数*5】的气血流失。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "流失次数统计需手动。伤害应用手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "赤心",
                    "icon": "icons/magic/life/heart-glowing-red.webp",
                    "description": "流失气血时，每层回复 5 点气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chixin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "残剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>据传为上古邪剑法残谱，每出一式邪气便强上一分。幸而其残破后，剑法必须依剑谱施展，灵性尽失，不然恐为祸苍生。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>刚</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "魔高一尺",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑多一寸，更恶一分，对目标造成伤害，若击破架招，则获得一层“邪气”状态，持续到战斗脱离。</p><p><strong>邪气：</strong>招式伤害+5，如果回合结束时，本回合“邪气”的层数并没有增加，则所有邪气的层数消除。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得邪气自动。邪气维护（未增加则消除）需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得邪气",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"邪气\").toObject();\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "残月断",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑出如残月，却不用尽，对目标造成伤害。若命中无架招目标，则获得一层“邪气”，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "获得邪气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得邪气",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"邪气\").toObject();\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "风波恶",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>残招不断，如暴风雨一般压制敌人，对目标造成伤害。获得一层“邪气”，若你的“邪气”大于五层，则击飞目标 3 米。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "获得邪气自动。层数判定击飞自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得邪气与击飞",
                            "trigger": "hit",
                            "script": "// 1. 获得邪气\nconst eff = thisItem.effects.getName(\"邪气\").toObject();\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\n\n// 2. 判定层数\n// 注意：因为刚刚加了一层，现在的层数应该是加之前的+1\nconst xieqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xieqi\");\nconst stacks = xieqi ? (xieqi.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (stacks > 5) {\n    ui.notifications.info(`${actor.name} 邪气凛然 (${stacks}层)，将 ${args.target.name} 击飞 3 米！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "邪气",
                    "icon": "icons/magic/symbols/runes-star-pentagon-orange.webp",
                    "description": "招式伤害+5 (每回合需增加否则消失)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xieqi",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "后土剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>剑走阴阳，暗含死生之谜。其中精要需遍尝生离死别之味，超脱其中，应天地自然之理，方能领悟。</p><p>注：此武功前三招为人级，最后一招为地级。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "梅葬幽骨",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刺出梅花朵朵，生机盎然，杀机暗藏。造成伤害。击破架招时，为其添加“未知生”，持续一回合。</p><p><strong>未知生：</strong>目标每次回复气血时，回复量-10。</p><p><strong>升级：</strong>伤害+5，未知生持续回合数+1，消耗+1。</p>",
                    "automationNote": "击破施加状态自动。扣除回复量需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-未知生",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const rounds = 1 + (lvl - 1);\n    const effData = {\n        name: \"未知生\",\n        icon: \"icons/magic/life/cross-worn-green.webp\",\n        description: \"每次回复气血时，回复量-10。\",\n        duration: { rounds: rounds },\n        flags: { \"xjzl-system\": { slug: \"weizhisheng\", stackable: false } }\n    };\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n    ui.notifications.info(`${args.target.name} 陷入 [未知生]！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "死生同归",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>阴阳二气缠绕剑锋，死生相合，变化无穷，点向目标心口，造成伤害。若命中无架招目标，可以选择将伤害减少一半（扣除对方防御前），并为自己回复 10 点气血。</p><p><strong>升级:</strong>招式伤害+5，回复+10 点，内力消耗+1。</p>",
                    "automationNote": "命中无架招目标时弹窗询问。选择回血则自动减伤并回复。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "死生抉择",
                            "trigger": "preDamage",
                            "script": "if (args.outcome.isHit && !args.target.system.martial.stanceActive && !args.isManual) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const healVal = 10 + (lvl - 1) * 10;\n    \n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"死生同归\" },\n        content: `<p>命中无架招目标！</p><p>是否<b>伤害减半</b>并<b>回复 ${healVal} 点气血</b>？</p>`,\n        yes: { label: \"吸取生机\", icon: \"fas fa-heart\" },\n        no: { label: \"全力输出\", icon: \"fas fa-skull\" }\n    });\n    \n    if (confirm) {\n        // 伤害减半\n        args.config.amount = Math.floor(args.config.amount / 2);\n        // 执行回血\n        await actor.applyHealing({ amount: healVal, type: \"hp\", showScrolling: true });\n        ui.notifications.info(\"已发动死生同归：伤害减半，汲取生机。\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "地老天荒",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑相抵，扪心叩问，开启架招。格挡成功后，为目标添加“焉知死”，持续一回合。</p><p><strong>焉知死：</strong>目标每次受伤时，额外流失 10 点气血。</p><p><strong>升级:</strong>格挡值+5，持续回合数+1，内力消耗+1。</p>",
                    "automationNote": "格挡施加状态自动。状态效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-焉知死",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst effData = {\n    name: \"焉知死\",\n    icon: \"icons/magic/death/skull-energy-light-purple.webp\",\n    description: \"每次受伤时，额外流失 10 点气血。\",\n    duration: { rounds: rounds },\n    flags: { \n        \"xjzl-system\": { \n            slug: \"yanzhisi\", \n            stackable: false,\n            scripts: [{\n                label: \"额外流失\",\n                trigger: \"damaged\",\n                script: \"if(args.finalDamage > 0) { await actor.applyHealing({amount: -10, type:'hp', showScrolling:true}); ui.notifications.info('焉知死：额外流失 10 点气血'); }\",\n                active: true\n            }]\n        } \n    }\n};\n\nif (args.attacker) {\n    await game.xjzl.api.effects.addEffect(args.attacker, effData);\n    ui.notifications.info(`${args.attacker.name} 沾染 [焉知死]！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "往生轮回",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "tier": 2,
                    "description": "<p>抛却生死，无欲无求，一剑斩出，轮回不绝，对目标造成伤害。</p><p>若目标身上同时存在“未知生”和“焉知死”，则进行一次气感检定（难度 11），失败则堕入万世轮回，陷入“自闭”一回合。</p><p><strong>升级:</strong>招式伤害+20，检定难度+3，怒气-1，内力消耗+4。</p>",
                    "automationNote": "命中时检测双状态并请求检定。自闭状态由检定失败回调施加。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "轮回判定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasWei = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"weizhisheng\");\n    const hasYan = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yanzhisi\");\n    \n    if (hasWei && hasYan) {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const dc = 11 + (lvl - 1) * 3;\n        \n        await Macros.requestSave({\n            target: args.target,\n            attacker: actor,\n            type: \"qigan\",\n            dc: dc,\n            label: \"抵抗往生轮回\",\n            onFail: {\n                name: \"自闭\",\n                img: \"icons/svg/sleep.svg\",\n                changes: [],\n                flags: { \"xjzl-system\": { slug: \"zibi\" } },\n                duration: { rounds: 1 }\n            }\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "风雪剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>姑苏神秘女子仰慕他人而不可得，最终心如死水，冷若冰霜，悟得此剑法，寒意凛然。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "风雪交加",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>一剑既出，风雪枯萎，剑锋所指之处瞬间凝结。对周围敌人造成伤害，并为其添加一层“寒霜”，至多三层，持续到脱战。</p><p><strong>寒霜：</strong>每层使你受阴属性招式攻击时额外受到 10 伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中施加寒霜自动。寒霜增伤效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加寒霜",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = thisItem.effects.getName(\"寒霜\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "冰花冷月",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>吹雪似花，风起踏云，对目标造成伤害，击破架招时，使其陷入“禁足”，持续两回合。</p><p>·你攻击未结婚的对象时，虚招值+2。</p><p><strong>升级：</strong>招式伤害+10，虚招值+1，内力消耗+2。</p>",
                    "automationNote": "击破禁足自动。结婚判断手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被冰封禁足！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雪月寒衣",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>周身凝结薄霜，瞬间呈现湛蓝，开启架招。格挡成功后，为攻击者添加一层“寒霜”，持续到脱战。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡反弹寒霜自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-寒霜",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    const effData = thisItem.effects.getName(\"寒霜\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, effData);\n    ui.notifications.info(`${args.attacker.name} 触碰寒衣，染上寒霜！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "傲雪枯霜",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>剑气纵横，霜气凛冽，对周围敌人造成伤害，并给目标添加“禁足”，持续一回合。</p><p>·如果目标身上具有三层“寒霜”，则同时陷入“封招”，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "禁足自动。三层寒霜检测封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "傲雪特效",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    // 1. 必加禁足\n    const rootEff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if (rootEff) {\n        const data = foundry.utils.deepClone(rootEff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n    \n    // 2. 检测三层寒霜 -> 封招\n    const frost = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"hanshuang\");\n    const stacks = frost ? (frost.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n    \n    if (stacks >= 3) {\n        const fengzhao = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n        if (fengzhao) {\n            const data = foundry.utils.deepClone(fengzhao);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n            ui.notifications.info(`${args.target.name} 寒毒攻心，被封招！`);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "寒霜",
                    "icon": "icons/magic/water/snowflake-ice-blue.webp",
                    "description": "受阴属性伤害+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "hanshuang",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "寒霜增伤",
                                    "trigger": "preTake",
                                    "script": "if (args.element === \"yin\") {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    args.output.damage += (10 * stacks);\n    // UI提示\n    if (!args.config.isManual) ui.notifications.info(`寒霜生效：阴伤害 +${10*stacks}`);\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "无名剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>此为一不知名的前辈高人将毕生所学融会贯通后创出的一套剑法，剑招刻在一偏僻石壁之上。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "日薄西山",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一剑甩出、气劲伤敌，造成伤害，招式伤害提升【自身最大气血 10%】的数值。（至多提升 30）</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "气血加成自动计算。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气血加成",
                            "trigger": "calc",
                            "script": "const maxHP = actor.system.resources.hp.max || 0;\nconst bonus = Math.min(Math.floor(maxHP * 0.1), 30);\nargs.output.damage += bonus;\nargs.output.bonusDesc.push(`气血加成 +${bonus}`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "重若泰山",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>马步架打，两臂交叉，开启架招，同时进入“重若泰山”一回合。</p><p><strong>重若泰山：</strong>【日薄西山】可以消耗反应动作当做反击招式释放。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启架招获得BUFF自动。反击用法手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获得泰山",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"重若泰山\").toObject();\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "轻如鸿毛",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>身体舒展，进入“轻如鸿毛”一回合。</p><p><strong>轻如鸿毛：</strong>【日薄西山】可以当作虚招来使用，且虚招对抗检定+1。</p><p><strong>升级：</strong>对抗检定再+1，内力消耗+4。</p>",
                    "automationNote": "获得BUFF自动。虚招用法/检定加值手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            1,
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获得鸿毛",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 1 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"轻如鸿毛\").toObject();\neff.duration = { rounds: 1 };\n// 写入描述提示玩家\neff.description += ` (虚招检定+${bonus})`;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "英雄迟暮",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>豪气微叹，获得一层“迟暮”，此后每个回合末或受伤或施展【日薄西山】时，你再获得一层“迟暮”，最多十层，战斗脱离后消失。</p><p>每层“迟暮”增加【日薄西山】释放距离 1 米。</p><p>五层“迟暮”后【日薄西山】伤害再提高 10 点。</p><p>十层“迟暮”后自身的虚招对抗检定结果+5。</p><p><strong>升级：</strong>五层时【日薄西山】的招式伤害再提高 5 点，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获层自动。日薄西山加成自动。虚招对抗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            5,
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得迟暮",
                            "trigger": "hit",
                            "script": "const effData = thisItem.effects.getName(\"迟暮\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 注入日薄西山升级带来的额外伤害变量 (lv)\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst extraDmg = 10 + (lvl - 1) * 5;\neffData.flags[\"xjzl-system\"].chimuExtraDmg = extraDmg;\n\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "重若泰山",
                    "icon": "icons/magic/earth/barrier-stone-blue.webp",
                    "description": "【日薄西山】可作反击。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhongruotaishan",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "轻如鸿毛",
                    "icon": "icons/magic/air/wind-stream-white.webp",
                    "description": "【日薄西山】可作虚招，检定加值。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingruhongmao",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "迟暮",
                    "icon": "icons/magic/time/hourglass-tilted-gray.webp",
                    "description": "每层增加日薄西山距离。5层加伤。10层加虚招对抗。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chimu",
                            "stackable": true,
                            "maxStacks": 10,
                            "scripts": [
                                {
                                    "label": "回合末/受伤获层",
                                    "trigger": "turnEnd",
                                    "script": "const effData = thisEffect.toObject();\nawait game.xjzl.api.effects.addEffect(actor, effData);\nui.notifications.info(\"英雄迟暮：岁月催人老 (层数+1)\");",
                                    "active": true
                                },
                                {
                                    "label": "受伤获层",
                                    "trigger": "damaged",
                                    "script": "if (args.finalDamage > 0) {\n    const effData = thisEffect.toObject();\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                                    "active": true
                                },
                                {
                                    "label": "施展日薄西山获层",
                                    "trigger": "attack",
                                    "script": "if (args.move.name === \"日薄西山\") {\n    const effData = thisEffect.toObject();\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                                    "active": true
                                },
                                {
                                    "label": "增强日薄西山",
                                    "trigger": "calc",
                                    "script": "if (args.move.name === \"日薄西山\") {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const extraDmg = thisEffect.getFlag(\"xjzl-system\", \"chimuExtraDmg\") || 10;\n    \n    // 距离增加提示 (无法直接改range属性，只改描述)\n    args.output.bonusDesc.push(`迟暮：距离 +${stacks} 米`);\n    \n    if (stacks >= 5) {\n        args.output.damage += extraDmg;\n        args.output.bonusDesc.push(`迟暮(5层)：伤害 +${extraDmg}`);\n    }\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "渔洋剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>歌曰“犹意左右用如一，双手独运捷于电”，渔洋剑老以双手持剑打遍一众年轻高手，剑势迅捷，破招让人无法反应。</p><p><strong>类型：</strong>剑-双手剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "前剑势",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>长剑如臂，身形如风，开启架招。被击破架招时，获得一层“剑势”，至多三层，持续到脱战或更换其他武器的武学套路。</p><p><strong>剑势：</strong>每层使剑法命中+10。</p><p><strong>升级：</strong>格挡值+10，额外获得一层剑势，消耗+2。</p>",
                    "automationNote": "被击破获剑势手动。命中加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "隐剑势",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑匿身前，狡隐而出，对目标造成伤害。击破架招时，为目标添加“禁绝”，持续一回合。</p><p><strong>禁绝：</strong>无法施展绝招。</p><p>·你每消耗一层“剑势”，禁绝持续回合数+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加禁绝自动。消耗剑势延长时间需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-禁绝",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const jinjue = CONFIG.statusEffects.find(e => e.id === \"jinjue\");\n    if (jinjue) {\n        const data = foundry.utils.deepClone(jinjue);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(\"目标被禁绝。可手动消耗剑势增加持续时间。\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "三门势",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑开三门，左龙右虎中曰蛇，对目标造成伤害。然后获得以下三个状态中的一个，持续一回合，三种状态不可共存：</p><p><strong>虎剑：</strong>当有敌人处于半空时，可以消耗反应动作，虎扑一跃，至半空中接剑施展【三门势】伤敌。</p><p><strong>龙剑：</strong>每次施展《渔洋剑诀》后，如龙折身，可不消耗速度朝任意方向移动 2 米。</p><p><strong>蛇剑：</strong>银蛇出动，杀前锋手，招式暴击骰-2。</p><p><strong>升级：</strong>招式伤害+10，状态持续回合+1，消耗+2。</p>",
                    "automationNote": "命中后弹窗选择状态。特殊效果手动。蛇剑暴击减值自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "选择架势",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst choice = await foundry.applications.api.DialogV2.wait({\n    window: { title: \"三门势\" },\n    content: \"<p>请选择一种架势：</p>\",\n    buttons: [\n        { action: \"tiger\", label: \"虎剑 (追击半空)\", icon: \"fas fa-paw\" },\n        { action: \"dragon\", label: \"龙剑 (移动)\", icon: \"fas fa-dragon\" },\n        { action: \"snake\", label: \"蛇剑 (暴击)\", icon: \"fas fa-staff-snake\" }\n    ]\n});\n\nif (choice) {\n    // 清除互斥\n    await game.xjzl.api.effects.removeEffect(actor, \"hujian\");\n    await game.xjzl.api.effects.removeEffect(actor, \"longjian\");\n    await game.xjzl.api.effects.removeEffect(actor, \"shejian\");\n\n    let effName = \"\";\n    if (choice === \"tiger\") effName = \"虎剑\";\n    else if (choice === \"dragon\") effName = \"龙剑\";\n    else effName = \"蛇剑\";\n\n    const effData = thisItem.effects.getName(effName).toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    effData.duration = { rounds: rounds };\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "奇正势",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>反转长剑，虚实相反，挥舞四方，对周围敌人造成伤害。若对方无架招，招式不会暴击。</p><p>·若对方格挡成功，可消耗三层“剑势”，不消耗动作对其施展【隐剑势】。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "无架招不暴击自动。格挡后追击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招不暴击",
                            "trigger": "preDamage",
                            "script": "if (!args.target.system.martial.stanceActive) {\n    args.config.applyCritDamage = false;\n    args.config.isCrit = false; // 强制不暴击\n    if (!args.isManual) ui.notifications.info(\"奇正势：目标无架招，无法暴击\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "剑势",
                    "icon": "icons/skills/melee/sword-damascus-pink.webp",
                    "description": "每层剑法命中+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianshi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "虎剑",
                    "icon": "icons/creatures/mammals/cat-blue.webp",
                    "description": "追击半空敌人。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "hujian",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "龙剑",
                    "icon": "icons/creatures/reptiles/dragon-horned-blue.webp",
                    "description": "施展招式后移动。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "longjian",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "蛇剑",
                    "icon": "icons/creatures/reptiles/snake-cobra-purple.webp",
                    "description": "暴击骰-2。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shejian",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-2"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-2"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "七星剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>上合日月星辰，下应土地山川，变幻莫测，剑如游龙。然剑法锐气太甚，伤人亦要伤己。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>刚</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "禄存解厄",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>禄存守财，解厄化灾，开启架招，格挡成功时，获得一层“北斗七星”，至多七层，持续到战斗脱离。</p><p><strong>北斗七星：</strong>造成伤害后，你每有 1 层北斗七星，星辰之力侵袭，使目标流失 10 点气血。</p><p>·该架招持续期间时，每次被敌人添加地级及以下状态的时候，都会自动消耗 3 层“北斗七星”和一个反应动作（若你有），移除这个状态。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获层自动。攻击附带流失自动。解厄移除状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获星",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst effData = thisItem.effects.getName(\"北斗七星\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "左辅右弼",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>左辅右弼，方成大业，对目标造成两次伤害（只需一次命中检定）。此招式每次攻击都会强制消耗 1 层“北斗七星”，若“北斗七星”状态不足，则会使自己进入点穴状态（冲穴难度 14）。</p><p>·若对方无架招，则不消耗“北斗七星”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "连击手动。消耗/惩罚检测自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗判定",
                            "trigger": "attack",
                            "script": "const target = args.targets[0];\nif (target) {\n    const targetActor = target.actor || target;\n    if (targetActor.system.martial.stanceActive) {\n        // 需消耗\n        const star = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beidouqixing\");\n        if (star) {\n            await game.xjzl.api.effects.removeEffect(actor, \"beidouqixing\", 1);\n            ui.notifications.info(\"消耗 1 层北斗七星\");\n        } else {\n            // 不足\n            const dianxue = CONFIG.statusEffects.find(e => e.id === \"dianxue\");\n            if(dianxue) {\n                await game.xjzl.api.effects.addEffect(actor, dianxue);\n                ui.notifications.warn(\"星力不足，自身受制（点穴）！\");\n            }\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "廉贞难辨",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>廉贞多变，剑路难猜，对目标造成伤害。若击破架招，自身获得一层“北斗七星”状态，持续到战斗脱离，</p><p>·若招式被对方反击压制，结算伤害后，自身流失 30 点气血，并获得 3 层“北斗七星”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获星自动。被反击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获星",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effData = thisItem.effects.getName(\"北斗七星\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "七星指路",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>七星下凡，剑指敌手，对目标造成伤害，同时消耗所有“北斗七星”，每消耗一层，招式伤害+10。</p><p>·若消耗“北斗七星”层数为七，则击倒对方，且对其释放【左辅右弼】，若消耗的“北斗七星”层数小于七，则使自己进入目盲状态，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "消耗增伤自动。7层特效(击倒/连击)手动。不足7层致盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "爆发",
                            "trigger": "attack",
                            "script": "const star = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beidouqixing\");\nconst stacks = star ? (star.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\n// 增伤\nconst bonus = stacks * 10;\nargs.flags.damageResult.damage += bonus;\nargs.flags.damageResult.breakdown += `\\n+ 七星爆发(${stacks}层): ${bonus}`;\n\n// 消耗\nif (star) await star.delete();\n\n// 副作用\nif (stacks < 7) {\n    const blind = CONFIG.statusEffects.find(e => e.id === \"blind\");\n    if (blind) {\n        const data = foundry.utils.deepClone(blind);\n        data.duration = { rounds: 1 };\n        // 这里使用宏/API稍后添加，因为attack是异步的\n        await game.xjzl.api.effects.addEffect(actor, data);\n        ui.notifications.warn(\"星力未满，反噬目盲！\");\n    }\n} else {\n    ui.notifications.info(\"七星聚首！请手动击倒目标并施展 [左辅右弼]\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "北斗七星",
                    "icon": "icons/magic/light/explosion-star-glow-yellow.webp",
                    "description": "造成伤害附带流失。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "beidouqixing",
                            "stackable": true,
                            "maxStacks": 7,
                            "scripts": [
                                {
                                    "label": "附带流失",
                                    "trigger": "hit",
                                    "script": "if (args.type === \"attack\" && args.isHit) {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const loss = 10 * stacks;\n    // 直接扣血 (流失)\n    await args.target.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n    ui.notifications.info(`星辰之力：目标流失 ${loss} 气血`);\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "太乙玄门剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>太乙门独有剑法，快慢相兼，刚柔相含，练习时要求剑随身走，以身带剑，神形之中要做到形与意合，意与气合，气与神合。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "寒梅吐玉",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑尖轻点，剑芒如玉，对敌人造成伤害。击中无架招的敌人时，给予对方一层“气虚”，至多三层，持续到战斗脱离。</p><p><strong>气虚：</strong>每层使你回合末流失 5 点内力。</p><p>·当你在不是自己的回合移动超过 3 米时，你可以消耗反应动作释放此招。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无架招施加气虚自动。反应施展手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加气虚",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"qixu\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "燕子斜飞",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>斜刺一剑，虚不受劲，对目标造成伤害。若击破架招，则给予对方“进退”状态，持续两回合。</p><p><strong>进退：</strong>每当你消耗移动速度移动 2 米，状态施加者便可不消耗速度地移动 1 米。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加进退自动。进退移动效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-进退",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effData = {\n        name: \"进退\",\n        icon: \"icons/skills/movement/feet-winged-boots-brown.webp\",\n        description: \"移动被偷取。\",\n        duration: { rounds: 2 },\n        flags: { \"xjzl-system\": { slug: \"jintui\", stackable: false } }\n    };\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "中盘云剑",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>运剑于顶旋转，开启架招，格挡成功时，借力踏步，可以不消耗速度地移动 1 米。</p><p>·当你在不是自己的回合移动超过 5 米时，你获得一层“玄门”，持续到战斗脱离。</p><p><strong>玄门：</strong>每层使你下一次【天罡指路】怒气消耗-1。</p><p><strong>升级:</strong>格挡值+10，内力消耗+2，移动距离+1。</p>",
                    "automationNote": "格挡移动手动。获层手动。玄门减耗自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "天罡指路",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>使剑刺向敌人的穴道，对目标造成伤害，若命中无架招目标，还可将其点穴（冲穴难度 10）。</p><p><strong>升级:</strong>招式伤害+10，冲穴难度+2，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "玄门减耗自动。无架招点穴自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "玄门减耗",
                            "trigger": "attack",
                            "script": "const xuanmen = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuanmen\");\nif (xuanmen) {\n    const stacks = xuanmen.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const refund = Math.min(stacks, args.move.currentCost.rage);\n    if (refund > 0) {\n        await actor.update({ \"system.resources.rage.value\": actor.system.resources.rage.value + refund });\n        ui.notifications.info(`玄门生效：返还 ${refund} 怒气`);\n    }\n    await xuanmen.delete(); \n}",
                            "active": true
                        },
                        {
                            "label": "点穴",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dc = 10 + (lvl - 1) * 2;\n    \n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"neixi\", \n        dc: dc,\n        label: \"冲穴判定\",\n        onFail: \"dianxue\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "落雨剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>一位平凡画师，观两位绝世高手一次雨中剑斗有感，将二人身形绘入大雨当中，历经一年，终于完成此画，画成三日之后，画师力竭含笑而亡。江湖侠客偶然发现，此画中竟蕴含一套高深剑法。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>以招式为准</p><p>注：此剑法施展时需以水溅湿剑身，江湖侠客以酒养剑，邪派人士则多御血对敌。</p><p>·你每次出招都必须消耗一壶美酒或 10 气血。</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "凄风冷雨",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>持剑横扫，甩出片状剑雨，对周围敌人造成伤害。击破任意一人架招后，你获得“听雨”状态，持续到战斗脱离。</p><p><strong>听雨：</strong>施展剑法招式命中+10。</p><p>·你可以移除听雨，然后不消耗动作和内力直接施展【清秋画雨】，但还是需要消耗美酒或气血。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "消耗酒/血手动。击破获BUFF自动。连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获听雨",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effData = {\n        name: \"听雨\",\n        icon: \"icons/magic/water/rain-cloud-blue.webp\",\n        description: \"剑法命中+10\",\n        flags: { \"xjzl-system\": { slug: \"tingyu\", stackable: false } },\n        changes: [{ key: \"system.combat.hit_waigong\", mode: 2, value: \"10\" }, { key: \"system.combat.hit_neigong\", mode: 2, value: \"10\" }]\n    };\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "清秋画雨",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>旋剑劈斩，斩出线状剑雨。对目标造成伤害。若击中的角色在这场战斗中没有被《落雨剑法》招式命中过，你获得“画雨”状态，持续到战斗脱离。</p><p><strong>画雨：</strong>施展剑法招式暴击骰-1。</p><p>·你可以移除画雨，然后不消耗动作和内力直接施展【连天碧雨】，但还是需要消耗美酒或气血。</p><p><strong>升级：</strong>招式伤害+10，画雨暴击骰再-1，消耗+2。</p>",
                    "automationNote": "消耗酒/血手动。首中检测手动。连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得画雨",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const critBonus = -1 - (lvl - 1);\n    const effData = {\n        name: \"画雨\",\n        icon: \"icons/magic/nature/leaves-orange.webp\",\n        description: `暴击骰 ${critBonus}`,\n        flags: { \"xjzl-system\": { slug: \"huayu\", stackable: false } },\n        changes: [{ key: \"system.combat.crit_waigong\", mode: 2, value: String(critBonus) }, { key: \"system.combat.crit_neigong\", mode: 2, value: String(critBonus) }]\n    };\n    // 提示玩家确认是否首中\n    ui.notifications.info(\"若此为首中该目标，请手动应用 [画雨] 状态。\");\n    // 也可以直接给，反正玩家会删\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "连天碧雨",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>以剑刺击，剑雨如弓击射而出。对一个敌人造成伤害。若击中的角色上回合未消耗过移动速度，你获得“落雨”状态，持续到战斗脱离。</p><p><strong>落雨：</strong>施展剑法不再消耗美酒或气血。</p><p>·你可以移除落雨，然后不消耗动作和内力直接施展【凄风冷雨】，但还是需要消耗美酒或气血。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "消耗酒/血手动。移动检测手动。获BUFF自动。连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得落雨",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = {\n        name: \"落雨\",\n        icon: \"icons/magic/water/bubbles-air-water-blue.webp\",\n        description: \"剑法免酒/血\",\n        flags: { \"xjzl-system\": { slug: \"luoyu\", stackable: false } }\n    };\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "疾雷剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>极难练的剑法，每招之出，皆如闪电横空，令人一见之下，惊心动魄，先自生了怯意。</p><p><strong>类型：</strong>剑-单剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "目光如电",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑身折射出耀眼光芒，开启架招。进入“迅闪”状态持续到战斗脱离或解除架招。</p><p><strong>迅闪：</strong>速度+1，在此期间格挡成功时，爆发光芒，使对方陷入“目盲”状态一回合。</p><p><strong>升级：</strong>格挡值+10，迅闪速度+1，内力消耗+2。</p>",
                    "automationNote": "开启获迅闪自动。格挡反击目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启迅闪",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst spd = 1 + (lvl - 1);\nconst effData = {\n    name: \"迅闪\",\n    icon: \"icons/magic/lightning/bolt-strike-blue.webp\",\n    description: `速度 +${spd}`,\n    flags: { \n        \"xjzl-system\": { \n            slug: \"xunshan\", \n            stackable: false,\n            scripts: [{\n                label: \"格挡目盲\",\n                trigger: \"damaged\",\n                script: \"if(Macros.checkStance(actor, args) && args.attacker) { const blind = CONFIG.statusEffects.find(e=>e.id==='blind'); if(blind) { const bd = foundry.utils.deepClone(blind); bd.duration={rounds:1}; await game.xjzl.api.effects.addEffect(args.attacker, bd); ui.notifications.info(`${args.attacker.name} 被强光致盲！`); } }\",\n                active: true\n            }]\n        } \n    },\n    changes: [{ key: \"system.combat.speed\", mode: 2, value: String(spd) }]\n};\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "惊蛰",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>长剑破空如春雷炸响，对目标造成伤害。击破架招时，选择目标身上的一个状态并将它移除；</p><p>若范围内有敌人处于半空中，此招可消耗反应动作释放，飞至半空突刺，造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破移除状态需手动。追击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "电闪雷鸣",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>剑尖电弧乱闪，对自身周围 2 米内目标造成伤害；</p><p>若目标处于“目盲”状态，则肝胆俱裂，被此招命中时必定暴击。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "对目盲目标必暴击自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "目盲必暴",
                            "trigger": "check",
                            "script": "const isBlind = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"blind\");\nif (isBlind) {\n    args.flags.critThresholdMod = 20; // 降低20，基本必暴\n    ui.notifications.info(`${args.target.name} 目盲，此招必定暴击！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "疾雷行空",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>闪电横空，耀眼一瞬，原地消失后闪现至 10 米内一个未被占据的空格，对施展招式起点与终点相连直线上的一个目标进行斩击，造成伤害，并为其添加“目盲”，持续一回合；</p><p>·然后力尽，自身陷入“禁足”，持续一回合。</p><p>·如果招式造成暴击，你闪现出身形后剑身电闪，可消耗反应动作释放一次【电闪雷鸣】。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "施加目盲、自身禁足自动。暴击追击手动。闪现手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "特效应用",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    // 敌方目盲\n    const blind = CONFIG.statusEffects.find(e => e.id === \"blind\");\n    if(blind) {\n        const bd = foundry.utils.deepClone(blind);\n        bd.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, bd);\n    }\n}\n// 自身禁足 (hit_once保证只加一次)\nif (args.type === 'hit_once' || args.isManual) {\n    const root = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(root) {\n        const rd = foundry.utils.deepClone(root);\n        rd.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(actor, rd);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "文殊剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>文殊菩萨右手持智慧剑，斩断种种烦恼。此剑法有五种大变化，每个大变化中又有五百小变化。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "护法天殊",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>金光罩身，天殊护法，格挡成功时，金光大耀，将周围 1 米敌人击退 3 米，若有单位撞到障碍物，则可以消耗反应动作释放【智引迷航】。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "击退效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "智引迷航",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑随意动，对目标造成伤害。击破架招时，可以切换套路为《风后奇刃》，并消耗次要动作释放【镇星荡宿】。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "切换套路手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "华严启智",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>翻身行剑，如当头棒喝，发人智慧，对目标造成伤害。若对方无架招，使目标杂念四生，陷入“启智”状态两回合，若对方格挡成功，则使自己陷入“启智”状态两回合。</p><p><strong>启智：</strong>虚招对抗具有劣势，但结果+3。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "启智状态自动应用(命中给敌/被格挡给自己)。状态效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "启智分配",
                            "trigger": "hit",
                            "script": "const effData = {\n    name: \"启智\",\n    icon: \"icons/magic/light/hand-sparks-glow-yellow.webp\",\n    description: \"虚招对抗劣势，但结果+3\",\n    duration: { rounds: 2 },\n    flags: { \"xjzl-system\": { slug: \"qizhi\", stackable: false } },\n    changes: [\n        { key: \"flags.xjzl-system.feintLevel\", mode: 2, value: \"-1\" }, // 劣势\n        { key: \"system.combat.kanpo\", mode: 2, value: \"3\" }, // 看破+3\n        { key: \"system.combat.xuzhao\", mode: 2, value: \"3\" } // 虚招+3\n    ]\n};\n\nif (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n    ui.notifications.info(`${args.target.name} 被启智！`);\n} else if (args.isHit && args.target.system.martial.stanceActive) {\n    // 命中但有架招 -> 视为格挡成功(除非被击破)\n    await game.xjzl.api.effects.addEffect(actor, effData);\n    ui.notifications.info(\"攻击被格挡，自身陷入 [启智]！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "觉远狮子",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>清啸响彻，震耳欲聋，周围敌人与自己进行一个气感对抗，若敌人对抗失败，则陷入“耳鸣”状态，持续一回合。</p><p><strong>升级：</strong>招式距离+2，对抗检定+1，内力消耗+2。</p>",
                    "automationNote": "请求对抗自动。耳鸣手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "狮子吼",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = actor.system.stats.qigan.total + (lvl - 1);\n\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"qigan\",\n    dc: dc,\n    label: \"狮子吼对抗\",\n    onFail: \"deaf\"\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "慧寂金刚",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>慧寂净明，无色无念，寻常一剑，对目标造成伤害，若对方拥有“启智”状态，则与他进行一个悟性对抗，对方若失败则陷入“自闭”，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "检测启智并请求对抗自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "慧寂对抗",
                            "trigger": "hit",
                            "script": "const hasQizhi = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qizhi\");\nif (hasQizhi) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"wuxing\",\n        dc: actor.system.stats.wuxing.total,\n        label: \"慧寂对抗\",\n        onFail: \"zibi\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "勘虚残剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>传闻与独孤剑诀同形异理，推算剑法未来，破尽招式，但看似相似，实则大有不同，可惜仅有残招。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "有隙可乘",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持剑轻点，剑尖直指目标破绽，造成伤害，击破架招时，你开启一个和目标相同的架招，且视作精通。</p><p>·若目标的架招你已经修炼到掌握级别，此次虚招对抗+4。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "对抗加值自动(需GM确认是否掌握)。复制架招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "掌握加成",
                            "trigger": "check",
                            "script": "ui.notifications.info(\"若已掌握目标架招，请手动在弹窗中增加 4 点虚招加值。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "引君入瓮",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>以剑引导对方攻击，剑兵多次相碰，推算敌方功法破绽，对目标造成伤害，敌方当前的套路每缺少 1 种招式类型（虚招、实招、架招、反击、气招、绝招），招式提升 10 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "伤害加成手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "破绽增伤",
                            "trigger": "check",
                            "script": "ui.notifications.info(\"请检查目标套路缺少的招式类型数量，并手动增加伤害 (每种+10)。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "八面埋伏",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作施展此招，压制对方虚招。剑起杀机，剑风肆虐，让对手避无可避，对目标造成伤害，之后向任意方向移动 1 米。</p><p>·若目标的虚招你已经修炼到精通级别，则可以直接消耗反应压制目标招式。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "连城剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖奇人梅先生成名剑法，招式全依唐诗取名，威力冠绝武林，据说还包含一个巨大的秘密。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "倚杖看孤石",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>依剑而立，杀机尽藏，开启架招，格挡成功后，使自己陷入“禁足”状态，持续一回合。</p><p><strong>升级：</strong>格挡值+10，消耗+2</p>",
                    "automationNote": "格挡自禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡禁足",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst root = CONFIG.statusEffects.find(e => e.id === \"root\");\nif (root) {\n    const data = foundry.utils.deepClone(root);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(actor, data);\n    ui.notifications.info(\"格挡反震，自身禁足！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "风尘三尺剑",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>以剑横扫，剑光闪过，对周围敌人造成伤害。若自己处于“禁足”状态，剑光分化为三，招式距离+3。</p><p>若自己处于“缚身”状态，击飞所有敌人 3 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "距离加成提示自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足增距",
                            "trigger": "calc",
                            "script": "const isRooted = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"root\");\nif (isRooted) {\n    args.output.bonusDesc.push(\"禁足加成：距离 +3\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白日依山尽",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一剑如日光恍恍，刺向目标肩头，对目标造成伤害。</p><p>·若自身处于“禁足”状态，则此招虚招值+3。</p><p>·若有目标被击飞，可以消耗反应飞身施展此招，击落敌人。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "禁足虚招加成自动。击落手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足加成",
                            "trigger": "calc",
                            "script": "const isRooted = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"root\");\nif (isRooted) {\n    args.output.feint += 3;\n    args.output.bonusDesc.push(\"禁足加成：虚招 +3\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "春潮带雨晚来急",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招后消耗反应施展，压制目标虚招，剑光闪闪，连绵不绝，对目标造成伤害。与目标进行一次[武学内功]对抗，对抗成功，击飞目标武器 3 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "武学对抗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "一行白鹭上青天",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "全回合动作",
                    "description": "<p>回合开始时，若你处于“眩晕”状态，才可以施展此招，移除“眩晕”，然后花费全回合动作，闪身至目标身前，一剑飞挑，荡开目标兵器，反手一记耳光，击飞目标 1 米，并对其造成伤害，然后使目标陷入“眩晕”状态，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "出招移除自身眩晕自动。命中施加目标眩晕自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "解晕",
                            "trigger": "attack",
                            "script": "const stun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xuanyun\");\nif (stun) {\n    await stun.delete();\n    ui.notifications.info(\"已解除自身眩晕！\");\n} else {\n    ui.notifications.warn(\"未检测到眩晕状态，可能不满足施展条件。\");\n}",
                            "active": true
                        },
                        {
                            "label": "晕敌",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const xuanyun = CONFIG.statusEffects.find(e => e.id === \"xuanyun\");\n    if (xuanyun) {\n        const data = foundry.utils.deepClone(xuanyun);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "仙授剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>一招一式深藏极情，内力运转，剑气出锋。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "无人贵骏骨",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑身汇聚内劲，隐隐震动，开启架招。格挡成功后，获得一层“长生气”，最多叠加 5 层，战斗脱离后消失。</p><p>·被击破架招时，对方流失 10 点气血。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获层自动。被击破反伤手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获气",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst effData = thisItem.effects.getName(\"长生气\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "醉舞纷绮席",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>长剑挥舞，对周围敌人造成伤害，每击破一人架招，则获得一层“长生气”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破获层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获气",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effData = thisItem.effects.getName(\"长生气\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白骨成丘山",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>长剑低垂，蓦然一挑，对敌人造成伤害，若击中无架招目标，获得一层“长生气”。</p><p>若有敌人处于 5 米范围的半空中，可消耗反应动作释放此招，飞身造成伤害，将敌人挑落并倒地。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无架招获层自动。追击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中获气",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effData = thisItem.effects.getName(\"长生气\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "清水出芙蓉",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "次要动作",
                    "description": "<p>内劲外放，清洗自身毛孔，每层“长生气”可回复 2 点气血。</p><p><strong>升级：</strong>每层长生气额外回复生命值 2 点，消耗+2</p>",
                    "automationNote": "回血量自动计算。需手动选自己。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "长生回血",
                            "trigger": "calc",
                            "script": "const qi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"changshengqi\");\nconst stacks = qi ? (qi.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst perStack = 2 + (lvl - 1) * 2;\n\nargs.output.damage = stacks * perStack;\nargs.output.bonusDesc.push(`长生气(${stacks}层) * ${perStack} = ${args.output.damage}`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一剑落旄头",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>转身一剑，直指面门，造成伤害，消耗所有长生气，每消耗一层，回复此招伤害 10%（扣除防御格挡之前）的气血。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "消耗长生气自动。伤害计算后自动回血。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "吞气回血",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const qi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"changshengqi\");\n    if (qi) {\n        const stacks = qi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n        await qi.delete();\n        \n        // 使用 baseDamage 模拟扣除防御前\n        const heal = Math.floor(args.baseDamage * 0.1 * stacks);\n        await actor.applyHealing({ amount: heal, type: \"hp\", showScrolling: true });\n        ui.notifications.info(`一剑落旄头：吞噬 ${stacks} 层长生气，回复 ${heal} 气血`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "长生气",
                    "icon": "icons/magic/life/cross-beam-green.webp",
                    "description": "储存生机。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "changshengqi",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "碧月剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖碧月剑派不传之秘，招式极为漂亮。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "碧月青天",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，单剑挑起，对目标造成 0.5 力量点外功伤害，若自身气血值低于 70 点，则可以消耗反应动作施展此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "反应动作施展条件需手动判定。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "莲花开月",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑扫浑圆，对目标造成 0.4 力量点外功伤害，击破架招可以使用次要动作施展【碧月青天】。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破后追击需手动操作。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "隐跃江波",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当对手造成暴击时，可消耗反应动作，剑身轻闪黄光，消耗内力抵挡此次攻击的一部分伤害，每点内力可抵挡 1 点伤害。</p><p><strong>升级：</strong>每点内力抵挡伤害+1。</p>",
                    "automationNote": "抵挡伤害与消耗内力均需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "灵泉映月",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，剑飞如双，虚实相间，开启架招。格挡成功时，使目标陷入“禁足”，持续一回合。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡施加禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-禁足",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    await game.xjzl.api.effects.addEffect(args.attacker, \"root\");\n    ui.notifications.info(`${args.attacker.name} 被禁足！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "月隐苍天",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，身剑相辅，融为一体，刺向对手，随后飘然远去，此次命中具有优势，造成 0.7 力量点外功伤害，然后你获得 5 移动速度持续到回合末，你获得“月隐”，持续到战斗脱离。</p><p><strong>月隐：</strong>你不会受到《趁虚而入》攻击。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中优势自动。获月隐、移速自动。月隐效果需手动注意。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "优势判定",
                            "trigger": "attack",
                            "script": "args.flags.level += 1;",
                            "active": true
                        },
                        {
                            "label": "获得月隐与极速",
                            "trigger": "hit",
                            "script": "const yueyin = thisItem.effects.getName(\"月隐\").toObject();\ndelete yueyin._id;\nyueyin.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, yueyin);\n\nconst speedBuff = {\n    name: \"月隐极速\",\n    icon: \"icons/magic/movement/trail-streak-blue.webp\",\n    duration: { turns: 1 },\n    changes: [{key: \"system.combat.speed\", mode: 2, value: \"5\"}],\n    flags: { \"xjzl-system\": { slug: \"yueyin_speed\", stackable: false } }\n};\nawait game.xjzl.api.effects.addEffect(actor, speedBuff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "月隐",
                    "icon": "icons/magic/air/fog-gas-smoke-dense-blue.webp",
                    "description": "不会受到《趁虚而入》攻击。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yueyin",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "螳螂剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>螳螂门于前辈所创，其《悟剑篇》中描述的双手剑法剑长四尺半，较寻常剑器，更重腰步手腕之力。开合挑刺，撩圈搅拨，如龙蛇飞舞，似惊天一线。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "轻而不浮求一快",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，上步直剑，轻刺咽喉，对敌人造成 0.4 力量点外功伤害，如果你的外功命中高于对方的闪避，虚招值+2。击破架招后，给目标添加一层“流血”，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，额外添加一层流血，消耗+2。</p>",
                    "automationNote": "命中对比判断自动。击破施加流血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中对比增加虚招",
                            "trigger": "check",
                            "script": "const myHit = actor.system.combat.hitWaigongTotal;\nconst targetDodge = args.target.system.combat.dodgeTotal || 0;\nif (myHit > targetDodge) {\n    args.flags.grantFeint += 2;\n}",
                            "active": true
                        },
                        {
                            "label": "击破-流血",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const statusId = \"bleed_stack\";\n    \n    // 循环叠加层数\n    for(let i=0; i<lvl; i++) {\n         await game.xjzl.api.effects.addEffect(args.target, statusId);\n    }\n    ui.notifications.info(`${args.target.name} 流血 +${lvl}层`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "重而不滞劲内传",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑长势沉，巧击劲力，挥剑对敌人造成 0.5 力量点外功伤害。</p><p>若目标具有架招，使其流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+10，流失增加 5 点，内力消耗+2。</p>",
                    "automationNote": "架招流失自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "架招流失",
                            "trigger": "hit",
                            "script": "if (args.target.system.martial.stanceActive) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const loss = 5 + (lvl - 1) * 5;\n    await args.target.applyDamage({\n        amount: loss,\n        type: \"liushi\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(`${args.target.name} 因架招流失 ${loss} 气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "锉步骤发快无隙",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，消耗反应动作释放此招，剑破杀机，回身长刺，压制目标虚招，并造成 0.6 力量点外功伤害。同时自身进入“剑围护身”状态，持续一回合。</p><p><strong>剑围护身：</strong>受到的内外功伤害减少 30 点。</p><p><strong>升级：</strong>招式伤害+10，剑围护身持续回合数+1，内力消耗+2。</p>",
                    "automationNote": "剑围护身自动获得。减伤效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得剑围",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst eff = thisItem.effects.getName(\"剑围护身\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: rounds };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "不偏不倚不求形",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "actionType": "default",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，凝神屏息，气势似有若无，剑如螳臂舐风，伺机迸发杀意。清除自身所有敌人添加的状态，并进入“猎食”状态，持续 1 回合。</p><p><strong>猎食：</strong>招式伤害+10，暴击骰-1。</p><p><strong>升级：</strong>“猎食”伤害+5，暴击骰再-1，持续回合数+1，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "清除状态手动。获猎食自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得猎食",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\nconst dmgBonus = 10 + (lvl - 1) * 5;\nconst critBonus = -1 + (lvl - 1) * -1;\n\nconst eff = thisItem.effects.getName(\"猎食\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: rounds };\n\n// 动态修改数值\neff.changes[0].value = String(dmgBonus);\neff.changes[1].value = String(critBonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"已进入 [猎食] 状态，请手动清除身上的负面状态。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "剑围护身",
                    "icon": "icons/magic/defensive/shield-barrier-glowing-blue.webp",
                    "description": "受到的内外功伤害减少 30 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianwei",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.resistances.global.mod",
                            "mode": 2,
                            "value": "30"
                        }
                    ]
                },
                {
                    "name": "猎食",
                    "icon": "icons/creatures/invertebrates/mantis-green.webp",
                    "description": "招式伤害增加，暴击骰减少。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lieshi",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "龙渊剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>欧冶子以器入武道，创出的一套剑法，此剑法不以功力深厚为长，只仗兵器锋锐，与传统武道大相径庭。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>无</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "无锋三千载",
                    "type": "stance",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，以手抚剑，开启架招，进入“剑醒”状态，持续到战斗脱离。若你在本场战斗中，已经获得过“剑醒”状态，则不会再次进入。</p><p><strong>剑醒：</strong>你装备的剑类武器伤害+10，格挡值+5。</p><p><strong>升级：</strong>架招提供的格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启自动获剑醒(单场战斗一次判断需手动)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得剑醒",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"剑醒\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "剑起有双龙",
                    "type": "feint",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，扬剑直刺，剑光一分为二，对目标造成武器伤害*2 点外功伤害，击破架招时，使目标陷入“弃武”状态，持续一回合。</p><p><strong>弃武：</strong>你失去武器的伤害、格挡和效果。</p><p>·命中前，你可以选择消耗“剑醒”状态，使此次虚招对抗具有优势。</p><p><strong>升级：</strong>武器伤害系数+1，内力消耗+2。</p>",
                    "automationNote": "伤害计算自动(脚本修正)。击破弃武(应用缴械状态)自动。消耗剑醒获优势会弹窗询问。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "武器伤害计算",
                            "trigger": "calc",
                            "script": "// 基础是 2 倍，升级后系数+1\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst multiplier = 1 + (lvl - 1);\nconst weaponDmg = args.baseData.weapon || 0;\n\n// 系统已算了一倍，我们补剩下的\nargs.output.damage += weaponDmg * (1 + multiplier);\nargs.output.bonusDesc.push(`武器倍率修正 +${weaponDmg * (1 + multiplier)}`);",
                            "active": true
                        },
                        {
                            "label": "消耗剑醒",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianxing\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"剑起有双龙\" },\n        content: `<p>是否消耗 [剑醒] 以获得 <b>虚招优势</b>？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"不消耗\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await buff.delete();\n        args.flags.feintLevel += 1;\n        ui.notifications.info(\"已消耗 [剑醒]，虚招获优势\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "击破-弃武",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"jiaoxie\");\n    ui.notifications.info(`${args.target.name} 被弃武(缴械)！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "剑啸天风起",
                    "type": "real",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，持剑引天，对周围敌人造成武器伤害值*2 点外功伤害，击中无架招敌人时，为自己的武器添加一层“天风”，最多五层，持续到战斗脱离。</p><p><strong>天风：</strong>每层使你装备的武器伤害+5，格挡值+5。</p><p>·命中前，你可以选择消耗“剑醒”状态，使此招的攻击范围变为 5。</p><p><strong>升级：</strong>武器伤害系数+1，内力消耗+4。</p>",
                    "automationNote": "伤害计算自动。获天风自动。消耗剑醒改距离手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "武器伤害计算",
                            "trigger": "calc",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst multiplier = 1 + (lvl - 1);\nconst weaponDmg = args.baseData.weapon || 0;\nargs.output.damage += weaponDmg * (1 + multiplier);\nargs.output.bonusDesc.push(`武器倍率修正 +${weaponDmg * (1 + multiplier)}`);",
                            "active": true
                        },
                        {
                            "label": "消耗剑醒",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianxing\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"剑啸天风起\" },\n        content: `<p>是否消耗 [剑醒] 以提升 <b>攻击范围</b> 至 5米？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"不消耗\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await buff.delete();\n        ui.notifications.info(\"已消耗 [剑醒]，请手动判定 5米 范围。\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "获得天风",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"天风\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "剑醒",
                    "icon": "icons/weapons/swords/sword-guard-blue.webp",
                    "description": "武器伤害+10，格挡值+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianxing",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.weapon.mod",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "天风",
                    "icon": "icons/magic/air/wind-weather-snow-gusts-blue.webp",
                    "description": "每层武器伤害+5，格挡+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tianfeng",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.weapon.mod",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "玄微剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>此剑法为玄微真人所创，以言辞诱人行动。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "唯唯诺诺",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，不出招，仅观察，开启架招，并获得“阖之贵密”状态，持续到战斗脱离或解除架招。</p><p><strong>阖之贵密：</strong>在半空中时，获得相当于先攻加值的闪避。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "获状态自动。状态效果需手动应用(无半空判断)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得阖之贵密",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"阖之贵密\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "剑若悬河",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑如流水，剑势不绝，由下而上（处于半空中），对目标造成 0.5 内息点内功伤害。同时击飞目标 2 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击飞手动。半空条件手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "度权量能",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，分析要害，一剑挥出，对目标造成 0.4 内息点内功伤害。若击破架招，则使自己获得“捭之贵周”状态，持续到战斗脱离。</p><p><strong>捭之贵周：</strong>在半空中时，招式伤害+15。</p><p><strong>升级：</strong>伤害+10，捭之贵周伤害再+5，消耗+2，</p>",
                    "automationNote": "击破获状态自动。状态效果需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获状态",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"捭之贵周\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    \n    // 动态伤害\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dmgBonus = 15 + (lvl - 1) * 5;\n    // 这里只是描述，因为没法自动判定半空\n    eff.description = `在半空中时，招式伤害+${dmgBonus}`; \n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "纵横捭阖",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，万变了然于心，以巧力便可动摇根基，对目标造成 0.7 内息点内功伤害。如果你的身上同时有“捭之贵周”和“阖之贵密”状态，则使内力从地面喷涌，击飞 5 米内所有先攻顺序高于你的目标，并对所有被击飞的目标造成 30 点内力流失。</p><p><strong>升级：</strong>招式伤害+20，内力流失+10，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "额外效果判断自动。击飞与内力流失效果需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "组合效果提示",
                            "trigger": "hit",
                            "script": "const hasBai = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"baizhiguizhou\");\nconst hasHe = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"hezhiguimi\");\nif (hasBai && hasHe) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const mpLoss = 30 + (lvl - 1) * 10;\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"padding:5px; font-size:0.9em; color:#555;\">\n                <b>纵横捭阖触发：</b><br>\n                请检查 5米 内先攻高于你的目标。<br>\n                对他们造成 <b>击飞</b> 并流失 <b>${mpLoss}</b> 内力。\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "阖之贵密",
                    "icon": "icons/magic/defensive/shield-barrier-flaming-diamond-teal.webp",
                    "description": "在半空中时，获得相当于先攻加值的闪避。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "hezhiguimi",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "捭之贵周",
                    "icon": "icons/weapons/swords/sword-winged-blue.webp",
                    "description": "在半空中时，招式伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "baizhiguizhou",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "赤壁六绝剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>万舸浮江互荡磨，一番蛟鳄战盘涡。中天日月悲分影，对局英雄付逝波。形胜空传二赤壁，文章谁肯百东坡。荆州风景今何似，秋夜时闻窈窕歌。</p><p>月夜泛舟，带走点点哀痛。怀古伤今，悲咽里精神解脱。这是他的故事，这是他的精神。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "遗世独立",
                    "type": "qi",
                    "actionType": "default",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，摒气凝神，进入“遗世独立”，持续一回合。</p><p><strong>遗世独立：</strong>被虚招攻击时，自身看破值-2。使用【望美人兮天一方】攻击时，自身虚招值+2。</p><p><strong>升级：</strong>看破值-1，虚招值+1，内力消耗+4。</p>",
                    "automationNote": "获BUFF自动。看破减少/虚招增加通过AE实现。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获遗世独立",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst kanpoMalus = -2 + (lvl - 1) * -1;\nconst feintBonus = 2 + (lvl - 1) * 1;\n\nconst eff = thisItem.effects.getName(\"遗世独立\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: 1 };\n\n// 动态写入\neff.changes[0].value = String(kanpoMalus);\neff.changes[1].value = String(feintBonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "东方既白",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，曳身轻刺，对周身范围目标造成 0.4 内息点内功伤害，并击倒无架招的目标。</p><p>造成伤害后，为自身添加“既白”，持续两回合。</p><p><strong>既白：</strong>普攻和招式伤害+10 点。</p><p><strong>升级：</strong>招式伤害+10，既白伤害+5，内力消耗+4。</p>",
                    "automationNote": "无架招击倒手动。获既白自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获既白",
                            "trigger": "hit_once",
                            "script": "if (args.hitCount > 0) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dmgBonus = 10 + (lvl - 1) * 5;\n    \n    const eff = thisItem.effects.getName(\"既白\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: 2 };\n    eff.changes[0].value = String(dmgBonus);\n    eff.changes[1].value = String(dmgBonus);\n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "望美人兮天一方",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑摆前方，造成 0.4 内息点内功伤害。击破架招时，获得等同对方格挡值的格挡值，持续到战斗结束。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破吸取格挡自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "遗世独立加成",
                            "trigger": "attack",
                            "script": "const hasBuff = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yishiduli\");\nif (hasBuff) {\n    const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yishiduli\");\n    // 读取buff里存的数值 (changes[1]是虚招加值)\n    const bonus = Number(buff.changes[1].value) || 0;\n    args.flags.bonusFeint += bonus;\n}",
                            "active": true
                        },
                        {
                            "label": "击破获格挡",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const targetBlock = args.target.system.combat.blockTotal || 0;\n    if (targetBlock > 0) {\n        const eff = {\n            name: \"夺取格挡\",\n            icon: \"icons/magic/defensive/shield-barrier-blue.webp\",\n            changes: [{key: \"system.combat.block\", mode: 2, value: String(targetBlock)}],\n            flags: { \"xjzl-system\": { slug: \"duoqugedang\", stackable: true } }\n        };\n        await game.xjzl.api.effects.addEffect(actor, eff);\n        ui.notifications.info(`夺取了 ${targetBlock} 点格挡！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "击空明兮溯流光",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，绕击盘旋，缠武多变，对目标造成 0.5 内息点内功伤害。</p><p>当自身存在“既白”时，将既白变为“流光”，持续到战斗脱离。</p><p><strong>流光：</strong>普攻和招式伤害+10 点。</p><p><strong>升级：</strong>招式伤害+10，流光伤害+5，消耗+2。</p>",
                    "automationNote": "既白转流光自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "转化流光",
                            "trigger": "hit",
                            "script": "const jibai = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jibai\");\nif (jibai) {\n    await jibai.delete();\n    \n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dmgBonus = 10 + (lvl - 1) * 5;\n    \n    const eff = thisItem.effects.getName(\"流光\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.changes[0].value = String(dmgBonus);\n    eff.changes[1].value = String(dmgBonus);\n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"既白转化为流光！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "遗响悲风",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，剑风拂晓吟哀鸣，开启架招。</p><p>只要架招未被击破，你在自己的回合时，可以不消耗动作进行一次普通攻击。</p><p>·当你即将施展《赤壁六绝剑》以外的武学招式时，该架招解除。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "普攻机会需手动使用。自动解除需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "羽化而登仙",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，原地腾至半空，奔袭落向 5 米内一处空格，使其周围空间气流凝聚混乱，对周围 5 米范围内的敌人造成 0.7 内息点内功伤害。</p><p>·若你存在“流光”，则在半空中时无法被选中。</p><p>·此招造成伤害后，你可以移除自身同时存在的“流光”和“既白”，然后无消耗的施展一次【望美人兮天一方】。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "不可选中手动。追击手动(需手动移除Buff)。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "遗世独立",
                    "icon": "icons/magic/symbols/triangle-glow-blue.webp",
                    "description": "被虚招攻击看破-，攻击虚招值+。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yishiduli",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.xuzhao",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "既白",
                    "icon": "icons/magic/light/explosion-star-glow-silhouette.webp",
                    "description": "普攻和招式伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jibai",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.normal.mod",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "流光",
                    "icon": "icons/magic/movement/trail-streak-impact-blue.webp",
                    "description": "普攻和招式伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "liuguang",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.normal.mod",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "长生剑歌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>出自李白之诗，其剑法灿烂，令人为之胆寒。</p><p>注：若一对夫妻同时掌握所有的《长生剑歌》，他们双修每个月获得额外的 100 修为。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "仙楼放歌",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，剑化放荡，开启架招。成功格挡后获得一层“气奏”，至多叠加三层，持续到战斗脱离。</p><p><strong>气奏：</strong>每层使你每次出招时对周围 2 米范围内的敌人造成 10 点气血流失。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获得气奏自动。气奏效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获气奏",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"气奏\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "情游四海",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，削风成气，对目标造成 0.5 内息点内功伤害，并获得一层“气奏”。</p><p>若范围内有敌人处于半空中，你可以消耗反应动作释放此招，站于原地射出剑气，从天而落伤敌。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "获气奏自动。反应动作判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获气奏",
                            "trigger": "hit_once",
                            "script": "if (args.hitCount > 0) {\n    const eff = thisItem.effects.getName(\"气奏\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "笑逐古今",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，压制对方虚招，并对其造成 0.4 内息点内功伤害，并获得一层“气奏”。其后微微一笑，让目标进行 [定力] 检定难度 15，若检定失败，则其下回合不得选中你为攻击目标。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "获气奏自动。发起检定自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获气奏",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"气奏\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "请求检定",
                            "trigger": "hit",
                            "script": "await Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: 15,\n    label: \"抵抗笑逐古今\"\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "仙授长生",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，仙人赐生，吾剑赐死，对目标造成 0.8 内息点内功伤害，若你“气奏”达到三层，则使你回复气奏层数*10 的气血。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "三层气奏回血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气奏回血",
                            "trigger": "hit_once",
                            "script": "const qizou = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qizou\");\nconst stacks = qizou ? (qizou.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nif (stacks >= 3) {\n    const heal = stacks * 10;\n    await actor.applyHealing({amount: heal, type: \"hp\", showScrolling: true});\n    ui.notifications.info(`仙授长生：回复 ${heal} 点气血`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "气奏",
                    "icon": "icons/magic/sonic/explosion-shock-wave-teal.webp",
                    "description": "出招时造成周围伤害(手动)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qizou",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "冰寂剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>一剑出，天地冻，事物寥落。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "万载沉冰",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，吐出一口寒气于剑上，将身体与地面通过寒气连结，开启架招。并获得“沉冰”，持续到战斗脱离或解除架招。</p><p><strong>沉冰：</strong>你免疫击飞和“流血”状态。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "获沉冰自动。免疫击飞流血需手动注意。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得沉冰",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"沉冰\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "千里冻土",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，随着一剑劈出，寒气肆虐，对目标造成 0.5 力量点内功伤害，若击中无架招敌人，寒气缠绕其全身，使目标陷入“禁气”状态两回合。</p><p><strong>禁气：</strong>无法施展气招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无架招禁气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁气",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, \"jinqi\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "绝风冽冽",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，斩出数道剑气，随着寒气扑向周围敌人，对周围敌人造成 0.3 力量点内功伤害，击破架招时，使目标陷入“禁气”状态两回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破禁气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-禁气",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"jinqi\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "寒潮起落余死骨",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时消耗反应施展，压制目标虚招，卷起寒气，击飞对手 1 米，并造成 0.6 力量点内功伤害，使对手陷入“禁气”状态，持续两回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击飞手动。禁气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁气",
                            "trigger": "hit",
                            "script": "await game.xjzl.api.effects.addEffect(args.target, \"jinqi\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万古冰寂了无生",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "4米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，呼啸一声，将周围 3 米内的敌人推开至距离 4 米处，引动寒气，剑气如旋风，对周围敌人造成 0.7 力量点内功伤害，每有一个敌人处于“禁气”状态，此招伤害提升 10 点。之后将所有敌人的“禁气”状态变为“冰封”状态，持续 1 回合。</p><p><strong>冰封：</strong>失去所有动作，冰封期间受到的伤害增加 50%，当你受到一次伤害后，冰封解除。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "推开手动。禁气增伤自动。禁气转冰封自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁气增伤",
                            "trigger": "preDamage",
                            "script": "const hasJinqi = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jinqi\");\nif (hasJinqi) {\n    args.config.amount += 10;\n}",
                            "active": true
                        },
                        {
                            "label": "禁气转冰封",
                            "trigger": "hit",
                            "script": "const jinqi = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jinqi\");\nif (jinqi) {\n    await jinqi.delete();\n    const eff = thisItem.effects.getName(\"冰封\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 禁气转化为冰封！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "沉冰",
                    "icon": "icons/magic/water/ice-block-silver.webp",
                    "description": "免疫击飞和流血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chenbing",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "冰封",
                    "icon": "icons/magic/water/snowflake-ice-blue.webp",
                    "description": "失去所有动作，易伤50%。受击解除。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bingfeng",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "易伤50%",
                                    "trigger": "preDefense",
                                    "active": true,
                                    "script": "args.config.amount = Math.floor(args.config.amount * 1.5);"
                                },
                                {
                                    "label": "受击解除",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "if (args.finalDamage > 0) {\n    await thisEffect.delete();\n    ui.notifications.info(`${actor.name} 冰封碎裂！`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.stun",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "巫鬼箓",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>脱胎于祈巫之舞，挥舞时光影绰绰，可驱离鬼魅。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>阳</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "巡游土地",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，双剑插地，开启架招。格挡成功后，获得“巡游”，持续一回合。</p><p><strong>巡游：</strong>命中半空的敌人时，招式伤害+10。</p><p><strong>升级：</strong>格挡值+10，巡游持续回合数+1，消耗+2。</p>",
                    "automationNote": "格挡获巡游自动。半空增伤手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获巡游",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst eff = thisItem.effects.getName(\"巡游\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "判官醉酒",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，似神似鬼，剑气飞出，对目标造成 0.5 力量点外功伤害。</p><p>·若范围内有敌人处于半空中，此招可消耗反应动作释放，立于原地甩出剑气，造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "反应释放手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "天师遣将",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，拘神衰灵，剑挑前方，对目标造成 0.4 力量点内功伤害。击破架招时，将目标击飞三米，并为其添加“天离”，持续一回合。</p><p><strong>天离：</strong>被【判官醉酒】命中后，被击飞 1 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破击飞手动。获天离自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获天离",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"天离\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "傩神跳魈",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应释放此招，恶鬼还世，将其击飞至半空中，然后原地剑削目标，对其造成 0.5 力量点内功伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击飞至半空手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "姜女送衣",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，剑舞剑气，侵蚀目标造成 0.8 力量点内功伤害，并将其“禁足”两回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足",
                            "trigger": "hit",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "巡游",
                    "icon": "icons/magic/light/beam-rays-yellow-blue.webp",
                    "description": "命中半空敌人增伤。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xunyou",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "天离",
                    "icon": "icons/magic/symbols/rune-sigil-black-pink.webp",
                    "description": "被判官醉酒击飞。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tianli",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "反两仪双剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>以八卦推演而得，常人难以琢磨，需与正两仪双刀合用。</p><p>注：当周围 10 米范围内有一名队友存在“太阳”“太阴”状态、且你存在“少阳”“少阴”时，你与他同时进入“阴阳调和”状态，浑身四象流转，持续到战斗脱离。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "西风斜阳",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，舞剑环身，对周围敌人造成 0.4 内息点内功伤害。自身进入“少阳”状态，持续到战斗脱离。</p><p>·当你处于“阴阳调和”时，若范围内有敌人处于半空中，可消耗反应动作，凝发剑气，原地攻击目标。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "获少阳自动。阴阳调和效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获少阳",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"少阳\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴云密布",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，反握双剑，开启架招。格挡后自身进入“少阴”状态，持续到战斗脱离。</p><p>·当你处于“阴阳调和”时，自身格挡值翻倍。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获少阴自动。调和格挡翻倍手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获少阴",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"少阴\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "日月如梭",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，反持双剑，一刺一划，造成 0.4 内息点内功伤害，击破架招时，额外获得 1 怒气。</p><p>·当你处于“阴阳调和”时，你还可以让场上其他队友获得 1 点怒气。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破回怒自动。调和回队友怒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破回怒",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const rage = actor.system.resources.rage;\n    if (rage.value < rage.max) {\n        await actor.update({ \"system.resources.rage.value\": rage.value + 1 });\n        ui.notifications.info(\"击破架招，额外获得1怒气\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴差阳错",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，以阴阳内劲袭击目标，为其添加“阴阳逆乱”状态，持续 1 回合。</p><p><strong>阴阳逆乱：</strong>招式伤害-20，同时无法获得怒气。</p><p>·当你处于“阴阳调和”时，持续回合数+1。</p><p><strong>升级：</strong>释放距离+2，内力消耗+2。</p>",
                    "automationNote": "施加状态自动。调和增加时长需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "阴阳逆乱",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"阴阳逆乱\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴阳易位",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，踏步四象，乱舞阴阳，对周围目标造成 0.7 内息点内功伤害。</p><p>招式可以改为消耗你的蓄力动作和 3 米内处于“阴阳调和”状态队友的反应动作共同释放此招（招式依旧由你释放，使用你的命中暴击），你和该队友共同支付怒气，对你周围的敌人造成 0.9 内息点内功伤害，</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "合击模式伤害需手动调整(弹窗或手动加值)。队友消耗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "少阳",
                    "icon": "icons/magic/symbols/rune-sigil-hook-white-pink.webp",
                    "description": "四象状态之一。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shaoyang",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "少阴",
                    "icon": "icons/magic/symbols/rune-sigil-hook-white-blue.webp",
                    "description": "四象状态之一。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shaoyin",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "阴阳逆乱",
                    "icon": "icons/magic/chaos/chaos-symbol-yellow.webp",
                    "description": "招式伤害-20，无法获得怒气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinyangniluan",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "-20"
                        },
                        {
                            "key": "flags.xjzl-system.noRecoverRage",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "惊世剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>此八式剑法非是一人所创，乃是历代剑法宗师的毕生武道精华，刻于皇城碑林。内共有上百石碑，上面尽是剑法招数，而此八式剑法便是其中之佼佼。</p><p>注：此武功前六招为地级，后两招为天级。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "华灯初上",
                    "type": "stance",
                    "tier": 2,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，剑挑风起，开启架招。格挡成功后，获得一层“龙气”，最多 5 层，持续到战斗脱离。</p><p><strong>龙气：</strong>每层龙气使你的格挡值额外+3，当你获得 5 层龙气后，进入“真龙”状态。</p><p><strong>真龙：</strong>你当前每有一点格挡值，招式伤害+1。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获龙气自动。真龙状态需手动添加AE。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获龙气",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"龙气\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "车水马龙",
                    "type": "real",
                    "tier": 2,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，快速穿行于战场当中，出其不意刺向敌人，对目标造成 0.5 力量点内功伤害，你本回合每移动 1 米，招式伤害+1。（最多 20 点）</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "移动增伤需在弹窗中手动修正。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "亭台楼阁",
                    "type": "feint",
                    "tier": 2,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，一剑虚晃斩向目标胸膛，又转刺下盘，对目标造成 0.4 力量点内功伤害，击破架招时，使目标陷入禁足状态，持续一回合。</p><p>你每拥有一层“龙气”，此招虚招值+1。</p><p>当你处于“真龙”状态，击破架招额外使目标陷入封招，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "龙气加值自动。击破禁足/封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "龙气加值",
                            "trigger": "calc",
                            "script": "const longqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"longqi\");\nif (longqi) {\n    const stacks = longqi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    args.output.feint += stacks;\n    args.output.bonusDesc.push(`龙气加成 +${stacks}`);\n}",
                            "active": true
                        },
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    \n    const trueDragon = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhenlong\");\n    if (trueDragon) {\n        const fengEff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n        if(fengEff) {\n            const d2 = foundry.utils.deepClone(fengEff);\n            d2.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, d2);\n            ui.notifications.info(\"真龙威压：目标被封招！\");\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "月明风清",
                    "type": "counter",
                    "tier": 2,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时消耗反应施展，压制目标虚招，刺出数剑，对目标造成 0.6 力量点内功伤害，每拥有一层“龙气”，额外造成 5 点气血流失。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "龙气流失自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "龙气流失",
                            "trigger": "hit",
                            "script": "const longqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"longqi\");\nif (longqi) {\n    const stacks = longqi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const loss = stacks * 5;\n    await args.target.applyDamage({\n        amount: loss,\n        type: \"liushi\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(`${args.target.name} 因龙气流失 ${loss} 气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "海市蜃景",
                    "type": "qi",
                    "tier": 2,
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "4米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，内力释放，在周围产生‘云气’，仿佛置身天际，持续三回合。在‘云气’范围内，每有一层“龙气”，闪避值+3。</p><p>当你处于“真龙”状态，吞云吐雾，你可以消耗反应，使一个‘云气’内的角色对你的一次攻击丢失。</p><p><strong>升级：</strong>云气距离+1，内力消耗+2。</p>",
                    "automationNote": "纯手动。请自行判定范围与闪避加值。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "火树银花",
                    "type": "real",
                    "isUltimate": true,
                    "tier": 2,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑光一闪，斩出数道绚烂剑光，斩向敌人。对目标造成 0.8 力量点内功伤害，并且击飞对手 5 米。若击中无架招的敌人，使目标陷入禁足，持续一回合。</p><p>你可以选择减少此招的伤害，每减少 20 点，获得一层“龙气”，最多获得 3 层。</p><p><strong>升级：</strong>招式伤害+20，获得龙气上限+1 层，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "击飞手动。无架招禁足自动。减伤获龙气需手动修正伤害并添加层数。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招禁足",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "金城汤池",
                    "type": "stance",
                    "tier": 3,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，双手托剑，凝神对敌，开启架招。被击破架招时，可以选择消耗反应，使此次攻击伤害降为 1 点。</p><p><strong>升级：</strong>格挡值+10，消耗+4。</p>",
                    "automationNote": "被击破减伤自动(preTake)。反应动作请自觉扣除。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破减伤",
                            "trigger": "preTake",
                            "script": "if (args.isBroken) {\n    args.output.damage = 1;\n    ui.notifications.info(\"金城汤池：架招被击破，伤害降为1 (请手动消耗反应)\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万家灯火",
                    "type": "real",
                    "isUltimate": true,
                    "tier": 3,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，剑光直刺天际，冲上云霄，轰然炸开，化作满天剑雨落下，对范围内所有敌人造成 0.9 力量点内功伤害，当自身处于“真龙”状态时，使所有敌人陷入封招，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，消耗+16。</p>",
                    "automationNote": "真龙封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48
                        ],
                        "rage": [
                            8,
                            7,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "真龙封招",
                            "trigger": "hit",
                            "script": "const trueDragon = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhenlong\");\nif (trueDragon) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "龙气",
                    "icon": "icons/creatures/reptiles/dragon-horned-blue.webp",
                    "description": "每层格挡+3。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "longqi",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "3"
                        }
                    ]
                },
                {
                    "name": "真龙",
                    "icon": "icons/creatures/reptiles/dragon-gold.webp",
                    "description": "格挡值转化为招式伤害(需配合全局AE或手动修正)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhenlong",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "格挡转伤",
                                    "trigger": "calc",
                                    "active": true,
                                    "script": "const block = actor.system.combat.blockTotal || 0;\nif (block > 0) {\n    args.output.damage += block;\n    args.output.bonusDesc.push(`真龙加成 +${block}`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "明月剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>剑势如潮水汹涌，攻守兼备。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "滟滟随波千万里",
                    "type": "qi",
                    "actionType": "default",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "4米",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>不消耗速度向前飞渡（半空中）4m，然后向左/右飞渡 3m，然后向前/后飞渡 2m，然后向左/右飞渡 1m，每次停留时周围 1m 内没有其他人，便获得一层“潮生”状态，若停留后周围 1m 有人或中途撞到人则停止飞渡。</p><p>“潮生”状态最多叠加 6 层，在战斗脱离后消失。</p><p>施展《明月剑法》招式时可以选择一项或多项效果，但不可重复选择同一项。：</p><p>消耗 1 层“潮生”：使自己本次出招伤害+5。</p><p>消耗 1 层“潮生”：使自己本次出招暴击骰-1。</p><p>消耗 2 层“潮生”：用自己的内息与对手的内息/力量进行一次对抗，成功则击飞目标。</p><p>消耗 3 层“潮生”：对手下回合对手每移动 1 米，都需要消耗 1 点内力。</p><p><strong>升级：</strong>潮生状态上限增加 2 层，内力消耗+2</p>",
                    "automationNote": "移动、获得潮生、消耗潮生均需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "空里流霜不觉飞",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑气冲霄，造成伤害，击破架招则将敌人原地挑飞至半空中。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破后挑飞状态需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`${args.target.name} 被击破架招，请手动将其挑飞至半空中。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白云一片去悠悠",
                    "type": "qi",
                    "actionType": "default",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "地面",
                    "actionCost": "主要动作",
                    "description": "<p>剑气横扫，在面前创造一道 3m*1m，高约 2m 的‘剑气白云’，持续 2 回合。</p><p><strong>剑气白云：</strong>在剑气白云中开始回合或进入剑气白云中的所有敌人和其他友方受到 0.4 内息点内功伤害。（必定命中，但无法造成暴击）</p><p>·此招中的内息是施展本招式者的内息属性。</p><p>·剑气白云形成在原地，不会跟随你移动，你只能拥有一个剑气白云，如果你形成新的剑气白云，之前的消失。</p><p>·若战场内有敌人在半空中，可消耗反应动作朝其所在的方向，释放此招。</p><p><strong>升级：</strong>‘剑气白云’伤害+10，内力消耗+2。</p>",
                    "automationNote": "造物生成手动。区域伤害需手动应用。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "生成提示",
                            "trigger": "hit",
                            "script": "const dmg = args.flags.damageResult.damage;\nui.notifications.info(`请手动生成 [剑气白云] (2回合)。区域伤害: ${dmg} (必定命中，无暴击)。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "人生代代无穷已",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>眼神清澈，开启架招，洞悉世间万物万法。格挡成功后，获得“明视”，持续一回合。</p><p><strong>明视：</strong>虚招对抗具有优势。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获明视自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-明视",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"明视\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "鸿雁长飞光不度",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破对方虚招时，消耗反应动作释放此招，压制对方虚招，内力鼓荡，剑似流水，对其造成伤害，然后获得 2 层“潮生”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中获潮生自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得潮生",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"潮生\").toObject();\n// 动态计算最大层数，防止此处addEffect时被默认值覆盖\nconst m1 = thisItem.system.moves.find(m => m.name === \"滟滟随波千万里\");\nconst lvl = Math.max(1, m1?.computedLevel || 1);\nconst maxStacks = 6 + (lvl - 1) * 2;\neff.flags[\"xjzl-system\"].maxStacks = maxStacks;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nawait game.xjzl.api.effects.addEffect(actor, eff); // 添加2层",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "斜月沉沉藏海雾",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>消耗所有“潮生”，引动周围水气，以自身为中心形成“潮生层数”*“潮生层数”、高约 2 米的‘雾海’区域，持续到战斗脱离。</p><p><strong>雾海：</strong>敌人在雾海范围内视作困难地形且重度遮蔽，无法进行任何需要视力的检定，且只能攻击面前 1 米的敌人，敌人每次在雾海内消耗内力时，受到 0.4 内息点内功伤害。（必定命中，但无法造成暴击）</p><p>·此招中的内息是施展本招式者的内息属性。</p><p>·雾海形成在原地，不会跟随你移动，你只能拥有一个雾海，如果你形成新的雾海，之前的消失。</p><p><strong>升级：</strong>‘雾海’伤害+20，怒气-1，内力消耗+8。</p>",
                    "automationNote": "消耗潮生、区域生成、区域伤害均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "生成提示",
                            "trigger": "attack",
                            "script": "const chaosheng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chaosheng\");\nconst stacks = chaosheng ? (chaosheng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nconst size = stacks * stacks;\nconst dmg = args.flags.damageResult.damage; // 基础伤害\n    \nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">雾海生成 (请手动处理)</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>请手动消耗所有潮生层数 (当前: <b>${stacks}</b>)</p>\n            <p>区域大小: <b>${size}米</b></p>\n            <p>区域伤害: <b>${dmg}</b> (消耗内力时触发)</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "潮生",
                    "icon": "icons/magic/water/wave-water-blue.webp",
                    "description": "明月剑法核心状态，可消耗增强招式。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chaosheng",
                            "stackable": true,
                            "maxStacks": 6
                        }
                    },
                    "changes": []
                },
                {
                    "name": "明视",
                    "icon": "icons/magic/perception/eye-ringed-glow-green.webp",
                    "description": "虚招对抗具有优势。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "mingshi",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.feintLevel",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "万剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>此乃剑术最高境界，一经使出万剑如仆见主，朝拜尊神一般。剑招一出，凌厉无匹的剑劲由体而生，身形化着青烟，劲气弥漫。无数利剑狂风暴雨般飞卷，漫天飞舞，剑势如网，蔚为奇观。</p><p><strong>特殊：</strong>修炼本套路需单剑技能>10，同时废除内功。（删除自身所有内功）</p><p>开始修炼后，你还会遗忘自身所有武学，直至此剑法七招修至合一，才会重新记起之前遗忘的剑法，之后你终生只能施展剑法。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "天剑唯一",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑气覆盖周身，开启架招，进入“剑体”状态，持续到战斗脱离，或被击破架招。</p><p><strong>剑体：</strong>每次出招时，凝聚等同于招式层数数量的“剑气”（领悟 1，掌握 2，精通 3，合一 4）。</p><p>剑气可叠加，持续到战斗脱离，或被击破架招。</p><p>·格挡成功时，自身“剑气”数量翻倍。</p><p><strong>升级：</strong>格挡值+10，消耗+4，招式修至合一后，所有剑法的虚招都无法以你为目标。</p>",
                    "automationNote": "开启获得剑体状态。剑体出招获剑气自动。格挡剑气翻倍自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启剑体",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"剑体\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "格挡翻倍",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst jianqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianqi\");\nif (jianqi) {\n    const stacks = jianqi.getFlag(\"xjzl-system\", \"stacks\") || 0;\n    if (stacks > 0) {\n        // 增加等同于当前层数的层数 = 翻倍\n        await game.xjzl.api.effects.addEffect(actor, { \n            name: \"剑气\", \n            flags: { \"xjzl-system\": { slug: \"jianqi\", stackable: true, stacks: stacks } }\n        });\n        ui.notifications.info(\"格挡成功！剑气翻倍！\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "名剑绝世",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>惊鸿一击，犹如数代绝世高手同时出剑，造成伤害。击破架招时为其添加“止悟”：看破值-5，持续到战斗脱离。然后，你凝聚 5 道剑气。</p><p><strong>升级：</strong>伤害+10，看破值-1，凝聚剑气+1，消耗+4。</p>",
                    "automationNote": "命中获剑气自动。击破施加止悟自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取剑气",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst gain = 5 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"剑气\").toObject();\neff.flags[\"xjzl-system\"].stacks = gain;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "击破止悟",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const penalty = -5 - (lvl - 1);\n    const eff = thisItem.effects.getName(\"止悟\").toObject();\n    eff.changes[0].value = String(penalty);\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "神剑千秋",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>气动八方，神扫剑意，造成伤害，若自身“剑气”数量超过自身悟性的一半，招式伤害提升自身内外功防御之和的伤害。</p><p>每次施展都可以消耗剑气对目标施加以下状态中的其中一个，持续一回合。</p><p>7 道“剑气”倒地。11 道“剑气”缚身。</p><p>15 道“剑气”封招。15 道“剑气”自闭。</p><p>19 道“剑气”晕眩。</p><p><strong>升级：</strong>伤害+10，每种状态消耗剑气-1，消耗+4。</p>",
                    "automationNote": "伤害加成自动。状态施加与消耗手动（提示卡）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "剑气伤害加成",
                            "trigger": "calc",
                            "script": "const jianqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianqi\");\nconst wuxing = actor.system.stats.wuxing.total;\nconst stacks = jianqi ? (jianqi.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\n\nif (stacks > wuxing / 2) {\n    const defWai = actor.system.combat.defWaigongTotal || 0;\n    const defNei = actor.system.combat.defNeigongTotal || 0;\n    const bonus = defWai + defNei;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`剑气充盈加成 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "状态选择提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst reduction = lvl - 1;\nconst costs = {\n    prone: 7 - reduction,\n    fushen: 11 - reduction,\n    fengzhao: 15 - reduction,\n    zibi: 15 - reduction,\n    stun: 19 - reduction\n};\n\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"font-weight:bold;\">神剑千秋 - 消耗剑气施加状态</div>\n        <ul style=\"font-size:0.9em; padding-left:20px;\">\n            <li><b>${costs.prone}层</b>: 倒地</li>\n            <li><b>${costs.fushen}层</b>: 缚身</li>\n            <li><b>${costs.fengzhao}层</b>: 封招 / 自闭</li>\n            <li><b>${costs.stun}层</b>: 晕眩</li>\n        </ul>\n        <p style=\"font-size:0.8em; color:#666;\">请手动在[剑气]AE中调整层数，并给目标添加对应状态。</p>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拙剑无式",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招后，消耗反应动作释放，压制对方虚招，以拙化巧，无形之招造成伤害。</p><p>若你压制的是剑法招式，你凝聚 1 道“剑气”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "压制剑法获剑气手动（需判断敌方招式）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "剑气提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"若压制的是剑法招式，请手动添加 1 层 [剑气]。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "身剑归合",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑气绕体，御剑进入“剑身”：受到伤害后，攻击者流失等同于你剑气数量*1 的气血，你的剑类兵器必然不会脱手，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4，每道剑气额外使攻击者流失 1 点气血。</p>",
                    "automationNote": "反伤自动。防缴械手动（系统暂无脱手机制）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            20,
                            24,
                            28,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得剑身",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"剑身\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 注入等级系数到 Flag\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst ratio = 1 + (lvl - 1);\neff.flags[\"xjzl-system\"].damageRatio = ratio;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "尘剑悠然",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>风清云谈，杀机四起，对目标造成伤害。</p><p>若有目标陷入地级或天级状态，可消耗反应动作释放此招，对其造成伤害。然后与目标进行一个悟性对抗，若对方失败，则目标获得的状态移除。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "伤害自动。悟性对抗与状态移除手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "对抗提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"若是用于移除状态，请手动进行 [悟性对抗]。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万剑归宗",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "20米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>你至少拥有 50 道剑气方可施展此招。爆发所有剑气，在自身周围 20 米范围内的每一个空格内布置一道‘剑痕’，持续到战斗脱离。</p><p><strong>剑痕：</strong>区域内敌人开始自己的回合或踏入该区域时，流失 10 点气血。</p><p>“剑痕”持续期间，你可以消耗蓄力动作，缓缓握掌，湮灭所有的剑痕，对站立在剑痕内的所有敌方造成伤害，并使他们陷入“封招”，持续一回合，场上的剑痕在湮灭后消失，返还你 5 层剑气。</p><p><strong>升级：</strong>招式伤害+20，剑痕流失气血+20，剑痕湮灭后返还的剑气+5，怒气-1，消耗+16</p>",
                    "automationNote": "条件判断手动。剑痕生成、伤害、湮灭均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "剑气检查与消耗",
                            "trigger": "attack",
                            "script": "const jianqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianqi\");\nconst stacks = jianqi ? (jianqi.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\n\nif (stacks < 50) {\n    ui.notifications.warn(`剑气不足 50 (当前 ${stacks})，无法施展万剑归宗！`);\n    args.flags.abort = true;\n} else {\n    ui.notifications.info(`请手动消耗 ${stacks} 道剑气，万剑归宗！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "剑气",
                    "icon": "icons/skills/melee/sword-damaged-glowing-yellow.webp",
                    "description": "万剑诀核心资源，每层对应一道剑气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianqi",
                            "stackable": true,
                            "maxStacks": 9999
                        }
                    },
                    "changes": []
                },
                {
                    "name": "剑体",
                    "icon": "icons/magic/defensive/shield-barrier-glowing-blue.webp",
                    "description": "出招时凝聚剑气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianti",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "出招凝聚",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "// 只有开启了架招，这个AE才存在。且只有在出招时触发。\n// 计算当前招式的境界层数 (领悟1/掌握2/精通3/合一4)\nconst move = args.move;\n// 这里需要获取招式等级，但attack上下文里的move是纯数据\n// 我们假设 computedLevel 存在\nlet stage = 1;\nif (move.effectiveStage) stage = move.effectiveStage;\nelse {\n    // 降级处理：按 level 估算 (1-4)\n    const lvl = move.computedLevel || 1;\n    stage = Math.min(4, lvl);\n}\n\n// 增加剑气\nconst eff = { name: \"剑气\", flags: { \"xjzl-system\": { slug: \"jianqi\", stackable: true, stacks: stage } } };\nawait game.xjzl.api.effects.addEffect(actor, eff);\n// ui.notifications.info(`剑体凝聚 ${stage} 道剑气`);"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "止悟",
                    "icon": "icons/magic/control/debuff-energy-hold-blue.webp",
                    "description": "看破值降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhiwu",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "-5"
                        }
                    ]
                },
                {
                    "name": "剑身",
                    "icon": "icons/skills/melee/sword-guard-gold.webp",
                    "description": "受击反伤。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jianshen",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "剑气反伤",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "if (!args.attacker || args.attacker.uuid === actor.uuid) return;\nconst jianqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jianqi\");\nconst stacks = jianqi ? (jianqi.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\n\nif (stacks > 0) {\n    const ratio = Number(thisEffect.getFlag(\"xjzl-system\", \"damageRatio\")) || 1;\n    const dmg = stacks * ratio;\n    \n    // 流失气血 (真实伤害，忽略防御)\n    // 由于是“流失”，通常使用 poison 或 liushi 类型，且 ignoreDefense=true\n    await args.attacker.applyDamage({\n        amount: dmg,\n        type: \"liushi\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(`剑身反震：对方流失 ${dmg} 气血`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "衍兵神剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>以手中剑幻化千万种兵器，与破尽万法的《独孤剑诀》可谓是正相反的武学。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>太极</p><p>注：该套路造成伤害时，受伤者将使用其内外防中较低的一项来结算伤害，而不是根据伤害类型。</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "随心万变",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑化万千，获得“衍兵-【武器类型】”，持续到战斗脱离。</p><p><strong>衍兵-【武器类型】：</strong>你手中的剑视为任意一种你选择的武器类型，且《衍兵神剑》视为需求该武器类型的套路。</p><p>·你可以再次释放此招，重新选择衍兵的武器。</p><p><strong>升级：</strong>内力消耗-10。</p>",
                    "automationNote": "手动选择类型。应用AE记录类型。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            40,
                            30,
                            20,
                            10
                        ]
                    },
                    "scripts": [
                        {
                            "label": "选择衍兵类型",
                            "trigger": "hit",
                            "script": "const types = {\n    \"blade\": \"刀\",\n    \"staff\": \"棍\",\n    \"dagger\": \"匕首\",\n    \"hidden\": \"暗器\",\n    \"unarmed\": \"徒手\",\n    \"instrument\": \"乐器\",\n    \"special\": \"奇门\"\n};\n\nlet content = `<form><div class=\"form-group\"><label>选择武器类型:</label><select name=\"wType\">`;\nfor (let [k, v] of Object.entries(types)) {\n    content += `<option value=\"${k}\">${v}</option>`;\n}\ncontent += `</select></div></form>`;\n\nconst newType = await foundry.applications.api.DialogV2.prompt({\n    window: { title: \"衍兵变形\" },\n    content: content,\n    ok: { callback: (event, button) => new FormData(button.form).get(\"wType\") }\n});\n\nif (newType) {\n    // 移除旧状态\n    const oldEff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yanbing\");\n    if (oldEff) await oldEff.delete();\n\n    const eff = {\n        name: `衍兵-${types[newType]}`,\n        icon: \"icons/weapons/swords/sword-guard-flanged-purple.webp\",\n        flags: {\n            \"xjzl-system\": {\n                slug: \"yanbing\",\n                wuxue_yanbingType: newType // 记录类型供脚本读取\n            }\n        }\n    };\n    \n    // 记录变换次数 (用于大招)\n    let changeCount = actor.getFlag(\"xjzl-system\", \"wuxue_yanbingChangeCount\") || 0;\n    await actor.setFlag(\"xjzl-system\", \"wuxue_yanbingChangeCount\", changeCount + 1);\n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(`手中剑已衍化为: ${types[newType]}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "均齐通一",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>与万物共生，与万物为一，开启架招。格挡成功后，若对方使用的武器和你具有的“衍兵-【武器类型】”相同，则对方此次攻击失去他手中武器提供的武器效果和伤害加成。</p><p><strong>升级：</strong>格挡值+10，消耗+4。</p>",
                    "automationNote": "武器类型判定困难，仅做提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "同兵器提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst yanbing = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yanbing\");\nif (yanbing) {\n    const type = yanbing.getFlag(\"xjzl-system\", \"wuxue_yanbingType\");\n    ui.notifications.info(`当前衍兵类型: ${type}。若攻击者使用相同类型武器，其武器加成无效（请手动减免伤害）。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无定风波",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑无定型，肆意挥洒，对目标造成伤害。击破架招时，目标陷入“禁足”“缚身”两回合。</p><p>·若对方使用的武器和你具有的“衍兵-【武器类型】”相同，此招式虚招值+2</p><p><strong>升级：</strong>招式伤害+10，虚招值再+1，内力消耗+4。</p>",
                    "automationNote": "击破后施加状态自动。虚招值加成需手动（或脚本提示）。低防结算自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "低防结算",
                            "trigger": "preDamage",
                            "script": "// 衍兵神剑通用特性：取低防\nconst defWai = args.target.system.combat.defWaigongTotal || 0;\nconst defNei = args.target.system.combat.defNeigongTotal || 0;\nconst lower = Math.min(defWai, defNei);\n// 逻辑：设置无视防御，然后手动减去较低的那个防御值\nargs.config.ignoreDefense = true;\nargs.config.amount = Math.max(1, args.config.amount - lower);",
                            "active": true
                        },
                        {
                            "label": "虚招加成提示",
                            "trigger": "calc",
                            "script": "const yanbing = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yanbing\");\nif (yanbing) {\n    const type = yanbing.getFlag(\"xjzl-system\", \"wuxue_yanbingType\");\n    // 基础虚招成长 (Lv-1)\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = (lvl - 1);\n    args.output.feint += bonus;\n    args.output.bonusDesc.push(`升级虚招加值 +${bonus}`);\n    args.output.bonusDesc.push(`若敌方武器为 [${type}]，虚招值额外+2 (未计入面板)`);\n}",
                            "active": true
                        },
                        {
                            "label": "击破状态",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const root = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"root\"));\n    const bind = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"fushen\"));\n    root.duration = { rounds: 2 };\n    bind.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, root);\n    await game.xjzl.api.effects.addEffect(args.target, bind);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "彼我无端",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>唤出万千兵器幻影，轰击而出，造成伤害。</p><p>·本次战斗中，你每使用【随心万变】改变过一次“衍兵-【武器类型】”，招式伤害+10。</p><p>·若你攻击的目标使用的武器和你具有的“衍兵-【武器类型】”相同，则招式必定暴击。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "伤害加成自动（读取Flag）。同武器必暴击需手动（脚本提示）。低防结算自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "低防结算",
                            "trigger": "preDamage",
                            "script": "const defWai = args.target.system.combat.defWaigongTotal || 0;\nconst defNei = args.target.system.combat.defNeigongTotal || 0;\nconst lower = Math.min(defWai, defNei);\nargs.config.ignoreDefense = true;\nargs.config.amount = Math.max(1, args.config.amount - lower);",
                            "active": true
                        },
                        {
                            "label": "变幻加伤",
                            "trigger": "calc",
                            "script": "const count = actor.getFlag(\"xjzl-system\", \"wuxue_yanbingChangeCount\") || 0;\nconst bonus = count * 10;\nargs.output.damage += bonus;\nargs.output.bonusDesc.push(`变幻加伤 (${count}次) +${bonus}`);",
                            "active": true
                        },
                        {
                            "label": "暴击提示",
                            "trigger": "attack",
                            "script": "const yanbing = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yanbing\");\nif (yanbing) {\n    const type = yanbing.getFlag(\"xjzl-system\", \"wuxue_yanbingType\");\n    ui.notifications.info(`当前衍兵: ${type}。若敌方武器相同，请手动勾选 [强制暴击] 或 [手动修正]。`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "无剑式",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>《无剑式》并非不用剑的剑法，而是无内力的剑法，创立者以偏门运气，将内力藏于全身，虽丹田中再无内力，但剑法却无中生有地产生了气劲。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "无有剑",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑锋似有似无，开启架招，格挡成功时，可以消耗自身最多 20 点内力，使对方流失等额的内力。</p><p>·开启此架招时，若你没有内力，获得“无始”状态，持续到战斗脱离。</p><p><strong>无始：</strong>你可以消耗反应动作和无始，回复最大内力的 20%。</p><p><strong>升级：</strong>格挡值+10，可以消耗的内力上限+10。</p>",
                    "automationNote": "开启检测无内力自动。格挡吸内手动（提示）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无内获无始",
                            "trigger": "attack",
                            "script": "if (actor.system.resources.mp.value <= 0) {\n    const eff = thisItem.effects.getName(\"无始\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"丹田空虚，领悟 [无始]！\");\n}",
                            "active": true
                        },
                        {
                            "label": "格挡消内",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst maxBurn = 20 + (lvl - 1) * 10;\nui.notifications.info(`格挡成功！可手动扣除自身最多 ${maxBurn} 内力，使对方流失等额内力。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "似非剑",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作施展此招，剑锋无处可寻，直击目标，压制对方虚招，对目标造成伤害。</p><p>·若你没有内力，则招式的伤害无视目标格挡值与内外功防御，且暴击骰-1。</p><p><strong>升级：</strong>招式伤害+10，暴击骰再-1。</p>",
                    "automationNote": "无内加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无内加成",
                            "trigger": "attack",
                            "script": "if (actor.system.resources.mp.value <= 0) {\n    // 暴击骰修正\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const critBonus = 1 + (lvl - 1);\n    args.flags.critThresholdMod += critBonus;\n}",
                            "active": true
                        },
                        {
                            "label": "无内穿透",
                            "trigger": "preDamage",
                            "script": "if (actor.system.resources.mp.value <= 0) {\n    args.config.ignoreBlock = true;\n    args.config.ignoreDefense = true;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无极剑",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑意无限，自无到有，对敌人造成伤害。</p><p>·若你没有内力，则招式施展距离变为 20。</p><p><strong>升级：</strong>招式伤害+10。</p>",
                    "automationNote": "无内距离增加需手动（无法动态修改UI）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "距离提示",
                            "trigger": "calc",
                            "script": "if (actor.system.resources.mp.value <= 0) {\n    args.output.bonusDesc.push(\"无内力：距离提升至 20米\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "始终剑",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑贯始终，消耗最大内力的 20%，获得“无终”状态，持续到战斗脱离。</p><p><strong>无终：</strong>你可以消耗主要动作和无终，回复自身最大气血 5%的气血，并获得等额的护体真气，持续到战斗脱离。</p><p><strong>升级：</strong>怒气消耗-1，回复气血增加 5%。</p>",
                    "automationNote": "消耗内力手动（脚本执行扣除）。获得无终自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            5,
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗内力获无终",
                            "trigger": "hit",
                            "script": "const maxMp = actor.system.resources.mp.max;\nconst burn = Math.floor(maxMp * 0.2);\nif (actor.system.resources.mp.value < burn) {\n    ui.notifications.warn(\"内力不足 20%，无法施展！\");\n    // 理想情况下应该在attack阻断，但这里是扣血逻辑，只能事后诸葛亮或者强制扣到0\n} \nawait actor.applyHealing({ amount: -burn, type: 'mp', showScrolling: true });\n\nconst eff = thisItem.effects.getName(\"无终\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 注入回复系数\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst healPct = 0.05 + (lvl - 1) * 0.05;\neff.flags[\"xjzl-system\"].wuxue_healPct = healPct;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "无始",
                    "icon": "icons/magic/time/clock-stop-watch-white.webp",
                    "description": "可消耗回复内力。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wushi",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "回复内力",
                                    "trigger": "passive",
                                    "active": false,
                                    "script": "// 这是一个占位，提示玩家：删除此BUFF时，手动回复 20% MaxMP"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "无终",
                    "icon": "icons/magic/life/cross-yellow-green.webp",
                    "description": "可消耗回复气血/护体。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuzhong",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "使用无终",
                                    "trigger": "passive",
                                    "active": false,
                                    "script": "// 这是一个占位，提示玩家：删除此BUFF时，手动回复 [Flags.wuxue_healPct * MaxHP]"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "覆雨神剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>创出剑法者，极情于剑，以剑入道，勘破生死之秘，传闻他破碎虚空而去。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>阴柔</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "明月犹存",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑而立，剑音渺渺，开启架招，格挡成功后，从“落雨”“听雨”“画雨”状态中，随机获得一个，持续到战斗脱离。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "格挡获状态自动（随机）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "随机状态",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst states = [\"落雨\", \"听雨\", \"画雨\"];\nconst pick = states[Math.floor(Math.random() * states.length)];\nconst eff = thisItem.effects.getName(pick).toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(`格挡领悟：${pick}`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "潮起潮落",
                    "type": "qi",
                    "actionType": "default",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "20米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>选择“落雨”“听雨”“画雨”中的一个状态消耗，将雨意化入天地，使周围 20 米范围内，产生相应的天候，持续一回合。</p><p><strong>弥天剑雨（落雨）：</strong>剑雨中的所有角色（包括自身），命中值-10。</p><p><strong>欺天剑雨（听雨）：</strong>剑雨中的所有角色（包括自身），虚招值-5。</p><p><strong>破天剑雨（画雨）：</strong>剑雨中的所有角色（包括自身），看破值-5。</p><p>（天候只可存在一个，新天候会替换旧天候）</p><p><strong>升级：</strong>持续回合数+1，消耗+4。</p>",
                    "automationNote": "消耗状态手动。天候光环效果手动（无法自动做区域光环）。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "选择消耗与提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst duration = 1 + (lvl - 1);\n\nconst content = `<form><div class=\"form-group\"><label>消耗状态:</label><select name=\"state\"><option value=\"落雨\">落雨 (弥天: 命中-10)</option><option value=\"听雨\">听雨 (欺天: 虚招-5)</option><option value=\"画雨\">画雨 (破天: 看破-5)</option></select></div></form>`;\n\nconst selection = await foundry.applications.api.DialogV2.prompt({\n    window: { title: \"潮起潮落\" },\n    content: content,\n    ok: { callback: (event, button) => new FormData(button.form).get(\"state\") }\n});\n\nif (selection) {\n    const eff = actor.effects.find(e => e.name === selection);\n    if (eff) {\n        await eff.delete();\n        await actor.setFlag(\"xjzl-system\", \"wuxue_fuyu_weather\", selection); // 记录天候类型\n        ui.notifications.info(`已消耗 [${selection}]，开启对应天候 (${duration}回合)。请手动给范围内角色添加Debuff。`);\n    } else {\n        ui.notifications.warn(`身上没有 [${selection}] 状态！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "彩云照影",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>斩出一道剑光，倏然炸开，化为无边剑雨，倾泄而下，而手中之剑，隐没于剑光之中，无迹可循，对目标造成伤害，击破架招时，根据天候产生以下效果：</p><p><strong>弥天剑雨：</strong>使目标流失 200 点气血。</p><p><strong>欺天剑雨：</strong>使目标陷入“眩晕”一回合。</p><p><strong>破天剑雨：</strong>使目标陷入“封招”“错骨”一回合。</p><p><strong>升级：</strong>招式伤害+10，消耗+4。</p>",
                    "automationNote": "天候效果自动（读取Flag）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "天候击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const weather = actor.getFlag(\"xjzl-system\", \"wuxue_fuyu_weather\");\n    if (weather === \"落雨\") {\n        await args.target.applyDamage({ amount: 200, type: \"liushi\", attacker: actor, isHit: true, ignoreDefense: true });\n        ui.notifications.info(\"弥天剑雨：流失 200 气血\");\n    } else if (weather === \"听雨\") {\n        const eff = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"xuanyun\"));\n        eff.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    } else if (weather === \"画雨\") {\n        const fz = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"fengzhao\"));\n        const cg = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"cuogu\"));\n        fz.duration = { rounds: 1 };\n        cg.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, fz);\n        await game.xjzl.api.effects.addEffect(args.target, cg);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "碧水难醉",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>寒芒暴涨，以奔雷逐电的速度，激射而来，对目标造成伤害。</p><p>根据天候产生以下效果：</p><p><strong>弥天剑雨：</strong>招式暴击伤害增加 50%。</p><p><strong>欺天剑雨：</strong>若击中无架招角色，使自身立刻不消耗速度闪身至 5 米外。</p><p><strong>破天剑雨：</strong>若击中无架招角色，使目标陷入“淹溺”状态，持续一回合。</p><p><strong>淹溺：</strong> 肺里灌满水，每回合末流失 50 点气血，并进行一次[韧性]检定（难度 20），成功则移除此状态，失败则下次检定难度-2。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "暴伤无法修改。欺天闪身手动。破天淹溺自动（AE脚本）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "天候效果",
                            "trigger": "hit",
                            "script": "const weather = actor.getFlag(\"xjzl-system\", \"wuxue_fuyu_weather\");\nif (weather === \"弥天剑雨\") {\n    // 系统暂不支持修改暴击倍率，仅提示\n    ui.notifications.info(\"弥天剑雨：若暴击，请手动结算额外 50% 伤害。\");\n} else if (args.isHit && !args.target.system.martial.stanceActive) {\n    if (weather === \"欺天剑雨\") {\n        ui.notifications.info(\"欺天剑雨：可立即闪身 5 米。\");\n    } else if (weather === \"破天剑雨\") {\n        const eff = thisItem.effects.getName(\"淹溺\").toObject();\n        delete eff._id;\n        eff.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雨落洞庭",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "20米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>将天空当中的无边剑雨引动，化为天地间无尽剑锋和气旋，对所有敌人造成伤害，并且根据引动的剑雨，产生额外效果：</p><p><strong>弥天剑雨：</strong>将全部敌人拉扯至剑雨的中心并击倒。</p><p><strong>欺天剑雨：</strong>使所有敌人流失 3 点怒气。</p><p><strong>破天剑雨：</strong>你可以消耗反应动作，对范围内所有敌人，分别施展一次【彩云照影】。</p><p><strong>升级：</strong>造成伤害+20，怒气消耗-1，消耗+16。</p>",
                    "automationNote": "拉扯击倒手动。怒气流失自动。连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "天候爆发",
                            "trigger": "hit",
                            "script": "const weather = actor.getFlag(\"xjzl-system\", \"wuxue_fuyu_weather\");\nif (weather === \"听雨\") {\n    // 欺天: 流失怒气\n    const oldRage = args.target.system.resources.rage.value;\n    const newRage = Math.max(0, oldRage - 3);\n    await args.target.update({\"system.resources.rage.value\": newRage});\n    ui.notifications.info(`${args.target.name} 流失 3 点怒气`);\n} else if (weather === \"落雨\") {\n    ui.notifications.info(\"弥天剑雨：请手动拉扯并击倒敌人。\");\n} else if (weather === \"画雨\") {\n    ui.notifications.info(\"破天剑雨：可追加施展 [彩云照影]。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "落雨",
                    "icon": "icons/magic/water/weather-rain-clouds-blue.webp",
                    "description": "覆雨神剑状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "luoyu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "听雨",
                    "icon": "icons/magic/water/weather-storm-clouds-blue.webp",
                    "description": "覆雨神剑状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tingyu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "画雨",
                    "icon": "icons/magic/water/weather-cloud-ice.webp",
                    "description": "覆雨神剑状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huayu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "淹溺",
                    "icon": "icons/magic/water/bubbles-air-blue.webp",
                    "description": "每回合流失气血，需检定移除。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yanni",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "淹溺结算",
                                    "trigger": "turnEnd",
                                    "active": true,
                                    "script": "// 流失气血\nawait actor.applyDamage({ amount: 50, type: \"liushi\", isHit: true, ignoreDefense: true });\n\n// 韧性检定 (难度20)\nconst dc = 20;\n// 读取上次失败积累的难度减免\nconst reduce = actor.getFlag(\"xjzl-system\", \"wuxue_yanniReduce\") || 0;\nconst finalDc = dc - reduce;\n\nawait Macros.requestSave({\n    target: actor,\n    type: \"renxing\",\n    dc: finalDc,\n    label: \"淹溺挣扎\",\n    onFail: [], // 失败不加状态，而是改 Flag\n});\n// 注意：requestSave 无法直接回调 JS 逻辑，只能让玩家看到结果手动删 BUFF\n// 这里只能做到提示。\nui.notifications.info(`淹溺生效：流失 50 气血。请进行韧性检定(DC ${finalDc})，成功则手动移除本BUFF。`);"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]