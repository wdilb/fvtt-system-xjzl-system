[
    {
        "name": "拖山扁",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>脚夫在抱团取暖的过程中形成了一个松散的集体，创造出了适合扁担的粗浅套路。</p><p><strong>需求：</strong>棍-长棍</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长棍",
            "moves": [
                {
                    "name": "撑山起货",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双手撑起扁担，开启架招。若格挡成功后陷入濒死状态，你额外获得 1 点怒气。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "濒死回怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死回怒",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.isDying) {\n    await actor.update({ \"system.resources.rage.value\": actor.system.resources.rage.value + 1 });\n    ui.notifications.info(\"撑山起货：濒死获得 1 点怒气\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "力拔山兮",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "环境/自身",
                    "actionCost": "主要动作",
                    "description": "<p>屈膝甩扁，将自身周围 1 米范围内的至多一件重物（如货箱、麻袋）挑起，然后你获得一层“撑山”，持续到战斗脱离。</p><p><strong>撑山：</strong>每层使你的格挡值+5，内外功防御+5。</p><p>·每件重物的重量不可超过你自身体重的一半。</p><p>·你每受到两次招式攻击，会有一件重物散落在自身空格处，无法再挑起，然后移除一层“撑山”。</p><p><strong>升级:</strong>可以多挑起一件重物、并再获得一层撑山，内力消耗+1。</p>",
                    "automationNote": "获得撑山自动。掉落手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得撑山",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"撑山\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\neff.flags[\"xjzl-system\"].maxStacks = stacks;\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "山河异位",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>拖起扁担抡向目标，造成伤害。</p><p>若你所处的空格处有散落的重物，还可撬起零散重物砸击目标，使招式伤害+10。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "重物加伤弹窗询问。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "重物加伤",
                            "trigger": "attack",
                            "script": "const confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"山河异位\" },\n    content: \"<p>脚下是否有散落的重物？</p>\",\n    yes: { label: \"有 (+10伤害)\" },\n    no: { label: \"无\" }\n});\nif (confirm) {\n    args.flags.damageResult.damage += 10;\n    args.flags.damageResult.breakdown += \"\\n+ 重物砸击: 10\";\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "山倾倒海",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>倾斜扁担，敲击敌人造成伤害。</p><p>·若你存在“撑山”，还会连带将重物滑落向目标，每件重物使招式伤害+10 并将其砸倒地。</p><p>·这些重物散落在目标空格处，无法再挑起，然后移除自身所有的“撑山”。</p><p><strong>升级:</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "消耗撑山加伤自动。击倒、重物散落手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "撑山爆发",
                            "trigger": "attack",
                            "script": "const chengshan = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chengshan\");\nif (chengshan) {\n    const stacks = chengshan.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 撑山(${stacks}层): ${bonus}`;\n    await chengshan.delete();\n    ui.notifications.info(\"撑山效果已移除\");\n}",
                            "active": true
                        },
                        {
                            "label": "击倒提示",
                            "trigger": "hit",
                            "script": "if (args.damageResult.baseDamage > 0 && args.isHit) {\n    ui.notifications.info(\"若消耗了重物，请手动将目标 [击倒]\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "撑山",
                    "icon": "icons/commodities/materials/crate-wood.webp",
                    "description": "格挡+5，双防+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chengshan",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "十字棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>因掷出时的十字架势得名，追逃打时很有用。</p><p><strong>需求：</strong>棍</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍",
            "moves": [
                {
                    "name": "甩棍留情",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>回旋掷棍对目标造成伤害，然后棍棒弹回自己手中，并给目标添加一层“留情”，至多三层，持续到脱战。</p><p><strong>留情：</strong>每层使你速度-1，叠加三层后，移除所有留情，变为“禁足”，持续一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "留情叠加/转化禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "留情叠加",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const target = args.target;\n    const existing = target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"liuqing\");\n    const currentStacks = existing ? (existing.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\n    if (currentStacks >= 2) {\n        if (existing) await existing.delete();\n        const rootEff = CONFIG.statusEffects.find(e => e.id === \"root\");\n        if (rootEff) {\n            const data = foundry.utils.deepClone(rootEff);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(target, data);\n            ui.notifications.info(`${target.name} 留情满层，转化为 [禁足]`);\n        }\n    } else {\n        const eff = thisItem.effects.getName(\"留情\").toObject();\n        await game.xjzl.api.effects.addEffect(target, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "其乐融融",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>吐棍伐敌，劲扫目标造成伤害，击破架招时可击倒目标。</p><p>若有敌人在你周身 3 米范围半空中，可消耗反应动作释放此招，飞身（半空中）击敌造成伤害，若击破架招，将其击打坠地。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破击倒/坠地手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击倒提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`击破架招！请手动将 ${args.target.name} [击倒/坠地]`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无花无酒",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破对方虚招后，消耗反应动作施展，压制对方虚招，无欲无求，挑棍攻击目标造成伤害。若目标无架招，则被你击飞 1 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击飞手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (!args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 无架招，被击飞 1 米`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "十字销魂",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>旋转棍影，对周围范围敌方造成伤害。招式可以击飞正处于“留情”状态的目标 1 米。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "留情击飞手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "留情击飞",
                            "trigger": "hit",
                            "script": "const hasLiuqing = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"liuqing\");\nif (hasLiuqing) {\n    ui.notifications.info(`${args.target.name} 处于留情状态，被击飞 1 米`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "留情",
                    "icon": "icons/magic/movement/trail-streak-impact-blue.webp",
                    "description": "速度-1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "liuqing",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "驱蛇棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>原为丐帮棍法，后因民间四处捕蛇，此武学便被允许传至江湖，以防止普通侠客被咬伤。</p><p><strong>需求：</strong>棍</p><p><strong>属性：</strong>柔</p>",
            "requirements": "棍",
            "moves": [
                {
                    "name": "投石问路",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>棍点地面，开启架招。架招持续期间，[韧性]等级+1。</p><p><strong>升级：</strong>格挡值+5，韧性+1，内力消耗+1。</p>",
                    "automationNote": "韧性提升自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得加成",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"投石问路\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.changes[0].value = String(1 + (lvl - 1));\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "打草惊蛇",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>戳棍向前，对直线上的敌人造成伤害，每击破一个敌人的架招，便获得一层“莲花真气”，至多三层，持续到战斗脱离。</p><p><strong>莲花真气：</strong>每层使你内功命中+5。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "击破获气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获气",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"莲花真气\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拨草寻蛇",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>左拨右打，对目标造成伤害，击中无架招目标时，如果你自身无架招，立即施展【投石问路】（无视被破防后一回合内无法开启架招的效果）。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "自动施展提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "触发架招",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive && !actor.system.martial.stanceActive) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><div class=\"card-header\"><b>拨草寻蛇 - 追击</b></div><div style=\"padding:5px;\">满足条件，请免费施展 <b>【投石问路】</b></div></div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "七寸打蛇",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>击向目标颈部，造成伤害。</p><p>·每消耗一层莲花真气，击飞目标 1 米。</p><p>·当你被击破架招时，可消耗反应动作释放此招。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "消耗真气击飞弹窗询问。反应施展手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗真气",
                            "trigger": "attack",
                            "script": "const zhenqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"lianhuazhenqi\");\nif (zhenqi) {\n    const stacks = zhenqi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"七寸打蛇\" },\n        content: `<p>当前有 ${stacks} 层莲花真气。</p><p>是否全部消耗以击飞目标？</p>`,\n        yes: { label: \"消耗\" },\n        no: { label: \"不消耗\" }\n    });\n    if (confirm) {\n        await zhenqi.delete();\n        ui.notifications.info(`已消耗 ${stacks} 层真气，请手动击飞目标 ${stacks} 米`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "投石问路",
                    "icon": "icons/magic/nature/root-vine-thorn-spikes.webp",
                    "description": "韧性等级提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "toushiwenlu",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.skills.renxing.mod",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "莲花真气",
                    "icon": "icons/magic/nature/lotus-pink.webp",
                    "description": "内功命中+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lianhuazhenqi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "阴风棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>左道入门棍法，挥舞间阴风阵阵，勾魂摄魄。</p><p><strong>需求：</strong>棍-短棍</p><p><strong>属性：</strong>阴</p>",
            "requirements": "棍-短棍",
            "moves": [
                {
                    "name": "阴风乍起",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>棍扫敌人双腿，造成伤害，击破架招使目标下盘不稳，持续一回合。同时自身获得一层“黄泉气”，可叠加，持续到战斗脱离。</p><p><strong>黄泉气：</strong>每层使你的格挡值+1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破施加下盘不稳自动。获气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果应用",
                            "trigger": "hit",
                            "script": "const hq = thisItem.effects.getName(\"黄泉气\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, hq);\n\nif (args.isBroken) {\n    const unstable = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if (unstable) {\n        const data = foundry.utils.deepClone(unstable);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "秋水无皱",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>短棍静止，如图如画，开启架招。被击破架招时，获得一层“黄泉气”。</p><p><strong>升级：</strong>格挡值+5，获得黄泉气+1 层，消耗+1。</p>",
                    "automationNote": "被破获气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被破获气",
                            "trigger": "damaged",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const stacks = 1 + (lvl - 1);\n    const hq = thisItem.effects.getName(\"黄泉气\").toObject();\n    for(let i=0; i<stacks; i++) {\n        await game.xjzl.api.effects.addEffect(actor, hq);\n    }\n    ui.notifications.info(`架招被破，获得 ${stacks} 层黄泉气`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "棍锁生魂",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，飞棍而出，击中敌人面门后弹回，造成伤害。</p><p>可消耗一层“黄泉气”，使对方流失 10 点气血。</p><p><strong>升级：</strong>招式伤害+5，流失气血+5，内力消耗+1。</p>",
                    "automationNote": "消耗黄泉气流失血弹窗询问。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗黄泉气",
                            "trigger": "hit",
                            "script": "const hq = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huangquanqi\");\nif (hq) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"棍锁生魂\" },\n        content: \"<p>是否消耗 1 层黄泉气使目标流失气血？</p>\",\n        yes: { label: \"消耗\" },\n        no: { label: \"否\" }\n    });\n    if (confirm) {\n        await game.xjzl.api.effects.removeEffect(actor, \"huangquanqi\", 1);\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const loss = 10 + (lvl - 1) * 5;\n        await args.target.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n        ui.notifications.info(`${args.target.name} 流失 ${loss} 气血`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无常索命",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>棍扫目标全身，对其造成伤害。</p><p>·每消耗 1 层黄泉气，使自己和目标同时流失 10 点气血。（至多三层）</p><p><strong>升级：</strong>招式伤害+10，消耗黄泉气上限+1，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "消耗黄泉气流失血弹窗询问。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "爆发",
                            "trigger": "hit",
                            "script": "const hq = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huangquanqi\");\nif (hq) {\n    const stacks = hq.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const limit = 3 + (lvl - 1);\n    const maxUse = Math.min(stacks, limit);\n    \n    // 询问消耗层数\n    const use = await foundry.applications.api.DialogV2.prompt({\n        window: { title: \"无常索命爆发\" },\n        content: `<p>当前可用黄泉气: ${maxUse} 层</p><p>请输入消耗层数 (每层使双方流失10气血):</p><input type=\"number\" name=\"num\" value=\"${maxUse}\" min=\"0\" max=\"${maxUse}\">`,\n        ok: { callback: (e, b) => parseInt(b.form.elements.num.value) || 0 }\n    });\n    \n    if (use > 0) {\n        await game.xjzl.api.effects.removeEffect(actor, \"huangquanqi\", use);\n        const loss = use * 10;\n        await actor.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n        await args.target.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n        ui.notifications.info(`双方各流失 ${loss} 气血`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "黄泉气",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "格挡+1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huangquanqi",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "小自在棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖杂耍把式，看似花哨好看，实则不堪大用，倒是登徒浪子极爱使用。</p><p><strong>需求：</strong>棍-短棍</p><p><strong>属性：</strong>柔</p>",
            "requirements": "棍-短棍",
            "moves": [
                {
                    "name": "棍挑落花",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>攻击目标衣衫，造成伤害，击破架招时解开目标上衣，使其袒胸露乳。（失去上衣效果，需要花费一个主要动作穿好）</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破提示卸甲。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "卸甲提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`击破架招！请提示 ${args.target.name} [上衣]失效`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "自在逍遥",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>肩扛短棍，开启架招。格挡成功时，获得一层“乘风”，至多三层，持续到战斗脱离。</p><p><strong>乘风：</strong>每层使你速度+1。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获风",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"乘风\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "飞棍引吭",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>将棍子高高扔起，飞身跃起接住(半空中)，砸向目标头冠，造成伤害。击中无架招目标时，打歪目标头冠。（失去头饰效果，需要花费一个主要动作穿好）</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中提示卸头饰。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "打歪头冠",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被打歪头冠，[头饰]失效`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "棍出如枪",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，撩其腰部，造成伤害，击中无架招目标可击落目标下衣。（失去下衣效果，需要花费一个主要动作穿好）</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中提示卸下衣。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击落下衣",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击落 [下衣]，下衣失效`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "乘风",
                    "icon": "icons/magic/air/wind-weather-snow-gusts.webp",
                    "description": "速度+1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chengfeng",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "降龙棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>由万佛寺罗汉棍演变而来，棍法天赋出众的江湖人多修习此棍法入门。</p><p><strong>需求：</strong>棍-长棍</p><p><strong>属性：</strong>阳</p>",
            "requirements": "棍-长棍",
            "moves": [
                {
                    "name": "佛心如天",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "空地",
                    "actionCost": "次要动作",
                    "description": "<p>将长棍高高抛至半空中，长棍将在下回合初在该空格落下。</p><p>·该空格处的人如果处于空手状态，可以花费反应动作接住此棍，且他那回合的棍法招式伤害+5。</p><p>·若无人接住长棍，长棍落在地上，需花费主要动作捡起。</p><p><strong>升级:</strong>接住长棍增加的棍法伤害+5，内力消耗+1。</p>",
                    "automationNote": "完全手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "化木入凡",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持棍住地，开启架招。被击破架招时，获得“化木入凡”：外功防御+10，陷入禁足，持续一回合。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "被破加状态自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被破化木",
                            "trigger": "damaged",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"化木入凡\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "当头棒喝",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持棍敲击，造成伤害，击中无架招的目标时，其周围 1 米的其他敌方角色流失 10 点气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "AOE流失血提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "溅射提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`命中无架招目标！请手动使目标周围1米敌人流失 10 气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "罗汉垂钓",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>缓缓跃至半空中，若有角色消耗反应对你进行攻击，则立刻跃至目标身边空格，打断攻击并对其造成伤害，同时将其击倒。</p><p><strong>升级:</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "触发条件判断手动。击倒提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击倒提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) ui.notifications.info(\"请手动 [击倒] 目标\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "化木入凡",
                    "icon": "icons/magic/nature/root-vine-tree-brown.webp",
                    "description": "外防+10，禁足。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huamurufan",
                            "stackable": false
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "flags.xjzl-system.forceSpeedZero",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "五祖枪法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>又名父子枪法，父子齐用，威力无穷，后世洪熙官以此闻名。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>柔</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "父子同心",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>长枪连刺，造成伤害。</p><p>·若目标本回合被《五祖枪法》命中过，你本次出招暴击骰-1。</p><p><strong>升级：</strong>招式伤害+5，暴击骰再-1，内力消耗+1。</p>",
                    "automationNote": "本回合命中检测询问。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连击检测",
                            "trigger": "attack",
                            "script": "const confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"父子同心\" },\n    content: \"<p>目标本回合是否已被《五祖枪法》命中？</p>\",\n    yes: { label: \"是 (暴击-1)\" },\n    no: { label: \"否\" }\n});\nif (confirm) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = 1 + (lvl - 1);\n    args.flags.critThresholdMod += bonus;\n    ui.notifications.info(`暴击阈值 -${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "儿子哎～",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>高喊招式名称，开启架招。</p><p>施展此招后若立即有其他人回应“爹～”（即施展【爹～】），架招提供的格挡值翻倍。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "手动配合。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "爹～",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当有其他人施展【儿子哎～】的时候，可以消耗反应动作释放，大声喊出招式名字，获得“同心”，持续一回合。</p><p><strong>同心：</strong>施展《五祖枪法》命中+5，招式伤害+5。</p><p><strong>升级：</strong>命中再+5，伤害再+5，内力消耗+1。</p>",
                    "automationNote": "获得同心自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得同心",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"同心\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst val = 5 + (lvl - 1) * 5;\n// 修改伤害和命中\neff.changes[0].value = String(val);\neff.changes[1].value = String(val);\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "其利断金",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>钢枪飞旋，对目标造成伤害。</p><p>·若目标本回合被【其利断金】击中过，本次出招可移除目标身上任意一个状态。</p><p><strong>升级：</strong>招式伤害+10，移除状态数量+1，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "连击判断移除状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连击提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"其利断金\" },\n        content: \"<p>目标本回合是否已被【其利断金】命中？</p>\",\n        yes: { label: \"是 (移除状态)\" },\n        no: { label: \"否\" }\n    });\n    if (confirm) {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const count = 1 + (lvl - 1);\n        ui.notifications.info(`请手动移除目标 ${count} 个状态`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "同心",
                    "icon": "icons/magic/life/heart-glow-red.webp",
                    "description": "五祖枪法命中/伤害提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tongxin",
                            "stackable": false
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "温侯戟法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>挥舞方天画戟的武学，据说流传自三国时期的吕温侯，真伪莫辨，但即便寥寥数招，已经威力绝伦。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>太极</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "睹微知著",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>眼观六路，开启架招。格挡成功时，获得一层“养血”，至多三层，持续到战斗脱离。</p><p><strong>养血：</strong>每层使你回合末回复 10 点气血。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获血自动(系统通用养血)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡养血",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = CONFIG.statusEffects.find(e => e.id === \"yangxue\");\nif (eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.flags[\"xjzl-system\"].maxStacks = 3;\n    await game.xjzl.api.effects.addEffect(actor, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "饥附饱飏",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>画戟击地，乌光翻慑，造成伤害，击破架招后，在本整轮结束后，将自己的先攻顺序提高一位。（按先攻排列）</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破提速手动调整战斗追踪器。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提速提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) ui.notifications.info(\"击破架招！请在回合结束后手动提高先攻顺序\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "八面临风",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "4米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>狂舞画戟，霸气四溢，对周身范围内所有敌人造成伤害，击退所有无架招的目标到招式范围外。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击退至 4 米外`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万夫莫敌",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "25米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>咆哮大喝，与范围内所有敌人进行一次[定力]对抗，若敌人失败，则为其添加状态“畏惧”，持续一回合。</p><p><strong>畏惧：</strong>你无法对给你添加此状态的目标进行普通攻击。你被他攻击时，内外功防御归零。</p><p><strong>升级：</strong>持续回合数+1，[定力]对抗结果+2，内力消耗+4。</p>",
                    "automationNote": "对抗请求自动。畏惧状态自动（需物品内有对应AE）。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "发起对抗",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\n// 尝试获取物品内的特效，如果没有则只显示文本\nconst fearEffect = thisItem.effects.getName(\"畏惧\");\n\nawait Macros.requestContest({\n    attacker: actor,\n    defender: args.target,\n    type: \"dingli\",\n    defType: \"dingli\",\n    label: \"万夫莫敌 - 定力对抗\",\n    outcome: {\n        win: {\n            text: \"目标心生畏惧！\",\n            targetEffect: fearEffect ? fearEffect.toObject() : null\n        },\n        lose: {\n            text: \"目标意志坚定，不受影响。\"\n        }\n    }\n});",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "畏惧",
                    "icon": "icons/magic/control/fear-fright-white.webp",
                    "description": "无法普攻来源，被来源攻击无视防御。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "weiju",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "无视防御",
                                    "trigger": "preDefense",
                                    "active": true,
                                    "script": "// 检查攻击者是否是施加该状态的人 (origin)\nconst originUuid = thisEffect.origin;\nif (originUuid) {\n    const originDoc = await fromUuid(originUuid);\n    const sourceActor = originDoc?.actor || originDoc;\n    if (sourceActor && args.attacker.uuid === sourceActor.uuid) {\n        args.config.ignoreDefense = true;\n        ui.notifications.info(\"畏惧生效：无视防御\");\n    }\n}"
                                }
                            ]
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "桓侯八枪",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>相传为三国时名将张飞所创，以其谥号命名。枪法严密规整，却又带着沙场冲杀的豪气。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>阳</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "一马当先",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>举枪前冲，一往无前，不消耗速度移动到目标空格，对直线路径上的敌人造成伤害，若目标无架招，则将其击退至冲锋终点空格周围一米随机格子处。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "位移、击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击退 (随机1米)`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛇矛点头",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>抬枪虚点，轻重难测，对敌人造成伤害，若击破架招，则使目标陷入“禁足”状态，持续一回合。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一夫当关",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>横枪立马，势当千军，开启架招。架招持续期间，若有敌人在你周围 1 米内结束回合，你可以消耗反应动作使其流失 10 气血并击退 1 米。</p><p><strong>升级:</strong>格挡值+5，流失气血+10，内力消耗+1。</p>",
                    "automationNote": "手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "燕人还首",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作施展此招，压制对方虚招，枪出如乌龙，造成伤害。可以选择不对敌人造成伤害，而是以枪刃卡住敌人兵器，使其当前装备的武器脱手并甩飞到周围 3 米中的空格中。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "出招时询问击落武器。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "选择效果",
                            "trigger": "attack",
                            "script": "const confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"燕人还首\" },\n    content: \"<p>选择效果：</p>\",\n    yes: { label: \"造成伤害\" },\n    no: { label: \"击落武器 (伤害归零)\" }\n});\nif (!confirm) {\n    args.flags.damageResult.damage = 0;\n    args.flags.damageResult.breakdown += \"\\n- 选择击落武器: 伤害归零\";\n    ui.notifications.info(\"请手动处理 [击落武器]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "喝断当阳",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>怒目横矛，声如虎豹，范围内所有敌人进行[定力]检定（难度 14），若失败则受到 10 点精神伤害，并且获得“破胆”状态，持续三回合。</p><p><strong>破胆：</strong>无法通过消耗移动速度向状态施加者靠近。</p><p><strong>升级:</strong>难度+1，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "对抗、伤害、状态施加自动。移动限制手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "定力对抗",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 14 + (lvl - 1);\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: dc,\n    label: \"抵抗喝断\",\n    damageOnFail: {\n        value: 10,\n        type: \"mental\"\n    },\n    onFail: [\n        thisItem.effects.getName(\"破胆\").toObject()\n    ]\n});",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "破胆",
                    "icon": "icons/magic/control/fear-fright-monster-purple.webp",
                    "description": "无法靠近施加者。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "podan",
                            "stackable": false
                        }
                    },
                    "duration": {
                        "rounds": 3
                    },
                    "changes": []
                },
                {
                    "name": "精神伤害",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "瞬间受到10点精神伤害。",
                    "transfer": false,
                    "duration": {
                        "turns": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "mental_dmg",
                            "scripts": [
                                {
                                    "label": "造成伤害",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "await actor.applyDamage({ amount: 10, type: \"mental\", ignoreDefense: true, isHit: true });\nawait thisEffect.delete();"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "泼水杖法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>杖法取自泼水不进之意，棍法迅猛，劲道十足，声势凌厉。</p><p><strong>需求：</strong>棍-长棍</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长棍",
            "moves": [
                {
                    "name": "水泼不进",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>快速旋转挥舞长杖，开启架招。格挡 3 米内的攻击成功后，可击退目标 1 米，自身不耗速度后退 1 米。</p><p>·格挡超过 3 米以外的攻击时，减免 5 点伤害。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "远程减伤自动。近战击退手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "远程减伤",
                            "trigger": "preTake",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst t1 = actor.token?.object || actor.getActiveTokens()[0];\nconst t2 = args.attacker.token?.object || args.attacker.getActiveTokens()[0];\nif (t1 && t2) {\n    const dist = canvas.grid.measureDistance(t1.center, t2.center);\n    if (dist > 3) {\n        args.output.damage = Math.max(0, args.output.damage - 5);\n        ui.notifications.info(\"水泼不进：远程减伤 5\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "近战击退",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst t1 = actor.token?.object || actor.getActiveTokens()[0];\nconst t2 = args.attacker.token?.object || args.attacker.getActiveTokens()[0];\nif (t1 && t2) {\n    const dist = canvas.grid.measureDistance(t1.center, t2.center);\n    if (dist <= 3) {\n        ui.notifications.info(\"水泼不进：请手动 [击退目标] 并 [后退]\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "避水翻身",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时反应动作释放，压制目标虚招，不消耗速度闪至目标身侧空格，伸棍扫击，对目标造成伤害，并且将击倒目标。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击倒提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击倒提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) ui.notifications.info(`${args.target.name} 被击倒`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万里石堤",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>疯狂挥舞铁杖，杖舞密不透风，对目标造成伤害，若击中无架招目标，则击倒目标。</p><p>·若目标处于倒地，招式暴击骰-1。</p><p><strong>升级：</strong>招式伤害+5，暴击骰再-1，内力消耗+1。</p>",
                    "automationNote": "倒地暴击自动。击倒提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "倒地易暴",
                            "trigger": "attack",
                            "script": "const isProne = args.attacker.targets.first()?.actor?.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"prone\");\nif (isProne) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = 1 + (lvl - 1);\n    args.flags.critThresholdMod += bonus;\n}",
                            "active": true
                        },
                        {
                            "label": "击倒提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击倒`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "江河倒灌",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>借势而击，铁杖轰然而下，砸向目标，对目标造成伤害。</p><p>若目标处于倒地状态，则击飞目标，并给自身添加“波返”状态，持续三回合。</p><p><strong>波返：</strong>闪避+5，成功闪避敌人招式时，可以将目标反震倒地。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "倒地获波返自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获波返",
                            "trigger": "hit",
                            "script": "const isProne = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"prone\");\nif (isProne) {\n    ui.notifications.info(`${args.target.name} 被击飞`);\n    const eff = thisItem.effects.getName(\"波返\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "波返",
                    "icon": "icons/magic/water/wave-water-blue.webp",
                    "description": "闪避+5，闪避反震倒地。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bofan",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "闪避反震",
                                    "trigger": "avoided",
                                    "active": true,
                                    "script": "ui.notifications.info(`波返触发：请手动将 ${args.attacker.name} [击倒]`);"
                                }
                            ]
                        }
                    },
                    "duration": {
                        "rounds": 3
                    },
                    "changes": [
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "中平枪法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>所谓中平枪，枪中王，远近高低多不防，高不拦，底不挪，当中一点难招架。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>太极</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "摆闪赚",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>凝神架枪，开启架招。进入“迅闪”状态，持续一回合。</p><p><strong>迅闪：</strong>速度+1，在此期间格挡成功时，使对方陷入“目盲”状态一回合。</p><p><strong>升级：</strong>格挡值+5，迅闪速度+1，内力消耗+1。</p>",
                    "automationNote": "开启获迅闪自动。格挡反致盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启迅闪",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"迅闪\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst spd = 1 + (lvl - 1);\neff.changes[0].value = String(spd);\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "扑入巢",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持枪猛扎，攻入敌巢，对目标造成伤害，击中无架招的角色时，额外获得 1 点怒气。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "回怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await actor.update({ \"system.resources.rage.value\": actor.system.resources.rage.value + 1 });\n    ui.notifications.info(\"扑入巢：获得 1 点怒气\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "退还乡",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时，消耗反应施展，枪杆一震，压制目标虚招，对目标造成伤害，并击退目标 2 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击退提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) ui.notifications.info(`${args.target.name} 被击退 2 米`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "梨花转",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>旋转枪身，给自己的武器添加一层“天风”，最多五层，持续到战斗脱离。</p><p><strong>天风：</strong>每层使你装备的武器伤害+5，格挡值+5。</p><p><strong>升级：</strong>获得天风层数+1，怒气消耗-1，消耗+2。</p>",
                    "automationNote": "获得天风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得天风",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"天风\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\neff.flags[\"xjzl-system\"].maxStacks = 5;\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "迅闪",
                    "icon": "icons/magic/movement/trail-streak-yellow.webp",
                    "description": "速度+1。格挡致盲。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xunshan",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "格挡致盲",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "if (!Macros.checkStance(actor, args)) return;\nconst blind = CONFIG.statusEffects.find(e => e.id === \"blind\");\nif (blind) {\n    const data = foundry.utils.deepClone(blind);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.attacker, data);\n    ui.notifications.info(\"迅闪触发：攻击者被致盲\");\n}"
                                }
                            ]
                        }
                    },
                    "duration": {
                        "rounds": 1
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "天风",
                    "icon": "icons/magic/air/wind-weather-snow-gusts.webp",
                    "description": "武器伤害/格挡+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tianfeng",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.weapon.mod",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "偓佺棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>棍分两节，可分可合，乃是短棍当中最灵巧的存在，棍扫全身，取一字“震”。</p><p><strong>需求：</strong>棍-双棍</p><p><strong>属性：</strong>柔</p>",
            "requirements": "棍-双棍",
            "moves": [
                {
                    "name": "落日卷帘",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>短棍挥舞间一分为二，前端轰然崩落，震心破肺，对目标造成伤害，若敌人无架招，减少其气血上限 15 点，持续到其连续休整一周。</p><p><strong>升级：</strong>招式伤害+10，消耗+2。</p>",
                    "automationNote": "削减上限自动(永久AE)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "震心破肺",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"震心\").toObject();\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 气血上限 -15 (需休整恢复)`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "浪卷白头",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双棍挥舞间合二为一，以长打短，刺击小腹。对目标造成伤害，击破架招后为自己增加两层“疾风”，最多叠加 5 层，持续到脱战。</p><p><strong>疾风：</strong>每层使你速度+1、闪避+1。</p><p><strong>升级：</strong>招式伤害+10，消耗+2。</p>",
                    "automationNote": "击破获风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获风",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"疾风\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "水天倒灌",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时，可消耗反应动作施展此招，压制对方虚招，缠绕对方兵器，直击面门，对其造成伤害，并为自己增加一层“疾风”状态。</p><p><strong>升级：</strong>招式伤害+10，消耗+2。</p>",
                    "automationNote": "获风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获风",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"疾风\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "千顷浩然",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双棍挥舞，开启架招。成功格挡后可消耗两层“疾风”和反应动作施展【落日卷帘】。</p><p><strong>升级：</strong>格挡值+10，消耗+2。</p>",
                    "automationNote": "反击提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击检查",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jifeng\");\nconst stacks = eff ? (eff.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (stacks >= 2) {\n    ui.notifications.info(`千顷浩然：可消耗2层疾风反击 [落日卷帘]`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "碧峰倒转",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>击飞周围敌人 1 米，再跃至半空中进行多次攻击，消耗全部“疾风”，每消耗一层，对范围内所有敌人造成一次伤害。</p><p>·每次造成伤害都需要对方投掷一次残疾检定。</p><p><strong>升级：</strong>每次招式伤害+20，怒气-1，消耗+8。</p>",
                    "automationNote": "伤害计算自动。残疾检定提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.1
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗疾风",
                            "trigger": "calc",
                            "script": "const eff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jifeng\");\nconst stacks = eff ? (eff.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\n// 伤害 = 基础 * 层数\n// 这里的 base 已经是 growth 后的单次伤害\n// 脚本修改总伤害\nif (stacks > 0) {\n    args.output.damage = args.output.damage * stacks;\n    args.output.bonusDesc.push(`疾风爆发 (${stacks}层): x${stacks} 倍率`);\n} else {\n    args.output.damage = 0;\n    args.output.bonusDesc.push(\"无疾风层数，伤害为0\");\n}",
                            "active": true
                        },
                        {
                            "label": "清理层数",
                            "trigger": "attack",
                            "script": "const eff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jifeng\");\nif (eff) await eff.delete();",
                            "active": true
                        },
                        {
                            "label": "残疾检定",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.finalDamage > 0) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><div style=\"padding:5px;\">请 ${args.target.name} 进行 <b>残疾检定</b></div></div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "震心",
                    "icon": "icons/magic/life/heart-broken-red.webp",
                    "description": "气血上限-15。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhenxin",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.resources.hp.max",
                            "mode": 2,
                            "value": "-15"
                        }
                    ]
                },
                {
                    "name": "疾风",
                    "icon": "icons/magic/air/wind-stream-teal.webp",
                    "description": "速度+1，闪避+1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jifeng",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "疯魔棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>梁山泊好汉鲁智深流传下来的杖法，套路极为威猛，挥舞起来不知轻重，极易死伤。</p><p><strong>需求：</strong>棍</p><p><strong>属性：</strong>阳</p>",
            "requirements": "棍",
            "moves": [
                {
                    "name": "疯癫乱棍",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，呼喝跳打，棍风挥洒，对敌人造成伤害。</p><p>若有敌人在 5 米范围的半空中，可消耗反应动作施展此招，飞身（半空中）冲至目标上方，劈棍下踹，造成伤害并将敌人击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "半空反应判定及击倒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "狂魔破阵",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，力大无穷，舞棍对敌人造成伤害，击破架招时，使目标下盘不稳两回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加状态自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "性情疯狂",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，无法冷静，陷入疯狂，开启架招。格挡成功后，给自身添加一层“疯意”，可叠加三层，持续到战斗脱离。</p><p><strong>疯意：</strong>出招时可消耗一层，使招式伤害+10。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获疯意",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"疯意\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "疯魔入体",
                    "type": "qi",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>若气血不足则无法释放，主要动作，心癫目赤，获得 3 怒气，然后将自身气血内力恢复到满值，坠入“疯魔”状态，持续五回合。</p><p><strong>疯魔：</strong>《疯魔杖法》招式伤害+10。持续期间，你受到的伤害和消耗的内力变为原来的三倍，且无法开启架招，即格挡值归零。</p><p>·疯魔结束时，你的怒气归零。</p><p>·疯魔期间陷入濒死，直接进行死亡检定。</p><p>·疯魔持续期间，你无法重复释放【疯魔入体】。</p><p><strong>升级：</strong>疯魔期间受到的伤害和内力消耗减少 50%。</p>",
                    "automationNote": "消耗判断、状态恢复、施加BUFF自动。易伤/内力消耗倍率自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "疯魔判定与消耗",
                            "trigger": "attack",
                            "script": "const hp = actor.system.resources.hp.value;\nconst maxHp = actor.system.resources.hp.max;\nif (hp < maxHp * 0.3) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"气血不足 30%\";\n    return;\n}\nconst hasFengmo = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengmo\");\nif (hasFengmo) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"已疯魔\";\n    return;\n}\n// 扣除30%血量\nconst cost = Math.floor(maxHp * 0.3);\nawait actor.applyHealing({amount: -cost, type: \"hp\", showScrolling: true});",
                            "active": true
                        },
                        {
                            "label": "状态恢复与应用",
                            "trigger": "hit",
                            "script": "// 恢复满状态\nconst maxHp = actor.system.resources.hp.max;\nconst maxMp = actor.system.resources.mp.max;\nawait actor.update({\n    \"system.resources.hp.value\": maxHp,\n    \"system.resources.mp.value\": maxMp,\n    \"system.resources.rage.value\": actor.system.resources.rage.value + 3\n});\n\n// 应用疯魔AE\nconst eff = thisItem.effects.getName(\"疯魔\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 升级逻辑\nconst lvl = Math.max(1, move.computedLevel || 1);\nif (lvl >= 2) {\n    eff.flags[\"xjzl-system\"].level = lvl;\n    eff.description += \" (升级: 惩罚减半)\";\n}\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "群魔疯舞",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，心随魔舞，癫狂乱打，对自身周围 3 米敌人造成伤害。</p><p>·自身具有“疯意”时，击飞所有敌人。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，消耗内力+8。</p>",
                    "automationNote": "消耗疯意自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗疯意",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fengyi\");\nif (buff) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"疯意\" },\n        content: `<p>消耗 [疯意] 击飞敌人？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"否\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await game.xjzl.api.effects.removeEffect(actor, \"fengyi\", 1);\n        ui.notifications.info(\"疯意爆发，请手动击飞敌人。\")\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "疯意",
                    "icon": "icons/magic/control/fear-fright-white.webp",
                    "description": "出招时可消耗一层，使招式伤害+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fengyi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                },
                {
                    "name": "疯魔",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "伤害+10，易伤/内力消耗增加，禁架。",
                    "transfer": false,
                    "duration": {
                        "rounds": 5
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "fengmo",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "易伤倍率",
                                    "trigger": "preTake",
                                    "active": true,
                                    "script": "const lvl = thisEffect.getFlag(\"xjzl-system\", \"level\") || 1;\nlet multiplier = 3;\nif (lvl >= 2) multiplier = 1.5;\nargs.output.damage = Math.floor(args.output.damage * multiplier);"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.blockStance",
                            "mode": 5,
                            "value": "true"
                        },
                        {
                            "key": "system.combat.blockTotal",
                            "mode": 5,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.damages.global.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "开山棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>威力不俗，体系完整，招式风格古朴精炼、体用结合，是上乘棍法之一。</p><p><strong>需求：</strong>棍</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍",
            "moves": [
                {
                    "name": "愚公落泪",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，持棍待敌，开启架招。并获得一层“轻灵”，至多三层，持续到脱战或解除架招。</p><p><strong>轻灵：</strong>每层使你的闪避+5。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启自动获BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得轻灵",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"轻灵\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拨石凿洞",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，持棍捅出，对目标造成伤害，击中无架招的目标时，将其击退 3 米。</p><p><strong>升级：</strong>招式伤害+10，消耗+2。</p>",
                    "automationNote": "击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"目标无架招，请手动击退 3 米。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "力拨千斤",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，挑动周围 1 米的重物砸向目标，对其造成伤害。</p><p>·你也可以挑起队友砸向目标（过程中队友处于半空中），队友可在半空中途借力消耗反应动作施展一招需要消耗主要动作的招式，并使招式伤害+10。若这么做，【力拔千斤】的伤害不会生效，队友出招后，落在目标周围空格处。</p><p><strong>升级：</strong>招式伤害+10，队友借力出招的伤害再+10，内力消耗+2。</p>",
                    "automationNote": "队友配合部分纯手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "一怒开山",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，用尽全身力量，重棍对目标造成巨大打击。</p><p>若击中开启架招的目标，且其武器品级低于自己的武器，则损坏对手武器。</p><p><strong>损坏：</strong>无法使用，需花费原价值一半的银两修复后才能继续使用。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "武器损坏需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "损坏提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"命中架招目标！请对比武器品级，手动处理武器损坏。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "轻灵",
                    "icon": "icons/magic/air/wind-weather-snow-gusts.webp",
                    "description": "每层使闪避+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingling",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "灵蛇毒棍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>招数繁复，自不待言，常喂剧毒，杖影舞动时宛如个见人即噬的厉鬼。</p><p><strong>需求：</strong>棍-短棍</p><p><strong>属性：</strong>阴</p>",
            "requirements": "棍-短棍",
            "moves": [
                {
                    "name": "蛇牙蜂蛰",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，力破一点，造成伤害，击中无架招目标为其添加“灵蛇毒”持续一回合。</p><p><strong>灵蛇毒：</strong>回合末受到 10 点毒素伤害。</p><p><strong>升级：</strong>伤害+10，灵蛇毒持续回合数+1，消耗+2。</p>",
                    "automationNote": "无架招施毒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加灵蛇毒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"灵蛇毒\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛇隐青竹",
                    "type": "real",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，棍斜横扫，灵动摆击，造成伤害。若目标存在“灵蛇毒”，则加重其毒伤，使其额外受到 10 点毒素伤害。</p><p><strong>升级：</strong>伤害+10，额外受到毒素伤害+10，消耗+2。</p>",
                    "automationNote": "额外毒伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "追加毒伤",
                            "trigger": "preDamage",
                            "script": "const hasPoison = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"lingshedu\");\nif (hasPoison) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = 10 + (lvl - 1) * 10;\n    args.config.amount += bonus;\n    ui.notifications.info(`追加毒伤 +${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "毒蛇入穴",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，棍影虚幻，开启架招。架招被击破时，给对方添加“灵蛇毒”，持续一回合。若目标已经存在“灵蛇毒”，为其再添加“奇蛇毒”，持续三回合。</p><p><strong>奇蛇毒：</strong>你的外功防御和[韧性]归零。</p><p><strong>升级：</strong>格挡+10，奇蛇毒持续回合数+1，消耗+2。</p>",
                    "automationNote": "击破反毒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破反毒",
                            "trigger": "damaged",
                            "script": "if (args.isBroken && args.attacker) {\n    const hasPoison = args.attacker.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"lingshedu\");\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    \n    if (hasPoison) {\n        const eff = thisItem.effects.getName(\"奇蛇毒\").toObject();\n        delete eff._id;\n        eff.origin = thisItem.uuid;\n        eff.duration = { rounds: 3 + (lvl - 1) };\n        await game.xjzl.api.effects.addEffect(args.attacker, eff);\n    } else {\n        const eff = thisItem.effects.getName(\"灵蛇毒\").toObject();\n        delete eff._id;\n        eff.origin = thisItem.uuid;\n        eff.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.attacker, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "长蛇寻路",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，蛇棍游走，莫测截打，对目标造成伤害。</p><p>若此招将目标打入濒死，则立刻抛洒蛇毒并以内力催化，向周围敌人注入“奇蛇毒”，持续一回合。</p><p><strong>升级：</strong>招式伤害+20 点，怒气-1，内力消耗+4。</p>",
                    "automationNote": "濒死扩散毒素手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死提示",
                            "trigger": "hit",
                            "script": "if (args.isDying || args.isDead) {\n    ui.notifications.info(\"目标濒死！请手动给周围敌人施加 [奇蛇毒]\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "灵蛇毒",
                    "icon": "icons/creatures/reptiles/snake-fang-green.webp",
                    "description": "回合末受到 10 点毒素伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lingshedu",
                            "stackable": false,
                            "regenHpTurnEnd": -10
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                },
                {
                    "name": "奇蛇毒",
                    "icon": "icons/creatures/reptiles/snake-cobra-poison-green.webp",
                    "description": "外功防御和韧性归零。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qishedu",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 5,
                            "value": "0"
                        },
                        {
                            "key": "system.skills.renxing.total",
                            "mode": 5,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "神打棍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>神打又称请神上身，其间信者或舞蹈或歌谣或摆坛做法，迎神上身深信不疑仿若己为真神，不惧刀兵不躲拳脚。</p><p><strong>需求：</strong>棍-短棍</p><p><strong>属性：</strong>阳</p>",
            "requirements": "棍-短棍",
            "moves": [
                {
                    "name": "头破血流",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，棍棒大开大合，劈头盖脸不留余力，对目标造成伤害。</p><p>若你具有“太岁当值”，还会使其流失 10 气血。</p><p><strong>升级:</strong>招式伤害+10，流失气血+10，内力消耗+2。</p>",
                    "automationNote": "太岁流失自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "太岁流失",
                            "trigger": "hit",
                            "script": "const hasTaiSui = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"taisui\");\nif (hasTaiSui && args.isHit) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const loss = 10 + (lvl - 1) * 10;\n    await args.target.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n    ui.notifications.info(`太岁追加流失 ${loss} 气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "刑冲破害",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，棍做枪直冲而去，如岁星降世，对其造成伤害。击破敌方架招后，你喜若癫狂，高呼乱语，自身获得“神打”一回合。</p><p><strong>神打：</strong>你无视“太岁当值”的效果。</p><p><strong>升级:</strong>招式伤害+10，持续回合数+1，内力消耗+2。</p>",
                    "automationNote": "击破获BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获神打",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"神打\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "祸到临头",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放此招，压制目标虚招，棍勒目标，然后头锤啃咬，并对其造成伤害。</p><p>同时给目标添加“太岁当值”状态，持续一回合。</p><p><strong>升级:</strong>招式伤害+10，持续回合数+1，内力消耗+2。</p>",
                    "automationNote": "施加太岁自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加太岁",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"太岁当值\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "请岁君",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，摇头晃脑，口念歌谣，不论通顺，只尊声势，你获得“太岁当值”，持续到战斗脱离。</p><p><strong>太岁当值:</strong>你周围三米范围内的所有人（包括友方和自己）进行的命中检定、属性检定、技能检定、虚招对抗都具有劣势。</p><p><strong>升级:</strong>怒气-1，内力消耗+4。</p>",
                    "automationNote": "自身获状态自动。自身劣势自动。光环效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得太岁",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"太岁当值\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"周围3米内所有人劣势需手动处理\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "太岁当值",
                    "icon": "icons/magic/control/debuff-energy-hold-yellow.webp",
                    "description": "检定劣势。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "taisui",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "自身劣势",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "const hasShenda = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shenda\");\nif (!hasShenda) {\n    args.flags.level -= 1;\n    args.flags.feintLevel -= 1;\n}"
                                },
                                {
                                    "label": "属性检定劣势",
                                    "trigger": "check",
                                    "active": true,
                                    "script": "const hasShenda = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shenda\");\nif (!hasShenda) {\n    args.flags.level -= 1;\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.globalCheckLevel",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                },
                {
                    "name": "神打",
                    "icon": "icons/magic/light/explosion-star-glow-yellow.webp",
                    "description": "无视太岁当值效果。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shenda",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "神宵矛法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖侠客观天雷悟出此矛法，厉害非常。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>阳</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "神宵引",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，引矛震地，开启架招。格挡成功后，给目标添加一层“五雷”状态，持续到战斗脱离。</p><p><strong>五雷：</strong>每层使你的命中减少 2 点。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡施加BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡施雷",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"五雷\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.attacker, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雷光一闪",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，矛尖刺出螺旋气劲，对目标造成伤害，若击中无架招的敌人，使目标陷入“禁足”状态。</p><p>·当有陷入“五雷”的敌人消耗移动速度，离开你周围三米时，你可以消耗反应动作对其施展此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中禁足自动。反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "奔雷突",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，持矛闪至目标身边，直刺胸膛，对目标造成伤害，若目标身上有“五雷”状态，你可将此招视为虚招。目标每存在一层“五雷”状态，此次虚招值+1。（至多+3）</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "视作虚招手动。手动转虚招时五雷加值自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "五雷增虚",
                            "trigger": "attack",
                            "script": "const targets = Array.from(game.user.targets);\nif (targets.length === 1) {\n    const t = targets[0].actor;\n    const wulei = t.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wulei\");\n    if (wulei) {\n        const stacks = Math.min(3, wulei.getFlag(\"xjzl-system\", \"stacks\") || 1);\n        ui.notifications.info(`目标有 ${stacks} 层五雷。若转虚招，请手动+${stacks}虚招值。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雷光炸裂",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时消耗反应施展，压制目标虚招，雷矛直刺，造成伤害。目标身上每有一层“五雷”，招式伤害+10。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "五雷增伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "五雷增伤",
                            "trigger": "preDamage",
                            "script": "const wulei = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wulei\");\nif (wulei) {\n    const stacks = wulei.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = 10 * stacks;\n    args.config.amount += bonus;\n    ui.notifications.info(`五雷增伤 +${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "五雷轰顶",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，将矛奋力投向空中，消耗范围内所有目标身上的所有“五雷”，在自身周围 5 米范围产生‘雷云’，持续三回合。</p><p><strong>雷云：</strong>区域内同时视作‘雷暴’天气，雷云中的敌人开始回合时，受到此招消耗“五雷”总层数*10 点的气血流失。</p><p><strong>升级：</strong>雷云的流失系数+10，怒气-1，内力消耗+8。</p>",
                    "automationNote": "消耗五雷自动。雷云及伤害手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗五雷",
                            "trigger": "hit",
                            "script": "const wulei = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wulei\");\nif (wulei) {\n    const stacks = wulei.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    await wulei.delete();\n    ChatMessage.create({\n        content: `${args.target.name} 消耗 ${stacks} 层五雷 (雷云伤害+${stacks*10})`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "五雷",
                    "icon": "icons/magic/lightning/bolt-strike-purple.webp",
                    "description": "每层命中-2。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wulei",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "-2"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "-2"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "极烈神枪",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>军阵厮杀绝招，极尽刚烈。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "压城",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，一手握枪尾，一手握中段，枪锋护身，暗含黑云压城之势，开启架招。格挡成功后，可使用反应动作对目标释放【裂甲】。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启架招自动。格挡成功后请手动判断距离释放【裂甲】。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功！可消耗反应动作施展 [裂甲]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "裂甲",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当有敌人进入你周围三米范围内，在你三米范围内消耗移动速度移动或是施展轻功经过，你可以消耗反应动作施展此招，提枪横扫，碎甲断骨，对其造成伤害，并使目标倒地。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。命中后自动给予目标[倒地]状态。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加倒地",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"prone\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被击倒在地！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "狼袭",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，枪破万千，对目标造成伤害，击破架招时，可以不消耗动作，对目标释放一次【裂甲】。</p><p>·你可以额外消耗怒气，每额外 1 点使虚招值+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "半自动化。出招前弹窗询问是否投入额外怒气。击破架招后请手动施展免费的【裂甲】。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "怒气加成决策",
                            "trigger": "attack",
                            "script": "const currentRage = actor.system.resources.rage.value;\nif (currentRage > 0) {\n    const confirm = await foundry.applications.api.DialogV2.prompt({\n        window: { title: \"狼袭 - 怒气加成\" },\n        content: `<p>当前剩余怒气: ${currentRage}</p><div class=\"form-group\"><label>额外投入怒气 (每点虚招+1)</label><input type=\"number\" name=\"rage\" value=\"0\" min=\"0\" max=\"${currentRage}\" autofocus></div>`,\n        ok: {\n            label: \"确定\",\n            callback: (event, button) => button.form.elements.rage.valueAsNumber\n        }\n    });\n    \n    const extraRage = confirm || 0;\n    if (extraRage > 0) {\n        await actor.update({ \"system.resources.rage.value\": currentRage - extraRage });\n        args.flags.bonusFeint += extraRage;\n        ui.notifications.info(`消耗 ${extraRage} 点额外怒气，虚招值 +${extraRage}`);\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招！请免费施展 [裂甲]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "焚江",
                    "type": "qi",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，极速攒刺，枪影翻飞，热浪汹涌，你本回合内获得一个额外的反应动作，并获得“焚江煮海”，持续一回合。</p><p><strong>焚江煮海：</strong>你的次要动作可以当做反应动作使用。</p><p>·你以反应动作释放的招式伤害+10。</p><p><strong>升级：</strong>焚江煮海令反应招式伤害+10，消耗+2。</p>",
                    "automationNote": "应用后获得BUFF。请玩家在施展反应招式时，手动在弹窗的'伤害修正'中输入加值（+10/20）。额外动作请手动管理。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得BUFF",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"焚江煮海\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 提示玩家伤害加值\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst dmgBonus = lvl >= 2 ? 20 : 10;\nui.notifications.info(`焚江煮海生效：下一次反应招式伤害应 +${dmgBonus} (请手动修正)`);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "破军",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，进入“极烈”之境，持续 4 个回合（极烈属特殊状态，无法移除）。</p><p>在极烈结束的回合初，你冲锋到范围内目标面前，一枪刺出，破尽千军，摧毁其身上的随机一件非玉品防具，并造成伤害。</p><p>·你每有一种武器技能达到 8，此招暴击骰-1。</p><p><strong>极烈：</strong>你失去且无法使用主要、次要动作。</p><p><strong>升级：</strong>招式伤害+20，极烈持续回合减 1，怒气-1，内力消耗+4。</p>",
                    "automationNote": "手动流程：1. 正常出招，获得BUFF，请忽略此次伤害。2. BUFF结束回合，再次点击出招(勾选免费)，应用伤害。防具摧毁手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "极烈处理",
                            "trigger": "attack",
                            "script": "// 检查是否已处于极烈状态（判断是第1阶段还是第2阶段）\nconst hasBuff = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"jilie\");\n\nif (!hasBuff) {\n    // 阶段1：施加状态\n    const lvl = Math.max(1, move.computedLevel || 1);\n    let rounds = 4;\n    if (lvl >= 2) rounds = 3;\n    if (lvl >= 3) rounds = 2;\n\n    const eff = thisItem.effects.getName(\"极烈\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: rounds };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    \n    ui.notifications.info(\"进入 [极烈] 状态。本次出招仅为启动，请忽略伤害卡片。\");\n} else {\n    // 阶段2：结算伤害，计算暴击修正\n    let skillCount = 0;\n    const ranks = actor.system.combat.weaponRanks;\n    for (const key in ranks) {\n        if (ranks[key].total >= 8) skillCount++;\n    }\n    // 暴击阈值修正 (正数 = 阈值降低 = 更容易暴击)\n    args.flags.critThresholdMod += skillCount;\n    \n    ui.notifications.info(`[破军] 结算：武器技能修正暴击骰 -${skillCount}`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "焚江煮海",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "你的次要动作可以当做反应动作使用。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenjiang",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "极烈",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "失去且无法使用主要、次要动作(请手动跳过动作阶段)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jilie",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "齐眉棍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>枪挑一条线，棍打一大片，立棍于地，高与眉齐，得名齐眉棍，是精要棍法之代表。</p><p><strong>需求：</strong>棍-长棍</p><p><strong>属性：</strong>柔</p>",
            "requirements": "棍-长棍",
            "moves": [
                {
                    "name": "大禹分水",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，虎口对握，灵活纵横，转身撩棍对目标造成伤害。击破架招时，自身获得一层“棍势”，至多三层，持续到你更换其他武器的武学套路。</p><p><strong>棍势：</strong>每层使棍法命中+10。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获棍势",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"棍势\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "回首望月",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，弓步架推，提膝握棍，开启架招。</p><p>成功格挡时，反手倒棍，绕头推击，借力将攻击者击倒。（不造成伤害）</p><p>·若自身具有“棍势”，还可将其击飞 1 米。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡击倒/击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst hasGunShi = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"gunshi\");\nlet msg = \"格挡反制：请手动将目标 [倒地]\";\nif (hasGunShi) msg += \" 并 [击飞] 1米\";\nui.notifications.info(msg);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "愚公移山",
                    "type": "real",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，双脚碾地，转身劈打，对目标造成伤害。</p><p>若目标处于倒地状态，可消耗反应动作再次施展此招，舞棍连打，造成伤害。</p><p>·若自身具有“棍势”，还可使其陷入“下盘不稳”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "连打手动。棍势施加状态自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasGunShi = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"gunshi\");\n    if (hasGunShi) {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n        if(eff) {\n            const data = foundry.utils.deepClone(eff);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "五花坐山",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，金鸡独立，而后开步戳棍。对目标造成伤害。</p><p>·此招造成伤害后，若目标气血低于最大上限的一半，则可拨棍撑地，跃至半空中后跳步砸下，对周围范围内所有敌人再造成一次伤害。</p><p><strong>升级：</strong>招式伤害增加 20 点，招式释放距离提升 1 米，怒气-1，内力消耗+4。</p>",
                    "automationNote": "二次伤害手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "棍势",
                    "icon": "icons/weapons/staves/staff-simple-brown.webp",
                    "description": "每层棍法命中+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "gunshi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "威仪六合",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>战场杀伐煞气之技，以极简动作，作极速屠戮。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "涤荡八荒",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，抡舞长枪，刚烈枪势笼罩四周，对周围范围内敌人造成伤害，然后自身获得“兵煞”，持续三回合。</p><p><strong>兵煞：</strong>你的招式伤害+15，但是你在自己的每个回合初流失 10 点气血和 10 点内力。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "自身获BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得兵煞",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"兵煞\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "奇袭子午",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，长枪快速点刺，以迅雷之势直取要害，对敌人造成伤害。击破架招时，使目标陷入“下盘不稳”，持续三个回合。</p><p>·如果你存在“兵煞”，下盘不稳改为禁足。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加状态自动（自动判断兵煞）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破状态",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const hasBingSha = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bingsha\");\n    let statusId = \"unstable\";\n    if (hasBingSha) statusId = \"root\";\n    \n    const eff = CONFIG.statusEffects.find(e => e.id === statusId);\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "据险坚守",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，拦枪回转，开启架招。格挡成功时，你可以立即解除架招，让此次伤害（扣除防御格挡）不生效，自己下回合初时，立即受到等额的气血流失。</p><p><strong>升级:</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "伤害延迟逻辑自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "延迟伤害",
                            "trigger": "preTake",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 弹出确认\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"据险坚守\" },\n    content: `<p>是否解除架招，将本次 <b>${args.output.damage}</b> 点伤害延迟到下回合？</p>`,\n    yes: { label: \"延迟伤害\", icon: \"fas fa-shield-alt\" },\n    no: { label: \"正常承受\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    // 1. 免疫本次伤害\n    const storedDmg = args.output.damage;\n    args.output.damage = 0;\n    \n    // 2. 解除架招\n    await actor.stopStance();\n    \n    // 3. 施加延迟流血AE\n    const delayEff = {\n        name: \"延迟伤害 (据险坚守)\",\n        icon: \"icons/svg/blood.svg\",\n        duration: { rounds: 1 },\n        flags: {\n            \"xjzl-system\": {\n                slug: \"delayed_pain\",\n                stackable: true,\n                regenHpTurnStart: -storedDmg\n            }\n        }\n    };\n    \n    await game.xjzl.api.effects.addEffect(actor, delayEff);\n    ui.notifications.info(`伤害已延迟！下回合开始将流失 ${storedDmg} 气血。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拨乱反正",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招，枪砸面门，对敌人造成伤害。若你重视世俗，招式伤害+30。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "世俗判定自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "世俗加成",
                            "trigger": "calc",
                            "script": "if (actor.system.social.attitude_shisu === \"respect\") {\n    args.output.damage += 30;\n    args.output.bonusDesc.push(\"重视世俗 +30\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "此志无双",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，凝聚自身兵煞，刺出决绝一击，对目标造成伤害。</p><p>·若你自身存在“兵煞”，你可以选择移除兵煞，让目标流失 20 点气血，20 点内力。</p><p><strong>升级:</strong>招式伤害+20，流失的气血内力+10，怒气-1，内力消耗+4。</p>",
                    "automationNote": "消耗兵煞追加流失手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗提示",
                            "trigger": "hit",
                            "script": "const bingsha = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bingsha\");\nif (bingsha) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const loss = 20 + (lvl - 1) * 10;\n    \n    // 这里不自动消耗，因为是“可以选择”\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"此志无双\" },\n        content: `<p>是否消耗 [兵煞] 使目标流失 ${loss} 点气血/内力？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-bolt\" },\n        no: { label: \"保留\", icon: \"fas fa-times\" }\n    });\n    \n    if (confirm) {\n        await bingsha.delete();\n        await args.target.applyHealing({amount: -loss, type: \"hp\", showScrolling: true});\n        await args.target.applyHealing({amount: -loss, type: \"mp\", showScrolling: true});\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "兵煞",
                    "icon": "icons/magic/fire/dagger-rune-enchant-flame-strong-red.webp",
                    "description": "招式伤害+15，回合初流失气血内力。",
                    "transfer": false,
                    "duration": {
                        "rounds": 3
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "bingsha",
                            "stackable": false,
                            "regenHpTurnStart": -10,
                            "regenMpTurnStart": -10
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "15"
                        },
                        {
                            "key": "flags.xjzl-system.regenHpTurnStart",
                            "mode": 2,
                            "value": "-10"
                        },
                        {
                            "key": "flags.xjzl-system.regenMpTurnStart",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "佛陀六诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>相传北魏时期法庆所创，本是佛门高僧，却自命为“新佛”，创“弥勒大乘教”起兵造反，屠灭寺舍，斩戮僧尼，焚烧经像，后被官府擒斩。</p><p>注：若你修炼此武功，万佛寺弟子视你为血仇。</p><p><strong>需求：</strong>棍-长棍</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长棍",
            "moves": [
                {
                    "name": "新佛出世",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，垂眉冷目，开启架招。格挡成功后进入“新佛”状态，持续三回合。</p><p><strong>新佛：</strong>自己的气血每少 400 点，招式暴击骰-1。若攻击者运转佛门武学，你还会获得 1 点怒气。</p><p><strong>升级：</strong>格挡值+10，气血减少要求-100，消耗+4。</p>",
                    "automationNote": "格挡获BUFF自动。暴击修正自动。佛门加怒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获新佛",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst eff = thisItem.effects.getName(\"新佛\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 升级逻辑\n// 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\nconst hpStep = 400 - (lvl - 1) * 100;\neff.flags[\"xjzl-system\"].hpStep = hpStep;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "灭世燃灯",
                    "type": "qi",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，逆转经脉，激发自身潜能，下次招式伤害提升【消耗的气血一半】的数值。</p><p><strong>升级：</strong>消耗气血增加 10%，怒气消耗+1。</p>",
                    "automationNote": "扣血及获BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            1,
                            2,
                            3,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "燃灯",
                            "trigger": "attack",
                            "script": "const maxHp = actor.system.resources.hp.max;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst ratio = 0.1 + (lvl - 1) * 0.1;\nconst cost = Math.floor(maxHp * ratio);\n\n// 扣血\nawait actor.applyHealing({amount: -cost, type: \"hp\", showScrolling: true});\n\n// 施加BUFF\nconst bonus = Math.floor(cost / 2);\nconst eff = thisItem.effects.getName(\"燃灯\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 写入数值\neff.changes[0].value = String(bonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(`燃灯消耗 ${cost} 气血，下击增伤 +${bonus}`);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "莲台杀僧",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，侵染佛念，轰棒直喝，对目标造成伤害，击破架招时，使目标陷入“封招”，持续一回合。</p><p>·若自身处于“新佛”状态，且对手正施展佛门武学，对方需进行[佛法]检定（难度 10），若对方失败，则下回合无法使用佛门武学。</p><p>·若对方身处“旧魔”状态，检定结果必定为 1。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破封招自动。对抗及旧魔互动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破封招",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "邪见观音",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，散布邪念杀气，棍意扫荡周身，对周围敌人造成伤害。命中无架招目标时，为其添加“旧魔”，持续一回合。</p><p><strong>旧魔：</strong>你每有 1 级[佛法]，你的速度-1。</p><p><strong>升级:</strong>招式伤害+10，持续回合+1，内力消耗+8。</p>",
                    "automationNote": "命中施加旧魔及减速自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加旧魔",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"旧魔\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    \n    // 计算目标佛法等级\n    const fofa = args.target.system.arts?.fofa?.total || 0;\n    eff.changes[0].value = String(-fofa);\n    \n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血海弥勒",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，恶露宝相，凌空而袭，造成伤害。</p><p>可移除自身存在的“新佛”，给对方添加“旧魔”，持续到战斗脱离。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "状态转化手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "状态转化",
                            "trigger": "hit",
                            "script": "const xinfo = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xinfo\");\nif (xinfo) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"血海弥勒\" },\n        content: `<p>是否移除 [新佛] 给对方施加 [旧魔]？</p>`,\n        yes: { label: \"执行\", icon: \"fas fa-skull\" },\n        no: { label: \"取消\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await xinfo.delete();\n        \n        const eff = thisItem.effects.getName(\"旧魔\").toObject();\n        delete eff._id;\n        eff.origin = thisItem.uuid;\n        const fofa = args.target.system.arts?.fofa?.total || 0;\n        eff.changes[0].value = String(-fofa);\n        \n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一念成魔",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>只有处于“新佛”时才能释放此招。</p><p>蓄力动作，自身气血减少到 1，并陷入“走火入魔”，持续 3 回合。</p><p>以自身气血幻化出一朵巨大莲花，炸开后分散为毁天灭地般的莲花魔雨，对周身范围内所有敌人造成伤害，并造成与自身因此招而减少气血等额的流失伤害。</p><p>·我入地狱，众生皆入地狱，每有一人死于此招之下（包括你自己），你视野范围内的所有人增加 50 点恶行值，50 点杀戮值。</p><p>·此招一旦释放，自身立刻处于“走火入魔”状态，因此需先投掷 D20 判定敌我再判定命中伤害。</p><p>1：只攻击自己。</p><p>2-5：攻击所有敌方和友方（包括自己）。</p><p>6-10：攻击所有敌方和友方（不包括自己）。</p><p>11-20：攻击范围内所有敌方。</p><p><strong>升级：</strong>招式释放距离+2，招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "扣血、状态、流失计算自动。敌我判定及恶行增加手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "一念成魔前置",
                            "trigger": "attack",
                            "script": "const hasXinfo = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xinfo\");\nif (!hasXinfo) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"必须处于 [新佛] 状态\";\n    return;\n}\n// 扣血至1\nconst hp = actor.system.resources.hp.value;\nconst loss = Math.max(0, hp - 1);\nawait actor.applyHealing({amount: -loss, type: \"hp\", showScrolling: true});\n\n// 记录流失量到 Move flag供hit读取\nawait thisItem.setFlag(\"xjzl-system\", \"tempBloodLoss\", loss);\n\n// 施加走火入魔\nconst eff = CONFIG.statusEffects.find(e => e.id === \"rage\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(actor, data);\n}",
                            "active": true
                        },
                        {
                            "label": "预览流失",
                            "trigger": "calc",
                            "script": "const hp = actor.system.resources.hp.value;\nconst loss = Math.max(0, hp - 1);\nargs.output.damage += loss;\nargs.output.bonusDesc.push(`血祭流失 +${loss}`);",
                            "active": true
                        },
                        {
                            "label": "追加流失",
                            "trigger": "hit",
                            "script": "const loss = thisItem.getFlag(\"xjzl-system\", \"tempBloodLoss\") || 0;\nif (loss > 0) {\n    // 注意：calc阶段加的是面板伤害，而hit这里是流失伤害，不走防御。\n    // 规则是：造成X点外功伤害，并造成X点流失伤害。\n    // 上面的calc加了外功伤害。这里追加流失。\n    await args.target.applyHealing({amount: -loss, type: \"hp\", showScrolling: true});\n    ui.notifications.info(`${args.target.name} 受到 ${loss} 点血祭流失！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "新佛",
                    "icon": "icons/magic/symbols/runes-star-pentagon-orange.webp",
                    "description": "气血越低暴击越高。被佛门武学攻击回怒。",
                    "transfer": false,
                    "duration": {
                        "rounds": 3
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "xinfo",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "暴击修正",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "// 动态计算暴击修正\nconst maxHp = actor.system.resources.hp.max;\nconst hp = actor.system.resources.hp.value;\nconst missing = maxHp - hp;\nconst step = thisEffect.getFlag(\"xjzl-system\", \"hpStep\") || 400;\n\nconst critMod = Math.floor(missing / step);\nif (critMod > 0) {\n    args.flags.critThresholdMod += critMod;\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "燃灯",
                    "icon": "icons/magic/fire/projectile-fireball-smoke-orange.webp",
                    "description": "下次招式伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "randeng",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "消耗BUFF增伤",
                                    "trigger": "calc",
                                    "active": true,
                                    "script": "// calc 阶段预览\nconst bonus = Number(thisEffect.changes[0].value) || 0;\nargs.output.damage += bonus;\nargs.output.bonusDesc.push(`燃灯加成 +${bonus}`);"
                                },
                                {
                                    "label": "移除BUFF",
                                    "trigger": "hit_once",
                                    "active": true,
                                    "script": "await thisEffect.delete();"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "旧魔",
                    "icon": "icons/magic/control/debuff-chains-ropes-purple.webp",
                    "description": "基于佛法等级减少速度。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jiumo",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "霸王枪",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>西楚霸王，纵横一世，此功法乃是楚国流传的镇国之法，冠绝天下，百兵臣服。枪诀写在昔年楚国战旗之上，上面血迹为霸王于乌江边所留。</p><p><strong>需求：</strong>棍-长枪</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长枪",
            "moves": [
                {
                    "name": "霸王举鼎",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，举枪顶天，开启架招。格挡成功后获得一层“霸王”，可无限叠加，持续到战斗结束。</p><p><strong>霸王：</strong>每层增加内外功防御 5 点，招式伤害+5。</p><p><strong>升级：</strong>格挡值+10，额外获得一层，消耗+4。</p>",
                    "automationNote": "开启自动。格挡叠层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-霸王",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 获取AE模板\nconst eff = thisItem.effects.getName(\"霸王\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 默认每次格挡加1层\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(`格挡成功！霸王意气叠加。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "霸王卸甲",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，气散八方，以退为进，回复 10 气血，解除架招，进入“卸甲”状态，持续到战斗脱离。</p><p><strong>卸甲：</strong>你失去所有内外功防御。每因此失去 1 点内外功防御，下一次出招招式伤害+1。</p><p><strong>升级：</strong>额外回复气血 10 点，每点防御再增加 1 点伤害，内力消耗+4。</p>",
                    "automationNote": "完全自动化。自动回血、关架招、计算防御快照、扣除防御、赋予伤害加成。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            1,
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "卸甲逻辑",
                            "trigger": "hit",
                            "script": "// 0. 防复触发\nif (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xiejia\")) {\n    return ui.notifications.warn(\"你已处于卸甲状态！\");\n}\n\n// 1. 回复气血\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst healAmt = 10 + (lvl - 1) * 10;\nawait actor.applyHealing({ amount: healAmt, type: \"hp\", showScrolling: true });\n\n// 2. 解除架招 (确保架招提供的防御被移除)\nawait actor.stopStance();\n\n// 3. 快照当前防御 (使用 Total 属性)\nconst wai = actor.system.combat.defWaigongTotal || 0;\nconst nei = actor.system.combat.defNeigongTotal || 0;\nconst totalDef = wai + nei;\n\n// 4. 计算转化加成\nconst ratio = lvl;\nconst dmgBonus = totalDef * ratio;\n\n// 5. 应用状态 A: 卸甲 (防御归零)\n// 逻辑: 施加一个负的修正值，抵消当前所有防御\nconst effA = thisItem.effects.getName(\"卸甲\").toObject();\ndelete effA._id;\neffA.origin = thisItem.uuid;\n\n// 动态写入负值\neffA.changes[0].value = String(-wai);\neffA.changes[1].value = String(-nei);\n\nawait game.xjzl.api.effects.addEffect(actor, effA);\n\n// 6. 应用状态 B: 卸甲之力 (伤害加成)\nif (dmgBonus > 0) {\n    const effB = thisItem.effects.getName(\"卸甲之力\").toObject();\n    delete effB._id;\n    effB.origin = thisItem.uuid;\n    effB.changes[0].value = String(dmgBonus);\n    await game.xjzl.api.effects.addEffect(actor, effB);\n}\n\nui.notifications.info(`霸王卸甲：牺牲 ${totalDef} 防御，下一次伤害 +${dmgBonus}！`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "破釜沉舟",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，以枪撑地，飞跃而起（半空中），跳到攻击者身后攻其背部，造成 0.8 力量点外功伤害。</p><p>·若目标无架招，可以改为造成内功伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "伤害类型转换自动。跳跃位移手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "类型转换",
                            "trigger": "preDamage",
                            "script": "if (args.target && !args.target.system.martial.stanceActive) {\n    args.config.type = \"neigong\";\n    ui.notifications.info(\"目标无架招，破釜沉舟转为内功伤害！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "鸿门杀机",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，大枪横扫，对周围敌人造成 0.7 力量点外功伤害。</p><p>·自身存在“霸王”时，范围内每有一个敌人，招式伤害增加 15 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "霸王加成自动(基于选中目标数)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "霸王群攻加伤",
                            "trigger": "attack",
                            "script": "const hasBawang = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bawang\");\nconst targetCount = game.user.targets.size;\n\nif (hasBawang && targetCount > 0) {\n    const bonus = 15 * targetCount;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 霸王群攻 (${targetCount}人): ${bonus}`;\n    ui.notifications.info(`鸿门杀机：霸王气概触发，伤害 +${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "四面楚歌",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，长枪突刺，枪鸣如歌，造成 0.6 力量点外功伤害，击破架招时，使目标“封招”一回合。</p><p>·当自身存在三层以上“霸王”时，可将封招效果改为“眩晕”一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破效果自动判断霸王层数。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const bawang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bawang\");\n    const stacks = bawang ? (bawang.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n    \n    let statusId = \"fengzhao\";\n    let label = \"封招\";\n    \n    if (stacks >= 3) {\n        statusId = \"stun\"; // 使用系统定义的 stun\n        label = \"眩晕\";\n    }\n    \n    const eff = CONFIG.statusEffects.find(e => e.id === statusId);\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被 ${label} (霸王 ${stacks} 层)`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "乌江再起",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "none",
                    "actionType": "heal",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，败势已难回，更需挽狂澜，回复生命值至上限，移除自身任意数量的状态，然后陷入“走火入魔”，持续五回合。</p><p><strong>升级：</strong>持续回合数-1，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "回满血自动。走火入魔自动。移除状态需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "乌江再起",
                            "trigger": "hit",
                            "script": "// 1. 回满血\nconst missingHp = actor.system.resources.hp.max - actor.system.resources.hp.value;\nif (missingHp > 0) {\n    await actor.applyHealing({ amount: missingHp, type: \"hp\", showScrolling: true });\n}\n\n// 2. 走火入魔\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = Math.max(1, 5 - (lvl - 1));\n\nconst rageEff = CONFIG.statusEffects.find(e => e.id === \"rage\");\nif (rageEff) {\n    const data = foundry.utils.deepClone(rageEff);\n    data.duration = { rounds: rounds };\n    await game.xjzl.api.effects.addEffect(actor, data);\n}\n\nui.notifications.info(\"乌江再起！气血已回满。请手动在 Token HUD 中移除不需要的状态。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "霸王",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "每层增加防御与伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bawang",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "卸甲",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "内外防归零。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiejia",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "卸甲之力",
                    "icon": "icons/svg/explosion.svg",
                    "description": "卸甲带来的爆发性伤害加成 (攻击一次后消失)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiejia_power",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "一击即逝",
                                    "trigger": "hit_once",
                                    "active": true,
                                    "script": "if (args.move.type !== 'qi' && args.move.type !== 'stance') {\n    await thisEffect.delete();\n    ui.notifications.info(\"卸甲之力已耗尽。\");\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "披风乱棍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>此棍法与传统武学大相径庭，包含刀剑鞭等各类兵器的特色，擅长借力打力，面对多人时不落下风。</p><p>注：此武功每修炼合一一招，气血上限-50。</p><p><strong>需求：</strong>全武器技能等级≥6</p><p><strong>需求：</strong>棍</p><p><strong>属性：</strong>太极</p>",
            "requirements": "全武器技能等级≥6；棍",
            "automationNote": "注意：修炼导致的气血上限减少请由GM或玩家手动调整。",
            "moves": [
                {
                    "name": "披风穿云",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，以内功展开道道真气，身形如披风云，飘忽不定，开启架招。格挡成功后，获得一层“披风”，可无限叠加，持续到脱战或解除架招。</p><p><strong>披风：</strong>每层使你闪避+5。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "扣血自动。格挡叠层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "hp": [
                            50,
                            50,
                            50,
                            50
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-披风",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"披风\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "乱风渺",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，杖如山呼海啸，在范围内击出道道虚影，对面前 3*3 米内的敌人造成 0.7 内息点内功伤害。</p><p>·你每有一层“披风”，击飞目标 1 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "击飞距离提示自动，位移手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "hp": [
                            50,
                            50,
                            50,
                            50
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\n    const stacks = pifeng ? (pifeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n    if (stacks > 0) {\n        ui.notifications.info(`${args.target.name} 被击飞 ${stacks} 米 (请手动移位)。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "峡风凛",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "6米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，杖带疾风，闪至目标身前，直刺目标，对目标造成 0.7 内息点内功伤害，若击破目标架招，使目标陷入“禁足”“封招”，持续一回合。</p><p>·你身上每有一层“披风”，虚招值+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "披风加成自动。击破效果自动。位移手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "hp": [
                            50,
                            50,
                            50,
                            50
                        ]
                    },
                    "scripts": [
                        {
                            "label": "披风加成",
                            "trigger": "attack",
                            "script": "const pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\nconst stacks = pifeng ? (pifeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nargs.flags.bonusFeint += stacks;",
                            "active": true
                        },
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const root = CONFIG.statusEffects.find(e => e.id === \"root\");\n    const fengzhao = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    \n    if (root) {\n        const d1 = foundry.utils.deepClone(root);\n        d1.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, d1);\n    }\n    if (fengzhao) {\n        const d2 = foundry.utils.deepClone(fengzhao);\n        d2.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, d2);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "风烛恍恍",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，以自身本源肾气，维持风劲不散。</p><p>流失 60 点气血，获得一层“披风”，持续到脱战或解除架招。（每次至多获得 1 层）</p><p><strong>升级：</strong>流失气血-10，内力消耗+4。</p>",
                    "automationNote": "流失气血自动。获得披风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "流血获风",
                            "trigger": "attack",
                            "script": "// 1. 计算流失量 (60 - (Lv-1)*10)\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst loss = Math.max(0, 60 - (lvl - 1) * 10);\n\n// 2. 执行流失\nif (loss > 0) {\n    await actor.applyHealing({ amount: -loss, type: \"hp\", showScrolling: true });\n}\n\n// 3. 获得披风\nconst eff = thisItem.effects.getName(\"披风\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天风不乱",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招后消耗反应动作和 4 层“披风”，压制目标虚招，并且将此招虚招引向你周围的其他敌人或其他友方。</p><p>·此次虚招攻击沿用攻击者的数据（包括命中、伤害、虚招值、暴击骰等）。</p><p><strong>升级：</strong>消耗“披风”层数-1，消耗+4。</p>",
                    "automationNote": "消耗披风自动。转移虚招效果完全手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "hp": [
                            50,
                            50,
                            50,
                            50
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗披风",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst costStacks = Math.max(1, 4 - (lvl - 1));\n\nconst pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\nconst currentStacks = pifeng ? (pifeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (currentStacks < costStacks) {\n    args.flags.abort = true;\n    args.flags.abortReason = `披风层数不足 (需要 ${costStacks})`;\n    return;\n}\n\nawait game.xjzl.api.effects.removeEffect(actor, \"pifeng\", costStacks);\nui.notifications.info(\"已消耗披风，请手动指定虚招转移的目标并裁定结果。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "挟雨拨月转江山",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，消耗所有“披风”，棍卷狂风，似带惊雷，对周围敌人造成 0.9 内息点内功伤害，被击中的角色进行一次[韧性]检定，难度＝10+2*消耗披风层数。检定失败则陷入“眩晕”一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，消耗+16。</p>",
                    "automationNote": "消耗披风自动。检定请求自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ],
                        "hp": [
                            100,
                            100,
                            100,
                            100
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗披风",
                            "trigger": "attack",
                            "script": "const pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\nconst stacks = pifeng ? (pifeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (pifeng) {\n    await pifeng.delete();\n    args.flags.consumedPifeng = stacks; // 存入标志供 hit 使用\n}",
                            "active": true
                        },
                        {
                            "label": "发起检定",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    // 从 Item 的临时变量中读取 attack 阶段消耗的层数\n    // 注意：由于 flags 是深拷贝传下来的，需确保 attack 写入的是 args.flags\n    // 但 hit 和 attack 是分离的。最佳方案：读取消耗记录，或者这里我们已经知道 attack 阶段写入了 consumedPifeng\n    // 修正：Item.roll 流程中，Attack 阶段的 args.flags 并不会自动透传给 Hit。所以这里需要一个持久化的方式。\n    // 考虑到系统限制，我们在 hit_once 删除披风，hit 读取披风。但这会导致多目标时披风被第一个目标删掉。\n    // 解决方案：使用 hit_once 统一删除。hit 读取当前层数。\n    \n    const pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\n    const stacks = pifeng ? (pifeng.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n    \n    const dc = 10 + 2 * stacks;\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"renxing\",\n        dc: dc,\n        label: \"抵抗眩晕\",\n        onFail: \"xuanyun\"\n    });\n}",
                            "active": true
                        },
                        {
                            "label": "清空披风",
                            "trigger": "hit_once",
                            "script": "const pifeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"pifeng\");\nif (pifeng) await pifeng.delete();",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "披风",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "每层使你闪避+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "pifeng",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "天机神棒",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>天机老人所使棍法，以人道窥天道，神秘莫测。</p><p><strong>需求：</strong>棍-短棍</p><p><strong>属性：</strong>太极</p>",
            "requirements": "棍-短棍",
            "moves": [
                {
                    "name": "觅天寻机",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，轻点短棍，寻觅天机，开启架招。格挡成功后，获得一层“天机”，最多五层，持续到战斗脱离。</p><p><strong>天机：</strong>每层使你看破值+1。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "开启自动。格挡叠层自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-天机",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"天机\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一叶障目",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，以棍为臂，遮蔽天机，无处可寻，自不思议处攻向目标，对目标造成 0.6 力量点外功伤害，击破架招时，使目标获得三层“乏力”，持续到战斗脱离，并使自己获得两层“天机”，持续到战斗脱离。</p><p>·出招前，你可以选择消耗任意层数的“天机”，每消耗 1 层，虚招值+2。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "消耗天机弹窗询问。击破效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗天机",
                            "trigger": "attack",
                            "script": "const tianji = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"tianji\");\nif (tianji) {\n    const max = tianji.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const num = await foundry.applications.api.DialogV2.prompt({\n        window: { title: \"消耗天机\" },\n        content: `<p>当前天机：${max} 层。</p><p>消耗多少层增强虚招？</p><input type=\"number\" value=\"0\" min=\"0\" max=\"${max}\">`,\n        ok: { callback: (e, b) => b.form.elements[0].value }\n    });\n    if (num > 0) {\n        await game.xjzl.api.effects.removeEffect(actor, \"tianji\", Number(num));\n        args.flags.bonusFeint += num * 2;\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    // 目标乏力 x3\n    const fali = CONFIG.statusEffects.find(e => e.id === \"fali\");\n    if (fali) {\n        const d1 = foundry.utils.deepClone(fali);\n        d1.flags[\"xjzl-system\"].stacks = 3;\n        await game.xjzl.api.effects.addEffect(args.target, d1);\n    }\n    \n    // 自身天机 x2\n    const tianji = thisItem.effects.getName(\"天机\").toObject();\n    delete tianji._id;\n    tianji.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, tianji);\n    await game.xjzl.api.effects.addEffect(actor, tianji);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "管中窥天",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，以棍迅点，将大千世界，武道感悟，汇于一式之上，对目标造成 0.7 力量点外功伤害。击中无架招目标时，使目标陷入“封招”一回合。</p><p>·出招前，你可以选择消耗任意层数的“天机”，每消耗 1 层，可以使你的招式伤害提高等同于你悟性值的数值。</p><p>·若你消耗 3 层以上的“天机”，则此招可以攻击周围敌人。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "消耗天机弹窗询问。范围提示自动。封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗天机",
                            "trigger": "attack",
                            "script": "const tianji = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"tianji\");\nif (tianji) {\n    const max = tianji.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const num = await foundry.applications.api.DialogV2.prompt({\n        window: { title: \"消耗天机\" },\n        content: `<p>当前天机：${max} 层。</p><p>消耗多少层增强伤害？(3层以上转为范围)</p><input type=\"number\" value=\"0\" min=\"0\" max=\"${max}\">`,\n        ok: { callback: (e, b) => b.form.elements[0].value }\n    });\n    \n    const consume = Number(num);\n    if (consume > 0) {\n        await game.xjzl.api.effects.removeEffect(actor, \"tianji\", consume);\n        const wuxing = actor.system.stats.wuxing.total;\n        args.flags.damageResult.damage += consume * wuxing;\n        args.flags.damageResult.breakdown += `\\n+ 天机加成 (${consume}层): ${consume * wuxing}`;\n        \n        if (consume >= 3) {\n            ui.notifications.info(\"消耗超过 3 层天机，此招转为范围攻击！(请手动框选目标)\");\n        }\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "封招",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天机难测",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "6米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时消耗反应动作施展，身影如虚空一般，以棍击飞劲力，压制目标虚招，对目标造成 0.7 力量点外功伤害，并使自身获得一种曾经见过并明确效果的状态，持续一回合或获得一层。</p><p>·你可以选择至多消耗 1 层“天机”，每消耗 1 层，获得状态额外持续一回合或额外获得一层。</p><p><strong>升级：</strong>招式伤害+10，最多消耗层数+1，消耗+4。</p>",
                    "automationNote": "状态复制手动。消耗天机手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "操作提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst maxConsume = 1 + (lvl - 1);\n\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p><b>天机难测命中！</b></p>\n            <p>请手动为自己添加一个已知状态。</p>\n            <p>可选：消耗至多 ${maxConsume} 层 [天机]，增加持续时间/层数。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "窥天一目",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，以棍引天，终窥得一线天机，使自己进入“窥天”状态，持续一回合。</p><p><strong>窥天：</strong>在你视线范围内进行的 D20 投掷，你可以消耗 1 层“天机”，将投掷的结果更改成任何数字。</p><p><strong>升级：</strong>窥天持续回合数+1，消耗+8，怒气消耗-1。</p>",
                    "automationNote": "消耗天机获得窥天自动。改骰效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "前置检查与消耗",
                            "trigger": "attack",
                            "script": "const tianji = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"tianji\");\nconst stacks = tianji ? (tianji.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\nif (stacks < 5) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"需要 5 层 [天机] 才能施展！\";\n    return;\n}\nawait tianji.delete(); // 消耗所有 (因为是5层施展，通常全部消耗，或者这里代码写的是检查5层消耗5层？原文描述：消耗5层天机。OK，那就消耗5层。这里为简便直接delete，如果有多余的再改 removeEffect)\n// 修正：调用 removeEffect 5层\n// await game.xjzl.api.effects.removeEffect(actor, \"tianji\", 5); // 考虑到可能有多余5层的情况",
                            "active": true
                        },
                        {
                            "label": "获得窥天",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"窥天\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "天机",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "每层增加看破值。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tianji",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "窥天",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "消耗天机修改骰子。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "kuitian",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]