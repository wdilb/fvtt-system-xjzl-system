[
    {
        "name": "夺命十三剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>失传已久，曾为一燕姓剑客所用，很快销声匿迹。剑招如鬼斧神工，快、狠、奇，且杀气极重，稍加修炼便入疯魔。传闻还有第十四和第十五剑。</p><p><strong>需求：</strong>悟性5</p>",
            "requirements": "悟性5",
            "moves": [
                {
                    "name": "绝命",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑本无招，招由心生</p><p>剑影连颤，无命无情，瞬间刺出十数剑，对目标造成伤害。</p><p>·本场战斗中目标每受到过一次【封喉】造成的伤害，招式提升20点。</p><p>·若施展本招将敌人击杀（死亡检定失败），为在场任意一个敌人添加“封喉”，持续到当前行动的玩家的回合结束。</p>",
                    "automationNote": "自动化：自动检测目标身上的[封喉计数]并增加伤害。击杀后施加状态需手动选择目标。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "封喉增伤检测",
                            "trigger": "preDamage",
                            "active": true,
                            "script": "const counter = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fenghou_counter\");\nconst stacks = counter ? (counter.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (stacks > 0) {\n    const bonus = stacks * 20;\n    args.config.amount += bonus;\n    // 这里的提示只给GM和玩家看，确认触发了效果\n    ui.notifications.info(`绝命：检测到 ${stacks} 层封喉计数，伤害 +${bonus}`);\n}"
                        },
                        {
                            "label": "击杀检测",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isDead) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold; color:darkred;\">绝命 - 击杀触发</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>目标已死亡。</p>\n                <p>请手动为场上任意一个敌人添加 <b>[封喉]</b>。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "枉死",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑指九幽，闭目待敌，开启架招。架招被击破时，为在场任意一个敌人添加“封喉”，持续到当前行动的玩家的回合结束。</p>",
                    "automationNote": "击破后提示手动施加封喉。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破触发",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.isBroken && args.config.ignoreStance !== true) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">枉死 - 架招击破</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>架招被击破。</p>\n                <p>请手动为场上任意一个敌人添加 <b>[封喉]</b>。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "挫颅",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招。射出剑气，对敌人造成伤害，并为其添加“封喉”，持续到当前行动的玩家的回合结束。</p><p><strong>封喉：</strong>当该状态结束时，若你5米范围内有习得【夺命十三剑-封喉】的角色，他可以不消耗动作对你施展一次【封喉】。</p>",
                    "automationNote": "命中施加封喉自动。封喉后续联动效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加封喉",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"封喉\").toObject();\n    eff.duration = { turns: 1 }; // 持续到当前回合结束，近似处理为1回合\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 已被封喉`);\n}"
                        }
                    ]
                },
                {
                    "name": "割面",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑走偏锋，斜削面门，对敌人造成伤害。击破对方架招时，清除目标身上的一个状态，并且本次战斗中，目标无法再获得此状态。</p>",
                    "automationNote": "击破后状态清除与封印需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            6,
                            10
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold; color:darkred;\">割面 - 击破架招</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>已击破 <b>${args.target.name}</b> 的架招！</p>\n                <p>请手动清除目标身上的一个状态，且本场战斗中目标无法再获得该状态。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "封喉",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>剑指咽喉，凝练一线，对直线上的敌人造成伤害。</p><p>若范围内有敌人处于半空中，此招可消耗反应动作释放，立于原地射出剑气，对其造成伤害。</p>",
                    "automationNote": "自动化：伤害计算自动。命中后自动给目标叠加[封喉计数]（用于绝命增伤）。反应动作释放需玩家自行判断时机。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "叠加封喉计数",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const effName = \"封喉计数\";\n    const eff = thisItem.effects.getName(effName);\n    if (eff) {\n        const effData = eff.toObject();\n        delete effData._id;\n        effData.origin = thisItem.uuid;\n        // 叠加一层\n        await game.xjzl.api.effects.addEffect(args.target, effData, 1);\n    }\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "封喉",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "当该状态结束时，若你5米范围内有习得【夺命十三剑-封喉】的角色，他可以不消耗动作对你施展一次【封喉】。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenghou",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "封喉计数",
                    "icon": "icons/svg/blood.svg",
                    "description": "记录受到【封喉】招式伤害的次数，用于增加【绝命】的伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenghou_counter",
                            "stackable": true
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "摄魂魔刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>魔刀门功法，刀光乍现，吸魂取魄，壮大自身。</p><p><strong>需求：</strong>刀-双刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀-双刀",
            "moves": [
                {
                    "name": "血债血偿",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双刀交叉，新仇旧恨，开启架招。格挡成功后，自身获得一层“魂”，持续到脱战。</p><p><strong>魂：</strong>造成伤害时，可消耗一层“魂”，吸取【招式伤害（未扣除防御格挡）*20%】的气血。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡自动获魂。吸血效果需在其他攻击招式中手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获魂",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"魂\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "魂飞魄荡",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>挥刀之际，摄人心神，对目标造成伤害。击破架招时，若消耗一层“魂”，此次吸血比例从 20%提高到 100%。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中后弹窗询问是否消耗魂吸血（基于未减免伤害）。自动判断击破架招提升吸血比例。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "摄魂吸血",
                            "trigger": "hit",
                            "script": "if (!args.isHit) return;\nconst hun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shehun_hun\");\nif (!hun) return;\n\n// 判断是否满足强化条件\nconst isBoosted = args.isBroken;\nconst ratio = isBoosted ? 1.0 : 0.2;\n// 使用 pre-defense damage (args.damageResult.damage)\nconst rawDamage = args.damageResult.damage || 0;\nconst healAmount = Math.floor(rawDamage * ratio);\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"摄魂魔刀 - 魂飞魄荡\" },\n    content: `<p>消耗一层 [魂] 进行吸血？</p><p>击破状态: <b>${isBoosted ? \"是\" : \"否\"}</b></p><p>预计算吸血量: <b>${healAmount}</b> (基于伤害 ${rawDamage})</p>`,\n    yes: { label: \"吸血\", icon: \"fas fa-skull\" },\n    no: { label: \"不吸\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    await game.xjzl.api.effects.removeEffect(actor, \"shehun_hun\", 1);\n    await actor.applyHealing({ amount: healAmount, type: \"hp\", showScrolling: true });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天诛地戮",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>挥舞双刀，心乱神迷，对周围 3 米范围内所有敌人造成伤害。</p><p>·若命中两人以上，在回合末获得一层“魂”，持续到脱战。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "命中2人以上自动挂载回合末获魂特效。吸血询问自动（基于未减免伤害）。请遵循规则每次出招仅吸血一次。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "摄魂吸血(通用)",
                            "trigger": "hit",
                            "script": "if (!args.isHit) return;\nconst hun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shehun_hun\");\nif (!hun) return;\n\nconst rawDamage = args.damageResult.damage || 0;\nconst healAmount = Math.floor(rawDamage * 0.2);\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"摄魂魔刀 - 天诛地戮\" },\n    content: `<p>对目标 <b>${args.target.name}</b> 消耗一层 [魂] 进行吸血？</p><p>预计算吸血量: <b>${healAmount}</b> (20%)</p><p style=\"color:red; font-size:0.8em;\">注意：规则限制每次出招仅能吸血一次。</p>`,\n    yes: { label: \"吸血\", icon: \"fas fa-skull\" },\n    no: { label: \"不吸\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    await game.xjzl.api.effects.removeEffect(actor, \"shehun_hun\", 1);\n    await actor.applyHealing({ amount: healAmount, type: \"hp\", showScrolling: true });\n}",
                            "active": true
                        },
                        {
                            "label": "聚魂检测",
                            "trigger": "hit_once",
                            "script": "if (args.hitCount >= 2) {\n    const eff = thisItem.effects.getName(\"聚魂 (回合末)\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"命中多人，将在回合末获得 [魂]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血溅当场",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制目标虚招，刀架脖颈，身首异处，造成伤害。若消耗一层“魂”，此次吸血比例从 20%提高到 100%。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中后弹窗询问吸血。消耗魂自动提升比例（基于未减免伤害）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "摄魂吸血",
                            "trigger": "hit",
                            "script": "if (!args.isHit) return;\nconst hun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shehun_hun\");\nif (!hun) return;\n\n// 反击固定提升比例\nconst ratio = 1.0;\nconst rawDamage = args.damageResult.damage || 0;\nconst healAmount = Math.floor(rawDamage * ratio);\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"摄魂魔刀 - 血溅当场\" },\n    content: `<p>消耗一层 [魂] 进行吸血？</p><p>反击加成比例: <b>100%</b></p><p>预计算吸血量: <b>${healAmount}</b></p>`,\n    yes: { label: \"吸血\", icon: \"fas fa-skull\" },\n    no: { label: \"不吸\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    await game.xjzl.api.effects.removeEffect(actor, \"shehun_hun\", 1);\n    await actor.applyHealing({ amount: healAmount, type: \"hp\", showScrolling: true });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无间地狱",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀斩无间，摄魂夺魄，对目标造成伤害。若消耗一层“魂”，此次吸血比例从 20%提高到 100%。还会让目标陷入“封招”，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+2。</p>",
                    "automationNote": "封招自动。命中后弹窗询问吸血（基于未减免伤害）。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加封招",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"fengzhao\", { duration: { rounds: 1 } });\n    ui.notifications.info(`${args.target.name} 被封招！`);\n}",
                            "active": true
                        },
                        {
                            "label": "摄魂吸血",
                            "trigger": "hit",
                            "script": "if (!args.isHit) return;\nconst hun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shehun_hun\");\nif (!hun) return;\n\n// 绝招固定提升比例\nconst ratio = 1.0;\nconst rawDamage = args.damageResult.damage || 0;\nconst healAmount = Math.floor(rawDamage * ratio);\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"摄魂魔刀 - 无间地狱\" },\n    content: `<p>消耗一层 [魂] 进行吸血？</p><p>绝招加成比例: <b>100%</b></p><p>预计算吸血量: <b>${healAmount}</b></p>`,\n    yes: { label: \"吸血\", icon: \"fas fa-skull\" },\n    no: { label: \"不吸\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    await game.xjzl.api.effects.removeEffect(actor, \"shehun_hun\", 1);\n    await actor.applyHealing({ amount: healAmount, type: \"hp\", showScrolling: true });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "魂",
                    "icon": "icons/magic/death/skull-energy-light-purple.svg",
                    "description": "消耗以吸血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shehun_hun",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "聚魂 (回合末)",
                    "icon": "icons/magic/death/skull-energy-light-purple.svg",
                    "description": "回合结束时获得一层魂。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "temp_hun_gain",
                            "stackable": false,
                            "scripts": [
                                {
                                    "trigger": "turnEnd",
                                    "script": "const eff = thisItem.effects.getName(\"魂\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"回合结束，吸取生魂！\");\nawait thisEffect.delete();",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "赶尽杀绝",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>魔刀门钩锁绝技，但凡被盯上，通常下场极惨。</p><p><strong>需求：</strong>奇门-鞭钩</p><p><strong>属性：</strong>刚</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "赶尽杀绝",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>射出飞爪钩缠，造成 0.4 力量点内功伤害，并将自己不消耗速度牵引至其身旁空格。</p><p>·若目标无架招，招式释放距离+5。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "伤害自动。牵引效果手动。距离加成需手动判断（请自行确认距离）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    ui.notifications.info(\"请手动将自己移动至目标身旁。若目标无架招，本招式距离可视为 10米。\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "血魄凝精",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>魔刀门弟子收集他人鲜血，以特殊手段融入己身。过程极其痛苦，若融合的鲜血种类过多，相互冲突，就可能导致经脉逆行，爆体而亡。</p><p><strong>炼血</strong></p><p>消耗一分钟，将尸体心口精血逼出，进行[渡气]检定（难度 15），成功则汇聚出一滴殷红泛光的魔血。之后尸体浑身血液挥发逸散，变为干尸。</p><p><strong>魔血：</strong>配合魔刀门功法使用，杀伐之力倍增。</p><p>·一具成年尸体只能炼出一滴魔血。</p><p>·魔血只能存在十二个时辰。</p><p><strong>融血</strong></p><p>自身躺入刀棺，以内劲秘法牵引吸纳魔血。进行[忍耐]检定（难度 11），失败则进行死亡检定。</p><p>若成功，你每融血一次，气血+10，内力+10，但下一次融血的忍耐检定难度+1。</p><p><strong>升级：</strong>炼血的检定难度-2，融血的检定难度-2。</p>",
            "moves": [
                {
                    "name": "血魄凝精",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "其他",
                    "description": "<p>魔刀门弟子收集他人鲜血，以特殊手段融入己身。</p><p><strong>炼血：</strong>消耗一分钟，对尸体进行[渡气]检定（难度 15），成功获得魔血（RP道具）。尸体变为干尸。</p><p><strong>融血：</strong>消耗魔血进行[忍耐]检定（难度 11+N），成功则永久气血/内力+10，失败触发死检。</p><p><strong>升级：</strong>炼血的检定难度-2，融血的检定难度-2。</p>",
                    "automationNote": "纯手动/RP向。请GM协助判定炼血结果。融血请手动进行属性调整和死亡检定。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "血遁",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>魔刀门邪异功法，由血魔老祖所创。以自身血液为引，激发潜能，将速度短暂提升至极致。</p><p><strong>属性：</strong>阳</p>",
            "moves": [
                {
                    "name": "血遁",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "none",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>神色狰狞，血影遁行，选择范围内一处未被占据的空格，不消耗速度突进至那，并对周围 1 米范围内敌人造成 0.4 力量点内功伤害。</p><p><strong>消耗：</strong>气血上限 30%的气血或魔血*1</p><p><strong>升级：</strong>招式伤害+10，释放距离+5。</p>",
                    "automationNote": "出招时弹窗选择消耗魔血(手动)或气血(自动)。位移手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "血遁消耗决策",
                            "trigger": "attack",
                            "script": "const choice = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"血遁消耗\" },\n    content: \"请选择消耗方式：\",\n    yes: { label: \"消耗魔血 (手动扣除)\", icon: \"fas fa-tint\" },\n    no: { label: \"消耗气血 (30%上限)\", icon: \"fas fa-heart-broken\" }\n});\n\nif (choice) {\n    ui.notifications.info(\"玩家选择消耗魔血，请手动扣除物品。\");\n} else {\n    const maxHP = S.resources.hp.max;\n    const cost = Math.floor(maxHP * 0.3);\n    if (S.resources.hp.value <= cost) {\n        args.flags.abort = true;\n        args.flags.abortReason = \"气血不足以支付血遁消耗\";\n        return;\n    }\n    // 扣除气血 (真实伤害)\n    await actor.applyDamage({\n        amount: cost,\n        type: \"liushi\",\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(`血遁消耗 ${cost} 点气血`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "青云刀棍诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>威力不凡，大开大阖，善于正面搏杀。</p><p><strong>需求：</strong>刀-横刀/棍-长棍（升级提升刀等级）</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "飞花难现",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>以刀掩面，气定神闲，开启架招，格挡成功后，获得一层“眼力”，至多三层，持续到脱战。</p><p><strong>眼力：</strong>每层使你的命中+5。</p><p><strong>升级：</strong>格挡值+10，消耗+2。</p>",
                    "automationNote": "格挡获眼力自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-眼力",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"眼力\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "满目苍痍",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>持刀回转，连扫数刀，对直线上的敌人造成伤害。若击中招架中的敌人，自己获得一层“青云意”，持续到战斗脱离。</p><p>·若你的武器为长棍，则直线变为扇形范围敌人。</p><p><strong>升级：</strong>招式伤害+10，消耗+4。</p>",
                    "automationNote": "击中架招目标获青云意自动。范围形状、判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获青云意",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"青云意\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"击中架招目标，获得 [青云意]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "平步青云",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>迅速飞身跃起，俯视战场。使自己跃至空中 3 米高处，并且在自己下个回合开始时落地。</p><p><strong>升级：</strong>飞身高度+1 米，消耗+4。</p>",
                    "automationNote": "纯手动。请GM处理高度与落地。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "日月交汇",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>战意凛然，消耗一层青云意，使自己获得一层“蓄劲”，至多三层，持续到战斗脱离。</p><p><strong>蓄劲：</strong>每层使你招式暴击骰-1。</p><p><strong>升级：</strong>额外获得一层蓄劲，消耗+2。</p>",
                    "automationNote": "消耗青云意自动。获得蓄劲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗青云意",
                            "trigger": "attack",
                            "script": "const qingyun = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qingyunyi\");\nif (!qingyun) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"必须消耗 [青云意] 才能施展\";\n    return;\n}\nawait game.xjzl.api.effects.removeEffect(actor, \"qingyunyi\", 1);",
                            "active": true
                        },
                        {
                            "label": "获得蓄劲",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst gain = 1 + (lvl - 1); // 升级额外获得\nconst eff = thisItem.effects.getName(\"蓄劲\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff, gain);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "云卷三合",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>将刀以巧劲甩出，环绕周身飞掠一周，后顺势接刀，对周围斩出三道刀气，随机攻击范围内至多 3 个敌人（投掷 3 次 X 面骰子，X 是招式范围内的敌人数量，按投结果决定三次斩击的目标），造成伤害。</p><p>·你可以消耗任意层数的青云意，每消耗一层，可以让一道刀气斩向指定敌人。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，消耗+8。</p>",
                    "automationNote": "随机目标手动。消耗青云意指定目标手动。只提供单次伤害计算，请多次应用。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "操作提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请根据敌人数量手动投掷随机目标，或手动消耗 [青云意] 指定目标。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "眼力",
                    "icon": "icons/svg/eye.svg",
                    "description": "命中增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yanli",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "青云意",
                    "icon": "icons/magic/air/wind-stream-blue-gray.webp",
                    "description": "特殊资源。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingyunyi",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "蓄劲",
                    "icon": "icons/magic/symbols/star-yellow.webp",
                    "description": "暴击阈值降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xujin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "灭生四式",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>自塞外雪山当中发现的刀法残篇，据说源于北海遗族，此刀法自杀戮当中诞生，吞噬生命，可惜千年遗落，此刀法只余留残篇。</p><p>·此武学只能领悟，无法继续投入修为。</p><p><strong>需求：</strong>杀孽 50</p><p><strong>类型：</strong>刀-双刀 <strong>属性：</strong>阴</p>",
            "requirements": "杀孽50；刀-双刀",
            "moves": [
                {
                    "name": "永夜无光",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双刀染血，流失 80 点气血，开启招架。成功格挡时，自身进入“灭生”状态，持续一回合。开启招架时，你免疫“定身”“禁足”一回合。</p><p><strong>灭生：</strong>你暴击时，造成的伤害变为气血流失。</p><p><strong>升级：</strong>格挡值+10，流失的气血-20。</p>",
                    "automationNote": "气血流失自动。格挡获灭生自动。开启获免疫自动(仅提示)。灭生变流失自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "流失气血&免疫",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst hpCost = 80 - (lvl - 1) * 20;\nawait actor.applyHealing({amount: -hpCost, type: \"hp\", showScrolling: true});\n\nconst immuneEff = thisItem.effects.getName(\"永夜免疫\").toObject();\ndelete immuneEff._id;\nimmuneEff.origin = thisItem.uuid;\nimmuneEff.duration = {rounds: 1};\nawait game.xjzl.api.effects.addEffect(actor, immuneEff);",
                            "active": true
                        },
                        {
                            "label": "格挡-灭生",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"灭生\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = {rounds: 1};\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "生灭如絮",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>刀气如从天而降，扫向周围，对范围内所有敌人造成伤害。</p><p>击破架招时，将目标击飞 1 米，使目标陷入“禁足”一回合。</p><p>·若你处于“灭生”状态，此招式距离+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "灭生加距离提示。击破施加禁足自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "距离检测",
                            "trigger": "calc",
                            "script": "const hasMiesheng = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"miesheng\");\nif (hasMiesheng) {\n    args.output.bonusDesc.push(\"灭生状态：距离 +1 米\");\n}",
                            "active": true
                        },
                        {
                            "label": "击破-禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被禁足！(需手动击飞1米)`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "问枯冢",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招的时候，你可以用反应动作释放此招，压制对方虚招，对目标造成伤害，刀光入地，斩出一道 1m*3 米，深度 2m 的坑冢，敌人会直接落入坑中。</p><p>·若你处于“灭生”状态，使目标随机一条腿“骨折”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "落坑手动。灭生骨折提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "骨折提示",
                            "trigger": "hit",
                            "script": "const hasMiesheng = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"miesheng\");\nif (hasMiesheng) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><div class=\"card-header\"><b>问枯冢 - 灭生特效</b></div><div style=\"padding:5px;\">目标 <b>${args.target.name}</b> 随机一条腿骨折，请手动投掷伤残表或应用效果。</div></div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "红尘一入灭",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "8米",
                    "targetInfo": "路径",
                    "actionCost": "全回合动作",
                    "description": "<p>双刀悲鸣，向前连踏最多七步，正面碰到敌人/障碍物后停止前行。刀光所过，红尘消散，对途径路上周围 1m 的敌人造成伤害，并且击倒所有敌人，被这一击打入濒死的敌人，无法进行濒死一击。</p><p>·若你处于“灭生”状态，被打入濒死的角色残疾与死亡检定具有劣势。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+16。</p>",
                    "automationNote": "路径伤害与击倒手动。濒死限制手动。灭生劣势手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "灭生",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "暴击造成气血流失。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "miesheng",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "暴击转流失",
                                    "trigger": "preDamage",
                                    "script": "if (args.outcome.isCrit) {\n    args.config.type = 'liushi';\n    ui.notifications.info(\"灭生生效：暴击转化为气血流失\");\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "永夜免疫",
                    "icon": "icons/svg/shield.svg",
                    "description": "免疫定身、禁足 (手动)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yongye_immune",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ],
            "progression": {
                "mode": "custom",
                "customThresholds": [
                    0
                ],
                "mappedStage": 0
            }
        }
    },
    {
        "name": "桃花扇",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>本为文人雅客所创，扇叶舞动间，桃花飞舞，煞是好看，后被采花贼习得，配合迷香，声誉虽损，却也名扬江湖。</p><p><strong>需求：</strong>匕首-扇 <strong>属性：</strong>阴</p>",
            "requirements": "匕首-扇",
            "moves": [
                {
                    "name": "别枝印潭",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>折扇轻弹，散出阵阵花香，开启招架，格挡成功时，也会触发武器涂抹毒药的效果。（视为消耗一次攻击涂抹毒素效果）</p><p><strong>升级：</strong>每升一级增加格挡值 5 点，消耗+1。</p>",
                    "automationNote": "格挡提示触发毒药手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "毒药提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功：请手动触发武器涂抹的毒药效果。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "桃之夭夭",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>桃花扇起，卷起疾风，扇身直刺，对目标造成伤害，击破招架时，可以将武器涂抹毒药的效果一次性全部触发。</p><p><strong>升级：</strong>伤害+5，消耗+1。</p>",
                    "automationNote": "击破提示触发毒药手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "毒药提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招：请手动触发武器毒药全部效果。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "春风拂面",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>扇卷清风，扫向目标，对目标造成伤害，击中未招架目标时，使目标陷入“下盘不稳”一回合。</p><p>出招前，你可以选择将一份扩散型毒药展开，随着攻击洒出，视为在目标位置释放此毒药，若如此，此招变为蓄力动作施展。</p><p><strong>升级：</strong>伤害+5，消耗+1。</p>",
                    "automationNote": "施加下盘不稳自动。毒药释放手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 下盘不稳！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "倒转迷香",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>闪身回旋，扇扫周身，扬起风尘，对周围所有敌人造成伤害，若攻击范围内有扩散型毒药存在，则使毒药范围布满你的攻击范围。</p><p><strong>升级：</strong>造成伤害+10，消耗+5，怒气消耗-1。</p>",
                    "automationNote": "毒药扩散范围手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            5,
                            10,
                            15
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "素女莲",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>天伶教资质出众的教众，均会修行此法，丝带内衬银丝，缠于腰间，既可对敌，又修塑身形，挥舞之时，内力灌注，行如刀劈斧砍，观似白莲绽放，威力极大。</p><p><strong>需求：</strong>奇门-鞭钩 <strong>属性：</strong>柔</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "飞仙流",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>飘带飞舞，盘绕周身，开启架招。格挡成功后可以借力飘动，闪身后退 1 米。</p><p><strong>升级：</strong>格挡值+10，后退距离+1 米，消耗+2。</p>",
                    "automationNote": "后退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "后退提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const dist = 1 + (lvl - 1);\n    ui.notifications.info(`格挡成功：可闪身后退 ${dist} 米。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "奉天莲",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>丝带如云狂舞，横扫周围，对周围所有敌人造成伤害。</p><p>如果有敌人处在空中，则可以消耗反应施展。</p><p><strong>升级：</strong>招式伤害+10。内力消耗+4。</p>",
                    "automationNote": "反应动作判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "绽天莲",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>将丝带束为一剑，飞刺而出，触敌之时，层叠飞散，对目标造成伤害，而后迅速收回，并将对手向自己方向击飞 3 米。</p><p>·当剑熟练到达 3 时，此招可额外获得剑技能提供的伤害加值。</p><p>·当剑熟练到达 6 时，此招可攻击招式路线（一条直线）上的所有敌人。</p><p>·当剑熟练达到 9 时，此招范围可变成周围全部敌 人。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+4。</p>",
                    "automationNote": "剑技能伤害加成自动。范围变化需手动选择目标。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "剑技能加成",
                            "trigger": "calc",
                            "script": "const swordRank = actor.system.combat.weaponRanks.sword.total || 0;\nif (swordRank >= 3) {\n    let rankDmg = 0;\n    if (swordRank <= 4) rankDmg = swordRank * 1;\n    else if (swordRank <= 8) rankDmg = swordRank * 2;\n    else rankDmg = swordRank * 3;\n    \n    args.output.damage += rankDmg;\n    args.output.bonusDesc.push(`剑技能加成 +${rankDmg}`);\n}\n\nif (swordRank >= 6) {\n    args.output.bonusDesc.push(\"剑术>=6：范围变为直线\");\n}\nif (swordRank >= 9) {\n    args.output.bonusDesc.push(\"剑术>=9：范围变为周围全部\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "烈女歌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>以特殊的运功技巧，通过刺激穴道，大幅增加毒药的效果。</p><p><strong>效果：</strong>当有角色吸入扩散性毒药时，你可以消耗反应动作，对其进行一次点穴检定，检定成功不会使对方陷入“点穴”状态，而是使对方针对此次毒药的韧性检定难度+5。</p><p><strong>升级：</strong>此次点穴检定+5，韧性难度+5</p>",
            "requirements": "特殊",
            "moves": [
                {
                    "name": "烈女歌",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "视毒药",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当有角色吸入扩散性毒药时，你可以消耗反应动作，对其进行一次点穴检定，检定成功不会使对方陷入“点穴”状态，而是使对方针对此次毒药的韧性检定难度+5。</p><p><strong>升级：</strong>此次点穴检定+5，韧性难度+5</p>",
                    "automationNote": "需手动施展。发送卡片提示对方增加难度。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = (lvl - 1) * 5;\nconst totalDiff = 5 + bonus;\n\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">烈女歌</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>消耗反应动作。</p>\n            <p>对吸入毒药者进行 <b>点穴检定</b> (气感)。</p>\n            <p>若成功，目标针对此次毒药的韧性检定难度 <b>+${totalDiff}</b>。</p>\n            <hr>\n            <p style=\"color:#888; font-size:0.8em;\">请 GM 手动主持检定。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "白鸿飞仙剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>白鸿剑派掌门，闯荡江湖，与诸多剑法高手切磋之后，总结出的一套剑法，剑如飞鸟临地，势不可挡，飘然如仙，只不过绝招尚未创出，终究少了一分凌厉。</p><p><strong>需求：</strong>剑-单剑 属性：太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "千羽破云",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>衣袂翻飞间隐现鸿影，剑光如散落白羽笼罩两丈。对所有敌人造成 0.5 内息点内功伤害。击中无招架敌人时，给敌人添加“禁虚”状态，持续一回合。</p><p><strong>禁虚：</strong>无法施展虚招</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "对无架招目标施加禁虚自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招禁虚",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (!args.target.system.martial.stanceActive) {\n    // 获取系统通用状态：禁虚 (jinxu)\n    const status = CONFIG.statusEffects.find(e => e.id === \"jinxu\");\n    if (status) {\n        // 克隆并修改持续时间为1回合\n        const data = foundry.utils.deepClone(status);\n        data.duration = { rounds: 1 };\n        // 调用 API 应用\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 未开启招架，被禁虚！`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "白鸿掠水",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑尖贴地三寸疾扫，待敌俯身格挡时陡然上挑，化作鸿雁振翅击喉之势，对目标造成 0.4 内息点内功伤害。击破敌方招架时，可以消耗反应动作，施展【千羽破云】。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><div class=\"card-header\" style=\"border-bottom:1px solid #ccc;font-weight:bold;\">白鸿掠水 - 击破触发</div><div style=\"padding:5px;font-size:0.9em;\">击破敌方招架！<br>可消耗反应动作，施展【千羽破云】。</div></div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "云崖折翼",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑身横转似断翅斜坠，以剑脊弧形卸力，开启架招，格挡成功时，寒光四散，击退目标 1 米并使目标陷入“禁足”，持续两回合。</p><p><strong>升级:</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "施加禁足自动。击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡反击",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (!args.attacker) return;\n\n// 施加系统通用状态：禁足 (root)\nconst status = CONFIG.statusEffects.find(e => e.id === \"root\");\nif (status) {\n    const data = foundry.utils.deepClone(status);\n    data.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.attacker, data);\n    \n    actor.showFloatyText(\"寒光四散\", {fill: \"#00BFFF\"});\n    ui.notifications.info(`${args.attacker.name} 被击退1米并禁足！`);\n}"
                        }
                    ]
                },
                {
                    "name": "寒潭惊鸿",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>屈膝贴地，剑气凝霜，使你获得“惊鸿”状态，持续一回合。</p><p><strong>惊鸿：</strong>你的白鸿剑法可以攻击范围内所有敌人。</p><p><strong>升级:</strong>消耗+3 持续回合数+1。</p>",
                    "automationNote": "获得状态自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            3,
                            6,
                            9
                        ],
                        "rage": [
                            2,
                            2,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得惊鸿",
                            "trigger": "hit",
                            "active": true,
                            "script": "const eff = thisItem.effects.getName(\"惊鸿\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\neff.duration = { rounds: rounds };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "惊鸿",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "白鸿剑法可以攻击范围内所有敌人。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jinghong",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "神火剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>神火教剑招，烈火飞舞，透露燃烧自我的疯狂之意。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "天火冲涌",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，剑指蓄力，抬剑轰斩，对自身周围敌人造成 0.4 内息点内功伤害。</p><p>·若自身处于“引燃”，招式释放距离+1</p><p><strong>升级：</strong>招式伤害+10，释放距离再+1，内力消耗+4。</p>",
                    "automationNote": "伤害计算自动。检测引燃并提示距离增加。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "引燃提示",
                            "trigger": "attack",
                            "script": "const yinran = actor.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'yinran');\nif (yinran) {\n    ui.notifications.info(`${actor.name} 处于 [引燃] 状态，天火冲涌 释放距离+1。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "心火乍燃",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，挥舞长剑，烈火乍起，开启架招。格挡成功后，自身陷入“引燃”，持续到战斗脱离，同时获得一层“凡火”，最多三层，持续到脱战。</p><p><strong>凡火：</strong>你对他人造成火焰伤害时，每有一层凡火，额外造成 5 火焰伤害。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡自动施加引燃和凡火。凡火增伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡触发",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 1. 自身获得引燃\nconst yinranData = thisItem.effects.getName('引燃').toObject();\ndelete yinranData._id;\nyinranData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, yinranData);\n\n// 2. 获得凡火 (Max 3)\nconst fanhuoData = thisItem.effects.getName('凡火').toObject();\ndelete fanhuoData._id;\nfanhuoData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, fanhuoData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "地火飘翻",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑身刺地，翻转火花，对目标造成 0.4 内息点内功伤害，命中无架招目标时，使其陷入“引燃”，持续到战斗脱离。</p><p>·自身每有一层“凡火”，虚招值+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "凡火加虚招值自动。命中无架招施加引燃自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "凡火加成",
                            "trigger": "calc",
                            "script": "const fanhuo = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'fanhuo');\nif (fanhuo) {\n    const stacks = fanhuo.getFlag('xjzl-system', 'stacks') || 1;\n    args.output.feint += stacks;\n    args.output.bonusDesc.push(`凡火加成: +${stacks} 虚招值`);\n}",
                            "active": true
                        },
                        {
                            "label": "施加引燃",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effectData = thisItem.effects.getName('引燃').toObject();\n    delete effectData._id;\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n    ui.notifications.info(`${args.target.name} 被引燃！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "火中长生",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，心火燃起，四肢百骸，火中长存。消耗气血最大值 10%的气血，获得一层“凡火”，最多三层，持续到脱战。</p><p>·若你已经有三层“凡火”，施展此招时会将三层“凡火”移除，获得“疯火”，持续到战斗脱离。</p><p><strong>疯火：</strong>你对他人造成火焰伤害时，额外造成 10 点火焰伤害，同时回复 10 点气血。</p><p><strong>升级：</strong>额外获得一层凡火，疯火造成的火焰伤害和回复的气血+10。</p>",
                    "automationNote": "扣血自动。凡火/疯火转化及效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "火中长生",
                            "trigger": "hit",
                            "script": "// 1. 扣除 10% 最大气血\nconst hpCost = Math.floor(actor.system.resources.hp.max * 0.1);\nawait actor.applyHealing({amount: -hpCost, type: 'hp', showScrolling: true});\n\n// 2. 检查凡火\nconst fanhuo = actor.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'fanhuo');\nconst currentStacks = fanhuo ? (fanhuo.getFlag('xjzl-system', 'stacks') || 1) : 0;\n\n// 升级后每次获得层数 (Lv1=1, Lv2+=1)\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst gainStacks = 1 + (lvl - 1);\n\nif (currentStacks >= 3) {\n    // 转化疯火\n    if (fanhuo) await fanhuo.delete();\n    \n    const fenghuoData = thisItem.effects.getName('疯火').toObject();\n    delete fenghuoData._id;\n    fenghuoData.origin = thisItem.uuid;\n    \n    // 升级加成写入 Flag (疯火特效里读取)\n    const bonus = (lvl - 1) * 10;\n    fenghuoData.flags['xjzl-system'].fenghuoBonus = bonus;\n    // 动态修改疯火的伤害加成 (基础10 + 成长)\n    const totalFireDmg = 10 + bonus;\n    fenghuoData.changes[0].value = String(totalFireDmg);\n\n    await game.xjzl.api.effects.addEffect(actor, fenghuoData);\n    ui.notifications.info(`${actor.name} 凡火已极，化为疯火！`);\n} else {\n    // 获得凡火\n    const fanhuoData = thisItem.effects.getName('凡火').toObject();\n    delete fanhuoData._id;\n    fanhuoData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, fanhuoData, gainStacks);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "神火百杀",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，烈焰指天，火剑飞舞，对目标造成 0.7 内息点内功伤害。若目标处于“引燃”状态，则立刻焚毁对方身上一件金品及以下的防具。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+4。</p>",
                    "automationNote": "检测引燃自动。焚毁防具提示GM手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "焚甲提示",
                            "trigger": "hit",
                            "script": "const isYinran = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'yinran');\nif (isYinran) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"background:#e74c3c; color:white; font-weight:bold;\">神火百杀 - 焚甲特效</div>\n            <div style=\"padding:5px;\">\n                <p>目标 <b>${args.target.name}</b> 处于 [引燃] 状态。</p>\n                <p>请GM手动焚毁其一件 <b>金品及以下</b> 的防具。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "引燃",
                    "icon": "icons/magic/fire/flame-burning-skeleton-orange.webp",
                    "description": "被神火点燃。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinran",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "凡火",
                    "icon": "icons/magic/fire/flame-burning-campfire-orange.webp",
                    "description": "造成火焰伤害时，每层额外造成 5 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fanhuo",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.fire.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "疯火",
                    "icon": "icons/magic/fire/elemental-fire-flying-orange.webp",
                    "description": "造成火焰伤害时增加伤害并回血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenghuo",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "疯火回血",
                                    "trigger": "hit",
                                    "active": true,
                                    "script": "if (args.type === 'attack' && args.config?.element === 'fire') {\n    // 读取升级加成 (基础10 + Bonus)\n    const bonus = Number(thisEffect.getFlag('xjzl-system', 'fenghuoBonus')) || 0;\n    const heal = 10 + bonus;\n    await actor.applyHealing({amount: heal, type: 'hp', showScrolling: true});\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.fire.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "哭五更",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>白事传统基本功，需情真意切，肝肠寸断，让人不自觉之中就被牵动心念。</p><p><strong>需求：</strong>奇门-无需武器</p><p><strong>属性：</strong>阴</p>",
            "requirements": "奇门-无需武器",
            "moves": [
                {
                    "name": "追往昔",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，垂目而立，开启架招。格挡成功后，为目标添加一层“恸哭”，最高三层，持续到战斗脱离。</p><p><strong>恸哭：</strong>每层使你速度-1，回合末流失 5 点内力。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡施加恸哭自动。恸哭效果（减速、流失内力）自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡施加恸哭",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    const effData = thisItem.effects.getName('恸哭').toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "寄哀思",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>反应动作，当你看破对方虚招时，可消耗反应动作，压制对方，面容凄苦，向对方长叹一口浊气，造成 0.5 内息点内功伤害。</p><p>若对方存在“恸哭”，使其“耳鸣”一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "检测恸哭施加耳鸣自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "恸哭耳鸣",
                            "trigger": "hit",
                            "script": "const hasTongku = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'tongku');\nif (args.isHit && hasTongku) {\n    await game.xjzl.api.effects.toggleStatus(args.target, 'deaf', true);\n    ui.notifications.info(`${args.target.name} 因恸哭而耳鸣！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "泣平生",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，捶胸顿足，嚎啕大哭，所听之人无不感同身受，对范围内目标造成 0.3 内息点内功伤害，击破架招时，为其添加一层“恸哭”，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+5，消耗+2。</p>",
                    "automationNote": "击破施加恸哭自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破施加恸哭",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effData = thisItem.effects.getName('恸哭').toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n    ui.notifications.info(`${args.target.name} 被击破架招，陷入恸哭！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "心悲切",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，无语凝噎，面如死灰，所看之人无不动容。对目标造成 0.4 内息点内功伤害，击中无架招目标时，目标进行[定力]检定（难度 10），若失败，双眼被泪水模糊，陷入“目盲”一回合。</p><p><strong>升级：</strong>招式伤害+5，检定难度+1，内力消耗+1。</p>",
                    "automationNote": "无架招判定自动。发起定力检定请求自动。失败施加目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "定力检定",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dc = 10 + (lvl - 1);\n    \n    // 构造目盲效果数据\n    const blindData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === 'blind'));\n    blindData.duration = { rounds: 1 };\n\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"dingli\",\n        dc: dc,\n        label: \"抵抗悲切\",\n        onFail: blindData\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "痛断肠",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，对目标造成 0.6 内息点内功伤害，目标每有一层“恸哭”，你获得一层基础战斗状态（人级叠加层数类，由你自己选择）。</p><p><strong>升级：</strong>招式伤害+10，消耗+2，怒气-1。</p>",
                    "automationNote": "提示手动添加Buff。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "Buff提示",
                            "trigger": "hit",
                            "script": "const tongku = args.target.effects.find(e => e.getFlag('xjzl-system', 'slug') === 'tongku');\nconst stacks = tongku ? (tongku.getFlag('xjzl-system', 'stacks') || 1) : 0;\n\nif (stacks > 0) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"background:#8e44ad; color:white;\">痛断肠 - 效果触发</div>\n            <div style=\"padding:5px;\">\n                <p>目标拥有 <b>${stacks}</b> 层 [恸哭]。</p>\n                <p>请手动为自己添加 <b>${stacks}</b> 层任意 [人级叠加类状态]。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "恸哭",
                    "icon": "icons/svg/rain.svg",
                    "description": "速度降低，内力流失。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tongku",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "内力流失",
                                    "trigger": "turnEnd",
                                    "active": true,
                                    "script": "const stacks = thisEffect.getFlag('xjzl-system', 'stacks') || 1;\nawait actor.applyHealing({amount: -(stacks * 5), type: 'mp', showScrolling: true});"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "闹阴婚",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p><strong>需求：</strong>乐器-喇叭</p><p><strong>属性：</strong>柔</p>",
            "requirements": "乐器-喇叭",
            "moves": [
                {
                    "name": "起轿迎新",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，对目标造成 0.4 力量点内功伤害，击破架招时，为其添加“禁足”，持续三回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破禁足",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === 'root');\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被禁足！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "婚婚噩噩",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，开启架招，格挡成功后，为目标添加“错乱”，持续一回合。</p><p><strong>错乱：</strong>你的每个回合末，朝 D4 随机方向不消耗速度走出一步，然后倒地。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2</p>",
                    "automationNote": "格挡施加错乱自动。错乱随机移动和倒地自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡施加错乱",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    const eff = CONFIG.statusEffects.find(e => e.id === 'cuoluan');\n    if(eff) {\n        // 注入错乱的具体脚本\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        \n        // 确保 flags 结构存在\n        if (!data.flags['xjzl-system']) data.flags['xjzl-system'] = {};\n        \n        // 添加 TurnEnd 脚本\n        data.flags['xjzl-system'].scripts = [{\n            label: \"错乱随机移动\",\n            trigger: \"turnEnd\",\n            active: true,\n            script: \"ChatMessage.create({content: `${actor.name} 处于错乱，请朝 D4 方向移动一步。`, speaker: ChatMessage.getSpeaker({actor: actor})}); await game.xjzl.api.effects.toggleStatus(actor, 'prone', true);\"\n        }];\n\n        await game.xjzl.api.effects.addEffect(args.attacker, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "郎情妾意",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，对目标造成 0.5 力量点内功伤害，命中无架招目标时，为其添加“错乱”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中无架招施加错乱自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加错乱",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === 'cuoluan');\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        // 同样注入脚本\n        if (!data.flags['xjzl-system']) data.flags['xjzl-system'] = {};\n        data.flags['xjzl-system'].scripts = [{\n            label: \"错乱随机移动\",\n            trigger: \"turnEnd\",\n            active: true,\n            script: \"ChatMessage.create({content: `${actor.name} 处于错乱，请朝 D4 方向移动一步。`, speaker: ChatMessage.getSpeaker({actor: actor})}); await game.xjzl.api.effects.toggleStatus(actor, 'prone', true);\"\n        }];\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "痴男怨女",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>反应动作，当你看破虚招时，可消耗反应动作，压制对方，造成 0.6 力量点内功伤害。</p><p>若对方拥有“错乱”，招式伤害类型变为精神伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "检测错乱并修改伤害类型自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "精神伤害转换",
                            "trigger": "preDamage",
                            "script": "const hasCuoluan = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'cuoluan');\nif (hasCuoluan) {\n    args.config.type = 'mental';\n    ui.notifications.info(\"目标错乱，伤害转化为 [精神]！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天人永隔",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，对目标造成 0.8 力量点内功伤害，并将目标朝任意方向击退至 5 米。</p><p><strong>升级：</strong>招式伤害+20，内力消耗+4。</p>",
                    "automationNote": "击退效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    ui.notifications.info(`${args.target.name} 被击退至 5 米！(请手动移动)`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "神女舞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>瑶池宫的武学，缠绵悱恻，额蹙心痛，以柔克刚、最是难当。</p><p><strong>需求：</strong>奇门-鞭钩</p><p><strong>属性：</strong>阴</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "夜挑灯",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>-神女摇曳，舞姿婀娜-</p><p>主要动作，仙女私语，灯火摇曳。丝带飘舞，蒙眼拉扯，造成 0.4 内息点内功伤害，击破敌人招架时，对其添加“迟滞”一回合。</p><p><strong>迟滞：</strong>·你失去反应动作。<br>·你进行属性检定时-5 且具有劣势。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加迟滞自动。迟滞效果（禁反+检定劣势）自动，检定数值惩罚手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破施加迟滞",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === 'chizhi');\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        // 迟滞效果在 Config 中定义为空，补充效果\n        // 1. 失去反应动作 -> 禁反\n        // 2. 检定劣势\n        data.changes = [\n            { key: \"flags.xjzl-system.blockCounter\", mode: 5, value: \"true\" },\n            { key: \"flags.xjzl-system.globalCheckLevel\", mode: 2, value: \"-1\" }\n        ];\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 陷入 [迟滞]！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "流逝水",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "直线",
                    "actionCost": "主要动作",
                    "description": "<p>-仙女飞天，丝带如剑-</p><p>主要动作，韶华流逝水，新叶看旧花。丝带横挥舞宛若利剑，对范围内一条直线的所有敌人造成 0.5 内息点内功伤害。</p><p>若目标处于“迟滞”，你可以消耗反应动作释放此招，挥舞拉扯，对其造成伤害并将对方拉扯至你身前。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "拉扯效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "拉扯提示",
                            "trigger": "hit",
                            "script": "const isChizhi = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'chizhi');\nif (args.isHit && isChizhi) {\n    ui.notifications.info(`目标 [迟滞]，可消耗反应动作将其拉扯至身前。(手动)`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "诉离殇",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>-双手捧心，如泣如诉-</p><p>次要动作，诉离殇，惆怅垂涕，求之至曙，开启招架。</p><p>成功格挡后，与目标进行一次神采对抗，若你胜出，则目标心生怜惜，对你造成伤害减少 10 点。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2，伤害减少+5。</p>",
                    "automationNote": "神采对抗自动。减伤需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "神采对抗",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    // 计算减伤数值仅做显示\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const reduction = 10 + (lvl - 1) * 5;\n\n    await Macros.requestContest({\n        attacker: actor,\n        defender: args.attacker,\n        type: \"shencai\",\n        defType: \"shencai\",\n        label: \"诉离殇 - 神采对抗\",\n        outcome: {\n            win: { text: `目标心生怜惜！请手动返还 HP ${reduction} 点。` },\n            lose: { text: \"目标铁石心肠。\" }\n        }\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "梦中人",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>-神女如梦，如梦如幻-</p><p>当你看破对方虚招时，可消耗反应动作施展此招，压制虚招，如梦似幻，不分虚实，对其造成 0.7 内息点内功伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无特殊效果。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "夜归而去",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>-乘夜而去，永不再见-</p><p>主要动作，神独享而未结兮，魂茕茕以无端。造成 0.7 内息点内功伤害，并为目标添加“窒息”，持续三回合。</p><p><strong>升级：</strong>招式伤害+20，内力消耗+4，怒气消耗-1。</p>",
                    "automationNote": "施加窒息自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加窒息",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = thisItem.effects.getName('窒息').toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    effData.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n    ui.notifications.info(`${args.target.name} 感到 [窒息]！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "窒息",
                    "icon": "icons/magic/air/fog-gas-smoke-swirling-white.webp",
                    "description": "无法呼吸。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhixi",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "娥皇女英",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>瑶池宫的独门武学，据说只有双胞胎姐妹才可以学习。</p><p><strong>需求：</strong>双胞胎姐妹，并学习《神女赋》</p>",
            "requirements": "双胞胎姐妹；学习《神女赋》",
            "moves": [
                {
                    "name": "娥皇女英",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "10米",
                    "targetInfo": "友方",
                    "actionCost": "反应动作",
                    "description": "<p>回合末（结算其他效果前），你可以消耗反应动作，将身上的一个状态转移到你的血脉同胞身上。</p>",
                    "automationNote": "纯手动。请自行操作状态转移。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            6
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "服毒法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>鬼灵门特殊的服毒法门，使用特殊毒囊包裹，将毒药藏于口中。</p><p><strong>需求：</strong>毒药 特制毒囊（20L）</p>",
            "requirements": "毒药；特制毒囊（20L）",
            "moves": [
                {
                    "name": "服毒法",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "无",
                    "description": "<p>你在濒死状态下，可以直接选择咬破毒囊，触发毒囊内毒药的服毒效果，此毒药若是使你进行死亡检定，则死亡检定必定为 1。</p>",
                    "automationNote": "手动。请在濒死时使用物品栏中的毒药。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "乱神噬心",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>合欢派蛊术，侵蚀三魂七魄，中招者或在幻象中沉沦，或在剧痛中癫狂，最终都化作蛊的养分。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "乱神噬心",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "25米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，口吹尖哨，邪蛊飞扑，对方进行一个[定力]检定（难度14），失败则迷失神智，陷入“乱心”，持续两回合。</p><p><strong>乱心：</strong>你持续陷入“封招”和“缚身”；在你的回合，你必须朝为你添加此状态的目标直线移动。</p><p><strong>升级：</strong>检定难度+3。</p>",
                    "requirements": "物品：迷神蛊*1",
                    "automationNote": "物品消耗需手动。检定请求与状态应用自动。强制移动需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "定力检定",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 14 + (lvl - 1) * 3;\n\n// 获取AE模板\nconst effData = thisItem.effects.getName(\"乱心\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: dc,\n    label: \"抵抗乱神噬心\",\n    onFail: effData\n});",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "乱心",
                    "icon": "icons/magic/control/hypnosis-mesmerism-eye.webp",
                    "description": "持续陷入“封招”和“缚身”；在你的回合，你必须朝为你添加此状态的目标直线移动。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "luanshenshixin_luanxin",
                            "stackable": false
                        }
                    },
                    "duration": {
                        "rounds": 2
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.blockShiZhao",
                            "mode": 5,
                            "value": "true"
                        },
                        {
                            "key": "flags.xjzl-system.fushen",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "雾锁腐蛊",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>合欢派蛊术，腐坏化薄雾，吸入则不宁。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "雾锁腐蛊",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "15米",
                    "targetInfo": "地面",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，血滴掌心邪蛊，选择范围内一个空格，弹出蛊虫，在目标周围3米范围形成淡绿色的‘腐蛊雾霭’，持续三回合。</p><p><strong>腐蛊雾霭：</strong>该区域不会影响敌我视线，在区域内的角色进行命中检定和虚招对抗时具有劣势。</p><p>·若区域内角色离开此区域（消耗移动速度，施展轻功，被击飞、击退），则陷入“眩晕”一回合。</p><p>·你只能在战场布置一个‘腐蛊雾霭’。</p><p><strong>升级：</strong>战场可布置的最大数量+1。</p>",
                    "requirements": "物品：迷神蛊*1",
                    "automationNote": "物品消耗需手动。区域布置与效果需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst maxCount = 1 + (lvl - 1);\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">雾锁腐蛊 (上限 ${maxCount})</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>请手动放置 [腐蛊雾霭] 区域 (3米/3回合)。</p>\n            <p><b>区域效果:</b> 命中/虚招对抗劣势。</p>\n            <p><b>离开惩罚:</b> 陷入 [眩晕] (手动应用)。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "欢邪双刃",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>合欢派秘技刀法，邪魅狠辣，融入刀光，暗藏噬补与迷心之术。</p><p><strong>需求：</strong>刀-双刀</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀-双刀",
            "moves": [
                {
                    "name": "葬死欢场",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "liushi",
                    "weaponType": "blade",
                    "range": "20米",
                    "targetInfo": "单体",
                    "actionCost": "简要动作",
                    "description": "<p>简要动作，挥舞刀风，似情人私语，怨侣纠缠，敌人进行[定力]检定（难度15），若失败，受到0.2内息+0.3神采点气血流失（不会造成暴击），并陷入“禁足”，持续两回合。</p><p>·若敌人为异性，检定难度+5。</p><p><strong>升级：</strong>招式伤害+20，内力消耗+4，怒气消耗-1。</p>",
                    "automationNote": "禁足检定自动。异性判断尝试自动。伤害需手动应用。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.2
                            },
                            {
                                "prop": "shencai",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "定力检定与流失提示",
                            "trigger": "hit",
                            "script": "// 1. 计算流失伤害 (面板值)\nconst bleedDmg = args.finalAmount || args.damageResult?.damage || 0;\n\n// 2. 异性判断\nconst selfGender = actor.system.info?.gender;\nconst targetGender = args.target.system.info?.gender;\nlet dc = 15;\nif (selfGender && targetGender && selfGender !== targetGender) {\n    dc += 5;\n}\n\n// 3. 构建禁足AE\nconst rootEff = CONFIG.statusEffects.find(e => e.id === \"root\");\nlet effectData = null;\nif (rootEff) {\n    effectData = foundry.utils.deepClone(rootEff);\n    effectData.duration = { rounds: 2 };\n}\n\n// 4. 发起检定\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: dc,\n    label: \"抵抗葬死欢场\",\n    onFail: effectData // 失败自动挂禁足\n});\n\n// 5. 伤害提示\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">葬死欢场 - 伤害结算</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>如果目标<b>检定失败</b>，请GM手动应用流失伤害：</p>\n            <p style=\"font-size:1.2em; color:red; font-weight:bold;\">${bleedDmg} 点 (流失)</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "裂帛摧心",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招。双腕急颤，钻刀聚煞，对敌人造成伤害。若目标受伤后陷入重伤（气血不足50%），自身回复100点气血。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "重伤回血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "重伤回血",
                            "trigger": "hit",
                            "script": "// 检查目标当前气血比例\nconst targetHp = args.target.system.resources.hp.value;\nconst targetMax = args.target.system.resources.hp.max;\n\nif (targetMax > 0 && (targetHp / targetMax) < 0.5) {\n    await actor.applyHealing({ amount: 100, type: \"hp\", showScrolling: true });\n    ui.notifications.info(\"目标陷入重伤，自身回复气血！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "缠丝牵魂",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，双足错立，腰如杨柳，旋身舞刀。</p><p>划弧对周围敌人造成伤害。命中无架招敌人时为其添加“封招”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "封招状态应用自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "封招",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被封招！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "魅蝶振翅",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，双刀交叠，撕裂罗衫，开启架招。若自身没有装备【防具-上衣】，格挡成功后，令攻击者减少1点怒气。若攻击者没有怒气，则为其添加“禁实”，持续一回合。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "上衣检测自动。削怒与禁实自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡特效",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 检测是否装备上衣\nconst hasTop = actor.itemTypes.armor.some(i => i.system.equipped && i.system.type === \"top\");\nif (hasTop) return;\n\nif (args.attacker) {\n    const atkRage = args.attacker.system.resources.rage.value;\n    if (atkRage > 0) {\n        await args.attacker.update({ \"system.resources.rage.value\": atkRage - 1 });\n        actor.showFloatyText(\"削怒 -1\", { fill: \"#ff00ff\" });\n    } else {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"jinshi\");\n        if (eff) {\n            const data = foundry.utils.deepClone(eff);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.attacker, data);\n            ui.notifications.info(`${args.attacker.name} 被禁实！`);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "销魂刺法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>合欢派功法，沉沦奉献本心，勾动无尽欲念。</p><p><strong>需求：</strong>匕首</p><p><strong>属性：</strong>阴</p>",
            "requirements": "匕首",
            "moves": [
                {
                    "name": "裂心祭魂",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，匕首刺入心口，气血逆冲癫魔，将范围内的敌人击飞3米，同时自身进入“魔欲”，持续到战斗脱离。</p><p><strong>魔欲：</strong>凶性大发，你施展《销魂刺法》时招式伤害提升50点；在你的每回合初，获得一层“魂欲”，至多三层，持续到战斗脱离。</p><p><strong>升级：</strong>魔欲提供的伤害加成+50，内力消耗+4，怒气消耗-1。</p>",
                    "automationNote": "击飞手动。魔欲加伤、回合初回魂欲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得魔欲",
                            "trigger": "hit",
                            "script": "// 获取AE模板\nconst eff = thisItem.effects.getName(\"魔欲\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 动态计算加伤数值\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst dmgBonus = 50 + (lvl - 1) * 50;\n\n// 写入 Flags 供 calc 脚本读取\nfoundry.utils.setProperty(eff, \"flags.xjzl-system.moyuDmgBonus\", dmgBonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"进入 [魔欲] 状态！\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "断欲焚魂",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，幻出刺影，对敌人造成伤害。击破架招时，自身获得一层“魂欲”，至多三层，持续到战斗脱离。</p><p>·敌人每有1种状态，虚招值+1（至多+3）。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获魂欲自动。虚招值加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-魂欲",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"魂欲\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        },
                        {
                            "label": "状态加成虚招",
                            "trigger": "check",
                            "script": "const effectCount = args.target.effects.size || 0;\nconst bonus = Math.min(3, effectCount);\nif (bonus > 0) {\n    args.flags.grantFeint += bonus;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "骨蚀欢魂",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，刺如指尖，轻划爱抚，对敌人造成伤害。若消耗一层“魂欲”，可使敌人进行[定力]检定（难度14），若对方失败，则坠入温柔幻想，陷入“自闭”，持续三回合。</p><p><strong>升级：</strong>招式伤害+10，检定难度+3，内力消耗+2。</p>",
                    "automationNote": "消耗魂欲提示自动。检定与状态应用自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗与检定",
                            "trigger": "hit",
                            "script": "const hunyu = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xiaohuncifa_hunyu\");\nif (args.isHit && hunyu) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"骨蚀欢魂 - 命中\" },\n        content: `<p>命中目标！是否消耗 1 层 [魂欲] 发起检定？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"跳过\", icon: \"fas fa-times\" }\n    });\n    \n    if (confirm) {\n        await game.xjzl.api.effects.removeEffect(actor, \"xiaohuncifa_hunyu\", 1);\n        \n        const lvl = Math.max(1, move.computedLevel || 1);\n        const dc = 14 + (lvl - 1) * 3;\n        \n        const eff = CONFIG.statusEffects.find(e => e.id === \"zibi\");\n        const effData = foundry.utils.deepClone(eff);\n        effData.duration = { rounds: 3 };\n\n        await Macros.requestSave({\n            target: args.target,\n            attacker: actor,\n            type: \"dingli\",\n            dc: dc,\n            label: \"抵抗骨蚀欢魂\",\n            onFail: effData\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "极乐引魂",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，刺抵下颌，腥甜冷笑。获得一层“魂欲”，至多三层，持续到战斗脱离。</p><p><strong>魂欲：</strong>受到内外功伤害后投掷一个D20，若大于等于10，每层魂欲使你回复20点气血内力。</p><p><strong>升级：</strong>魂欲的回复数值+10。</p>",
                    "automationNote": "获得魂欲自动。受击判定与回复自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得魂欲",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"魂欲\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 动态计算回复量\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst healBase = 20 + (lvl - 1) * 10;\nfoundry.utils.setProperty(eff, \"flags.xjzl-system.hunyuHeal\", healBase);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "魔欲",
                    "icon": "icons/magic/control/energy-stream-purple.webp",
                    "description": "施展《销魂刺法》伤害提升；回合初获得魂欲。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiaohuncifa_moyu",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "回合初获魂欲",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "const eff = thisItem.effects.getName(\"魂欲\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 查找极乐引魂(Move 4)以计算回复量\nconst moveData = thisItem.system.moves[3];\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst healBase = 20 + (lvl - 1) * 10;\nfoundry.utils.setProperty(eff, \"flags.xjzl-system.hunyuHeal\", healBase);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nactor.showFloatyText(\"魔欲生魂\", {fill: \"#800080\"});"
                                },
                                {
                                    "label": "招式加伤",
                                    "trigger": "calc",
                                    "active": true,
                                    "script": "if (item && item.id === thisItem.id) {\n    const bonus = thisEffect.getFlag(\"xjzl-system\", \"moyuDmgBonus\") || 50;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`魔欲加成 +${bonus}`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "魂欲",
                    "icon": "icons/magic/life/heart-shadow-red.webp",
                    "description": "受击概率回复气血内力。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiaohuncifa_hunyu",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "受击判定回复",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "// 仅限内外功伤害\nif (![\"waigong\", \"neigong\"].includes(args.type)) return;\n\nconst roll = await new Roll(\"1d20\").evaluate();\nif (game.dice3d) game.dice3d.showForRoll(roll, game.user, true);\n\nif (roll.total >= 10) {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const healBase = thisEffect.getFlag(\"xjzl-system\", \"hunyuHeal\") || 20;\n    const totalHeal = healBase * stacks;\n    \n    await actor.applyHealing({amount: totalHeal, type: \"hp\", showScrolling: true});\n    await actor.applyHealing({amount: totalHeal, type: \"mp\", showScrolling: true});\n    ui.notifications.info(`${actor.name} 魂欲生效，回复 ${totalHeal} 点气血内力！`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]