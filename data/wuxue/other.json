[
    {
        "name": "夺命十三剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>失传已久，曾为一燕姓剑客所用，很快销声匿迹。剑招如鬼斧神工，快、狠、奇，且杀气极重，稍加修炼便入疯魔。传闻还有第十四和第十五剑。</p><p><strong>需求：</strong>悟性5</p>",
            "requirements": "悟性5",
            "moves": [
                {
                    "name": "绝命",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑本无招，招由心生</p><p>剑影连颤，无命无情，瞬间刺出十数剑，对目标造成伤害。</p><p>·本场战斗中目标每受到过一次【封喉】造成的伤害，招式提升20点。</p><p>·若施展本招将敌人击杀（死亡检定失败），为在场任意一个敌人添加“封喉”，持续到当前行动的玩家的回合结束。</p>",
                    "automationNote": "自动化：自动检测目标身上的[封喉计数]并增加伤害。击杀后施加状态需手动选择目标。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "封喉增伤检测",
                            "trigger": "preDamage",
                            "active": true,
                            "script": "const counter = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fenghou_counter\");\nconst stacks = counter ? (counter.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (stacks > 0) {\n    const bonus = stacks * 20;\n    args.config.amount += bonus;\n    // 这里的提示只给GM和玩家看，确认触发了效果\n    ui.notifications.info(`绝命：检测到 ${stacks} 层封喉计数，伤害 +${bonus}`);\n}"
                        },
                        {
                            "label": "击杀检测",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isDead) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold; color:darkred;\">绝命 - 击杀触发</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>目标已死亡。</p>\n                <p>请手动为场上任意一个敌人添加 <b>[封喉]</b>。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "枉死",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑指九幽，闭目待敌，开启架招。架招被击破时，为在场任意一个敌人添加“封喉”，持续到当前行动的玩家的回合结束。</p>",
                    "automationNote": "击破后提示手动施加封喉。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破触发",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.isBroken && args.config.ignoreStance !== true) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">枉死 - 架招击破</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>架招被击破。</p>\n                <p>请手动为场上任意一个敌人添加 <b>[封喉]</b>。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "挫颅",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招。射出剑气，对敌人造成伤害，并为其添加“封喉”，持续到当前行动的玩家的回合结束。</p><p><strong>封喉：</strong>当该状态结束时，若你5米范围内有习得【夺命十三剑-封喉】的角色，他可以不消耗动作对你施展一次【封喉】。</p>",
                    "automationNote": "命中施加封喉自动。封喉后续联动效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加封喉",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"封喉\").toObject();\n    eff.duration = { turns: 1 }; // 持续到当前回合结束，近似处理为1回合\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 已被封喉`);\n}"
                        }
                    ]
                },
                {
                    "name": "割面",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑走偏锋，斜削面门，对敌人造成伤害。击破对方架招时，清除目标身上的一个状态，并且本次战斗中，目标无法再获得此状态。</p>",
                    "automationNote": "击破后状态清除与封印需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            6,
                            10
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold; color:darkred;\">割面 - 击破架招</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>已击破 <b>${args.target.name}</b> 的架招！</p>\n                <p>请手动清除目标身上的一个状态，且本场战斗中目标无法再获得该状态。</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "封喉",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>剑指咽喉，凝练一线，对直线上的敌人造成伤害。</p><p>若范围内有敌人处于半空中，此招可消耗反应动作释放，立于原地射出剑气，对其造成伤害。</p>",
                    "automationNote": "自动化：伤害计算自动。命中后自动给目标叠加[封喉计数]（用于绝命增伤）。反应动作释放需玩家自行判断时机。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "叠加封喉计数",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const effName = \"封喉计数\";\n    const eff = thisItem.effects.getName(effName);\n    if (eff) {\n        const effData = eff.toObject();\n        delete effData._id;\n        effData.origin = thisItem.uuid;\n        // 叠加一层\n        await game.xjzl.api.effects.addEffect(args.target, effData, 1);\n    }\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "封喉",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "当该状态结束时，若你5米范围内有习得【夺命十三剑-封喉】的角色，他可以不消耗动作对你施展一次【封喉】。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenghou",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "封喉计数",
                    "icon": "icons/svg/blood.svg",
                    "description": "记录受到【封喉】招式伤害的次数，用于增加【绝命】的伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenghou_counter",
                            "stackable": true
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]