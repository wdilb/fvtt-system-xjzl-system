[
    {
        "name": "分筋错骨手",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>传统单对单擒拿手法，可快速让敌人无法反抗。</p><p><strong>需求：</strong>徒手</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "分筋错骨手",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "无",
                    "description": "<p>当你的普通攻击命中敌方目标时，可以消耗反应动作，与目标进行[角力]对抗，若你获胜，给对方添加“错骨”一回合。</p><p><strong>升级：</strong>此次[角力]对抗检定结果+1。</p>",
                    "automationNote": "普攻命中后请手动点击此招式以记录（或纯RP）。对抗与状态施加均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "卸劲术",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>一种卸力巧劲之法，可将对手强劲攻击化为无形。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "卸劲术",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你受到内外功伤害时，可以消耗反应动作施展此招，飘摇闪身，宛若轻絮，主动被击飞 3 米，扭身卸去力道，减免 30 内外功伤害。</p><p><strong>升级：</strong>额外减免 10 点伤害，内力消耗+1。</p>",
                    "automationNote": "受击时请手动扣除内力并计算减伤。位移手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "博古通今",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>一些家族传承不断，典籍众多，留下不少上古秘闻。</p><p><strong>效果：</strong>你的[书写]等级+1。</p><p>·你认得一些古老文字，在识别篆书（汉代）、金文（周）、甚至甲骨文（商）时，可进行一个悟性检定。</p><p>难度 10：你能看懂一半，模糊知道意思。</p><p>难度 15：你基本能看懂，明白文字表面意思。</p><p>难度 20：你认得每一个字和其含义，古文中的隐喻也一清二楚。</p><p><strong>升级：</strong>你看古文时的检定结果+2。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "博古通今",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动技能。升级提升检定加值。</p>",
                    "automationNote": "书写等级通过AE自动增加。古文检定需手动投掷悟性。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "博古通今",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "transfer": true,
                    "changes": [
                        {
                            "key": "system.arts.shuxie.value",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "欺男霸女",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>通过肢体或言语的攻击、抗拒及排挤，也可能是嘲讽、恶评或讥笑，或是因嫉妒而进行辱骂和讽刺。</p><p><strong>需求：</strong>标签为[恶]</p>",
            "requirements": "标签为[恶]",
            "moves": [
                {
                    "name": "欺男霸女",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "10米",
                    "actionCost": "主要动作",
                    "description": "<p>说出一段至少 10 个字以上的话，欺凌与压迫一个目标，同时进行一个[说服]技能检定。</p><p>·你每有 100 点恶行值，你的本次检定结果+1。</p><p>·若这次检定结果大于等于 20，目标与你进行的所有对抗检定-1，持续十回合。</p><p>·若这次检定结果小于 20，你激起目标斗志，目标与你进行的所有对抗检定+1，持续十回合。</p><p><strong>升级：</strong>大于等于 20 再-1，小于 20 再+1。</p>",
                    "automationNote": "自动计算恶行加值并请求检定。根据检定结果自动发送对应效果的提示卡片(需手动应用)。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "欺凌检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "const exing = actor.system.social?.exing || 0;\nconst bonus = Math.floor(exing / 100);\nconst roll = await actor.rollAttributeTest(\"shuofu\", { bonus: bonus, flavor: \"欺男霸女 - 欺凌检定\" });\nconst total = roll.total;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst extraMod = lvl - 1;\n\nlet content = \"\";\nif (total >= 20) {\n    const debuffVal = 1 + extraMod;\n    content = `<div class='xjzl-chat-card'><div class='card-header' style='color:green;'>欺凌成功 (${total})</div><div style='padding:5px;'>目标被压迫。<br>对抗检定 <b>-${debuffVal}</b> (持续10回合)。<br>请GM手动给目标添加惩罚。</div></div>`;\n} else {\n    const buffVal = 1 + extraMod;\n    content = `<div class='xjzl-chat-card'><div class='card-header' style='color:red;'>欺凌失败 (${total})</div><div style='padding:5px;'>目标激起斗志。<br>对抗检定 <b>+${buffVal}</b> (持续10回合)。<br>请GM手动给目标添加增益。</div></div>`;\n}\nChatMessage.create({ user: game.user.id, speaker: ChatMessage.getSpeaker({actor: actor}), content: content });"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "缩骨术",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>这门绝技想要练成本要下大力气，但真经记载妙法，可轻易而为之，极为神奇。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "缩骨术",
                    "type": "qi",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "全回合动作",
                    "description": "<p>下腰屈身，气散骸骨，提肛收髋，脑缩颅骨，进入“缩骨”状态，持续一个时辰。</p><p><strong>缩骨：</strong>你的[潜行]等级+2，速度+1。持续期间你的身形缩短到 7、8 岁孩童大小（三尺高），且身躯柔软至极，可通过最窄为三寸宽的地形。</p><p>·若在收筋缩骨时消耗内力，会引起真气紊乱，立即解除此状态。</p><p><strong>升级：</strong>潜行等级再+2，速度再+1。</p>",
                    "automationNote": "点击应用获得BUFF。特殊解除条件(耗内力/过地形)需手动处理。",
                    "xpCostRatio": 1,
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            100,
                            200,
                            300,
                            400
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用缩骨",
                            "trigger": "hit",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst stealthBonus = 2 + (lvl - 1) * 2;\nconst speedBonus = 1 + (lvl - 1);\n\nconst effData = {\n    name: \"缩骨\",\n    icon: item.img,\n    duration: { seconds: 7200 },\n    changes: [\n        { key: \"system.skills.qianxing.mod\", mode: 2, value: String(stealthBonus) },\n        { key: \"system.combat.speed\", mode: 2, value: String(speedBonus) }\n    ]\n};\nawait game.xjzl.api.effects.addEffect(actor, effData);"
                        }
                    ],
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "叩阎罗",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>势有去无回，以死搏向生。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "叩阎罗",
                    "type": "qi",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>架招开启期间，可消耗次要动作，解除架招，获得“叩阎罗”，持续到战斗脱离。</p><p><strong>叩阎罗：</strong>下一次攻击势如疾风，招式提高等同于你解除架招前格挡值的伤害。</p><p><strong>升级：</strong>伤害+5，消耗+1。</p>",
                    "automationNote": "手动解除架招。手动计算格挡值加成并通过手动修正组应用到下一次攻击。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [],
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "夺命剪刀脚",
        "type": "real",
        "isUltimate": true,
        "element": "rou",
        "damageType": "waigong",
        "weaponType": "unarmed",
        "range": "2米",
        "targetInfo": "单体",
        "actionCost": "蓄力动作",
        "description": "<p>解除自身架招，凌空飞起，双腿伸出，直夹敌人脑袋，腰部用力再向下一摔，造成外功伤害，然后与目标进行一个徒手技能对抗，若自身胜出，则与目标双双倒地并进入缚身、禁足状态，持续到战斗脱离或你主动选择放开目标。</p><p>·若你对抗失败，则只对目标造成伤害。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
        "automationNote": "伤害自动。架招解除手动。对抗请求自动。获胜自动施加缚身/禁足/倒地。双方位置移动手动。",
        "calculation": {
            "base": 0,
            "growth": 10,
            "scalings": [
                {
                    "prop": "liliang",
                    "ratio": 0.5
                }
            ]
        },
        "costs": {
            "mp": [
                2,
                4,
                6
            ],
            "rage": [
                7,
                6,
                5
            ]
        },
        "scripts": [
            {
                "label": "夺命剪刀脚对抗",
                "trigger": "hit",
                "script": "await Macros.requestContest({\n    attacker: actor,\n    defender: args.target,\n    type: \"wuxue\",\n    label: \"夺命剪刀脚 - 徒手对抗\",\n    outcome: {\n        win: {\n            text: \"双腿绞杀！双方倒地并纠缠在一起。\",\n            selfEffect: \"prone\",\n            targetEffect: [\"prone\", \"fushen\", \"root\"]\n        },\n        lose: {\n            text: \"目标稳住下盘，未被摔倒。\"\n        }\n    }\n});",
                "active": true
            }
        ]
    },
    {
        "name": "炎阳真气",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖上运用灼热阳刚内力的方法，妙用无方。</p><p><strong>需求：</strong>将一门阳刚属性的地级内功修炼圆满。</p><p><strong>属性：</strong>阳</p>",
            "requirements": "将一门阳刚属性的地级内功修炼圆满",
            "moves": [
                {
                    "name": "炎阳真气",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yang",
                    "range": "自身",
                    "description": "<p><strong>次要动作，1 点内力：</strong>将拇指大小的冰块化为冷水并加热至体表温度。</p><p><strong>反应动作，5 点内力：</strong>受到火焰伤害时施展，减免 10 点火焰伤害。</p><p><strong>全回合动作，10 点内力：</strong>内力蒸腾，白气浮顶，瞬间烘干自己身上湿润的衣物。</p><p><strong>升级：</strong>冰块体积增加一倍，火焰伤害额外减免 10 点，烘干衣物的动作降低一个级别。</p>",
                    "automationNote": "所有效果均为手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "龟息大法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖奇功，修炼后一旦施展，脉搏心跳停止，体温冰凉，浑身僵硬，看起来就像是死了一样。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "龟息大法",
                    "type": "qi",
                    "range": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>调整心脉，迅速进入“龟息”状态，持续到你主动解除。</p><p><strong>龟息：</strong>你进行一个[潜行]检定且结果+1，你进行一个[敛息]检定且结果+1，然后你陷入“自闭”，浑身冰凉，看起来就像是死了一样，持续一个时辰。</p><p>·一旦受到攻击，你立即移除龟息状态。</p><p><strong>升级：</strong>潜行、敛息的检定结果再+1。</p>",
                    "automationNote": "应用龟息状态自动。技能检定需手动。受击移除手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用龟息",
                            "trigger": "hit",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 1 + (lvl - 1);\n\nconst effData = {\n    name: \"龟息\",\n    icon: item.img,\n    flags: {\n        \"xjzl-system\": { \n            \"slug\": \"guixi\"\n        }\n    },\n    changes: [\n        { key: \"system.skills.qianxing.mod\", mode: 2, value: String(bonus) },\n        { key: \"system.skills.biqi.mod\", mode: 2, value: String(bonus) },\n        { key: \"flags.xjzl-system.zibi\", mode: 5, value: \"true\" }\n    ]\n};\nawait game.xjzl.api.effects.addEffect(actor, effData);"
                        }
                    ],
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "传音入密",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>虽不高深，却是武林中绝顶高手才能习得的武功。以深厚内力将话送入他人耳中，旁人即使靠在说话者身边，亦无法听闻。</p><p><strong>需求：</strong>内力上限 200</p>",
            "requirements": "内力上限 200",
            "moves": [
                {
                    "name": "传音入密",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "20米",
                    "targetInfo": "单体",
                    "actionCost": "简要动作",
                    "description": "<p>口唇不动，运劲暗送，将一段不超过 20 个字的话送到范围内一个目标的耳中。</p><p><strong>升级：</strong>距离+20，消耗+1。</p>",
                    "automationNote": "纯RP技能。可使用私聊功能模拟。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "点穴大法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>记载于神秘真经，其中要领极为精简，但却与寻常点穴要旨完全不同。</p><p><strong>效果：</strong>你的[点穴]检定结果+1。</p><p>·你点穴成功后，对方难以冲开你点住的穴道，他进行[冲穴]技能检定时结果-1。</p><p><strong>升级：</strong>你的点穴结果再+1，对方的冲穴结果再-1。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "点穴大法",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动技能。提升点穴效果。</p>",
                    "automationNote": "自身点穴加值自动。敌人冲穴减值需手动调整或GM干预。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "点穴大法-被动",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "transfer": true,
                    "changes": [
                        {
                            "key": "system.skills.dianxue.mod",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "同道中人",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖难闯，知音难觅，寻一意见志趣相同之人仗剑同行，多是一件美事啊。</p><p><strong>效果：</strong>所有与你初次见面之人对你的好感度+5。你获得“同道”，不会被其他效果移除。</p><p><strong>同道：</strong>你每有一位结拜好友，气血内力最大值+10（最多+40），当这位结拜好友死去时，改为气血内力上限-20。</p><p><strong>升级：</strong>同道提供的气血内力上限+30。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "同道中人",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动生效。</p>",
                    "automationNote": "初见好感度纯RP。属性加成请使用手动修正组添加。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "三阴手",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖败类袭杀手法杂乱无章，三阴分堂高手取其精华去其糟粕，从中筛选出三种最为阴险毒辣，发动不引人注目的手法藏于招式之中。</p><p><strong>效果：</strong></p><p>一阴：你的身法属性相关技能检定结果+1。</p><p>二阴：当 1 米周围有敌人被击破架招时，你可以对其落井下石，不消耗动作对其施展一次普通攻击。</p><p>三阴：你在偷袭时，招式伤害+20。</p><p><strong>升级：</strong>一阴的检定结果再+1；三阴的招式伤害+5。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "三阴手",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动技能。提供三阴效果。</p>",
                    "automationNote": "身法技能加值自动。偷袭加伤与落井下石需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "三阴手-被动",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "transfer": true,
                    "changes": [
                        {
                            "key": "system.skills.qianxing.mod",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.skills.qiaoshou.mod",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.skills.qinggong.mod",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.skills.mashu.mod",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "自断经脉",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>此招为江湖禁绝招式，得之即毁，连口诀都不许流传，生怕用心险恶之人将口诀混入秘籍害人。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "自断经脉",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>气碎丹田，断筋焚脉，你的气血、内力立即归零，同时死亡检定结果必定为 1。</p><p><strong>升级：</strong>招式无法升级。</p>",
                    "automationNote": "点击即死。自动归零资源。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "自绝",
                            "trigger": "hit",
                            "active": true,
                            "script": "await actor.update({\n    \"system.resources.hp.value\": 0,\n    \"system.resources.mp.value\": 0\n});\n// 强制死亡状态\nawait actor.toggleStatusEffect(\"dead\", { overlay: true, active: true });\nChatMessage.create({ \n    content: `<div style='text-align:center; font-weight:bold; color:darkred; font-size:1.5em;'>${actor.name} 自断经脉，气绝身亡！</div>`, \n    speaker: ChatMessage.getSpeaker({actor: actor}) \n});"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "礼贤",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>礼者，敬人也，崇德而礼贤，君子当所为。</p><p><strong>效果：</strong>你的先攻+2。</p><p>进入战斗且投掷完先攻后，你可以将自身先攻顺序延后到任意目标之后。</p><p>·你每让一人比你先行动，你获得一层“礼贤”，至多三层，持续到战斗脱离。</p><p><strong>礼贤：</strong>每层使你内外功防御+5，速度+1。</p><p>·获得礼贤时，你可以移除礼贤，每移除一层礼贤，便可以选择场上一名其他友方，将他的先攻顺序上升一位。</p><p>·若场上还有其他角色学习了《礼贤》，按照你们的先攻顺序来结算礼贤的效果。</p><p><strong>升级：</strong>你的先攻+2。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "礼贤",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动提升先攻。战斗中手动调整顺序获得BUFF。</p>",
                    "automationNote": "先攻加成自动。层数获取与消耗需手动添加/移除对应的 AE。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "礼贤-被动",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "transfer": true,
                    "changes": [
                        {
                            "key": "system.combat.initiative",
                            "mode": 2,
                            "value": "2"
                        }
                    ]
                },
                {
                    "name": "礼贤-层数",
                    "icon": "icons/magic/symbols/star-yellow.webp",
                    "transfer": false,
                    "description": "每层防御+5，速度+1。",
                    "flags": {
                        "xjzl-system": {
                            "slug": "lixian_stack",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "行侠好义",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>路见不平拔刀助，舍己助人讲义气。</p><p><strong>需求：</strong>标签为[侠]</p>",
            "requirements": "标签为[侠]",
            "moves": [
                {
                    "name": "行侠好义",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "20米",
                    "actionCost": "主要动作",
                    "description": "<p>挺身而出，不畏强权，你说出一段至少 10 个字以上的话，并进行一次[说服]技能检定。</p><p>·你每有 100 点侠义值，[说服]检定结果+1。</p><p>·若这次检定结果大于等于 15，场上所有标签为[侠]的目标获得“好义”，持续一回合，否则获得“避嫌”，持续一回合。</p><p><strong>好义：</strong>招式伤害+10，暴击骰-2。</p><p><strong>避嫌：</strong>速度+1，命中-5。</p><p><strong>升级：</strong>好义和避嫌的持续回合数+1。</p>",
                    "automationNote": "检定自动。请根据检定结果手动给目标施加状态 (无法自动识别侠标签)。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "行侠检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "const xiayi = actor.system.social?.xiayi || 0;\nconst bonus = Math.floor(xiayi / 100);\nconst roll = await actor.rollAttributeTest(\"shuofu\", { bonus: bonus, flavor: \"行侠好义 - 检定\" });\nconst total = roll.total;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nlet content = \"\";\nif (total >= 15) {\n    content = `<div class='xjzl-chat-card'><div class='card-header' style='color:green;'>检定成功 (${total})</div><div style='padding:5px;'>请给场上 [侠] 标签目标施加 <b>[好义]</b>。<br>伤害+10，暴击-2。<br>持续 ${rounds} 回合。</div></div>`;\n} else {\n    content = `<div class='xjzl-chat-card'><div class='card-header' style='color:orange;'>检定不足 (${total})</div><div style='padding:5px;'>请给场上 [侠] 标签目标施加 <b>[避嫌]</b>。<br>速度+1，命中-5。<br>持续 ${rounds} 回合。</div></div>`;\n}\nChatMessage.create({ user: game.user.id, speaker: ChatMessage.getSpeaker({actor: actor}), content: content });"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "好义",
                    "icon": "icons/magic/life/cross-yellow.webp",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "haoyi",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-2"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-2"
                        }
                    ]
                },
                {
                    "name": "避嫌",
                    "icon": "icons/magic/movement/trail-streak-gray.webp",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bixian",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "-5"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "-5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "式随心现",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>以虚为式，击其不意。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "式随心现",
                    "type": "feint",
                    "damageType": "waigong",
                    "range": "1米",
                    "actionCost": "次要动作",
                    "description": "<p>心达通念，对目标进行一次普通攻击，这次攻击可以与对方进行虚招对抗，虚招值为 2。</p><p><strong>升级：</strong>虚招值+2。</p>",
                    "automationNote": "仅提供虚招值。请配合普通攻击使用。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "天外飞飞飞仙",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>虽然凌厉凶猛，却少了一丝神韵。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "天外飞飞飞仙",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "25米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>飞身一剑，造成伤害，招式伤害提升双方距离米数的数值。</p><p>·使目标流失等同于受到伤害（扣除防御和格挡）10%的内力。</p><p><strong>升级：</strong>额外流失 5%内力，怒气-1，消耗+10。</p>",
                    "automationNote": "吸蓝自动。距离增伤请使用手动修正组或弹窗修正。",
                    "calculation": {
                        "base": 0,
                        "growth": 0,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "吸蓝",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const ratio = 0.10 + (lvl - 1) * 0.05;\n    // args.finalDamage 是实际扣血量，近似于受到的伤害。虽然可能有护体等抵扣，暂且以此为准。\n    const mpDrain = Math.floor(args.finalDamage * ratio);\n    if (mpDrain > 0) {\n        await args.target.applyHealing({ amount: -mpDrain, type: \"mp\", showScrolling: true });\n        ui.notifications.info(`天外飞飞飞仙：目标流失 ${mpDrain} 内力。`);\n    }\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "千面术",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖奇术，千变莫名，极难被人看穿。</p><p><strong>消耗：</strong>一次 10 两（面粉、浆糊、墨胶等）</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "千面术",
                    "type": "qi",
                    "range": "自身",
                    "actionCost": "10分钟",
                    "description": "<p>你塑面易貌，获得“千面”，持续一天或被水冲刷脸庞。</p><p><strong>千面：</strong>进行一次易容的[欺瞒]检定，且结果+2，然后你扮成其他模样，你可以改变自己的声音，也可以适当的改变自己的身高（不超过三寸）。</p><p>·你可以易容成你曾见过的其他人。</p><p>·若易容成异性，该次检定结果-10。</p><p><strong>升级：</strong>欺瞒检定结果再+2，易容异性的减值减少 5，千面持续时间增加一天。</p>",
                    "automationNote": "检定自动。扣钱与易容效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "易容检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 2 + (lvl - 1) * 2;\n// 扣钱逻辑暂不自动（需操作物品）\nconst roll = await actor.rollAttributeTest(\"qiman\", { bonus: bonus, flavor: \"千面术 - 易容\" });"
                        }
                    ],
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "太阴伏魔掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>饱含阴劲，气势威猛！</p><p><strong>需求：</strong>徒手-拳掌</p><p><strong>属性：</strong>阴</p>",
            "requirements": "徒手-拳掌",
            "moves": [
                {
                    "name": "太阴伏魔掌",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>掌力笼罩目标，对目标造成伤害，并获得一层“太阴之气”，至多三层，持续到战斗脱离。</p><p><strong>太阴之气：</strong>每层使《太阴伏魔掌》伤害+10。</p><p>当你陷入濒死后，自动移除所有太阴之气，每层为你回复 10 点气血。</p><p>·可以改为消耗全回合动作出招，双掌同时向目标轰出，对其造成 0.7 内息点内功伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "层数增伤自动。濒死回血自动。全回合大招模式需手动修正。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "太阴增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const stackEff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"taiyin_qi\");\nconst stacks = stackEff ? (stackEff.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nconst stackBonus = stacks * 10;\nif (stackBonus > 0) {\n    args.output.damage += stackBonus;\n    args.output.bonusDesc.push(`太阴之气(${stacks}): +${stackBonus}`);\n}"
                        },
                        {
                            "label": "获得太阴之气",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const effData = {\n        name: \"太阴之气\",\n        icon: item.img,\n        flags: {\n            \"xjzl-system\": { \n                \"slug\": \"taiyin_qi\", \n                \"stackable\": true, \n                \"maxStacks\": 3,\n                \"scripts\": [\n                    {\n                        \"label\": \"濒死转化\",\n                        \"trigger\": \"dying\",\n                        \"active\": true,\n                        \"script\": \"const st = thisEffect.getFlag('xjzl-system', 'stacks') || 1; const heal = st * 10; await actor.applyHealing({amount: heal, type: 'hp', showScrolling: true}); await thisEffect.delete(); ui.notifications.info(`太阴之气护体！回复 ${heal} 气血。`);\"\n                    }\n                ]\n            }\n        }\n    };\n    await game.xjzl.api.effects.addEffect(actor, effData);\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "梅花易数",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖神棍所用，真假参半。</p><p><strong>效果：</strong>你的[道法]等级+1。</p><p>一天一次，你推算一个自己熟知（好感度大于 10 或低于-10）的人的所处城市，以及大致方向。</p><p>（由主持人告知具体信息）</p><p><strong>升级：</strong>一天可以额外使用一次。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "梅花易数",
                    "type": "qi",
                    "actionType": "buff",
                    "description": "<p>被动技能。主动推算。</p>",
                    "automationNote": "道法加值自动。推算功能纯RP。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "梅花易数-被动",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "transfer": true,
                    "changes": [
                        {
                            "key": "system.arts.daofa.value",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "祝融甲气",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>祝融火神，云驾龙骖，气御朱明，正阳是含。</p><p><strong>需求：</strong>将一门阳刚属性的天级内功修炼圆满。</p><p><strong>属性：</strong>阳</p>",
            "requirements": "将一门阳刚属性的天级内功修炼圆满",
            "moves": [
                {
                    "name": "祝融甲气",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你受到阴、柔属性招式伤害时，可消耗反应动作施展，以火施化，用纯阳内力抵御阴柔内力侵袭，每消耗 1 点内力可以抵挡 1 点内外功伤害。</p><p>·若你修炼过任意阴柔内功，该散手失效。</p><p><strong>升级：</strong>每消耗 1 内力可以抵挡的伤害+1。</p>",
                    "automationNote": "受击时手动扣除内力抵挡伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "狮子吼",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>原为万佛绝技之一，流传于外。清啸之下，犹如迅雷疾泻声闻数里，令敌肝胆俱裂，心惊胆战，有震慑人心的不可思议之威力。练功者禁止烟酒。</p><p><strong>需求：</strong>内息、气感大于等于 30</p>",
            "requirements": "内息、气感大于等于 30",
            "moves": [
                {
                    "name": "狮子吼",
                    "type": "real",
                    "damageType": "mental",
                    "weaponType": "unarmed",
                    "range": "20米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>丹田内气外发，狂声怒吼，范围内所有敌人和其他友方进行一次[定力]检定，失败则受到等同于你最大内力值一半的精神伤害，检定成功则此伤害减半。</p><p><strong>升级：</strong>检定难度+3，消耗+10。</p>",
                    "automationNote": "显示完整伤害。请提示目标进行定力检定，成功者手动减半伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30
                        ]
                    },
                    "scripts": [
                        {
                            "label": "狮子吼伤害",
                            "trigger": "calc",
                            "active": true,
                            "script": "const maxMP = actor.system.resources.mp.max;\nargs.output.damage = Math.floor(maxMP / 2);\nargs.output.bonusDesc.push(`最大内力一半 (${Math.floor(maxMP/2)})`);"
                        },
                        {
                            "label": "检定提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 13 + (lvl - 1) * 3;\nconst fullDmg = Math.floor(actor.system.resources.mp.max / 2);\nconst halfDmg = Math.floor(fullDmg / 2);\n\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"font-weight:bold; border-bottom:1px solid #ccc;\">狮子吼 - 判定</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>目标需进行 <b>定力 (Dingli)</b> 检定，DC <b>${dc}</b>。</p>\n            <ul>\n                <li><b>失败:</b> 受到 ${fullDmg} 点精神伤害。</li>\n                <li><b>成功:</b> 受到 ${halfDmg} 点精神伤害。</li>\n            </ul>\n            <p>请GM根据检定结果手动应用伤害。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "舍身诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖秘技，不计代价运转内劲，短期内大幅增加战斗力，但是后遗症较大，影响日后修行。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "舍身诀",
                    "type": "qi",
                    "actionType": "heal",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>以秘法刺激肉体，瞬间回复最大气血值 20%的气血，且获得一层“护身”，至多三层，持续到战斗脱离。</p><p><strong>护身：</strong>每层使你内外功防御+5。</p><p>·战斗结束后，你的体魄永久-5（归零则死亡）。</p><p>·此招一场战斗只能使用一次，在小憩后恢复。</p><p><strong>升级：</strong>回复气血增加 10%，额外获得一层护身。</p>",
                    "automationNote": "回复气血自动。获得护身自动。体魄永久扣除会弹出提示并尝试添加修正组（需GM确认）。战斗次数限制手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回复与护身",
                            "trigger": "hit",
                            "script": "const maxHP = actor.system.resources.hp.max;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst ratio = 0.2 + (lvl - 1) * 0.1;\nconst totalHeal = Math.floor(maxHP * ratio);\n\n// 1. 回血\nawait actor.applyHealing({amount: totalHeal, type: 'hp', showScrolling: true});\n\n// 2. 获得护身 (层数: 1 + (lvl-1))\n// 假设基础得1层，升级额外得1层 -> total = 1 + (lvl-1)\nconst stacksToAdd = 1 + (lvl - 1);\n\n// 循环调用 addEffect 以叠加层数\nfor(let i=0; i<stacksToAdd; i++) {\n    await game.xjzl.api.effects.addEffect(actor, \"hushen_sheshen\");\n}\n\n// 3. 永久扣除体魄提示与修正\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"舍身诀后遗症\" },\n    content: `<p>战斗结束后，体魄将永久-5。</p><p>是否现在添加属性修正？</p>`,\n    yes: { label: \"添加修正\", icon: \"fas fa-skull\" },\n    no: { label: \"稍后手动\", icon: \"fas fa-clock\" }\n});\n\nif (confirm) {\n    const modifiers = foundry.utils.deepClone(actor.system.customModifiers || []);\n    modifiers.push({\n        id: foundry.utils.randomID(),\n        name: '舍身诀后遗症',\n        enabled: true,\n        changes: [{key: 'stats.tipo.value', value: -5}]\n    });\n    await actor.update({'system.customModifiers': modifiers});\n    ui.notifications.info(\"体魄永久-5！\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "葵花点穴指",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>听闻是某位侠盗留下的武功，神秘玄妙，速度奇快无比，甚至可以隔空点穴。</p><p><strong>需求：</strong>徒手-指法</p><p><strong>属性：</strong>无</p>",
            "requirements": "徒手-指法",
            "moves": [
                {
                    "name": "葵花点穴指",
                    "type": "real",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>抬指点穴，对目标进行一次[点穴]检定，若击中无架招目标，该次检定结果+2。</p><p><strong>升级：</strong>攻击距离+2，检定结果+2，消耗+2。</p>",
                    "automationNote": "命中后弹出提示，请手动发起点穴检定（或使用宏）。加值会自动计算并在提示中显示。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "点穴提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const noStance = !args.target.system.martial.stanceActive;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const growthBonus = (lvl - 1) * 2;\n    let bonus = growthBonus;\n    let msg = `基础加值: +${growthBonus}`;\n    \n    if (noStance) {\n        bonus += 2;\n        msg += `，无架招额外 +2`;\n    }\n\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"font-weight:bold;\">葵花点穴指 - 效果触发</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>请对目标进行 <b>[点穴]</b> 检定。</p>\n                <p>${msg}</p>\n                <p style=\"color:darkred; font-weight:bold;\">总检定修正: +${bonus}</p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "生死一线",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>闭死关秘技，为求突破，将其余所有都置之度外。</p><p><strong>效果：</strong>你选择一个无人打扰的地方小憩，进行闭关，你进入“闭死关”状态，持续到你打通经脉。</p><p><strong>闭死关：</strong>你选择一条经脉（可以是生死玄关）进行突破，每过一个月，便进行一次死亡检定，失败死亡，成功则继续闭死关，同时获得 500 修为，且你选择的经脉突破难度-1。</p><p>·闭死关期间你无需吃喝拉撒，视作辟谷。</p><p>·你只有打通该经脉之后方可移除闭死关。</p><p>·闭死关期间被人打扰影响（包含大声呵斥，推搡等），立刻进行一次死亡检定，成则移除闭死关。</p><p><strong>升级：</strong>每过一个月，经脉突破难度再-1。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "生死一线",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "长时间",
                    "description": "<p>进入闭死关状态。</p>",
                    "automationNote": "纯剧情/养成技能。死亡检定、修为获取、难度降低均为手动。",
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "无形神音",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>音波无形，妙用无匹。</p><p><strong>效果：</strong>你进入战斗后，内力环身无形颤动，获得“无音”“通音”，持续到战斗脱离。</p><p><strong>无音：</strong>敌人在你 1 米内开始回合时流失 30 气血。</p><p><strong>通音：</strong>你靠近未濒死的友方时，可以消耗反应动作，为其恢复 30 点气血。</p><p><strong>升级：</strong>无音流失气血+10，通音回复气血+10。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "无音 (被动光环)",
                    "type": "qi",
                    "actionType": "buff",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "1米",
                    "targetInfo": "敌方",
                    "actionCost": "被动",
                    "description": "<p>敌人在你 1 米内开始回合时流失 30 气血。</p><p><strong>升级：</strong>无音流失气血+10。</p>",
                    "automationNote": "光环效果手动。请手动检测距离并应用流失伤害。",
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                },
                {
                    "name": "通音",
                    "type": "qi",
                    "actionType": "heal",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "1米",
                    "targetInfo": "友方",
                    "actionCost": "反应动作",
                    "description": "<p>你靠近未濒死的友方时，可以消耗反应动作，为其恢复 30 点气血。</p><p><strong>升级：</strong>通音回复气血+10。</p>",
                    "automationNote": "完全自动化。点击应用治疗即可。",
                    "calculation": {
                        "base": 30,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "摄魂心法",
        "type": "qi",
        "actionType": "attack",
        "damageType": "mental",
        "weaponType": "none",
        "range": "5米",
        "targetInfo": "单体",
        "actionCost": "主要动作",
        "description": "<p>直视目标，双眼惑神，与目标进行一次[定力]对抗，若你胜出，目标陷入“自闭”一回合，当“自闭”结束后，再陷入“走火入魔”一个回合。</p><p>·若对方胜出，则你陷入“走火入魔”，持续到战斗脱离。</p><p><strong>升级：</strong>本次[定力]对抗检定结果+2，消耗+4。</p>",
        "automationNote": "对抗请求自动。获胜自动施加[自闭]。后续[走火入魔]需在下一回合手动施加。失败自动施加自身[走火入魔]。",
        "calculation": {
            "base": 0,
            "growth": 0
        },
        "costs": {
            "mp": [
                4,
                8,
                12
            ]
        },
        "scripts": [
            {
                "label": "定力对抗",
                "trigger": "hit",
                "script": "const bonus = (Math.max(1, args.move.computedLevel || 1) - 1) * 2;\n\nawait Macros.requestContest({\n    attacker: actor,\n    defender: args.target,\n    type: \"dingli\",\n    label: \"摄魂心法 - 定力对抗\",\n    winText: \"对抗修正: +\" + bonus + \" (请手动计入)。\",\n    outcome: {\n        win: {\n            text: \"摄魂成功！目标陷入[自闭]，结束后请手动施加[走火入魔]。\",\n            targetEffect: \"zibi\"\n        },\n        lose: {\n            text: \"摄魂失败！心神反噬。\",\n            selfEffect: \"rage\"\n        }\n    }\n});",
                "active": true
            }
        ]
    },
    {
        "name": "银环鞭",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>使用极长鞭子，通体雪白，伸缩自如，灵动之极。</p><p><strong>需求：</strong>奇门-鞭钩</p><p><strong>属性：</strong>柔</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "银环鞭",
                    "type": "real",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>灵动无比，缠绕目标，对目标造成伤害，并为其添加“禁足”“缚身”，持续到你收回鞭子。</p><p>·将目标缠绕期间，你失去主要动作。</p><p><strong>升级：</strong>伤害+10，收紧鞭绳时，使其额外受到 10 点气血流失，内力消耗+2。</p>",
                    "automationNote": "伤害自动。禁足、缚身状态自动施加。失去主要动作需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加缠绕",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    await game.xjzl.api.effects.addEffect(args.target, \"fushen\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "收紧鞭绳",
                    "type": "qi",
                    "actionType": "attack",
                    "damageType": "liushi",
                    "weaponType": "special",
                    "range": "10米",
                    "targetInfo": "已缠绕目标",
                    "actionCost": "次要动作",
                    "description": "<p>收紧鞭绳，将目标朝你的方向拖拽 10 米，并使其受到气血流失。</p><p><strong>升级：</strong>额外受到 10 点气血流失。</p>",
                    "automationNote": "流失伤害自动。拖拽效果手动。",
                    "tier": 2,
                    "calculation": {
                        "base": 10,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "天地同归",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>与敌人同死的悲壮之招，杀身成仁、舍生取义。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "天地同归",
                    "type": "real",
                    "element": "none",
                    "damageType": "liushi",
                    "weaponType": "none",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你出招命中敌人时，可消耗反应动作释放此招，强运气血焚烧内力，毁坏敌方经脉，你的气血、内力归 1 且进入昏迷状态，持续一个时辰。</p><p>然后使目标流失你最大气血 30%数值的气血。</p><p><strong>升级：</strong>流失气血提升你最大气血的 10%。</p>",
                    "automationNote": "流失伤害自动计算。自身气血内力归1及昏迷状态自动施加。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "计算流失",
                            "trigger": "attack",
                            "script": "const maxHP = actor.system.resources.hp.max;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst ratio = 0.3 + (lvl - 1) * 0.1;\nconst dmg = Math.floor(maxHP * ratio);\n\nargs.flags.damageResult.damage = dmg;\nargs.flags.damageResult.breakdown += `\\n天地同归 (${Math.round(ratio*100)}% MaxHP): ${dmg}`;",
                            "active": true
                        },
                        {
                            "label": "自身副作用",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await actor.update({\n        \"system.resources.hp.value\": 1,\n        \"system.resources.mp.value\": 1\n    });\n    \n    // 昏迷 (unconscious) 持续一个时辰 (7200秒)\n    // 我们获取模板后修改duration\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unconscious\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { seconds: 7200 };\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n    ui.notifications.warn(`${actor.name} 施展天地同归，气若游丝！`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "四平八稳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>一名瞎子所创，看似平平无奇实则变化无常，将敌人腾挪空间限制，封锁路线，无法离开自己周身。</p><p><strong>效果：</strong>你的普通攻击消耗 5 点内力，且普攻距离+1 米，伤害+10，命中具有优势。</p><p>·即便敌人不消耗移动速度从你身边离开（一些轻功或武功的效果，如奔袭等），你仍然能对其施展《趁虚而入》来发动普通攻击。</p><p><strong>升级：</strong>普通攻击距离+1，伤害+10，内力消耗+5。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "四平八稳",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "description": "<p>点击应用以获得“四平八稳”被动效果（持续到战斗脱离）。</p>",
                    "automationNote": "被动通过应用Buff实现。普攻修正自动生效。普攻额外消耗的内力请手动扣除。",
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "四平八稳",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "普通攻击增强。",
                    "transfer": true,
                    "flags": {
                        "xjzl-system": {
                            "slug": "sipingbawen",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "普攻修正",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "if (args.move.type === 'basic') {\n    // 获取招式等级 (通过 actor.items 查找)\n    // 由于这是在 AE 脚本里，我们需要找到源 Item\n    const sourceItem = thisEffect.parent instanceof Item ? thisEffect.parent : actor.items.get(thisEffect.origin?.split('.').pop()); \n    // 上面的查找可能不准，最稳妥是通过 slug 或 origin 查找\n    // 假设 origin 是准确的。如果找不到，默认 1 级。\n    // 实际上，因为这是散手，物品本身就在 actor 身上。\n    // 简化逻辑：直接假定等级关联，或者如果是 transfer effect，它就在 Item 上。\n    // 但此时 effect 在 actor 上。我们用 thisItem (指向源 Item 如果在脚本里能获取到的话，但 AE 脚本里 thisItem 是 Effect)\n    // 修正：我们需要找到“四平八稳”这个 Wuxue Item 来读取等级。\n    const wuxueItem = actor.items.find(i => i.name === \"四平八稳\" && i.type === \"wuxue\");\n    const lvl = wuxueItem ? Math.max(1, wuxueItem.system.moves[0]?.computedLevel || 1) : 1;\n    \n    const dmgBonus = 10 + (lvl - 1) * 10;\n    const mpCost = 5 + (lvl - 1) * 5;\n\n    args.flags.damageResult.damage += dmgBonus;\n    args.flags.damageResult.breakdown += `\\n+ 四平八稳: ${dmgBonus}`;\n    args.flags.level += 1;\n\n    ui.notifications.info(`触发四平八稳：请手动扣除 ${mpCost} 点内力。`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "不入轮回",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>江湖气功，可抵一口精血维持一息性命。</p><p><strong>属性：</strong>阳</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "不入轮回",
                    "type": "qi",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你受伤后即将陷入濒死时，可消耗 4 点怒气，使你可以保留 1 点气血继续行动（但依然需要投掷残疾检定）且解除自身所有状态。</p><p>·本招式经过小憩之后，方可再次施展。</p><p><strong>升级：</strong>每提升一级减少 1 点怒气消耗。</p>",
                    "automationNote": "请将此招式设为常用。濒死时手动点击使用。使用后自动回血至1并清除所有临时状态。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "免死净化",
                            "trigger": "hit",
                            "script": "if (actor.system.resources.hp.value <= 0) {\n    // 锁血\n    await actor.update({\"system.resources.hp.value\": 1});\n    \n    // 清除临时状态 (transfer=false)\n    const tempEffects = actor.effects.filter(e => !e.transfer).map(e => e.id);\n    if (tempEffects.length > 0) {\n        await actor.deleteEmbeddedDocuments(\"ActiveEffect\", tempEffects);\n    }\n    ui.notifications.info(\"不入轮回触发：保留1气血并清除状态！\");\n} else {\n    ui.notifications.warn(\"当前未处于濒死状态，不入轮回未生效。\");\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "佛魔双生",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>声名不显的佛门招式，秘籍的编写者自号“未来柯忌”，据说这位高手数百年前曾威震一方。</p><p>注：修炼此招式后，你堕入魔道，佛法无法圆满，你的[佛法]上限变为 9。</p><p><strong>需求：</strong>杀孽值≥18 且[佛法]等级≥9</p>",
            "requirements": "杀孽值≥18；佛法≥9",
            "moves": [
                {
                    "name": "佛魔双生",
                    "type": "qi",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>佛露恶念，内力颠转，获得“魔佛”，持续一回合。</p><p><strong>魔佛：</strong>你施展佛门武学的招式，造成伤害时，伤害类型变为毒素伤害。</p><p><strong>升级：</strong>魔佛持续的回合数+1，消耗+4。</p>",
                    "automationNote": "自动获得魔佛状态。伤害转化自动生效(需招式名含\"佛\"或门派为万佛寺)。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得魔佛",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst eff = thisItem.effects.getName(\"魔佛\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: rounds };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "魔佛",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "佛门武学伤害转化为毒素。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "mofo",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "毒素转化",
                                    "trigger": "preDamage",
                                    "active": true,
                                    "script": "const moveName = args.move.name || \"\";\nconst sect = args.item.system.sect || \"\";\nif (moveName.includes(\"佛\") || sect === \"wanfosi\") {\n    args.config.type = \"poison\";\n    ui.notifications.info(\"魔佛：伤害转化为毒素！\");\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "火灼之术",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>霹雳堂内门秘传，将硝、硫磺和木炭按比例搭配混合，获得黑火药，并将其混入武器，通过特殊发力技巧催动，引起火药效果，声势非凡。</p><p><strong>消耗：</strong>100 两/次</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "火灼之术",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "小憩",
                    "description": "<p>花费一个小憩的时间，在一把武器中内置火药，该武器获得一层“火灼”词缀，至多三层，持续到被消耗或遇到水。</p><p><strong>火灼：</strong>该武器命中目标后，你可以选择移除一层“火灼”，额外造成 10 点火焰伤害。</p><p><strong>升级：</strong>武器额外获得一层火灼。</p>",
                    "automationNote": "使用获得火灼层数(叠加)。攻击时自动弹窗询问是否消耗层数增加伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得火灼",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\n\n// 循环叠加层数\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(actor, \"huozhuo\");\n}\nui.notifications.info(`获得 ${stacks} 层火灼。`);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "火灼",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "命中后可消耗层数造成火焰伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huozhuo",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "消耗爆发",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "const confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"火灼之术\" },\n    content: `<p>是否消耗一层 [火灼] 造成额外 10 点火焰伤害？</p>`,\n    yes: { label: \"引爆\", icon: \"fas fa-fire\" },\n    no: { label: \"保留\", icon: \"fas fa-times\" }\n});\n\nif (confirm) {\n    await game.xjzl.api.effects.removeEffect(actor, \"huozhuo\", 1);\n    args.flags.damageResult.damage += 10;\n    args.flags.damageResult.breakdown += \"\\n+ 火灼: 10\";\n    ui.notifications.info(\"火药引爆！附加火焰伤害。\");\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "他心通",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>全称他心智证通或智心差别智作证通。证得他心智，能如实了知他人心中差别相之神通力。</p><p><strong>需求：</strong>气感大于 150</p>",
            "requirements": "气感>150",
            "moves": [
                {
                    "name": "他心通",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你能看见任意目标时，可消耗反应动作，了知心神，你获得“他心通”，持续一回合。</p><p><strong>他心通：</strong>你感知范围内所有内息低于自己气感角色的心中想法。这些想法源源不断第一时间传入你的脑海，并且你不会因此而混淆。</p><p>·若目标也看见了你，会知道你正感知他的想法。目标可以用[欺瞒]来对抗你的[洞察]，若他胜利，可隐藏自己内心的想法，而避免被你知晓。</p><p><strong>升级：</strong>招式距离+5。升级至合一后，即便内息高于你气感的目标，也会被你知道他的心中想法。</p>",
                    "automationNote": "纯剧情效果。请手动处理与GM的沟通。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            10
                        ]
                    },
                    "actionType": "buff"
                }
            ]
        }
    },
    {
        "name": "神行无双",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>取自《列子》：乘空如履实，寝虚若处床。云雾不硋其视，雷霆不乱其听，美恶不滑其心，山谷不踬其步。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "神行百变 (第一层)",
                    "type": "qi",
                    "actionType": "buff",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "被动",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "description": "<p>需求：悟性达到 10，修为 2000。</p><p>你的速度提高 5 点，闪避提高 5 点。</p>",
                    "automationNote": "被动属性自动生效。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            2000
                        ]
                    },
                    "scripts": [
                        {
                            "label": "属性加成",
                            "trigger": "passive",
                            "script": "if (move.computedLevel >= 1) {\n    system.combat.speed += 5;\n    system.combat.dodge += 5;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "如履平地 (第二层)",
                    "type": "qi",
                    "actionType": "buff",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "被动",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "description": "<p>需求：悟性达到 12，修为 3000。</p><p>你可以无视困难地形，且可以双脚垂直悬停、倒挂于墙壁之上行走。</p><p>当你受伤时可以减免 50 点内外功伤害，然后获得“卸劲”，持续一回合。</p><p><strong>卸劲：</strong>招式伤害降低 50 点。</p>",
                    "automationNote": "减伤效果自动(preTake)。卸劲状态自动施加。地形效果手动。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            3000
                        ]
                    },
                    "scripts": [
                        {
                            "label": "减伤与卸劲",
                            "trigger": "preTake",
                            "script": "if (move.computedLevel >= 1 && (args.type === 'waigong' || args.type === 'neigong')) {\n    args.output.damage = Math.max(0, args.output.damage - 50);\n    \n    // 添加卸劲AE\n    const eff = thisItem.effects.getName(\"卸劲\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: 1 };\n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"如履平地：减伤 50 并获得 [卸劲]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "百变不变 (第三层)",
                    "type": "qi",
                    "actionType": "buff",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "被动",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "description": "<p>需求：悟性达到 16，修为 5000。</p><p>进入战斗后每次出招都可获得一层“百变”，至多三层，持续到战斗脱离。</p><p><strong>百变：</strong>每层使你的速度+5，闪避+5。</p><p>·在你的回合末，你可以消耗一层“百变”，回到你回合初所处于的位置。</p>",
                    "automationNote": "出招获得百变自动。回溯位置手动。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            5000
                        ]
                    },
                    "scripts": [
                        {
                            "label": "出招获百变",
                            "trigger": "attack",
                            "script": "if (move.computedLevel >= 1) {\n    const eff = thisItem.effects.getName(\"百变\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "卸劲",
                    "icon": "icons/svg/downgrade.svg",
                    "description": "招式伤害降低 50。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiejin",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "-50"
                        }
                    ]
                },
                {
                    "name": "百变",
                    "icon": "icons/svg/wing.svg",
                    "description": "速度+5，闪避+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "baibian",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "一心二用",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>江湖绝顶奇功，使用者可以用两只手同时做不同的事情，左右互搏。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "一手画方 (第一层)",
                    "type": "qi",
                    "description": "<p>需求：悟性达到 10，修为 5000。</p><p>你可以同时开启两个不同的架招，获得两个架招提供的格挡值，并同时获得它们带来的效果。</p><p>·当你被虚招破防后，两个架招会同时被击破。</p>",
                    "automationNote": "手动处理双架招逻辑。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            5000
                        ]
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                },
                {
                    "name": "一手画圆 (第二层)",
                    "type": "qi",
                    "description": "<p>需求：悟性小于 20，修为 4000。</p><p>你不必遵循武学切换规则，即一回合内可以接连施展不同武学套路的招式。</p>",
                    "automationNote": "规则豁免，无需脚本。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            4000
                        ]
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                },
                {
                    "name": "左右互博 (第三层)",
                    "type": "qi",
                    "description": "<p>需求：悟性小于 15，修为 1000。</p><p>你的单体目标的招式，可以额外指定一个目标。</p>",
                    "automationNote": "请手动多选一个目标。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            1000
                        ]
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "浩然正气",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>天地有正气，存于人心间，此技培养人之根本精神，处变不惊，至大至刚，留于天地。</p><p><strong>需求：</strong>恶行值 0，标签为[大侠]</p>",
            "requirements": "恶行值0；大侠",
            "moves": [
                {
                    "name": "浩然正气",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "25米",
                    "targetInfo": "敌方",
                    "actionCost": "次要动作",
                    "description": "<p>运气全身，加持浩然之力，选择一个敌人，然后自身获得以下状态中一种，持续两回合。</p><p><strong>威武不能屈：</strong>遇强则强，自身每有一项属性低于对手，招式伤害+10，格挡值+10。</p><p><strong>富贵不能淫：</strong>每回合初移除自身任意一个状态，然后自身恢复生命值 10 点，目标失去 1 点怒气。</p><p><strong>贫贱不能移：</strong>你被该目标打入濒死时，可以保留 1 气血继续战斗。</p><p><strong>升级：</strong>持续回合+2，消耗+10。</p>",
                    "automationNote": "出招选择Buff。威武属性判定手动。富贵回血自动，去状态/扣怒气手动。贫贱免死自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30,
                            40
                        ]
                    },
                    "scripts": [
                        {
                            "label": "选择Buff",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 2 + (lvl - 1) * 2;\n\nnew Dialog({\n    title: \"浩然正气选择\",\n    buttons: {\n        b1: {\n            label: \"威武不能屈 (属性差加成)\",\n            callback: async () => {\n                const eff = thisItem.effects.getName(\"威武不能屈\").toObject();\n                delete eff._id; eff.origin = thisItem.uuid; eff.duration = {rounds: rounds};\n                await game.xjzl.api.effects.addEffect(actor, eff);\n            }\n        },\n        b2: {\n            label: \"富贵不能淫 (回血/去状态)\",\n            callback: async () => {\n                const eff = thisItem.effects.getName(\"富贵不能淫\").toObject();\n                delete eff._id; eff.origin = thisItem.uuid; eff.duration = {rounds: rounds};\n                await game.xjzl.api.effects.addEffect(actor, eff);\n            }\n        },\n        b3: {\n            label: \"贫贱不能移 (免死)\",\n            callback: async () => {\n                const eff = thisItem.effects.getName(\"贫贱不能移\").toObject();\n                delete eff._id; eff.origin = thisItem.uuid; eff.duration = {rounds: rounds};\n                await game.xjzl.api.effects.addEffect(actor, eff);\n            }\n        }\n    }\n}).render(true);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "威武不能屈",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "属性低于对手时获得加成(手动)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "weiwu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "富贵不能淫",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "回合初回血(自动)。去状态、扣怒气(手动)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fugui",
                            "stackable": false,
                            "regenHpTurnStart": 10
                        }
                    },
                    "changes": []
                },
                {
                    "name": "贫贱不能移",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "被特定目标攻击濒死时保留1血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "pinjian",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "免死",
                                    "trigger": "dying",
                                    "active": true,
                                    "script": "args.preventDying = true;\nui.notifications.info(\"贫贱不能移：保留 1 气血！\");"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "神威",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>神出江海，威震天下。名震寰宇，万国朝拜之技。</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "神威",
                    "type": "qi",
                    "actionType": "attack",
                    "damageType": "liushi",
                    "weaponType": "none",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>瞬身推掌，刚劲威猛，使目标流失 10*怒气点气血，并以绝强气劲将目标击飞 1*怒气值的米数。</p><p><strong>升级:</strong>每点怒气额外流失 10 气血、额外击飞 1 米。</p>",
                    "automationNote": "出招时询问消耗怒气。流失伤害自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗怒气与计算",
                            "trigger": "attack",
                            "script": "const currentRage = actor.system.resources.rage.value;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst dmgPerRage = 10 + (lvl - 1) * 10;\nconst distPerRage = 1 + (lvl - 1) * 1;\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"神威\" },\n    content: `<p>当前怒气: ${currentRage}</p><p>消耗全部怒气，造成每点 <b>${dmgPerRage}</b> 流失伤害，击飞 <b>${distPerRage}</b> 米/点。</p>`,\n    yes: { label: \"释放\", icon: \"fas fa-bomb\" }\n});\n\nif (confirm) {\n    await actor.update({\"system.resources.rage.value\": 0});\n    \n    const totalDmg = currentRage * dmgPerRage;\n    args.flags.damageResult.damage = totalDmg;\n    args.flags.damageResult.breakdown += `\\n神威 (${currentRage}怒): ${totalDmg}`;\n    \n    ui.notifications.info(`神威：击飞 ${currentRage * distPerRage} 米！`);\n} else {\n    args.flags.abort = true;\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "探花飞刀",
        "type": "real",
        "element": "taiji",
        "damageType": "waigong",
        "weaponType": "hidden",
        "range": "25米",
        "targetInfo": "单体",
        "actionCost": "主要动作",
        "description": "<p>对目标造成伤害。使目标陷入“错骨”，持续一回合。</p><p>·若目标为【大恶】，则必然命中目标，然后与目标进行一次气感对抗，若对抗成功，则此刀随气牵引，正中目标咽喉，招式伤害+50。</p><p><strong>升级：</strong>招式伤害+10，对大恶伤害+50，消耗+10。</p>",
        "automationNote": "施加错骨自动。大恶判定自动(恶>=500,侠<100)。大恶必中自动。气感对抗自动请求，伤害加成需手动修正。",
        "calculation": {
            "base": 0,
            "growth": 10,
            "scalings": [
                {
                    "prop": "shenfa",
                    "ratio": 0.4
                },
                {
                    "prop": "neixi",
                    "ratio": 0.4
                }
            ]
        },
        "costs": {
            "mp": [
                10,
                20,
                30,
                40
            ]
        },
        "scripts": [
            {
                "label": "施加错骨",
                "trigger": "hit",
                "script": "await game.xjzl.api.effects.addEffect(args.target, \"cuogu\");",
                "active": true
            },
            {
                "label": "大恶判定与对抗",
                "trigger": "attack",
                "script": "const t = Array.from(game.user.targets)[0]?.actor;\nif (t) {\n    const isDaE = (t.system.social.exing >= 500 && t.system.social.xiayi < 100);\n    if (isDaE) {\n        ui.notifications.info(\"目标为[大恶]！本招式必中。正在发起气感对抗...\");\n        args.flags.forceHit = true;\n        \n        // 发起后续对抗\n        await Macros.requestContest({\n            attacker: actor,\n            defender: t,\n            type: \"qigan\",\n            label: \"探花飞刀 - 气感牵引\",\n            outcome: {\n                win: { text: \"气机牵引，正中咽喉！请手动补算 +50 伤害。\" },\n                lose: { text: \"未能命中要害。\" }\n            }\n        });\n    }\n}",
                "active": true
            }
        ]
    },
    {
        "name": "天外飞剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>人如飞仙剑如神，居高而下剑迅击，人剑合一，天下无双。</p><p><strong>属性：</strong>太极</p><p><strong>需求：</strong>剑-单剑 剑>15</p>",
            "requirements": "剑-单剑；剑>15",
            "moves": [
                {
                    "name": "天外飞剑",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "25米",
                    "targetInfo": "单体/范围",
                    "actionCost": "主要动作",
                    "description": "<p>当你处于半空中时，可消耗主要动作释放此招：</p><p>·无瑕无垢，浑然天成：移除自身所有敌人添加的状态，此时你无法被招式选中，持续到你的下回合初。</p><p>·青天白云，剑锋彻骨：你选中范围内的所有敌人，使他们陷入下盘不稳，持续一回合，并对他们造成精神伤害，然后一剑斜来，惊芒掣电，飞身穿至其中一名敌人身后，造成外功伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "效果抉择提示自动。去状态手动。不可选中手动。AOE/单体伤害分段结算需手动（建议多次应用或Shift+应用）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "shenfa",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            2,
                            2,
                            2,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "ChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"font-weight:bold;\">天外飞剑 - 效果选择</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p><b>选项 A (无瑕无垢):</b> 手动移除敌方状态，视为不可选中。</p>\n            <p><b>选项 B (青天白云):</b></p>\n            <ul>\n                <li>对范围敌人：手动施加 [下盘不稳]，应用精神伤害。</li>\n                <li>对单体：应用额外外功伤害。</li>\n            </ul>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ]
        }
    }
]