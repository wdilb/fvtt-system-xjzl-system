[
    {
        "name": "剔骨刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>厨师处理食材练就的刀法，剔肉抽骨，行云流水。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "磨刀霍霍",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>响亮磨刀，开启架招。自身获得“剔骨”，持续一回合。</p><p><strong>剔骨：</strong>你的刀法招式伤害提高 5 点。</p><p>·每有 5 级[烹饪]，剔骨提供的伤害+5。</p><p><strong>升级：</strong>格挡值+5，剔骨持续回合+1，内力消耗+1。</p>",
                    "automationNote": "开启获BUFF自动(数值基于烹饪等级)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得剔骨",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"剔骨\").toObject();\nconst cookingLevel = actor.system.arts.pengren?.total || 0;\nconst extraBonus = Math.floor(cookingLevel / 5) * 5;\nconst totalBonus = 5 + extraBonus;\n\neff.changes[0].value = String(totalBonus);\n\n// 计算持续时间 (1 + Lv-1)\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(`磨刀霍霍：烹饪等级 ${cookingLevel}，额外加成 +${extraBonus}`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "切肤之痛",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>每当你受到招式伤害后，可消耗反应动作，反握尖刀，切向目标，对其造成 0.4 力量点外功伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "剥皮去骨",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>垂直刀刃，劈下切割，对目标造成 0.4 力量点外功伤害。</p><p>若施展此招后使目标进入濒死状态，目标的残疾检定结果-1（最低 1）。</p><p><strong>升级：</strong>招式伤害+5，检定结果再-1，内力消耗+1。</p>",
                    "automationNote": "濒死时提示GM处理残疾检定。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死检定惩罚提示",
                            "trigger": "hit",
                            "script": "if (args.isDying) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const penalty = 1 + (lvl - 1);\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"font-weight:bold; color:red;\">剥皮去骨 - 残疾检定惩罚</div>\n            <div>目标进入濒死！请 GM 在进行残疾检定时手动 <b>-${penalty}</b> (最低为1)。</div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "挫骨扬灰",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>扒皮抽筋，砍剁成碎，对目标造成 0.6 力量点外功伤害，并为其添加“错骨”三回合。</p><p>·若目标处于濒死状态，则招式必定暴击，且为其添加“血流不止”，持续到脱战。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "错骨自动。濒死必定暴击/血流不止自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死暴击判断",
                            "trigger": "attack",
                            "script": "const target = Array.from(game.user.targets)[0]?.actor;\nif (target && target.system.resources.hp.value <= 0) {\n    // 濒死必定暴击\n    args.flags.critThresholdMod += 20; \n    ui.notifications.info(\"目标濒死，必定暴击！\");\n}",
                            "active": true
                        },
                        {
                            "label": "附加状态",
                            "trigger": "hit",
                            "script": "// 1. 错骨 (3回合)\nawait game.xjzl.api.effects.addEffect(args.target, {\n    id: \"cuogu\",\n    duration: { rounds: 3 }\n});\n\n// 2. 若濒死，附加血流不止 (bloodloss)\nif (args.target.system.resources.hp.value <= 0) {\n    await game.xjzl.api.effects.addEffect(args.target, \"bloodloss\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "剔骨",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "刀法伤害提高。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tigu",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.weaponTypes.blade.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "黑虎断门刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>刚劲有力、勇猛矫健、神情兼备，是江湖上一套难度较大的刀法。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "黑虎剐心",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>劈砍前方敌人胸口造成 0.4 力量点外功伤害。</p><p>若对方无架招，胸口一痛两眼发黑，陷入目盲一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招目盲",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"blind\",\n        duration: { rounds: 1 }\n    });\n    ui.notifications.info(`${args.target.name} 陷入目盲！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "虎视眈眈",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀光花影，造成 0.3 力量点外功伤害，击破架招时，击飞目标 1 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`${args.target.name} 被击飞 1 米！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "虎不食子",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>横刀开启架招，格挡成功后，给自身添加“黑虎”状态，持续到战斗脱离。</p><p><strong>黑虎：</strong>《黑虎断门刀》所有招式伤害提升 5 点。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获黑虎自动。黑虎加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获黑虎",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"黑虎\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "谈虎色变",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>怒吼跳劈，对目标造成 0.5 力量点外功伤害。</p><p>若自身处于“黑虎”状态，刀影发黑，快速连斩，给其添加“错骨”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "黑虎加成自动。附加错骨自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "黑虎特效",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasHeihu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"heihu\");\n    if (hasHeihu) {\n        await game.xjzl.api.effects.addEffect(args.target, {\n            id: \"cuogu\",\n            duration: { rounds: 1 }\n        });\n        ui.notifications.info(\"黑虎加持：目标错骨！\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "scripts": [
                {
                    "label": "黑虎加伤",
                    "trigger": "calc",
                    "script": "const hasHeihu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"heihu\");\nif (hasHeihu) {\n    args.output.damage += 5;\n    args.output.bonusDesc.push(\"黑虎状态 +5\");\n}",
                    "active": true
                }
            ],
            "effects": [
                {
                    "name": "黑虎",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "黑虎断门刀招式伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "heihu",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "滚地刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>以地滚动作为主，主攻下三路，颇为棘手。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "懒驴打滚",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>迅速躺倒在地，原地绕圈滚动，开启架招。只要架招未被击破，敌人攻击你就不会因为攻击倒地角色获得优势。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "开启获BUFF自动(抵消倒地被击优势)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "抵消倒地",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"懒驴打滚\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "抛珠滚玉",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>只有在倒地状态下可以使用，对敌人造成 0.4 力量点外功伤害，同时给目标添加“下盘不稳”状态，持续两回合。</p><p>若你被敌人击倒，你可以使用反应动作施展此招。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "倒地判断手动。反应动作手动。下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"unstable\",\n        duration: { rounds: 2 }\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "滚汤泼雪",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>虚晃一刀，卷起尘土飞扬，对敌人造成 0.3 力量点外功伤害。击破对方架招时，使其陷入“目盲”状态，持续两回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破目盲",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"blind\",\n        duration: { rounds: 2 }\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "撒泼无赖",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>原地打转移动，刀刃胡乱旋转挥砍周围 1 米范围内的目标，造成 0.4 力量点外功伤害。</p><p>攻击下盘不稳的目标，招式伤害+10。</p><p>·此招可移动释放，对移动路径上周围 1 米范围内的敌人造成伤害。（不会重复造成伤害）</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "移动手动。针对下盘不稳加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "打滚加伤",
                            "trigger": "preDamage",
                            "script": "const isUnstable = args.target.effects.some(e => e.getFlag('xjzl-system', 'slug') === 'unstable');\nif (isUnstable) {\n    args.config.amount += 10;\n    ui.notifications.info(`${args.target.name} 下盘不稳，伤害 +10`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "懒驴打滚",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "敌人攻击你不会因为倒地获得优势 (给予敌方劣势抵消)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lanludagun",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.grantAttackLevel",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "冰雪刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>大雪纷飞，寒气凌冽，雪刀一柄度寒风。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>阴</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "冻雪冰人",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀冰刃寒，对目标造成 0.3 内息点内功伤害，击破架招时，使目标失去当前的反应动作。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破后反应动作丢失手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`${args.target.name} 失去反应动作！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "死生不弃",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当受到伤害前可以消耗反应动作施展，扬雪护身，回复 2 内力，本回合进行残疾检定时具有优势。</p><p><strong>升级：</strong>内力回复再+4。</p>",
                    "automationNote": "回蓝自动。残疾检定优势手动(提示)。",
                    "calculation": {
                        "base": 2,
                        "growth": 4
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回复内力",
                            "trigger": "hit",
                            "script": "// 气招类型heal默认回血，脚本处理回蓝\nconst amount = args.baseAmount;\nawait actor.applyHealing({amount: amount, type: 'mp', showScrolling: true});\nui.notifications.info(\"本回合残疾检定获得优势。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "人间飞雪",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀尖泛冰，开启架招。格挡成功后，获得“飞雪”，持续一回合。</p><p><strong>飞雪：</strong>虚招对抗检定+1。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p><p>招式精通后，虚招对抗检定再+1。</p>",
                    "automationNote": "格挡获飞雪自动。飞雪层数自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-飞雪",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 获取AE模板\nconst effData = thisItem.effects.getName(\"飞雪\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 精通(Level 3)判断\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\n\nif (lvl >= 3) {\n    effData.changes[0].value = \"2\";\n}\n\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "了因现雪",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>雪影弥漫，对所有敌人造成 0.5 内息点内功伤害，并在 5 米范围内产生‘寒霜’一回合。</p><p><strong>寒霜：</strong>区域中所有角色外功防御+5，内功防御-5。</p><p>·寒霜形成在原地，不会跟随你移动，你只能拥有一个寒霜，如果你形成新的寒霜，之前的消失。</p><p><strong>升级：</strong>招式伤害+10，寒霜中角色外防再+5，内防再-5，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "领域效果手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "生成领域",
                            "trigger": "hit_once",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 5 + (lvl - 1) * 5;\nui.notifications.info(`已生成 [寒霜] 领域 (5米)。效果：外防 +${bonus} / 内防 -${bonus}。`);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "飞雪",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "虚招对抗检定加值。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "feixue",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.feintLevel",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "柴刀十八砍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>江湖最常见的刀法之一，很多刀客都会使用。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "剥皮去木",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>指抵刀背，开启架招。格挡成功后，获得一层“劲力”，至多三层，持续到战斗脱离。</p><p><strong>劲力：</strong>每层提高招式伤害 5 点。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获劲力自动。劲力加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-劲力",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"劲力\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "砍枝劈木",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>斜挥下砍，造成 0.3 力量点外功伤害。击破架招时，使目标陷入“下盘不稳”，持续 2 回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"unstable\",\n        duration: { rounds: 2 }\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拦腰截断",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>横劈一刀，造成 0.4 力量点外功伤害。击中无架招敌人获得额外一点怒气。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招回怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "额外回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await actor.update({ \"system.resources.rage.value\": actor.system.resources.rage.value + 1 });\n    ui.notifications.info(\"击中无架招，额外怒气 +1\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "大刀阔斧",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>全力一击，对目标造成 0.6 力量点外功伤害。击中无架招的敌人，使目标陷入“错骨”一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "无架招错骨自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招错骨",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"cuogu\",\n        duration: { rounds: 1 }\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "劲力",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "招式伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jinli",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "神江刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>原为士兵水战所用刀法，刀势有去无回，一往无前。</p><p><strong>需求：</strong>刀-单刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "风光染血",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀光舞动，开启架招。格挡成功后，可以不消耗速度向攻击者移动 1 米。</p><p><strong>升级：</strong>格挡值+5，可额外移动 1 米，内力消耗+1。</p>",
                    "automationNote": "移动手动(提示)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "移动提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst dist = 1 + (lvl - 1);\nui.notifications.info(`格挡成功：可向攻击者移动 ${dist} 米。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "长江东流",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>快速奔至目标身边空格，劈头一刀，对目标造成 0.3 力量点外功伤害。</p><p>若击中无架招目标，可以使用次要动作再使用一次【长江东流】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。连击提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连击提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"击中无架招：可消耗次要动作再施展一次【长江东流】\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "浪断生杀",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，同时奔袭至攻击者身边空格，对其造成 0.4 力量点外功伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "神江一梦",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>将手中刀旋转投掷出去，造成 0.5 力量点外功伤害，然后飞身（视作半空中）至目标身前空格接住弹回的飞刀。</p><p>若击中无架招目标，可以使用次要动作再使用一次【长江东流】。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "移动手动。连击提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连击提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"击中无架招：可消耗次要动作再施展一次【长江东流】\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "辛酉刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>载于《武艺诸谱》，以唐刀制式的双手长刀为武器，适合军阵对敌，专克倭刀刀法，锋利难当。</p><p><strong>需求：</strong>刀-横刀</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "出刀防贼势",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>左手持柄，负刀正立，开启架招。格挡刀法招式成功后，可不消耗动作对攻击者进行一次普通攻击。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "普攻提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nui.notifications.info(\"格挡成功！若对方招式为刀法，可免费进行一次普通攻击。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "持刀击贼势",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>握刀直劈，对目标造成 0.3 力量点内功伤害。当你受到 1 米内的刀法招式伤害后，可以消耗反应动作释放此招。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "退坐藏刀势",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>半蹲背刀，伺机对敌，选择一个敌人，若他手中持刀，你获得一层“刀势”，至多三层，持续到脱战或更换其他武器的武学套路。</p><p><strong>刀势：</strong>每层使刀法命中+10。</p><p><strong>升级：</strong>动作下降一级（蓄力-主要-次要），内力消耗+1。</p>",
                    "automationNote": "目标持刀检测自动。刀势命中加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取刀势",
                            "trigger": "hit",
                            "script": "// 检测目标是否装备刀类武器\nconst targetHasBlade = args.target.itemTypes.weapon.some(w => w.system.equipped && w.system.type === \"blade\");\n\nif (targetHasBlade) {\n    const eff = thisItem.effects.getName(\"刀势\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"敌方持刀，获得 [刀势]！\");\n} else {\n    ui.notifications.warn(\"目标未持刀，无法获得刀势。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "左右防贼势",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，手腕反握，持刀直劈，对目标造成 0.5 力量点内功伤害。若你压制的是刀法虚招，使其陷入“撕裂”，持续三回合。</p><p><strong>撕裂：</strong>每次受到内外功伤害时，流失 10 点气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "撕裂效果需手动判断来源是否为刀法后施加。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "撕裂提示",
                            "trigger": "hit",
                            "script": "ChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>若压制的是 <b>刀法虚招</b>，请手动给目标施加 [撕裂] (3回合)。</p>\n            <p><i>注: 系统预设撕裂(sielie)为持续效果，请检查配置。</i></p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "进前杀贼势",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>进步挥刀，左右连砍，不消耗速度直线狂奔 5 米，对直线路径上敌人造成 0.5 力量点内功伤害。</p><p>·你每有一层“刀势”，招式暴击骰-1。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "移动手动。刀势增加暴击率自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "刀势暴击加成",
                            "trigger": "attack",
                            "script": "const daoshi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"daoshi\");\nif (daoshi) {\n    const stacks = daoshi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    args.flags.critThresholdMod += stacks;\n    ui.notifications.info(`刀势 x${stacks}：暴击阈值 -${stacks}`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "刀势",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "刀法命中增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "daoshi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "追风双刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>双刀连舞，内力越精深，气劲越绵延四溢。</p><p><strong>需求：</strong>刀-双刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀-双刀",
            "moves": [
                {
                    "name": "力沉劈山",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>沉力一劈，刀气对目标造成 0.4 力量点内功伤害。</p><p>·若有目标在空中，可消耗反应动作，立于原地释放刀气伤敌。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "刀舞乱麻",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刀来回抡斩，造成 0.3 力量点外功伤害。命中无架招目标时自身获得一层“刚劲”，至多三层，持续到战斗脱离。</p><p><strong>刚劲：</strong>每层使你的刚属性武学招式伤害+5。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招获刚劲自动。刚劲加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取刚劲",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"刚劲\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "刀疾风逝",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>刀势似风，劈向前方，对直线目标造成 0.3 力量点内功伤害。若自身具有“刚劲”，可消耗一层，击飞目标 1 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "消耗刚劲自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗提示",
                            "trigger": "attack",
                            "script": "const hasGangjin = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"gangjin\");\nif (hasGangjin) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"刀疾风逝\" },\n        content: `<p>检测到 [刚劲]。</p><p>是否消耗 1 层以击飞目标 1 米？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"不消耗\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await game.xjzl.api.effects.removeEffect(actor, \"gangjin\", 1);\n        ui.notifications.info(\"已消耗 [刚劲]，请手动击飞目标 1 米。\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天起刚风",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双刀舞气，开启架招，格挡成功时，自身获得一层“刚劲”，至多三层，持续到脱战。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获刚劲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-刚劲",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"刚劲\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "刀舞风沙",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>刀风呼啸，对范围内敌人造成 0.5 力量点内功伤害。</p><p>·此招可移动释放，对移动路径上周围 3 米范围内的敌人造成伤害。（不会重复造成伤害）</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    }
                }
            ],
            "effects": [
                {
                    "name": "刚劲",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "刚属性招式伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "gangjin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.gang.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "开山斧法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>朴实无华，力大势强。</p><p><strong>需求：</strong>刀-斧钺</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-斧钺",
            "moves": [
                {
                    "name": "连峰斩",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>连砍数斧，势大力沉，对目标造成 0.4 力量点外功伤害。</p><p>·造成暴击时，将目标击倒，并使其流失等同于武器伤害数值的气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "暴击施加倒地自动。暴击流血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "暴击特效",
                            "trigger": "hit",
                            "script": "if (args.isCrit) {\n    // 1. 击倒 (Prone)\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    \n    // 2. 流失 (武器伤害)\n    const weapon = actor.itemTypes.weapon.find(w => w.system.equipped && w.system.type === move.weaponType);\n    const val = weapon ? (weapon.system.damage || 0) : 0;\n    \n    if (val > 0) {\n        await args.target.applyDamage({ amount: val, type: \"liushi\" });\n        ui.notifications.info(`${args.target.name} 暴击流血：${val} 点！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "孤山残阳",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>斧划圆弧，人如峰立，岿然不动，开启架招。格挡成功时，免疫击飞效果。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "免疫击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "燕子入巢",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，脚踢对手兵刃，顺势回撩，对目标造成 0.4 力量点外功伤害，击中无架招敌人，使目标陷入“错骨”状态，持续两回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招错骨自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招错骨",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, {\n        id: \"cuogu\",\n        duration: { rounds: 2 }\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "铁火连山",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>劈刺截扫，斩削砍剁，对目标造成 0.2 力量点外功伤害，并与目标进行一次力量对抗。对抗成功，则击退对手 1 米，并使自己前进 1 米，重复一次此招式效果。最多叠加 3 次。</p><p><strong>升级：</strong>造成伤害+20，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "自动发起力量对抗。击退、重复施放均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.2
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "力量对抗",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await Macros.requestContest({\n        attacker: actor,\n        defender: args.target,\n        type: 'liliang',\n        label: '铁火连山 - 力量对抗',\n        outcome: {\n            win: { text: '对抗胜利：击退敌人1米，前进1米，可再次施放（手动）。' },\n            lose: { text: '对抗失败：攻势被阻挡。' }\n        }\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "血战刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>兵卒所用刀法，善于在千军万马之中冲杀。</p><p><strong>需求：</strong>刀-单刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "两军对垒",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持刀护身，开启架招。格挡成功时，获得一层“磐石”，至多三层，持续到脱战。</p><p><strong>磐石：</strong>每层使你格挡值+5。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获磐石自动。磐石加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-磐石",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"磐石\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "锋芒毕露",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>持刀快斩，对周围敌人造成 0.3 力量点外功伤害，若一次性命中超过 3 个敌人，则可以消耗反应动作再施展一次【锋芒毕露】。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "命中计数检测自动。连击提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连击检测",
                            "trigger": "hit_once",
                            "script": "if (args.hitCount > 3) {\n    ui.notifications.info(`命中 ${args.hitCount} 人 (>3)：可消耗反应动作再施展一次【锋芒毕露】`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "轻骑突出",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>不消耗速度狂奔，途中可以被《趁虚而入》，但不会使你的速度归零。冲杀至目标身前，对目标一刀斩出，造成 0.4 力量点外功伤害，突进过程中每受到一次攻击，此招伤害+10。</p><p>·若在骑马时施展，马匹增加 5 点速度，途中被《趁虚而入》也不会速度归零。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "移动手动。受击加伤手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "君临天下",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>怒喝一声，威势震天，使周围友方角色获得一层“蓄劲”，至多三层，持续到脱战。</p><p><strong>蓄劲：</strong>每层使你暴击骰-1。</p><p><strong>升级：</strong>额外获得一层蓄劲，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "友方BUFF施加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加蓄劲",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"蓄劲\").toObject();\n// 升级效果：额外获得一层。通过修改 AE 模板的 mode=2 value 来实现？\n// 不行，mode=2 ADD 是叠加。我们应该调用 addEffect 两次，或者修改 stacks flag。\n// 最稳妥：根据等级循环调用 addEffect。\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst amount = 1 + (lvl - 1);\n\n// 循环应用以确保正确叠层\nfor(let i=0; i<amount; i++) {\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "磐石",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "格挡值增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "panshi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "蓄劲",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "暴击阈值降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xujin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "厚德刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>刀势厚重凝练，以德行护身为先，攻伐劝敌于后。唯有德高望众、肩负重任之人方能领悟。</p><p><strong>需求：</strong>刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "含垢弃瑕",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "单体",
                    "actionCost": "次要动作",
                    "description": "<p>君子包容万象，不责过失，收刀入鞘，你指定一个敌对目标，与其同时进入“宽宥”状态，持续一回合。</p><p><strong>宽宥：</strong>目标的每个回合末，回复 10 点气血。</p><p><strong>升级：</strong>宽宥持续回合数+1，内力消耗+2。</p>",
                    "automationNote": "施加宽宥自动 (目标+自身)。回合回血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加宽宥",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"宽宥\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\n\n// 给目标\nawait game.xjzl.api.effects.addEffect(args.target, eff);\n// 给自己\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "以德服人",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀芒轻闪，略施惩戒，教人心悦诚服，对目标造成 0.3 力量点内功伤害，并为其添加“报德”，持续一回合。</p><p><strong>报德：</strong>每次出招时，自身受到 10 点精神伤害。</p><p><strong>升级：</strong>伤害+5，报德持续回合数+1，内力消耗+1。</p>",
                    "automationNote": "施加报德自动。报德反伤效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加报德",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"报德\").toObject();\nconst lvl = Math.max(1, move.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "载舟覆舟",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制对方虚招，抽刀而出，破其怨愤，平其心气，造成 0.5 力量点内功伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "高风亮节",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>驻刀直立，清气满堂，对自身周围敌方造成 0.7 力量点内功伤害。</p><p>若目标身上同时存在“宽宥”和“报德”，则进行一次[气感]检定（难度 11），失败则羞愧懊悔自责，陷入“自闭”一回合。</p><p><strong>升级：</strong>招式伤害+20，气感检定难度+3，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "状态检测自动。检定请求自动。失败惩罚自动。",
                    "tier": 2,
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "组合检定",
                            "trigger": "hit",
                            "script": "const hasKuanyou = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kuanyou\");\nconst hasBaode = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"baode\");\n\nif (hasKuanyou && hasBaode) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dc = 11 + (lvl - 1) * 3;\n    \n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"qigan\",\n        dc: dc,\n        label: \"高风亮节 - 羞愧检定\",\n        onFail: \"zibi\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "宽宥",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "回合末回复气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "kuanyou",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "报德",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "出招时受到精神伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "baode",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "出招自伤",
                                    "trigger": "attack",
                                    "script": "await actor.applyDamage({amount: 10, type: \"mental\", attacker: actor, isHit: true, ignoreDefense: true});",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "苗刀十二式",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>御林军所修刀法，也称苗刀二路，身摧刀往，刀随人转，雄健凌厉，一势承多式，连势不绝。</p><p><strong>需求：</strong>刀-横刀</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "朝天刀势",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双手举刀，守望中门，威风肃杀，银光劈落对目标造成 0.5 力量点内功伤害。</p><p>·当你受到刀法招式伤害后，可以不消耗速度朝任意方向奔袭 3 米，然后消耗反应动作释放此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "移动手动。反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "担肩刀势",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双手反握，刀背靠肩，开启架招。格挡成功后，不消耗速度朝任意方向奔袭 3 米，再不消耗动作回转刀身，换步变势，进行一次普通攻击。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "移动手动。普攻提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nui.notifications.info(\"格挡成功！可免费移动 3 米并进行一次普通攻击。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "正劈刀势",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>逢进必迎，连环劈刀，造成 0.4 力量点内功伤害，击破架招时获得“连击”持续到脱战。</p><p><strong>连击：</strong>你施展消耗主要动作的招式后，可以消耗反应动作，再次释放该招式，然后移除“连击”。</p><p>·若目标的架招是刀法，虚招值+1。</p><p><strong>升级：</strong>招式伤害+10，虚招值再+1，内力消耗+2。</p>",
                    "automationNote": "击破获连击自动。刀法架招判定提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破连击",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(actor, \"lianji\");\n}",
                            "active": true
                        },
                        {
                            "label": "架招类型提示",
                            "trigger": "calc",
                            "script": "args.output.bonusDesc.push(\"若目标架招为刀法，虚招值+1 (需手动确认)\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "埋头刀势",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，抚刀背长，反臂车轮倒劈，对其造成 0.6 力量点内功伤害。为其添加“禁虚”，持续两回合。</p><p><strong>禁虚：</strong>无法施展虚招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "施加禁虚自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁虚",
                            "trigger": "hit",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"jinxu\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "迎推刀势",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>紧握刀柄，如青龙出洞，刀刺目标造成 0.7 力量点内功伤害。若招式将目标打入濒死，你获得“连击”持续到脱战。</p><p><strong>连击：</strong>你施展消耗主要动作的招式后，可以消耗反应动作，再次释放该招式，然后移除“连击”。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "濒死获连击自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死连击",
                            "trigger": "hit",
                            "script": "if (args.isDying) {\n    await game.xjzl.api.effects.addEffect(actor, \"lianji\");\n    ui.notifications.info(\"目标濒死，获得 [连击]！\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "风后奇刃",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>相传为黄帝手下大将风后所使，其中暗含奇门数算之道，随着其后人遁入空门，此刀法又经过改良，使其能与一门佛门剑法配合。</p><p><strong>需求：</strong>刀-弯刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-弯刀",
            "moves": [
                {
                    "name": "荧惑察微",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，荧惑守心，祸之将现，刀光迷心，对目标造成伤害，造成伤害后，若对方持有架招，可以切换套路为《文殊剑法》，并消耗反应动作释放【智引迷航】。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "套路切换及连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示切换",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.system.martial.stanceActive) {\n    ui.notifications.info(\"命中持架招目标，可手动切换《文殊剑法》并释放【智引迷航】。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "镇星荡宿",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，镇星摇荡，四时失政，刀势轻灵，对目标造成伤害。击中无架招目标时，使对方心神不定，为其添加“命奇”状态，持续两回合。</p><p><strong>命奇：</strong>悟性-3。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加命奇",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"命奇\").toObject();\n    eff.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "摄提启年",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，摄提值年，岁以之启，自身脱离战斗并重新进入战斗，然后回合结束。（先攻顺序不变）</p><p><strong>升级：</strong>内力消耗-5，怒气消耗-1。</p>",
                    "automationNote": "战斗状态重置手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            30,
                            25,
                            20
                        ],
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    }
                },
                {
                    "name": "太白经天",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，太白经天，天下乃变，开启架招，格挡成功时，获得“太白经天”状态，持续一回合。</p><p><strong>太白经天：</strong>你的所有劣势骰，均会化为优势骰。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获益",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"太白经天\").toObject();\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "辰星犯主",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，辰星犯明堂，则天下大罚，对周围敌人造成伤害，若你存在“太白经天”状态，则将其转化为“五星分天”状态，持续到战斗脱离。</p><p><strong>五星分天：</strong>虚招对抗检定结果+3。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "状态转化",
                            "trigger": "attack",
                            "script": "const taibai = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"taibaijingtian\");\nif (taibai) {\n    await taibai.delete();\n    const wuxing = thisItem.effects.getName(\"五星分天\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, wuxing);\n    ui.notifications.info(\"太白经天 已转化为 五星分天\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "命奇",
                    "icon": "icons/magic/symbols/question-stone-yellow.webp",
                    "description": "悟性-3。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "mingqi",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.stats.wuxing.mod",
                            "mode": 2,
                            "value": "-3"
                        }
                    ]
                },
                {
                    "name": "太白经天",
                    "icon": "icons/magic/light/star-struck-purple.webp",
                    "description": "劣势转化为优势。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "taibaijingtian",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "劣势转优势(攻)",
                                    "trigger": "attack",
                                    "script": "if (args.flags.level < 0) args.flags.level = Math.abs(args.flags.level);",
                                    "active": true
                                },
                                {
                                    "label": "劣势转优势(检定)",
                                    "trigger": "check",
                                    "script": "if (args.flags.grantLevel > 0) args.flags.grantLevel = -args.flags.grantLevel; // 别人打我优势变劣势\nif (args.flags.grantFeintLevel > 0) args.flags.grantFeintLevel = -args.flags.grantFeintLevel;",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "五星分天",
                    "icon": "icons/magic/light/beam-rays-orange-purple.webp",
                    "description": "虚招对抗检定结果+3。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxingfentian",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "3"
                        },
                        {
                            "key": "system.combat.xuzhao",
                            "mode": 2,
                            "value": "3"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "五行斧诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>相生相克，衍化万千，刀斧纵横，大气磅礴。</p><p><strong>需求：</strong>刀-斧钺</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀-斧钺",
            "moves": [
                {
                    "name": "青木无生",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，斧光乍现，斩断生机，对目标造成伤害，击中无架招的敌人使其陷入“缚身”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加缚身",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fushen\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "赤火焚天",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，斧柄如火，开启架招。该架招开启期间，5 米范围内所有想要远离你的角色，视为在困难地形上移动（需要消耗双倍的速度）。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "困难地形效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "黑水倾覆",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，旋转大斧，产生无穷吸力，对周围敌人造成伤害，击破架招将目标吸至自己身边空格并将其击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "位移与击倒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`${args.target.name} 被击破！请手动吸至身边并击倒。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白金碎尘",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，金色斧影闪过，对其造成伤害。</p><p>·若自身处于“封招”“缚身”时受到虚招攻击，则虚招对抗必定成功，直接消耗反应施展此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "必胜逻辑判断及反应施放手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "黄土光阴",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，萧瑟一斧，瞬息便至，无可抵挡，对目标造成伤害。</p><p>·招式伤害无视防御、格挡值。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无视防御格挡",
                            "trigger": "preDamage",
                            "script": "args.config.ignoreBlock = true;\nargs.config.ignoreDefense = true;",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "正两仪双刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>从伏羲文王的八卦方位中推演而得，其奥妙精微之处，易理之深邃，常人难以琢磨，需与反两仪双剑合用。</p><p><strong>需求：</strong>刀-双刀</p><p><strong>属性：</strong>太极</p><p>注：当周围 10 米范围内有一名队友存在“少阳”“少阴”状态、且你存在“太阳”“太阴”时，你与他同时进入“阴阳调和”状态，浑身四象流转，持续到战斗脱离。</p>",
            "requirements": "刀-双刀",
            "moves": [
                {
                    "name": "阴凝坚冰",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，双刀覆盖寒气，开启架招。成功格挡时，自身进入“太阴”状态，持续到战斗脱离。</p><p>·当你开启此架招，并处于“阴阳调和”状态时，你每回合初回复 10 点气血。</p><p><strong>升级：</strong>格挡值+10。回复气血+10，内力消耗+2。</p>",
                    "automationNote": "需手动赋予[阴阳调和]状态以触发额外效果。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获太阴",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"太阴\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "调和回血",
                            "trigger": "turnStart",
                            "script": "const hasTiaohe = actor.effects.some(e => e.name === \"阴阳调和\");\nif (hasTiaohe) {\n    await actor.applyHealing({amount: 10, type: 'hp', showScrolling: true});\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阳融春水",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，刀尖照影，阳气灼灼，造成伤害，并为自身添加“太阳”状态，持续到战斗脱离。</p><p>·当你处于“阴阳调和”状态时，招式伤害+30。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获太阳",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"太阳\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "调和加伤",
                            "trigger": "calc",
                            "script": "const hasTiaohe = actor.effects.some(e => e.name === \"阴阳调和\");\nif (hasTiaohe) {\n    args.output.damage += 30;\n    args.output.bonusDesc.push(\"阴阳调和 +30\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴阳相隔",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，刀身连环挥舞，造成伤害，击破对方架招时，将目标击飞 1 米。</p><p>·当你处于“阴阳调和”状态时，虚招值+2。</p><p><strong>升级：</strong>招式伤害+10，虚招值+1，内力消耗+2。</p>",
                    "automationNote": "调和加虚招自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "调和加虚招",
                            "trigger": "calc",
                            "script": "const hasTiaohe = actor.effects.some(e => e.name === \"阴阳调和\");\nif (hasTiaohe) {\n    args.output.feint += 2;\n    args.output.bonusDesc.push(\"阴阳调和 虚招+2\");\n}",
                            "active": true
                        },
                        {
                            "label": "击破击飞",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(`${args.target.name} 被击破！请手动击飞 1 米。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "调理阴阳",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招的时候，你可以用反应动作释放此招，压制对方虚招，借力化劲疗伤，为自己回复气血、内力。</p><p>·当你处于“阴阳调和”状态时，你还可以让场上同样处于此状态下的队友回复等额的气血，以及共同获得 1 点怒气。</p><p><strong>升级：</strong>回复气血内力+20，消耗+2。</p>",
                    "automationNote": "自奶自动。队友回复需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "调理阴阳",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst amount = 20 + (lvl - 1) * 20;\nawait actor.applyHealing({amount: amount, type: 'hp', showScrolling: true});\nawait actor.applyHealing({amount: amount, type: 'mp', showScrolling: true});\n\nconst hasTiaohe = actor.effects.some(e => e.name === \"阴阳调和\");\nif (hasTiaohe) {\n    ui.notifications.info(\"阴阳调和触发：请让队友回复等额气血并获得1怒气。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "颠倒阴阳",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，双刀蕴含阴阳劲力，对目标造成伤害。</p><p>·当你处于“阴阳调和”状态时，招式可以改为消耗你的蓄力动作和 3 米内处于“阴阳调和”状态队友的反应动作共同释放此招，你和该队友共同支付怒气，对敌方目标造成 1.0 力量点外功伤害（招式依旧由你释放，使用你的命中暴击），然后再为目标添加“阴阳逆乱”，持续两回合。</p><p><strong>阴阳逆乱：</strong>招式伤害-20，同时无法获得怒气。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "合击伤害自动，消耗队友资源手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "合击判断",
                            "trigger": "attack",
                            "script": "const hasTiaohe = actor.effects.some(e => e.name === \"阴阳调和\");\nif (hasTiaohe) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"颠倒阴阳\" },\n        content: `<p>是否与队友发动合击？</p><p>倍率提升至 1.0，并施加 [阴阳逆乱]。</p>`,\n        yes: { label: \"合击\", icon: \"fas fa-check\" },\n        no: { label: \"普通\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        // 合击模式：增加倍率差值 (1.0 - 0.8 = 0.2)\n        const bonus = Math.floor(actor.system.stats.liliang.total * 0.2);\n        args.flags.damageResult.damage += bonus;\n        args.flags.damageResult.breakdown += `\\n+ 合击加成: ${bonus}`;\n        // 标记以便 hit 施加状态\n        args.flags.isTeamAttack = true;\n        ui.notifications.info(\"合击发动！请队友手动扣除怒气和反应。\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "阴阳逆乱",
                            "trigger": "hit",
                            "script": "if (args.flags?.isTeamAttack || (args.isHit && args.isManual)) {\n    const eff = thisItem.effects.getName(\"阴阳逆乱\").toObject();\n    eff.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "太阴",
                    "icon": "icons/magic/symbols/yin-yang-white.webp",
                    "description": "标记状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "taiyin",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "太阳",
                    "icon": "icons/magic/symbols/sun-yellow.webp",
                    "description": "标记状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "taiyang",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "阴阳调和",
                    "icon": "icons/magic/light/beam-rays-orange-purple.webp",
                    "description": "浑身四象流转，强化两仪招式。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinyangtiaohe",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "阴阳逆乱",
                    "icon": "icons/magic/control/debuff-energy-hold-levitate-yellow.webp",
                    "description": "伤害-20，无法获得怒气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinyangniluan",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.global.mod",
                            "mode": 2,
                            "value": "-20"
                        },
                        {
                            "key": "flags.xjzl-system.noRecoverRage",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "狭路刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>团练所用刀法，狭路相逢勇者胜，以气势压人。</p><p><strong>类型：</strong>刀</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀",
            "moves": [
                {
                    "name": "横劈竖砍",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，刀势刚猛，对目标造成伤害。</p><p>若目标无架招，可使目标陷入“下盘不稳”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "不骄不躁",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，跨步斜刀，开启架招。成功格挡时，可进入“狭路”状态，持续到战斗脱离或被击破架招。</p><p><strong>狭路：</strong>获得 5 点内外功防御。</p><p><strong>升级：</strong>格挡值+10，狭路防御+5，消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获狭路",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"狭路\").toObject();\n// 动态计算防御 (5 + (Lv-1)*5)\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst defBonus = 5 + (lvl - 1) * 5;\n\neff.changes[0].value = String(defBonus);\neff.changes[1].value = String(defBonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "狭路相逢",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，勇往直前，拖刀冲锋至 5 米范围内的一个目标面前，对其造成伤害。若你和目标的三米范围内没有其他人，双方进行决斗：投掷一个 d20 比拼大小。</p><p>决斗失败者流失 50 点气血；</p><p>决斗获胜者获得 1 点怒气。</p><p>你一往无前，将自己的决斗投掷结果+1。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，决斗投掷结果+2，内力消耗+4。</p>",
                    "automationNote": "决斗判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "决斗提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 1 + (lvl - 1) * 2;\nui.notifications.info(`若满足单挑条件，请手动决斗。你的结果 +${bonus}。`);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "狭路",
                    "icon": "icons/magic/defensive/shield-barrier-flaming-diamond-blue.webp",
                    "description": "增加防御。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xialu",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "三板斧",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>传闻混世魔王程咬金入梦时，一名神仙教了他一套绝世斧法，他仅学会第三招时便被人喊醒，未能学全。但他凭借这三板斧，已经横扫隋唐英雄。</p><p><strong>需求：</strong>刀-斧钺</p><p><strong>属性：</strong>刚</p>",
            "requirements": "刀-斧钺",
            "moves": [
                {
                    "name": "劈脑袋",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，斧头从上往下砍，对目标造成伤害。</p><p>若目标格挡成功，则可消耗反应动作释放【鬼剔牙】。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "后续连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "鬼剔牙",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>主要动作，献斧纂，攻击对方面部，对目标造成伤害，击破架招时，使其陷入“禁实”，持续三回合。</p><p>·当你因【劈脑袋】而消耗反应动作释放此招时，此招虚招值+1。</p><p>·若目标看破成功，无论他是否释放反击，你都可以不消耗动作，立即释放【掏耳朵】，若目标反击，因此释放的【掏耳朵】与目标反击同时结算。</p><p><strong>升级：</strong>招式伤害+10，反应释放虚招值+1，内力消耗+2。</p>",
                    "automationNote": "击破禁实自动。后续连招手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破禁实",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"jinshi\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "掏耳朵",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，回身横扫，对周围目标造成伤害。</p><p>·若目标没有反应动作，该招式必定暴击。</p><p>·当你因【鬼剔牙】而不消耗动作释放此招时，该招式变为单体攻击，且招式伤害提升 50 点伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "必暴与连招加伤需在弹窗手动设置。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "胡家刀诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>招数精奇，不以力碰力。有阴有阳，刚柔并济。</p><p><strong>需求：</strong>刀-单刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "八方藏刀",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，缓缓行刀，开启架招。格挡成功后，获得一层“绵劲”，至多三层，持续到战斗脱离。</p><p><strong>绵劲：</strong>每层使你的柔属性武学招式伤害+5。</p><p><strong>升级：</strong>格挡值+10，消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获绵劲",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"绵劲\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "怀中揽月",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，以刀缠敌，对目标造成伤害，击破架招时，你每消耗 1 层绵劲，使目标流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+10，每层流失气血+5，消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "绵劲流失",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const mianjin = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"mianjin\");\n    if (mianjin) {\n        const stacks = mianjin.getFlag(\"xjzl-system\", \"stacks\") || 1;\n        await mianjin.delete();\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const bleed = (5 + (lvl - 1) * 5) * stacks;\n        await args.target.applyDamage({\n            amount: bleed,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n        ui.notifications.info(`消耗 ${stacks} 层绵劲，造成 ${bleed} 点流失。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "闭门挥刀",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，刚猛刀劲，对目标造成伤害。若击中无架招敌人时，获得 1 层“刚劲”，至多三层，持续到战斗脱离。</p><p><strong>刚劲：</strong>每层使你的刚属性武学招式伤害+5。</p><p><strong>升级：</strong>招式伤害+10，消耗+2。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获刚劲",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"刚劲\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "燕子翻身",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，转刀换手，选择以下一项：</p><p>·消耗一层“刚劲”，本回合内，将你的“怀中揽月”变为实招，且招式伤害提高 10 点。</p><p>·消耗一层“绵劲”，本回合内，将你的“闭门挥刀”变为虚招，且虚招值+1</p><p><strong>升级：</strong>招式伤害+10，虚招值+1，消耗+2。</p>",
                    "automationNote": "效果及消耗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "云龙九现",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，刀无常形，瞬息临身，对周围 3 个敌人造成伤害，并击飞他们 3 米。</p><p>若你存在“刚劲”，则招式伤害+30；</p><p>若你存在“绵劲”，则此招使目标陷入“错骨”状态，持续三回合。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，消耗+8。</p>",
                    "automationNote": "刚劲加伤自动。绵劲错骨自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "刚劲加伤",
                            "trigger": "calc",
                            "script": "const hasGangjin = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"gangjin\");\nif (hasGangjin) {\n    args.output.damage += 30;\n    args.output.bonusDesc.push(\"刚劲 +30\");\n}",
                            "active": true
                        },
                        {
                            "label": "绵劲错骨",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMianjin = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"mianjin\");\n    if (hasMianjin) {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"cuogu\");\n        if(eff) {\n            const data = foundry.utils.deepClone(eff);\n            data.duration = { rounds: 3 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "绵劲",
                    "icon": "icons/magic/water/water-hand-blue.webp",
                    "description": "柔属性伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "mianjin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.rou.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "刚劲",
                    "icon": "icons/magic/fire/dagger-rune-enchant-flame-strong-orange.webp",
                    "description": "刚属性伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "gangjin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.gang.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "无尘刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>由南宋奇人包梓创出，糅合佛道心平气和，清心寡欲的理念，只有如此方能使出最大威力。全部修炼至合一后，喜怒不形于色，悲欢不溢于面。</p><p><strong>需求：</strong>刀-单刀</p><p><strong>属性：</strong>刚</p><p>注：无尘刀要求清净、放松，没有愤怒。你每有 1 点怒气，你的招式伤害减少 5 点。</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "空明",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>无需消耗任何动作，面色坦然，不愠不怒。开启后，进入“无尘”心境，你获得 8 点怒气，持续到战斗脱离，该气招小憩后恢复。</p><p><strong>无尘：</strong>当你气血归零投掷残疾检定或死亡检定之前，进行一次 D20 的心境检定（难度 16），成功后怒气归零，同时可以消耗反应动作立即释放一次【无法】，然后脱离“无尘”心境。</p><p>·切换套路或内功后移除“无尘”心境，同时自身怒气归零。</p><p><strong>升级：</strong>心境检定难度-2，获得怒气-1，消耗+4。</p>",
                    "automationNote": "濒死检定及触发【无法】手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无尘心境",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"无尘\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);\n\n// 动态获得怒气\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rageGain = 8 - (lvl - 1);\nconst current = actor.system.resources.rage.value;\nconst max = actor.system.resources.rage.max;\nawait actor.update({ \"system.resources.rage.value\": Math.min(max, current + rageGain) });\nui.notifications.info(`进入无尘心境，获得 ${rageGain} 怒气。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无触无声",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，无欲无求，随意防御，开启架招。在架招开启期间，你受伤不会增加怒气。</p><p>·每有 1 点怒气，你的看破值-1。</p><p><strong>升级：</strong>格挡值+10，消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "怒气影响看破",
                            "trigger": "passive",
                            "script": "const rage = actor.system.resources.rage.value || 0;\nactor.system.combat.kanpo -= rage;",
                            "active": true
                        },
                        {
                            "label": "屏蔽受伤回怒",
                            "trigger": "damaged",
                            "script": "if (args.rageGained) {\n    // 系统在 damaged 后已经加了怒气，这里我们把它扣回去\n    const current = actor.system.resources.rage.value;\n    if (current > 0) {\n        await actor.update({ \"system.resources.rage.value\": current - 1 });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无香无味",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>-招式需处于“无尘”心境后方可释放-</p><p>主要动作，挥出淡淡刀气，缓缓袭去，对目标造成伤害，然后自身减少 2 怒气。</p><p>·命中无架招目标时，将目标击飞 2 米。</p><p>·若范围内有敌人处于半空中，可消耗反应动作释放此招，原地旋身劈出淡淡刀气，对目标造成伤害，并减少自己 2 点怒气。</p><p><strong>升级：</strong>招式伤害+10，消耗+4。</p>",
                    "automationNote": "击飞/反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "条件检测与消耗",
                            "trigger": "attack",
                            "script": "const hasWuchen = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuchen\");\nif (!hasWuchen) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"需处于 [无尘] 心境方可释放。\";\n}",
                            "active": true
                        },
                        {
                            "label": "减少怒气",
                            "trigger": "hit",
                            "script": "const current = actor.system.resources.rage.value;\nconst reduce = 2;\nconst newVal = Math.max(0, current - reduce);\nif (newVal !== current) {\n    await actor.update({ \"system.resources.rage.value\": newVal });\n    ui.notifications.info(`怒气减少 ${reduce} 点`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无色",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>-招式需处于“无尘”心境后方可释放-</p><p>当你看破对方虚招时，你可以消耗反应动作释放此招，压制对方虚招，挥出透明之刀，造成伤害，同时自身减少 3 怒气。</p><p>·若目标无架招，给其添加“封招”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "条件检测",
                            "trigger": "attack",
                            "script": "const hasWuchen = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuchen\");\nif (!hasWuchen) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"需处于 [无尘] 心境方可释放。\";\n}",
                            "active": true
                        },
                        {
                            "label": "减少怒气与封招",
                            "trigger": "hit",
                            "script": "// 减怒\nconst current = actor.system.resources.rage.value;\nconst reduce = 3;\nconst newVal = Math.max(0, current - reduce);\nif (newVal !== current) {\n    await actor.update({ \"system.resources.rage.value\": newVal });\n}\n\n// 封招\nif (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无法",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>-招式需“无尘”心境且怒气归零时方可释放-</p><p>蓄力动作，心中空旷澄澈，洞澈灵明，对目标挥出无尘之刀，造成伤害。同时对目标造成等同于对方神采数值的精神伤害。</p><p>·释放此招后，自身怒气增加 8 点。</p><p><strong>升级：</strong>招式伤害+20，增加的怒气-1，消耗+8。</p>",
                    "automationNote": "额外精神伤害自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "条件检测",
                            "trigger": "attack",
                            "script": "const hasWuchen = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuchen\");\nconst rage = actor.system.resources.rage.value || 0;\nif (!hasWuchen || rage > 0) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"需 [无尘] 心境且怒气归零。\";\n}",
                            "active": true
                        },
                        {
                            "label": "增加怒气与精神伤害",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst gain = 8 - (lvl - 1);\nconst current = actor.system.resources.rage.value;\nconst max = actor.system.resources.rage.max;\nawait actor.update({ \"system.resources.rage.value\": Math.min(max, current + gain) });\n\n// 额外精神伤害\nconst shencai = args.target.system.stats.shencai.total || 0;\nif (shencai > 0) {\n    await args.target.applyDamage({\n        amount: shencai,\n        type: \"mental\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true,\n        ignoreBlock: true\n    });\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><div class=\"card-content-wrapper\"><b>无我无道</b><br>造成 ${shencai} 点精神伤害（基于目标神采）。</div></div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "scripts": [
                {
                    "label": "无尘怒气惩罚",
                    "trigger": "calc",
                    "script": "if ([\"real\", \"feint\", \"counter\", \"ultimate\"].includes(args.move.type)) {\n    const rage = actor.system.resources.rage.value || 0;\n    if (rage > 0) {\n        const penalty = rage * 5;\n        args.output.damage -= penalty;\n        args.output.bonusDesc.push(`怒气惩罚 -${penalty}`);\n    }\n}",
                    "active": true
                }
            ],
            "effects": [
                {
                    "name": "无尘",
                    "icon": "icons/magic/light/explosion-star-glow-silhouette.webp",
                    "description": "濒死心境检定。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuchen",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "虎啸奇掌刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>此刀法威力无穷，又偏偏不似刀法。纯以蛮力驭使，却又辅有一套精妙绝伦的拳掌功夫。</p><p><strong>需求：</strong>刀/徒手</p><p><strong>属性：</strong>阳</p>",
            "requirements": "刀；徒手",
            "moves": [
                {
                    "name": "如虎添翼",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，展臂俯身，百穴归一，开启架招。每次格挡成功后，投掷一个 D20，如果大于等于 10，在伤害结算完成后，你恢复 10 点气血。</p><p><strong>升级：</strong>格挡值+10，额外回复 10 气血，消耗+4。</p>",
                    "automationNote": "格挡回血判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡回血提示",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n// 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\nconst heal = 10 + (lvl - 1) * 10;\nui.notifications.info(`格挡成功！请投掷 D20 >= 10，若成功则手动回复 ${heal} 点气血。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "山崩地啸(虎贪)",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，施虎贪拳，劈出霸烈刀气，对直线上至多 2 名敌人造成伤害。同时为他们增加“虎啸”状态，持续到战斗脱离：</p><p><strong>虎啸：</strong>在回合初投掷一个 D20，如果小于等于 10，则封招一回合，并移除“虎啸”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "回合初判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加虎啸",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"虎啸\").toObject();\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "银虎踏岳(虎嗔)",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，施虎嗔拳，刀法随心境凌乱愤怒，对目标造成伤害。</p><p>·本次虚招对抗将进行 3 次，你需要连胜其中的 2 次，方能击破敌方架招。</p><p>若成功击破敌人架招，可将其击退 5 米倒地，并使其陷入眩晕状态，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "特殊对抗规则手动。击破后眩晕自动。击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破眩晕",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"xuanyun\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被击破！请手动击退 5 米并倒地。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "羊入虎口(虎痴)",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招后，可消耗反应动作释放此招，施虎痴拳，旋身劈出刀气轰击敌方，对其造成伤害。</p><p>·同时使周围敌方陷入强烈的颤栗之中，无法自拔，怒气-2。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "完全自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "减少怒气",
                            "trigger": "hit",
                            "script": "const current = args.target.system.resources.rage.value;\nif (current > 0) {\n    const newVal = Math.max(0, current - 2);\n    await args.target.update({ \"system.resources.rage.value\": newVal });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "岁中凶神",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，虎目圆睁，煞气凛然，刀掌交替出招，对周围范围内所有敌人造成伤害。</p><p>·若你处于【魔虎】状态，将周围敌方眩晕一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+16。</p>",
                    "automationNote": "魔虎眩晕自动。进入魔虎状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "魔虎眩晕",
                            "trigger": "hit",
                            "script": "const mohu = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"mohu\");\nif (mohu) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"xuanyun\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "虎啸",
                    "icon": "icons/creatures/mammals/cat-tiger-roar-orange.webp",
                    "description": "回合初判定封招。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huxiao",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "魔虎",
                    "icon": "icons/creatures/mammals/cat-tiger-fanged-glowing-red.webp",
                    "description": "速度翻倍，刀法+徒手，悟性+徒手。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "mohu",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "属性加成",
                                    "trigger": "passive",
                                    "script": "const unarmedRank = actor.system.combat.weaponRanks.unarmed?.total || 0;\nactor.system.combat.weaponRanks.blade.mod += unarmedRank;\nactor.system.stats.wuxing.mod += unarmedRank;",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenMpTurnStart",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "雪饮六诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>旷世刀法，施展时六月飞雪，传闻需配合其他神秘功法方可发挥真正威力。</p><p>注：施展《雪饮六诀》时，心若冰清，攻击无法获得怒气。</p><p><strong>类型：</strong>刀-单刀 <strong>属性：</strong>阴</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "惊雪回眸",
                    "type": "real",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>身跃半空（处于半空中），居高砍下，毫不犹豫，对敌人造成伤害。</p><p>·可消耗一层“冰心”，使攻击距离+3，劈出寒冰气劲，招式改为攻击直线上的所有敌人。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "跳跃、改变距离与AOE范围需手动处理。若需消耗冰心，请手动移除层数。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "冰冻三丈",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀劲缠绕凝结寒冰，开启架招。格挡成功时，获得一层“冰心”，最多十层，持续到战斗脱离。</p><p><strong>冰心：</strong>你的格挡值+5。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "格挡获冰心自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获冰心",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"冰心\").toObject();\nfoundry.utils.setProperty(eff, \"flags.xjzl-system.maxStacks\", 10);\nawait game.xjzl.api.effects.addEffect(actor, eff);"
                        }
                    ]
                },
                {
                    "name": "傲雪红梅",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，若你有反应动作，则必须消耗反应动作施展此招，压制对方虚招，傲立劈刀，冰雪迫人，对敌人造成伤害。</p><p>释放此招时，需进行一次[定力]检定（难度 16），失败则移除自身所有“冰心”。</p><p><strong>升级：</strong>招式伤害+10，难度-1，内力消耗+4。</p>",
                    "automationNote": "命中后提示手动进行定力检定及移除冰心。反应动作手动扣除。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            1,
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "检定提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 16 - (lvl - 1);\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"font-weight:bold;\">傲雪红梅 - 定力检定</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>请进行 <b>[定力]</b> 检定 (DC ${dc})。</p>\n            <p style=\"color:red;\">若失败：请手动移除所有 [冰心] 层数。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});"
                        }
                    ]
                },
                {
                    "name": "否极泰来",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>解除自身架招，不消耗速度朝任意方向移动 1 米，致命一刀，对目标造成伤害。击破目标架招时，自身获得两层“冰心”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "解除架招自动。移动手动。击破获冰心自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "解除架招",
                            "trigger": "attack",
                            "active": true,
                            "script": "if (actor.system.martial.stanceActive) {\n    await actor.stopStance();\n    ui.notifications.info(\"否极泰来：架招已解除，请手动移动。\");\n}"
                        },
                        {
                            "label": "击破获冰心",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"冰心\").toObject();\n    foundry.utils.setProperty(eff, \"flags.xjzl-system.maxStacks\", 10);\n    // 叠加两层\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}"
                        }
                    ]
                },
                {
                    "name": "透骨冷意",
                    "type": "qi",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "全回合动作",
                    "description": "<p>寒意冻结，自身获得“冷心”状态，持续一回合，冷心持续期间，在自身周围 1 米范围释放‘透骨寒意’。</p><p><strong>透骨寒意：</strong>处于区域内的敌人也陷入“冷心”。</p><p>·你的每个回合初需要消耗自身周围【具有“冷心”人数*20】的内力，然后你再获得一回合“冷心”，否则移除你的冷心和透骨寒意，处于区域中的敌人的“冷心”也被移除。</p><p><strong>冷心：</strong>你被寒意冻结，失去所有动作也无法被选中，在你的回合末，你获得一层“冰心”，如果你没有修炼过《雪饮六诀》，改为获得 1 点怒气。</p><p><strong>升级：</strong>透骨寒意范围+1，每回合初维持冷心需要的内力系数-5。</p>",
                    "automationNote": "获得冷心BUFF自动。光环效果、回合并判断内力消耗及续杯均为手动。冷心回合末获益自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            10,
                            14,
                            18,
                            22
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得冷心",
                            "trigger": "hit",
                            "active": true,
                            "script": "const eff = thisItem.effects.getName(\"冷心\").toObject();\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(actor, eff);"
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "踏雪人间",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>以腿御刀，诡异难测。突进到敌人身前，对其造成伤害。</p><p>·如果你《雪饮六诀》全套招式等级相同，则可消耗反应动作释放【惊雪回眸】，且必定命中。</p><p><strong>升级：</strong>招式伤害+20，需求冰心层数-1，消耗+8。</p>",
                    "automationNote": "消耗冰心手动。移动手动。免费追击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "层数检查",
                            "trigger": "attack",
                            "active": true,
                            "script": "const bingxin = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bingxin\");\nconst stacks = bingxin ? (bingxin.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst req = 8 - (lvl - 1);\n\nif (stacks < req) {\n    ui.notifications.warn(`踏雪人间：冰心层数可能不足 (需${req}层，当前${stacks})。请确认。`);\n} else {\n    ui.notifications.info(`踏雪人间：请手动消耗 ${req} 层 [冰心]。`);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "冰心",
                    "icon": "icons/magic/water/snowflake-ice-blue.webp",
                    "description": "每层格挡值+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bingxin",
                            "stackable": true,
                            "maxStacks": 10
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "冷心",
                    "icon": "icons/magic/water/ice-statue-frozen.webp",
                    "description": "失去动作，无法被选中。回合末获得冰心或怒气。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lengxin",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "冷心回合末",
                                    "trigger": "turnEnd",
                                    "active": true,
                                    "script": "const hasManual = actor.items.some(i => i.name === \"雪饮六诀\" && i.type === \"wuxue\");\nif (hasManual) {\n    const eff = thisItem.effects.getName(\"冰心\").toObject();\n    foundry.utils.setProperty(eff, \"flags.xjzl-system.maxStacks\", 10);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"冷心：获得1层 [冰心]\");\n} else {\n    // 获得怒气\n    const current = actor.system.resources.rage.value;\n    const max = actor.system.resources.rage.max;\n    if (current < max) {\n        await actor.update({\"system.resources.rage.value\": current + 1});\n        ui.notifications.info(\"冷心：获得1点怒气\");\n    }\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.stun",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "神雷九刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>霸绝天下的刀法，相传乃仙界雷公所创，以电劲驾驭刀意，刚猛霸道，乃至引动天象，无人能当。</p><p>注：施展此武学，武器必须经历天雷淬炼，蕴含雷霆之力。</p><p><strong>需求：</strong>刀-单刀 <strong>属性：</strong>阳</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "天雷暴掣",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>蹬地登空（处于半空中），双手持刀，引天雷霹雳砍下，造成伤害。</p><p>·此招无法暴击，但若自身存在“雷霆”，则此招必定命中，且施展此招期间无法被选中。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "空中状态手动。无法选中手动。禁暴击自动。雷霆必中自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆必中",
                            "trigger": "attack",
                            "active": true,
                            "script": "const hasThunder = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (hasThunder) {\n    args.flags.forceHit = true;\n    ui.notifications.info(\"天雷暴掣：雷霆引导，必定命中！\");\n}"
                        },
                        {
                            "label": "禁止暴击",
                            "trigger": "preDamage",
                            "active": true,
                            "script": "args.config.isCrit = false;\nargs.config.applyCritDamage = false;"
                        }
                    ]
                },
                {
                    "name": "雷转天地",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>将刀旋转挥舞，卷起阵阵电光，开启架招，同时获得 1 层“雷霆”状态，持续到脱战。</p><p><strong>雷霆：</strong>施展带有雷字的招式，每层使伤害+10。</p><p>·格挡 3 米内的攻击后，可以消耗反应动作解除架招，并对攻击者施展一次【寂雷沉灭】。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "开启获雷霆自动。雷霆增伤自动(所有雷字招式已挂载脚本)。反击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获雷霆",
                            "trigger": "attack",
                            "active": true,
                            "script": "const eff = thisItem.effects.getName(\"雷霆\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);"
                        },
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        }
                    ]
                },
                {
                    "name": "寂雷沉灭",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持刀刹挥，造成伤害，此招式必定命中，击破架招时，刀斩双腿，为其添加一层“斩腿”状态，持续到战斗脱离。</p><p><strong>斩腿：</strong>每层减少 2 点速度，若期间目标速度归 0，则将对方双腿齐齐斩断，血肉横飞。</p><p><strong>升级：</strong>招式伤害+10，额外添加 1 层“斩腿”，内力消耗+4。</p>",
                    "automationNote": "必中自动。雷霆增伤自动。击破施加斩腿自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "必中",
                            "trigger": "attack",
                            "active": true,
                            "script": "args.flags.forceHit = true;"
                        },
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "击破斩腿",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"斩腿\").toObject();\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const stacks = 1 + (lvl - 1);\n    for(let i=0; i<stacks; i++) {\n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    }\n    ui.notifications.info(`${args.target.name} 被斩腿！`);\n}"
                        }
                    ]
                },
                {
                    "name": "霹雳狂雷",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>跃至空中（处于半空中），雷刀离手，化为无数刀光，对目标及周围 1 米敌人造成伤害，并可消耗“雷霆”，每消耗一层，使伤害半径增加 2 米。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "雷霆增伤自动。消耗雷霆增加范围手动。空中状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            9,
                            8,
                            7,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "范围提示",
                            "trigger": "attack",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    ui.notifications.info(\"霹雳狂雷：可手动消耗 [雷霆] 增加范围 (每层+2米)。\");\n}"
                        }
                    ]
                },
                {
                    "name": "九霄神雷",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破对方虚招时，消耗反应施展，压制对手虚招，对目标一口气劈出九击，层层递进，一刀力道大过一刀，每一击造成伤害。</p><p>·若消耗一层“雷霆”状态，则与对手获得等量的怒气。</p><p><strong>升级：</strong>招式伤害+10。内力消耗+4。</p>",
                    "automationNote": "雷霆增伤自动。消耗雷霆获怒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.1
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "消耗提示",
                            "trigger": "attack",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    ui.notifications.info(\"九霄神雷：可手动消耗 1 层 [雷霆] 获得怒气。\");\n}"
                        }
                    ]
                },
                {
                    "name": "雷劈五岳",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>一口气劈出 5 道刀气，击飞周围 3 米内所有敌人 5 米，每击飞 1 人，获得 1 层“雷霆”状态，此招一次最多获得 2 层雷霆。</p><p><strong>升级：</strong>招式范围+1 米，最多获得的“雷霆”状态+1 层，内力消耗+4。</p>",
                    "automationNote": "雷霆增伤自动。击飞手动。获雷霆自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "命中获雷霆",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst limit = 2 + (lvl - 1);\nconst gain = Math.min(args.hitCount, limit);\nif (gain > 0) {\n    const eff = thisItem.effects.getName(\"雷霆\").toObject();\n    for(let i=0; i<gain; i++) {\n        await game.xjzl.api.effects.addEffect(actor, eff);\n    }\n    ui.notifications.info(`雷劈五岳：获得 ${gain} 层 [雷霆]`);\n}"
                        }
                    ]
                },
                {
                    "name": "撕天裂地",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>雷电瞬间爆发，斩碎罢休，对目标造成伤害，若对手无架招，可以消耗 1 层“雷霆”状态，使目标经脉错乱，陷入“封招”一回合。</p><p>若有敌人处于半空中，你可以消耗反应动作释放此招，斩敌于空。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "空中斩敌手动。无架招弹窗询问消耗封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "封招判定",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\n    if (thunder) {\n        const confirm = await foundry.applications.api.DialogV2.confirm({\n            window: { title: \"撕天裂地\" },\n            content: `<p>目标无架招，是否消耗 1 层 [雷霆] 施加 [封招]？</p>`,\n            yes: { label: \"消耗\", icon: \"fas fa-check\" },\n            no: { label: \"不消耗\", icon: \"fas fa-times\" }\n        });\n        if (confirm) {\n            await game.xjzl.api.effects.removeEffect(actor, \"leiting\", 1);\n            await game.xjzl.api.effects.addEffect(args.target, \"fengzhao\");\n            ui.notifications.info(`${args.target.name} 被封招！`);\n        }\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "天雷屠龙",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>挥刀狂舞，震彻九霄，雷鸣闪电，闪现至目标面前雷霆劈斩，造成伤害。</p><p>若击破架招或击中无架招的敌人，则：</p><p>使目标陷入“错骨”状态，持续到战斗脱离。</p><p>若目标已存在“错骨”状态，则使目标陷入“缚身”状态，持续到战斗脱离。</p><p>若目标已存在“错骨”和“缚身”状态，则刀光一抹，雷息电寂，斩飞对手一条手臂，俱寂当中砸起尘土一抔。</p><p>当你被徒手武学的反击攻击时，可以消耗反应动作，压制对手反击并施展此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "雷霆增伤自动。状态递进施加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "状态递进",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && (args.isBroken || !args.target.system.martial.stanceActive)) {\n    const t = args.target;\n    const hasCuogu = t.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"cuogu\");\n    const hasFushen = t.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fushen\");\n\n    if (hasCuogu && hasFushen) {\n        ui.notifications.info(`${t.name} 被斩飞手臂！(剧情效果)`);\n    } else if (hasCuogu) {\n        await game.xjzl.api.effects.toggleStatus(t, \"fushen\", true);\n        ui.notifications.info(`${t.name} 陷入 [缚身]`);\n    } else {\n        await game.xjzl.api.effects.toggleStatus(t, \"cuogu\", true);\n        ui.notifications.info(`${t.name} 陷入 [错骨]`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "天谴雷罚",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>刀如雷龙，毁天灭地，对范围内所有敌方造成伤害，并在范围内产生‘雷电真龙’，持续 1 回合，每消耗 1 层“雷霆”可以使雷龙的存在时间增加 1 回合。</p><p><strong>雷电真龙：</strong>区域内开始回合的敌方角色，投掷 2 枚 D6 骰，根据投掷结果产生效果：</p><p>1/2/3：受到 100 点气血流失；</p><p>4/5/6：陷入禁足、封招状态，持续一回合。</p><p>在雷龙范围内开始回合的友方角色，投掷 2 枚 D6 骰，根据投掷结果产生效果：</p><p>1/2：回复 20 点内力值；</p><p>3/4：移除 1 个状态；</p><p>5/6：攻击有雷霆引导，必然命中，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，怒气-1，内力消耗+16。</p>",
                    "automationNote": "雷霆增伤自动。消耗雷霆延时手动。区域效果及随机判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            10,
                            9,
                            8,
                            7
                        ]
                    },
                    "scripts": [
                        {
                            "label": "雷霆增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const thunder = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiting\");\nif (thunder) {\n    const stacks = thunder.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const bonus = stacks * 10;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`雷霆增伤 +${bonus}`);\n}"
                        },
                        {
                            "label": "区域效果提示",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "ChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"font-weight:bold;\">雷电真龙 (区域效果)</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p><strong>敌方回合开始 (2D6):</strong></p>\n            <ul><li>1-3: 气血流失 100</li><li>4-6: 禁足、封招 (1回合)</li></ul>\n            <p><strong>友方回合开始 (2D6):</strong></p>\n            <ul><li>1-2: 回复 20 内力</li><li>3-4: 移除 1 个状态</li><li>5-6: 攻击必中 (1回合)</li></ul>\n            <hr>\n            <p><i>每消耗1层雷霆，持续时间+1回合。</i></p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "雷霆",
                    "icon": "icons/magic/lightning/bolt-strike-blue.webp",
                    "description": "雷字招式伤害+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "leiting",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "斩腿",
                    "icon": "icons/skills/wounds/injury-leg-bloody.webp",
                    "description": "速度-2。归零断腿。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhantui",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "-2"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "大荒刀谱",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>古之刀谱，皆无记载，不可修，不可查。</p><p><strong>需求：</strong>刀-双刀 <strong>属性：</strong>太极</p>",
            "requirements": "刀-双刀",
            "moves": [
                {
                    "name": "困龙锁地",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>缠刀锁敌，刃划扼喉，对目标造成伤害，并为其添加“扼喉”一回合。</p><p><strong>扼喉：</strong>移动速度降低至 5。</p><p><strong>升级：</strong>招式伤害+10，扼喉持续回合+1，消耗+4。</p>",
                    "automationNote": "命中添加扼喉自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加扼喉",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"扼喉\").toObject();\n    const lvl = Math.max(1, move.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 陷入 [扼喉]`);\n}"
                        }
                    ]
                },
                {
                    "name": "饮虹问路",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀光叠影，散发五色虹光，开启架招。成功格挡时，自身进入“大荒”，持续一回合。</p><p><strong>大荒：</strong>山芜平野，海天茫茫，当你周围 20 米内没有其他友方时，你出招必定命中。</p><p><strong>升级：</strong>格挡值+10，大荒持续回合数+1，消耗+4。</p>",
                    "automationNote": "格挡获大荒自动。大荒孤立必中效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获大荒",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"大荒\").toObject();\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\neff.duration = { rounds: 1 + (lvl - 1) };\nawait game.xjzl.api.effects.addEffect(actor, eff);"
                        }
                    ]
                },
                {
                    "name": "饮血镟锋",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "taiji",
                    "damageType": "liushi",
                    "weaponType": "blade",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "次要动作",
                    "description": "<p>选择一个处于“扼喉”的目标，提刀环首，抽取其 40 点气血或 10 点内力，然后自身回复 40 气血或 10 内力。</p><p>·目标视为流失相应数值的气血或内力。</p><p><strong>升级：</strong>抽取气血+20，抽取内力+10。</p>",
                    "automationNote": "需选中扼喉目标。应用时弹窗选择抽血或抽蓝。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "抽取资源",
                            "trigger": "hit",
                            "active": true,
                            "script": "const hasEhou = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"ehou\");\nif (!hasEhou) return ui.notifications.warn(`${args.target.name} 未处于扼喉状态！`);\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst hpDrain = 40 + (lvl - 1) * 20;\nconst mpDrain = 10 + (lvl - 1) * 10;\n\nconst confirm = await foundry.applications.api.DialogV2.confirm({\n    window: { title: \"饮血镟锋\" },\n    content: `<p>选择抽取类型：</p>`,\n    yes: { label: `气血 (${hpDrain})`, icon: \"fas fa-heart\" },\n    no: { label: `内力 (${mpDrain})`, icon: \"fas fa-bolt\" }\n});\n\nif (confirm) {\n    // 抽血\n    await args.target.applyDamage({ amount: hpDrain, type: \"liushi\", attacker: actor });\n    await actor.applyHealing({ amount: hpDrain, type: \"hp\" });\n} else {\n    // 抽蓝 (模拟扣蓝)\n    await args.target.applyHealing({ amount: -mpDrain, type: \"mp\" });\n    await actor.applyHealing({ amount: mpDrain, type: \"mp\" });\n}"
                        }
                    ]
                },
                {
                    "name": "刀穿魂海",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀化劲气，飞射伤魂，对目标造成伤害。击破架招时，将目标击飞 5 米，同时自身进入“大荒”，持续到战斗脱离。</p><p>·若目标处于“扼喉”，则喉颈歃血，脑颅激荡，额外使其流失 50 点气血。</p><p><strong>升级：</strong>招式伤害+10，气血流失+50，内力消耗+4。</p>",
                    "automationNote": "击破获大荒自动。击飞手动。扼喉额外流失自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获大荒",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"大荒\").toObject();\n    // 持续到脱战\n    delete eff.duration;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}"
                        },
                        {
                            "label": "扼喉额外流失",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const hasEhou = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"ehou\");\n    if (hasEhou) {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const loss = 50 + (lvl - 1) * 50;\n        await args.target.applyDamage({ amount: loss, type: \"liushi\", attacker: actor });\n        ui.notifications.info(\"刀穿魂海：触发扼喉额外流失！\");\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "纵斩山河",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招的时候，你可以用反应动作释放此招，压制对方虚招，引刀冲刺，分刀化影，对其造成伤害。</p><p>·当自身处于“大荒”时，招式伤害翻倍，并使目标陷入“扼喉”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "大荒伤害翻倍自动。大荒添加扼喉自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "大荒增幅",
                            "trigger": "calc",
                            "active": true,
                            "script": "const hasDahuang = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"dahuang\");\nif (hasDahuang) {\n    args.output.damage *= 2;\n    args.output.bonusDesc.push(\"大荒翻倍\");\n}"
                        },
                        {
                            "label": "大荒施加扼喉",
                            "trigger": "hit",
                            "active": true,
                            "script": "const hasDahuang = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"dahuang\");\nif (hasDahuang) {\n    const eff = thisItem.effects.getName(\"扼喉\").toObject();\n    eff.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}"
                        }
                    ]
                },
                {
                    "name": "唯我洪荒",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>挽刃横扫，环击八方，对周围敌人造成伤害，并使他们陷入“扼喉”，持续到战斗脱离。</p><p>命中已陷入“扼喉”的目标时，可不消耗动作对其中一名“扼喉”目标施展一次【饮血镟锋】。</p><p>·当你处于“大荒”状态时，荒流涌动，刀尖劈出真空地带，招式释放距离+7，且每命中一个敌人，你获得 1 点怒气。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+16。</p>",
                    "automationNote": "施加扼喉自动。大荒加攻距手动。大荒回怒自动(hit_once)。免费追击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加扼喉",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"扼喉\").toObject();\n    delete eff.duration; // 战斗脱离\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}"
                        },
                        {
                            "label": "大荒效果提示",
                            "trigger": "attack",
                            "active": true,
                            "script": "const hasDahuang = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"dahuang\");\nif (hasDahuang) {\n    ui.notifications.info(\"唯我洪荒：大荒生效，请手动增加距离+7米。\");\n}"
                        },
                        {
                            "label": "大荒回怒",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "const hasDahuang = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"dahuang\");\nif (hasDahuang && args.hitCount > 0) {\n    const current = actor.system.resources.rage.value;\n    const max = actor.system.resources.rage.max;\n    const gain = args.hitCount;\n    const newVal = Math.min(max, current + gain);\n    if (newVal > current) {\n        await actor.update({\"system.resources.rage.value\": newVal});\n        ui.notifications.info(`唯我洪荒：大荒回怒 +${gain}`);\n    }\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "扼喉",
                    "icon": "icons/skills/wounds/injury-neck-blood-red.webp",
                    "description": "移动速度降低至5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "ehou",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 5,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "大荒",
                    "icon": "icons/environment/wilderness/terrain-desert-sand-dunes.webp",
                    "description": "孤立无援时必中。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "dahuang",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "孤立必中提示",
                                    "trigger": "attack",
                                    "active": true,
                                    "script": "ui.notifications.info(\"大荒：若周围20米无友方，则必定命中。请手动在弹窗中勾选【必中】。\");"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]