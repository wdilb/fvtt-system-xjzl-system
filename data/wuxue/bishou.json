[
    {
        "name": "琢玉刺法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>巧匠手艺超凡，将刻玉的技法，化作璀璨的刀芒。</p><p><strong>需求：</strong>匕首</p><p><strong>属性：</strong>刚</p>",
            "requirements": "匕首",
            "moves": [
                {
                    "name": "解玉剖丝",
                    "type": "qi",
                    "actionType": "default",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>观察目标，寻其弱点，为目标添加“解玉”，持续三个回合。</p><p><strong>解玉：</strong>格挡值-10（最低 0）。</p><p><strong>升级:</strong>解玉额外减少格挡值 5 点，内力消耗+1。</p>",
                    "automationNote": "施加解玉自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加解玉",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst penalty = -10 - (lvl - 1) * 5;\n\n// 获取Item内的AE模板\nconst eff = thisItem.effects.getName(\"解玉\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 动态修改数值\neff.changes[0].value = String(penalty);\n\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "韵玉穿云",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刻刀泛光，刺其要害，对目标造成伤害。</p><p>·每有 1 级[制宝]，招式暴击骰-1。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "制宝降低暴击阈值自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "制宝暴击修正",
                            "trigger": "attack",
                            "script": "const artLevel = actor.system.arts?.zhibao?.total || 0;\nif (artLevel > 0) {\n    // 暴击骰-1 等于 阈值+1 (更容易暴击)\n    args.flags.critThresholdMod += artLevel;\n    args.flags.damageResult.breakdown += `\\n+ 制宝(${artLevel}) 暴击骰优化`;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "玉影翩跹",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>把玩刻刀，翻跃指尖，开启架招。</p><p>格挡成功后，自身获得一层“乘风”，至多三层。</p><p><strong>乘风：</strong>速度+1。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获乘风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-乘风",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst eff = thisItem.effects.getName(\"乘风\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "玉铸奇器",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "全回合动作",
                    "description": "<p>为目标打造独特精致的首饰，目标获得“玉铸”，持续到战斗脱离。</p><p><strong>玉铸：</strong>选择自己喜爱的珠宝首饰并获得相应加成：</p><ul><li><strong>玛瑙：</strong>每回合初回复 10 点气血。</li><li><strong>绿松石：</strong>每回合初回复 10 点内力。</li><li><strong>蜜蜡：</strong>内外功防御提升 10 点。</li><li><strong>青金石：</strong>招式伤害+10 点。</li></ul><p><strong>升级：</strong>怒气消耗-1。</p>",
                    "automationNote": "消耗银两手动。效果选择需从物品栏拖拽对应BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "操作提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请手动扣除100两白银。请打开【琢玉刺法】物品详情，将对应的宝石BUFF拖拽给目标。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "解玉",
                    "icon": "icons/tools/scribal/magnifying-glass.webp",
                    "description": "格挡值降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jieyu_debuff",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                },
                {
                    "name": "乘风",
                    "icon": "icons/magic/air/wind-weather-snow-gusts.webp",
                    "description": "速度增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chengfeng_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "玉铸-玛瑙",
                    "icon": "icons/commodities/gems/gem-faceted-square-red.webp",
                    "description": "回合初回血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuzhu_manao"
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnStart",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "玉铸-绿松石",
                    "icon": "icons/commodities/gems/gem-faceted-square-teal.webp",
                    "description": "回合初回蓝。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuzhu_lvsongshi"
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenMpTurnStart",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "玉铸-蜜蜡",
                    "icon": "icons/commodities/gems/gem-rough-cushion-yellow.webp",
                    "description": "防御提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuzhu_mila"
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "玉铸-青金石",
                    "icon": "icons/commodities/gems/gem-faceted-square-blue.webp",
                    "description": "招式伤害提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuzhu_qingjinshi"
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "乘风刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>来无影，风无息，轻盈无比，灵活自如。</p><p><strong>需求：</strong>匕首</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首",
            "moves": [
                {
                    "name": "风乘万里",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>身影虚晃，飘忽不定，对目标造成伤害，击破架招时给自己添加一层“乘风”状态，最多叠加三层，持续到脱战。</p><p><strong>乘风：</strong>每层使你的速度+1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破获乘风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-乘风",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"乘风\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(attacker, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "云湿纱窗",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>轻抚匕首，开启架招。格挡成功时回复 5 点内力，同时获得一层“乘风”，持续到脱战。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡回蓝、获乘风自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡效果",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 回复内力\nawait actor.applyHealing({ amount: 5, type: \"mp\", showScrolling: true });\n\n// 获得乘风\nconst eff = thisItem.effects.getName(\"乘风\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "红花落尽",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>高空一跃而下（处于半空中），对目标造成伤害，若击中无架招目标，每层乘风使招式伤害+5。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "空中状态手动。命中无架招乘风加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "乘风加伤",
                            "trigger": "preDamage",
                            "script": "if (!args.outcome.isHit) return;\n// 检查目标是否有架招\nif (!args.target.system.martial.stanceActive) {\n    const buff = attacker.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chengfeng_buff\");\n    const stacks = buff ? (buff.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n    if (stacks > 0) {\n        const bonus = stacks * 5;\n        args.config.amount += bonus;\n        ui.notifications.info(`红花落尽：乘风(${stacks}) 加伤 ${bonus}`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "乘风而起",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>身影重重，你每消耗三层“乘风”，获得一层“轻灵”，至多三层，持续到战斗脱离。</p><p><strong>轻灵：</strong>每层使你的闪避+5。</p><p><strong>升级：</strong>消耗的乘风层数-1，内力消耗+1。</p>",
                    "automationNote": "消耗乘风获轻灵自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "转化轻灵",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst costPerLayer = Math.max(1, 3 - (lvl - 1));\n\nconst buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chengfeng_buff\");\nconst currentStacks = buff ? (buff.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\nif (currentStacks >= costPerLayer) {\n    // 计算可转化层数\n    const layersToGain = Math.floor(currentStacks / costPerLayer);\n    const costTotal = layersToGain * costPerLayer;\n\n    // 消耗乘风\n    await game.xjzl.api.effects.removeEffect(actor, \"chengfeng_buff\", costTotal);\n\n    // 获得轻灵\n    const qinglingEff = thisItem.effects.getName(\"轻灵\").toObject();\n    delete qinglingEff._id;\n    qinglingEff.origin = thisItem.uuid;\n    \n    for(let i=0; i<layersToGain; i++) {\n        await game.xjzl.api.effects.addEffect(actor, qinglingEff);\n    }\n    \n    ui.notifications.info(`消耗 ${costTotal} 层乘风，获得 ${layersToGain} 层轻灵。`);\n} else {\n    ui.notifications.warn(`乘风层数不足 (需要 ${costPerLayer})`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "乘风",
                    "icon": "icons/magic/air/wind-weather-snow-gusts.webp",
                    "description": "速度增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chengfeng_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "轻灵",
                    "icon": "icons/magic/movement/trail-streak-white.webp",
                    "description": "闪避增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingling_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "金刚锥",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>虽为匕首手法，却比起棍棒都要刚猛凶狠，江湖之上人人闻之色变。</p><p><strong>需求：</strong>匕首</p><p><strong>属性：</strong>刚</p>",
            "requirements": "匕首",
            "moves": [
                {
                    "name": "金刚护体",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>金刚现匕，开启架招。格挡成功时，可以在该回合末回复 1 点气血。</p><p><strong>升级：</strong>格挡值+5，气血回复额外+1，消耗+1。</p>",
                    "automationNote": "格挡添加回合末回血BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-回血BUFF",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst healAmt = 1 + (lvl - 1);\n\nconst eff = thisItem.effects.getName(\"金刚回复\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.changes[0].value = String(healAmt);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "金刚铁壁",
                    "type": "qi",
                    "actionType": "default",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>受到伤害时，可消耗反应动作释放，瞬舞蓄劲，将本次受到伤害（扣除格挡和防御）的 10%记为“反劲值”，持续到战斗脱离。</p><p><strong>反劲值：</strong>下一次施展《金刚锥》时，招式伤害提升反劲值的数值。</p><p><strong>升级：</strong>反劲值占受伤害的比例增加 10%，消耗+1。</p>",
                    "automationNote": "反劲值计算与记录需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请根据受到的伤害计算反劲值，并手动添加到下一次攻击的伤害修正中。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "断钢洞石",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>猛击目标胸膛，造成伤害，击中无架招敌人时，目标下回合初流失 10 点气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招施加流血BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加流血",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"断钢内伤\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "暴裂无声",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>手持匕首猛击对手肩膀，造成伤害。将匕首击入对方身体内（你失去匕首武器），敌人必须使用主要动作拔出身体中的匕首，否则一直处于“错骨”状态。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "施加错骨自动。移除武器装备、敌人拔刀逻辑需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加错骨",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"cuogu\");\n    ui.notifications.warn(\"匕首已击入敌体，请手动移除装备。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "金刚回复",
                    "icon": "icons/magic/life/cross-yellow-green.webp",
                    "description": "回合末回复气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "jingang_heal",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "断钢内伤",
                    "icon": "icons/skills/wounds/injury-impact-orange.webp",
                    "description": "回合初流失气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "duangang_bleed",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnStart",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "针剪飞舞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>以剪刀和针线为武器的独特武学，锋利而灵巧。</p><p><strong>需求：</strong>匕首/暗器-针</p><p><strong>属性：</strong>柔</p>",
            "requirements": "匕首；暗器-针",
            "moves": [
                {
                    "name": "飞针织锦",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "needle",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>穿针引线，开启架招，并获得一层“飞针”，至多一层，持续到战斗脱离或被击破架招。</p><p><strong>飞针：</strong>受伤时每层对攻击者造成 10 点气血流失。</p><p><strong>升级：</strong>格挡值+5，飞针叠加上限+1，内力消耗+1。</p>",
                    "automationNote": "开启架招获飞针自动。飞针反伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得飞针",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"飞针\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst maxStacks = 1 + (lvl - 1);\neff.flags[\"xjzl-system\"].maxStacks = maxStacks;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "剪花跃影",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一跃而起（处于半空中），落在目标周围空格，刃尖猛刺对其造成伤害，击破架招时为其添加一层“流血”，持续到脱战。</p><p>·每有 3 级[成衣]，额外添加一层流血。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "空中状态手动。击破施加流血自动(含成衣加成)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-流血",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const chengyi = actor.system.arts?.chengyi?.total || 0;\n    const extraStacks = Math.floor(chengyi / 3);\n    const totalStacks = 1 + extraStacks;\n\n    const bleedEff = CONFIG.statusEffects.find(e => e.id === \"bleed_stack\");\n    if (bleedEff) {\n        for(let i=0; i<totalStacks; i++) {\n            await game.xjzl.api.effects.addEffect(args.target, bleedEff);\n        }\n        ui.notifications.info(`${args.target.name} 受到 ${totalStacks} 层流血 (成衣加成 ${extraStacks})`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一剪断空",
                    "type": "real",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>持刀割向目标造成伤害。每有一层“飞针”，此招式释放距离+1。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "距离加成无法自动，请留意飞针层数。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "针锋相对",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "weaponSubtype": "needle",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放，压制目标虚招，射出针线，刺入其体内，对其造成伤害。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "基础反击。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "裁云剪水",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>来回快速割裂，对目标造成伤害，并为其添加一层“流血”，持续到脱战。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "命中施加流血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加流血",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"bleed_stack\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "飞针",
                    "icon": "icons/skills/ranged/arrows-flying-salvo-blue.webp",
                    "description": "受伤时反弹气血流失。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "feizhen_buff",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "飞针反伤",
                                    "trigger": "damaged",
                                    "script": "if (args.attacker && args.attacker.uuid !== actor.uuid && !args.attacker.isReceivingReflection) {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const dmg = stacks * 10;\n    args.attacker.isReceivingReflection = true;\n    try {\n        await args.attacker.applyDamage({\n            amount: dmg,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n        ui.notifications.info(`飞针反弹: ${dmg} 流失`);\n    } finally {\n        args.attacker.isReceivingReflection = false;\n    }\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "撩阴刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>专攻下三路的卑鄙武学，为武林人士不齿。</p><p><strong>需求：</strong>匕首-单刺</p><p><strong>属性：</strong>阴</p>",
            "requirements": "匕首-单刺",
            "moves": [
                {
                    "name": "偷梁换柱",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刺其大腿，造成伤害。击中无架招目标使其下盘不稳，持续一回合。</p><p>若目标已经处于“下盘不稳”，则将其击倒。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招施加下盘不稳自动。若已有则施加倒地自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳/倒地",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const hasUnstable = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"unstable\");\n    \n    if (hasUnstable) {\n        // 击倒\n        await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n        ui.notifications.info(`${args.target.name} 被击倒！`);\n    } else {\n        // 下盘不稳\n        await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "凝息聚意",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>缩刺待敌，开启架招。获得“阴损”状态，持续到战斗脱离或解除架招。</p><p><strong>阴损：</strong>你从背后攻击目标时，伤害增加 4 点。</p><p><strong>升级：</strong>格挡值+5，阴损伤害+3，内力消耗+1。</p>",
                    "automationNote": "开启架招获阴损自动。背击加伤需在出招时手动修正数值。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得阴损",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"阴损\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 4 + (lvl - 1) * 3;\neff.description = `背击伤害 +${bonus}。`;\n// 系统暂无背击检测，仅作标记\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "钻裆越人",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作，压制对方虚招，钻过对手裤裆攻击目标身后，造成伤害，使目标下盘不稳，持续一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中施加下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "断子绝孙",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>攻击目标命根，造成伤害。若此次攻击使目标陷入濒死，则其残疾检定前需要投掷一个[韧性]检定（难度 13），失败则残疾检定结果必然为 80。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "残疾检定逻辑复杂，请人工判定。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "阴损",
                    "icon": "icons/skills/wounds/injury-face-impact-orange.webp",
                    "description": "背击伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinsun_buff",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "翰林笔法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>《书法正传》所载，以笔法口诀融入武道。所谓笔无定势，境由心生，练笔如做人，人正则笔正。</p><p>·翰林笔法招式伤害提高你[书写]等级*2 数值。</p><p><strong>需求：</strong>匕首-笔</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-笔",
            "moves": [
                {
                    "name": "字正如人",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>三指执笔，腕掌皆平，开启架招。格挡成功时获得“笔势”，至多三层，持续到脱战。</p><p><strong>笔势：</strong>每层使笔法命中+10。持续到你更换其他武器的武学套路。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获笔势自动。全局被动加伤需在每个招式预览时处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-笔势",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"笔势\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "横如臂展",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>左低右高，横一笔对目标造成伤害。本次出招前可以先进行一次[书写]检定，若结果大于等于 15，招式暴击骰-1。</p><p><strong>升级:</strong>招式伤害+5，暴击骰再-1，内力消耗+1。</p>",
                    "automationNote": "书写加伤自动。检定降低暴击阈值自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "书写加伤",
                            "trigger": "calc",
                            "script": "const skill = actor.system.arts?.shuxie?.total || 0;\nargs.output.damage += skill * 2;",
                            "active": true
                        },
                        {
                            "label": "书写检定",
                            "trigger": "attack",
                            "script": "const roll = await actor.rollAttributeTest(\"shuxie\", { skipDialog: true });\nif (roll.total >= 15) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = 1 + (lvl - 1);\n    args.flags.critThresholdMod += bonus;\n    ui.notifications.info(`书写检定成功，暴击阈值 -${bonus}`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "撇画如刀",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>出锋锐尖，撇一笔对目标造成伤害。击破架招时，顺势将目标拉扯倒地。</p><p>·若[书写]等级达到 5，招式虚招值+2。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "书写加伤自动。书写加虚招值自动。击破倒地自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "书写加伤/虚招",
                            "trigger": "calc",
                            "script": "const skill = actor.system.arts?.shuxie?.total || 0;\nargs.output.damage += skill * 2;\nif (skill >= 5) args.output.feint += 2;",
                            "active": true
                        },
                        {
                            "label": "击破-倒地",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "竖如身立",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后可消耗反应动作释放，压制对方虚招，中正一笔，对其造成伤害。</p><p>·你可以移除“笔势”，让目标陷入禁足一回合。</p><p><strong>升级：</strong>招式伤害+5。内力消耗+1。</p>",
                    "automationNote": "书写加伤自动。消耗笔势禁足手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "书写加伤",
                            "trigger": "calc",
                            "script": "const skill = actor.system.arts?.shuxie?.total || 0;\nargs.output.damage += skill * 2;",
                            "active": true
                        },
                        {
                            "label": "可选效果",
                            "trigger": "hit",
                            "script": "const hasBishi = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bishi_buff\");\nif (hasBishi) {\n    ui.notifications.info(\"可选：手动消耗 [笔势] 以施加 [禁足] 1回合。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "长捺如足",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>胯膝腕连，一波三折，捺一笔对目标造成伤害。若本次战斗施展过本套路前四个招式，则本招式伤害提升 20 点。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "书写加伤自动。连招检测无法自动，请手动修正伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "书写加伤",
                            "trigger": "calc",
                            "script": "const skill = actor.system.arts?.shuxie?.total || 0;\nargs.output.damage += skill * 2;",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "笔势",
                    "icon": "icons/skills/melee/strike-polearm-light-white.webp",
                    "description": "笔法命中增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bishi_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "百笔绘",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>-人间百态，尽在笔下-</p><p>注：每有一级[作画]，招式命中提升 1 点。</p><p><strong>需求：</strong>匕首-笔</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-笔",
            "moves": [
                {
                    "name": "锥划沙",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>横于前，纵于后，不结不滞，如锥划沙，开启架招。当你成功格挡后，在攻击者脸上画上一笔，使攻击者陷入“目盲”状态一回合。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "作画加命中自动。格挡施加目盲自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "作画加成",
                            "trigger": "attack",
                            "script": "const skill = actor.system.arts?.zuohua?.total || 0;\nargs.flags.bonusHit += skill;",
                            "active": true
                        },
                        {
                            "label": "格挡-目盲",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    await game.xjzl.api.effects.addEffect(args.attacker, \"blind\");\n    ui.notifications.info(`${args.attacker.name} 被施加目盲！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "折钗股",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，消耗反应动作施展，压制对方虚招，光滑圆润，圆转有力，转折自如，并对其造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "作画加命中自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shencai",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "作画加成",
                            "trigger": "attack",
                            "script": "const skill = actor.system.arts?.zuohua?.total || 0;\nargs.flags.bonusHit += skill;",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "屋漏痕",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>积点成线，不漂不浮，形似渗透，沉稳有力，造成伤害。</p><p>当你被对方反击压制后，以星点墨痕渗透目标，为其添加一层“愚钝”，至多三层，持续到脱战。</p><p><strong>愚钝：</strong>每层使你虚招对抗-1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "作画加命中自动。被反击施加愚钝需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shencai",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "作画加成",
                            "trigger": "attack",
                            "script": "const skill = actor.system.arts?.zuohua?.total || 0;\nargs.flags.bonusHit += skill;",
                            "active": true
                        },
                        {
                            "label": "被反击提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"若此招式被对方反击，请手动为对方施加 [愚钝]。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "山坠石",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>重笔一点，力透纸背，入木三分，造成伤害。</p><p>若有敌人处于 3 米范围内的半空中，你可以消耗反应动作释放此招，原地甩墨伤敌，同时击落目标。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "作画加命中自动。击落手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shencai",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "作画加成",
                            "trigger": "attack",
                            "script": "const skill = actor.system.arts?.zuohua?.total || 0;\nargs.flags.bonusHit += skill;",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "川归海",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>纵笔如百川归海，变中有变，对周围敌人造成伤害，同时将所有敌人击退 1 米。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "作画加命中自动。击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shencai",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "作画加成",
                            "trigger": "attack",
                            "script": "const skill = actor.system.arts?.zuohua?.total || 0;\nargs.flags.bonusHit += skill;",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "愚钝",
                    "icon": "icons/skills/wounds/injury-head-brain-blue.webp",
                    "description": "虚招对抗降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yudun",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "纨绔笔法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>依着世家荫官上进的子弟，酒囊饭袋，附庸风雅，不识四书五经六义，可笑可笑。</p><p><strong>需求：</strong>匕首-笔</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-笔",
            "moves": [
                {
                    "name": "胸无点墨",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>大愚若智，开启架招。格挡成功时获得一层“唾骂”，至多三层，持续到战斗脱离或解除架招。</p><p><strong>唾骂：</strong>每层使他人攻击你时暴击骰-1。</p><p><strong>升级:</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡获唾骂自动。唾骂降低敌方暴击效果需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-唾骂",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"唾骂\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "出口成脏",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>口不择言，抓笔倒插，对目标造成伤害。</p><p>·招式造成伤害后，可移除一层“唾骂”，让自身和对方怒气+1。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "消耗唾骂回怒逻辑需手动确认，点击脚本提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "交互效果",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"tuoma_buff\");\n    if (buff) {\n        ui.notifications.info(\"可选：手动消耗1层[唾骂]，双方怒气+1。\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "才疏学浅",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>拽白错字，不知所谓，笔点目标造成伤害。击破架招时，使目标陷入“错乱”，持续一回合。</p><p><strong>错乱：</strong>自己的每个回合末，朝 D4 随机方向不消耗速度走出一步，然后倒地。</p><p>·可移除一层“唾骂”，让错乱持续回合+3。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破施加错乱自动。消耗唾骂延长持续需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-错乱",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"cuoluan\");\n    \n    const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"tuoma_buff\");\n    if (buff) ui.notifications.info(\"可选：手动消耗[唾骂]延长错乱时间。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "绝世草包",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>愚鲁无用，但自信满满，你每消耗一层唾骂，可使目标流失 10 点气血。若消耗三层，自身还会进入“普信”状态，持续到战斗脱离。</p><p><strong>普信：</strong>你的虚招对抗检定失败时，视作成功，然后移除“普信”。</p><p><strong>升级:</strong>每层唾骂流失的气血+5，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "消耗唾骂造成流失手动。施加普信手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const loss = 10 + (lvl - 1) * 5;\n    ui.notifications.info(`请根据消耗的[唾骂]层数，手动对目标应用流失 (每层 ${loss})，若消耗3层则手动添加 [普信]。`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "唾骂",
                    "icon": "icons/magic/sonic/scream-wail-shout-teal.webp",
                    "description": "使攻击者暴击骰-1 (更难暴击)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tuoma_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "黄泉令",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>左道入门武学，不伤敌，只强身。</p><p><strong>需求：</strong>匕首-尺</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-尺",
            "moves": [
                {
                    "name": "气血生",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>气运丹田，开启架招。格挡成功后回复 10 点气血，同时获得一层“黄泉气”，持续到战斗脱离。</p><p><strong>黄泉气：</strong>每层使你格挡值+1。</p><p><strong>升级：</strong>格挡值+5，回复生命值+10，内力消耗+10。</p>",
                    "automationNote": "格挡回血、获黄泉气自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡效果",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst healAmt = 10 + (lvl - 1) * 10;\nawait actor.applyHealing({ amount: healAmt, type: \"hp\", showScrolling: true });\n\nconst eff = thisItem.effects.getName(\"黄泉气\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "内劲起",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>飞出令牌后飞回，以自身气血化为疗伤劲力输送给其他友方目标，为其回复 10 点气血、5 内力。</p><p><strong>升级：</strong>气血消耗+10，回复气血+10、内力+5。</p>",
                    "automationNote": "治疗气血自动。回复内力需手动。消耗气血手动。",
                    "calculation": {
                        "base": 10,
                        "growth": 10
                    },
                    "costs": {
                        "hp": [
                            10,
                            20,
                            30
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗与内力",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst hpCost = 10 + (lvl - 1) * 10;\nconst mpHeal = 5 + (lvl - 1) * 5;\n\nawait actor.applyHealing({ amount: -hpCost, type: \"hp\", showScrolling: true });\nui.notifications.info(`已消耗 ${hpCost} 气血。请手动为目标回复 ${mpHeal} 内力。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "黄泉护身",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>消耗一层黄泉气，令牌贴身，给周围 3 米范围内所有友方添加一层“护身”，至多三层，持续到脱战。</p><p><strong>护身：</strong>每层使你内外功防御 5 点。</p><p><strong>升级：</strong>额外增加一层，内力消耗+2。</p>",
                    "automationNote": "消耗黄泉气自动。施加护身自动（需选中目标）。升级效果（额外层）自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "群体护身",
                            "trigger": "hit",
                            "script": "if (args.isBuff) {\n    // 消耗\n    await game.xjzl.api.effects.removeEffect(actor, \"huangquanqi_buff\", 1);\n\n    // 计算层数\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const stacksToAdd = 1 + (lvl - 1);\n\n    const eff = thisItem.effects.getName(\"护身\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n\n    for(let i=0; i<stacksToAdd; i++) {\n        await game.xjzl.api.effects.addEffect(args.target, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "生死一念",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当范围内有其他友方陷入濒死时，可以消耗反应动作释放此招，黄泉不死，挽救其魂，你每消耗一层黄泉气，目标立即回复其气血上限 10%的气血。</p><p><strong>升级：</strong>怒气消耗-1。</p>",
                    "automationNote": "消耗黄泉气回复需手动执行。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请手动消耗 [黄泉气] 并为目标回复对应百分比气血。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "黄泉气",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "格挡值增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huangquanqi_buff",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "护身",
                    "icon": "icons/magic/defensive/shield-barrier-blue.webp",
                    "description": "防御增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "hushen_buff",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "刺客列传",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>古之刺客，舍生取义者也。自曹沫至荆轲五人，此其义或成或不成，然其立意较然，不欺其志，名垂后世，岂妄也哉!</p><p><strong>需求：</strong>匕首</p><p><strong>属性：</strong>刚</p>",
            "requirements": "匕首",
            "moves": [
                {
                    "name": "彗星袭月",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一往无前，舍生忘死！对敌人造成伤害。</p><p>·若自身存在“鱼肠”，可消耗“鱼肠”，使招式伤害+10。（和鱼肠提升的招式伤害叠加）</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "鱼肠被动加伤自动。出招询问消耗鱼肠额外加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗鱼肠",
                            "trigger": "attack",
                            "script": "const yuchang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yuchang_buff\");\nif (yuchang) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"彗星袭月\" },\n        content: `<p>是否消耗 [鱼肠] 使伤害额外+10？</p>`,\n        yes: { label: \"消耗\", icon: \"fas fa-check\" },\n        no: { label: \"不消耗\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await yuchang.delete();\n        args.flags.damageResult.damage += 10;\n        args.flags.damageResult.breakdown += \"\\n+ 消耗鱼肠 (+10)\";\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "曹沫劫盟",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>突进到目标身旁的空格，执匕劫持，并对其造成伤害。</p><p>·若虚招对抗失败，且自身存在“鱼肠”，可消耗“鱼肠”，使本招式无法被压制。</p><p><strong>升级:</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "鱼肠被动加伤自动。对抗失败后消耗效果需手动判定执行（强制命中/生效）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "鱼肠藏剑",
                    "type": "qi",
                    "actionType": "default",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>不动声色，藏匕于袖，自身获得“鱼肠”状态，持续到战斗脱离或施展其他套路。</p><p><strong>鱼肠：</strong>《刺客列传》招式伤害+5 点，自身内外功防御提高 5 点。</p><p><strong>升级:</strong>提供的伤害和防御增加 5 点，内力消耗+1。</p>",
                    "automationNote": "获鱼肠自动。鱼肠防御加成自动。伤害加成需在各招式中检测。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得鱼肠",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst bonus = 5 + (lvl - 1) * 5;\n\nconst eff = thisItem.effects.getName(\"鱼肠\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.description = `防御+${bonus}。刺客列传招式伤害+${bonus}。`;\neff.changes[0].value = String(bonus);\neff.changes[1].value = String(bonus);\neff.flags[\"xjzl-system\"].cikeBonus = bonus;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "以衣代首",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>以披风覆盖全身，开启架招。被击破架招的瞬间，受到伤害之前，使自身获得“鱼肠”状态，持续到战斗脱离或施展其他套路。</p><p><strong>升级:</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "鱼肠被动加伤自动。击破获鱼肠自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "鱼肠加伤",
                            "trigger": "attack",
                            "script": "const yuchang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yuchang_buff\");\nif (yuchang) {\n    const bonus = yuchang.getFlag(\"xjzl-system\", \"cikeBonus\") || 0;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 鱼肠加成 (+${bonus})`;\n}",
                            "active": true
                        },
                        {
                            "label": "击破-鱼肠",
                            "trigger": "preTake",
                            "script": "if (args.isBroken && args.attacker) {\n    // 动态查找鱼肠藏剑等级\n    const qiMove = thisItem.system.moves.find(m => m.name === \"鱼肠藏剑\");\n    const lvl = Math.max(1, qiMove?.computedLevel || 1);\n    const bonus = 5 + (lvl - 1) * 5;\n    \n    const eff = thisItem.effects.getName(\"鱼肠\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    eff.description = `防御+${bonus}。刺客列传招式伤害+${bonus}。`;\n    eff.changes[0].value = String(bonus);\n    eff.changes[1].value = String(bonus);\n    eff.flags[\"xjzl-system\"].cikeBonus = bonus;\n    \n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "荆轲刺秦",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>-风萧萧兮易水寒，壮士一去兮不复还！-</p><p>匹夫一怒，血溅五步！须发怒张，拔匕而出！将自身气血值变为 1 点，进入“匕现”状态，持续到战斗脱离。</p><p><strong>匕现：</strong>匕首武学暴击骰-3 且招式伤害+10。</p><p><strong>升级:</strong>暴击骰再-1，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "鱼肠被动加伤自动。气血变1自动。匕现效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "鱼肠加伤",
                            "trigger": "attack",
                            "script": "const yuchang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yuchang_buff\");\nif (yuchang) {\n    const bonus = yuchang.getFlag(\"xjzl-system\", \"cikeBonus\") || 0;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 鱼肠加成 (+${bonus})`;\n}",
                            "active": true
                        },
                        {
                            "label": "应用效果",
                            "trigger": "hit",
                            "script": "// 气血变1\nawait actor.update({ \"system.resources.hp.value\": 1 });\nui.notifications.warn(`${actor.name} 气血已降至 1 点！`);\n\n// 匕现BUFF\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst critBonus = 3 + (lvl - 1);\n\nconst eff = thisItem.effects.getName(\"匕现\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.description = `匕首暴击阈值+${critBonus}，伤害+10。`;\neff.flags[\"xjzl-system\"].critBonus = critBonus;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "鱼肠",
                    "icon": "icons/weapons/daggers/dagger-straight-blue.webp",
                    "description": "防御提升，本套路伤害提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuchang_buff",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "匕现",
                    "icon": "icons/weapons/daggers/dagger-ritual-engraved-gold.webp",
                    "description": "匕首暴击阈值增加，伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bixian_buff",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ],
            "system": {
                "scripts": [
                    {
                        "label": "匕现全局加成",
                        "trigger": "calc",
                        "script": "if (args.item.system.weaponType === \"dagger\") {\n    const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bixian_buff\");\n    if (buff) {\n        args.output.damage += 10;\n        args.output.bonusDesc.push(\"匕现 +10\");\n    }\n}",
                        "active": true
                    },
                    {
                        "label": "匕现暴击修正",
                        "trigger": "attack",
                        "script": "if (args.item.system.weaponType === \"dagger\") {\n    const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"bixian_buff\");\n    if (buff) {\n        const bonus = buff.getFlag(\"xjzl-system\", \"critBonus\") || 3;\n        args.flags.critThresholdMod += bonus;\n    }\n}",
                        "active": true
                    }
                ]
            }
        }
    },
    {
        "name": "蛊仙环",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>暗藏蛊毒的尖刺双环，不小心使用会划到自己。</p><p><strong>类型：</strong>匕首-双刺</p><p><strong>属性：</strong>刚</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "蛊上月",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>毒蛊覆环，开启架招。格挡成功后，进入“毒环”状态，持续到战斗脱离。</p><p><strong>毒环：</strong>下一次出招造成 5 点毒素伤害。</p><p><strong>升级：</strong>格挡值+5，毒素伤害+5，内力消耗+1。</p>",
                    "automationNote": "格挡获毒环自动。毒环加伤消耗自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-毒环",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst poisonDmg = 5 + (lvl - 1) * 5;\n\nconst eff = thisItem.effects.getName(\"毒环\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.description = `下一次出招造成 ${poisonDmg} 毒素伤害。`;\neff.flags[\"xjzl-system\"].poison = poisonDmg;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛊环月",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>挥环而出，对目标造成伤害。</p><p>·若自身处于“毒环”，双环飞舞周身，改为对周围敌人造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "毒环范围改变需手动选目标。毒环加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗毒环",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duhuan_buff\");\nif (buff) {\n    const bonus = buff.getFlag(\"xjzl-system\", \"poison\") || 0;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 毒环伤害 (+${bonus})`;\n    await buff.delete();\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛊擒月",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，环刃倒悬，对其造成伤害。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "毒环加伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗毒环",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duhuan_buff\");\nif (buff) {\n    const bonus = buff.getFlag(\"xjzl-system\", \"poison\") || 0;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 毒环伤害 (+${bonus})`;\n    await buff.delete();\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛊隐月",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>暗发双环，对目标造成伤害。击破架招时，将目标击倒，并使其陷入“下盘不稳”，持续一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "毒环加伤自动。击破倒地、下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗毒环",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duhuan_buff\");\nif (buff) {\n    const bonus = buff.getFlag(\"xjzl-system\", \"poison\") || 0;\n    args.flags.damageResult.damage += bonus;\n    args.flags.damageResult.breakdown += `\\n+ 毒环伤害 (+${bonus})`;\n    await buff.delete();\n}",
                            "active": true
                        },
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛊蚀月",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>青红蛊环，飞射而出，绞杀目标造成伤害。</p><p>若自身处于“毒环”，额外造成 10 点毒素伤害。</p><p><strong>升级：</strong>招式伤害+10，毒素伤害额外增加 5 点，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "毒环加伤自动。毒环额外伤害自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗毒环",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duhuan_buff\");\nif (buff) {\n    const bonus = buff.getFlag(\"xjzl-system\", \"poison\") || 0;\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const extra = 10 + (lvl - 1) * 5;\n    \n    args.flags.damageResult.damage += (bonus + extra);\n    args.flags.damageResult.breakdown += `\\n+ 毒环 (${bonus}) + 额外 (${extra})`;\n    await buff.delete();\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "毒环",
                    "icon": "icons/magic/acid/dissolve-pool-bubbles.webp",
                    "description": "下次出招附加毒素伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "duhuan_buff",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "短叉诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>山西伏虎门传承，如今在铁叉会手中发扬光大。</p><p><strong>需求：</strong>匕首-单刺</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-单刺",
            "moves": [
                {
                    "name": "油盐不进",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>短叉在手中回旋，开启架招。格挡 1 米内的攻击后，划伤对手，使其流失 5 点气血。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "近身格挡反伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反伤",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (!args.attacker || args.attacker.uuid === actor.uuid) return;\n\n// 距离检测\nconst t1 = actor.token?.object || actor.getActiveTokens()[0];\nconst t2 = args.attacker.token?.object || args.attacker.getActiveTokens()[0];\nif (t1 && t2) {\n    const dist = canvas.grid.measurePath([t1.center, t2.center]).distance;\n    if (dist <= 1.1) {\n        // 反伤\n        await args.attacker.applyDamage({ amount: 5, type: \"liushi\", attacker: actor, isHit: true, ignoreDefense: true });\n        ui.notifications.info(\"短叉划伤对手！\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "饿虎扑食",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>一跃而起（半空中），跳至目标身前，短叉猛刺，对目标造成伤害，击中无架招目标时，击退目标 1 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "空中状态手动。击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "飞叉夺命",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>陡然丢出手中短叉，对目标造成伤害，击破架招时，可以消耗次要动作，掏出另一把短叉，并再次施展【飞叉夺命】，飞掷攻击同一目标。</p><p>·你丢出的武器视作脱手，掉落在目标周围随机空格。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破后再次攻击手动。武器脱手手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "脱手提示",
                            "trigger": "hit",
                            "script": "ui.notifications.warn(\"短叉已投掷脱手，请手动移除装备。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "莽夫一怒",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>将短叉刺入自己大腿，流失 50 点气血，剧痛之下，气力倍增，向前扑去，一头撞向目标胸膛。对目标造成伤害。并与目标进行一次[韧性]对抗，失败的角色，陷入“错骨”三回合。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "自伤自动。韧性对抗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "自伤",
                            "trigger": "attack",
                            "script": "await actor.applyHealing({ amount: -50, type: \"hp\", showScrolling: true });",
                            "active": true
                        },
                        {
                            "label": "对抗提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请与目标进行 [韧性] 对抗。若目标失败，手动添加 [错骨] (3回合)。\");",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "宫女刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>宫中侍女所习练的武学，虽然主要为表演性质，但经由武林人士删改后，仍有不俗的战斗力。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>柔</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "西施捧心",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>美人捧心，开启架招。格挡成功后，若目标的神采低于 15 点，则为美人身姿倾倒，失去反应动作。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡判定自动。失去反应动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "神采判定",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst shencai = args.attacker?.system?.stats?.shencai?.total || 0;\nif (shencai < 15) {\n    ui.notifications.info(`${args.attacker.name} 神采(${shencai})过低，为美人倾倒，失去反应动作。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "昭君出塞",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刺齐出，欲向前，又欲回，对目标造成伤害，若击中无架招目标，使目标流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招流失气血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "流失气血",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await args.target.applyHealing({amount: -5, type: \"hp\", showScrolling: true});\n    ui.notifications.info(`${args.target.name} 流失 5 点气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "花容闭月",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，双刺向内，欲拒还迎，压制目标虚招，对目标造成伤害。使目标脚步不稳，陷入“下盘不稳”，持续一回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "梨花带雨",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刺如雨点般刺出，似美人垂泪，对目标造成伤害。同时与目标进行一个神采对抗，若你胜出，则目标心生怜惜，下回合无法选中你为攻击目标。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "神采对抗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "对抗提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    ui.notifications.info(\"请手动与目标进行 [神采] 对抗。\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "超然扇",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>画圣曾励志创下的天级武学，可惜尚未写完便身死道消，后人补完，仅成地阶功法。</p><p><strong>需求：</strong>匕首-扇</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-扇",
            "moves": [
                {
                    "name": "春水城花",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>折扇飞舞，以一画三，两道虚影翩飞，在周身回旋，开启架招。格挡成功后，随机移除攻击者身上的一种状态。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "移除状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示移除",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(`格挡成功！请手动移除 ${args.attacker.name} 的一个状态。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "烟雨千家",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "2目标",
                    "actionCost": "蓄力动作",
                    "description": "<p>扇风游荡，对 5 米内两个目标造成伤害，若击中无架招目标，目标下回合无法获得状态。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "禁状态BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加禁状态",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"禁状态\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "新火新茶",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>由下而上卷起一阵旋风，吹乱目标身形，对其造成伤害，若击破架招，使对方脱离战斗后再加入，且先攻顺序调至末位。</p><p>·若在你的攻击范围内有敌人施展气招，可消耗反应对其释放此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "战斗顺序调整手动。反应施展手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示调整先攻",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招：请GM手动将目标移出战斗并重新加入，调整至末位。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "诗酒年华",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你开启【春水城花】且格挡成功时，可使用反应动作施展此招，三扇合一，减少受到伤害的 20%，然后解除架招状态。</p><p><strong>升级：</strong>额外减伤 20%，内力消耗+4。</p>",
                    "automationNote": "手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "禁状态",
                    "icon": "icons/svg/cancel.svg",
                    "description": "无法获得状态。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "jin_zhuangtai",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "夺魄刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>引起江湖血雨的噬血刺法，招招行险，以自身精血代替内力施展，越战越勇，夺人夺命，威力惊人。</p><p><strong>需求：</strong>匕首-单刺</p><p><strong>属性：</strong>阳</p>",
            "requirements": "匕首-单刺",
            "moves": [
                {
                    "name": "群魔乱舞",
                    "type": "real",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>挥斩削肉，造成伤害。若造成暴击，给其添加“缚身”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，气血消耗+5。</p>",
                    "automationNote": "缚身自动。夺魄免耗自动(脚本补回)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "hp": [
                            5,
                            10,
                            15
                        ]
                    },
                    "scripts": [
                        {
                            "label": "夺魄补回气血",
                            "trigger": "attack",
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duopo\")) {\n    const cost = move.currentCost.hp;\n    if (cost > 0) {\n        await actor.applyHealing({amount: cost, type: \"hp\", showScrolling: false});\n        ui.notifications.info(\"夺魄：免疫气血消耗\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "暴击缚身",
                            "trigger": "hit",
                            "script": "if (args.isCrit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"fushen\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "魍魉勾魄",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>身如鬼魅，隐刺对敌人造成伤害，击破架招时，将目标击倒。</p><p>·若自身怒气大于 5 点，施展不消耗气血，还可将目标击飞 1 米。</p><p><strong>升级：</strong>招式伤害+10，气血消耗+5。</p>",
                    "automationNote": "击倒自动。怒气判定免耗(补回)自动。击飞提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "hp": [
                            5,
                            10,
                            15
                        ]
                    },
                    "scripts": [
                        {
                            "label": "怒气判定免耗",
                            "trigger": "attack",
                            "script": "const rage = actor.system.resources.rage.value;\nconst hasDuopo = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duopo\");\nif (rage > 5 || hasDuopo) {\n    const cost = move.currentCost.hp;\n    if (cost > 0) {\n        await actor.applyHealing({amount: cost, type: \"hp\", showScrolling: false});\n        ui.notifications.info(\"怒气/夺魄：免疫气血消耗\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "效果结算",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n}\nconst rage = actor.system.resources.rage.value;\nif (rage > 5) {\n    ui.notifications.info(`${args.target.name} 被击飞 1 米`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "邪灭八方",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>邪气环绕，开启架招。格挡成功时，你给攻击目标添加“邪灭”，持续三回合。</p><p><strong>邪灭：</strong>受到他人攻击时，对方暴击骰-1。</p><p><strong>升级：</strong>格挡值+10，暴击骰再-1，气血消耗+5。</p>",
                    "automationNote": "施加邪灭自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "hp": [
                            5,
                            10,
                            15
                        ]
                    },
                    "scripts": [
                        {
                            "label": "夺魄免耗",
                            "trigger": "attack",
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duopo\")) {\n    const cost = move.currentCost.hp;\n    await actor.applyHealing({amount: cost, type: \"hp\", showScrolling: false});\n    ui.notifications.info(\"夺魄：免疫气血消耗\");\n}",
                            "active": true
                        },
                        {
                            "label": "格挡施加邪灭",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"邪灭\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const val = -1 + (lvl - 1) * -1;\n    eff.changes[0].value = String(val);\n    await game.xjzl.api.effects.addEffect(args.attacker, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "摄魂血雨",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>勾魂异术，将自身怒气转换成气血，每 1 点怒气回复气血上限 10%的气血。</p><p><strong>升级：</strong>可以额外消耗 1 怒气。</p>",
                    "automationNote": "自动转化怒气回复气血。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "怒气转化",
                            "trigger": "hit",
                            "script": "const currentRage = actor.system.resources.rage.value;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst maxExtra = lvl - 1;\nlet extra = 0;\nif (maxExtra > 0 && currentRage > 0) {\n    extra = Math.min(currentRage, maxExtra);\n    await actor.update({\"system.resources.rage.value\": currentRage - extra});\n}\nconst totalConsumed = 1 + extra;\nconst heal = Math.floor(actor.system.resources.hp.max * 0.1 * totalConsumed);\nawait actor.applyHealing({amount: heal, type: \"hp\", showScrolling: true});\nui.notifications.info(`消耗 ${totalConsumed} 怒气，回复气血`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "邪灵破脑",
                    "type": "qi",
                    "actionType": "default",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>催逼内力转换为 3 点怒气。</p><p>·此招获得的怒气在消耗掉之前无法再次获得。施展《夺魄刺》以外的武学时，这些怒气消散。</p><p><strong>升级：</strong>获得怒气+1。</p>",
                    "automationNote": "内力转怒气自动。怒气限制玩家自觉。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "内力转怒气",
                            "trigger": "hit",
                            "script": "const maxMp = actor.system.resources.mp.max;\nconst cost = Math.floor(maxMp * 0.5);\nif (actor.system.resources.mp.value < cost) {\n    return ui.notifications.warn(\"内力不足 50%\");\n}\nawait actor.update({\"system.resources.mp.value\": actor.system.resources.mp.value - cost});\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst gain = 3 + (lvl - 1);\nconst curRage = actor.system.resources.rage.value;\nconst maxRage = actor.system.resources.rage.max;\nawait actor.update({\"system.resources.rage.value\": Math.min(maxRage, curRage + gain)});\nui.notifications.info(`消耗 ${cost} 内力，获得 ${gain} 怒气`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "降世邪魔",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>血祭邪魔，获得“夺魄”。</p><p><strong>夺魄：</strong>内外功防御+5，施展《夺魄刺》时不消耗气血，持续三回合。</p><p><strong>升级：</strong>防御额外+5，持续回合+1，怒气消耗-1。</p>",
                    "automationNote": "夺魄BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得夺魄",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"夺魄\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst def = 5 + (lvl - 1) * 5;\nconst dur = 3 + (lvl - 1);\neff.changes[0].value = String(def);\neff.changes[1].value = String(def);\neff.duration = {rounds: dur};\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "邪灭",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "受到他人攻击时，对方暴击骰-1。",
                    "transfer": false,
                    "duration": {
                        "rounds": 3
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiemie",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.critThresholdMod",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                },
                {
                    "name": "夺魄",
                    "icon": "icons/magic/unholy/silhouette-evil-horned-giant.webp",
                    "description": "内外功防御增加，夺魄刺招式免耗气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "duopo",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "0"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "乾坤尺法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>秉天下之正义，断世间之不平。</p><p><strong>需求：</strong>匕首-尺</p><p><strong>属性：</strong>阳</p>",
            "requirements": "匕首-尺",
            "moves": [
                {
                    "name": "尺定乾坤",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>尺暗藏袖，开启架招。格挡成功后，在周围 5 米范围创造‘乾坤气场’，持续两回合。</p><p><strong>乾坤气场：</strong>区域内敌人在他的回合初流失 5 气血。</p><p><strong>升级：</strong>格挡值+10，气血流失+5，内力消耗+2。</p>",
                    "automationNote": "获得气场AE自动。气场对敌效果手动（提供AE说明）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "激活气场",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"乾坤气场\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一尺断空",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>风定尺出，撩击敌人造成伤害。击破架招时，回复自身 20 点气血，并给其添加“下盘不稳”，持续 2 回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破回血、下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await actor.applyHealing({amount: 20, type: \"hp\", showScrolling: true});\n    await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "得寸进尺",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>步步紧逼，抽击目标造成伤害。</p><p>·若目标处于‘乾坤气场’，额外流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+10，流失气血+5，内力消耗+2。</p>",
                    "automationNote": "气场额外流失需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气场流失提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bleed = 5 + (lvl - 1) * 5;\n    ui.notifications.info(`若目标在乾坤气场内，请手动使其流失 ${bleed} 气血。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "咫尺天涯",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破目标虚招时，可消耗反应动作释放此招，压制虚招，伸尺拉拽目标至身前空格，并将其击倒，同时对其造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击倒自动。拉拽手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击倒",
                            "trigger": "hit",
                            "script": "await game.xjzl.api.effects.addEffect(args.target, \"prone\");\nui.notifications.info(\"目标被击倒。请手动拉拽。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "百尺竿头",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>短尺转舞，气劲参差，对周围敌人造成伤害。</p><p>·若你处于‘乾坤气场’，击退所有敌人 1 米。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气场击退提示",
                            "trigger": "hit",
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qiankunqichang\")) {\n    ui.notifications.info(\"气场生效：请手动击退目标 1 米。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "乾坤气场",
                    "icon": "icons/magic/light/explosion-star-glow-orange.webp",
                    "description": "5米内敌人回合初流失气血。",
                    "transfer": false,
                    "duration": {
                        "rounds": 2
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "qiankunqichang",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "囚徒刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>麻木于汉人流离失所、生离死别后感悟出的刺法。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "寒鸦送晚",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刺飞出，由上而下落击敌人，造成伤害。击中无架招敌人可以获得一层“离恨”，持续到战斗脱离。</p><p>·此招可以代替《趁虚而入》攻击。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中无架招获离恨自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得离恨",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"离恨\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "银丝离愁",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刺合而为一，刺至敌人胸膛前又一分为二，封堵闪避。造成伤害，此招无法闪避，击破架招时获得一层“离恨”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "必中自动。击破获离恨自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "必中",
                            "trigger": "attack",
                            "script": "args.flags.forceHit = true;",
                            "active": true
                        },
                        {
                            "label": "击破获离恨",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"离恨\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "断肠收泪",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，同时针刺自己周身大穴，使自己下一次招式伤害+10 点，并获得两层“离恨”。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "获离恨自动。下一次增伤手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获离恨",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"离恨\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"下一次招式伤害+10，请手动修正。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "人间白头",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>将离恨转化为等额点怒气，或把怒气转化为等额层数离恨，至多一层或一点。</p><p><strong>升级：</strong>转化上限+1。</p>",
                    "automationNote": "弹窗选择转化方向和数量。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "转化逻辑",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst maxTrans = 1 + (lvl - 1);\n\nconst content = `<div class=\"form-group\"><label>数量 (最大 ${maxTrans})</label><input type=\"number\" name=\"amount\" value=\"1\" max=\"${maxTrans}\" min=\"1\"></div><div class=\"form-group\"><label>模式</label><select name=\"mode\"><option value=\"L2R\">离恨转怒气</option><option value=\"R2L\">怒气转离恨</option></select></div>`;\n\nawait foundry.applications.api.DialogV2.prompt({\n    window: { title: \"人间白头\" },\n    content: content,\n    ok: {\n        callback: async (event, button) => {\n            const amount = Math.min(parseInt(button.form.elements.amount.value) || 0, maxTrans);\n            const mode = button.form.elements.mode.value;\n            \n            if (amount <= 0) return;\n\n            if (mode === \"L2R\") {\n                await game.xjzl.api.effects.removeEffect(actor, \"lihen\", amount);\n                const cur = actor.system.resources.rage.value;\n                const max = actor.system.resources.rage.max;\n                await actor.update({\"system.resources.rage.value\": Math.min(max, cur + amount)});\n            } else {\n                const cur = actor.system.resources.rage.value;\n                if (cur < amount) return ui.notifications.warn(\"怒气不足\");\n                await actor.update({\"system.resources.rage.value\": cur - amount});\n                const eff = thisItem.effects.getName(\"离恨\").toObject();\n                delete eff._id; eff.origin = thisItem.uuid;\n                for(let i=0; i<amount; i++) await game.xjzl.api.effects.addEffect(actor, eff);\n            }\n        }\n    }\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "人入囚笼",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>造成伤害。每有一层“离恨”便获得一层“蓄劲”，至多三层，持续到战斗脱离。</p><p><strong>蓄劲：</strong>每层使你暴击骰-1。</p><p>·你可以消耗 6 层离恨，改为消耗反应动作施展此招。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获蓄劲自动。反应动作施展手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得蓄劲",
                            "trigger": "hit",
                            "script": "const lihen = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"lihen\");\nconst stacks = lihen ? (lihen.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nconst gain = Math.min(3, stacks);\n\nif (gain > 0) {\n    const eff = thisItem.effects.getName(\"蓄劲\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    for(let i=0; i<gain; i++) {\n        await game.xjzl.api.effects.addEffect(actor, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "离恨",
                    "icon": "icons/magic/unholy/projectile-spear-glow-pink.webp",
                    "description": "计数标记。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lihen",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "蓄劲",
                    "icon": "icons/skills/melee/strike-dagger-blood-red.webp",
                    "description": "暴击骰-1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xujin_qiutu",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "霓裳羽衣舞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>舞蹈大成之作，源自大唐杨贵妃舞曲，飘逸璀璨，华丽无比，极为神妙。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>柔</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "排云袂",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>排云弄影，双刺飘忽，对周围目标造成伤害。</p><p>·你每有一级[表演]，招式暴击骰-1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "暴击骰加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "表演等级加成",
                            "trigger": "attack",
                            "script": "const lvl = actor.system.arts?.biaoyan?.total || 0;\nif (lvl > 0) args.flags.critThresholdMod = lvl;",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "翩缟衣",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>衣袖飞翔，对目标造成伤害，击破架招时，自身获得“霓裳”，持续到战斗脱离。</p><p><strong>霓裳：</strong>你对神采低于你的目标招式伤害+20。</p><p>·你可以移除霓裳，获得一个主要动作。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获霓裳自动。霓裳增伤自动。移除换动作手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获霓裳",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"霓裳\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "棹青罗",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作使用此招，压制对方虚招，青罗带起，刺旋荡涤目标造成伤害，然后将目标击退 3 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(`${args.target.name} 被击退 3 米`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "流纨素",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>腰流纨素，妙采四方，开启架招，成功格挡后，可获得“羽衣”，持续一回合。</p><p><strong>羽衣：</strong>神采提高 10 点，速度+3。</p><p><strong>升级：</strong>格挡值+10，羽衣回合+1，消耗+2。</p>",
                    "automationNote": "格挡获羽衣自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获羽衣",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"羽衣\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "舞霓裳",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>风舞霓裳动，你进行一个舞蹈的[表演]检定（无需花费一分钟），若成功，则当场生效一个舞谱的效果。</p><p>·然后获得“霓裳”，和“羽衣”，持续三回合。</p><p><strong>升级：</strong>怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获BUFF自动。检定及舞谱手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得状态",
                            "trigger": "hit",
                            "script": "const nishang = thisItem.effects.getName(\"霓裳\").toObject();\ndelete nishang._id; nishang.origin = thisItem.uuid; nishang.duration = {rounds: 3};\nawait game.xjzl.api.effects.addEffect(actor, nishang);\n\nconst yuyi = thisItem.effects.getName(\"羽衣\").toObject();\ndelete yuyi._id; yuyi.origin = thisItem.uuid; yuyi.duration = {rounds: 3};\nawait game.xjzl.api.effects.addEffect(actor, yuyi);\n\nui.notifications.info(\"请手动进行 [表演] 检定\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "霓裳",
                    "icon": "icons/equipment/back/cloak-layered-tattered-purple.webp",
                    "description": "对神采低于自己的目标伤害+20。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "nishang",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "霓裳增伤",
                                    "trigger": "preDamage",
                                    "script": "const tShencai = args.target.system.stats.shencai.total || 0;\nconst sShencai = actor.system.stats.shencai.total || 0;\nif (tShencai < sShencai) {\n    args.config.amount += 20;\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "羽衣",
                    "icon": "icons/equipment/back/cloak-plain-white.webp",
                    "description": "神采+10，速度+3。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuyi",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.stats.shencai.mod",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "3"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "亡吾刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>亡乃古文遗忘之意，此武学以佛门要义为心诀，愈练愈忘却自身，渐至天人合一，物我两忘之境，大成后刺法缭乱，使见之敌人记忆模糊，难以再战。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>阳</p><p><strong>注：</strong>“亡吾”最多叠加 10 层，持续到战斗脱离。<br>·拥有亡吾的角色，每次出招进行一次难度为亡吾层数*2 的[气感]检定，失败则念头舍尽，在本场战斗中，忘却当前使用的武学的记忆，无法施展对应招式。</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "离情恶",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>断情舍恶，对目标造成伤害，若击破架招，则给予对方一层“亡吾”状态，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破施加亡吾自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加亡吾",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"亡吾\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "正智见真",
                    "type": "qi",
                    "actionType": "default",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "随机敌方",
                    "actionCost": "次要动作",
                    "description": "<p>端正心智，固本见真，清除身上所有人、地级的状态。每清除一个状态，给予场上随机一个敌人一层“亡吾”状态，持续到战斗脱离。</p><p><strong>升级：</strong>内力消耗-10。</p>",
                    "automationNote": "手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            70,
                            60,
                            50,
                            40
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "安住一想",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>安住灵台，不被外物所扰，开启架招，格挡成功时，给予对方一层“亡吾”状态，持续到战斗脱离。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "格挡施加亡吾自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡施加",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"亡吾\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "舍念清净",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>舍去杂念，终得清净，对周围敌人造成伤害，若目标具有“亡吾”，则在受到伤害后需进行[气感]检定（难度=亡吾层数*2），失败则陷入“禁绝”状态，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "发起亡吾检定自动。禁绝需在检定失败后手动添加。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "亡吾检定",
                            "trigger": "hit",
                            "script": "const wangwu = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wangwu\");\nif (wangwu) {\n    const stacks = wangwu.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"qigan\",\n        dc: stacks * 2,\n        label: \"亡吾检定\",\n        onFail: \"jinjue\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "亡吾",
                    "icon": "icons/magic/mind/amnesia-blue.webp",
                    "description": "出招需进行气感检定，失败则忘却武学。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wangwu",
                            "stackable": true,
                            "maxStacks": 10,
                            "scripts": [
                                {
                                    "label": "出招检定",
                                    "trigger": "attack",
                                    "script": "const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\nconst dc = stacks * 2;\nui.notifications.info(`${actor.name} 亡吾发作：请进行气感检定 (DC ${dc})，失败则本场忘却此招式。`);",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "天邪刺",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>修炼时需引动心中之魔，恶念之影，招式狠辣，刺影枯骨魔相，蚀人销骨。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>太极</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "魔刺定魂",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双刺贯击其脑，对目标造成伤害，命中无架招目标时，为其添加五层“枯骨”，至多十层，持续到战斗脱离。</p><p><strong>枯骨：</strong>每层使外功防御-5，满十层时陷入禁足。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "枯骨叠加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加枯骨",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"枯骨\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    for(let i=0; i<5; i++) await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "心魔乱影",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>速射飞刺暗影，对目标造成伤害。</p><p>你可以移除目标身上的“枯骨”，每移除一层对目标及周围 5 米敌方造成 10*移除层数的毒素伤害。</p><p><strong>升级：</strong>招式伤害+10，毒素伤害系数+10，消耗+4。</p>",
                    "automationNote": "枯骨爆发伤害自动。AOE伤害需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "枯骨爆发",
                            "trigger": "hit",
                            "script": "const kugu = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\nif (kugu) {\n    const stacks = kugu.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"枯骨爆发\" },\n        content: `目标有 ${stacks} 层枯骨，是否引爆？`,\n        yes: { label: \"引爆\" }\n    });\n    if (confirm) {\n        await kugu.delete();\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const dmg = stacks * (10 + (lvl - 1) * 10);\n        await args.target.applyDamage({amount: dmg, type: \"poison\", attacker: actor, isHit: true, ignoreDefense: true});\n        ui.notifications.info(`爆发造成 ${dmg} 毒伤。AOE需手动处理。`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "心魔妙舞",
                    "type": "qi",
                    "actionType": "default",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "15米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>转刺挥舞，尖音厉啸。范围内的敌方进行一个[定力]检定（难度 15），失败则被添加一层“枯骨”，持续到战斗脱离。</p><p><strong>升级：</strong>难度+2，额外添加一层枯骨，内力消耗+4。</p>",
                    "automationNote": "检定请求自动。枯骨添加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "定力检定",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 15 + (lvl - 1) * 2;\nconst eff = thisItem.effects.getName(\"枯骨\").toObject();\ndelete eff._id; eff.origin = thisItem.uuid;\nconst onFail = [];\nfor(let i=0; i < (1 + (lvl - 1)); i++) onFail.push(eff);\nawait Macros.requestSave({target: args.target, attacker: actor, type: \"dingli\", dc: dc, label: \"定力检定\", onFail: onFail});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "恨分飞恶",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>提刺抱圆，开启架招。格挡成功时，给目标添加一层“枯骨”。</p><p><strong>升级：</strong>格挡值+10，额外添加一层枯骨，消耗+4。</p>",
                    "automationNote": "枯骨添加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡枯骨",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"枯骨\").toObject();\n    delete eff._id; eff.origin = thisItem.uuid;\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    for(let i=0; i < (1 + (lvl - 1)); i++) await game.xjzl.api.effects.addEffect(args.attacker, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "天魔乱舞",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>挥刺乱舞，对周围敌人造成伤害。</p><p>若目标具有五层“枯骨”，将其眩晕一回合。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "眩晕自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "枯骨眩晕",
                            "trigger": "hit",
                            "script": "const kugu = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"kugu\");\nif (kugu && (kugu.getFlag(\"xjzl-system\", \"stacks\") || 1) >= 5) {\n    await game.xjzl.api.effects.addEffect(args.target, \"xuanyun\");\n    ui.notifications.info(`${args.target.name} 被眩晕！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "枯骨",
                    "icon": "icons/magic/death/skull-horned-goat-purple.webp",
                    "description": "每层外防-5，满10层禁足。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "kugu",
                            "stackable": true,
                            "maxStacks": 10,
                            "scripts": [
                                {
                                    "label": "满层禁足",
                                    "trigger": "passive",
                                    "script": "const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\nif (stacks >= 10) {\n    // 满层逻辑较复杂，建议手动施加[禁足]\n    // 这里仅做数值处理，禁足状态需GM手动添加或在此处写死flag修改\n    // 暂留空，依靠说明提示\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "-5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "子母双环",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>一寸短，一寸险，子环刻龙主攻，母环刻凤主守，龙凤合一，天地反覆。</p><p><strong>需求：</strong>匕首-双刺</p><p><strong>属性：</strong>阳</p>",
            "requirements": "匕首-双刺",
            "moves": [
                {
                    "name": "龙翔",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>抛出龙环，势如破竹，环旋飞回，对目标造成伤害，击中无架招目标后，龙环弹射，你可以不消耗动作和内力，立即对目标周围 2 米内另一个敌人施展【龙翔】。</p><p>·如果你拥有“环鸣”状态，则弹射距离+2 米。</p><p>·一个敌人一回合内只能被【龙翔】攻击一次。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "弹射提示自动。免费施展需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "弹射提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const dist = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huanming\") ? 4 : 2;\n    ui.notifications.info(`可免费弹射 ${dist} 米内另一目标。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "凤䎝",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>凤环绕身，密不透风，开启架招。</p><p>格挡成功时，使自己获得“环鸣”状态，持续一回合。</p><p><strong>环鸣：</strong>你的《子母双环》招式距离+2。</p><p><strong>升级：</strong>格挡值+10，持续回合数+1，内力消耗+4。</p>",
                    "automationNote": "格挡获环鸣自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获环鸣",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const eff = thisItem.effects.getName(\"环鸣\").toObject();\n    delete eff._id; eff.origin = thisItem.uuid;\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "龙乘九霄",
                    "type": "qi",
                    "actionType": "default",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "dagger",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>·招式需处于“环鸣”时方能施展。</p><p>龙环低鸣，本回合内你的【龙翔】视为虚招，且若因【龙翔】的弹射目标施展反击压制你的招式，并将要对你造成伤害时，弹射前的敌人代替你受到该次反击伤害。</p><p>·本场战斗中，你每失去一次“环鸣”（持续时间结束或【凤舞九天】主动移除），你获得一层“龙凤吟”，至多两层，持续到战斗脱离。</p><p><strong>龙凤吟：</strong>每层使【龙翔】作为虚招时虚招值+2。</p><p><strong>升级：</strong>龙凤吟层数上限+1，内力消耗+4</p>",
                    "automationNote": "条件检查自动。效果手动。龙凤吟获取手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "条件检查",
                            "trigger": "attack",
                            "script": "if (!actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huanming\")) {\n    ui.notifications.warn(\"未处于环鸣状态\");\n    args.flags.abort = true;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "凤舞九天",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时消耗反应，压制目标虚招，凤环飞舞，对周围敌人造成伤害。</p><p>·你可以选择消耗“环鸣”，移除敌人身上的任意状态，每移除一个，目标流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+10，流失气血+5，消耗+8。</p>",
                    "automationNote": "手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示",
                            "trigger": "hit",
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huanming\")) {\n    ui.notifications.info(\"可选：消耗环鸣移除状态并流失气血。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "扳龙附凤定八方",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "dagger",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>龙凤双环合一，化为数百道金环虚影，遮天蔽日，笼罩一方，对周围敌人造成伤害，使所有敌人陷入“禁足”，持续一回合。</p><p>·若你处于“环鸣”状态，则还使所有敌人陷入“耳鸣”状态，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，禁足耳鸣持续回合+1，消耗+16，怒气消耗-1</p>",
                    "automationNote": "禁足、耳鸣施加自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加状态",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dur = 1 + (lvl - 1);\n\n// 禁足\nconst root = CONFIG.statusEffects.find(e => e.id === \"root\");\nif (root) {\n    const data = foundry.utils.deepClone(root);\n    data.duration = {rounds: dur};\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}\n\n// 耳鸣\nif (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huanming\")) {\n    const deaf = CONFIG.statusEffects.find(e => e.id === \"deaf\");\n    if (deaf) {\n        const data = foundry.utils.deepClone(deaf);\n        data.duration = {rounds: dur};\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 陷入耳鸣`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "环鸣",
                    "icon": "icons/magic/sonic/explosion-shock-wave-teal.webp",
                    "description": "招式距离+2。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huanming",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "龙凤吟",
                    "icon": "icons/creatures/reptiles/dragon-horned-blue.webp",
                    "description": "龙翔作为虚招时虚招值+2。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "longfengyin",
                            "stackable": true,
                            "maxStacks": 2
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]