[
    {
        "name": "罗汉拳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>万佛寺基础套路，七十二绝技之一，上下相随，步随手变，劲力刚柔相济，易学难精。</p>",
            "requirements": "徒手，罗汉堂",
            "automationNote": "完全自动化。刚劲/磐石通过AE叠加实现，迦叶微笑检测AE修改属性。",
            "moves": [
                {
                    "name": "野马追风",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>拳出如风，无羁无束，对敌人造成 0.4 力量点外功伤害。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "黄牛转角",
                    "type": "feint",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>虚以实劲，横肘猛捣，造成 0.3 力量点外功伤害。击破对方架招时，给自己添加一层“刚劲”，至多三层，持续到战斗脱离。</p><p><b>刚劲</b>：每层使你的刚属性武学招式伤害+5。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加刚劲",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effect = thisItem.effects.getName(\"刚劲\");\n    if (effect) {\n        await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n        if (args.move.computedLevel >= 2) await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "弥勒垂眉",
                    "type": "stance",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双臂下摆，低头垂目，开启架招。成功格挡时，给自身添加“磐石”，至多三层，持续到战斗脱离。</p><p><b>磐石</b>：每层增加格挡值 5 点。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡触发磐石",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"磐石\");\n    if (effect) {\n        await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "迦叶微笑",
                    "type": "qi",
                    "actionType": "default",
                    "isUltimate": true,
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>明相不灭，破颜微笑，提升自身真气状态效果，持续三回合。</p><p>自身存在“刚劲”时，《罗汉拳》招式伤害+5。</p><p>自身存在“磐石”时，自身格挡值翻倍。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用迦叶微笑",
                            "trigger": "hit",
                            "script": "const effect = thisItem.effects.getName(\"迦叶微笑\");\nif (effect) await game.xjzl.api.effects.addEffect(args.target, effect.toObject());"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "刚劲",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "每层使你的刚属性武学招式伤害+5。",
                "flags": {
                    "xjzl-system": {
                        "slug": "gangjin",
                        "stackable": true,
                        "maxStacks": 3
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.damages.gang.mod",
                        "mode": 2,
                        "value": "5"
                    }
                ]
            },
            {
                "name": "磐石",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "每层增加格挡值 5 点。",
                "flags": {
                    "xjzl-system": {
                        "slug": "panshi",
                        "stackable": true,
                        "maxStacks": 3
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.block",
                        "mode": 2,
                        "value": "5"
                    }
                ]
            },
            {
                "name": "迦叶微笑",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "强化刚劲与磐石效果。",
                "flags": {
                    "xjzl-system": {
                        "slug": "jiayeweixiao",
                        "scripts": [
                            {
                                "label": "刚劲强化",
                                "trigger": "calc",
                                "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"gangjin\") && move.name.includes(\"罗汉拳\")) {\n    const bonus = 5 + (args.move.computedLevel >= 2 ? 5 : 0);\n    output.damage += bonus;\n    output.bonusDesc.push(`迦叶微笑 +${bonus}`);\n}"
                            },
                            {
                                "label": "磐石强化",
                                "trigger": "passive",
                                "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"panshi\")) {\n    const current = S.combat.block || 0;\n    S.combat.block += current;\n}"
                            }
                        ]
                    }
                },
                "duration": {
                    "rounds": 3
                }
            }
        ]
    },
    {
        "name": "罗汉棍法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>可组成万佛十八罗汉阵，运转之时可困世间高手。</p><p><strong>需求：</strong>棍-长棍，罗汉堂</p><p><strong>属性：</strong>刚</p>",
            "requirements": "棍-长棍；罗汉堂",
            "moves": [
                {
                    "name": "恒河结沙",
                    "type": "qi",
                    "actionType": "default",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>在周身 1 米范围扫起沙尘，持续一回合。沙尘空间内无法视物，陷入“目盲”，沙尘内的角色可以使用【普度四方】替代《趁虚而入》。</p><p><strong>升级：</strong>沙尘的半径范围增加 1 米，内力消耗+1。</p>",
                    "automationNote": "区域与目盲效果需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示效果",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst radius = 1 + (lvl - 1);\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">恒河结沙 - 区域效果</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>已生成沙尘区域，半径 <b>${radius}</b> 米。</p>\n            <p>区域内目标陷入 [目盲] (需手动施加)。</p>\n            <p>区域内可用 [普度四方] 替代 [趁虚而入]。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "罗汉闭目",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>紧闭双眼，细心感受，开启架招，获得“罗汉闭目”，持续一回合。</p><p><strong>罗汉闭目：</strong>你免疫目盲。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "开启架招自动。免疫目盲需手动处理（获得提示状态）。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得状态",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"罗汉闭目\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "普度四方",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>扬棍落击，造成伤害。对方格挡成功时，给对方增加一层“分神”，至多三层，持续到脱战。</p><p><strong>分神：</strong>叠加 3 层后，主动解除架招，然后移除所有分神。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "若目标开启架招且命中，自动施加分神。分神满3层自动解除对方架招。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "分神判定",
                            "trigger": "hit",
                            "script": "// 逻辑：命中 且 对方开启架招 => 视为格挡成功(或至少触发格挡交互)\nif (args.isHit && args.target.system.martial.stanceActive) {\n    // 1. 施加分神\n    const effData = thisItem.effects.getName(\"分神\").toObject();\n    effData.origin = thisItem.uuid;\n    // 添加并获取最新的 Effect 文档\n    const addedEffect = await game.xjzl.api.effects.addEffect(args.target, effData);\n    \n    // 2. 检查层数 (需要重新从 Actor 获取以确保是最新状态)\n    const currentEffect = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fenshen\");\n    const stacks = currentEffect?.getFlag(\"xjzl-system\", \"stacks\") || 0;\n\n    if (stacks >= 3) {\n        ui.notifications.info(`${args.target.name} 分神达到3层，架招被迫解除！`);\n        // 解除架招\n        await args.target.stopStance();\n        // 移除所有分神\n        await game.xjzl.api.effects.removeEffect(args.target, \"fenshen\", 99);\n    } else {\n        ui.notifications.info(`${args.target.name} 格挡受击，分神+1 (当前 ${stacks} 层)`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "罗汉棍阵",
                    "type": "qi",
                    "isUltimate": true,
                    "actionType": "default",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "staff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>快速挥舞长棍，自身获得“罗汉棍阵”状态，持续三回合。</p><p><strong>罗汉棍阵：</strong>你的长棍武器伤害+10 且长棍普通攻击距离+3 米，目标在你周围三米范围内移动时，你都可以对其施展《趁虚而入》。</p><p><strong>升级：</strong>武器伤害再+5，罗汉棍阵持续回合数+1，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "BUFF数值与持续时间完全自动化。趁虚而入效果需玩家手动判断。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6,
                            8
                        ],
                        "rage": [
                            5,
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启棍阵",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 3 + (lvl - 1);\nconst dmgBonus = 10 + (lvl - 1) * 5;\n\nconst eff = thisItem.effects.getName(\"罗汉棍阵\").toObject();\neff.duration = { rounds: rounds };\n// 修改伤害加成\nconst change = eff.changes.find(c => c.key === \"system.combat.damages.weaponTypes.staff.mod\");\nif (change) change.value = String(dmgBonus);\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "罗汉闭目",
                    "icon": "icons/svg/blind.svg",
                    "description": "免疫目盲 (请手动忽略目盲效果)。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "luohanbimu",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "分神",
                    "icon": "icons/svg/daze.svg",
                    "description": "叠加 3 层后，主动解除架招。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fenshen",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                },
                {
                    "name": "罗汉棍阵",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "长棍武器伤害增加。普攻距离+3米。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "luohangunzhen",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.weaponTypes.staff.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "伏魔杖法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>万佛七十二绝技之一，威力刚猛，极为难缠。</p>",
            "requirements": "棍-长棍，罗汉堂",
            "automationNote": "下盘不稳/击倒/击飞效果自动化。位移需手动。",
            "moves": [
                {
                    "name": "佛光普度",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>影疏劲实，对周围范围内敌人造成 0.3 力量点外功伤害。</p><p>命中无架招目标给其添加“下盘不稳”状态，持续两回合。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "金刚伏魔",
                    "type": "stance",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>落棍杵地，开启架招，成功格挡时，给对方添加“下盘不稳”状态，持续一回合。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击下盘不稳",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const rounds = 1 + (args.move.computedLevel >= 2 ? 1 : 0);\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: rounds };\n        await game.xjzl.api.effects.addEffect(args.attacker, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "佛门广渡",
                    "type": "feint",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>臂力灌注，棍端猛击，造成伤害。击破架招时，使目标“下盘不稳”两回合。</p><p>若对方已经处于“下盘不稳”，则将其击倒。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const hasUnstable = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"unstable\");\n    if (hasUnstable) {\n        // 倒地通常不需要改时间，直接传 ID 即可\n        await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    } else {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n        if (eff) {\n            const data = foundry.utils.deepClone(eff);\n            data.duration = { rounds: 2 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万家生佛",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>万棍齐出，棍风震荡，席卷周围敌人，对周围范围内敌人造成 0.6 力量点外功伤害。</p><p>若有目标处于“下盘不稳”或倒地状态，则被击飞至半空中。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const unstable = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"unstable\");\n    const prone = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"prone\");\n    if (unstable || prone) {\n        ui.notifications.info(`${args.target.name} 被击飞至半空！(需手动处理)`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "燃木刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>万佛七十二绝技之一，练成后在一根干木旁快劈九九八十一刀，刀刃不损木材丝毫，刀上发出的热力却可将木材点燃生火，故得此名。</p>",
            "requirements": "刀-单刀，罗汉堂",
            "automationNote": "引燃/刀木效果完全自动化。",
            "moves": [
                {
                    "name": "钻木取火",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀尖速劈，对敌人造成 0.4 力量点内功伤害。</p><p>若目标身上存在“刀木”，为其添加“引燃”，持续到战斗脱离。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "引燃判定",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.effects.find(e => e.name === \"刀木\")) {\n    const effect = thisItem.effects.getName(\"引燃\");\n    if (effect) await game.xjzl.api.effects.addEffect(args.target, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "入木三分",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>厉刃刻划，造成 0.3 力量点内功伤害。击破架招时，给目标添加“刀木”状态，持续到战斗脱离。</p><p><b>刀木</b>：受到刀法招式攻击时，敌人的暴击骰-3。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加刀木",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effect = thisItem.effects.getName(\"刀木\");\n    if (effect) await game.xjzl.api.effects.addEffect(args.target, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "人非草木",
                    "type": "stance",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>抽刀于身，开启架招，成功格挡时，给目标添加“刀木”状态，持续到战斗脱离。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击刀木",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const effect = thisItem.effects.getName(\"刀木\");\n    if (effect) await game.xjzl.api.effects.addEffect(args.attacker, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "风林火山",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀气挥舞，擦出灼气，对目标造成 0.6 力量点内功伤害。</p><p>若目标身上存在“引燃”状态，招式伤害+20。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "引燃增伤",
                            "trigger": "preDamage",
                            "script": "if (args.target && args.target.effects.find(e => e.name === \"引燃\")) {\n    args.config.amount += 20;\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "刀木",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "受到刀法招式攻击时，暴击骰-3（更难暴击）。",
                "flags": {
                    "xjzl-system": {
                        "slug": "daomu",
                        "scripts": [
                            {
                                "label": "降低暴击",
                                "trigger": "check",
                                "script": "if (args.move.weaponType === \"blade\") {\n    args.flags.critThresholdMod -= 3;\n}"
                            }
                        ]
                    }
                }
            },
            {
                "name": "引燃",
                "icon": "icons/svg/fire.svg",
                "description": "被点燃。",
                "flags": {
                    "xjzl-system": {
                        "slug": "ignite"
                    }
                }
            }
        ]
    },
    {
        "name": "大力金刚腿",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>万佛七十二绝技之一，金刚八部功之一，招式简单使用，但凌厉威猛，刚烈无比。</p>",
            "requirements": "徒手-腿，罗汉堂",
            "moves": [
                {
                    "name": "金刚独立",
                    "type": "stance",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>左脚独立，右膝提起，泛出微微金光。开启架招。格挡成功后，自身获得“金刚”，持续一回合。</p><p><b>金刚</b>：你不会被击退、拉扯、击飞。</p><p>升级：格挡值+5，金刚持续回合数+1，消耗+1。</p>",
                    "automationNote": "格挡成功后自动应用“金刚”状态。状态持续时间随等级自动计算(Lv1=1, Lv2=2...)。注意：“金刚”的具体免疫效果（不被击退等）需GM/玩家人工判定。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获得金刚",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"金刚\");\n    if (effect) {\n        const data = effect.toObject();\n        // 升级：金刚持续回合数+1 (Lv1=1, Lv2=2, Lv3=3)\n        data.duration.rounds = args.move.computedLevel;\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "铁劲刚脚",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>猛力抽射，对目标造成 0.4 力量点外功伤害。</p><p>·若目标无架招或处于“下盘不稳”，还可将其击退 1 米，并为其添加“错骨”一回合。</p><p>升级：招式伤害+5，击退距离+1，内力消耗+1。</p>",
                    "automationNote": "伤害计算自动。自动检测目标架招/下盘不稳状态。满足条件时自动应用“错骨”并发送击退距离提示。位移操作需人工处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退与错骨",
                            "trigger": "hit",
                            "script": "const unstable = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"unstable\");\n// 判定条件：目标无架招 OR 目标下盘不稳\nif (args.isHit && (!args.target.system.martial.stanceActive || unstable)) {\n    // 升级：击退距离+1 (Lv1=1, Lv2=2, Lv3=3)\n    const dist = args.move.computedLevel;\n    ui.notifications.info(`${args.target.name} 被击退 ${dist} 米！(需手动处理位移)`);\n    \n    // 添加“错骨” (使用系统通用状态ID)\n    await game.xjzl.api.effects.addEffect(args.target, \"cuogu\");\n}"
                        }
                    ]
                },
                {
                    "name": "罗汉矗根",
                    "type": "feint",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>抬腿下砸，对目标造成 0.3 力量点外功伤害。击破架招时，可消耗反应动作释放【铁劲刚脚】，且击退距离+1。</p><p>升级：招式伤害+5，击退距离+1，内力消耗+1。</p>",
                    "automationNote": "伤害计算自动。击破架招时自动检测并发送连招提示。后续使用的【铁劲刚脚】需玩家手动操作。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破连招提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    // 计算额外击退距离 (此处升级增加的是连招的收益)\n    const extraPush = args.move.computedLevel;\n    ui.notifications.info(`击破架招！可消耗反应动作释放【铁劲刚脚】。本次连招击退距离额外 +${extraPush} (需手动叠加)`);\n}"
                        }
                    ]
                },
                {
                    "name": "夺命金刚",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>-真是天生神力，好一条夺命金刚腿-</p><p>主要动作，奔袭至其身边空格，连环摆腿，踢击目标头部，对其造成 0.5 力量点外功伤害。</p><p>若自身存在“金刚”，招式可将目标直线击退 5 米，若 5 米内撞击到障碍物或其他角色，则额外为该目标和受撞击角色添加“破甲”，持续三回合。</p><p>破甲：你的外功防御归零。</p><p>升级：招式伤害+10，怒气消耗-1，内力消耗+2</p>",
                    "automationNote": "伤害计算自动。自动检测“金刚”状态并提示击退。提供弹窗询问是否发生碰撞，若确认碰撞则自动赋予目标“破甲”（已修正为持续3回合）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "金刚击退与破甲",
                            "trigger": "hit",
                            "script": "if (actor.effects.find(e => e.name === \"金刚\")) {\n    ui.notifications.info(`【金刚】生效：将 ${args.target.name} 击退 5 米！`);\n    \n    // 提示手动处理碰撞\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"碰撞判定\" },\n        content: \"<p>目标在 5 米击退过程中是否撞击到障碍物或其他角色？</p>\",\n        yes: { label: \"是 (应用破甲)\" },\n        no: { label: \"否\" }\n    });\n    \n    if (confirm) {\n        // 获取系统破甲状态并修改持续时间为3回合\n        const pojiaData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"pojia\"));\n        if (pojiaData) {\n            pojiaData.duration = { rounds: 3 };\n            await game.xjzl.api.effects.addEffect(args.target, pojiaData);\n            ui.notifications.info(`${args.target.name} 已应用【破甲】(3回合)。请手动为受撞击角色也添加此状态。`);\n        }\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "金刚",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "你不会被击退、拉扯、击飞。",
                "flags": {
                    "xjzl-system": {
                        "slug": "jingang",
                        "stackable": false
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "达摩剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>达摩祖师面壁时，与易经洗髓一同悟出。以静制动，以气运力，需慈悲胸怀方可展现招式精妙，奇绝变化。</p>",
            "requirements": "剑-双手剑，达摩院",
            "automationNote": "部分自动化。禅心/禅意/禅法状态切换完全自动化，但默认加伤，如果不是佛门内功，请手动减去伤害。",
            "moves": [
                {
                    "name": "惩恶扬善",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>用力啄剑，扬剑向天。对目标敌人造成 0.4 力量点外功伤害。</p><p>若你标签为[侠]，招式暴击骰-1。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "侠义暴击修正",
                            "trigger": "attack",
                            "script": "if (actor.system.social.xiayi >= 100 && actor.system.social.exing <= 50) {\n    args.flags.critThresholdMod += 1;\n}"
                        }
                    ]
                },
                {
                    "name": "侠骨禅心",
                    "type": "qi",
                    "actionType": "default",
                    "damageType": "none",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>剑如禅法，禅入剑式。手捏指诀，进入“禅心”状态，持续到战斗脱离。</p><p><b>禅心</b>：当你运行佛门内功时，招式伤害+5。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得禅心",
                            "trigger": "attack",
                            "script": "const effect = thisItem.effects.getName(\"禅心\");\nif (effect) await game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ]
                },
                {
                    "name": "一切皆空",
                    "type": "feint",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>跺足弓步，剑指要害，对目标造成 0.3 力量点外功伤害。</p><p>若你处于禅心状态，你可以在击破对方架招的场合将禅心替换为“禅意”，持续到战斗脱离。</p><p><b>禅意</b>：当你运行佛门内功时，招式伤害+15。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禅心转禅意",
                            "trigger": "hit",
                            "script": "if (args.isBroken && actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chanxin\")) {\n    await game.xjzl.api.effects.removeEffect(actor, \"chanxin\");\n    const effect = thisItem.effects.getName(\"禅意\");\n    if (effect) await game.xjzl.api.effects.addEffect(actor, effect.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "气贯神锋",
                    "type": "qi",
                    "actionType": "default",
                    "isUltimate": true,
                    "damageType": "none",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>回剑挽花，吐出内气。</p><p>若你处于禅心状态，将禅心替换为“禅意”。</p><p>若你处于禅意状态，将禅变替换为“禅法”。</p><p><b>禅法</b>：当你运行佛门内功时，招式伤害+20。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            3,
                            2,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "状态升级",
                            "trigger": "hit",
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chanxin\")) {\n    await game.xjzl.api.effects.removeEffect(actor, \"chanxin\");\n    const eff = thisItem.effects.getName(\"禅意\");\n    if (eff) await game.xjzl.api.effects.addEffect(actor, eff.toObject());\n} else if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chanyi\")) {\n    await game.xjzl.api.effects.removeEffect(actor, \"chanyi\");\n    const eff = thisItem.effects.getName(\"禅法\");\n    if (eff) await game.xjzl.api.effects.addEffect(actor, eff.toObject());\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "禅心",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛门内功时，招式伤害+5。",
                "flags": {
                    "xjzl-system": {
                        "slug": "chanxin",
                        "scripts": [
                            {
                                "label": "伤害加成",
                                "trigger": "calc",
                                "script": "if (thisItem.system.active) { output.damage += 5; output.bonusDesc.push(\"禅心 +5\"); }"
                            }
                        ]
                    }
                }
            },
            {
                "name": "禅意",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛门内功时，招式伤害+15。",
                "flags": {
                    "xjzl-system": {
                        "slug": "chanyi",
                        "scripts": [
                            {
                                "label": "伤害加成",
                                "trigger": "calc",
                                "script": "if (thisItem.system.active) { output.damage += 15; output.bonusDesc.push(\"禅意 +15\"); }"
                            }
                        ]
                    }
                }
            },
            {
                "name": "禅法",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛门内功时，招式伤害+20。",
                "flags": {
                    "xjzl-system": {
                        "slug": "chanfa",
                        "scripts": [
                            {
                                "label": "伤害加成",
                                "trigger": "calc",
                                "script": "if (thisItem.system.active) { output.damage += 20; output.bonusDesc.push(\"禅法 +20\"); }"
                            }
                        ]
                    }
                }
            }
        ]
    },
    {
        "name": "降魔刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>万佛寺戒律院高僧所创，与燃木刀法齐名。</p>",
            "requirements": "刀-单刀，菩提院",
            "automationNote": "金刚降魔必暴击需手动。反击效果自动化。",
            "moves": [
                {
                    "name": "金刚降魔",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yin",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>刀扫目标周身，对目标造成 0.4 内息点内功伤害，击中无架招目标时，你可以选择消耗“禅心”状态，金刚伏魔，使此招式必然暴击。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "必暴击提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive && actor.effects.some(e => e.name === \"禅心\")) {\n    ui.notifications.info(\"可消耗禅心使此招式暴击（需手动移除禅心并应用暴击伤害）。\");\n}"
                        }
                    ]
                },
                {
                    "name": "罗汉入定",
                    "type": "stance",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yin",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>佛门入定，闭目而立，开启架招。并进入“目盲”和“禅心”状态，持续到战斗脱离。</p><p>你可以选择睁眼，然后同时移除目盲和禅心。</p><p><b>禅心</b>：当你运行佛门内功时，招式伤害+5。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获得状态",
                            "trigger": "attack",
                            "script": "await game.xjzl.api.effects.toggleStatus(actor, \"blind\", true);\nconst effect = thisItem.effects.getName(\"禅心\");\nif (effect) await game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ]
                },
                {
                    "name": "金殿霞光",
                    "type": "counter",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yin",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作释放此招，压制目标虚招，睁开双目，眼含精光，移除自身存在的目盲和禅心状态，使敌人陷入“禁足”三回合，并使自己获得“禅意”，持续三回合。</p><p><b>禅意</b>：当你运行佛门内功时，招式伤害+15。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击效果",
                            "trigger": "hit",
                            "script": "await game.xjzl.api.effects.removeEffect(actor, \"blind\");\nawait game.xjzl.api.effects.removeEffect(actor, \"chanxin\");\nawait game.xjzl.api.effects.addEffect(args.target, { id: \"root\", duration: { rounds: 3 } });\n\nconst effect = thisItem.effects.getName(\"禅意\");\nif (effect) {\n    const data = effect.toObject();\n    if (args.move.computedLevel >= 2) data.duration.rounds += 1;\n    await game.xjzl.api.effects.addEffect(actor, data);\n}"
                        }
                    ]
                },
                {
                    "name": "刀光囚魔",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "yin",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>刀光回旋，口念经文，对单个敌人造成 0.5 内息点内功伤害。</p><p>你可以选择消耗自身周围六米内所有目标的“禅心”或“禅意”状态，每消耗一个这样的状态，此招式的伤害提高 15 点。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "手动提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请手动统计周围禅心/禅意数量并调整伤害（每层+15），并手动移除这些状态。\");"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "禅心",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛门内功时，招式伤害+5。",
                "flags": {
                    "xjzl-system": {
                        "slug": "chanxin"
                    }
                }
            },
            {
                "name": "禅意",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛门内功时，招式伤害+15。",
                "duration": {
                    "rounds": 3
                },
                "flags": {
                    "xjzl-system": {
                        "slug": "chanyi"
                    }
                }
            }
        ]
    },
    {
        "name": "伏魔普度棍",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>伏魔杖法进阶武学，怜世舍己入轮回，普度众生。</p>",
            "requirements": "棍，达摩院",
            "automationNote": "伏魔状态自动化。击倒/流失需手动。",
            "moves": [
                {
                    "name": "佛念三千",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>三千世界，皆为尘埃，别棍搅势，对周围 3 米范围内敌人造成伤害。</p><p>若自身存在“伏魔”，还可将目标击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "伏魔击倒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "伏魔击倒",
                            "trigger": "hit",
                            "script": "// 检查自身是否有伏魔状态\n// [修正] Collection API 和 位置错误\nconst hasFumo = !!actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fumo\");\nif (hasFumo) {\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    ui.notifications.info(`${args.target.name} 被伏魔劲气击倒！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "五蕴皆空",
                    "type": "stance",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>垂目观世态炎凉，累善行慈悲为怀。开启架招。成功格挡时，给自身添加“伏魔”状态，持续一回合。</p><p><b>伏魔</b>：你对[恶][邪]的目标出招时招式伤害+10。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。2级后伏魔持续时间+1回合。</p>",
                    "automationNote": "格挡获伏魔自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获得伏魔",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"伏魔\");\n    if (effect) {\n        const data = effect.toObject();\n        delete data._id;\n        data.origin = thisItem.uuid;\n        \n        // [修正] 正确获取当前架招等级\n        const stanceId = actor.system.martial.stance;\n        const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n        const lvl = Math.max(1, moveData?.computedLevel || 1);\n\n        // 2级以上增加持续时间\n        if (lvl >= 2) {\n             data.duration.rounds = 2;\n        }\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "焚魔救世",
                    "type": "counter",
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，旋棍突击，对目标造成伤害。</p><p>可消耗自身 10 点气血，使目标流失 10 点内力。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "手动处理血换蓝。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "以血换蓝提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"提示：可手动扣除自身10HP，并扣除目标10MP。\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "普度众生",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "weaponType": "staff",
                    "element": "gang",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>扫棍狂舞，旋风打叶。对周围范围内敌人造成伤害。</p><p>对倒地目标招式伤害+10。</p><p>若自身存在“伏魔”，还可将目标击倒。</p><p><strong>升级：</strong>招式伤害+20，内力消耗+8，怒气消耗-1。</p>",
                    "automationNote": "倒地增伤自动。伏魔击倒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "倒地增伤",
                            "trigger": "preDamage",
                            "script": "// 直接读取系统维护的 xjzlStatuses.prone 状态\nif (args.target && args.target.xjzlStatuses.prone) {\n    args.config.amount += 10;\n    ui.notifications.info(\"目标倒地，普度众生伤害+10！\");\n}",
                            "active": true
                        },
                        {
                            "label": "伏魔击倒",
                            "trigger": "hit",
                            "script": "const hasFumo = !!actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fumo\");\nif (hasFumo) {\n    await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n    ui.notifications.info(`${args.target.name} 被伏魔劲气击倒！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "scripts": []
        },
        "effects": [
            {
                "name": "伏魔",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "对[恶][邪]目标招式伤害+10。",
                "duration": {
                    "rounds": 1
                },
                "flags": {
                    "xjzl-system": {
                        "slug": "fumo",
                        "stackable": false,
                        "scripts": [
                            {
                                "label": "伏魔增伤",
                                "trigger": "preDamage",
                                "active": true,
                                "script": "// --- 调试模式 ---\nconsole.log(\"XJZL | 伏魔检查目标:\", args.target?.name);\nif (args.target) {\n    const xiayi = args.target.system.social.xiayi || 0;\n    const exing = args.target.system.social.exing || 0;\n    \n    console.log(`XJZL | 目标数值: 恶行=${exing}, 侠义=${xiayi}`);\n\n    if (exing >= 100 && xiayi <= 50) {\n        console.log(\"XJZL | 伏魔生效!\");\n        args.config.amount += 10;\n        ui.notifications.info(`伏魔生效：对邪恶目标 [${args.target.name}] 伤害+10！`);\n    } else {\n        console.log(\"XJZL | 伏魔未生效: 目标不是大奸大恶之徒\");\n    }\n}"
                            }
                        ]
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "大力金刚掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>七十二绝技中最精湛的掌法。功成后可开砖碎石，威力无穷。</p>",
            "requirements": "徒手-拳掌，达摩院",
            "automationNote": "错骨/金刚/封招状态自动化。拉扯位移、击退免疫需手动。",
            "moves": [
                {
                    "name": "金刚推山",
                    "type": "real",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "3米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>双膝成弓、双掌齐出，对面前直线 3 米内敌人造成 0.4 力量点外功伤害。</p><p>命中无架招目标时，为其添加“错骨”一回合。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加错骨(1回合)",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    // 1. 获取系统预设数据\n    const baseData = CONFIG.statusEffects.find(e => e.id === \"cuogu\");\n    if (baseData) {\n        // 2. 克隆并修改持续时间\n        const effectData = foundry.utils.deepClone(baseData);\n        effectData.duration = { rounds: 1 };\n        // 3. 应用完整数据\n        await game.xjzl.api.effects.addEffect(args.target, effectData);\n        ui.notifications.info(`${args.target.name} 被错骨 (持续1回合)`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "力按千斤",
                    "type": "stance",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>沉肩松胯、刚劲下按，开启架招。获得“金刚”，持续到战斗脱离，或架招被击破。</p><p>成功格挡时，运劲反震，可将目标朝任意方向拉扯 2 米。</p><p><b>金刚</b>：你不会被击退、拉扯、击飞。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得金刚",
                            "trigger": "attack",
                            "script": "const effect = thisItem.effects.getName(\"金刚\");\nif (effect) await game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        },
                        {
                            "label": "反击拉扯提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const lvl = Math.max(1, args.move.computedLevel || 1);\n    const dist = 2 + (lvl - 1);\n    ui.notifications.info(`力按千斤：可拉扯 ${args.attacker.name} ${dist} 米。(需手动处理)`);\n}"
                        }
                    ]
                },
                {
                    "name": "蹲星伏虎",
                    "type": "feint",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>扬眉怒目、指掌变拳狠击，造成 0.4 力量点外功伤害。</p><p>击破对方架招时，给目标添加“错骨”状态，持续三回合。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破施加错骨(3回合)",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const baseData = CONFIG.statusEffects.find(e => e.id === \"cuogu\");\n    if (baseData) {\n        const effectData = foundry.utils.deepClone(baseData);\n        effectData.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, effectData);\n        ui.notifications.info(`${args.target.name} 被错骨 (持续3回合)`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "达摩拂袖",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>平直甩臂、拧腰背击，对敌人造成 0.7 力量点外功伤害。</p><p>若目标处于“错骨”，还会为其添加“封招”状态，持续一回合。</p>",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "错骨转封招",
                            "trigger": "hit",
                            "script": "// 检查目标是否有错骨状态 (slug=cuogu)\nif (args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"cuogu\")) {\n    const baseData = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if (baseData) {\n        const effectData = foundry.utils.deepClone(baseData);\n        effectData.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, effectData);\n        ui.notifications.info(`${args.target.name} 被封招 (持续1回合)`);\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "金刚",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "不会被击退、拉扯、击飞。",
                "flags": {
                    "xjzl-system": {
                        "slug": "jingang",
                        "stackable": false
                    }
                }
            }
        ]
    },
    {
        "name": "摩柯伏魔掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>七十二绝技之一，穷极生死轮转，克尽阴司鬼物。</p><p><strong>需求：</strong>徒手-拳掌，菩提院</p><p><strong>属性：</strong>阴</p>",
            "requirements": "徒手-拳掌，菩提院",
            "moves": [
                {
                    "name": "秽土悲慈",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，掌风如实，造成 0.4 内息点内功伤害，击破架招后获得一层“愿力”，至多三层，持续到战斗脱离。</p><p><strong>愿力：</strong>每层使你虚招对抗结果+1，虚招伤害+10。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获愿力自动。愿力效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破获愿力",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"愿力\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "地狱净空",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，默念咒语，开启架招。若自身具有“愿力”，可以同时击飞周围 1 米无架招的敌人。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启架招自动。愿力击飞提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "愿力击飞提示",
                            "trigger": "attack",
                            "script": "const hasYuanli = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yuanli\");\nif (hasYuanli) {\n    ui.notifications.info(\"愿力加持：请手动处理周围 1 米无架招敌人的 [击飞] 效果。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "大愿成佛",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，双掌虚划，压制虚招，消耗至多一层“愿力”，每消耗一层愿力，目标受到一次等同于他此次虚招伤害数值（不暴击）的内功伤害。</p><p><strong>升级：</strong>消耗愿力层数+1，内力消耗+2。</p>",
                    "automationNote": "反伤效果手动。发送卡片提示可选操作。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反伤提示",
                            "trigger": "hit",
                            "script": "const yuanli = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yuanli\");\nif (yuanli) {\n    const currentStacks = yuanli.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const maxConsume = (args.move.computedLevel >= 2) ? 2 : 1;\n    const canConsume = Math.min(currentStacks, maxConsume);\n\n    const msg = `\n    <div class=\"xjzl-chat-card\">\n        <div class=\"card-content-wrapper\">\n            <div style=\"font-weight:bold; color:var(--xjzl-gold); margin-bottom:5px;\">可选：大愿成佛</div>\n            <p style=\"font-size:0.9em;\">当前愿力：<b>${currentStacks}</b> 层。</p>\n            <p style=\"font-size:0.9em;\">可手动消耗至多 <b>${canConsume}</b> 层。</p>\n            <hr>\n            <p style=\"font-size:0.85em; color:#666;\">若消耗，请手动造成：<br><b>敌方虚招伤害 × 消耗层数</b> 的内功伤害。</p>\n        </div>\n    </div>`;\n    ChatMessage.create({ user: game.user.id, content: msg, speaker: ChatMessage.getSpeaker({actor: actor}) });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "度尽众生",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，单掌拍出，禅音鼓荡，造成 0.5 内息点内功伤害，</p><p>·若有人处于半空状态，你可以消耗反应动作释放此招，原地发出内劲，遥遥一击，造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无特殊自动化。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "菩提证果",
                    "type": "qi",
                    "actionType": "default",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，默念誓愿，浑身闪烁金色光芒，立即获得一层“愿力”，至多三层，持续到战斗脱离。</p><p>·你进行一次[佛法]检定（难度 11），成功后为场上其他友方添加“禅心”，持续到战斗脱离。</p><p><strong>禅心：</strong>当你运行佛门内功时，招式伤害+5。</p><p><strong>升级：</strong>愿力层数+1，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获愿力自动。检定与BUFF应用手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获愿力与提示",
                            "trigger": "hit",
                            "script": "// 1. 获得愿力 (Lv1=1层, Lv2=2层, Lv3=3层)\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst stacksToAdd = lvl;\nconst eff = thisItem.effects.getName(\"愿力\").toObject();\n// 循环添加，利用 addEffect 的堆叠逻辑\nfor(let i=0; i<stacksToAdd; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}\n\n// 2. 发送提示卡片\nconst msg = `\n<div class=\"xjzl-chat-card\">\n    <div class=\"card-content-wrapper\">\n        <p><b>菩提证果</b> 已释放。</p>\n        <hr>\n        <p>请手动进行 <b>[佛法]</b> 检定 (DC 11)。</p>\n        <p>若成功，请将物品栏中的 <b>[禅心]</b> 拖拽给场上友方。</p>\n    </div>\n</div>`;\nChatMessage.create({ user: game.user.id, content: msg, speaker: ChatMessage.getSpeaker({actor: actor}) });",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "愿力",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "每层使你虚招对抗结果+1，虚招伤害+10。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yuanli",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "虚招增伤",
                                    "trigger": "calc",
                                    "script": "if (args.move.type === \"feint\") {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    args.output.damage += 10 * stacks;\n    args.output.bonusDesc.push(`愿力 +${10 * stacks}`);\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.xuzhao",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.combat.kanpo",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "禅心",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "运行佛门内功时，招式伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "chanxin",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "佛门加伤",
                                    "trigger": "calc",
                                    "script": "// 获取当前运行的内功\nconst activeId = actor.system.martial.active_neigong;\nif (activeId) {\n    const neigong = actor.items.get(activeId);\n    // 判断门派是否为万佛寺 (wanfosi)\n    if (neigong && neigong.system.sect === \"wanfosi\") {\n        args.output.damage += 5;\n        args.output.bonusDesc.push(\"禅心 +5\");\n    }\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ],
            "scripts": []
        }
    },
    {
        "name": "菩提劫指",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一。成佛历劫，需大毅力，此指炽热非常，中招之人必定全身焦黑如火烧一般。</p><p><strong>需求：</strong>徒手-指法，菩提院</p><p><strong>属性：</strong>阳</p>",
            "requirements": "徒手-指法，菩提院",
            "moves": [
                {
                    "name": "无我无相",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，指尖一股纯阳气，开启架招。格挡成功后获得“纯阳气”状态，持续一回合。</p><p><strong>升级：</strong>格挡值+10，持续回合数+1，内力消耗+2。</p>",
                    "automationNote": "完全自动化。脚本自动计算等级对应的持续时间。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获气",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 1. 获取AE模板\nconst effData = thisItem.effects.getName(\"纯阳气\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 2. 手动查找招式数据以计算等级 (因为防御时 args.move 未定义)\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\n\n// 3. 计算持续时间 (基础1 + Lv-1)\nconst rounds = 1 + (lvl - 1);\neffData.duration = { rounds: rounds };\n\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一指昙花",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，指击目标兵刃，内劲传敌全身，造成伤害。若目标所持武器为金铁之物，则击破架招时可消耗“纯阳气”，使该武器炙热难挡，只要目标装备该武器，便会陷入“缴械”，持续两回合。</p><p><strong>缴械：</strong>你无法施展徒手以外的武学。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破后若有纯阳气，弹窗询问。若确认，脚本自动扣除纯阳气并给目标施加缴械。需玩家自行判断武器材质。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "纯阳缴械",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const chunyang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_chunyangqi\");\n    if (chunyang) {\n        const confirm = await foundry.applications.api.DialogV2.confirm({\n            window: { title: \"一指昙花\" },\n            content: `<p>击破架招！检测到自身拥有 [纯阳气]。</p><p>若目标持有<b>金铁武器</b>，是否消耗 1 层纯阳气使其 [缴械] 2回合？</p>`,\n            ok: { label: \"消耗并缴械\", icon: \"fas fa-fire\" },\n            reject: { label: \"跳过\", icon: \"fas fa-times\" }\n        });\n\n        if (confirm) {\n            // 1. 扣除纯阳气\n            await game.xjzl.api.effects.removeEffect(actor, \"wuxue_chunyangqi\", 1);\n            \n            // 2. 施加缴械 (调用系统预设 jiaoxie)\n            const statusConfig = CONFIG.statusEffects.find(e => e.id === \"jiaoxie\");\n            if (statusConfig) {\n                const effectData = foundry.utils.deepClone(statusConfig);\n                effectData.duration = { rounds: 2 };\n                await game.xjzl.api.effects.addEffect(args.target, effectData);\n                ui.notifications.info(\"纯阳劲透入，目标兵刃滚烫，已缴械！\");\n            }\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一指倾城",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作/反应",
                    "description": "<p>主要动作，红尘种种，过眼云烟，指击面门，对目标造成伤害。</p><p>·若目标处于走火入魔，可以消耗反应施展此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "反应施展时机需玩家手动判断。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "一指登天",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，指击胸膛，勘破执迷，压制虚招，对其造成伤害，击飞目标两米，并获得“纯阳气”状态，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中自动获得无限时长的纯阳气。击飞需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取纯阳气",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = thisItem.effects.getName(\"纯阳气\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    \n    // 持续到战斗脱离 -> 清空 duration 即为无限\n    delete effData.duration;\n    \n    await game.xjzl.api.effects.addEffect(actor, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "一指黄粱",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，内劲击额，吹醒黄粱梦，造成伤害。</p><p>·可消耗“纯阳气”使目标额外受到 30 点火焰伤害，并立即进行一次[定力]检定（难度 15），失败还会使其陷入“走火入魔”，持续一回合。</p><p><strong>升级：</strong>招式伤害+20，走火入魔回合数+1，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "若有纯阳气会弹窗询问。消耗则自动：造成火伤 -> 发起检定 -> 失败自动应用走火入魔。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "纯阳爆发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const chunyang = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_chunyangqi\");\n    \n    if (chunyang) {\n        const confirm = await foundry.applications.api.DialogV2.confirm({\n            window: { title: \"一指黄粱\" },\n            content: `<p>是否消耗 1 层<b>纯阳气</b>？</p><p>效果：额外造成 30 火焰伤害 + 定力检定(失败走火入魔)。</p>`,\n            ok: { label: \"消耗\", icon: \"fas fa-check\" }\n        });\n\n        if (confirm) {\n            // 1. 扣除\n            await game.xjzl.api.effects.removeEffect(actor, \"wuxue_chunyangqi\", 1);\n\n            // 2. 火焰伤害\n            await args.target.applyDamage({\n                amount: 30,\n                type: \"fire\",\n                attacker: actor,\n                isHit: true\n            });\n\n            // 3. 计算走火入魔持续时间 (基础1 + Lv-1)\n            const lvl = Math.max(1, move.computedLevel || 1);\n            const rageDuration = 1 + (lvl - 1);\n\n            // 4. 准备失败惩罚 (系统状态 rage)\n            const rageEffect = CONFIG.statusEffects.find(e => e.id === \"rage\");\n            if (rageEffect) {\n                const effectData = foundry.utils.deepClone(rageEffect);\n                effectData.duration = { rounds: rageDuration };\n                \n                // 5. 发起检定\n                await Macros.requestSave({\n                    target: args.target,\n                    attacker: actor,\n                    type: \"dingli\",\n                    dc: 15,\n                    label: \"抵抗走火入魔\",\n                    onFail: effectData\n                });\n            }\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "纯阳气",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "积蓄的纯阳真气，可用于强化菩提劫指的其他招式。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_chunyangqi",
                            "stackable": true
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "无相戒刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一，唐代无相禅师所创，此功法佛意深邃，真意直承达摩祖师。</p><p>需求：刀-单刀，戒律院 属性：太极</p>",
            "requirements": "刀-单刀，戒律院",
            "moves": [
                {
                    "name": "起手式",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>手拖刀刃，刀身转于掌心，开启架招。格挡成功时，若敌人具有[侠]或[恶]标签，则受到10点精神伤害。</p>",
                    "automationNote": "检测攻击者侠义/恶行值，符合则反弹精神伤害。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：戒刀反震",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const attSocial = args.attacker.system.social || {};\n    const isXia = (attSocial.xiayi >= 100 && attSocial.exing <= 50);\n    const isE = (attSocial.exing >= 100 && attSocial.xiayi <= 50);\n    if (isXia || isE) {\n        const dmg = 10 + (args.move.computedLevel - 1) * 10;\n        await args.attacker.applyDamage({\n            amount: dmg,\n            type: \"mental\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n        ui.notifications.info(\"无相戒刀直指人心，造成精神伤害！\");\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "无忆刀",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "taiji",
                    "actionCost": "主要动作/反应",
                    "range": "1米",
                    "description": "<p>无忆是戒，刀砍双臂，对目标造成0.5力量点外功伤害。当目标受到精神伤害时，可消耗反应施展此招攻击该目标。</p>",
                    "automationNote": "命中后记录使用标记（用于绝招）。反应需手动。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "记录使用",
                            "trigger": "hit",
                            "script": "if(args.isHit) await actor.setFlag(\"xjzl-system\", \"wuxue_wuxiang_wuyi\", true);"
                        }
                    ]
                },
                {
                    "name": "无念刀",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "taiji",
                    "actionCost": "主要动作/反应",
                    "range": "1米",
                    "description": "<p>无念是定，负刀重劈，对目标造成0.5力量点外功伤害。当目标使用反应动作时，可消耗反应施展此招攻击该目标。</p>",
                    "automationNote": "命中后记录使用标记。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "记录使用",
                            "trigger": "hit",
                            "script": "if(args.isHit) await actor.setFlag(\"xjzl-system\", \"wuxue_wuxiang_wunian\", true);"
                        }
                    ]
                },
                {
                    "name": "莫妄刀",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "taiji",
                    "actionCost": "主要动作/反应",
                    "range": "1米",
                    "description": "<p>莫妄是慧，刀砍肩颈，对目标造成0.5力量点外功伤害，若击中无架招目标，可消耗反应施展此招攻击该目标。</p>",
                    "automationNote": "命中后记录使用标记。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "记录使用",
                            "trigger": "hit",
                            "script": "if(args.isHit) await actor.setFlag(\"xjzl-system\", \"wuxue_wuxiang_mowang\", true);"
                        }
                    ]
                },
                {
                    "name": "禅洁定慧",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "taiji",
                    "actionCost": "蓄力动作",
                    "range": "2米",
                    "description": "<p>念六祖慧能，挥刀弄圆，对周围敌人造成0.7力量点外功伤害。</p><p>·若本场战斗自身曾施展过【无忆刀】【无念刀】【莫妄刀】，还会为命中目标添加“迟滞”，同时你免疫“迟滞”（不会被添加该状态），持续到战斗脱离。</p>",
                    "automationNote": "检测前置招式使用记录，满足则施加迟滞并赋予自身免疫BUFF。",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "三刀合一",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const f = actor.flags[\"xjzl-system\"] || {};\n    if (f.wuxue_wuxiang_wuyi && f.wuxue_wuxiang_wunian && f.wuxue_wuxiang_mowang) {\n        await game.xjzl.api.effects.toggleStatus(args.target, \"chizhi\", true);\n        const hasImmunity = actor.effects.find(e => e.name === \"免疫迟滞\");\n        if (!hasImmunity) {\n            const immuneEffect = thisItem.effects.find(e => e.name === \"免疫迟滞\");\n            if (immuneEffect) {\n                await game.xjzl.api.effects.addEffect(actor, immuneEffect.toObject());\n                ui.notifications.info(\"三刀圆满，获得迟滞免疫！\");\n            }\n        }\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "免疫迟滞",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "禅洁定慧赋予的特殊状态，免疫迟滞。",
                "duration": {
                    "rounds": 99
                }
            }
        ]
    },
    {
        "name": "大摩柯指",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一，声名不显，需高深内力驱动，指风稳健，势如山岳，然威力巨大。</p><p>需求：徒手-指法，戒律院 属性：太极</p>",
            "requirements": "徒手-指法，戒律院",
            "moves": [
                {
                    "name": "以逸待劳",
                    "type": "stance",
                    "actionCost": "次要动作/反应",
                    "range": "自身",
                    "description": "<p>指间萦绕内劲，开启架招。</p><p>即将受到招式伤害时，可消耗反应动作施展此招，使自身的格挡值翻倍，招式伤害结算后，自身格挡值恢复。</p>",
                    "automationNote": "反应施展与格挡翻倍需手动处理。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    }
                },
                {
                    "name": "羚羊挂角",
                    "type": "feint",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "主要动作",
                    "range": "2米",
                    "description": "<p>一指真气打出，无迹可寻，造成0.4内息点内功伤害，击破架招时获得一层“磐石”，至多三层，持续到战斗脱离。</p><p>磐石：每层使你的格挡值+5。</p>",
                    "automationNote": "击破架招自动添加/叠加磐石。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取磐石",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(actor, \"panshi\");\n}"
                        }
                    ]
                },
                {
                    "name": "指尖天风",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "反应动作",
                    "range": "2米",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，指风如炬，压制虚招，并对目标造成0.6内息点内功伤害，内劲蓄势待发，可消耗10点内力，使下次施展【惊天动地】所需怒气-1。</p>",
                    "automationNote": "命中后弹窗询问是否消耗内力以获得BUFF。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "蓄势",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"指尖天风\" },\n        content: \"<p>是否消耗 10 点内力，使下次【惊天动地】怒气消耗 -1？</p>\",\n        ok: { label: \"消耗\" }\n    });\n    if (confirm) {\n        if (actor.system.resources.mp.value >= 10) {\n            await actor.update({ \"system.resources.mp.value\": actor.system.resources.mp.value - 10 });\n            const buff = thisItem.effects.find(e => e.name === \"惊天动地·蓄势\");\n            if (buff) await game.xjzl.api.effects.addEffect(actor, buff.toObject());\n        } else {\n            ui.notifications.warn(\"内力不足！\");\n        }\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "惊天动地",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "主要动作",
                    "range": "2米",
                    "description": "<p>波澜不惊，一指打出，铺天盖地，此招必然命中，对目标造成0.7内息点内功伤害。同时给目标添加一层“愚钝”，至多三层，持续到战斗脱离。</p><p>愚钝：每层使你的虚招对抗-1。</p>",
                    "automationNote": "自动检测蓄势BUFF返还怒气。必定命中，命中叠加愚钝。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "怒气减免检测",
                            "trigger": "attack",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_damoke_xushi\");\nif (buff) {\n    const stacks = buff.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    await actor.update({\"system.resources.rage.value\": Math.min(10, actor.system.resources.rage.value + stacks)});\n    ui.notifications.info(`蓄势生效，返还 ${stacks} 点怒气。`);\n    await buff.delete();\n}\nargs.flags.bonusHit += 999; // 必中"
                        },
                        {
                            "label": "施加愚钝",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const stacksToAdd = 1 + (args.move.computedLevel - 1);\n    for(let i=0; i<stacksToAdd; i++) {\n         await game.xjzl.api.effects.addEffect(args.target, \"yudun\");\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "惊天动地·蓄势",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "下次施展惊天动地怒气-1",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_damoke_xushi",
                        "stackable": true
                    }
                }
            }
        ]
    },
    {
        "name": "大乘金刚般若掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一。此功属万佛外门神功，刚猛无比，但除达摩外无人能修至绝顶。</p><p>需求：徒手-拳掌，达摩院 属性：刚</p>",
            "requirements": "徒手-拳掌，达摩院",
            "moves": [
                {
                    "name": "天衣无缝",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>次要动作，双掌拍出，封堵周身破绽，开启架招，格挡成功后，下次《大乘金刚般若掌》招式造成的伤害+10。</p>",
                    "automationNote": "完全自动化。格挡成功且检测到架招开启时，自动赋予增伤Buff。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：金刚增伤",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const buff = thisItem.effects.find(e => e.name === \"金刚掌力\");\n    if (buff) await game.xjzl.api.effects.addEffect(actor, buff.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "慑伏外道",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "gang",
                    "actionCost": "主要动作/反应",
                    "range": "1米",
                    "description": "<p>主要动作，单掌猛击，造成 0.5 力量点外功伤害，若有敌方被友方击破架招，可消耗反应施展此招，攻击被击破架招的敌人。</p>",
                    "automationNote": "反应释放需手动。增伤逻辑已移交Buff自身托管，完全自动化。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    }
                },
                {
                    "name": "峡谷天风",
                    "type": "feint",
                    "damageType": "waigong",
                    "element": "gang",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "description": "<p>主要动作，掌如疾风，双掌贴合而击，造成 0.4 力量点外功伤害，击破架招后目标需要进行一次难度10 的体魄检定，失败则眩晕一轮。</p>",
                    "automationNote": "完全自动化。增伤逻辑托管。若击破架招，自动发起体魄检定，失败自动眩晕。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "破架眩晕",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const dc = 10 + (args.move.computedLevel - 1);\n    const stunEffect = CONFIG.statusEffects.find(e => e.id === \"stun\");\n    const effectData = foundry.utils.deepClone(stunEffect);\n    effectData.duration = { rounds: 1 };\n    \n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"tipo\",\n        dc: dc,\n        label: \"抵抗峡谷天风\",\n        onFail: effectData\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "境智俱寂",
                    "type": "qi",
                    "actionType": "default",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>次要动作，平心静气，如或长夜不安，心念纷飞，如何慑伏，清除自身存在的一个状态。</p>",
                    "automationNote": "请玩家自行在特效栏右键删除一个负面状态。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            3,
                            2,
                            1
                        ]
                    }
                },
                {
                    "name": "照空见寂",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "gang",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "description": "<p>主要动作，一掌打出，万籁俱寂，造成 0.7 力量点外功伤害。若施展时自身没有任何状态，则使目标陷入“封招”状态，持续一回合。</p>",
                    "automationNote": "检测自身状态逻辑复杂，改为手动判定。请根据提示操作。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "特效提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"照空见寂：请检查自身是否存在任何状态。若无，请手动给目标施加【封招】（持续1回合）。\");"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "金刚掌力",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "下一次大乘金刚般若掌伤害+10",
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_banruo_buff",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "增伤计算",
                                    "trigger": "calc",
                                    "script": "if (args.item && args.item.name === \"大乘金刚般若掌\" && args.move.type !== \"stance\" && args.move.type !== \"qi\") {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"金刚掌力 +10\");\n}"
                                },
                                {
                                    "label": "生效消耗",
                                    "trigger": "hit",
                                    "script": "if (args.item && args.item.name === \"大乘金刚般若掌\" && args.move.type !== \"stance\" && args.move.type !== \"qi\") {\n    await thisEffect.delete();\n}"
                                }
                            ]
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "八部天龙剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>“天龙八部、人与非人，皆遥见彼龙女成佛。”传闻佛向诸菩萨、比丘众说法时，常有天龙八部参与听法。此武功蕴含八种佛道神怪之离奇各异，威力不凡。</p><p>需求：剑-双手剑，戒律院 属性：太极</p>",
            "requirements": "剑-双手剑，戒律院",
            "moves": [
                {
                    "name": "金鹏啄蛇",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>收剑伺机，开启架招。格挡成功后，可以消耗反应动作对目标施展【天人掷电】。</p>",
                    "automationNote": "开启架招自动。格挡后的反击需玩家手动点击“天人掷电”。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    }
                },
                {
                    "name": "修罗一斩",
                    "type": "feint",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "主要动作",
                    "range": "2米",
                    "description": "<p>持剑急扫，势如破竹，对目标造成0.2力量+0.3内息点内功伤害，击中无架招敌人时，自身获得一层“化身”，至多八层，持续到脱战。</p>",
                    "automationNote": "命中时自动检测目标架招状态，若无架招则给予化身层数。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.2
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取化身",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const effectData = thisItem.effects.find(e => e.name === \"化身\");\n    if (effectData) await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "天人掷电",
                    "type": "real",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "主要动作/反应",
                    "range": "3米",
                    "description": "<p>剑气冲霄，直刺印堂，对目标造成0.3力量+0.3内息点内功伤害。</p><p>·当有目标处于半空中时，可以消耗反应动作，原地释放此招，射出剑光直刺目标，造成伤害并使自己获得一层“化身”状态，持续到战斗脱离。</p>",
                    "automationNote": "完全手动。系统无法判断“半空”或“反应动作”，若满足条件，请手动在特效栏添加一层“化身”。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    }
                },
                {
                    "name": "夜叉燎天",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "反应动作",
                    "range": "3米",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，指风如炬，崩剑探出，压制虚招，挑剑将目标拉扯至身边1米空格处，然后剑气刺体，对目标造成0.3力量+0.4内息点内功伤害，获得一层“化身”状态，持续到战斗脱离。</p>",
                    "automationNote": "命中自动获得化身（2级后获2层）。位移需手动。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取化身",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    let stacks = 1;\n    if (args.move.computedLevel >= 2) stacks = 2;\n    const effectData = thisItem.effects.find(e => e.name === \"化身\");\n    if (effectData) {\n        // 循环添加以触发叠层逻辑\n        for(let i=0; i<stacks; i++) {\n            await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n        }\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "八龙探首",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "主要动作",
                    "range": "10米",
                    "description": "<p>将手中长剑飞掷而出，对目标造成0.5力量+0.4内息点内功伤害，之后双掌合并，剑气缠绕，获得“八部天龙”，持续二回合。</p><p>·你的剑会落在目标所处空格，可以花费一个主要动作捡起。</p><p>八部天龙：双手合十，视为伤害20格挡10的双手剑，你可以徒手施展剑法套路，若你用徒手施展《八部天龙剑》，每次出招，获得一层“化身”，持续到战斗脱离。</p>",
                    "automationNote": "命中应用BUFF。丢刀、捡刀需手动。BUFF已包含徒手施展本武学加化身的脚本。",
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30
                        ],
                        "rage": [
                            10,
                            9,
                            8
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用BUFF",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effectData = thisItem.effects.find(e => e.name === \"八部天龙\");\n    if (effectData) {\n        const data = effectData.toObject();\n        data.duration.rounds = 2 + (args.move.computedLevel - 1);\n        await game.xjzl.api.effects.addEffect(actor, data);\n    }\n    ui.notifications.info(\"长剑飞出！请手动在装备栏卸下当前武器。\");\n}"
                        }
                    ]
                },
                {
                    "name": "化身选择",
                    "type": "qi",
                    "actionType": "default",
                    "actionCost": "无消耗",
                    "range": "自身",
                    "description": "<p>当你拥有八层“化身”时，移除全部“化身”，使自己化为八部天龙众之一。</p>",
                    "automationNote": "若满8层化身，消耗化身，并提示玩家手动添加对应的化身AE。",
                    "costs": {
                        "mp": [],
                        "rage": [],
                        "hp": []
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "scripts": [
                        {
                            "label": "化身降临",
                            "trigger": "attack",
                            "script": "const huashen = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_babu_huashen\");\nconst stacks = huashen ? (huashen.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nif (stacks < 8) {\n    ui.notifications.warn(`化身层数不足 (${stacks}/8)`);\n    args.flags.abort = true;\n    return;\n}\nawait huashen.delete();\nargs.flags.autoApplied = true;\nui.notifications.info(\"化身消耗完毕。请在物品特效栏中找到对应的化身效果并拖拽给角色。\");"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "化身",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "八部天龙剑的化身层数。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_huashen",
                        "stackable": true,
                        "maxStacks": 8
                    }
                }
            },
            {
                "name": "八部天龙",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "视为持剑，徒手施展八部天龙剑时叠加化身。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_tianlong",
                        "scripts": [
                            {
                                "label": "徒手加化身",
                                "trigger": "hit",
                                "script": "// 检查是否徒手且使用的是本武学的招式\nif (args.move.weaponType === 'unarmed' && args.item.id === thisItem.id) {\n    const effectData = thisItem.effects.find(e => e.name === \"化身\");\n    if (effectData) await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n}"
                            }
                        ]
                    }
                }
            },
            {
                "name": "化身：天众",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "你立即回复全部的气血内力（需手动点击治疗或调整数值）。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_tian"
                    }
                }
            },
            {
                "name": "化身：龙众",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "力量相关技能检定+3且具有优势，招式伤害+30。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_long"
                    }
                },
                "changes": [
                    {
                        "key": "flags.xjzl-system.liliangCheckLevel",
                        "mode": 2,
                        "value": 1
                    },
                    {
                        "key": "system.stats.liliang.checkMod",
                        "mode": 2,
                        "value": 3
                    },
                    {
                        "key": "system.skills.jiaoli.mod",
                        "mode": 2,
                        "value": 3
                    },
                    {
                        "key": "system.skills.zhengtuo.mod",
                        "mode": 2,
                        "value": 3
                    },
                    {
                        "key": "system.skills.paozhi.mod",
                        "mode": 2,
                        "value": 3
                    },
                    {
                        "key": "system.skills.qinbao.mod",
                        "mode": 2,
                        "value": 3
                    },
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": 30
                    }
                ]
            },
            {
                "name": "化身：夜叉",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "闪避+10，速度+5。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_yecha"
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.dodge",
                        "mode": 2,
                        "value": 10
                    },
                    {
                        "key": "system.combat.speed",
                        "mode": 2,
                        "value": 5
                    }
                ]
            },
            {
                "name": "化身：乾达婆",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "回合结束为周围5米友方回30血(手动)。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_gandapo"
                    }
                }
            },
            {
                "name": "化身：阿修罗",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "免疫目盲(手动)，内外防+30。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_axiuluo"
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.def_waigong",
                        "mode": 2,
                        "value": 30
                    },
                    {
                        "key": "system.combat.def_neigong",
                        "mode": 2,
                        "value": 30
                    }
                ]
            },
            {
                "name": "化身：迦楼罗",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "获得飞行能力。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_jialoulou"
                    }
                }
            },
            {
                "name": "化身：紧那罗",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "出招使20米内敌人流失10内力(手动)。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_jinnaluo"
                    }
                }
            },
            {
                "name": "化身：摩呼罗伽",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "伤害类型转为毒素。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_babu_mohuluojia",
                        "scripts": [
                            {
                                "label": "毒素转化",
                                "trigger": "preDamage",
                                "script": "args.config.type = 'poison';"
                            }
                        ]
                    }
                }
            }
        ]
    },
    {
        "name": "慈悲刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一，只制敌化敌而不杀敌。</p><p>需求：刀，菩提院 属性：阳</p>",
            "requirements": "刀，菩提院",
            "moves": [
                {
                    "name": "贫僧说法",
                    "type": "qi",
                    "actionType": "default",
                    "actionCost": "主要动作",
                    "range": "10米",
                    "description": "<p>传经布道，你与范围内单个目标进行一次论禅的[佛法]对抗，论禅失败者获得一层“乏力”，至多叠加三层，持续到战斗脱离。</p><p>乏力：招式伤害降低10点。</p>",
                    "automationNote": "完全自动化。发起佛法对抗，失败自动应用乏力（已配置叠层上限）。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "scripts": [
                        {
                            "label": "论禅",
                            "trigger": "hit",
                            "script": "const bonus = args.move.computedLevel - 1;\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"fofa\",\n    dc: 15,\n    label: \"论禅对抗 (攻方加值 \" + bonus + \")\",\n    onFail: {\n        name: \"乏力\",\n        icon: \"icons/svg/downgrade.svg\",\n        flags: { \"xjzl-system\": { \"slug\": \"fali_debuff\", \"stackable\": true, \"maxStacks\": 3 } },\n        changes: [{ \"key\": \"system.combat.damages.skill.mod\", \"mode\": 2, \"value\": -10 }]\n    }\n});"
                        }
                    ]
                },
                {
                    "name": "苦海无涯",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>诉世间苦，道孽海茫，开启架招。</p><p>格挡成功后，若目标携带有刃的兵器，会不慎被自身武器割破，受到10点气血流失。</p>",
                    "automationNote": "半自动化。成功格挡后会发出提示，需玩家自行确认敌方武器类型并手动结算反伤。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：反噬提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    ui.notifications.info(\"苦海无涯触发：若目标持有有刃兵器，请对其进行 10 点流失伤害。\");\n}"
                        }
                    ]
                },
                {
                    "name": "放下屠刀",
                    "type": "qi",
                    "actionType": "heal",
                    "actionCost": "主要动作",
                    "range": "5米",
                    "description": "<p>将手中之刀丢在自身所站立的空格，向目标劝言皈依，目标每有1点怒气，你回复10点气血，5点内力。</p><p>·若目标怒气大于5，为其添加“缴械”一回合。</p><p>·你丢掉的刀需要花费主要动作捡起。</p>",
                    "automationNote": "完全自动化。自动卸下自身武器，自动吸取回复，自动判定怒气并施加1回合缴械。",
                    "costs": {
                        "mp": []
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "scripts": [
                        {
                            "label": "劝世回春",
                            "trigger": "hit",
                            "script": "const rage = args.target.system.resources.rage.value || 0;\n\n// 1. 自动丢刀逻辑\nconst equippedWeapons = actor.itemTypes.weapon.filter(w => w.system.equipped);\nif (equippedWeapons.length > 0) {\n    const updates = equippedWeapons.map(w => ({ _id: w.id, \"system.equipped\": false }));\n    await actor.updateEmbeddedDocuments(\"Item\", updates);\n    ui.notifications.info(\"你丢下了手中的兵刃。\");\n}\n\n// 2. 治疗逻辑\nif (rage > 0) {\n    const healHP = rage * (10 + (args.move.computedLevel - 1) * 5);\n    const healMP = rage * (5 + (args.move.computedLevel - 1) * 5);\n    await actor.applyHealing({ amount: healHP, type: \"hp\" });\n    await actor.applyHealing({ amount: healMP, type: \"mp\" });\n    \n    // 3. 缴械逻辑 (修正持续时间)\n    if (rage > 5) {\n        // 获取系统标准状态并修改持续时间\n        const jiaoxieData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"jiaoxie\"));\n        if (jiaoxieData) {\n            jiaoxieData.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, jiaoxieData);\n            ui.notifications.info(\"放下屠刀：目标怒火攻心，兵刃脱手(1回合)！\");\n        }\n    }\n} else {\n    ui.notifications.warn(\"目标心中无怒，无法度化。\");\n}"
                        }
                    ]
                },
                {
                    "name": "回头是岸",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "yang",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "description": "<p>袈裟飞舞，持刀前送，在即将命中目标时收手，刀气对目标造成0.1力量点内功伤害。然后，不消耗动作和时间进行一次诵经，你此次诵经的[佛法]检定必定成功，且诵经效果直接生效。</p><p>·目标需要失去所有怒气，否则将流失等同于他恶行值的气血。（至多100）</p>",
                    "automationNote": "伤害自动。怒气判定与流失伤害自动。诵经效果需手动查阅规则执行。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.1
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "恶业反噬",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const targetRage = args.target.system.resources.rage.value || 0;\n    if (targetRage > 0) {\n        // 目标有怒气 (未放下)，触发反噬\n        const exing = args.target.system.social?.exing || 0;\n        const limit = 100 + (args.move.computedLevel - 1) * 100;\n        const dmg = Math.min(limit, exing);\n        \n        if (dmg > 0) {\n            await args.target.applyDamage({\n                amount: dmg,\n                type: \"liushi\",\n                attacker: actor,\n                isHit: true\n            });\n            ui.notifications.info(`回头是岸：恶业反噬！流失 ${dmg} 点气血。`);\n        } else {\n             ui.notifications.info(\"目标虽有怒气，但无恶行值，未受反噬。\");\n        }\n    } else {\n        ui.notifications.info(\"目标已放下屠刀（无怒气），免受恶业反噬。\");\n    }\n    // 提示诵经\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\"><h3>诵经成功</h3><p>你触发了一次必定成功的诵经，请根据[技艺:佛法]规则手动结算诵经效果。</p></div>`,\n        speaker: ChatMessage.getSpeaker({ actor: actor })\n    });\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "须弥神掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一，远近如意，威力极大，然门槛极高，纵能勉强练成，也需凝神良久才能发掌。</p><p>需求：徒手-拳掌，戒律院 属性：太极</p>",
            "requirements": "徒手-拳掌，戒律院",
            "moves": [
                {
                    "name": "须弥临天",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "反应动作",
                    "range": "1米",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，一掌打出，压制目标虚招，对其造成0.6内息点内功伤害，击退目标两米。然后自身获得一层“须弥”，至多四层，持续到战斗脱离。</p><p>须弥：每层使《须弥神掌》施放距离+1。</p>",
                    "automationNote": "命中叠加须弥BUFF。击退手动。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取须弥",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effectData = thisItem.effects.find(e => e.name === \"须弥\");\n    if (effectData) await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "须弥分寸",
                    "type": "feint",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "蓄力动作",
                    "range": "1米",
                    "description": "<p>内力汇聚，蓄力于虚，冲击目标造成0.4内息点内功伤害，击中无架招目标时，获得一层“须弥”，至多四层，持续到脱战。</p><p>·出招前可以选择消耗“须弥”，每消耗一层，此招需求动作下降一级。</p>",
                    "automationNote": "命中无架招叠加BUFF。消耗须弥降级动作需手动。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获取须弥",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const effectData = thisItem.effects.find(e => e.name === \"须弥\");\n    if (effectData) await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "须弥暗藏",
                    "type": "stance",
                    "actionCost": "主要动作",
                    "range": "自身",
                    "description": "<p>双手合十，坐马运气，内息暗藏，不显分毫，开启架招。格挡成功后，获得一层“须弥”，至多四层，持续到战斗脱离。</p>",
                    "automationNote": "格挡成功自动叠加BUFF。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：积蓄须弥",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effectData = thisItem.effects.find(e => e.name === \"须弥\");\n    if (effectData) await game.xjzl.api.effects.addEffect(actor, effectData.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "须弥镇邪",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "全回合动作",
                    "range": "1米",
                    "description": "<p>双掌摊开，掌藏须弥，对范围内所有敌人造成0.7内息点内功伤害。同时内劲如天空落雨般倾泻而下，可消耗X层“须弥”，在招式范围内形成‘小须弥天’，持续到战斗脱离。</p><p>小须弥天：区域内的敌人持续陷入下盘不稳，同时招式释放距离减少X米（至少1），移动速度减少X米（至少1）。</p>",
                    "automationNote": "伤害自动。脚本提示消耗层数，区域效果手动。",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "小须弥天",
                            "trigger": "hit_once",
                            "script": "const buff = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_xumi_stack\");\nif (buff) {\n    const stacks = buff.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"须弥镇邪\" },\n        content: `<p>是否消耗 ${stacks} 层须弥，展开小须弥天？</p>`,\n        ok: { label: \"展开\" }\n    });\n    if (confirm) {\n        await buff.delete();\n        ui.notifications.info(`已消耗 ${stacks} 层须弥。请手动放置【小须弥天】区域效果（敌人下盘不稳，减射程 ${Math.max(1, stacks)}，减速 ${Math.max(1, stacks)}）。`);\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "须弥",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "须弥神掌距离增加。",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_xumi_stack",
                        "stackable": true,
                        "maxStacks": 4
                    }
                }
            }
        ]
    },
    {
        "name": "阿难渡指",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技之一，阿难以此指法度化世人戾气，万佛僧众少有修炼，声名不显。</p><p>需求：徒手-指法，菩提院 属性：阴</p>",
            "requirements": "徒手-指法，菩提院",
            "moves": [
                {
                    "name": "相如满月",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>慈眉善目，开启架招，格挡成功后，减少攻击者1点怒气。</p>",
                    "automationNote": "格挡成功扣除攻击者怒气。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：渡化",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    // 兼容 Token 和 Actor 实例\n    const targetActor = args.attacker.actor || args.attacker;\n    const currentRage = targetActor.system.resources.rage.value || 0;\n    if (currentRage > 0) {\n        await targetActor.update({ \"system.resources.rage.value\": currentRage - 1 });\n        ui.notifications.info(\"相如满月：化解了对手 1 点怒气。\");\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "似净莲华",
                    "type": "real",
                    "damageType": "neigong",
                    "element": "yin",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "description": "<p>一指莲昙，幻化千万指虚影，对目标造成0.5内息点内功伤害，击中无架招目标后，减少其1点怒气。</p>",
                    "automationNote": "命中无架招自动扣怒。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "扣除怒气",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const r = args.target.system.resources.rage.value || 0;\n    if (r > 0) await args.target.update({ \"system.resources.rage.value\": r - 1 });\n}"
                        }
                    ]
                },
                {
                    "name": "佛法浩瀚",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "yin",
                    "actionCost": "反应动作",
                    "range": "2米",
                    "description": "<p>当你看破虚招时，可消耗反应动作施展此招，双手擒住目标武器，压制目标虚招，内力奔涌，对其造成0.6内息点内功伤害，然后减少其1点怒气。</p>",
                    "automationNote": "命中自动扣怒。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "扣除怒气",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const r = args.target.system.resources.rage.value || 0;\n    if (r > 0) await args.target.update({ \"system.resources.rage.value\": r - 1 });\n}"
                        }
                    ]
                },
                {
                    "name": "流入难心",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "yin",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "description": "<p>一指虚点目标心脏，造成0.6内息点内功伤害。若出招前目标没有怒气，造成后使其主动解除架招，然后为其添加“不怒”，持续一回合。</p><p>不怒：无法获得怒气。</p>",
                    "automationNote": "自动检测目标怒气，若为0则解除架招并施加不怒。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "绝气封架",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const currentRage = args.target.system.resources.rage.value || 0;\n    if (currentRage === 0) {\n        if (args.target.system.martial.stanceActive) {\n            await args.target.update({ \"system.martial.stanceActive\": false });\n            ui.notifications.info(`${args.target.name} 架招被迫解除！`);\n        }\n        const bunuEffect = CONFIG.statusEffects.find(e => e.id === \"bunu\");\n        if (bunuEffect) {\n            const data = foundry.utils.deepClone(bunuEffect);\n            data.duration = { rounds: 1 };\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "断烦刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛寺三大刀法之一，烦恼无尽，刀意无尽，敌方烦恼越重，受此刀意伤害越大。</p><p>·前三刀为地级武学，最后一刀为天级武学。</p><p>需求：刀-单刀，戒律院 属性：太极</p>",
            "requirements": "刀-单刀，戒律院",
            "moves": [
                {
                    "name": "无始无明",
                    "type": "stance",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "description": "<p>净心断念，开启架招。格挡成功后，使攻击者获得1点怒气。</p>",
                    "automationNote": "完全自动化。开启后若成功格挡（受击触发），脚本会自动检测并给予攻击者1点怒气。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "架招：增怒",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const r = args.attacker.system.resources.rage.value || 0;\n    const max = args.attacker.system.resources.rage.max || 10;\n    if (r < max) {\n        await args.attacker.update({ \"system.resources.rage.value\": r + 1 });\n        ui.notifications.info(`${args.attacker.name} 攻击被断烦刀法架住，怒气 +1`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "尘沙如海",
                    "type": "feint",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "蓄力动作",
                    "range": "2米",
                    "description": "<p>暴喝一声，刀法蕴含佛门金刚气劲，对扇形两米范围敌人造成0.4力量点内功伤害，击破目标架招时，明悟佛法如一，你可以消耗反应动作施展一次【万法如一】。</p><p>·招式虚招值提升你与对方怒气差值的数值。</p>",
                    "automationNote": "虚招值修正自动化（基于怒气差）。击破架招后的反应施展需玩家手动操作。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "虚招怒气修正",
                            "trigger": "check",
                            "script": "const myRage = actor.system.resources.rage.value || 0;\nconst targetRage = args.target.system.resources.rage.value || 0;\nconst diff = Math.abs(myRage - targetRage);\nargs.flags.grantFeint += diff;"
                        },
                        {
                            "label": "提示：触发万法如一",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"【尘沙如海】击破架招！你可立即消耗反应动作施展【万法如一】。\");\n}"
                        }
                    ]
                },
                {
                    "name": "见思妄念",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "taiji",
                    "actionCost": "反应动作",
                    "range": "3米",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作施展，压制目标虚招，刀斩妄念，一应清空，对目标造成0.6力量点内功伤害，若目标受伤后怒气大于5，则为其添加“自闭”，持续一回合。</p>",
                    "automationNote": "完全自动化。命中后脚本自动检测目标怒气，若大于5则自动施加【自闭】状态。",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "斩念自闭",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const r = args.target.system.resources.rage.value || 0;\n    if (r > 5) {\n        await game.xjzl.api.effects.toggleStatus(args.target, \"zibi\", true);\n        ui.notifications.info(`【见思妄念】检测到怒气过盛，目标 ${args.target.name} 陷入自闭！`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "万法如一",
                    "type": "real",
                    "isUltimate": true,
                    "tier": 3,
                    "damageType": "none",
                    "element": "taiji",
                    "actionCost": "全回合动作",
                    "range": "5米",
                    "description": "<p>横持佛刀，朗诵经文，将敌人烦恼通通斩断，无需命中，周围敌人失去等同于你消耗怒气数值的怒气。然后使周围敌人流失【失去怒气总数*10】点气血，而你回复相同数值的气血。</p>",
                    "automationNote": "【纯手动模式】系统仅辅助显示伤害系数。请GM或玩家：1.手动扣除自身怒气；2.手动调整敌方怒气；3.手动计算并应用流失伤害（失去怒气 * 系数）；4.手动回复自身气血。",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": []
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "scripts": [
                        {
                            "label": "系数提示",
                            "trigger": "attack",
                            "script": "args.flags.forceHit = true; // 设定必中\nconst lvl = args.move.computedLevel || 1;\nconst coef = 10 + (lvl - 1) * 5;\nui.notifications.info(`【万法如一】当前流失伤害系数为：${coef} (每点怒气)。请手动结算怒气消耗与伤害。`);"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "斩业刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛寺三大刀法之一，刀意沾染业力，可通因果。</p><p>·前四刀为地级武学，最后一刀为天级武学。</p>",
            "requirements": "刀-单刀，菩提院；属性：阳",
            "moves": [
                {
                    "name": "散业力",
                    "type": "stance",
                    "tier": 2,
                    "description": "<p>次要动作，刃对胸口，业力乍现，开启架招。格挡成功后，使目标获得一层“业力”，至多九层，持续到战斗脱离。</p><p><b>业力</b>：每层使招式伤害+10，出招后移除业力。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "格挡成功后自动给攻击者添加[业力]。",
                    "scripts": [
                        {
                            "label": "散业力-反击",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const yeli = thisItem.effects.getName('业力');\n    if (yeli) await game.xjzl.api.effects.addEffect(args.attacker, yeli.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "断善恶",
                    "type": "real",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 2,
                    "description": "<p>蓄力动作，善恶之举冥冥已定，刀光如虹，对周围敌人造成0.4力量点内功伤害。若命中目标存在业力，则削减其10点侠义值或恶行值（至少0）。</p><p>·侠义值、恶行值优先消耗其中数值较高的那个，若因此造成目标的侠恶标签产生变化，该目标心若惶惶，陷入定身，持续一回合。</p>",
                    "actionCost": "蓄力动作",
                    "range": "1米",
                    "targetInfo": "周围敌人",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "automationNote": "削减侠恶值及定身效果自动化。",
                    "scripts": [
                        {
                            "label": "断善恶-削减侠恶",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (!args.isHit) return;\nconst yeLi = target.effects.find(e => e.name === '业力');\nif (yeLi) {\n    const social = target.system.social;\n    let xiayi = social.xiayi || 0;\n    let exing = social.exing || 0;\n    const reduce = 10 + (Math.max(1, args.move.computedLevel || 1) - 1) * 10;\n    \n    const oldLabel = (xiayi >= 100 && exing <= 50) ? 'xia' : (exing >= 100 && xiayi <= 50 ? 'e' : 'none');\n\n    if (xiayi >= exing) {\n        xiayi = Math.max(0, xiayi - reduce);\n        await target.update({'system.social.xiayi': xiayi});\n        ui.notifications.info(`${target.name} 侠义值减少 ${reduce}`);\n    } else {\n        exing = Math.max(0, exing - reduce);\n        await target.update({'system.social.exing': exing});\n        ui.notifications.info(`${target.name} 恶行值减少 ${reduce}`);\n    }\n\n    const newLabel = (xiayi >= 100 && exing <= 50) ? 'xia' : (exing >= 100 && xiayi <= 50 ? 'e' : 'none');\n    if (oldLabel !== newLabel) {\n         await game.xjzl.api.effects.addEffect(target, 'stun');\n         ui.notifications.warn(`${target.name} 侠恶巨变，陷入定身！`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "断共己",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 2,
                    "description": "<p>次要动作，口诵真言，引天地生灵共业力，根据周围敌人存在的“业力”总层数，自己获得等量层数的“业力”，至多九层，持续到战斗脱离。</p>",
                    "actionCost": "次要动作",
                    "range": "1米",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "自动统计周围敌人业力并应用到自身。",
                    "scripts": [
                        {
                            "label": "断共己-获取业力",
                            "trigger": "attack",
                            "active": true,
                            "script": "const tokens = canvas.tokens.placeables.filter(t => t.actor && t.id !== actor.token?.id && canvas.grid.measureDistance(actor.token?.object || {}, t) <= (1 + (args.move.computedLevel-1)*2));\nlet totalStacks = 0;\nfor (const t of tokens) {\n    const yeLi = t.actor.effects.find(e => e.name === '业力');\n    if (yeLi) totalStacks += (yeLi.getFlag('xjzl-system', 'stacks') || 1);\n}\nif (totalStacks > 0) {\n    const effect = thisItem.effects.getName('业力');\n    if (effect) {\n        const data = effect.toObject();\n        delete data._id;\n        foundry.utils.setProperty(data, 'flags.xjzl-system.stacks', Math.min(9, totalStacks));\n        await game.xjzl.api.effects.addEffect(actor, data);\n        ui.notifications.info(`${actor.name} 获得 ${Math.min(9, totalStacks)} 层业力`);\n    }\n} else {\n    ui.notifications.warn('周围无业力存在');\n}"
                        }
                    ]
                },
                {
                    "name": "断引满",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 2,
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作施展，压制目标虚招，业力自生灭，无尽亦无终，对自身周围所有存在“业力”的敌人，造成等同于此次虚招伤害数值（不暴击）的内功伤害。</p>",
                    "actionCost": "反应动作",
                    "range": "1米",
                    "targetInfo": "周围敌人",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "手动选择目标，伤害数值需手动输入修正。",
                    "scripts": []
                },
                {
                    "name": "金刚斩业",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 3,
                    "description": "<p>-杀生为护生，斩业非斩人-</p><p>蓄力动作，刀光破空起，对周围敌人造成0.8力量点内功伤害，使具有“业力”的目标战斗脱离。</p><p>·战斗脱离后，怒气归零，相关状态消失。但是由于敌人依旧在场上，若无特殊情况，对方会重新进入战场，投掷先攻，按照结果决定他的行动顺序。</p>",
                    "actionCost": "蓄力动作",
                    "range": "3米",
                    "targetInfo": "周围敌人",
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "automationNote": "战斗脱离、怒气清空等需手动处理。",
                    "scripts": [
                        {
                            "label": "金刚斩业-提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.target.effects.find(e => e.name === '业力')) {\n    ChatMessage.create({content: `${args.target.name} 具有业力，应<b>脱离战斗</b>（怒气归零，状态消失）。请GM手动处理。`});\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "业力",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "每层使招式伤害+10，出招后移除业力。",
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "yeli",
                            "stackable": true,
                            "maxStacks": 9,
                            "scripts": [
                                {
                                    "label": "业力-出招后移除",
                                    "trigger": "hit",
                                    "active": true,
                                    "script": "if (thisEffect) await game.xjzl.api.effects.removeEffect(actor, thisEffect.id, 99);"
                                }
                            ]
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "除魔刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛寺三大刀法之一，刀斩天魔，金刚登天。</p><p>·前四刀为地级武学，最后一刀为天级武学。</p>",
            "requirements": "刀-单刀，达摩院；属性：阳",
            "moves": [
                {
                    "name": "不落妖邪",
                    "type": "stance",
                    "tier": 2,
                    "description": "<p>次要动作，佛法加持，刀身嗡嗡作响，开启架招，若成功格挡标签为[恶]的敌人的攻击，你可以消耗反应动作，对攻击者施展一次【怒目祛阴】。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "反击触发需手动判断敌人标签。",
                    "scripts": []
                },
                {
                    "name": "寂灭无恼",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 2,
                    "description": "<p>当你被敌人添加状态后，可消耗反应动作施展此招，心无外魔，立即移除该状态，同时获得10点护体真气，持续到战斗脱离。</p>",
                    "actionCost": "反应动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            3,
                            2,
                            1
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "移除状态需手动操作。护体真气自动增加。",
                    "scripts": [
                        {
                            "label": "寂灭无恼-加护体",
                            "trigger": "attack",
                            "active": true,
                            "script": "const huti = 10 + (Math.max(1, args.move.computedLevel || 1) - 1) * 10;\nawait actor.applyHealing({ amount: huti, type: 'huti' });\nui.notifications.info(`请手动移除一个负面状态。`);"
                        }
                    ]
                },
                {
                    "name": "怒目祛阴",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 2,
                    "description": "<p>主要动作，怒目一刀，当头直破而下，对目标造成0.5力量点外功伤害，击中无架招目标时为其添加“错骨”，持续三回合。</p>",
                    "actionCost": "主要动作",
                    "range": "2米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "automationNote": "自动判断架招并添加错骨。",
                    "scripts": [
                        {
                            "label": "怒目祛阴-错骨",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, 'cuogu');\n}"
                        }
                    ]
                },
                {
                    "name": "九幽退散",
                    "type": "counter",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 2,
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展，压制目标虚招，刀光乱舞，选择3米内的空格，不消耗速度直线冲向该空格，对沿途你周围1米内的敌人造成0.6力量点外功伤害，同时击退他们2米。</p>",
                    "actionCost": "反应动作",
                    "range": "3米",
                    "targetInfo": "路径敌人",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "automationNote": "移动与击退需手动。伤害计算自动化。",
                    "scripts": []
                },
                {
                    "name": "六天清净",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "blade",
                    "tier": 3,
                    "description": "<p>-万千佛法持，斩断自在天-</p><p>蓄力动作，刀光利芒，分割天地，对目标造成1.0力量点外功伤害。</p><p>你可以选择先不释放此招，而是到下个回合继续消耗蓄力动作后再释放，若如此，你每额外消耗一个蓄力动作，该招式获得以下可叠加的效果：</p><p>1：招式距离+16，招式伤害+50。</p><p>2：招式必然命中。</p><p>3：招式使目标陷入“眩晕”一回合。</p><p>4：招式伤害转化为精神伤害。</p><p>5：招式让目标额外进行一次死亡检定。</p>",
                    "actionCost": "蓄力动作",
                    "range": "8米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "automationNote": "需手动确认蓄力层数，脚本根据层数调整效果。额外死亡检定手动。",
                    "scripts": [
                        {
                            "label": "六天清净-蓄力效果",
                            "trigger": "attack",
                            "active": true,
                            "script": "const dialog = await foundry.applications.api.DialogV2.wait({\n window: { title: '六天清净-蓄力层数' },\n content: '<input type=\"number\" name=\"charges\" value=\"0\" min=\"0\" max=\"5\"/>',\n buttons: [{ action: 'ok', label: '确定', default: true, callback: (event, button) => button.form.elements.charges.value }]\n});\nconst charges = parseInt(dialog) || 0;\n\nif (charges >= 1) {\n    args.move.range = '24米';\n}\nif (charges >= 2) {\n    args.flags.bonusHit += 999;\n}\n// 将层数传给 hit 脚本处理后续效果\nargs.flags.charges = charges;"
                        },
                        {
                            "label": "六天清净-伤害数值修正",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (args.flags?.charges >= 1) args.output.damage += 50;"
                        },
                        {
                            "label": "六天清净-命中效果",
                            "trigger": "hit",
                            "active": true,
                            "script": "const charges = args.flags?.charges || 0;\nif (charges >= 3 && args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, 'xuanyun');\n}\nif (charges >= 5 && args.isHit) {\n    ChatMessage.create({content: `${args.target.name} 需进行额外死亡检定`});\n}"
                        },
                        {
                            "label": "六天清净-精神伤害转化",
                            "trigger": "preDamage",
                            "active": true,
                            "script": "if (args.flags?.charges >= 4) {\n    args.config.type = 'mental';\n    args.config.ignoreDefense = true;\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "神龙爪",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>万佛七十二绝技指功真谛。功成后手指坚硬逾钢，铁指开砖如泥，手如钢爪般抓树撕皮，搓石成粉，瞬间致敌于伤残。</p>",
            "requirements": "徒手-指法，达摩院；属性：阳",
            "moves": [
                {
                    "name": "乌龙探爪",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 2,
                    "description": "<p>主要动作，凝力于爪，对敌人造成0.5力量点外功伤害。</p><p>·若有人处于半空状态，你可以消耗反应动作释放此招，原地发出内劲隔空击敌，造成伤害。</p>",
                    "actionCost": "主要动作",
                    "range": "3米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "automationNote": "对空反应需手动。",
                    "scripts": []
                },
                {
                    "name": "双龙戏珠",
                    "type": "feint",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 2,
                    "description": "<p>主要动作，两臂前抓，造成0.4力量点外功伤害。击破对方架招时，将目标击飞三米。</p>",
                    "actionCost": "主要动作",
                    "range": "1米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "automationNote": "击飞效果需手动处理。",
                    "scripts": [
                        {
                            "label": "双龙戏珠-击飞",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) ChatMessage.create({content: `${args.target.name} 被击飞3米`});"
                        }
                    ]
                },
                {
                    "name": "气贯龙爪",
                    "type": "stance",
                    "tier": 2,
                    "description": "<p>次要动作，掌心向上，气喷指尖，开启架招。成功格挡时，给目标添加一层“愚钝”，至多三层，持续到战斗脱离。</p><p><b>愚钝</b>：每层使你的虚招对抗-1。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "格挡成功后自动给攻击者添加[愚钝]。",
                    "scripts": [
                        {
                            "label": "气贯龙爪-反击",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const yudun = thisItem.effects.getName('愚钝');\n    if (yudun) await game.xjzl.api.effects.addEffect(args.attacker, yudun.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "龙凤朝阳",
                    "type": "counter",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 2,
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，压制虚招并移动至目标周围空格，直臂抓探，对目标造成0.6力量点外功伤害。</p><p>·同时给对方添加“下盘不稳”，持续三回合。</p>",
                    "actionCost": "反应动作",
                    "range": "3米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "automationNote": "移动需手动。自动添加下盘不稳。",
                    "scripts": [
                        {
                            "label": "龙凤朝阳-下盘不稳",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, 'unstable');\n}"
                        }
                    ]
                },
                {
                    "name": "龙行乾坤",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 2,
                    "description": "<p>主要动作，龙腾移步，神爪探伸，造成0.8力量点外功伤害。</p><p>·若有人处于半空状态，你可以消耗反应动作释放此招，原地发出内劲隔空击敌，造成伤害。</p><p>·若目标存在“愚钝”，将其拉至身边空格击倒。</p>",
                    "actionCost": "主要动作",
                    "range": "5米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "automationNote": "拉人需手动。脚本检测愚钝并应用击倒。",
                    "scripts": [
                        {
                            "label": "龙行乾坤-愚钝检测",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.target.effects.find(e => e.name === '愚钝')) {\n    await game.xjzl.api.effects.addEffect(args.target, 'prone');\n    ChatMessage.create({content: `${args.target.name} 被拉至身边并击倒`});\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "愚钝",
                    "img": "icons/svg/daze.svg",
                    "description": "每层使你的虚招对抗-1。",
                    "changes": [
                        {
                            "key": "flags.xjzl-system.feintLevel",
                            "mode": 2,
                            "value": "-1"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "yudun",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "拈花指",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>“佛祖在灵山会上，拈花示众，是时众皆默然，唯迦叶尊者破颜微笑。”</p><p>注：学习拈花指后，直到自身突破生死玄关之前，无法再修炼其他万佛寺武学。</p>",
            "requirements": "徒手-指法，戒律院；属性：太极",
            "moves": [
                {
                    "name": "真如妙心",
                    "type": "stance",
                    "tier": 3,
                    "description": "<p>-纯净无染，无欲无贪-</p><p>主要动作，舒张放松，坦然自得，开启架招。获得“真如”，持续到解除架招或战斗脱离。</p><p><b>真如</b>：你的佛法检定结果+1，念诵佛经需求的回合减少一回合（至少需要1回合）。</p>",
                    "actionCost": "主要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "开启时自动获得[真如]。",
                    "scripts": [
                        {
                            "label": "真如妙心-获得真如",
                            "trigger": "attack",
                            "active": true,
                            "script": "const effect = thisItem.effects.getName('真如');\nif (effect) await game.xjzl.api.effects.addEffect(actor, effect.toObject());"
                        }
                    ]
                },
                {
                    "name": "心印心法",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>-一中无言，暗藏万法-</p><p>全回合动作，盘坐于地面（视作倒地），无言微笑，意态安详。</p><p>·范围内敌人不明何意，恼羞成怒，与你进行一次[佛法]对抗，若敌人失败，主动解除架招。</p><p>·范围内其他友方心领神会，各自获得一层“劲力”和一层“武器势”，均至多三层。</p>",
                    "actionCost": "全回合动作",
                    "range": "2米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "提供友方BUFF AE以供手动添加。倒地、敌方对抗手动。",
                    "scripts": []
                },
                {
                    "name": "如来拈花",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>-世尊拈花，迦叶微笑-</p><p>主要动作，指端凝出佛花，绽放金光，劲射而出，对敌人造成0.7内息点内功伤害。</p><p>·若目标无架招，则陷入“点穴”（冲穴难度16）状态，持续三回合。</p>",
                    "actionCost": "主要动作",
                    "range": "10米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            4,
                            3,
                            2,
                            1
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "automationNote": "自动判定无架招并添加点穴。",
                    "scripts": [
                        {
                            "label": "如来拈花-点穴",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const dianxue = CONFIG.statusEffects.find(e => e.id === 'dianxue');\n    if (dianxue) await game.xjzl.api.effects.addEffect(args.target, { ...dianxue, duration: { rounds: 3 } });\n    ui.notifications.info(`点穴冲穴难度: ${16 + (args.move.computedLevel-1)*2}`);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "真如",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "佛法检定+1，念经回合-1。",
                    "changes": [
                        {
                            "key": "system.arts.fofa.checkMod",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "劲力",
                    "img": "icons/svg/combat.svg",
                    "description": "每层提高招式伤害5点。",
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "5"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "jinli",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    }
                },
                {
                    "name": "武器势",
                    "img": "icons/svg/combat.svg",
                    "description": "每层使命中+10。",
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "10"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "10"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuqishi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "涤瑕杖法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>北宋一无名扫地僧所创，起初众人只当修禅法门，纳入藏经阁。直到万佛朝宗，后人才看出竟蕴含一门刚猛无匹的棍法，可扫荡乾坤，涤清天下。</p>",
            "requirements": "棍-长棍；属性：刚",
            "moves": [
                {
                    "name": "理秽清垢",
                    "type": "feint",
                    "damageType": "waigong",
                    "element": "gang",
                    "weaponType": "staff",
                    "tier": 3,
                    "description": "<p>-涤拂除秽，宇宙载清-</p><p>主要动作，帚柄击穴，外劲入内，对目标造成0.6力量点外功伤害。命中无架招目标时，可选择对方身上的一种状态移除，并为他添加一层“秽”，至多三层，持续到战斗脱离。</p><p><b>秽</b>：受到伤害时，每层使自身流失10气血。</p>",
                    "actionCost": "主要动作",
                    "range": "3米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "automationNote": "移除状态需手动。添加[秽]自动化。",
                    "scripts": [
                        {
                            "label": "理秽清垢-添加秽",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const huiProto = thisItem.effects.getName('秽');\n    if (huiProto) {\n        const huiData = huiProto.toObject();\n        huiData.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.target, huiData);\n    }\n    ui.notifications.info('请手动移除目标一个状态');\n}"
                        }
                    ]
                },
                {
                    "name": "持守灵台",
                    "type": "stance",
                    "tier": 3,
                    "description": "<p>-清规在心 凡尘不染-</p><p>次要动作，持帚颂佛，圆融不侵，开启架招。格挡成功后，为攻击者添加一层“秽”，至多三层，持续到战斗脱离。</p><p>·若目标身上已经存在“秽”，每有一层，格挡成功后自身还会回复10点内力。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "格挡成功后自动给攻击者添加[秽]，自动回内。",
                    "scripts": [
                        {
                            "label": "持守灵台-反击",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args) && args.attacker) {\n    const huiProto = thisItem.effects.getName('秽');\n    if (huiProto) {\n        const huiData = huiProto.toObject();\n        huiData.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.attacker, huiData);\n    }\n    const attackerHui = args.attacker.effects.find(e => e.name === '秽');\n    if (attackerHui) {\n        const stacks = attackerHui.getFlag('xjzl-system', 'stacks') || 1;\n        // 回复自身内力\n        await actor.applyHealing({amount: stacks * 10, type: 'mp', showScrolling: true});\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "棍扫无心",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "gang",
                    "weaponType": "staff",
                    "tier": 3,
                    "description": "<p>-心量缘起，无风起浪-</p><p>主要动作，尾端轻扫，力逾千钧，对目标造成0.7力量点外功伤害，并击退目标2米，若目标因此撞击到障碍物或其他角色，则可选择目标和受撞击角色身上的一种状态移除，并为移除状态者添加一层“秽”，至多三层，持续到战斗脱离。</p>",
                    "actionCost": "主要动作",
                    "range": "3米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "automationNote": "击退及后续碰撞效果(移除状态、添加秽)需手动处理。",
                    "scripts": []
                },
                {
                    "name": "观尘六净",
                    "type": "counter",
                    "damageType": "waigong",
                    "element": "gang",
                    "weaponType": "staff",
                    "tier": 3,
                    "description": "<p>-圆转如意，万法不侵-</p><p>当你看破虚招后，可消耗反应动作释放此招，压制虚招，握棍上段，以尾扫顶，对目标造成0.8力量点外功伤害，同时，目标需进行[定力]检定（难度=10+其身上“秽”层数*2），若失败，则心神失守，陷入“走火入魔”，持续一回合。</p>",
                    "actionCost": "反应动作",
                    "range": "4米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "automationNote": "自动发起定力检定，失败自动应用走火入魔。",
                    "scripts": [
                        {
                            "label": "观尘六净-定力检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "const hui = args.target.effects.find(e => e.name === '秽');\nconst stacks = hui ? (hui.getFlag('xjzl-system', 'stacks') || 1) : 0;\n// 检定难度 = 10 + 层数*2 + 招式等级成长(升级检定难度+1)\n// 招式等级从1开始，所以是 (level-1)\nconst dc = 10 + (stacks * 2) + (args.move.computedLevel - 1);\n\nconst rageProto = CONFIG.statusEffects.find(e => e.id === 'rage');\nif (rageProto) {\n    const rageData = foundry.utils.deepClone(rageProto);\n    rageData.name = '走火入魔'; // 确保名字正确\n    rageData.duration = { rounds: 1 };\n    \n    await Macros.requestSave({\n        target: args.target,\n        type: 'dingli',\n        dc: dc,\n        label: '抵抗走火入魔',\n        attacker: actor,\n        onFail: rageData\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "诸法清净",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "gang",
                    "weaponType": "staff",
                    "tier": 3,
                    "description": "<p>-泽佑苍生，功齐百灵-</p><p>蓄力动作，扫净污秽，荡涤一空，对范围内敌人造成1.0力量点外功伤害，场上每有一层“秽”，招式伤害+10，之后移除全场所有的“秽”。</p><p>·若移除秽的层数≥7，则给予自己和其他范围内的友方“清净”状态，持续到战斗脱离。</p><p><b>清净</b>：免疫敌人添加的人级、地级状态。</p>",
                    "actionCost": "蓄力动作",
                    "range": "5米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "automationNote": "根据场上秽层数增加伤害并移除。提供[清净]AE以供手动添加。",
                    "scripts": [
                        {
                            "label": "诸法清净-计算加成",
                            "trigger": "calc",
                            "active": true,
                            "script": "let totalStacks = 0;\n// 遍历场景内所有 Token\ncanvas.tokens.placeables.forEach(t => {\n    if (t.actor) {\n        const hui = t.actor.effects.find(e => e.name === '秽');\n        if (hui) totalStacks += (hui.getFlag('xjzl-system', 'stacks') || 1);\n    }\n});\nargs.output.damage += totalStacks * 10;\nif (totalStacks > 0) {\n    args.output.bonusDesc.push(`吞噬 ${totalStacks} 层秽，伤害+${totalStacks*10}`);\n}"
                        },
                        {
                            "label": "诸法清净-移除与Buff",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "let removed = 0;\n// 再次遍历移除\nfor (const t of canvas.tokens.placeables) {\n    if (t.actor) {\n        const hui = t.actor.effects.find(e => e.name === '秽');\n        if (hui) {\n            removed += (hui.getFlag('xjzl-system', 'stacks') || 1);\n            await hui.delete();\n        }\n    }\n}\nif (removed >= 7) {\n    ui.notifications.info(`移除了 ${removed} 层秽，请手动给范围内的友方添加 [清净] 状态。`);\n    // 自动给自己加上\n    const qingjingProto = thisItem.effects.getName('清净');\n    if (qingjingProto) {\n        await game.xjzl.api.effects.addEffect(actor, qingjingProto.toObject());\n    }\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "秽",
                    "img": "icons/svg/acid.svg",
                    "description": "受到伤害时，每层使自身流失10气血。",
                    "changes": [],
                    "flags": {
                        "xjzl-system": {
                            "slug": "hui",
                            "stackable": true,
                            "maxStacks": 3,
                            "scripts": [
                                {
                                    "label": "秽-受击流失",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "if (args.type === 'liushi') return;\n\nconst stacks = thisEffect.getFlag('xjzl-system', 'stacks') || 1;\nconst loss = stacks * 10;\n\nif (loss > 0) {\n    ChatMessage.create({\n         content: `<div style=\"padding:5px; border:1px solid #555; background:#eee; color:#333; text-align:center;\"><b>${actor.name}</b> 污秽缠身，气血流失 ${loss}！</div>`,\n         speaker: ChatMessage.getSpeaker({ actor: actor })\n    });\n    await actor.applyDamage({ amount: loss, type: 'liushi', isHit: true, ignoreDefense: true });\n}"
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "清净",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "免疫敌人添加的人级、地级状态。",
                    "changes": [],
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingjing",
                            "stackable": false
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "如来神掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "wuxue",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>万佛寺普渡众生流传千年的秘藏武学。掌法共分九式，每式皆有【佛器】守护。</p>",
            "requirements": "徒手，菩提院；属性：阳",
            "moves": [
                {
                    "name": "第一式-佛光乍现",
                    "type": "real",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>主要动作，诸法所生，为心所现。掌放光芒对敌人造成0.6力量点内功伤害。若目标无架招，需进行[定力]检定（难度18），失败则走火入魔，持续一回合。</p>",
                    "actionCost": "主要动作",
                    "range": "10米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "automationNote": "自动判定无架招并请求检定。",
                    "scripts": [
                        {
                            "label": "佛光乍现-定力检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const rage = CONFIG.statusEffects.find(e => e.id === 'rage');\n    await Macros.requestSave({\n        target: args.target,\n        type: 'dingli',\n        dc: 18,\n        label: '抵抗走火入魔',\n        attacker: actor,\n        onFail: rage ? { ...rage, duration: { rounds: 1 } } : null\n    });\n}"
                        }
                    ]
                },
                {
                    "name": "第二式-佛动山海",
                    "type": "counter",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，裂地成沟，倒山破海，压制虚招并对目标造成0.7力量点内功伤害，同时将目标击倒。若目标为[恶][邪]，招式伤害提升30点。</p>",
                    "actionCost": "反应动作",
                    "range": "5米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "automationNote": "自动检测恶邪标签增加伤害。击倒效果自动化。",
                    "scripts": [
                        {
                            "label": "佛动山海-恶邪加伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const target = args.target || Array.from(game.user.targets)[0]?.actor;\nif (target) {\n    const s = target.system.social;\n    const isEvil = (s.exing >= 100 && s.xiayi <= 50);\n    if (isEvil) args.output.damage += 30;\n}"
                        },
                        {
                            "label": "佛动山海-击倒",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, 'prone');\n}"
                        }
                    ]
                },
                {
                    "name": "第三式-如来叩心",
                    "type": "feint",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>主要动作，结印拍掌，口诵浩瀚梵音，对目标造成0.6力量点内功伤害。击破架招时，使目标陷入“封招”，持续一回合。</p>",
                    "actionCost": "主要动作",
                    "range": "3米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "automationNote": "击破架招自动添加封招。",
                    "scripts": [
                        {
                            "label": "如来叩心-封招",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    const fengzhao = CONFIG.statusEffects.find(e => e.id === 'fengzhao');\n    if (fengzhao) await game.xjzl.api.effects.addEffect(args.target, { ...fengzhao, duration: { rounds: 1 } });\n}"
                        }
                    ]
                },
                {
                    "name": "第四式-佛法无边",
                    "type": "stance",
                    "tier": 3,
                    "description": "<p>次要动作，释放佛力，光华普照，开启架招。成功格挡时获得“如来”，持续三回合。如来：《如来神掌》的命中、招式伤害+5；你的[佛法]检定结果+5。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "格挡成功后自动获得[如来]。",
                    "scripts": [
                        {
                            "label": "佛法无边-如来",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args)) {\n    const rulai = thisItem.effects.getName('如来');\n    if (rulai) await game.xjzl.api.effects.addEffect(actor, rulai.toObject());\n}"
                        }
                    ]
                },
                {
                    "name": "第五式-万佛归宗",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>蓄力动作，结一切明印，众生皆可成佛，周围5米范围内敌人进行一次气感检定（难度15），失败目标不愿再造杀孽，主动脱离战斗。</p>",
                    "actionCost": "蓄力动作",
                    "range": "5米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "自动发起气感检定。脱离战斗需手动。",
                    "scripts": [
                        {
                            "label": "万佛归宗-检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "await Macros.requestSave({\n    target: args.target,\n    type: 'qigan',\n    dc: 15 + (args.move.computedLevel-1)*5,\n    label: '万佛归宗-意志判定',\n    attacker: actor,\n    onFail: null\n});\nui.notifications.info('若检定失败，请GM处理脱离战斗逻辑。');"
                        }
                    ]
                },
                {
                    "name": "第六式-如来下凡",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>蓄力动作，以泰山压顶之势一掌击出，对10米范围内所有敌人造成1.0力量点内功伤害。若目标为[恶][邪]，需进行[定力]检定（难度18），失败则走火入魔，持续一回合。</p>",
                    "actionCost": "蓄力动作",
                    "range": "10米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "automationNote": "自动检测恶邪并请求检定。",
                    "scripts": [
                        {
                            "label": "如来下凡-恶邪检定",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const s = args.target.system.social;\n    const isEvil = (s.exing >= 100 && s.xiayi <= 50);\n    if (isEvil) {\n        const rage = CONFIG.statusEffects.find(e => e.id === 'rage');\n        await Macros.requestSave({\n            target: args.target,\n            type: 'dingli',\n            dc: 18,\n            label: '抵抗走火入魔',\n            attacker: actor,\n            onFail: rage ? { ...rage, duration: { rounds: 1 } } : null\n        });\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "第七式-迎佛出世",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>主要动作，双手朝天，拱天卫地。施展此招后，获得“飞升”，持续两回合。</p><p><b>飞升</b>：漂浮于三米高的半空中，无法被击飞、击退、击倒，并获得30点格挡值。你的普通攻击距离+10米，目标在你周围十米范围内移动时，你都可以不消耗动作对其施展《趁虚而入》。</p>",
                    "actionCost": "主要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "自动应用[飞升]。趁虚而入逻辑需手动关注。",
                    "scripts": [
                        {
                            "label": "迎佛出世-飞升",
                            "trigger": "attack",
                            "active": true,
                            "script": "const feisheng = thisItem.effects.getName('飞升');\nif (feisheng) {\n    const dur = 2 + (args.move.computedLevel-1);\n    const extraBlock = (args.move.computedLevel-1) * 30;\n    const data = feisheng.toObject();\n    data.duration.rounds = dur;\n    const blockChange = data.changes.find(c => c.key === 'system.combat.block');\n    if (blockChange) blockChange.value = String(30 + extraBlock);\n    await game.xjzl.api.effects.addEffect(actor, data);\n}"
                        }
                    ]
                },
                {
                    "name": "第八式-超度众生",
                    "type": "real",
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>全回合动作，佛光汹涌澎湃，荡涤天地。对范围内所有敌人造成0.4力量+0.4内息点内功伤害，并将所有无架招敌人击倒，并添加“封招”持续一回合。</p>",
                    "actionCost": "全回合动作",
                    "range": "10米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            10,
                            20,
                            30,
                            40
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "automationNote": "自动检测无架招并应用击倒封招。",
                    "scripts": [
                        {
                            "label": "超度众生-控制",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial?.stanceActive) {\n    const prone = CONFIG.statusEffects.find(e => e.id === 'prone');\n    const fengzhao = CONFIG.statusEffects.find(e => e.id === 'fengzhao');\n    if (prone) await game.xjzl.api.effects.addEffect(args.target, prone);\n    if (fengzhao) await game.xjzl.api.effects.addEffect(args.target, { ...fengzhao, duration: { rounds: 1 } });\n}"
                        }
                    ]
                },
                {
                    "name": "最终式-我佛慈悲",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>主要动作，天外有天，浩瀚无边。你扣除自身全部气血和内力（至少500），进行一次无其他加值的死亡检定。无论你是否死亡，都将立即超度在场所有敌方，对他们造成0.9力量+0.9内息点内功伤害。如果目标因此而陷入濒死，且标签为【大恶】或【极恶】，则直接进行死亡检定。</p>",
                    "actionCost": "主要动作",
                    "range": "10米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            10,
                            9,
                            8,
                            7
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.9
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "automationNote": "自杀逻辑、敌方死亡检定需脚本支持。",
                    "scripts": [
                        {
                            "label": "我佛慈悲-献祭",
                            "trigger": "attack",
                            "active": true,
                            "script": "const hp = actor.system.resources.hp.value;\nconst mp = actor.system.resources.mp.value;\nif (hp + mp < 500) {\n    ui.notifications.warn('气血内力总和不足500，无法施展');\n    args.flags.abort = true;\n    return;\n}\nawait actor.update({'system.resources.hp.value': 0, 'system.resources.mp.value': 0});\nawait ChatCardManager._rollDeathSave(actor);"
                        },
                        {
                            "label": "我佛慈悲-超度",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isDying) {\n    ui.notifications.info(`${args.target.name} 濒死，请GM判断是否直接进行死亡检定(大恶极恶)`);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "如来",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "如来神掌命中/伤害+5，佛法+5。",
                    "changes": [
                        {
                            "key": "system.arts.fofa.checkMod",
                            "mode": 2,
                            "value": "5"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "rulai",
                            "stackable": false
                        }
                    }
                },
                {
                    "name": "飞升",
                    "img": "icons/svg/wing.svg",
                    "description": "漂浮半空，免疫击飞/击退/击倒，格挡+30，普攻距离+10。",
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "30"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "feisheng",
                            "stackable": false
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "释迦佛印",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>如来神掌源于释迦牟尼一生所悟的大智大慧，但后人依靠佛器参悟如来神掌时，始终缺其原始真韵。更有传闻说施展印诀后，如来神掌方显真正威力。</p>",
            "requirements": "徒手-指法，达摩院；属性：阳",
            "moves": [
                {
                    "name": "禅定印",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>次要动作，如果你已开启佛门架招，你移除视野范围内一个目标的状态（下盘不稳、倒地、禁足、缚身、封招、点穴、眩晕、自闭）。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "移除状态需手动。",
                    "scripts": []
                },
                {
                    "name": "与愿印",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>次要动作，下次施展佛门招式时，自身可以选择获得以下一个效果：1.吸血 2.状态延长 3.必中 4.检定+3。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "需手动记录选择并应用下一次效果。",
                    "scripts": []
                },
                {
                    "name": "无畏印",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>次要动作，选择范围内一个目标获得“无畏”：目标下一次受到招式攻击时，只承受50%的伤害，而你自己流失与他受到伤害相同数值的气血。</p>",
                    "actionCost": "次要动作",
                    "range": "20米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "提供[无畏]AE，分摊伤害逻辑需手动。",
                    "scripts": []
                },
                {
                    "name": "说法印",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>次要动作，你获得“说法”：你的虚招对抗+2，在你施展完一式佛门招式之后消失。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "自动应用说法BUFF。",
                    "scripts": [
                        {
                            "label": "说法印-添加说法",
                            "trigger": "attack",
                            "active": true,
                            "script": "const shuofa = thisItem.effects.getName('说法');\nif (shuofa) {\n    const data = shuofa.toObject();\n    data.changes[0].value = String(2 + (args.move.computedLevel-1));\n    await game.xjzl.api.effects.addEffect(actor, data);\n}"
                        }
                    ]
                },
                {
                    "name": "降魔印",
                    "type": "qi",
                    "actionType": "default",
                    "tier": 3,
                    "description": "<p>次要动作，你下一次施展佛门武学时，招式伤害提升悟性*1的数值。</p>",
                    "actionCost": "次要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "automationNote": "手动应用伤害加成。",
                    "scripts": []
                },
                {
                    "name": "法界虚空金刚印",
                    "type": "real",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>主要动作，对目标造成0.7力量点外功伤害。若你运行佛门内功，招式必定造成暴击。</p>",
                    "actionCost": "主要动作",
                    "range": "5米",
                    "targetInfo": "单体",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "automationNote": "需手动确认是否运行佛门内功以触发暴击。",
                    "scripts": []
                },
                {
                    "name": "如意千手观音印",
                    "type": "stance",
                    "tier": 3,
                    "description": "<p>主要动作，开启架招，立即获得2点怒气，同时进入“千手观音”姿态，持续到被击破架招或者战斗脱离。</p><p><b>千手观音</b>：你无需遵循武学套路切换调息的规则。</p>",
                    "actionCost": "主要动作",
                    "range": "自身",
                    "targetInfo": "自身",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "automationNote": "开启时自动回怒。",
                    "scripts": [
                        {
                            "label": "千手观音-回怒",
                            "trigger": "attack",
                            "active": true,
                            "script": "await actor.update({'system.resources.rage.value': Math.min(10, actor.system.resources.rage.value + 2)});"
                        }
                    ]
                },
                {
                    "name": "降世不动明王印",
                    "type": "feint",
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>主要动作，罡风四散，对周围至多2个目标造成0.7力量点外功伤害。击破架招后，使目标陷入眩晕，持续一回合。</p>",
                    "actionCost": "主要动作",
                    "range": "5米",
                    "targetInfo": "至多2目标",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "automationNote": "击破架招自动添加眩晕。",
                    "scripts": [
                        {
                            "label": "不动明王-眩晕",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, 'xuanyun');\n}"
                        }
                    ]
                },
                {
                    "name": "天鼓雷音如来印",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "waigong",
                    "element": "yang",
                    "weaponType": "unarmed",
                    "tier": 3,
                    "description": "<p>蓄力动作，向周围敌人打出寂灭之掌，造成1.0力量点外功伤害。同时自身获得“佛印”状态：提升所有佛门武学招式伤害30点，持续到战斗脱离。</p>",
                    "actionCost": "蓄力动作",
                    "range": "5米",
                    "targetInfo": "群体",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "automationNote": "自动添加佛印BUFF。",
                    "scripts": [
                        {
                            "label": "如来印-佛印BUFF",
                            "trigger": "attack",
                            "active": true,
                            "script": "const foyin = thisItem.effects.getName('佛印');\nif (foyin) {\n    const data = foyin.toObject();\n    data.changes[0].value = String(30 + (args.move.computedLevel-1)*10);\n    await game.xjzl.api.effects.addEffect(actor, data);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "说法",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "虚招对抗+2。",
                    "changes": [
                        {
                            "key": "flags.xjzl-system.feintLevel",
                            "mode": 2,
                            "value": "1"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "shuofa",
                            "stackable": false
                        }
                    }
                },
                {
                    "name": "佛印",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "佛门招式伤害+30。",
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "30"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "foyin",
                            "stackable": false
                        }
                    }
                },
                {
                    "name": "无畏",
                    "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                    "description": "下次受到伤害只承受50%，施法者承受等量流失。",
                    "changes": [],
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuwei",
                            "stackable": false
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "礼佛诵经",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 1,
            "description": "<p>此乃灭障消灾，增加福慧之殊胜法门，每一位佛教<br>弟子都会向佛虔敬礼拜，歌颂佛德。</p>",
            "requirements": "需求：《阿含功》修炼圆满",
            "moves": [
                {
                    "name": "诵经",
                    "type": "qi",
                    "actionType": "default",
                    "damageType": "none",
                    "range": "自身",
                    "description": "<p>·你的[佛法]等级+1。<br>·每日一次，在佛像前低头鞠躬，跪拜礼佛，然后<br>成功念诵任意一篇佛经后，自身及周围能听到诵经<br>的目标，减少 10 点杀戮值。<br>升级：诵经减少的杀戮值再+5。</p>",
                    "automationNote": "佛法等级+1已通过被动特效实现。点击招式执行减少自身杀戮值。每日次数需手动记录。",
                    "calculation": {
                        "base": 10,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "减少杀戮",
                            "trigger": "hit",
                            "script": "const amount = args.damageResult.finalDamage || 10;\nconst current = actor.system.resources.shalu.value;\nconst newVal = Math.max(0, current - amount);\nawait actor.update({'system.resources.shalu.value': newVal});\nui.notifications.info(`${actor.name} 虔诚诵经，杀戮值减少 ${amount} 点。`);",
                            "active": true
                        }
                    ]
                }
            ],
            "scripts": []
        },
        "effects": [
            {
                "name": "礼佛诵经-佛法加持",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "佛法等级+1。",
                "changes": [
                    {
                        "key": "system.arts.fofa.mod",
                        "mode": 2,
                        "value": "1"
                    }
                ],
                "transfer": true
            }
        ]
    },
    {
        "name": "无极大悲咒",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 2,
            "description": "<p>-无极无我总有法，大慈大悲方为佛-</p>",
            "requirements": "需求：徒手，戒律院 属性：太极",
            "moves": [
                {
                    "name": "无极大悲咒",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "5",
                    "description": "<p>蓄力动作，对周围范围内所有敌人造成 0.3 力量<br>+0.3 内息点内功伤害，击飞所有无架招目标。<br>·每击中一个目标，回复自身气血 5 点。<br>·每场战斗只能使用一次。<br>升级：招式伤害提高 20 点，每击中一个目标回复<br>的气血+5。</p>",
                    "automationNote": "击中回血已自动化。击飞效果与战斗次数限制需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            25,
                            25,
                            25
                        ],
                        "rage": [
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击中回血",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, args.move.computedLevel || 1);\nconst healAmount = 5 + (lvl - 1) * 5;\nif (args.isHit) {\n    await args.attacker.applyHealing({ amount: healAmount, type: 'hp', showScrolling: true });\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "闭口禅",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>“所谓是开口即罪，闭口是禅，心亦有所悟，方行<br>闭口禅，闭之人口，方得大果。”闭口禅是万佛寺<br>苦修摒除口业之法，可消罪免灾，速得解脱。</p>",
            "requirements": "需求：《金刚不坏神功》修炼圆满",
            "moves": [
                {
                    "name": "禅默 (状态)",
                    "type": "qi",
                    "actionType": "default",
                    "range": "自身",
                    "description": "<p>修炼此功时你不可以说话，需自备一小木牌，上写<br>“止语”二字，遇人欲与己言谈，则出示该木牌。<br>口闭心沉：你每修炼闭口禅一日，便在第二日凌晨<br>获得“闭口值”1 点，闭口值持续累计，直到你主<br>动开口说话时，移除所有闭口值。<br>万籁皆胜：闭口值每累积 360 点（一年 360 天），<br>你获得一层“禅默”，至多十层，禅默不会被其他<br>武功移除或转移。<br>禅默：每层使你的[佛法]检定结果+1；当你因出招<br>而破功时，每层禅默使该招式伤害提升 30 点。<br>·你可以移除禅默，使丹田获得 2100 点修为。<br>破功：主动开口说话，叙述、提醒、辩解、问好<br>时，闭口禅破功，闭口值归零，同时移除禅默。<br>·你受惊时被迫发出的不带有叙述、提醒、辩解的<br>呼喝或惊叫，不属于主动说话，不会破功。<br>·修闭口禅极为枯燥，需要大毅力方能坚持，你每<br>月初需进行一次[定力]检定难度 11，成功你忍住<br>没寻人说话；失败则放弃修禅，疯癫自语，破功。<br>升级：你每月进行破功的[定力]检定结果+2。<br>移除禅默获得的修为+500。</p>",
                    "automationNote": "点击可给自身添加【禅默】状态，每层佛法检定+1。层数叠加、闭口值记录、破功及移除修为需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用禅默",
                            "trigger": "hit",
                            "script": "const effectData = thisItem.effects.getName('禅默')?.toObject();\nif (effectData) {\n    delete effectData._id;\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "禅默",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "每层使[佛法]检定结果+1。破功时消耗所有层数增加伤害。",
                "changes": [
                    {
                        "key": "system.arts.fofa.checkMod",
                        "mode": 2,
                        "value": "1"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "stackable": true,
                        "slug": "chanmo",
                        "maxStacks": 10
                    }
                },
                "transfer": false
            }
        ]
    },
    {
        "name": "持戒修法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>不持戒而修三昧者，尘不可出，<br>纵有多智禅定现前，亦落外道。<br>——《楞严经》<br>此乃戒律院高僧秘传，用于警醒自身恪守万佛十<br>戒，你持戒严谨，参禅、练武、念佛、讲经时，无<br>不具现自身佛法。</p>",
            "requirements": "需求：《枯荣神功》修炼圆满",
            "moves": [
                {
                    "name": "弘扬佛法 (被动)",
                    "type": "qi",
                    "actionType": "default",
                    "damageType": "none",
                    "range": "自身",
                    "description": "<p>弘扬佛法：<br>[佛法]等级低于你的敌人对你造成的伤害-5；<br>你对[佛法]等级低于你的目标的说服检定结果+1。<br>·阅读僧人书籍时，每月额外增长 100 修为进度。<br>审戒忏悔：<br>当你触犯万佛寺门规时，可以立即盘坐忏悔，<br>你每消耗 2500 修为，可抵消 1 点武林声望降低。<br>（触犯门规扣除的声望数值通常由主持人裁定。）<br>升级：弘扬佛法中，敌人对你造成的伤害再-5，说<br>服检定额外+1,每月增长修为+50；审戒忏悔中，抵<br>消声望消耗的修为减少 500 点。</p>",
                    "automationNote": "对低佛法敌人的伤害减免已自动化。说服检定加成与审戒忏悔需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用持戒修法",
                            "trigger": "hit",
                            "script": "const effectData = thisItem.effects.getName('持戒修法')?.toObject();\nif (effectData) {\n    delete effectData._id;\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "持戒修法",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "若攻击者[佛法]等级低于你，其造成的伤害减少。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "chijiexiufa",
                        "scripts": [
                            {
                                "label": "弘扬佛法减伤",
                                "trigger": "preTake",
                                "script": "if (!attacker) return;\n// 动态获取招式等级\nconst move = thisItem.system.moves.find(m => m.name.includes('弘扬佛法'));\nconst lvl = move ? (move.computedLevel || 1) : 1;\n// 比较佛法等级\nconst myFofa = actor.system.arts?.fofa?.total || 0;\nconst enemyFofa = attacker.system.arts?.fofa?.total || 0;\n\nif (enemyFofa < myFofa) {\n    const reduction = 5 + (lvl - 1) * 5;\n    output.damage = Math.max(0, output.damage - reduction);\n}",
                                "active": true
                            }
                        ]
                    }
                }
            }
        ]
    },
    {
        "name": "易筋经",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>脱换者，易筋是也。此功由达摩所创，与洗髓经一<br>同被发现。修习可改变筋骨，通过修炼丹田内力打<br>通全身经络。易筋经分内壮、外壮两阶段。内壮言<br>坚、外壮言勇。</p>",
            "requirements": "需求：《洗髓经》修炼圆满后直接领悟",
            "moves": [
                {
                    "name": "内壮篇 (被动)",
                    "type": "qi",
                    "actionType": "default",
                    "description": "<p>【金刚之体】：你的内外功防御+5。<br>【意行意止】：你的气血内力充沛而自主周转，每<br>回合末回复 5 气血，5 内力。</p>",
                    "automationNote": "防御加成、回合末回复均已通过特效自动化。请点击应用。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用内壮篇",
                            "trigger": "hit",
                            "script": "const effectData = thisItem.effects.getName('易筋经-内壮')?.toObject();\nif (effectData) {\n    delete effectData._id;\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "外壮篇 (被动)",
                    "type": "qi",
                    "actionType": "default",
                    "requirements": "需求：修为 3000",
                    "description": "<p>【守中积气】：以任何形式获得的修为提高 1 成。<br>【坚筋劲膜】：你冲击第一关、第二关、第三关经<br>脉穴位的难度-2。</p>",
                    "automationNote": "修为获取加成与经脉冲击难度需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            3000
                        ]
                    }
                }
            ]
        },
        "effects": [
            {
                "name": "易筋经-内壮",
                "icon": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
                "description": "内外功防御+5，回合末回复气血/内力。",
                "transfer": false,
                "changes": [
                    {
                        "key": "system.combat.def_waigong",
                        "mode": 2,
                        "value": "5"
                    },
                    {
                        "key": "system.combat.def_neigong",
                        "mode": 2,
                        "value": "5"
                    },
                    {
                        "key": "flags.xjzl-system.regenHpTurnEnd",
                        "mode": 2,
                        "value": "5"
                    },
                    {
                        "key": "flags.xjzl-system.regenMpTurnEnd",
                        "mode": 2,
                        "value": "5"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "yijinjing_neizhuang"
                    }
                }
            }
        ]
    },
    {
        "name": "擒龙控鹤功",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/万佛.png",
        "system": {
            "category": "sanshou",
            "sect": "wanfosi",
            "tier": 3,
            "description": "<p>万佛绝学，乃江湖上一等一的神奇功法，可隔空取<br>物、擒拿敌人，因需要极深内力，鲜有人能修成。</p>",
            "requirements": "需求：徒手 属性：太极",
            "moves": [
                {
                    "name": "擒龙控鹤",
                    "type": "qi",
                    "actionType": "attack",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "2",
                    "description": "<p>主要动作，虚空一抓，将目标物体摄入手中。若目<br>标物体是敌人，你需要与目标进行[渡气]对抗，若<br>你胜利，则将其拉扯至你面前空格，并陷入“点<br>穴”（难度 15），持续一回合。<br>升级：释放距离+1，渡气对抗结果+1，消耗+4</p>",
                    "automationNote": "点击请求目标进行渡气豁免。若失败自动应用【点穴】。位移需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "渡气豁免",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, args.move.computedLevel || 1);\nconst bonus = lvl - 1;\n// 基础DC 15 + 等级加值\nconst dc = 15 + bonus;\n\n// 获取点穴状态数据 (通用状态)\nconst dianxueData = CONFIG.statusEffects.find(e => e.id === 'dianxue');\nconst onFailEffect = foundry.utils.deepClone(dianxueData);\nif(onFailEffect) {\n    onFailEffect.duration = { rounds: 1 };\n    onFailEffect.statuses = ['dianxue'];\n}\n\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: 'duqi',\n    dc: dc,\n    label: '抵抗擒龙控鹤',\n    onFail: onFailEffect\n});",
                            "active": true
                        },
                        {
                            "label": "范围修正",
                            "trigger": "calc",
                            "script": "const lvl = Math.max(1, args.move.computedLevel || 1);\n// 基础距离2 + 每级+1\nconst range = 2 + (lvl - 1);\n// 仅做提示，修改 description 或通知\n// args.output.bonusDesc.push(`范围: ${range}米`);",
                            "active": true
                        }
                    ]
                }
            ]
        }
    }
]