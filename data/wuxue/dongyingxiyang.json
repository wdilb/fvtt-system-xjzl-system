[
    {
        "name": "东瀛剑道",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>东瀛武士必修刀法，演变出多种流派技法，平时以竹刀练习。</p><p><strong>需求：</strong>刀-横刀</p><p><strong>属性：</strong>太极</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "唐竹",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>高举长刀，当头劈下，对敌人造成伤害。</p><p>·若目标无架招，招式暴击骰-2。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "暴击阈值修正自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招暴击修正",
                            "trigger": "check",
                            "script": "if (!args.target.system.martial.stanceActive) {\n    args.flags.critThresholdMod += 2;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "逆风",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>自下而上，挥刀直撩，对敌人造成伤害。击破架招时将目标击倒，同时自身不消耗速度移动 1 米。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破击倒自动。移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    ui.notifications.info(\"击破架招：目标已倒地，请手动移动 1 米。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "中段构",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>双脚朝前，刀尖居中，开启架招。格挡成功时，刀劈小臂，使攻击者流失 10 点气血。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡反伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡反伤",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    await args.attacker.applyDamage({\n        amount: 10,\n        type: \"liushi\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(\"中段构：反击流失 10 点气血\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "突刺",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>力压刀尖，向前突刺，对直线上所有敌人造成伤害。</p><p>·命中敌人后，可继续推刀前刺，自身每前进 1 米，便可将直线上敌人也全部向后击退 1 米，同时使他们流失 5 点气血。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中流失自动。位移/击退手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            6,
                            10
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中流失",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await args.target.applyDamage({\n        amount: 5,\n        type: \"liushi\",\n        attacker: actor,\n        isHit: true,\n        ignoreDefense: true\n    });\n    ui.notifications.info(\"突刺：目标流失 5 点气血，请手动处理位移和击退。\");\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "天然理心流",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>东瀛剑术流派之一，借鉴中原武林，将中华棍术跟太极柔术也糅合在了剑道之中，威力不俗。</p><p><strong>需求：</strong>剑-单剑/棍-短棍</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑；棍-短棍",
            "moves": [
                {
                    "name": "序中剑",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑一斩，双握重劈，有去无回。对目标造成伤害。</p><p>·击中格挡目标，自己也会增加怒气。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击中架招回怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "架招回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.system.martial.stanceActive) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"击中招架目标，怒气+1\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "急云剑",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑次斩，勾拳上挑，飞身居合，对目标造成伤害。</p><p>击中无架招目标时，自身额外获得 1 点怒气。</p><p>若有敌人处于半空中，可再次释放此招，跃至半空横斩，造成伤害并将目标击落地面。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无架招回怒自动。半空判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"击中无架招目标，怒气+1\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "飞燕剑",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，压制目标虚招，剑三斩，旋身横斩，不消耗速度冲向范围内未被占据的空格，对周围 1 米内敌人造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    }
                },
                {
                    "name": "波返剑",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>屈腿下蹲，转身挥剑，开启架招，并给自身添加“波返”状态，持续一回合。</p><p><strong>波返：</strong>闪避+5，闪避成功时可将攻击者反震倒地。</p><p><strong>升级：</strong>格挡+10，波返持续回合+1，内力消耗+2。</p>",
                    "automationNote": "获得波返自动。波返效果(闪避+5)自动。反震倒地提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加波返",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"波返\").toObject();\n\n// 动态计算持续时间\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\neff.duration = { rounds: rounds };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "狮子王剑",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑终结，舞剑狂刺，对目标造成伤害。</p><p>·击中无架招目标，则额外获得 2 点怒气。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "回怒自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 2});\n    ui.notifications.info(\"击中无架招目标，怒气+2\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "波返",
                    "icon": "icons/magic/defensive/barrier-shield-dome-deflect-blue.webp",
                    "description": "闪避+5，闪避成功反震倒地。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bofan",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "闪避反震提示",
                                    "trigger": "avoided",
                                    "script": "if (args.attacker) {\n    ui.notifications.info(\"波返触发：请手动判定将攻击者 [\" + args.attacker.name + \"] 反震倒地\");\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "居合-拔刀十式",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>东瀛武士流传最广，也是威力最大的武技。居合是拔击、斩切对方在瞬间获胜的武技，不需要拔出兵器也可出招。</p><p><strong>需求：</strong>刀-横刀</p><p><strong>属性：</strong>刚</p><p>注：拔出或收入兵器是一个简要动作，《居合-拔刀十式》在拔刀和收刀时具有 2 个姿态。</p><p><strong>拔刀姿态：</strong>【血振】提供的格挡值翻倍。</p><p><strong>收刀姿态：</strong>将刀归入刀鞘后持握的状态，在此状态下施展《居合-拔刀十式》，可获得 1 点怒气。</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "血振",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀尖向下指敌，振落刃上血迹，开启架招。</p><p>若你在本回合受到或造成过伤害，施展本招式后还可以不消耗动作，立即纳刀进入收刀姿态。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "收刀姿态提示手动。拔刀姿态下格挡翻倍需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "收刀提示",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (!sheathed) {\n    ui.notifications.info(\"若本回合造成或受到过伤害，可手动添加 [收刀姿态] AE\");\n}",
                            "active": true
                        },
                        {
                            "label": "姿态回怒",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"收刀姿态出招：怒气+1\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "残心",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "gang",
                    "damageType": "none",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "简要动作",
                    "description": "<p>毫不松懈，预防敌人，获得一层“残心”，至多一层，持续到战斗脱离。</p><p><strong>残心：</strong>每层提高命中 5 点。若你的回合结束时正处于收刀姿态，你可以消耗一层残心，获得一个额外的反应动作。</p><p><strong>升级：</strong>残心可叠加层数+1，内力消耗+2。</p>",
                    "automationNote": "获得残心自动。反应动作提示自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "姿态回怒",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"收刀姿态出招：怒气+1\");\n}",
                            "active": true
                        },
                        {
                            "label": "获得残心",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"残心\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst maxStacks = 1 + (lvl - 1);\neff.flags[\"xjzl-system\"].maxStacks = maxStacks;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "横一文字",
                    "type": "real",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>疾风闪光般的迅速横切！对敌人造成伤害，然后进入拔刀姿态。</p><p>·若出招前处于收刀姿态，招式伤害+10。</p><p>·若你处于收刀姿态且自身处于倒地或半空中，你可以消耗反应动作释放此招。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "收刀姿态加伤自动。自动移除收刀姿态。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "姿态回怒",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"收刀姿态出招：怒气+1\");\n}",
                            "active": true
                        },
                        {
                            "label": "姿态加伤预览",
                            "trigger": "calc",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"收刀姿态加成 (+10)\");\n}",
                            "active": true
                        },
                        {
                            "label": "解除收刀",
                            "trigger": "hit",
                            "script": "const sheathed = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await sheathed.delete();\n    ui.notifications.info(\"进入拔刀姿态\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "袈裟斩",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招后，可消耗反应动作释放此招，压制对方虚招，沿左右肩向下斜切，对目标造成伤害，然后不消耗速度移动 2 米。</p><p>·释放完袈裟斩后，纳刀进入收刀姿态。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "进入收刀姿态自动。移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "姿态回怒",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"收刀姿态出招：怒气+1\");\n}",
                            "active": true
                        },
                        {
                            "label": "纳刀",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"收刀姿态\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);\nui.notifications.info(\"纳刀：进入收刀姿态\");",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "云切半月剑",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "扇形",
                    "actionCost": "蓄力动作",
                    "description": "<p>注：你只能在收刀姿态释放此招。</p><p>鞘扭向左，徐徐推刃，瞬间化为半月弧光，拔刀斩击前方扇形区域内敌人，造成伤害。</p><p>·若造成暴击，则可迅速纳刀，进入收刀姿态。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "收刀姿态检查自动。解除收刀自动。暴击纳刀自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "姿态回怒",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 1});\n    ui.notifications.info(\"收刀姿态出招：怒气+1\");\n}",
                            "active": true
                        },
                        {
                            "label": "姿态检查与解除",
                            "trigger": "attack",
                            "script": "const sheathed = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (!sheathed) {\n    args.flags.abort = true;\n    args.flags.abortReason = \"必须处于 [收刀姿态] 才能释放此招\";\n} else {\n    // 出招即拔刀，先移除，若暴击再加回\n    await sheathed.delete();\n}",
                            "active": true
                        },
                        {
                            "label": "暴击纳刀",
                            "trigger": "hit",
                            "script": "if (args.isCrit) {\n    const eff = thisItem.effects.getName(\"收刀姿态\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"暴击！迅速纳刀进入收刀姿态\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "收刀姿态",
                    "icon": "icons/skills/melee/sword-sheathed-wood.webp",
                    "description": "刀归入鞘。拔刀十式获益。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shoudao",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "残心",
                    "icon": "icons/magic/perception/eye-ringed-glow-red.webp",
                    "description": "提高命中。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "canxin",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "回合末提示",
                                    "trigger": "turnEnd",
                                    "script": "const sheathed = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shoudao\");\nif (sheathed) {\n    ui.notifications.info(\"残心：回合结束处于收刀姿态，可手动消耗一层残心获得额外反应动作\");\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "杀神一刀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>东瀛绝学，曾被带入中原，斩杀武林高手无数，狠辣绝情，讲究一击必杀，出刀必死。</p><p><strong>需求：</strong>刀-横刀</p><p><strong>属性：</strong>阴</p>",
            "requirements": "刀-横刀",
            "moves": [
                {
                    "name": "无量杀意",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>刀身震颤，杀意凌冽，开启架招，并获得一层“杀意”，持续到脱战。格挡成功后，获得一层“杀意”，持续到脱战，杀意至多叠加十层。</p><p><strong>杀意：</strong>造成内外功伤害时移除所有杀意，每移除一层使你招式伤害+5。</p><p>·若你出招消耗杀意后，将人打入濒死或杀死，则返还消耗的杀意。</p><p><strong>升级：</strong>格挡值+10，格挡成功时获得的杀意+1 层，内力消耗+4。</p>",
                    "automationNote": "开启/格挡获杀意自动。出招消耗杀意加伤自动。击杀返还自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获杀意",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"杀意\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "格挡获杀意",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"杀意\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\n// 动态层数 (基础1 + Lv-1)\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst gain = 1 + (lvl - 1);\n\nfor(let i=0; i<gain; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "神光一现",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "blade",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>杀意爆发，不消耗速度突进至目标周围空格，斩出刀光，对目标造成伤害，根据消耗“杀意”层数，触发以下效果：</p><p>3 层：招式释放距离+5。</p><p>6 层：将目标打入濒死时伤残检定-10（最低 1）。</p><p>10 层：招式将人打入濒死后，额外获得 3 怒气。</p><p><strong>升级：</strong>造成伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "杀意伤害加成自动。层数效果(距离/伤残/回怒)提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.1
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "层数效果检查",
                            "trigger": "attack",
                            "script": "const shayi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shayi\");\nif (shayi) {\n    const stacks = shayi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    let msg = `当前杀意 ${stacks} 层：\\n`;\n    if (stacks >= 3) msg += \"- 距离+5 (请手动确认)\\n\";\n    if (stacks >= 6) msg += \"- 濒死伤残检定 -10\\n\";\n    if (stacks >= 10) msg += \"- 濒死额外回怒 +3\";\n    ui.notifications.info(msg);\n    // 记录层数供 hit 判断\n    args.flags.shayiStacks = stacks;\n}",
                            "active": true
                        },
                        {
                            "label": "回怒判定",
                            "trigger": "hit",
                            "script": "if (args.flags.shayiStacks >= 10 && args.isDying) {\n    await actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + 3});\n    ui.notifications.info(\"神光一现 (10层)：击倒回怒 +3\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血飘人间",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>刀意如雪，寒光滔滔，对周围敌人造成伤害，根据消耗“杀意”层数，触发以下效果：</p><p>4 层：使所有敌人陷入“禁疗”，持续一回合。</p><p>8 层：使所有敌人投掷一次伤残检定。</p><p>10 层：使所有敌人陷入“封招”，持续一回合。</p><p><strong>升级：</strong>造成伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "杀意伤害加成自动。层数效果需根据提示手动应用。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "层数效果检查",
                            "trigger": "attack",
                            "script": "const shayi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"shayi\");\nif (shayi) {\n    const stacks = shayi.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    let msg = `当前杀意 ${stacks} 层：\\n`;\n    if (stacks >= 4) msg += \"- 附加 [禁疗] (1回合)\\n\";\n    if (stacks >= 8) msg += \"- 触发 [伤残检定]\\n\";\n    if (stacks >= 10) msg += \"- 附加 [封招] (1回合)\";\n    ui.notifications.info(msg);\n    // 记录层数供 hit 提示\n    args.flags.shayiStacks = stacks;\n}",
                            "active": true
                        },
                        {
                            "label": "效果应用提示",
                            "trigger": "hit",
                            "script": "const stacks = args.flags.shayiStacks || 0;\nif (stacks >= 4) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <b>血飘人间效果 (${stacks}层)</b><br>\n                ${stacks >= 4 ? \"- 请手动施加 [禁疗]<br>\" : \"\"}\n                ${stacks >= 8 ? \"- 请手动投掷 [伤残检定]<br>\" : \"\"}\n                ${stacks >= 10 ? \"- 请手动施加 [封招]\" : \"\"}\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "杀意",
                    "icon": "icons/magic/death/skull-energy-light-purple.webp",
                    "description": "出招时消耗所有层数，每层伤害+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shayi",
                            "stackable": true,
                            "maxStacks": 10,
                            "scripts": [
                                {
                                    "label": "杀意释放与返还",
                                    "trigger": "preDamage",
                                    "active": true,
                                    "script": "if ([\"waigong\", \"neigong\"].includes(args.config.type)) {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    args.config.amount += stacks * 5;\n    \n    // 记录消耗的层数到 flags，以便 hit 阶段读取\n    // 由于 preDamage 的 args.flags 不会传给 hit，我们只能通过其他方式传递\n    // 或者，利用 hit 脚本去读取 消耗前 的层数？不行，preDamage 是先执行的。\n    // 方案：preDamage 写入 actor 的临时 flag\n    await actor.setFlag(\"xjzl-system\", \"lastShayiConsumed\", stacks);\n\n    await thisEffect.delete();\n    ui.notifications.info(\"杀意释放：伤害 +\" + (stacks*5));\n}"
                                },
                                {
                                    "label": "击杀返还监听",
                                    "trigger": "hit",
                                    "active": true,
                                    "script": "// 注意：这个脚本挂在 AE 上，但 AE 在 preDamage 阶段可能已经被删除了！\n// 如果 AE 被删除了，这个脚本就不会运行。\n// 因此，返还逻辑必须写在【招式】的 scripts 中，或者 preDamage 暂时不删 AE？\n// 不行，规则是“造成伤害时移除”。\n// 正解：在【招式】里写一个 hit 脚本来处理返还。此处代码仅作逻辑说明，实际不生效。\n// 见下方修正后的通用 Hit 脚本。"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "八方手里剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>东瀛武士修炼的脱手暗器，以近程打击威力为最大。</p><p><strong>需求：</strong>暗器-飞镖</p><p><strong>属性：</strong>太极</p>",
            "requirements": "暗器-飞镖",
            "moves": [
                {
                    "name": "八方手里剑",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "hidden",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>指捏八方，螺旋飞掷，对目标造成伤害。</p><p>若目标处于你 5 米范围内，招式伤害提高 20 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "近程加伤自动 (需选中目标)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "近程加伤",
                            "trigger": "preDamage",
                            "script": "const t1 = actor.token?.object || actor.getActiveTokens()[0];\nconst t2 = args.target.token?.object || args.target.getActiveTokens()[0];\n\nif (t1 && t2) {\n    const dist = canvas.grid.measurePath([t1.center, t2.center]).distance;\n    if (dist <= 5) {\n        args.config.amount += 20;\n        ui.notifications.info(\"近程打击：伤害+20\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "侍从之剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>西夷骑士贵族在侍从期间便开始苦练的基础技法。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>无</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "福音守护",
                    "type": "stance",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>高举手中之剑，开启架招。</p><p>你被击破架招时，在该回合末回复 5 点气血。</p><p><strong>升级：</strong>格挡值+5，被击破回合末回复+5，消耗+1。</p>",
                    "automationNote": "击破回血提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "damaged",
                            "script": "if (args.isBroken) {\n    // 获取当前架招等级\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const heal = 5 + (lvl-1)*5;\n    ui.notifications.info(`架招被破：请在回合末手动回复 ${heal} 点气血`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "虔诚之佑",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>用剑在胸前飞速画一个十字，使天主护佑自身，获得“虔诚”，持续三回合。</p><p><strong>虔诚：</strong>直到你造成伤害为止，你的速度增加 2 点。你下一次出招，招式伤害+10。</p><p><strong>升级：</strong>虔诚提供的速度+1，招式伤害+5，消耗+1。</p>",
                    "automationNote": "获得BUFF自动。BUFF加速自动。下一次出招加伤并移除BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得虔诚",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"虔诚\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst spd = 2 + (lvl - 1);\nconst dmg = 10 + (lvl - 1) * 5;\n\n// 写入动态数值\neff.changes[0].value = String(spd);\neff.flags[\"xjzl-system\"].qianchengDmg = dmg;\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "英勇打击",
                    "type": "real",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双手持剑，跨步斩击，对目标造成伤害，并为其添加“奴隶标记”，持续一回合。</p><p><strong>奴隶标记：</strong>每次受到《侍从之剑》《骑誓之剑》《西洋剑法》的伤害时，额外流失 10 点气血。</p><p>·若有敌人处于半空状态，你可以消耗反应动作释放此招，跃至半空劈斩，造成伤害。</p><p><strong>升级：</strong>招式伤害+5，奴隶标记持续回合数+1，消耗+1。</p>",
                    "automationNote": "添加标记自动。标记增伤自动 (需匹配武学名称)。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加标记",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"奴隶标记\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    \n    const lvl = Math.max(1, move.computedLevel || 1);\n    eff.duration = { rounds: 1 + (lvl - 1) };\n\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "裁决之刃",
                    "type": "real",
                    "isUltimate": true,
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>大力劈出手中之剑，贯穿目标。对目标造成自身气血上限 20%的外功伤害（外功命中，可暴击）。</p><p>若目标拥有“奴隶标记”，还会将其击飞 1 米。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "百分比伤害计算自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "百分比伤害",
                            "trigger": "calc",
                            "script": "const hpMax = actor.system.resources.hp.max;\nconst bonus = Math.floor(hpMax * 0.2);\nargs.output.damage += bonus;\nargs.output.bonusDesc.push(`20%血量加成 (+${bonus})`);",
                            "active": true
                        },
                        {
                            "label": "标记击飞",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        ui.notifications.info(`${args.target.name} 被击飞 1 米`);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "虔诚",
                    "icon": "icons/magic/light/hand-sparks-glow-yellow.webp",
                    "description": "速度+2，下次出招伤害增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qiancheng",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "出招加伤",
                                    "trigger": "preDamage",
                                    "active": true,
                                    "script": "if ([\"waigong\", \"neigong\"].includes(args.config.type)) {\n    const dmg = thisEffect.getFlag(\"xjzl-system\", \"qianchengDmg\") || 10;\n    args.config.amount += dmg;\n    await thisEffect.delete();\n    ui.notifications.info(`虔诚消耗：伤害 +${dmg}`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "2"
                        }
                    ]
                },
                {
                    "name": "奴隶标记",
                    "icon": "icons/svg/degen.svg",
                    "description": "受到特定武学伤害时流失气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "slave_mark",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "西洋剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>西夷贵族所用的剑技，动作简单高雅有效。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>无</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "刺剑",
                    "type": "real",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>弯曲膝盖，持剑前伸，对直线上单个敌人造成伤害。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "奴隶标记加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n        ui.notifications.info(\"奴隶标记：额外流失 10 点\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "佯剑",
                    "type": "feint",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>回转身位，佯攻下路，对目标造成伤害，击破架招时将其击倒，同时自身获得“滑步”，持续到战斗脱离。</p><p><strong>滑步：</strong>你可以消耗一个次要动作，不消耗速度滑步 2 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破击倒自动。获得滑步自动。滑步移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    \n    // 获得滑步AE\n    const eff = thisItem.effects.getName(\"滑步\").toObject();\n    delete eff._id;\n    eff.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        },
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "拨剑",
                    "type": "stance",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>剑握于胸前，开启架招。格挡成功时，可以消耗反应动作，施展【刺剑】。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "反击提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"拨剑格挡成功：可消耗反应动作施展 [刺剑]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "绞剑",
                    "type": "counter",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作，压制对方虚招，绞剑缠斗，对其造成伤害，此伤害无视敌方外功防御。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "无视防御自动。使用记录自动(用于旋剑)。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "配置穿透",
                            "trigger": "preDamage",
                            "script": "args.config.ignoreDefense = true;",
                            "active": true
                        },
                        {
                            "label": "记录使用",
                            "trigger": "hit",
                            "script": "await actor.setFlag(\"xjzl-system\", \"wuxue_western_combo_flag\", true);",
                            "active": true
                        },
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "旋剑",
                    "type": "real",
                    "isUltimate": true,
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>手腕灵活，剑身柔韧旋转戳穿目标，对其造成伤害。</p><p>若此战中曾以【绞剑】伤敌，招式伤害转化为气血流失。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "绞剑连携自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "连携转化",
                            "trigger": "preDamage",
                            "script": "const used = actor.getFlag(\"xjzl-system\", \"wuxue_western_combo_flag\");\nif (used) {\n    args.config.type = \"liushi\";\n    args.config.ignoreDefense = true;\n    ui.notifications.info(\"绞剑连携：伤害转化为流失\");\n}",
                            "active": true
                        },
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "滑步",
                    "icon": "icons/skills/movement/feet-winged-boots-brown.webp",
                    "description": "可消耗次要动作滑步。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huabu",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "骑誓之剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>西方圣殿骑士苦修的战技，可圈可点。</p><p><strong>需求：</strong>剑-双手剑</p><p><strong>属性：</strong>无</p>",
            "requirements": "剑-双手剑",
            "moves": [
                {
                    "name": "横扫摔绊",
                    "type": "real",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "至多2个",
                    "actionCost": "蓄力动作",
                    "description": "<p>双手举剑横扫周围，对身边至多 2 个目标造成伤害。若目标无架招，则将其击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击倒自动。标记加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招击倒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    ui.notifications.info(`${args.target.name} 被击倒`);\n}",
                            "active": true
                        },
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "坚强守护",
                    "type": "stance",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>横置长剑，以守待攻，开启架招。若你 1 米内的其他友方受到攻击，你可以进行掩护，让攻击者的命中具有劣势。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "掩护效果手动（GM裁定或手动调整骰子）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "指挥奇袭",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "友方",
                    "actionCost": "蓄力动作",
                    "description": "<p>指挥 1 米内一名其他友军，使其获得“奇袭”，持续一回合。</p><p><strong>奇袭：</strong>你可以移除奇袭，然后立即施展一次实招。</p><p><strong>升级：</strong>指挥距离+1，消耗内力-5。</p>",
                    "automationNote": "获得BUFF自动。爆发效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            20,
                            15,
                            10
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加奇袭",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"奇袭\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "诡诈反击",
                    "type": "counter",
                    "element": "none",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可以消耗反应动作，压制对方虚招，虚晃一剑，对其造成伤害，同时为其添加“错骨”，持续三回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "添加错骨自动。标记加成自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            3,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加错骨",
                            "trigger": "hit",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"cuogu\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        },
                        {
                            "label": "标记触发",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasMark = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"slave_mark\");\n    if (hasMark) {\n        await args.target.applyDamage({\n            amount: 10,\n            type: \"liushi\",\n            attacker: actor,\n            isHit: true,\n            ignoreDefense: true\n        });\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "为了光荣",
                    "type": "qi",
                    "actionType": "buff",
                    "isUltimate": true,
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "简要动作",
                    "description": "<p>为了光荣而战！在短时间内突破自己的极限，你在本回合获得一个额外的主要动作。</p><p>在你的回合末陷入“脱力”，持续到下个回合初。</p><p><strong>脱力：</strong>你的虚招对抗-3，且具有劣势。</p><p><strong>升级：</strong>怒气消耗-1 点，内力消耗+4。</p>",
                    "automationNote": "手动增加动作。回合末脱力需手动添加。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "attack",
                            "script": "ui.notifications.info(\"已开启突破：请手动执行额外动作。回合结束请手动添加 [脱力] 状态。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "奇袭",
                    "icon": "icons/skills/melee/strike-dagger-white-orange.webp",
                    "description": "移除可施展实招。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qixi",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "提气再战",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>长期锻炼让你的肌肉存储不少精力，释放吧！</p><p><strong>需求：</strong>《骑士七技》修炼圆满</p><p><strong>类型：</strong>气招</p><p><strong>距离：</strong>自身</p><p><strong>消耗：</strong>无</p><p>次要动作，释放精力，回复【5+韧性】点气血。</p><p>·你每次小憩后，能施展此招一次。</p><p><strong>升级：</strong>回复气血+5，小憩后能施展的次数+1。</p>",
            "requirements": "《骑士七技》圆满",
            "moves": [
                {
                    "name": "提气再战",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>释放精力，回复气血。</p>",
                    "automationNote": "治疗量计算自动。次数限制手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "renxing",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "洗礼",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>天主教神父祝圣，以降福、驱邪、治病。</p><p><strong>需求：</strong>读完《圣经-福音书》</p><p><strong>类型：</strong>气招</p><p><strong>距离：</strong>5</p><p><strong>消耗：</strong>100 点修为</p><p>全回合动作，以光明引导天福注入目标，使他回复 10 气血并获得“祝福”，持续一日。</p><p><strong>祝福：</strong>当攻击被闪避后，你可以移除祝福，让自己的这次攻击变为命中，但不会造成暴击。</p><p><strong>升级：</strong>回复气血+10。</p>",
            "requirements": "读完《圣经-福音书》",
            "moves": [
                {
                    "name": "洗礼",
                    "type": "qi",
                    "actionType": "heal",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "全回合",
                    "description": "<p>回复气血并获得“祝福”，持续一日。</p>",
                    "automationNote": "治疗自动。祝福BUFF自动。祝福效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗修为",
                            "trigger": "attack",
                            "script": "await actor.manualModifyXP(\"general\", -100, {title: \"洗礼消耗\"});",
                            "active": true
                        },
                        {
                            "label": "添加祝福",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"祝福\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\neff.duration = { seconds: 86400 };\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "祝福",
                    "icon": "icons/magic/life/cross-yellow-green.webp",
                    "description": "攻击被闪避后可移除此BUFF强制命中(不暴击)。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhufu",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "天神庇护",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>神爱世人，叫一切信他者，不至灭亡，反得永生。</p><p><strong>需求：</strong>读完《圣经-使徒书信》</p><p><strong>类型：</strong>气招</p><p><strong>距离：</strong>1</p><p><strong>消耗：</strong>1000 修为</p><p>全回合动作，触摸自己或其他友方生物头顶，给目标添加“庇护”，持续到下一次休整。</p><p><strong>庇护：</strong>当你受到超过高于 30 的伤害时，移除“庇护”，你只受到 1 点伤害。</p><p><strong>升级：</strong>消耗的修为减少 250 点。</p>",
            "requirements": "读完《圣经-使徒书信》",
            "moves": [
                {
                    "name": "天神庇护",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "none",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "全回合",
                    "description": "<p>给目标添加“庇护”，持续到下一次休整。</p>",
                    "automationNote": "消耗修为自动 (随等级减少)。庇护减伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗修为",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst cost = 1000 - (lvl - 1) * 250;\nawait actor.manualModifyXP(\"general\", -cost, {title: \"天神庇护消耗\"});",
                            "active": true
                        },
                        {
                            "label": "添加庇护",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"庇护\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "庇护",
                    "icon": "icons/magic/holy/angel-wings-gray.webp",
                    "description": "受到>30伤害时化为1点并移除。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bihu",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "庇护触发",
                                    "trigger": "preTake",
                                    "active": true,
                                    "script": "if (args.calcDamage > 30) {\n    args.output.damage = 1;\n    await thisEffect.delete();\n    ui.notifications.info(\"天神庇护触发！伤害化为 1\");\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]