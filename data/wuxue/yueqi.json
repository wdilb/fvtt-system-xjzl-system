[
    {
        "name": "清平曲",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>轻松的小调，听者心悦无比。</p><p><strong>需求：</strong>乐器</p><p><strong>属性：</strong>太极</p>",
            "requirements": "乐器",
            "moves": [
                {
                    "name": "茅檐低小",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>吹奏一曲压抑之曲，对范围内所有敌人造成 0.3 内息点内功伤害，并添加下盘不稳，持续一回合。</p><p>·获得“起”，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "施加下盘不稳自动。获得“起”自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加效果",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"unstable\", true);\n}",
                            "active": true
                        },
                        {
                            "label": "获得起",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"起\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "溪上青青草",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>吹奏一曲生机之曲，为所有未陷入濒死的友方单位回复 0.1 气感点生命值。（无法暴击），并获得“承”，持续到战斗脱离。</p><p>·此招中的气感是施展本招式者的气感属性。</p><p><strong>升级：</strong>额外回复生命值 5 点，内力消耗+2。</p>",
                    "automationNote": "治疗需选中目标。自动获得“承”。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "qigan",
                                "ratio": 0.1
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "执行治疗",
                            "trigger": "hit",
                            "script": "if (args.target.system.resources.hp.value > 0) {\n    await args.target.applyHealing({amount: args.finalAmount, type: \"hp\", showScrolling: true});\n}",
                            "active": true
                        },
                        {
                            "label": "获得承",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"承\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "醉里吴音相媚好",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "taiji",
                    "damageType": "mental",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>吹奏靡靡之曲，范围内敌方角色进行[定力]检定（难度 11），失败受到 10 点精神伤害，成功减半。</p><p>·获得“转”，持续到战斗脱离。</p><p><strong>升级：</strong>难度+2，精神伤害+10，内力消耗+2。</p>",
                    "automationNote": "发起定力检定请求自动。伤害应用需根据检定结果手动调整（全额或半额）。获得“转”自动。",
                    "calculation": {
                        "base": 10,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求检定与获转",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 11 + (lvl - 1) * 2;\nawait Macros.requestSave({\n    target: args.target,\n    type: \"dingli\",\n    dc: dc,\n    label: \"抵抗靡靡之曲\",\n    attacker: actor\n});",
                            "active": true
                        },
                        {
                            "label": "获得转",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"转\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白发谁家翁媪",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>一曲肝肠断，减少范围内所有敌人的寿命一息，并对所有敌人进行一次[点穴]检定。</p><p>可一次性消除“起、承、转”三个状态，然后不消耗动作释放此招。</p><p><strong>升级：</strong>减少的寿命增多一息，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "寿命减少手动RP。点穴检定请求自动。消除状态手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求点穴检定",
                            "trigger": "hit",
                            "script": "await Macros.requestSave({\n    target: args.target,\n    type: \"neixi\",\n    dc: 15,\n    label: \"抵抗点穴\",\n    attacker: actor,\n    onFail: \"dianxue\"\n});",
                            "active": true
                        },
                        {
                            "label": "消除提示",
                            "trigger": "attack",
                            "script": "const hasQi = actor.effects.some(e => e.name === \"起\");\nconst hasCheng = actor.effects.some(e => e.name === \"承\");\nconst hasZhuan = actor.effects.some(e => e.name === \"转\");\n\nif (hasQi && hasCheng && hasZhuan) {\n    ui.notifications.info(\"检测到[起][承][转]俱全，可手动删除以视为不消耗动作。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "起",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "清平曲-起",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingping_qi",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "承",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "清平曲-承",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingping_cheng",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "转",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "清平曲-转",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingping_zhuan",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "折杨柳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>南朝梁宫体诗人萧纲创作笛曲，如一缕柔情，委婉缠绵，多为伤春惜别之辞。</p><p><strong>需求：</strong>乐器-箫笛</p><p><strong>属性：</strong>阴</p>",
            "requirements": "乐器-箫笛",
            "moves": [
                {
                    "name": "风轻花落",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>短音轻扬，开启架招。格挡成功后，为目标添加“惜别”，持续一回合。</p><p><strong>惜别：</strong>目标朝远离你的方向移动时，每走 1 格消耗 2 点速度。</p><p><strong>升级：</strong>格挡值+5，走 1 格额外消耗 1 速度，内力消耗+1。</p>",
                    "automationNote": "施加惜别自动。惜别减速效果需手动结算。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加惜别",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"惜别\").toObject();\neff.duration = { rounds: 1 };\nawait game.xjzl.api.effects.addEffect(args.attacker, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "柳乱成丝",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>音穿柳林，对目标造成 0.3 内息点内功伤害，命中无架招目标时，为其添加“惜别”，持续三回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招施加惜别自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加惜别",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"惜别\").toObject();\n    eff.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "曲无别意",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>长音浑厚，对周围敌方造成 0.3 内息点内功伤害。</p><p>·招式范围内每有一个目标存在“惜别”，招式伤害提升 5 点。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "惜别增伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "惜别增伤",
                            "trigger": "preDamage",
                            "script": "if (args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xibie\")) {\n    args.config.amount += 5;\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "是为相思",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>清丽圆美，映思回萦，对周围敌方造成 0.5 内息点内功伤害，自身获得“相思”，持续到战斗脱离。</p><p><strong>相思：</strong>在你 3 米范围内开始回合的敌方需要进行难度 16 的[定力]检定，失败受到 10 点精神伤害。</p><p>·若其具有“惜别”，则检定必定失败。</p><p><strong>升级：</strong>招式伤害+10，相思伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "获得相思自动。相思光环效果需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得相思",
                            "trigger": "hit_once",
                            "script": "const eff = thisItem.effects.getName(\"相思\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "惜别",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "远离施法者时移动消耗增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xibie",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "相思",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "周围敌人回合开始需过定力检定。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiangsi",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "抬花轿",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>百姓迎亲时所奏曲目，根据抬花轿的动作、行走而编配的音乐，喜庆无比，嘹亮四方。</p><p><strong>需求：</strong>乐器-喇叭</p><p><strong>属性：</strong>阳</p>",
            "requirements": "乐器-喇叭",
            "moves": [
                {
                    "name": "三声炮响",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>短促高音，催轿起动，开启架招。格挡成功后，自身获得“彩头”，持续到战斗脱离。</p><p><strong>彩头：</strong>下一次施展的乐器招式需求动作下降一级。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "获得彩头自动。动作降级需玩家手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得彩头",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"彩头\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "闹抬轿",
                    "type": "qi",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "1米",
                    "targetInfo": "范围",
                    "actionCost": "主要动作",
                    "description": "<p>不消耗速度朝任意方向奔跑 3 米，然后为 1 米范围内友方添加一层“蓄劲”，至多三层，持续到脱战。</p><p><strong>蓄劲：</strong>每层使你暴击骰-1。</p><p>·若你因“彩头”而下降了此招消耗的动作，额外为友方添加一层“蓄劲”。</p><p><strong>升级：</strong>奔跑距离+2，添加状态范围+1，消耗+2。</p>",
                    "automationNote": "施加蓄劲自动。彩头判定及额外层数自动。彩头消耗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加蓄劲",
                            "trigger": "hit",
                            "script": "const hasCaitou = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"caitou\");\nconst stacksToAdd = hasCaitou ? 2 : 1;\n\nconst eff = thisItem.effects.getName(\"蓄劲\").toObject();\nif (hasCaitou) {\n    ui.notifications.info(\"彩头生效：额外添加一层蓄劲！请手动移除彩头。\");\n}\n\n// 循环叠加\nfor(let i=0; i<stacksToAdd; i++) {\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "戏抬轿",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>摇摆抖吹，唢呐高奏，对周围敌方造成 0.3 内息点内功伤害。然后为所有敌人添加“下盘不稳”，持续一回合。</p><p>·若你因“彩头”而下降了此招消耗的动作，还会把敌人全部击倒。</p><p><strong>升级：</strong>伤害+5，内力消耗+2。</p>",
                    "automationNote": "施加下盘不稳自动。彩头击倒自动。彩头消耗手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳与击倒",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"unstable\", true);\n    \n    const hasCaitou = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"caitou\");\n    if (hasCaitou) {\n        await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n        ui.notifications.info(\"彩头生效：目标已倒地！请手动移除彩头。\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "满面春风",
                    "type": "qi",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>奏吹嘀嗒，悦耳动听，为周围友方添加一层“养血”，至多三层，持续到脱战。</p><p>·若你因“彩头”而下降了此招消耗的动作，还会给范围内敌方添加一层“流血”，持续到脱战。</p><p><strong>升级：</strong>添加的养血、流血增加一层，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "施加养血自动。彩头施加流血需Shift+点击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加养血",
                            "trigger": "hit",
                            "script": "// 默认给目标施加养血\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"养血\").toObject();\n\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}\n\n// 提示彩头流血\nconst hasCaitou = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"caitou\");\nif (hasCaitou) {\n    ui.notifications.info(\"彩头生效：请手动给敌方目标施加 [流血] (消耗彩头)。\");\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                }
            ],
            "effects": [
                {
                    "name": "彩头",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "下一次乐器招式动作降级。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "caitou",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "蓄劲",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "暴击骰-1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xujin",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                },
                {
                    "name": "养血",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "回合末回复气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yangxue",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "失魂曲",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>一走投无路，堕入魔道的风尘女子所编，全曲凄凉苦楚，听者仿若丢失三魂七魄，再无生气。</p><p><strong>需求：</strong>乐器-箫笛</p><p><strong>属性：</strong>柔</p>",
            "requirements": "乐器-箫笛",
            "moves": [
                {
                    "name": "守幽精",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>报情守心，开启架招。格挡成功后，移除自己身上的一种人级状态（不能移除本次格挡成功时，攻击者添加的状态）。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "移除状态需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "移除状态提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功：请手动移除一个 [人级] 状态。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "丧胎光",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>乐声勾魂，生机渐失，对目标造成 0.4 内息点内功伤害，若目标无架招，为其添加一层“丧胎”，持续到战斗脱离。</p><p><strong>丧胎：</strong>你的气血上限降低 10 点。（最低 1）</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "无架招施加丧胎自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加丧胎",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = thisItem.effects.getName(\"丧胎\").toObject();\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "遣尸狗",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>乐声清朗，使人放松警惕，对目标造成 0.3 内息点内功伤害。击破架招时，使目标获得“耳鸣”状态，持续两回合。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破施加耳鸣自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破耳鸣",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"deaf\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "魂飞魄散",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>勾魂夺魄，魂魄离体，对目标造成 0.5 内息点内功伤害。本场战斗中你每进行过一次残疾检定，此招招式伤害+10（至多+50）。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "残疾检定计数无法自动追踪，请手动修正伤害。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "丧胎",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "气血上限降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "sangtai",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.resources.hp.bonus",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "常山战鼓",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>始于战国时期，源远流长，久负盛名。时而如雷霆万钧，惊天动地；时而似万马奔腾，所向无敌。</p><p><strong>需求：</strong>乐器-锣鼓</p><p><strong>属性：</strong>阳</p>",
            "requirements": "乐器-锣鼓",
            "moves": [
                {
                    "name": "铿锵点兵",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>彩绸系鼓，挂于腰间，开启架招。格挡成功后，敲打鼓边，为目标添加“耳鸣”一回合。</p><p><strong>升级：</strong>格挡值+5，内力消耗+1。</p>",
                    "automationNote": "施加耳鸣自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加耳鸣",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = CONFIG.statusEffects.find(e => e.id === \"deaf\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.attacker, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "大军闯帐",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>两臂圆抡，槌击鼓面，对周围敌人造成 0.3 力量点内功伤害。</p><p>·若目标处于耳鸣，则痛苦倒地。</p><p><strong>升级：</strong>招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "耳鸣目标倒地自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "耳鸣倒地",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"deaf\")) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    ui.notifications.info(`${args.target.name} 因耳鸣而倒地！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "西鼓连天",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>鼓声急转直下，像雨打芭蕉，对目标造成 0.3 力量点内功伤害。击破架招时，为范围内所有友方添加 10 点士气。</p><p><strong>升级：</strong>招式伤害+5，获得士气+10，内力消耗+1。</p>",
                    "automationNote": "击破后士气增加需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招！请手动为范围内友方添加士气。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "大得胜",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>鼓槌翻飞，彩绸飘舞，气势雄浑，对周围敌人造成 0.5 力量点内功伤害。</p><p>·若目标处于耳鸣，则被击飞 1 米后倒地，此招每击飞一个目标，范围内所有友方获得 20 点士气。</p><p><strong>升级：</strong>招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "耳鸣目标击飞/倒地手动。士气增加手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    },
    {
        "name": "阳关三叠",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>此曲纯朴而激动沉郁，充分表达出对即将远行的友人的无限关怀、留恋的诚挚情感。</p><p><strong>需求：</strong>乐器-琴</p><p><strong>属性：</strong>柔</p>",
            "requirements": "乐器-琴",
            "moves": [
                {
                    "name": "长亭依依柳色新",
                    "type": "qi",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>将范围内倒地的一名友方托起，恢复站立，然后为他添加一层“护身”，至多叠加三层，持续到脱战。</p><p><strong>护身：</strong>每层增加内外功防御 5 点。</p><p><strong>升级：</strong>额外添加一层护身，内力消耗+4。</p>",
                    "automationNote": "恢复站立(移除倒地)自动。添加护身自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "托起与护身",
                            "trigger": "hit",
                            "script": "await game.xjzl.api.effects.removeEffect(args.target, \"prone\", 100);\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"护身\").toObject();\n\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "故人相别十里亭",
                    "type": "qi",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "4米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>为目标添加 10 点护体真气，持续到战斗脱离。</p><p>·你每有 1 级[演奏]，护体真气+10。</p><p>·你和目标若为结拜或结婚，护体真气+50。</p><p><strong>升级：</strong>护体真气+10，内力消耗+2。</p>",
                    "automationNote": "基础及演奏加成自动。关系加成手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加护体",
                            "trigger": "hit",
                            "script": "const yanzou = actor.system.skills.yanzou?.total || 0;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst base = 10 + (lvl - 1) * 10;\nconst total = base + yanzou * 10;\n\nawait args.target.applyHealing({amount: total, type: \"huti\", showScrolling: true});\nui.notifications.info(`[演奏 Lv.${yanzou}] 护体+${total} (若有关系请手动再补50)`);",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "劝君更尽一杯酒",
                    "type": "qi",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "全回合动作",
                    "description": "<p>提起行囊中的一壶酒，请对方饮下，目标获得该美酒效果，并为其添加“香醪”，持续三回合。</p><p><strong>香醪：</strong>美酒未饮，心已先醇，你可以消耗醉意来代替内力施展招式，若你消耗醉意施展招式，你的出招具有优势，且暴击骰-1。</p><p><strong>升级：</strong>香醪持续回合+1，暴击骰再-2，消耗+2。</p>",
                    "automationNote": "酒类物品消耗及效果手动。施加香醪自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加香醪",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 3 + (lvl - 1);\nconst critReduction = -1 + (lvl - 1) * (-2);\n\nconst eff = thisItem.effects.getName(\"香醪\").toObject();\neff.duration = { rounds: rounds };\neff.changes[0].value = String(critReduction);\n\nawait game.xjzl.api.effects.addEffect(args.target, eff);\nui.notifications.info(\"请手动消耗背包中的美酒。\");",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "西出阳关无故人",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>对周围敌方造成 0.5 内息点内功伤害，后为一名友方添加“养血”“聚气”“轻灵”各一层，至多三层，持续到战斗脱离。</p><p><strong>养血：</strong>每层使你回合末回复 10 点气血。</p><p><strong>聚气：</strong>每层使你回合末回复 5 点内力。</p><p><strong>轻灵：</strong>每层使你的闪避+5。</p><p>·你和目标若为结拜或结婚，额外添加一层。</p><p><strong>升级：</strong>可选择目标+1，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "施加状态手动（因无法自动判断友方选择）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示",
                            "trigger": "hit_once",
                            "script": "ui.notifications.info(\"请手动给选择的友方施加 [养血][聚气][轻灵] (使用系统通用状态栏)。\");",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "护身",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "增加双防。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "hushen",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.def_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.def_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "香醪",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "消耗醉意代替内力，出招优势，暴击骰降低。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xianglao",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "-1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "-1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "琵琶行",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>白居易于浔阳江头遇一乐女，感其技艺超绝而作。曲调流转匀称优美和谐，而曲罢悯然，哀叹不已。</p><p><strong>需求：</strong>乐器-琵琶</p><p><strong>属性：</strong>阴</p>",
            "requirements": "乐器-琵琶",
            "moves": [
                {
                    "name": "千呼万唤",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>犹抱琵琶半遮面，开启架招。格挡成功时在周身 3 米内弹奏‘荻花秋瑟’，持续两回合。</p><p><strong>荻花秋瑟：</strong>区域内敌人速度减半，且攻击距离-1（至少 1）。</p><p><strong>升级：</strong>格挡值+10，荻花秋瑟范围+1，攻击距离再-1，内力消耗+2。</p>",
                    "automationNote": "荻花秋瑟光环需手动创建/移动。效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "生成光环提示",
                            "trigger": "damaged",
                            "script": "if (Macros.checkStance(actor, args)) {\n    ui.notifications.info(\"格挡成功：请手动给自己施加 [荻花秋瑟] (使用物品内特效)。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "珠落玉盘",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>轻拢慢捻抹复挑，对范围内至多三个目标造成 0.4 内息点内功伤害，若招式暴击，还会为敌人添加一层“犹豫”，至多三层，持续到脱战。</p><p><strong>犹豫：</strong>每层使暴击骰+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "暴击施加犹豫自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "暴击施加犹豫",
                            "trigger": "hit",
                            "script": "if (args.isCrit) {\n    const eff = thisItem.effects.getName(\"犹豫\").toObject();\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "杜鹃啼血",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>呕哑嘲哳难为听，对目标造成 0.4 内息点内功伤害。击破架招时，额外使其流失 10 气血，并陷入“耳鸣”，持续三回合。</p><p>·若目标处于‘荻花秋瑟’中，虚招值+2。</p><p><strong>升级：</strong>伤害+10，流失气血+10，内力消耗+2。</p>",
                    "automationNote": "击破流失及耳鸣自动。荻花秋瑟虚招加成手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bleed = 10 + (lvl - 1) * 10;\n    await args.target.applyHealing({amount: -bleed, type: \"hp\", showScrolling: true});\n    \n    const eff = CONFIG.statusEffects.find(e => e.id === \"deaf\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无声胜有声",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "光环范围",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>曲终收拨当心画，对所有处于‘荻花秋瑟’内的敌人造成 0.7 内息点内功伤害。并使他们陷入“脱力”，持续三回合。</p><p><strong>脱力：</strong>你的虚招对抗-3，且具有劣势。</p><p>·你可以移除‘荻花秋瑟’，让此招必定命中。</p><p><strong>升级：</strong>伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "施加脱力自动。移除光环必中需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用脱力",
                            "trigger": "hit",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"tuoli\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        },
                        {
                            "label": "消耗光环必中",
                            "trigger": "attack",
                            "script": "const aura = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"dihua_qiuse\");\nif (aura) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"无声胜有声\" },\n        content: \"<p>是否移除 [荻花秋瑟] 以获得 <b>必中</b> 效果？</p>\",\n        yes: { label: \"移除并必中\", icon: \"fas fa-check\" },\n        no: { label: \"保留光环\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await aura.delete();\n        args.flags.forceHit = true;\n        ui.notifications.info(\"光环已移除，本招式必中！\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "荻花秋瑟",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "光环：敌人减速，攻击距离减少。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "dihua_qiuse",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "犹豫",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
                    "description": "暴击骰增加。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "youyu",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.crit_waigong",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.combat.crit_neigong",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "苏武牧羊",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>以苏武宁死不屈，情愿牧羊也不投降匈奴的典故而创作，全曲平和优美之中，潜藏无比坚定的信念。</p><p><strong>需求：</strong>乐器-箫</p><p><strong>属性：</strong>刚</p>",
            "requirements": "乐器-箫",
            "moves": [
                {
                    "name": "风雪孤忠",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>箫音低沉，空旷凄凉，对范围内至多 2 个目标造成 0.5 内息点内功伤害，自身获得一层“磐石”，至多叠加三层，持续到战斗脱离。</p><p><strong>磐石：</strong>每层使你格挡值+5。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "获得磐石自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            6,
                            8
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得磐石",
                            "trigger": "hit_once",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"panshi\");\nif(eff) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "饥餐寒冰",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>音渐慢渐弱，迟缓凝重，造成 0.4 内息点内功伤害，击中无架招目标后，移除其身上的佳肴、茶叶状态，并使其饱食度归零。</p><p>·若目标饱食度已归零，为其添加一层“饥饿”。</p><p><strong>升级：</strong>伤害+10，额外添加一层饥饿，消耗+2。</p>",
                    "automationNote": "移除食物BUFF需手动。饱食度归零自动。添加饥饿自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "饥饿效果",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const target = args.target;\n    const satiety = target.system.resources.satiety.value;\n    \n    if (satiety > 0) {\n        await target.update({\"system.resources.satiety.value\": 0});\n        ui.notifications.info(`${target.name} 饱食度已归零！请手动移除食物BUFF。`);\n    } else {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const stacks = 1 + (lvl - 1);\n        const eff = CONFIG.statusEffects.find(e => e.id === \"hunger\");\n        if(eff) {\n            for(let i=0; i<stacks; i++) {\n                await game.xjzl.api.effects.addEffect(target, eff);\n            }\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "思汉怀乡",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>箫音清澈，开启架招。格挡成功后，为目标添加“缚身”，持续一回合。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "施加缚身自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加缚身",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = CONFIG.statusEffects.find(e => e.id === \"fushen\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.attacker, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "白雁传书",
                    "type": "counter",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招后可消耗反应动作释放，压制对方虚招，鸣奏坚定之音，对其造成 0.6 内息点内功伤害。</p><p>·你选择场上距离你最远的一个友方，他此时可以消耗反应动作来代替主要动作使用一件物品。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "伤害自动。队友效果提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "队友效果提示",
                            "trigger": "hit",
                            "script": "ChatMessage.create({\n    content: \"<b>白雁传书</b>：请告知距离最远的友方，他现在可以使用反应动作代替主要动作使用物品。\",\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "执节荣归",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>高奏颂歌，雄壮辉煌，对范围所有敌方造成 0.7 内息点内功伤害。若你有三层“磐石”，可将其全部移除，然后获得“荣归”持续到脱战。</p><p><strong>荣归：</strong>每回合末回复 30 点气血。</p><p><strong>升级：</strong>招式伤害+20，荣归回复气血+10，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "移除磐石及获得荣归需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "磐石转化荣归",
                            "trigger": "attack",
                            "script": "const panshi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"panshi\");\nif (panshi && (panshi.getFlag(\"xjzl-system\", \"stacks\") || 1) >= 3) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"执节荣归\" },\n        content: \"<p>是否移除 3 层 [磐石] 以获得 [荣归]？</p>\",\n        yes: { label: \"转化\", icon: \"fas fa-check\" },\n        no: { label: \"保留磐石\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await panshi.delete();\n        const eff = thisItem.effects.getName(\"荣归\").toObject();\n        // 动态调整回复量\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const regen = 30 + (lvl - 1) * 10;\n        eff.changes[0].value = String(regen);\n        await game.xjzl.api.effects.addEffect(actor, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "荣归",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "回合末回复气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "ronggui",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "30"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "凤阳花鼓",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>边舞边歌，氛围愉悦，传遍大江南北。</p><p><strong>需求：</strong>乐器-锣鼓</p><p><strong>属性：</strong>阳</p>",
            "requirements": "乐器-锣鼓",
            "moves": [
                {
                    "name": "击鼓传花",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>点脚转身，轻敲鼓边，开启架招。格挡成功后为攻击者添加一层“花鼓”，持续到脱战。</p><p><strong>花鼓：</strong>花鼓层数在你回合初减少一层而非回合末，当层数因此归零时，花鼓炸开，你受到【该场战斗中所有角色一共添加花鼓层数*10】的精神伤害，然后移除场上其他目标身上的花鼓。</p><p>·当你出招选择目标时，你可以将自身存在的所有层数“花鼓”都转移给对方，若是范围招式，由你选择转移给任意一个敌人。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "施加花鼓自动。花鼓倒计时及炸裂自动（回合开始）。转移花鼓手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加花鼓",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"花鼓\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.attacker, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "花开富贵",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>左手锣，右手鼓，锣鼓敲打对目标造成 0.4 内息点内功伤害。命中无架招目标时，若目标具有“花鼓”层数，将它减少一层，若因此层数归零，则花鼓立即炸开，触发爆发伤害。</p><p><strong>升级：</strong>招式伤害+10，减少层数+1，内力消耗+2。</p>",
                    "automationNote": "命中减少花鼓层数自动（触发炸裂逻辑）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "催动花鼓",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const target = args.target;\n    const huagu = target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"huagu\");\n    if (huagu) {\n        const lvl = Math.max(1, move.computedLevel || 1);\n        const reduce = 1 + (lvl - 1);\n        const current = huagu.getFlag(\"xjzl-system\", \"stacks\") || 1;\n        if (current <= reduce) {\n            // 触发炸裂\n            let total = 0;\n            if (game.combat) {\n                for (let c of game.combat.combatants) {\n                    const e = c.actor?.effects.find(ef => ef.getFlag('xjzl-system', 'slug') === 'huagu');\n                    if (e) total += (e.getFlag('xjzl-system', 'stacks') || 1);\n                }\n            }\n            const dmg = total * 10;\n            ChatMessage.create({content: `${target.name} 花鼓被迫炸裂！受到 ${dmg} 点精神伤害。`});\n            await target.applyDamage({amount: dmg, type: 'mental', ignoreDefense: true, isHit: true});\n            await huagu.delete();\n        } else {\n            await game.xjzl.api.effects.removeEffect(target, \"huagu\", reduce);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "锣鼓催花",
                    "type": "qi",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>欢快清脆，鼓点绵密，为自身添加一层“花鼓”，持续到脱战。</p><p><strong>升级：</strong>额外添加一层，内力消耗+2。</p>",
                    "automationNote": "添加花鼓自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加花鼓",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst stacks = 1 + (lvl - 1);\nconst eff = thisItem.effects.getName(\"花鼓\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "得儿铃铛",
                    "type": "qi",
                    "isUltimate": true,
                    "actionType": "heal",
                    "element": "yang",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>得儿飘，得儿飘，欢快舞鼓，为范围内所有友方回复气血内力 10 点，然后为他们添加一层“花鼓”，持续到脱战。</p><p><strong>升级：</strong>回复气血内力+20，怒气消耗-1，额外添加一层“花鼓”，内力消耗+4。</p>",
                    "automationNote": "回复及添加花鼓自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "回复与花鼓",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst heal = 10 + (lvl - 1) * 20;\nconst stacks = 1 + (lvl - 1);\n\nawait args.target.applyHealing({amount: heal, type: \"hp\", showScrolling: true});\nawait args.target.applyHealing({amount: heal, type: \"mp\", showScrolling: true});\n\nconst eff = thisItem.effects.getName(\"花鼓\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nfor(let i=0; i<stacks; i++) {\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "花鼓",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "回合初层数-1，归零炸裂。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "huagu",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "倒计时炸裂",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "const stacks = thisEffect.getFlag('xjzl-system', 'stacks') || 1;\nif (stacks <= 1) {\n    let total = 0;\n    if (game.combat) {\n        for (let c of game.combat.combatants) {\n            const e = c.actor?.effects.find(ef => ef.getFlag('xjzl-system', 'slug') === 'huagu');\n            if (e) total += (e.getFlag('xjzl-system', 'stacks') || 1);\n        }\n    }\n    const dmg = total * 10;\n    ChatMessage.create({content: `${actor.name} 花鼓炸裂！受到 ${dmg} 点精神伤害。`});\n    await actor.applyDamage({amount: dmg, type: 'mental', ignoreDefense: true, isHit: true});\n    await thisEffect.delete();\n    ui.notifications.info(\"花鼓已炸裂，请GM手动移除场上其他人的花鼓效果。\")\n} else {\n    await game.xjzl.api.effects.removeEffect(actor, \"huagu\", 1);\n}"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "赛马曲",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>以其磅礴的气势、热烈的气息、奔放的旋律而广为流传，所需拨弦、颤音技巧极高。</p><p><strong>需求：</strong>乐器-二胡</p><p><strong>属性：</strong>刚</p>",
            "requirements": "乐器-二胡",
            "moves": [
                {
                    "name": "一马平川",
                    "type": "real",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "8米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>手腕瞬间甩动，喷弓强音，对目标造成 0.5 内息点内功伤害。自身获得一层“乘风”，至多三层，持续到战斗脱离。</p><p><strong>乘风：</strong>每层使你速度+1。</p><p>·若你当前速度是全场最高的，改为为所有友方添加一层“乘风”，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "获得乘风自动。全场速度最高给予队友需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "乘风逻辑",
                            "trigger": "hit_once",
                            "script": "const eff = CONFIG.statusEffects.find(e => e.id === \"chengfeng\");\nif(eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.flags[\"xjzl-system\"].maxStacks = 3;\n    await game.xjzl.api.effects.addEffect(actor, data);\n    ui.notifications.info(\"若速度全场最高，请手动给队友施加 [乘风] (使用系统通用状态栏)。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "快马加鞭",
                    "type": "feint",
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>颤指打音，如奔腾嘶鸣，对目标造成 0.4 内息点内功伤害，击破架招时，可以消耗反应动作演奏一招乐谱散手，但[演奏]检定结果-2。</p><p><strong>升级：</strong>伤害+10，演奏检定结果+1，内力消耗+2。</p>",
                    "automationNote": "击破提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const malus = -2 + (lvl - 1);\n    ui.notifications.info(`击破架招！可消耗反应动作释放乐谱散手 (演奏检定 ${malus})。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "茫茫草原",
                    "type": "stance",
                    "element": "gang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持弓抚琴，气宇轩昂，开启架招。架招开启期间，你每通读一册乐谱，你的移动速度+1。</p><p>·格挡成功后进行一次[演奏]检定（难度 15），成功则顿弓紧音，将目标朝自己方向拉扯 1 米，然后使其倒地。</p><p><strong>升级：</strong>格挡值+10，[演奏]难度-1，内力消耗+2。</p>",
                    "automationNote": "乐谱速度加成手动（AE修改）。格挡反击检定自动。拉扯倒地手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡反击",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst dc = 15 - (lvl - 1);\n\n// 自动投掷检定\nconst roll = await actor.rollAttributeTest(\"yanzou\");\nif (roll.total >= dc) {\n    ChatMessage.create({\n        content: `<div style=\"color:green; font-weight:bold;\">演奏检定成功！</div><p>请手动将 ${args.attacker.name} 拉近 1 米并击倒。</p>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n    await game.xjzl.api.effects.toggleStatus(args.attacker, \"prone\", true);\n} else {\n    ui.notifications.warn(\"反击演奏检定失败。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万马奔腾",
                    "type": "real",
                    "isUltimate": true,
                    "element": "gang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "15米",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>拨弦如马蹄，群马竞相争，对直线上敌人造成 0.7 内息点内功伤害，并将他们击退 5 米。</p><p>·招式伤害提升自身【移动速度】*1 的伤害。</p><p>·你可以移除三层“乘风”，让招式目标从直线敌人改为对周围敌人释放。</p><p><strong>升级：</strong>招式伤害 20，提升的伤害系数+1，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "速度增伤自动。乘风消耗及范围改变需手动确认。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "速度增伤",
                            "trigger": "calc",
                            "script": "const speed = actor.system.combat.speedTotal || 0;\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst coef = 1 + (lvl - 1);\nconst bonus = speed * coef;\nargs.output.damage += bonus;\nargs.output.bonusDesc.push(`速度增伤 +${bonus}`);",
                            "active": true
                        },
                        {
                            "label": "乘风消耗",
                            "trigger": "attack",
                            "script": "const chengfeng = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"chengfeng\");\nif (chengfeng && (chengfeng.getFlag(\"xjzl-system\", \"stacks\") || 1) >= 3) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"万马奔腾\" },\n        content: \"<p>是否消耗 3 层 [乘风] 将范围改为 <b>周围</b>？</p>\",\n        yes: { label: \"消耗并改范围\", icon: \"fas fa-check\" },\n        no: { label: \"保持直线\", icon: \"fas fa-times\" }\n    });\n    if (confirm) {\n        await chengfeng.delete();\n        ui.notifications.info(\"已消耗乘风，请手动对周围敌人进行检定/伤害应用。\");\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "五十弦音",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>“太帝使素女鼓五十弦瑟，悲，帝禁不止，故破其瑟为二十五弦”。五十弦音手法逸绝，非凡人所能为，弹奏者好似天仙下凡。</p><p><strong>需求：</strong>乐器-琴</p><p><strong>属性：</strong>柔</p>",
            "requirements": "乐器-琴",
            "moves": [
                {
                    "name": "锦瑟无端",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，轻弹瑟，引哀声，对周围敌人造成 0.6 内息点内功伤害，同时，给范围内除自身外的所有其他角色不分敌我地添加“悲情”状态，持续到战斗脱离，若目标身上已有“悲情”状态，则消除悲情，给予“悲极”状态，持续到战斗脱离。</p><p><strong>悲情：</strong>招式伤害减少 10 点。</p><p><strong>悲极：</strong>招式伤害减少 20 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "伤害自动。状态切换逻辑自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加悲情/悲极",
                            "trigger": "hit",
                            "script": "if (args.target.id === actor.id) return;\n\nconst beiqing = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beiqing\");\n\nif (beiqing) {\n    await beiqing.delete();\n    const beijiData = thisItem.effects.getName(\"悲极\").toObject();\n    beijiData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, beijiData);\n    ui.notifications.info(`${args.target.name} 悲情转化为悲极`);\n} else {\n    const beiji = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beiji\");\n    if (!beiji) {\n        const beiqingData = thisItem.effects.getName(\"悲情\").toObject();\n        beiqingData.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.target, beiqingData);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "花好月圆",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，轻拂弦，花好月圆夜，欢喜涌上心头，对目标造成 0.7 内息点内功伤害，并为范围内所有其他角色不分敌我地添加“喜悦”，持续到战斗脱离。若目标身上已有喜悦，则消除喜悦，变为“乐极”。若目标身上同时具有“悲情”和“喜悦”，或“悲极”和“乐极”，则消除对应两个状态。</p><p><strong>喜悦：</strong>招式伤害增加 10 点。</p><p><strong>乐极：</strong>招式伤害增加 20 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "伤害自动。状态切换逻辑自动。状态抵消逻辑自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加喜悦/乐极与抵消",
                            "trigger": "hit",
                            "script": "if (args.target.id === actor.id) return;\n\n// 1. 处理喜悦/乐极\nconst xiyue = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xiyue\");\nlet hasLeji = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leji\");\n\nif (xiyue) {\n    await xiyue.delete();\n    const lejiData = thisItem.effects.getName(\"乐极\").toObject();\n    lejiData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, lejiData);\n    hasLeji = true;\n    ui.notifications.info(`${args.target.name} 喜悦转化为乐极`);\n} else if (!hasLeji) {\n    const xiyueData = thisItem.effects.getName(\"喜悦\").toObject();\n    xiyueData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, xiyueData);\n}\n\n// 2. 处理抵消 (延时确保状态已应用)\nsetTimeout(async () => {\n    const t = args.target;\n    const s_beiqing = t.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beiqing\");\n    const s_xiyue = t.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"xiyue\");\n    const s_beiji = t.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"beiji\");\n    const s_leji = t.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leji\");\n\n    if (s_beiqing && s_xiyue) {\n        await s_beiqing.delete();\n        await s_xiyue.delete();\n        ui.notifications.info(`${t.name} 的悲情与喜悦相互抵消`);\n    }\n    if (s_beiji && s_leji) {\n        await s_beiji.delete();\n        await s_leji.delete();\n        ui.notifications.info(`${t.name} 的悲极与乐极相互抵消`);\n    }\n}, 500);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "高山流水",
                    "type": "qi",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，高山流水，觅知音，使范围内所有其他角色进行一个[气感]检定，并且自己进行[演奏]检定，选择范围中一个[气感]检定+你的[演奏]检定数值之和大于 40 的目标，使其获得“知音”状态，持续到战斗脱离。场上同时只能有一个知音。</p><p><strong>知音：</strong>《五十弦音》添加状态的效果提升 1 倍。</p><p><strong>升级：</strong>知音最大数量+1，内力消耗+8。</p>",
                    "automationNote": "检定流程提示自动。施加知音状态手动。知音效果翻倍手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "发起检定流程",
                            "trigger": "hit",
                            "script": "if (args.target.id === actor.id) return;\n\nconst myRoll = await actor.rollAttributeTest(\"yanzou\", { skipDialog: true });\nconst myTotal = myRoll.total;\n\nawait Macros.requestSave({\n    target: args.target,\n    type: \"qigan\",\n    dc: 0,\n    label: `高山流水觅知音 (演奏值: ${myTotal})`,\n    attacker: actor\n});\n\nChatMessage.create({\n    content: `<b>高山流水判定</b><br>演奏者 (${actor.name}) 演奏检定: ${myTotal}<br>请GM查看目标 (${args.target.name}) 的气感检定结果。<br>若两者之和 > 40，请手动施加 [知音] 状态。`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ],
                    "actionType": "buff"
                },
                {
                    "name": "天音魔舞",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，魔音勾七情，曼舞引六欲，使范围内所有其他角色不分敌我获得“走火入魔”一回合，走火入魔结束后再获得“乱欲”状态，持续一回合。</p><p><strong>乱欲：</strong>若你具有悲情或悲极（喜悦或乐极），必须对喜悦或乐极（悲情或悲极）的目标发动攻击，攻击相关规则参照走火入魔。</p><p><strong>升级：</strong>乱欲持续回合+1，怒气-1，内力消耗+16。</p>",
                    "automationNote": "施加走火入魔自动。乱欲状态手动。乱欲强制攻击手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加走火入魔",
                            "trigger": "hit",
                            "script": "if (args.target.id === actor.id) return;\n\nconst eff = CONFIG.statusEffects.find(e => e.id === \"rage\");\nif (eff) {\n    const data = foundry.utils.deepClone(eff);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}\n\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst luanyuRounds = 1 + (lvl - 1);\nui.notifications.info(`对 ${args.target.name} 施加走火入魔。请在结束后手动施加 [乱欲] (${luanyuRounds}回合)`);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "悲情",
                    "icon": "icons/svg/rain.svg",
                    "description": "招式伤害减少 10 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "beiqing",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                },
                {
                    "name": "悲极",
                    "icon": "icons/svg/rain.svg",
                    "description": "招式伤害减少 20 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "beiji",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "-20"
                        }
                    ]
                },
                {
                    "name": "喜悦",
                    "icon": "icons/svg/sun.svg",
                    "description": "招式伤害增加 10 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xiyue",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "10"
                        }
                    ]
                },
                {
                    "name": "乐极",
                    "icon": "icons/svg/sun.svg",
                    "description": "招式伤害增加 20 点。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "leji",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "20"
                        }
                    ]
                },
                {
                    "name": "知音",
                    "icon": "icons/magic/sonic/explosion-shock-wave-teal.webp",
                    "description": "《五十弦音》添加状态的效果提升 1 倍。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhiyin",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "乱欲",
                    "icon": "icons/magic/control/confusion-string-red.webp",
                    "description": "必须对特定情绪目标发动攻击。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "luanyu",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "大雷音鼓",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>一声惊雷天地动，银蛇电闪雨倾盆。传闻中雷公敲的便是此鼓，可惊摄万魔，也可以使万物复苏。</p><p><strong>需求：</strong>乐器-锣鼓</p><p><strong>属性：</strong>阳</p>",
            "requirements": "乐器-锣鼓",
            "moves": [
                {
                    "name": "平地惊雷",
                    "type": "real",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，持槌跃起（半空中），猛击鼓面，如雷炸响，对周围敌人造成 0.6 力量点内功伤害，并给他们添加“雷音”，持续两回合。</p><p><strong>雷音：</strong>受到乐器攻击时额外流失 10 气血，且被向【攻击者面朝的方向】击飞 1 米。</p><p><strong>升级：</strong>招式伤害+10，雷音流失气血+5，消耗+8。</p>",
                    "automationNote": "伤害自动。施加雷音自动。雷音的流失气血和击飞效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加雷音",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"雷音\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n// 动态写入描述以便玩家查看流失量\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst bleed = 10 + (lvl - 1) * 5;\neff.description += ` (当前流失量: ${bleed})`;\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "如雷贯耳",
                    "type": "feint",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，连绵不断，敲击鼓边，对所有敌人造成 0.5 力量点内功伤害，击破架招后，为其添加“耳鸣”，持续到战斗脱离。</p><p>·若目标具有“雷音”，则改为使其耳膜破裂，永久“失聪”，且失去基础闪避。（残疾列表 51）</p><p><strong>升级：</strong>伤害+10，消耗+8。</p>",
                    "automationNote": "击破后检测雷音自动。施加耳鸣或失聪AE自动（失聪AE包含禁闪，永久效果）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破/雷音检测",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const hasLeiyin = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiyin\");\n    \n    if (hasLeiyin) {\n        const shicong = thisItem.effects.getName(\"失聪\").toObject();\n        shicong.origin = thisItem.uuid;\n        await game.xjzl.api.effects.addEffect(args.target, shicong);\n        ui.notifications.info(`${args.target.name} 耳膜破裂，永久失聪！`);\n    } else {\n        const eff = CONFIG.statusEffects.find(e => e.id === \"deaf\");\n        if(eff) {\n            const data = foundry.utils.deepClone(eff);\n            await game.xjzl.api.effects.addEffect(args.target, data);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "鼓声雷动",
                    "type": "stance",
                    "element": "yang",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，轻点鼓面，隆隆作响，开启架招。格挡成功后，为目标添加“雷音”，持续一回合。</p><p><strong>升级：</strong>格挡值+10，消耗+4。</p>",
                    "automationNote": "格挡施加雷音自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-雷音",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (!args.attacker) return;\n\nconst eff = thisItem.effects.getName(\"雷音\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst bleed = 10 + (lvl - 1) * 5;\n\neff.description += ` (当前流失量: ${bleed})`;\neff.duration = { rounds: 1 };\n\nawait game.xjzl.api.effects.addEffect(args.attacker, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "暴跳如雷",
                    "type": "counter",
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放，压制对方虚招，用力将鼓扔出，砸击目标，对其造成 0.7 力量点内功伤害。若目标具有“雷音”，锣鼓回到你手中，否则视作脱手，掉落在目标周围随机空格。</p><p><strong>升级：</strong>招式伤害+10，消耗+4。</p>",
                    "automationNote": "伤害自动。雷音判断提示自动。武器脱手手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "检测雷音/脱手",
                            "trigger": "hit",
                            "script": "const hasLeiyin = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiyin\");\nif (hasLeiyin) {\n    ui.notifications.info(\"目标具有雷音，锣鼓飞回手中。\");\n} else {\n    ui.notifications.warn(\"目标无雷音，锣鼓脱手！请手动处理武器掉落。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "雷霆万钧",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yang",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "15米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，竖起打鼓，左右狂敲，惊天动地，对范围所有敌方造成 0.8 力量点内功伤害，然后不消耗动作对每个具有雷音的目标施展【如雷贯耳】。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，内力消耗+16。</p>",
                    "automationNote": "基础伤害自动。追击逻辑提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "追击提示",
                            "trigger": "hit",
                            "script": "const hasLeiyin = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"leiyin\");\nif (hasLeiyin) {\n    ui.notifications.info(`${args.target.name} 具有 [雷音]，请手动免费施展 [如雷贯耳]`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "雷音",
                    "icon": "icons/svg/sound.svg",
                    "description": "受到乐器攻击时流失气血，且被击飞。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "leiyin",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "失聪",
                    "icon": "icons/svg/deaf.svg",
                    "description": "永久失聪，失去基础闪避。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "shicong",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.grantAttackLevel",
                            "mode": 2,
                            "value": "1"
                        },
                        {
                            "key": "system.combat.dodge",
                            "mode": 2,
                            "value": "-10"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "岁月史歌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>此曲谱写自三皇五帝至今数千年中的历史变迁，共分各朝代诸侯国百二十套曲，磅礴恢弘大气。</p><p><strong>需求：</strong>乐器</p><p><strong>属性：</strong>太极</p>",
            "requirements": "乐器",
            "moves": [
                {
                    "name": "兴亡盛衰",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，高低调变奏，长短音更迭，对范围内所有敌人造成 0.6 内息点内功伤害。为每一个命中的敌人添加“岁月”，持续到战斗脱离或陷入濒死。</p><p><strong>岁月：</strong>有岁月的人数增加后，在岁月人数减少前，岁月兴盛，你出招后流失岁月人数*5 的内力。</p><p>·当具有岁月的人数减少后，在岁月人数增加前，岁月衰亡，你出招后流失岁月人数*10 的气血。</p><p><strong>升级：</strong>伤害+10，流失内力+5、气血+10，消耗+8。</p>",
                    "automationNote": "伤害自动。施加岁月自动。内力/气血流失手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加岁月",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"岁月\").toObject();\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.target, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "聚散离合",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，音调欢欣，快速落寞，悲从中来，对目标造成 0.6 内息点内功伤害，击破架招后，为其添加“封招”，持续一回合。</p><p>·目标如果具有岁月，还需进行[定力]检定（难度15），失败则苦痛于过去的离别愁绪中，封招的持续回合数+1。</p><p><strong>升级：</strong>伤害+10，失败后持续回合再+1，消耗+4。</p>",
                    "automationNote": "击破封招自动。定力检定提示手动。封招回合数增加手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破/岁月判定",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    let rounds = 1;\n    const hasSuiyue = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suiyue\");\n    \n    if (hasSuiyue) {\n        await Macros.requestSave({\n            target: args.target,\n            type: \"dingli\",\n            dc: 15,\n            label: \"定力检定 (失败封招+1回合)\",\n            attacker: actor\n        });\n        ui.notifications.info(`${args.target.name} 需进行定力检定。若失败，请手动增加封招回合数。`);\n    }\n    \n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: rounds };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "生前身后",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，清澈悦耳，洒脱豁然，开启架招。架招开启期间，场上具有“岁月”的人数每次增加或减少时，你获得 1 点怒气。</p><p>·你被击破架招时，具有“岁月”的目标怒气-2。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "被击破扣怒自动。岁月人数变化的获怒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被击破扣怒",
                            "trigger": "damaged",
                            "script": "if (args.isBroken && args.attacker) {\n    const hasSuiyue = args.attacker.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suiyue\");\n    if (hasSuiyue) {\n        const curRage = args.attacker.system.resources.rage.value;\n        if (curRage > 0) {\n            const newRage = Math.max(0, curRage - 2);\n            await args.attacker.update({\"system.resources.rage.value\": newRage});\n            ui.notifications.info(`${args.attacker.name} 击破架招但受岁月影响，怒气-2`);\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "人间英雄",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "instrument",
                    "range": "25米",
                    "targetInfo": "自身",
                    "actionCost": "全回合动作",
                    "description": "<p>全回合动作，荡气回肠，天长地久，范围内每有一人具有“岁月”，你获得一回合“英雄”状态。</p><p><strong>英雄：</strong>只要你没有陷入濒死，全场其他友方陷入濒死后，都会回复 1 点气血，然后恢复行动。</p><p><strong>升级：</strong>释放动作下降一级，怒气-1，内力消耗+8。</p>",
                    "automationNote": "统计岁月人数获英雄状态自动。复活效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得英雄",
                            "trigger": "hit",
                            "script": "let count = 0;\ncanvas.tokens.placeables.forEach(t => {\n    if (t.actor && t.actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"suiyue\")) {\n        count++;\n    }\n});\n\nif (count > 0) {\n    const eff = thisItem.effects.getName(\"英雄\").toObject();\n    eff.origin = thisItem.uuid;\n    eff.duration = { rounds: count };\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(`场上存在 ${count} 个岁月，获得 ${count} 回合 [英雄]`);\n} else {\n    ui.notifications.warn(\"场上无岁月目标，无法获得 [英雄]\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "岁月",
                    "icon": "icons/magic/time/hourglass-tilted-gray.webp",
                    "description": "标记状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "suiyue",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "英雄",
                    "icon": "icons/svg/angel.svg",
                    "description": "友方濒死复活。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yingxiong",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "十面埋伏",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>又名《淮阴平楚》，描绘了楚汉相争的战争场面，乐曲激烈残酷，似有对殒命者的痛悯，震撼人心。</p><p><strong>需求：</strong>乐器-琵琶</p><p><strong>属性：</strong>阴</p>",
            "requirements": "乐器-琵琶",
            "moves": [
                {
                    "name": "列营点将",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "instrument",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，由远及近，整齐紧凑，开启架招。格挡成功后，获得“伏杀”，持续一回合或解除架招。</p><p><strong>伏杀：</strong>命中无架招目标时，移除其任意一个状态。</p><p><strong>升级：</strong>格挡值+10，伏杀持续回合+1，消耗+4。</p>",
                    "automationNote": "格挡获伏杀自动。伏杀的驱散效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-伏杀",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst eff = thisItem.effects.getName(\"伏杀\").toObject();\ndelete eff._id;\neff.origin = thisItem.uuid;\n\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\n\neff.duration = { rounds: 1 + (lvl - 1) };\n\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "血战九里",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，喧嚣激烈，反复变奏，对范围内敌人造成 0.6 内息点内功伤害，每将一个目标打入濒死，添加一个五声音阶。</p><p><strong>升级：</strong>招式伤害+10，消耗+8。</p>",
                    "automationNote": "濒死检测提示自动。五声音阶手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "濒死检测",
                            "trigger": "hit",
                            "script": "if (args.isDying) {\n    ui.notifications.info(\"目标进入濒死，请手动添加 [五声音阶]\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "垓下之围",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，迟缓紧张，阴森恐怖，对目标造成 0.6 内息点内功伤害，击破架招后，为其添加“禁疗”，持续三回合。</p><p><strong>禁疗：</strong>你无法回复气血。</p><p>·若目标具有士气，招式虚招值+1。</p><p><strong>升级：</strong>伤害+10，虚招值再+1，消耗+4。</p>",
                    "automationNote": "士气检测增加虚招自动。击破施加禁疗自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "士气检测",
                            "trigger": "check",
                            "script": "if (args.target.system.resources.morale.value > 0) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const bonus = 1 + (lvl - 1);\n    args.flags.grantFeint += bonus;\n}",
                            "active": true
                        },
                        {
                            "label": "击破-禁疗",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"jinliao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 3 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被禁疗！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "霸王别姬",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后可消耗反应动作释放，压制对方虚招，可奈何，奈若何，造成 0.7 内息点内功伤害。</p><p>·你选择场上目标的一名友方结拜或结婚对象（若有），他进行一次残疾检定，且检定结果-2。</p><p><strong>升级：</strong>招式伤害+10，检定结果-1，消耗+2。</p>",
                    "automationNote": "伤害自动。残疾检定效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            6,
                            8,
                            10
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst malus = 2 + (lvl - 1);\nui.notifications.info(`命中提示：请手动选择目标的友方(结拜/结婚)，令其进行残疾检定，结果 -${malus}。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "乌江自刎",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "instrument",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，凄切悲壮，低沉无比，对目标造成 1.0 内息点内功伤害。</p><p>·若自身具有“伏杀”且此招将目标打入濒死，即使他仍有内力护体，也需要进行一次死亡检定。</p><p><strong>升级：</strong>招式伤害+20，怒气-1，消耗+8。</p>",
                    "automationNote": "伤害自动。死检逻辑提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 1.0
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            7,
                            6,
                            5,
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "死检提示",
                            "trigger": "hit",
                            "script": "const hasFusha = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"fusha\");\nif (hasFusha && args.isDying) {\n    ui.notifications.warn(`${args.target.name} 触发乌江自刎特效：请忽略内力，立即进行死亡检定！`);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "伏杀",
                    "icon": "icons/svg/target.svg",
                    "description": "命中移除状态。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "fusha",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    }
]