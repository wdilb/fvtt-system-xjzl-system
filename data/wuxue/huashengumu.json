[
    {
        "name": "蝶舞飘",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>花神殿武学，以水袖击敌，飘逸曼妙，令人心迷。</p><p><strong>需求：</strong>奇门-鞭钩</p><p><strong>属性：</strong>柔</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "飘絮飞蝶",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "special",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，挥舞丝带，翩翩起舞，开启架招。同时获得一层“粉蝶”，至多三层，持续到战斗脱离。</p><p><strong>粉蝶：</strong>出招前你可以消耗若干层粉蝶，每消耗一层粉蝶，使你此次施展《蝶舞飘》时招式伤害+10。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启架招自动获得粉蝶。消耗粉蝶增伤需在其他招式中手动触发（暂未强制自动化消耗逻辑）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得粉蝶",
                            "trigger": "attack",
                            "script": "const effData = thisItem.effects.getName(\"粉蝶\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "翩飞弄舞",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，翩翩起舞，转起手中丝带，跳跃（半空中）至 3 米范围内的空格，对周围敌人造成 0.4 内息点内功伤害，每击中一个目标，获得一层“粉蝶”，至多三层，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "命中获得粉蝶自动。跳跃/移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中获蝶",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = thisItem.effects.getName(\"粉蝶\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(attacker, effData);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "江上重月",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，巧舞步轻点，意凝丝带出，对目标造成 0.4 内息点内功伤害，击破对方架招时，使目标陷入“禁足”，持续两回合。之后自身获得两层“粉蝶”，至多三层，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加禁足自动。自身获得粉蝶自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const rootEff = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if (rootEff) {\n        const data = foundry.utils.deepClone(rootEff);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被禁足！`);\n    }\n}\n// 获得2层粉蝶\nconst effData = thisItem.effects.getName(\"粉蝶\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(attacker, effData);\nawait game.xjzl.api.effects.addEffect(attacker, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "落花随舞",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，微微躬身，随风起舞，对周围敌人造成 0.7 内息点内功伤害。</p><p>·若击中无架招的目标，可以消耗三层“粉蝶”，让该目标花费反应动作，随你一起舞蹈，若对方没有反应动作，流失 30 点内力、3 点怒气。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "命中无架招检测自动。消耗粉蝶询问弹窗。流失效果自动。反应动作判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗粉蝶追击",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const fendie = attacker.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_fendie\");\n    const stacks = fendie ? (fendie.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\n\n    if (stacks >= 3) {\n        const confirm = await foundry.applications.api.DialogV2.confirm({\n            window: { title: \"落花随舞\" },\n            content: `<p>命中无架招目标 <b>${args.target.name}</b>。</p><p>是否消耗 3 层 [粉蝶] 触发特效？</p>`,\n            yes: { label: \"消耗\" },\n            no: { label: \"跳过\" }\n        });\n\n        if (confirm) {\n            await game.xjzl.api.effects.removeEffect(attacker, \"wuxue_fendie\", 3);\n            // 发送提示信息\n            ChatMessage.create({\n                content: `<div class=\"xjzl-chat-card\">\n                    <div style=\"font-weight:bold; color:#e91e63;\">粉蝶起舞</div>\n                    <div>目标 <b>${args.target.name}</b> 需消耗反应动作跟随舞蹈。</div>\n                    <div style=\"font-size:0.9em; color:#666;\">若无反应动作，请GM手动扣除目标 30内力 和 3怒气。</div>\n                </div>`,\n                speaker: ChatMessage.getSpeaker({actor: attacker})\n            });\n            // 尝试自动扣除 (如果目标是 Token/Actor)\n            // 这里简化处理：直接扣，假设对方没有反应动作 (通常系统不追踪反应动作状态)\n            await args.target.applyHealing({ amount: -30, type: \"mp\" });\n            const rage = args.target.system.resources.rage.value;\n            await args.target.update({ \"system.resources.rage.value\": Math.max(0, rage - 3) });\n        }\n    }\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "粉蝶",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "出招前消耗可增加伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_fendie",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "移花掌法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>花神殿最为高深的掌法，神鬼莫敌，以柔克刚、后发制人，牵引挪移反弹敌方武学。</p><p><strong>需求：</strong>徒手</p><p><strong>属性：</strong>柔</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "金枝玉叶",
                    "type": "stance",
                    "element": "rou",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，手仰抚云，开启架招。成功格挡后，给对方添加一层“飞花”，持续到脱战。</p><p><strong>飞花：</strong>你因《移花掌法》招式效果受到伤害（包括流失）时，每层流失 5 点内力。</p><p><strong>升级：</strong>格挡值+10，额外叠加一层飞花，消耗+4。</p>",
                    "automationNote": "格挡施加飞花自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-飞花",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nif (args.attacker) {\n    const effData = thisItem.effects.getName(\"飞花\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    \n    // 升级检测: 若等级>=2 (即升级过1次)，额外叠加\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    \n    await game.xjzl.api.effects.addEffect(args.attacker, effData);\n    if (lvl >= 2) {\n        await game.xjzl.api.effects.addEffect(args.attacker, effData);\n    }\n    ui.notifications.info(`${args.attacker.name} 沾染了 [飞花]`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "花须蝶芒",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，聚气幽兰，盈盈一击，对目标造成 0.7 内息点内功伤害，并对目标周围 2 米范围内其他敌人造成本次伤害（扣除防御前）一半的气血流失。</p><p>·流失气血的目标不受“飞花”的内力流失效果。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "溅射伤害手动提示。飞花扣蓝自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "溅射提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const splashDmg = Math.floor(args.damageResult.finalDamage / 2);\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"font-weight:bold; color:#9c27b0;\">花须蝶芒 - 溅射</div>\n            <div>请对目标周围 2米 内其他敌人造成 <b>${splashDmg}</b> 点气血流失。</div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "枯木生花",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "15米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，飘引回身，流转气劲对目标造成 0.6 内息点内功伤害。击破对方架招时，“飞花”使目标流失双倍的内力，并使目标陷入“缚身”，持续两回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破缚身自动。双倍扣蓝通过临时Flag传递给飞花脚本。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破效果",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    // 1. 施加缚身\n    const fushen = CONFIG.statusEffects.find(e => e.id === \"fushen\");\n    if (fushen) {\n        const data = foundry.utils.deepClone(fushen);\n        data.duration = { rounds: 2 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n    \n    // 2. 补扣飞花蓝量 (飞花自带脚本只扣了1倍，这里再扣1倍)\n    const feihua = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_feihua\");\n    if (feihua) {\n        const stacks = feihua.getFlag(\"xjzl-system\", \"stacks\") || 1;\n        const extraDrain = 5 * stacks;\n        await args.target.applyHealing({ amount: -extraDrain, type: \"mp\" });\n        ui.notifications.info(\"枯木生花击破：触发双倍飞花扣蓝\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "玉树琼芝",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "25米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对手虚招时，可消耗反应动作释放此招，压制虚招，花开即逝，婉转一击对其造成 0.8 内息点内功伤害。并对目标周围 2 米范围内其他敌人造成本次伤害（扣除防御前）一半的气血流失。</p><p>·流失气血的目标不受“飞花”的内力流失效果。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "溅射提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "溅射提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const splashDmg = Math.floor(args.damageResult.finalDamage / 2);\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"font-weight:bold; color:#9c27b0;\">玉树琼芝 - 溅射</div>\n            <div>请对目标周围 2米 内其他敌人造成 <b>${splashDmg}</b> 点气血流失。</div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "移花接木",
                    "type": "qi",
                    "isUltimate": true,
                    "actionType": "buff",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "20米",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>-花神鬼魅，他山之玉- 次要动作，为自身添加“移花”，持续两回合。</p><p><strong>移花：</strong>每当你受到内外功伤害时，减免其中一半的伤害（扣除防御之前），减免的伤害会以气血流失的形式由周围 20 米内的随机一名敌方承担。</p><p><strong>升级：</strong>移花持续回合数+1，怒气消耗-1，消耗+8。</p><p>·当修炼至【合一】时，“移花”承担伤害的目标可以变为由你指定的目标。</p>",
                    "automationNote": "移花护盾自动减伤。反弹伤害提示手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            6,
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得移花",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 2 + (lvl - 1);\nconst effData = thisItem.effects.getName(\"移花\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\neffData.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "飞花",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
                    "description": "受到移花掌法伤害时流失内力。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_feihua",
                            "stackable": true,
                            "scripts": [
                                {
                                    "label": "受击扣蓝",
                                    "trigger": "damaged",
                                    "script": "// 检查伤害来源\nif (args.item && args.item.name === \"移花掌法\") {\n    const stacks = thisEffect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const drain = 5 * stacks;\n    await actor.applyHealing({ amount: -drain, type: \"mp\", showScrolling: true });\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                },
                {
                    "name": "移花",
                    "icon": "icons/magic/defensive/shield-barrier-pink.webp",
                    "description": "减免一半伤害并转移。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_yihua",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "伤害转移",
                                    "trigger": "preTake",
                                    "script": "if ([\"waigong\", \"neigong\"].includes(args.type)) {\n    const original = args.calcDamage;\n    const reduced = Math.ceil(original / 2);\n    const reflected = original - reduced;\n    \n    // 修改自身承受伤害\n    args.output.damage = reduced;\n    \n    // 提示转移\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"font-weight:bold; color:#e91e63;\">移花接木触发</div>\n            <div>自身减免 <b>${reflected}</b> 点伤害。</div>\n            <div>请指定 20米 内一名敌人承担 <b>${reflected}</b> 点气血流失。</div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "了尘清谈",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>素手执拂尘，我非凡俗人。</p><p><strong>属性：</strong>柔</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "了尘清谈",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "rou",
                    "damageType": "none",
                    "weaponType": "special",
                    "range": "3米",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，淡泊宁静，宁静致远，心无旁骛，无欲清心，真气疾速流转，移除自身任意一个状态，并震退周围 3 米敌人。</p><p><strong>升级：</strong>可额外移除一个状态，怒气-1，消耗+4。</p>",
                    "automationNote": "移除状态和震退均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            4,
                            3,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst count = 1 + (lvl - 1);\nui.notifications.info(`请手动移除自身 ${count} 个状态，并击退周围敌人。`);",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "素月剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>活死人墓祖师所创，每招剑法中均含着一件韵事。</p><p><strong>需求：</strong>剑-单剑</p><p><strong>属性：</strong>阴</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "花前月下",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，单剑颤动，来回挥削，对目标造成 0.5 内息点内功伤害。命中无架招目标时，将其击飞 1 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    ui.notifications.info(`${args.target.name} 被击飞 1 米。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "清饮小酌",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，剑尖上翻，开启架招。格挡成功时，飘身而进，姿态若仙，获得“素月”持续一回合。</p><p><strong>素月：</strong>你不会受到《趁虚而入》攻击，《素月剑法》招式释放距离增加 5 米。</p><p><strong>升级：</strong>格挡值+10，素月持续回合数+1，消耗+2。</p>",
                    "automationNote": "格挡获素月自动。素月效果（防趁虚、加距离）仅提示。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-素月",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\nconst lvl = Math.max(1, thisItem.system.moves.find(m => m.id === actor.system.martial.stance)?.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\n\nconst effData = thisItem.effects.getName(\"素月\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\neffData.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "菊园忆晓",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，剑轮横空，清光铺地，对敌人造成 0.4 内息点内功伤害。击破对方架招时，自身可朝任意方向移动 5 米。</p><p>·若对方处于倒地，招式虚招值+1。</p><p><strong>升级：</strong>招式伤害+10，虚招值再+1，内力消耗+2。</p>",
                    "automationNote": "倒地增加虚招值自动。移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "倒地加虚招值",
                            "trigger": "attack",
                            "script": "// 检查选中的目标\nconst targets = Array.from(game.user.targets);\nif (targets.length === 1) {\n    const t = targets[0].actor;\n    if (t.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"prone\")) {\n        args.flags.bonusFeint += 1;\n        ui.notifications.info(\"目标倒地，虚招值+1\");\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "击破移动提示",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ui.notifications.info(\"击破架招！你可以移动 5 米。\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "梦断清河",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作释放此招，压制虚招，剑锋连点下盘，对其造成 0.6 内息点内功伤害，并为其添加“禁足”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "禁足自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加禁足",
                            "trigger": "hit",
                            "script": "const rootEff = CONFIG.statusEffects.find(e => e.id === \"root\");\nif (rootEff) {\n    const data = foundry.utils.deepClone(rootEff);\n    data.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, data);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "素月分辉",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，分剑节击目标造成 0.8 内息点内功伤害。若自身处于“素月”状态，为招式范围内所有友方添加 10 护体真气，持续到战斗脱离。</p><p><strong>升级：</strong>招式伤害+20，护体真气+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "素月加护体需手动应用（提示）。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "素月护体提示",
                            "trigger": "hit_once",
                            "script": "const hasSuyue = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_suyue\");\nif (hasSuyue) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const huti = 10 + (lvl - 1) * 20;\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"font-weight:bold; color:#2196f3;\">素月分辉 - 护体</div>\n            <div>请为范围内友方手动添加 <b>${huti}</b> 点护体真气。</div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "素月",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
                    "description": "免疫趁虚而入，素月剑法距离+5。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_suyue",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "银索金铃",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p><strong>需求：</strong>奇门-鞭钩</p><p><strong>属性：</strong>阴</p>",
            "requirements": "奇门-鞭钩",
            "moves": [
                {
                    "name": "铃袖善舞",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "10米",
                    "targetInfo": "直线",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，射出金铃索，对一条直线上的目标造成 0.4 内息点内功伤害。命中无架招目标时，为其添加“下盘不稳”状态，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "命中施加下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "圆转如意",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "yin",
                    "damageType": "none",
                    "weaponType": "special",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "全回合动作",
                    "description": "<p>全回合动作，银索随念而转，金铃之声悦耳，为周围所有友方添加“如意”，持续到战斗脱离。</p><p><strong>如意：</strong>一回合一次，你可以消耗次要动作，与另一位存在“如意”的角色互换位置。</p><p>·如意互换位置的距离不可超过此招的施放距离。</p><p><strong>升级：</strong>施放距离+2，内力消耗+4。</p>",
                    "automationNote": "施加BUFF自动。换位手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用如意",
                            "trigger": "hit",
                            "script": "const effData = thisItem.effects.getName(\"如意\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(args.target, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "铃音惑心",
                    "type": "qi",
                    "actionType": "attack",
                    "element": "yin",
                    "damageType": "mental",
                    "weaponType": "special",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，轻摇金铃，铃声清脆，选择范围内一个敌人，让他进行一次[定力]检定（难度 15），失败则心神恍惚，你可以命令他，使其不消耗速度，朝任意方向移动至多 2 米。</p><p><strong>升级：</strong>目标失败移动的距离+2 米，内力消耗+2。</p>",
                    "automationNote": "检定自动。移动手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "请求检定",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dist = 2 + (lvl - 1) * 2;\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"dingli\",\n    dc: 15,\n    label: \"抵抗铃音\",\n    onFail: {\n        name: \"心神恍惚\",\n        description: `受控移动 ${dist} 米`,\n        icon: \"icons/svg/daze.svg\",\n        duration: { turns: 1 }\n    }\n});",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "幻铃缠天",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，银索化千万缕，划出无形轨迹，紧缚敌人，对其造成 0.7 内息点内功伤害，同时为其添加“缚铃”，持续到战斗脱离。</p><p><strong>缚铃：</strong>为你添加此状态的目标，可以在你的每个回合末，不消耗动作、不消耗内力地对你施展一次【铃音惑心】（只要你在他招式范围内）。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "施加缚铃自动。额外施法手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用缚铃",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const effData = thisItem.effects.getName(\"缚铃\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "如意",
                    "icon": "icons/magic/movement/abstract-ribbons-red-orange.webp",
                    "description": "可互换位置。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_ruyi",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "缚铃",
                    "icon": "icons/sundries/misc/bell-rope-gold.webp",
                    "description": "回合末可被施展铃音惑心。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_fuling",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "默然失魂掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "wuxue",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>【默然失魂者，唯别而已矣】</p><p>此功必须要以特殊心境才能真正发挥威力。若能领悟其中“默然”精要，此掌威力普天之下只有降龙神掌可以匹敌。</p><p><strong>需求：</strong>徒手</p><p><strong>属性：</strong>阴</p><p>注：若你曾经拥有，却又失去所有亲人后，便能领悟默然之意。</p><p><strong>默然之意：</strong>进入战斗后，获得“默然”，强化《默然失魂掌》所有招式，持续到战斗脱离。</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "无中生忧",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，左掌右袖、双足腿部、胸背腰腹尽皆有招式发出，对目标造成 0.7 内息点内功伤害。</p><p>若有敌人处于半空状态，可以消耗反应动作释放此招，立于原地，隔空伤敌。</p><p><strong>默然：</strong>击中开启架招的目标时，增加 1 点怒气。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "默然回怒自动。半空判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "默然回怒",
                            "trigger": "hit",
                            "script": "if (args.isHit && args.target.system.martial.stanceActive) {\n    const moran = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_moran\");\n    if (moran) {\n        const rage = actor.system.resources.rage.value;\n        await actor.update({ \"system.resources.rage.value\": rage + 1 });\n        ui.notifications.info(\"默然：击中架招回怒 +1\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "面无血色",
                    "type": "feint",
                    "element": "yin",
                    "damageType": "mental",
                    "weaponType": "unarmed",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，变化百出，使敌心神难以自制，对其造成 0.7 神采点精神伤害（内功命中、内功暴击）。</p><p>若击破目标架招，使对方悲从心中起，伤心欲绝，不能自已，陷入“封招”状态，持续一回合。</p><p><strong>默然：</strong>若你虚招对抗失败，则本招式视作释放失败，敌方无法释放反击压制。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "伤害基于神采自动。击破封招自动。默然效果需手动（GM判无效）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shencai",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破封招",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if (eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被封招！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "心神不宁",
                    "type": "stance",
                    "element": "yin",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，凝目远眺，脚下踱步，开启架招，并获得一层“悲”，至多十层，持续到战斗脱离或解除架招。</p><p>·成功格挡后获得一层“悲”，持续到战斗脱离。</p><p><strong>悲：</strong>每层提高《默然失魂掌》招式伤害 5 点。</p><p><strong>默然：</strong>每层“悲”额外提高招式伤害 5 点。</p><p><strong>升级:</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "开启/格挡获悲自动。悲增伤自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获悲",
                            "trigger": "attack",
                            "script": "const effData = thisItem.effects.getName(\"悲\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        },
                        {
                            "label": "格挡获悲",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst effData = thisItem.effects.getName(\"悲\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        },
                        {
                            "label": "悲增伤",
                            "trigger": "passive",
                            "script": "// 此脚本无效，因为passive只在轻功/散手/开启的架招生效。\n// 我们需要把增伤逻辑写在每个招式的 calc 中。\n// 但为了不重复写，这里作为占位符提醒。\n",
                            "active": false
                        }
                    ]
                },
                {
                    "name": "拖泥带水",
                    "type": "counter",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招后，可消耗反应动作释放此招，压制虚招，飘若流水，却重滞之极，带千斤之力。对目标造成 0.8 内息点内功伤害。</p><p><strong>默然：</strong>顺势击倒目标，并使其陷入“缚身”“禁足”，持续一回合。</p><p><strong>升级:</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "默然效果自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "默然特效",
                            "trigger": "hit",
                            "script": "const moran = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_moran\");\nif (moran && args.isHit) {\n    // 击倒 (Prone)\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    // 缚身\n    const fushen = CONFIG.statusEffects.find(e => e.id === \"fushen\");\n    if (fushen) {\n        const d1 = foundry.utils.deepClone(fushen);\n        d1.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, d1);\n    }\n    // 禁足\n    const root = CONFIG.statusEffects.find(e => e.id === \"root\");\n    if (root) {\n        const d2 = foundry.utils.deepClone(root);\n        d2.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, d2);\n    }\n    ui.notifications.info(\"默然触发：击倒、缚身、禁足！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "倒行逆施",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，头下脚上，倒过身子，逆中有正，正反相冲，自相矛盾，进入“逆练”状态，持续到战斗脱离。</p><p><strong>逆练：</strong>你的内功属性视为阴柔、阳刚或太极。在你的每个回合末，你因逆练真气，经脉受损而受到 200 点气血流失。</p><p><strong>默然：</strong>逆练状态下出招无需遵循套路切换规则。</p><p><strong>升级：</strong>降低因逆练而受到的气血流失 50 点。</p>",
                    "automationNote": "应用逆练自动。逆练流血自动。属性转换和切换规则需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用逆练",
                            "trigger": "hit",
                            "script": "const effData = thisItem.effects.getName(\"逆练\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 升级减少流失\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst reduction = (lvl - 1) * 50;\nconst baseBleed = 200;\nconst finalBleed = Math.max(0, baseBleed - reduction);\n\n// 写入变量\neffData.flags[\"xjzl-system\"].nilianBleed = finalBleed;\n\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "杞人忧天",
                    "type": "real",
                    "isUltimate": true,
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "10米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，举头拍天，掌力化弧，四散落下。对范围内所有敌人造成 0.9 内息点内功伤害。</p><p>·可消耗自身所有的“悲”，使此招圆转广被，无可躲闪，必定命中。</p><p><strong>默然：</strong>目标需要进行一次[定力]检定（难度 20），失败则悲痛欲绝，失去所有怒气。</p><p>·每消耗一层“悲”，检定难度提高 1 点。</p><p><strong>升级:</strong>招式伤害+20，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "消耗悲必中自动。默然定力检定请求自动。怒气清零手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.9
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "悲增伤逻辑(通用)",
                            "trigger": "calc",
                            "script": "const bei = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_bei\");\nif (bei) {\n    const stacks = bei.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const moran = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_moran\");\n    const perStack = moran ? 10 : 5;\n    const bonus = stacks * perStack;\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`悲(${stacks}) 加成 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "消耗悲必中",
                            "trigger": "attack",
                            "script": "const bei = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_bei\");\nif (bei) {\n    const stacks = bei.getFlag(\"xjzl-system\", \"stacks\") || 1;\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"杞人忧天\" },\n        content: `<p>当前有 ${stacks} 层 [悲]。</p><p>是否全部消耗以获得 <b>必中</b> 及提高定力检定难度？</p>`,\n        yes: { label: \"消耗\" },\n        no: { label: \"保留\" }\n    });\n    if (confirm) {\n        await bei.delete();\n        args.flags.forceHit = true;\n        // 传递消耗的层数给 hit 脚本\n        args.flags.beiConsumed = stacks;\n        ui.notifications.info(`消耗 ${stacks} 层悲，攻击必中！`);\n    }\n}",
                            "active": true
                        },
                        {
                            "label": "默然定力检定",
                            "trigger": "hit",
                            "script": "const moran = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_moran\");\nif (moran) {\n    const consumed = args.flags.beiConsumed || 0;\n    const dc = 20 + consumed;\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"dingli\",\n        dc: dc,\n        label: \"抵抗悲痛\",\n        onFail: {\n            name: \"悲痛欲绝\",\n            description: \"怒气清零 (请手动操作)\",\n            icon: \"icons/svg/skull.svg\",\n            duration: { turns: 1 }\n        }\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "默然",
                    "icon": "icons/svg/mystery-man.svg",
                    "description": "默然之意，强化掌法。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_moran",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "悲",
                    "icon": "icons/svg/rain.svg",
                    "description": "每层提高招式伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_bei",
                            "stackable": true,
                            "maxStacks": 10
                        }
                    },
                    "changes": []
                },
                {
                    "name": "逆练",
                    "icon": "icons/svg/hazard.svg",
                    "description": "回合末流失气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_nilian",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "回合末流失",
                                    "trigger": "turnEnd",
                                    "active": true,
                                    "script": "const bleed = thisEffect.getFlag('xjzl-system', 'nilianBleed') || 200;\nawait actor.applyHealing({ amount: -bleed, type: 'hp', showScrolling: true });\nui.notifications.info(`${actor.name} 逆练真气反噬！`);"
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "驭蜂术",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖3.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 1,
            "description": "<p>活死人墓于门派外围养了大量的玉蜂，个头硕大，需要用独特的秘法培养。可以驭其伤敌。</p><p><strong>属性：</strong>阴</p>",
            "requirements": "",
            "moves": [
                {
                    "name": "驭蜂术",
                    "type": "real",
                    "element": "yin",
                    "damageType": "poison",
                    "weaponType": "special",
                    "range": "15米",
                    "targetInfo": "三个",
                    "actionCost": "主要动作",
                    "description": "<p>消耗一瓶玉蜂浆，引来一群蜜蜂，蜇袭范围内最多三个敌人，无需投掷命中，对他们造成 30 点毒素伤害，并进行[韧性]检定（难度 15），失败陷入“鼻青脸肿”，持续一周。</p><p><strong>鼻青脸肿：</strong>神采相关技能检定自动失败。</p><p><strong>升级：</strong>毒素伤害+5，[韧性]检定难度+1。</p>",
                    "automationNote": "消耗玉蜂浆检测自动。必中。伤害/检定请求自动。",
                    "calculation": {
                        "base": 30,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            4
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗玉蜂浆",
                            "trigger": "attack",
                            "script": "const ammo = actor.items.find(i => i.name === \"玉蜂浆\");\nif (ammo && ammo.system.quantity > 0) {\n    await ammo.update({ \"system.quantity\": ammo.system.quantity - 1 });\n    args.flags.forceHit = true; // 无需投掷命中\n} else {\n    ui.notifications.warn(\"缺少 [玉蜂浆]！(未阻止施放，请手动扣除)\");\n    args.flags.forceHit = true;\n}",
                            "active": true
                        },
                        {
                            "label": "请求检定",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst dc = 15 + (lvl - 1);\nawait Macros.requestSave({\n    target: args.target,\n    attacker: actor,\n    type: \"renxing\",\n    dc: dc,\n    label: \"抵抗玉蜂\",\n    onFail: {\n        name: \"鼻青脸肿\",\n        description: \"神采技能检定失败\",\n        icon: \"icons/svg/daze.svg\"\n    }\n});",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "双剑合璧",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖4.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>活死人墓绝技，一阴一阳，合剑共情，威力大增。</p><p><strong>需求：</strong>剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "双剑合璧",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，剑舞云霞，选择 1 米内一名与自己“结拜”或“结婚”之人共同施展此招，对方需消耗反应动作配合你施展，否则你一人无法施展：对你周围 5 米范围内敌人造成 0.3 力量+0.3 内息点内功伤害，并将所有敌人击飞 1 米。</p><p>·当你消耗反应配合他人施展此招时，将你的招式伤害加在对方的招式伤害中，视作伤害提升。</p><p>·本招式每天只可使用一次（无论是你还是配合你施展此招之人），休整后回复。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击飞手动。配合施展需手动计算伤害加成。使用次数限制手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示配合",
                            "trigger": "attack",
                            "script": "ChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div style=\"font-weight:bold; color:#e91e63;\">双剑合璧</div>\n        <div>需 1米 内亲密友方消耗反应动作配合。</div>\n        <div style=\"font-size:0.9em; color:#666;\">若配合，请GM手动将队友的招式伤害加到本次伤害中 (通过Shift+点击手动应用，或在Calc阶段临时调整)。</div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        },
                        {
                            "label": "击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    ui.notifications.info(`${args.target.name} 被击飞 1 米。`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "寒魄银针",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 2,
            "description": "<p>活死人墓独特暗器，针身镂刻花纹，打造精致。此针剧毒无比，一碰即中毒，皮肤全呈黑色，若被碰破皮肤，顷刻便要丧命。</p><p><strong>需求：</strong>暗器-寒魄银针</p><p><strong>属性：</strong>阴</p>",
            "requirements": "暗器-寒魄银针",
            "moves": [
                {
                    "name": "寒魄银针",
                    "type": "real",
                    "element": "yin",
                    "damageType": "neigong",
                    "weaponType": "hidden",
                    "range": "20米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，射出寒光银针，对目标造成 0.5 内息点内功伤害，命中无架招目标时使其陷入“寒魄”，持续十回合。</p><p><strong>寒魄：</strong>陷入“禁足”，且每回合初受到 20 点毒素伤害。</p><p><strong>升级：</strong>寒魄每回合的毒素招式伤害+10 点。</p>",
                    "automationNote": "消耗银针检测自动。命中施加寒魄自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "消耗银针",
                            "trigger": "attack",
                            "script": "const ammo = actor.items.find(i => i.name === \"寒魄银针\");\nif (ammo && ammo.system.quantity > 0) {\n    await ammo.update({ \"system.quantity\": ammo.system.quantity - 1 });\n} else {\n    ui.notifications.warn(\"缺少 [寒魄银针]！(未阻止施放)\");\n}",
                            "active": true
                        },
                        {
                            "label": "施加寒魄",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effData = thisItem.effects.getName(\"寒魄\").toObject();\n    delete effData._id;\n    effData.origin = thisItem.uuid;\n    \n    // 升级加伤\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const dmg = 20 + (lvl - 1) * 10;\n    effData.flags[\"xjzl-system\"].hanpoDmg = dmg;\n    \n    await game.xjzl.api.effects.addEffect(args.target, effData);\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "寒魄",
                    "icon": "systems/xjzl-system/assets/icons/wuxue/江湖1.png",
                    "description": "禁足，每回合受到毒素伤害。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "wuxue_hanpo",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "回合初毒伤",
                                    "trigger": "turnStart",
                                    "active": true,
                                    "script": "const dmg = thisEffect.getFlag('xjzl-system', 'hanpoDmg') || 20;\nawait actor.applyDamage({ amount: dmg, type: 'poison', isHit: true, ignoreDefense: true });"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.forceSpeedZero",
                            "mode": 5,
                            "value": "true"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "纤云翩飞",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/江湖2.png",
        "system": {
            "category": "sanshou",
            "sect": "jianghushili",
            "tier": 3,
            "description": "<p>活死人墓独特绝技，双人如蝴蝶翩飞，无人能留，羡煞旁人。</p>",
            "moves": [
                {
                    "name": "纤云翩飞",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，揽上一名 1 米内的友方，与其一同朝范围内一处空格轻盈飞掠而去，你落地后将其放下在周围空格。</p><p>·飞掠的过程处于半空中，但你和你的友方都无法被选中。</p><p><strong>升级：</strong>飞掠的距离增加 4 米，内力消耗+4。</p>",
                    "automationNote": "纯移动描述。手动执行。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": []
                }
            ]
        }
    }
]