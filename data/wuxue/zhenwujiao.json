[
    {
        "name": "太极剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 1,
            "description": "<p>创派祖师张三丰所创，动作轻灵柔和，细腻舒展，<br>姿态大方，延绵不断，流传于世。</p><p>需求：剑 属性：太极</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "剑化阴阳",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "taiji",
                    "range": "2",
                    "targetInfo": "单体",
                    "actionCost": "蓄力动作（或反应动作）",
                    "description": "<p>蓄力动作，运功向空中挥洒剑气，对周围敌方造成 0.3 内息点内功伤害。<br>若有敌人处于半空中，可消耗反应动作释放此招，立于原地挥剑，攻击空中目标并将其击倒。</p><p>升级:招式伤害+5，内力消耗+2。</p>",
                    "automationNote": "伤害计算自动化。反应动作、攻击空中目标及击倒效果需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "虚实分时",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "taiji",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，轻盈点剑，造成 0.3 内息点内功伤害。<br>击破架招时，为对方添加一层“气虚”，至多三层，持续到战斗脱离。<br>气虚：每层使你回合末流失 5 点内力。</p><p>升级：招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破架招自动施加气虚。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加气虚",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"qixu\");\n    ui.notifications.info(`${args.target.name} 气虚了！`);\n}"
                        }
                    ]
                },
                {
                    "name": "剑倚青天",
                    "type": "counter",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "taiji",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作施展此招，灵动摆剑，对其造成 0.5 内息点内功伤害。同时为对方添加一层“气虚”，至多三层，持续到战斗脱离。<br>气虚：每层使你回合末流失 5 点内力。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中自动施加气虚。反应动作时机需手动判断。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加气虚",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"qixu\");\n}"
                        }
                    ]
                },
                {
                    "name": "剑舞太极",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "taiji",
                    "range": "3",
                    "targetInfo": "周围敌人",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，一气呵成，姿若翩翩，劲气四射，对周围敌人造成 0.5 内息点内功伤害。<br>·此招可移动释放，对移动路径上周围 3 米范围内的敌人造成伤害。（不会重复造成伤害）</p><p>升级：招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "伤害计算自动化。移动释放及AOE目标选择需手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    }
                }
            ]
        }
    },
    {
        "name": "玄虚刀法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 1,
            "description": "<p>真武教刀法，入门弟子皆有修习。</p><p>需求：刀-单刀 属性：太极</p>",
            "requirements": "刀-单刀",
            "moves": [
                {
                    "name": "燕山飞渡",
                    "type": "stance",
                    "damageType": "none",
                    "weaponType": "blade",
                    "element": "taiji",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，持刀静心，气运丹田，开启架招。格挡成功后，获得一层“玄虚真气”，持续到战斗脱离。</p><p>升级：格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡成功自动获得玄虚真气。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡获气",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"玄虚真气\");\n    await game.xjzl.api.effects.addEffect(actor, effect);\n    ui.notifications.info(\"燕山飞渡：格挡成功，获得玄虚真气！\");\n}"
                        }
                    ]
                },
                {
                    "name": "逾山登台",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "taiji",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，提气御刀，造成 0.3 内息点内功伤害。<br>击破架招时，为自身添加一层“玄虚真气”，持续到战斗脱离。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "击破架招自动获得玄虚真气。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "破防获气",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.isBroken) {\n    const effect = thisItem.effects.getName(\"玄虚真气\");\n    await game.xjzl.api.effects.addEffect(args.attacker, effect);\n    ui.notifications.info(\"逾山登台：击破架招，获得玄虚真气！\");\n}"
                        }
                    ]
                },
                {
                    "name": "岱宗如何",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "blade",
                    "element": "taiji",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作（或反应动作）",
                    "description": "<p>主要动作，横劈一刀，造成 0.4 内息点内功伤害。<br>击中无架招敌人时，获得一层“玄虚真气”，持续到战斗脱离。<br>·若目标处于“错骨”状态，可消耗反应动作使用此招攻击目标。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招自动获得玄虚真气。反应动作需手动判断。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "命中获气",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effect = thisItem.effects.getName(\"玄虚真气\");\n    await game.xjzl.api.effects.addEffect(args.attacker, effect);\n    ui.notifications.info(\"岱宗如何：命中无架招敌人，获得玄虚真气！\");\n}"
                        }
                    ]
                },
                {
                    "name": "玄虚一气",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "none",
                    "weaponType": "blade",
                    "element": "taiji",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，玄而虚之，百般变化，每消耗 1 层“玄虚真气”，为自身添加你曾见过的武学招式可以获取的状态（一层或持续一回合）。<br>·消耗一层玄虚真气，只能选择人级武学套路；<br>消耗三层，可选择地级武学套路；<br>消耗五层，可选择天级武学套路。<br>·你不可以选择获得散手的状态。<br>·你不可以选择获得特殊状态。</p><p>升级：怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "需手动处理。请手动扣除玄虚真气并手动添加对应的Buff。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            3,
                            2,
                            1
                        ]
                    }
                }
            ]
        },
        "effects": [
            {
                "name": "玄虚真气",
                "icon": "icons/svg/aura.svg",
                "description": "持续到战斗脱离。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_xuanxu_zhenqi",
                        "stackable": true,
                        "maxStacks": 99
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "龙虎掌法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 1,
            "description": "<p>传统拳术之一，招式舒展大方，大开大合，不仅是<br>一种武术，也是一门健身术。</p><p>需求：徒手-拳掌 属性：刚</p>",
            "requirements": "徒手-拳掌",
            "moves": [
                {
                    "name": "猛虎跳涧",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，纵横连环拍掌，对目标造成 0.4 力量点内功伤害。出招结束后，你可以不消耗速度朝任意方向横挪一米。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "伤害计算自动化。横挪请手动操作。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "龙潜曲沼",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，十趾抓地，走转旋臂，对目标造成 0.3 力量点内功伤害。命中无架招目标时，自身回复 10 点气血，10 点内力。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招自动回血回蓝。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "潜龙回复",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await args.attacker.applyHealing({ amount: 10, type: \"hp\" });\n    await args.attacker.applyHealing({ amount: 10, type: \"mp\" });\n}"
                        }
                    ]
                },
                {
                    "name": "虎行山林",
                    "type": "stance",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，舒展四肢，畅胸实腹，开启架招。格挡成功后，可消耗反应动作施展【猛虎跳涧】。</p><p>升级：格挡值+5，内力消耗+1。</p>",
                    "automationNote": "反应动作反击请手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    }
                },
                {
                    "name": "游龙盘柱",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "gang",
                    "range": "2",
                    "targetInfo": "周围目标",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，形意结合，随走随变，对周围目标造成 0.5 力量点内功伤害。<br>招式命中多个敌人时，将他们击飞 1 米，并添加“禁足”，持续两回合。</p><p>升级：招式伤害+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中自动施加禁足。击飞请手动处理。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加禁足",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const rootData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"root\"));\n    rootData.duration = { rounds: 2 };\n    rootData.name = \"禁足 (游龙盘柱)\";\n    await game.xjzl.api.effects.addEffect(args.target, rootData);\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "武当太乙绵掌",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 1,
            "description": "<p>绵者，柔也，武当内家拳宗以“水”延伸而出的掌法，可谓微妙精致。至柔则刚，刚柔要济，阴阳相随，不僵不滞，看似柔弱无骨，实则绵里藏铁。</p><p>需求：徒手-拳掌 属性：柔</p>",
            "requirements": "徒手-拳掌",
            "moves": [
                {
                    "name": "柔和清静",
                    "type": "stance",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "element": "rou",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，挺胸立腰，双掌平摊，开启架招。<br>格挡成功后获得一层“绵劲”，至多叠加三层，持续到战斗脱离。<br>绵劲：每层使你的柔属性武学招式伤害+5。</p><p>升级：格挡值+5，内力消耗+1。</p>",
                    "automationNote": "格挡成功自动叠加绵劲。",
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡聚绵",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args)) {\n    const effect = thisItem.effects.getName(\"绵劲\");\n    await game.xjzl.api.effects.addEffect(actor, effect);\n    ui.notifications.info(\"柔和清静：格挡成功，获得绵劲！\");\n}"
                        }
                    ]
                },
                {
                    "name": "处下不争",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "rou",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，屈步亮掌，对目标造成 0.4 内息点内功伤害，命中无架招目标时，将其击倒。</p><p>升级:招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "命中无架招自动击倒。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击倒",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    ui.notifications.info(`${args.target.name} 被击倒了！`);\n}"
                        }
                    ]
                },
                {
                    "name": "随方就圆",
                    "type": "counter",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "rou",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>看破虚招时反应动作施展，单掌虚弹，挥臂一震，压制目标虚招，对目标 0.4 内息点内功伤害。<br>自身每存在一层“绵劲”，可将目标击飞 1 米。</p><p>升级：招式伤害+5，内力消耗+1。</p>",
                    "automationNote": "伤害自动化。检测绵劲层数并提示击飞距离，需手动击飞。",
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "绵劲击飞",
                            "trigger": "hit",
                            "active": true,
                            "script": "const effect = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_mianjin\");\nconst stacks = effect ? (effect.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\nif (stacks > 0) {\n    ui.notifications.info(`${args.target.name} 被击飞 ${stacks} 米！`);\n}"
                        }
                    ]
                },
                {
                    "name": "穿石劈岭",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "element": "rou",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，双掌合十，如刺疾突，如水击石穿，对目标造成 0.6 内息点内功伤害。<br>若自身存在“绵劲”，可消耗任意层数的“绵劲”，使你进入“无坚不摧”状态，持续三回合。<br>无坚不摧：获得此状态时每消耗一层“绵劲”，此状态给予 5 点格挡值，1 点看破值。</p><p>升级：招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "automationNote": "出招时检测并消耗绵劲，自动获得无坚不摧。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "转化绵劲",
                            "trigger": "attack",
                            "active": true,
                            "script": "const effect = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_mianjin\");\nconst stacks = effect ? (effect.getFlag(\"xjzl-system\", \"stacks\") || 0) : 0;\n\nif (stacks > 0) {\n    const blockBonus = stacks * 5;\n    const kanpoBonus = stacks * 1;\n    \n    // 移除绵劲\n    await game.xjzl.api.effects.removeEffect(actor, \"wuxue_mianjin\", stacks);\n    \n    // 添加无坚不摧\n    const buffData = thisItem.effects.getName(\"无坚不摧\").toObject();\n    delete buffData._id;\n    buffData.changes = [\n        { key: \"system.combat.block\", mode: 2, value: blockBonus },\n        { key: \"system.combat.kanpo\", mode: 2, value: kanpoBonus }\n    ];\n    await game.xjzl.api.effects.addEffect(actor, buffData);\n    ui.notifications.info(`消耗 ${stacks} 层绵劲，获得无坚不摧（格挡+${blockBonus}, 看破+${kanpoBonus}）`);\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "绵劲",
                "icon": "icons/svg/ice-aura.svg",
                "description": "每层使你的柔属性武学招式伤害+5。至多叠加三层，持续到战斗脱离。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_mianjin",
                        "stackable": true,
                        "maxStacks": 3
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.damages.rou.mod",
                        "mode": 2,
                        "value": "5"
                    }
                ]
            },
            {
                "name": "无坚不摧",
                "icon": "icons/svg/shield.svg",
                "description": "每消耗一层“绵劲”，此状态给予 5 点格挡值，1 点看破值。持续三回合。",
                "transfer": false,
                "duration": {
                    "rounds": 3
                },
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_wujian_bucui",
                        "stackable": false
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "清风剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>清风剑在手，剑气如清风拂柳，优美灵动，飘逸而玄机。真武教弟子行走时常用的高明剑法。</p><p>需求：剑 属性：阴</p>",
            "requirements": "剑",
            "moves": [
                {
                    "name": "清风化雨",
                    "type": "stance",
                    "damageType": "none",
                    "weaponType": "sword",
                    "element": "yin",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，心神清朗，开启架招，格挡成功后自身进入“清风”，持续一回合。<br>清风：《清风剑》招式伤害提高 10 点。</p><p>升级：格挡值+10，“清风”额外持续一回合，内力消耗+2。</p>",
                    "automationNote": "格挡成功自动获得清风buff。伤害提升通过其他招式检测buff实现。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡清风",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (Macros.checkStance(actor, args)) {\n    // [修复] 在 damaged 时机中，args.move 可能是未定义的\n    // 我们通过当前激活的架招 ID，在当前物品(thisItem)中查找招式数据\n    const stanceId = actor.system.martial.stance;\n    const moveData = thisItem.system.moves.find(m => m.id === stanceId);\n    \n    // 安全获取等级\n    const lvl = Math.max(1, moveData?.computedLevel || 1);\n    const rounds = 1 + (lvl - 1);\n    \n    // 获取特效模板 (同样修改变量名避免冲突)\n    const sourceEffect = thisItem.effects.getName(\"清风\");\n    \n    if (sourceEffect) {\n        const effectData = sourceEffect.toObject();\n        delete effectData._id;\n        \n        // 确保 Slug 一致\n        foundry.utils.setProperty(effectData, \"flags.xjzl-system.slug\", \"wuxue_qingfeng\");\n        effectData.duration = { rounds: rounds };\n        \n        await game.xjzl.api.effects.addEffect(actor, effectData);\n        ui.notifications.info(`格挡成功，获得清风（持续 ${rounds} 回合）`);\n    }\n}"
                        }
                    ]
                },
                {
                    "name": "清扫积弊",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "yin",
                    "range": "1",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，破空一剑，造成 0.4 内息点内功伤害。<br>击破架招时，给对方添加“禁足”一回合，同时自身进入“清风”状态，持续三回合。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "破防自动对敌禁足，对自己施加清风。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "清风与禁足",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.isBroken) {\n    // 敌方禁足\n    const rootData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"root\"));\n    rootData.duration = { rounds: 1 };\n    await game.xjzl.api.effects.addEffect(args.target, rootData);\n    \n    // 自身清风\n    const effect = thisItem.effects.getName(\"清风\");\n    const effectData = effect.toObject();\n    delete effectData._id;\n    effectData.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.attacker, effectData);\n}"
                        },
                        {
                            "label": "清风增伤检测",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_qingfeng\")) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"清风 +10\");\n}"
                        }
                    ]
                },
                {
                    "name": "乾坤清气",
                    "type": "real",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "yin",
                    "range": "4",
                    "targetInfo": "直线",
                    "actionCost": "蓄力动作",
                    "description": "<p>蓄力动作，挥洒剑气，对直线上的敌人造成 0.4 内息点内功伤害。<br>·若自身处在“清风”状态，招式可改为对单体目标施展，挥舞剑气，招式伤害提升 20 点。</p><p>升级：招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "自动检测清风状态增加伤害。单体/直线范围需手动控制。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "scripts": [
                        {
                            "label": "清风增伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "const hasQingfeng = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_qingfeng\");\nif (hasQingfeng) {\n    args.output.damage += 30; // 20特有+10通用\n    args.output.bonusDesc.push(\"清风(通用+特有) +30\");\n}"
                        }
                    ]
                },
                {
                    "name": "清者自清",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "yin",
                    "range": "4",
                    "targetInfo": "单体/周围",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，青色剑气喷薄而出，对目标造成 0.8 内息点内功伤害。同时自身进入“清风”状态，持续两回合。<br>若自身已存在“清风”状态，此招可凌空释放。</p><p>清者自清（自身处于半空中）<br>距离：10<br>蓄力动作，清风拂八方，剑气极盛，对周围敌人造成 0.8 内息点内功伤害。同时自身“清风”状态额外再持续两回合。</p><p>升级：招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "自动检测清风状态增加伤害及buff持续时间。空中及AOE范围需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "清风续航",
                            "trigger": "attack",
                            "active": true,
                            "script": "const hasQingfeng = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_qingfeng\");\nconst rounds = hasQingfeng ? 4 : 2;\nconst effect = thisItem.effects.getName(\"清风\");\nconst effectData = effect.toObject();\ndelete effectData._id;\neffectData.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(actor, effectData);\nif (hasQingfeng) ui.notifications.info(\"清风状态延长至4回合！\");"
                        },
                        {
                            "label": "清风增伤检测",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_qingfeng\")) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"清风 +10\");\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "清风",
                "icon": "icons/svg/wing.svg",
                "description": "《清风剑》招式伤害提高 10 点。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_qingfeng",
                        "stackable": false
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "神门剑诀",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>刚猛凌厉，一招制敌，目标全是敌人手腕的神门穴，敌人中剑后，手掌便再也使不出半点力道。</p><p>需求：剑-单剑 属性：刚</p>",
            "requirements": "剑-单剑",
            "moves": [
                {
                    "name": "神门定穴",
                    "type": "qi",
                    "damageType": "none",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "actionType": "buff",
                    "description": "<p>次要动作，收腰凝神，剑出定脉，自身进入“定穴”状态，持续一回合。<br>定穴：出招命中无架招敌人时，为其添加一层“神门受损”，至多三层，持续到脱战。<br>神门受损：每层使你的招式伤害降低 10 点；你再次被《神门剑诀》招式命中受伤时投掷 D20，结果小于等于 1 则兵器掉落。（需花费主要动作捡起）</p><p>升级:“定穴”持续的回合数+1，神门受损 D20 检定的结果判定数值+1。</p>",
                    "automationNote": "自动开启定穴状态。定穴状态下命中无架招敌人自动施加神门受损（掉落物器需手动）。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            8,
                            8,
                            8
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启定穴",
                            "trigger": "attack",
                            "active": true,
                            "script": "const lvl = Math.max(1, args.move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\nconst effect = thisItem.effects.getName(\"定穴\");\nconst effectData = effect.toObject();\ndelete effectData._id;\neffectData.duration = { rounds: rounds };\nawait game.xjzl.api.effects.addEffect(args.target, effectData);\nui.notifications.info(`开启定穴状态（持续 ${rounds} 回合）`);"
                        }
                    ]
                },
                {
                    "name": "剑转游风",
                    "type": "feint",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "2",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，纵身向前，持剑斜刺神门穴，对敌人造成 0.4 力量点内功伤害。击破架招后，给对方添加一层“神门受损”状态，持续到战斗脱离。</p><p>升级:招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "破防自动施加神门受损（掉落物器需手动）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "神门受损",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && args.isBroken) {\n    const effect = thisItem.effects.getName(\"神门受损\");\n    await game.xjzl.api.effects.addEffect(args.target, effect);\n}"
                        }
                    ]
                },
                {
                    "name": "有影无踪",
                    "type": "stance",
                    "damageType": "none",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，提剑护身，开启架招。格挡成功后，可消耗反应动作，剑势如风，向 2 米内的攻击者手腕神门穴连续刺出两剑，每剑对其造成 30 点内功伤害。（投掷一次命中，造成 2 次伤害）</p><p>升级:格挡值+10，伤害增加 10 点，内力消耗+2。</p>",
                    "automationNote": "自动化仅含格挡值。反击请手动使用其他攻击方式模拟或GM判定。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "气尊万物",
                    "type": "real",
                    "isUltimate": true,
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "element": "gang",
                    "range": "3",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，纵身向前，剑尖瞬点目标手腕神门穴，造成 0.7 力量点内功伤害。<br>若目标具有三层“神门受损”，你可以选择不造成伤害，而是为其添加“点穴”，持续三回合（冲穴难度 11）。</p><p>升级:招式伤害+20，冲穴难度+2，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "伤害自动化。若目标满层受损，脚本会提示是否改为点穴，需手动执行点穴请求。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "点穴提示",
                            "trigger": "hit",
                            "active": true,
                            "script": "const effect = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuxue_shenmen_shousun\");\nif (effect && effect.getFlag(\"xjzl-system\", \"stacks\") >= 3) {\n    const dc = 11 + (Math.max(1, args.move.computedLevel||1)-1)*2;\n    ChatMessage.create({content: `<b>提示：</b>目标神门受损已满3层，可选择撤销本次伤害，改为点穴（难度 ${dc}）。`});\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "神门受损",
                "icon": "icons/svg/bones.svg",
                "description": "每层使你的招式伤害降低 10 点；你再次被《神门剑诀》招式命中受伤时投掷 D20，结果小于等于 1 则兵器掉落（需手动）。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_shenmen_shousun",
                        "stackable": true,
                        "maxStacks": 3,
                        "scripts": [
                            {
                                "label": "掉落检定",
                                "trigger": "damaged",
                                "active": true,
                                "script": "if (args.attacker && args.item && args.item.name.includes(\"神门剑诀\")) {\n    const lvl = Math.max(1, args.move?.computedLevel || 1);\n    const threshold = 1 + (lvl - 1);\n    ChatMessage.create({content: `<b>神门受损触发：</b> ${actor.name} 被神门剑诀命中，请投掷 D20，若结果 <= ${threshold} 则兵器掉落。`});\n}"
                            }
                        ]
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.damages.skill.mod",
                        "mode": 2,
                        "value": "-10"
                    }
                ]
            },
            {
                "name": "定穴",
                "icon": "icons/svg/target.svg",
                "description": "出招命中无架招敌人时，为其添加一层“神门受损”。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "wuxue_dingxue",
                        "stackable": false,
                        "scripts": [
                            {
                                "label": "定穴应用",
                                "trigger": "hit",
                                "active": true,
                                "script": "if (args.type === \"attack\" && args.isHit && !args.target.system.martial.stanceActive) {\n    const effect = thisItem.effects.getName(\"神门受损\");\n    await game.xjzl.api.effects.addEffect(args.target, effect);\n    ui.notifications.info(`${args.target.name} 神门受损！`);\n}"
                            }
                        ]
                    }
                },
                "changes": []
            }
        ]
    },
    {
        "name": "两仪双剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>真武教绝学，自太极化出，有阴有阳，亦刚亦柔。</p><p><strong>需求：</strong>剑-双剑</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-双剑",
            "moves": [
                {
                    "name": "易有太极",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>架双剑于前，开启架招。格挡成功时给敌人添加一层“乏力”，至多三层，持续到脱战。</p><p><strong>乏力：</strong>每层使你招式伤害减少 10 点。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "开启架招自动。格挡反击施加乏力自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "架招反击-乏力",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nawait game.xjzl.api.effects.addEffect(args.attacker, \"fali\");\nui.notifications.info(`${actor.name} 的易有太极使 ${args.attacker.name} 感到乏力！`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "始生两仪",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "自身/范围",
                    "actionCost": "次要动作",
                    "description": "<p>舞剑默调息，切换阴阳状态。第一次开启进入“阳”状态，再次使用【始生两仪】则切换为“阴”状态。</p><p><strong>“阳”状态：</strong>《两仪双剑》招式伤害提升 5 点；“阳转阴”时会回复 5 内力，同时周围 3 米范围内敌方流失 5 点内力。</p><p><strong>“阴”状态：</strong>格挡值+5；“阴转阳”时会回复 5 气血并将周围 3 米无架招的目标击倒。</p><p><strong>升级：</strong>阳状态伤害提升+5，阴状态格挡值+5。</p>",
                    "automationNote": "状态切换与自身回复自动。状态Buff自动。AOE效果（流失内力/击倒）需玩家手动判定范围和目标。",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "两仪切换",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst growth = (lvl - 1) * 5;\nlet state = actor.getFlag(\"xjzl-system\", \"wuxue_liangyi_state\");\nconst newState = (state === \"yang\") ? \"yin\" : \"yang\";\n\nif (newState === \"yang\") {\n    // 阴 -> 阳\n    await game.xjzl.api.effects.removeEffect(actor, \"liangyi_yin\");\n    const eff = thisItem.effects.getName(\"两仪-阳\").toObject();\n    eff.changes[0].value = String(5 + growth);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    \n    await actor.applyHealing({ amount: 5, type: \"hp\" });\n    ui.notifications.info(\"两仪双剑：切换至 [阳]。请手动处理周围3米无架招目标的击倒。\");\n\n} else {\n    // 阳 -> 阴\n    await game.xjzl.api.effects.removeEffect(actor, \"liangyi_yang\");\n    const eff = thisItem.effects.getName(\"两仪-阴\").toObject();\n    eff.changes[0].value = String(5 + growth);\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    \n    await actor.applyHealing({ amount: 5, type: \"mp\" });\n    ui.notifications.info(\"两仪双剑：切换至 [阴]。请手动处理周围3米敌方的内力流失(5点)。\");\n}\nawait actor.setFlag(\"xjzl-system\", \"wuxue_liangyi_state\", newState);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴阳流光",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>双剑影分光，对目标造成伤害。击破架招时使其陷入“下盘不稳”，持续三回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加下盘不稳自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const effectData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"unstable\"));\n    effectData.duration = { rounds: 3 };\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n    ui.notifications.info(`${args.target.name} 下盘不稳！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "易变两极",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>阴阳两相融，对目标造成伤害。</p><p>“阳”状态下，回复气血 20 点。</p><p>“阴”状态下，回复内力 20 点。</p><p><strong>升级：</strong>招式伤害+20，回复的气血、内力数值+10，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "根据状态回复自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.8
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "两极回复",
                            "trigger": "hit",
                            "script": "const state = actor.getFlag(\"xjzl-system\", \"wuxue_liangyi_state\");\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst healAmount = 20 + (lvl - 1) * 10;\n\nif (state === \"yang\") {\n    await actor.applyHealing({ amount: healAmount, type: \"hp\", showScrolling: true });\n} else if (state === \"yin\") {\n    await actor.applyHealing({ amount: healAmount, type: \"mp\", showScrolling: true });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "两仪-阳",
                    "icon": "icons/magic/fire/flame-burning-yellow-orange.webp",
                    "description": "招式伤害提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "liangyi_yang",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.damages.skill.mod",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "两仪-阴",
                    "icon": "icons/magic/water/water-hand-ice-blue.webp",
                    "description": "格挡值提升。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "liangyi_yin",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "百炼剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>真武教绝学，使出时以浑厚内力逼弯剑刃，使其如软带般轻柔曲折、飘忽不定，显得剑招变幻无常，令敌人无从挡架。</p><p><strong>需求：</strong>剑，全真道</p><p><strong>属性：</strong>柔</p>",
            "requirements": "剑；全真道",
            "moves": [
                {
                    "name": "何意百炼钢",
                    "type": "real",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>男儿铮铮铁骨，剑出千锤百炼。对目标造成伤害。获得一层“百炼”，至多三层，持续到战斗脱离。</p><p><strong>百炼：</strong>每层使招式命中提高 5 点。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中获得百炼自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得百炼",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const eff = thisItem.effects.getName(\"百炼\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "化为绕指柔",
                    "type": "feint",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>旋身绕剑，缠敌割首，对目标造成伤害，击破架招时对方陷入“血流不止”，持续到战斗脱离。</p><p><strong>血流不止：</strong>若目标内力归零，死亡检定必定为 1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破施加状态自动。死亡检定修改需玩家手动执行。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-血流不止",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"血流不止\").toObject();\n    await game.xjzl.api.effects.addEffect(args.target, eff);\n    ui.notifications.info(`${args.target.name} 血流不止！`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "梦断江河",
                    "type": "counter",
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破对方虚招后，可消耗反应动作释放此招，压制目标虚招，跃步回斩，不消耗速度移动至目标周围空格，对目标施展一次【化为绕指柔】，若你存在“百炼”，虚招值+1。</p><p><strong>升级：</strong>虚招值再提高 1 点，内力消耗+2。</p>",
                    "automationNote": "请手动施展【化为绕指柔】并注意加值。",
                    "calculation": {
                        "base": 0,
                        "growth": 1
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "轻许三生",
                    "type": "real",
                    "isUltimate": true,
                    "element": "rou",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>三生绕指，绝生无影，斩击周围目标造成伤害。</p><p>若自身“百炼”达到三层时，可移除所有百炼，额外再获得一个主要动作。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "需要时请手动移除百炼并手动执行额外动作。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": []
                }
            ],
            "effects": [
                {
                    "name": "百炼",
                    "icon": "icons/commodities/metal/ingot-engraved-steel.webp",
                    "description": "命中提高。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bailian",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.hit_waigong",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "system.combat.hit_neigong",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                },
                {
                    "name": "血流不止",
                    "icon": "icons/svg/blood.svg",
                    "description": "若目标内力归零，死亡检定必定为 1。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xueliubuzhi",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "天师拳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>天师府内宗拳法之一，又称天师五斗拳。不刻意追求招式精妙，注重形、意、气结合，不拘泥于形式，整体写意而协调。</p><p><strong>需求：</strong>徒手-拳掌，正一道</p><p><strong>属性：</strong>太极</p>",
            "requirements": "徒手-拳掌；正一道",
            "moves": [
                {
                    "name": "乾坤交泰",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>掌随步换，立掌靠肘，对目标造成伤害，并将其击退一米。</p><p>·若目标在本场战斗中曾对你造成过伤害，你可以将其击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击退、击倒均需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击退提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    ui.notifications.info(`${args.target.name} 被击退1米。若其伤害过你，请手动击倒。`);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "抱朴归元",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>自然守一，开启架招。格挡成功后，为对方添加一层“气虚”，至多三层，持续到脱战。</p><p><strong>气虚：</strong>每层使你回合末流失 5 点内力。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡反击自动施加气虚。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "架招反击-气虚",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nawait game.xjzl.api.effects.addEffect(args.attacker, \"qixu\");\nui.notifications.info(`${actor.name} 的抱朴归元使 ${args.attacker.name} 气虚！`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "虚灵顶劲",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放此招，压制对方虚招，神贯于顶，沉气立腰，自身获得 1 点怒气，同时气劲透敌，目标每有一层“气虚”，使其立即流失 10 点内力。</p><p><strong>升级：</strong>额外获得 1 点怒气，内力消耗+2。</p>",
                    "automationNote": "回怒、扣除目标内力自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击效果",
                            "trigger": "hit",
                            "script": "// 自身回怒\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst rageGain = 1 + (lvl - 1);\nawait actor.update({\"system.resources.rage.value\": actor.system.resources.rage.value + rageGain});\nui.notifications.info(`${actor.name} 获得 ${rageGain} 点怒气`);\n\n// 目标扣蓝\nconst qixu = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qixu\");\nconst stacks = qixu ? (qixu.getFlag(\"xjzl-system\", \"stacks\") || 1) : 0;\nif (stacks > 0) {\n    const manaBurn = stacks * 10;\n    const curMp = args.target.system.resources.mp.value;\n    await args.target.update({\"system.resources.mp.value\": Math.max(0, curMp - manaBurn)});\n    ChatMessage.create({content: `${args.target.name} 因气虚流失 ${manaBurn} 点内力！`});\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "法地天道",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>头顶为天、足膝为地，拳掌相互易变，对周身范围内敌人造成伤害，并将他们全部击飞 1 米。</p><p>·若目标无架招，招式伤害提升等同于你内息的数值。（至多提升 100）</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "无架招加伤自动。击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "执行加伤",
                            "trigger": "preDamage",
                            "script": "if (!args.target.system.martial.stanceActive) {\n    const neixi = actor.system.stats.neixi.total;\n    const bonus = Math.min(neixi, 100);\n    args.config.amount += bonus;\n    ui.notifications.info(`对无架招目标 ${args.target.name} 伤害提升 ${bonus}`);\n}\n\nif (args.outcome.isHit) {\n    ui.notifications.info(`${args.target.name} 被击飞1米`);\n}",
                            "active": true
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "全真剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>真武教弟子进阶剑法，志在守朴，养素全真，招式古朴拙重，但气象不凡。</p><p><strong>需求：</strong>剑-单剑，全真道</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑；全真道",
            "moves": [
                {
                    "name": "一叶扁舟",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>飞射剑气对目标造成伤害，若目标无架招，将其击倒。</p><p>若有敌人处于半空中，可消耗反应动作原地释放，剑气射敌于空，造成伤害并将其击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "命中无架招自动击倒。半空判定手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "无架招击倒",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.toggleStatus(args.target, \"prone\", true);\n    ChatMessage.create({content: `${args.target.name} 被剑气击倒！`});\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "斜风细雨",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑势连摆，造成伤害。击破架招时，为自身添加“西风残照”三回合。</p><p><strong>西风残照：</strong>《全真剑法》的招式造成伤害时，可击倒敌人。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击破获得BUFF自动。击倒效果需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得西风残照",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"西风残照\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "月满西楼",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放此招，压制对方虚招，然后跃起（半空中）剑舞，对周围目标造成伤害，并将他们全部击飞。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    }
                },
                {
                    "name": "薄雾浓云",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>轻挽剑花，开启架招，获得 10 点护体真气，持续到战斗脱离。在你下个回合开始时，如果有护体真气，则护体真气消散，然后你回复护体真气数值的气血。</p><p><strong>升级：</strong>格挡值+10，护体真气增加 10 点，消耗+2。</p>",
                    "automationNote": "开启获得护体自动。回合开始转化气血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得护体&挂载监测",
                            "trigger": "attack",
                            "script": "const lvl = Math.max(1, args.move.computedLevel || 1);\nconst hutiVal = 10 + (lvl - 1) * 10;\n// 1. 获得护体 (使用 applyHealing 会有飘字反馈)\nawait actor.applyHealing({amount: hutiVal, type: \"huti\"});\n\n// 2. 挂载转化监测\nconst eff = thisItem.effects.getName(\"薄雾浓云-转化\").toObject();\neff.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "寒烟衰草",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑分节击目标造成伤害，并使目标陷入“禁足”三回合，然后无消耗施展一次【薄雾浓云】。</p><p><strong>升级：</strong>伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "命中禁足自动。施展架招需手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "禁足&架招提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    ChatMessage.create({content: `${args.target.name} 被禁足！`});\n    ui.notifications.info(\"请手动免费开启【薄雾浓云】架招。\");\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "西风残照",
                    "icon": "icons/magic/air/wind-weather-autumn-leaves-brown.webp",
                    "description": "全真剑法招式造成伤害可击倒敌人。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xifengcanzhao",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "薄雾浓云-转化",
                    "icon": "icons/magic/water/fog-cloud-white.webp",
                    "description": "下回合开始时护体转化为气血。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "bowunongyun_monitor",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "转化护体",
                                    "trigger": "turnStart",
                                    "script": "const huti = actor.system.resources.huti || 0;\nif (huti > 0) {\n    // 转化回血\n    await actor.applyHealing({amount: huti, type: 'hp'});\n    // 清空护体\n    await actor.update({'system.resources.huti': 0});\n    // 视觉提示\n    if (actor.token?.object) {\n        actor.showFloatyText(\"护体转化\", { fill: \"#00FFFF\", stroke: \"#000000\", strokeThickness: 4 });\n    }\n}\n// 无论是否触发转化，回合开始后监测即结束\nawait thisEffect.delete();",
                                    "active": true
                                }
                            ]
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "三清剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>传统道门宗传剑法，为龙虎山道士所传习。剑势朴素无华，剑意凌厉锋锐，每一招均可化为三招，是剑法中的上乘武功。</p><p><strong>需求：</strong>剑-单剑，正一道</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑；正一道",
            "moves": [
                {
                    "name": "剑化三清",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>消耗自身所有“清气”状态，每消耗一层，选择“真”“玄”“神”三个状态中的一个获得，持续到战斗脱离。</p><p><strong>升级：</strong>怒气消耗-1，内力消耗+4。</p>",
                    "automationNote": "完全自动化：自动检测层数并串行弹出选择窗口。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "scripts": [
                        {
                            "label": "转化清气",
                            "trigger": "hit",
                            "script": "const qingqi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qingqi\");\nif (!qingqi) return ui.notifications.warn(\"没有清气！\");\n\nconst stacks = qingqi.getFlag(\"xjzl-system\", \"stacks\") || 1;\nawait qingqi.delete();\n\nconst { DialogV2 } = foundry.applications.api;\n\n// 串行执行选择，防止弹窗炸裂\nfor (let i = 0; i < stacks; i++) {\n    const choice = await DialogV2.wait({\n        window: { title: `剑化三清 (${i + 1}/${stacks})`, icon: \"fas fa-yin-yang\" },\n        content: \"<p>道生一，一生二，二生三。请选择化生之相：</p>\",\n        buttons: [\n            { action: \"zhen\", label: \"真 (必中)\", icon: \"fas fa-check-circle\" },\n            { action: \"xuan\", label: \"玄 (暴击)\", icon: \"fas fa-bolt\" },\n            { action: \"shen\", label: \"神 (移除)\", icon: \"fas fa-eraser\" }\n        ],\n        close: () => null\n    });\n\n    if (!choice) break;\n\n    let effectName = \"\";\n    if (choice === \"zhen\") effectName = \"三清-真\";\n    if (choice === \"xuan\") effectName = \"三清-玄\";\n    if (choice === \"shen\") effectName = \"三清-神\";\n\n    const eff = thisItem.effects.getName(effectName)?.toObject();\n    if (eff) {\n        await game.xjzl.api.effects.addEffect(actor, eff);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "阴阳冲和",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>擎剑刺出，对目标造成伤害，击破架招时移除目标身上的一个状态。</p><p>消耗“真”：招式必定命中。</p><p>消耗“玄”：招式虚招值+3。</p><p>消耗“神”：击破架招时，可移除目标三个地级及以下状态。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "所有消耗效果均为手动，请玩家在出招时自行决定是否移除状态并调整数值（如虚招值+3在弹窗中输入）。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": []
                },
                {
                    "name": "乾坤合一",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑气翻涌，对目标造成伤害。若你具有状态，招式伤害+10 点。</p><p>消耗“真”：招式距离+3 米且变为范围伤害。</p><p>消耗“玄”：招式暴击骰-3。</p><p>消耗“神”：自身每有一种状态招式伤害再+10（至多+30）。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+2。</p>",
                    "automationNote": "被动加伤自动（检测是否拥有状态）。消耗效果（范围、暴击骰、额外加伤）均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被动状态加伤",
                            "trigger": "calc",
                            "script": "// 仅处理“若你具有状态”的被动加成，不涉及消耗，安全自动\nconst states = [\"sanqing_zhen\", \"sanqing_xuan\", \"sanqing_shen\"];\nconst activeStates = actor.effects.filter(e => states.includes(e.getFlag(\"xjzl-system\", \"slug\")));\n\nif (activeStates.length > 0) {\n    args.output.damage += 10;\n    args.output.bonusDesc.push(\"三清状态被动 +10\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "吐故纳新",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑运气，开启架招。格挡成功时获得一层“清气”，至多三层，持续到脱战。</p><p><strong>清气：</strong>每层使自身回合末回复 5 点气血、内力。</p><p>消耗“真”：架招额外提供 20 点格挡值。</p><p>消耗“玄”：立即获得一层清气。</p><p>消耗“神”：移除自身一个地级及以下的状态。</p><p><strong>升级：</strong>格挡值+10，内力消耗+2。</p>",
                    "automationNote": "格挡获清气自动。消耗效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-清气",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"清气\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "三清-真",
                    "icon": "icons/magic/symbols/rune-sigil-white-blue.webp",
                    "description": "三清状态：真。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "sanqing_zhen",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "三清-玄",
                    "icon": "icons/magic/symbols/rune-sigil-black-purple.webp",
                    "description": "三清状态：玄。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "sanqing_xuan",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "三清-神",
                    "icon": "icons/magic/symbols/rune-sigil-yellow.webp",
                    "description": "三清状态：神。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "sanqing_shen",
                            "stackable": true
                        }
                    },
                    "changes": []
                },
                {
                    "name": "清气",
                    "icon": "icons/magic/air/wind-stream-purple.webp",
                    "description": "每层回合末回复气血内力。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingqi",
                            "stackable": true,
                            "maxStacks": 3
                        }
                    },
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenHpTurnEnd",
                            "mode": 2,
                            "value": "5"
                        },
                        {
                            "key": "flags.xjzl-system.regenMpTurnEnd",
                            "mode": 2,
                            "value": "5"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "青萍剑法",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>天师府秘传，按周天共六趟剑路合三百六十五剑。招中套招，式内藏式，招式精奇变化无常，无拘无束，超凡脱俗，有别开洞天、渊中求珠之妙。</p><p><strong>需求：</strong>剑-双剑，正一道</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-双剑；正一道",
            "moves": [
                {
                    "name": "迎风挥扇",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "2米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>弧剑绕圆，环斩自身周围敌人，造成伤害。</p><p>击破架招时，自身获得“青萍”，持续一回合。</p><p><strong>青萍：</strong>你无法被以单体为目标的招式选中。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "击破获得BUFF自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得青萍",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = thisItem.effects.getName(\"青萍\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "古月沉江",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>挽剑直刺，剑气对目标造成伤害，若目标无架招，可将其击飞 1 米。</p><p>若有敌人处于半空中，可以消耗反应动作释放此招，蹬地而起，腾空直刺，造成伤害并将其击倒。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击飞、击倒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "状态效果提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    if (!args.target.system.martial.stanceActive) {\n        ui.notifications.info(`${args.target.name} 被击飞1米`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "云鸿振羽",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>持剑舒展，青气弥漫，开启架招。格挡成功后，自身获得“青萍”，持续一回合。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "格挡获得青萍自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            1,
                            1,
                            1,
                            1
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-青萍",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"青萍\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "秋水匹练",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>指抚剑身，选择范围内除自身以外的一个目标，渡气为其添加“青萍”，持续一回合。</p><p>·若自身具有“青萍”，施展此招消耗的怒气-1。</p><p><strong>升级：</strong>可以选择的目标增加一个，内力消耗+4。</p>",
                    "automationNote": "施加BUFF自动。怒气减免手动。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            2,
                            2,
                            2,
                            2
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加青萍",
                            "trigger": "hit",
                            "script": "const eff = thisItem.effects.getName(\"青萍\").toObject();\nawait game.xjzl.api.effects.addEffect(args.target, eff);\nui.notifications.info(`已给 ${args.target.name} 施加青萍`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "碧云罩顶",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>轻灵转剑，对目标及其周围 2 米范围内的敌人造成伤害。</p><p>若招式命中 3 人及以上，自身获得“青萍”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "命中3人获得青萍自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "群攻获青萍",
                            "trigger": "hit_once",
                            "script": "if (args.hitCount >= 3) {\n    const eff = thisItem.effects.getName(\"青萍\").toObject();\n    await game.xjzl.api.effects.addEffect(actor, eff);\n    ui.notifications.info(\"命中3人以上，获得青萍！\");\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "仙人指迷",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>劲气如海，沉浮如雾，选择自身具有的任意状态将其移除；每移除一个回复 20 点气血，并为自身添加“青萍”，持续一回合。</p><p>·若施展此招时，自身已具有“青萍”，则在本场战斗中，将你获得和为他人添加的“青萍”的效果修改如下：<strong>青萍：</strong>你无法被招式选中。</p><p><strong>升级：</strong>每移除一个状态回复的气血+10 点，怒气消耗-1，内力消耗+8。</p>",
                    "automationNote": "纯手动。请手动删除状态，手动回血，手动添加青萍（绝招）BUFF。",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用提示",
                            "trigger": "hit",
                            "script": "ui.notifications.info(\"请手动移除状态。每移除一个，手动回复20(+10/lv)气血。\");\n\nconst eff = thisItem.effects.getName(\"青萍(绝招)\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "青萍",
                    "icon": "icons/magic/nature/leaf-glow-teal.webp",
                    "description": "你无法被以单体为目标的招式选中。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingping",
                            "stackable": false
                        }
                    },
                    "changes": []
                },
                {
                    "name": "青萍(绝招)",
                    "icon": "icons/magic/nature/leaf-glow-teal.webp",
                    "description": "你无法被以单体为目标的招式选中。若已有青萍，改为无法被招式选中。",
                    "transfer": false,
                    "duration": {
                        "rounds": 1
                    },
                    "flags": {
                        "xjzl-system": {
                            "slug": "qingping_ultimate",
                            "stackable": false
                        }
                    },
                    "changes": []
                }
            ]
        }
    },
    {
        "name": "太极拳",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>由张三丰所创，遵循阴阳太极之理，以“四两拨千斤”为口诀，后发先至，以柔克刚，以静待动，以圆化直，以小胜大，以弱胜强。</p><p><strong>需求：</strong>徒手-拳掌</p><p><strong>属性：</strong>太极</p>",
            "requirements": "徒手-拳掌",
            "moves": [
                {
                    "name": "白鹤亮翅",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>虚步分手，拳风凛凛，摆击前方敌人造成伤害。</p><p>击破架招时，使目标陷入“封招”，持续一回合。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破施加封招自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "击破-封招",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"fengzhao\");\n    if(eff) {\n        const data = foundry.utils.deepClone(eff);\n        data.duration = { rounds: 1 };\n        await game.xjzl.api.effects.addEffect(args.target, data);\n        ui.notifications.info(`${args.target.name} 被封招！`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "金鸡独立",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>提膝托掌，劲力牵引，开启架招。格挡成功时自身获得一层“引劲”，至多叠加 2 层，脱离战斗后消失。</p><p><strong>引劲：</strong>每有一层，造成伤害后，可将目标朝任意方向拖曳移动 1 米。</p><p><strong>升级：</strong>格挡值+10，引劲最大叠加层数+1，内力消耗+4。</p>",
                    "automationNote": "格挡获得引劲自动。拖曳效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "格挡-引劲",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\n\n// 获取AE模板\nconst effData = thisItem.effects.getName(\"引劲\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 动态计算最大层数 (基础2 + Lv-1)\nconst stanceId = actor.system.martial.stance;\nconst moveData = thisItem.system.moves.find(m => m.id === stanceId);\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst maxStacks = 2 + (lvl - 1);\n\n// 修改 Flags\neffData.flags[\"xjzl-system\"].maxStacks = maxStacks;\n\nawait game.xjzl.api.effects.addEffect(actor, effData);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "野马分鬃",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>屈膝前踏，左右开弓，席卷目标，造成伤害。</p><p>若身上存在“引劲”，击飞对方 2 米。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击飞手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "引劲击飞提示",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const hasYinjin = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yinjin\");\n    if (hasYinjin) {\n        ui.notifications.info(`${args.target.name} 被击飞 2 米 (因引劲)`);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "蛟龙出海",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "3米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>龙腾出海，气劲喷薄，对周围敌人造成伤害，并添加“下盘不稳”，持续一回合。</p><p>若有人处于半空中，你可以消耗反应动作，站在原地释放此招，伤敌并将他们击落倒地。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+8。</p>",
                    "automationNote": "命中施加下盘不稳自动。击落倒地手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ]
                    },
                    "scripts": [
                        {
                            "label": "下盘不稳",
                            "trigger": "hit",
                            "script": "if (args.isHit) {\n    const eff = CONFIG.statusEffects.find(e => e.id === \"unstable\");\n    if(eff) {\n       const data = foundry.utils.deepClone(eff);\n       data.duration = { rounds: 1 };\n       await game.xjzl.api.effects.addEffect(args.target, data);\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "如封似闭",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "3米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放此招，压制虚招，左掌右拳，回环推出，对其造成伤害。然后在自身周围 3 米范围形成‘炁化太虚’，持续一回合。</p><p><strong>炁化太虚：</strong>范围外敌方无法选中范围内友方。</p><p><strong>升级：</strong>招式伤害+10，炁化太虚持续回合+1，内力消耗+4。</p>",
                    "automationNote": "领域效果手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "生成领域",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst duration = 1 + (lvl - 1);\nui.notifications.info(`已生成 [炁化太虚] 领域 (3米)，持续 ${duration} 回合。`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "揽雀尾",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "unarmed",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "反应动作",
                    "description": "<p>当你被招式选为目标时，可消耗反应动作，棚、捋、挤、按，消耗 X 层“引劲”并获得“揽雀尾”，持续到你的下回合初。</p><p><strong>揽雀尾：</strong>你获得 5*X 点格挡值，且每次受到伤害后，恢复自身 10*X 点气血内力。</p><p><strong>升级：</strong>格挡值系数+5，气血内力回复系数+10。</p>",
                    "automationNote": "消耗引劲获BUFF自动。BUFF受击回血自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "应用揽雀尾",
                            "trigger": "hit",
                            "script": "// 1. 查找并消耗引劲\nconst yinjin = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"yinjin\");\nif (!yinjin) return ui.notifications.warn(\"未从自身引导劲力(无引劲层数)！\");\n\nconst stacks = yinjin.getFlag(\"xjzl-system\", \"stacks\") || 1;\nawait yinjin.delete();\n\n// 2. 计算系数\nconst lvl = Math.max(1, move.computedLevel || 1);\nconst blockBonus = (5 + (lvl - 1) * 5) * stacks;\nconst healBonus = (10 + (lvl - 1) * 10) * stacks;\n\n// 3. 强制刷新：检查身上已有的揽雀尾，如果有则删除，确保新的 healBonus 变量能写入\nconst oldLanquewei = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"lanquewei\");\nif (oldLanquewei) await oldLanquewei.delete();\n\n// 4. 获取AE模板\nconst effData = thisItem.effects.getName(\"揽雀尾\").toObject();\ndelete effData._id;\neffData.origin = thisItem.uuid;\n\n// 5. 修改数据\neffData.changes[0].value = String(blockBonus);\n// 注入回血变量到 Flag\neffData.flags[\"xjzl-system\"].lanqueweiHeal = healBonus;\neffData.duration = { turns: 1 };\n\nconsole.log(\"XJZL | 施展揽雀尾 - 回血变量:\", healBonus);\n\n// 6. 应用\nawait game.xjzl.api.effects.addEffect(actor, effData);\nui.notifications.info(`消耗 ${stacks} 层引劲，施展揽雀尾！(格挡+${blockBonus}, 受击回+${healBonus})`);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "开太极",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "unarmed",
                    "range": "5米",
                    "targetInfo": "范围",
                    "actionCost": "蓄力动作",
                    "description": "<p>气感阴阳，虚空旋引，对周边敌人造成伤害，并将敌人拖拽至身边未被占据的空格将他们击倒。</p><p>·命中无架招目标时，还会为其添加“点穴”，持续一回合（冲穴难度 20）。</p><p><strong>升级：</strong>招式伤害+20，冲穴难度+2，怒气消耗-1，内力消耗+16。</p>",
                    "automationNote": "无架招点穴自动。拖拽击倒手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            16,
                            32,
                            48,
                            64
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "点穴",
                            "trigger": "hit",
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await Macros.requestSave({\n        target: args.target,\n        attacker: actor,\n        type: \"neixi\",\n        dc: 20 + (Math.max(1, move.computedLevel || 1) - 1) * 2,\n        label: \"抵抗点穴\",\n        onFail: \"dianxue\"\n    });\n}",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "引劲",
                    "icon": "icons/magic/movement/trail-streak-white.webp",
                    "description": "造成伤害后可拖曳目标。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "yinjin",
                            "stackable": true,
                            "maxStacks": 2
                        }
                    },
                    "changes": []
                },
                {
                    "name": "揽雀尾",
                    "icon": "icons/magic/defensive/shield-barrier-blue.webp",
                    "description": "获得格挡值，受击回复。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "lanquewei",
                            "stackable": false,
                            "scripts": [
                                {
                                    "label": "受击回血",
                                    "trigger": "damaged",
                                    "active": true,
                                    "script": "const heal = Number(thisEffect.getFlag('xjzl-system', 'lanqueweiHeal')) || 0;\nif (heal > 0) {\n    await actor.applyHealing({amount: heal, type: 'hp', showScrolling: true});\n    await actor.applyHealing({amount: heal, type: 'mp', showScrolling: true});\n    ui.notifications.info(`${actor.name} 触发揽雀尾：回复 ${heal} 点气血内力`);\n}"
                                }
                            ]
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "真武七截剑",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "wuxue",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>真武教历代祖师观道悟剑，融真武龟蛇之意，以诠释武道之万千宗旨，剑出则天地变色，乃真武教镇派绝学。</p><p><strong>需求：</strong>剑-单剑，全真道</p><p><strong>属性：</strong>太极</p>",
            "requirements": "剑-单剑；全真道",
            "moves": [
                {
                    "name": "立身行道",
                    "type": "stance",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>背剑而立，开启架招，同时获得一层“道”，持续到战斗脱离。</p><p>·每次成功格挡后，也会获得一层“道”。</p><p><strong>道：</strong>每有一层，你的悟性提高 1 点。</p><p><strong>升级：</strong>格挡值+10，内力消耗+4。</p>",
                    "automationNote": "开启架招获道自动。格挡获道自动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "开启获道",
                            "trigger": "attack",
                            "script": "const eff = thisItem.effects.getName(\"道\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        },
                        {
                            "label": "格挡获道",
                            "trigger": "damaged",
                            "script": "if (!Macros.checkStance(actor, args)) return;\nconst eff = thisItem.effects.getName(\"道\").toObject();\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "玄龟填海",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>背生龟像，你获得“玄龟”一回合。</p><p><strong>玄龟：</strong>你获得等同于你悟性数值的格挡值。</p><p><strong>升级：</strong>持续回合数+1，内力消耗+4。</p>",
                    "automationNote": "完全自动化。点击应用获得BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得玄龟",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\nconst wuxing = actor.system.stats.wuxing.total;\n\nconst eff = thisItem.effects.getName(\"玄龟\").toObject();\neff.duration = { rounds: rounds };\neff.changes[0].value = String(wuxing);\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "腾蛇倚天",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "taiji",
                    "damageType": "none",
                    "weaponType": "sword",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>背化蛇影，你获得“腾蛇”一回合。</p><p><strong>腾蛇：</strong>你获得等同于你悟性/3 的速度。</p><p><strong>升级：</strong>持续回合数+1，内力消耗+4。</p>",
                    "automationNote": "完全自动化。点击应用获得BUFF。",
                    "calculation": {
                        "base": 0,
                        "growth": 0
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得腾蛇",
                            "trigger": "hit",
                            "script": "const lvl = Math.max(1, move.computedLevel || 1);\nconst rounds = 1 + (lvl - 1);\nconst speedBonus = Math.floor(actor.system.stats.wuxing.total / 3);\n\nconst eff = thisItem.effects.getName(\"腾蛇\").toObject();\neff.duration = { rounds: rounds };\neff.changes[0].value = String(speedBonus);\nawait game.xjzl.api.effects.addEffect(actor, eff);",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "道镇九州",
                    "type": "feint",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑舞九天，对目标造成伤害。击破架招后与对方进行一个悟性对抗，若你胜利，对方陷入“自闭”状态，持续一回合。</p><p>·你每消耗一层“道”，可以让对方“自闭”的持续回合数+1。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "击破后提示手动对抗。消耗道、施加状态均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.3
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "提示对抗",
                            "trigger": "hit",
                            "script": "if (args.isBroken) {\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">道镇九州 - 击破触发</div>\n            <div style=\"padding:5px; font-size:0.9em;\">\n                <p>请与目标进行 <b>悟性对抗</b>。</p>\n                <p>若胜利，请手动施加 [自闭] (持续1回合)。</p>\n                <p><i>可选：手动消耗 [道] 层数，每层使持续时间 +1。</i></p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "万道归一",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>以道入剑，斩出剑光，对目标造成伤害。</p><p>·消耗一层“道”，将自身习武所悟灌注于此招，你每领悟一式武学，该招式伤害+1，至多+100。</p><p><strong>升级：</strong>招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "预览时自动计算加成。出招时弹窗询问，若拒绝消耗，则从最终伤害中扣除加成。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "万道加伤预览",
                            "trigger": "calc",
                            "script": "// 预览逻辑：乐观估计 (Optimistic)\n// 只要身上有道，就默认显示加成后的伤害，展示最大潜力。\nconst hasDao = actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhenwu_dao\");\nif (hasDao) {\n    let totalMoves = 0;\n    for (const w of actor.itemTypes.wuxue) {\n        if (w.system.moves) {\n            totalMoves += w.system.moves.filter(m => (m.computedLevel || 0) >= 1).length;\n        }\n    }\n    const bonus = Math.min(totalMoves, 100);\n    args.output.damage += bonus;\n    args.output.bonusDesc.push(`万道加伤 +${bonus}`);\n}",
                            "active": true
                        },
                        {
                            "label": "询问消耗与回滚",
                            "trigger": "attack",
                            "script": "const dao = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhenwu_dao\");\n\n// 重新计算一次加成 (因为 attack 无法直接获取 calc 的局部变量)\nlet totalMoves = 0;\nfor (const w of actor.itemTypes.wuxue) {\n    if (w.system.moves) {\n        totalMoves += w.system.moves.filter(m => (m.computedLevel || 0) >= 1).length;\n    }\n}\nconst bonus = Math.min(totalMoves, 100);\n\nif (dao) {\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: \"万道归一\" },\n        content: `<p>当前“道”存在，预计算伤害已包含 <b>+${bonus}</b> 加成。</p><p>是否消耗一层 [道] 以生效此加成？</p>`,\n        yes: { label: \"消耗 (保留加成)\", icon: \"fas fa-check\" },\n        no: { label: \"不消耗 (移除加成)\", icon: \"fas fa-times\" }\n    });\n\n    if (confirm) {\n        // 消耗道\n        await game.xjzl.api.effects.removeEffect(actor, \"zhenwu_dao\", 1);\n        ui.notifications.info(\"已消耗 [道] 增强剑招\");\n    } else {\n        // 拒绝消耗，手动回滚数值\n        args.flags.damageResult.damage -= bonus;\n        args.flags.damageResult.breakdown += `\\n- 未消耗道：移除加成 (-${bonus})`;\n        ui.notifications.info(\"放弃消耗 [道]，伤害回落\");\n    }\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "道灭道生",
                    "type": "counter",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "10米",
                    "targetInfo": "单体",
                    "actionCost": "反应动作",
                    "description": "<p>当你看破虚招后，可消耗反应动作释放此招，道转伸剑，压制对方招式，并对其造成伤害。</p><p>·消耗一层“道”给目标添加“禁虚”，持续一回合。</p><p><strong>禁虚：</strong>无法施展虚招。</p><p><strong>升级：</strong>招式伤害+10，禁虚持续回合数+1，内力消耗+4。</p>",
                    "automationNote": "命中后提示可选效果。消耗道、施加禁虚均为手动。",
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.4
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ]
                    },
                    "scripts": [
                        {
                            "label": "效果提示",
                            "trigger": "hit",
                            "script": "const dao = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"zhenwu_dao\");\nif (dao) {\n    const lvl = Math.max(1, move.computedLevel || 1);\n    const rounds = 1 + (lvl - 1);\n    ChatMessage.create({\n        content: `<div class=\"xjzl-chat-card\">\n            <div style=\"padding:5px; font-size:0.9em; color:#555;\">\n                <p><i>可选：手动消耗 1 层 [道]，给目标施加 [禁虚] (持续 ${rounds} 回合)。</i></p>\n            </div>\n        </div>`,\n        speaker: ChatMessage.getSpeaker({actor: actor})\n    });\n}",
                            "active": true
                        }
                    ]
                },
                {
                    "name": "无我无道",
                    "type": "real",
                    "isUltimate": true,
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "sword",
                    "range": "5米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>剑叩于心，一斩截道，对目标造成伤害。</p><p>·你可以消耗自身任意层数的“道”，对目标额外造成【“道”层数*自身悟性】点精神伤害，若因此将目标打入濒死，消耗的“道”全部恢复。</p><p><strong>升级：</strong>招式伤害+20，怒气消耗-1，内力消耗+8。</p><p>·招式修至合一后，将你杀死的人（攻击你至内力归零且你死亡检定失败），会遗忘所有已经学会的武学招式。</p>",
                    "automationNote": "纯手动。伤害结算后提示计算公式，请手动应用精神伤害和处理道的消耗/返还。",
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "liliang",
                                "ratio": 0.5
                            },
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24,
                            32
                        ],
                        "rage": [
                            8,
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "额外伤害提示",
                            "trigger": "hit",
                            "script": "const wuxing = actor.system.stats.wuxing.total;\nChatMessage.create({\n    content: `<div class=\"xjzl-chat-card\">\n        <div class=\"card-header\" style=\"border-bottom:1px solid #ccc; font-weight:bold;\">无我无道 - 额外效果</div>\n        <div style=\"padding:5px; font-size:0.9em;\">\n            <p>可手动消耗任意层 [道]。</p>\n            <p>每层造成 <b>${wuxing}</b> 点精神伤害。</p>\n            <hr>\n            <p style=\"color:#888; font-size:0.8em;\">若因此击倒目标，请手动恢复消耗的 [道]。</p>\n        </div>\n    </div>`,\n    speaker: ChatMessage.getSpeaker({actor: actor})\n});",
                            "active": true
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "道",
                    "icon": "icons/magic/symbols/yin-yang-white.webp",
                    "description": "每层提高悟性。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhenwu_dao",
                            "stackable": true
                        }
                    },
                    "changes": [
                        {
                            "key": "system.stats.wuxing.mod",
                            "mode": 2,
                            "value": "1"
                        }
                    ]
                },
                {
                    "name": "玄龟",
                    "icon": "icons/creatures/reptiles/turtle-shell-green.webp",
                    "description": "获得格挡值。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "xuangui",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.block",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                },
                {
                    "name": "腾蛇",
                    "icon": "icons/creatures/reptiles/snake-cobra-attack-purple.webp",
                    "description": "获得速度。",
                    "transfer": false,
                    "flags": {
                        "xjzl-system": {
                            "slug": "tengshe",
                            "stackable": false
                        }
                    },
                    "changes": [
                        {
                            "key": "system.combat.speed",
                            "mode": 2,
                            "value": "0"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "太极推手（人）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 1,
            "description": "<p>引进落空合即出，沾连黏随不丢顶。真武教弟子练劲之气功，内劲发人如弹丸，弹指一挥跌丈外。</p><p>需求：徒手 属性：太极</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "太极推手",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "waigong",
                    "weaponType": "unarmed",
                    "range": "1米",
                    "targetInfo": "单体",
                    "actionCost": "主要动作",
                    "description": "<p>主要动作，上肢发力，推其躯干，与目标进行一个[渡气]对抗，获胜者立于原地，失败者被击飞 1 米或可消耗 1 怒气重新发起[渡气]对抗，直到有人失败且不再发起对抗被击飞。<br>·每对抗一次，最终的失败者被击飞米数+1。<br>·你的对抗检定结果+1。<br>升级：击飞距离+1，对抗检定结果+1，消耗+1。</p>",
                    "automationNote": "对抗检定、击飞位移、怒气重骰均为手动。",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ],
                        "rage": [
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0,
                        "scalings": []
                    },
                    "scripts": [
                        {
                            "label": "发送对抗提示卡",
                            "trigger": "hit",
                            "active": true,
                            "script": "const bonus = 1 + (move.level - 1);\nconst content = `<div class=\"xjzl-chat-card\"><header class=\"card-header\"><h3>对抗请求：太极推手</h3></header><div class=\"card-content\"><p><b>攻击者 (${actor.name})</b> 发起 [渡气] (内息) 对抗。</p><p>攻击者加值：<b>+${bonus}</b></p><hr><p><b>规则：</b>获胜者立于原地，失败者被击飞 1米 (每级+1)。<br>失败方可消耗 1 怒气重新发起对抗。</p></div></div>`;\nChatMessage.create({ user: game.user.id, content: content, speaker: ChatMessage.getSpeaker({actor: actor}) });"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "凝神调血（地）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>道教固内藏，宁心神，养气血之法。</p>",
            "moves": [
                {
                    "name": "凝神调血",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "次要动作",
                    "description": "<p>次要动作，以独特调息心法，将气血和内力按比例互换。可流失当前内力的至多 30%，回复消耗内力值*3 的气血值。<br>升级：可流失的内力上限提高 20%。</p>",
                    "automationNote": "数值转换自动化。",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            1,
                            1,
                            1
                        ],
                        "hp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 0,
                        "scalings": []
                    },
                    "scripts": [
                        {
                            "label": "内力化血",
                            "trigger": "attack",
                            "active": true,
                            "script": "const limitRatio = move.level > 1 ? 0.5 : 0.3;\nconst maxDrain = Math.floor(S.resources.mp.value * limitRatio);\n\nif (maxDrain < 1) {\n    ui.notifications.warn(\"当前内力不足以进行转换。\");\n    args.flags.abort = true;\n    return;\n}\n\nconst dialog = await foundry.applications.api.DialogV2.prompt({\n    window: { title: \"凝神调血\" },\n    content: `<div class=\"form-group\"><label>消耗内力 (最大 ${maxDrain})</label><input type=\"number\" name=\"cost\" min=\"1\" max=\"${maxDrain}\" value=\"1\" style=\"text-align:center\"></div>`,\n    ok: { callback: (e, b) => b.form.elements.cost.value }\n});\n\nconst cost = parseInt(dialog) || 0;\nif (cost > 0 && cost <= maxDrain) {\n    const totalHeal = cost * 3;\n    // 扣除内力\n    await actor.update({\"system.resources.mp.value\": S.resources.mp.value - cost});\n    // 回复气血 (自带飘字)\n    await actor.applyHealing({ amount: totalHeal, type: \"hp\" });\n    // 隐藏后续按钮\n    args.flags.autoApplied = true;\n} else {\n    ui.notifications.warn(\"无效的内力数值，操作取消。\");\n    args.flags.abort = true;\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "固精理气（地）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 2,
            "description": "<p>道教炼精化炁，积精充盈之法。</p>",
            "moves": [
                {
                    "name": "固精理气",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "全回合",
                    "description": "<p>全回合动作，盘坐于地面，以独特吐纳心法，获得一层“聚气”，持续到战斗脱离。<br>聚气：每层使你回合末回复 5 点内力。<br>升级：额外获得一层聚气。</p>",
                    "automationNote": "Buff叠加与回蓝完全自动化。",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加聚气",
                            "trigger": "attack",
                            "active": true,
                            "script": "const stacks = move.level >= 2 ? 2 : 1;\nconst source = thisItem.effects.getName(\"聚气\");\nif (source) {\n    const effectData = source.toObject();\n    delete effectData._id;\n    for(let i=0; i<stacks; i++) {\n        await game.xjzl.api.effects.addEffect(attacker, effectData);\n    }\n    args.flags.autoApplied = true;\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "聚气",
                    "icon": "icons/svg/light.svg",
                    "description": "每层回合末回复 5 点内力。",
                    "changes": [
                        {
                            "key": "flags.xjzl-system.regenMpTurnEnd",
                            "mode": 2,
                            "value": "5"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "juqi_buff",
                            "stackable": true,
                            "maxStacks": 99
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "内丹术（天）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>道家丹鼎派修炼法门。以“人身一小天地”思想进行性命修炼，以身体为鼎炉，修“精、气、神”，达成体内结丹，天人合一的长生目的。<br>需求：《太极神功》修炼圆满</p>",
            "requirements": "《太极神功》修炼圆满",
            "moves": [
                {
                    "name": "内丹术",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "无",
                    "description": "<p>你的[道法]等级+1。<br>·休整时，可以炼精化气，炼气化神，获得“内丹”，持续到下一次进行休整。<br>内丹：内力上限降低 10 点，招式伤害提升[道法]*1 点。<br>升级：内力上限额外降低 10 点，招式伤害提升额外增加[道法]等级点。</p>",
                    "automationNote": "完全自动化。道法等级常驻增加；使用招式时，脚本会根据当前的武学等级和道法等级，一次性计算好最终数值并应用“内丹”状态。状态为纯数值修正，无性能消耗。",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被动：道法加成",
                            "trigger": "passive",
                            "active": true,
                            "script": "S.arts.daofa.mod = (S.arts.daofa.mod || 0) + 1;"
                        },
                        {
                            "label": "应用内丹(动态快照)",
                            "trigger": "hit",
                            "active": true,
                            "script": "// 1. 获取基础数据\nconst lvl = move.computedLevel || 1;\nconst daofa = actor.system.arts.daofa.total || 0;\n\n// 2. 计算数值 (快照)\n// 1级减10，2级以上减20\nconst mpReduce = (lvl >= 2) ? -20 : -10;\n// 1级1倍，2级以上2倍\nconst multiplier = (lvl >= 2) ? 2 : 1;\nconst dmgBonus = daofa * multiplier;\n\n// 3. 获取并修改 AE 模板\nconst sourceEffect = thisItem.effects.getName(\"内丹\");\nif (sourceEffect) {\n    // 转换为普通对象以便修改\n    const effectData = sourceEffect.toObject();\n    delete effectData._id;\n\n    // 动态构建 changes 数组\n    effectData.changes = [\n        {\n            key: \"system.resources.mp.max\",\n            mode: 2, // ADD\n            value: String(mpReduce)\n        },\n        {\n            key: \"system.combat.damages.skill.mod\",\n            mode: 2, // ADD\n            value: String(dmgBonus)\n        }\n    ];\n\n    // 4. 应用 (管理器会自动处理同 Slug 覆盖)\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n    ui.notifications.info(`${actor.name} 结成内丹 (内力${mpReduce}, 伤害+${dmgBonus})`);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "内丹",
                    "icon": "icons/commodities/materials/orb-energy-white.webp",
                    "description": "内力上限降低，招式伤害提升。",
                    "changes": [],
                    "flags": {
                        "xjzl-system": {
                            "slug": "neidan",
                            "stackable": false
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "天师符法（天）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>正一道秘传，用于阴阳两种醮事，包罗万象，汇集三山符箓制作用法等精奥所在。<br>需求：《正一心诀》修炼圆满</p>",
            "requirements": "《正一心诀》修炼圆满",
            "moves": [
                {
                    "name": "天师符法",
                    "type": "qi",
                    "actionType": "buff",
                    "element": "none",
                    "damageType": "none",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "一个时辰",
                    "description": "<p>·你进行画符时的[道法]检定结果+1。<br>·每天一次，设法坛，净心身，花费一个时辰画符，若此次画符的[道法]检定成功，你获得“感应”，持续一日。<br>感应：福祸无门，唯人自召，你不会受偷袭影响；持续期间，你的属性检定、技能检定结果+1。<br>升级：你进行画符时的[道法]检定结果再+1，感应的属性、技能检定结果+1。</p>",
                    "automationNote": "画符检定手动。招式添加“感应”Buff，自动化检定加值。",
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "添加感应状态",
                            "trigger": "attack",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"感应\");\nif (source) {\n    const effectData = source.toObject();\n    delete effectData._id;\n    \n    // 动态调整加值\n    const bonus = move.level >= 2 ? 2 : 1;\n    const checkChange = effectData.changes.find(c => c.key === \"flags.xjzl-system.globalCheckLevel\");\n    if (checkChange) checkChange.value = String(bonus);\n    \n    effectData.description = `不受偷袭影响；检定结果+${bonus}。`;\n    \n    await game.xjzl.api.effects.addEffect(attacker, effectData);\n    args.flags.autoApplied = true;\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "感应",
                    "icon": "icons/magic/symbols/rune-sigil-yellow.webp",
                    "description": "不受偷袭影响；属性与技能检定结果增加。",
                    "changes": [
                        {
                            "key": "flags.xjzl-system.globalCheckLevel",
                            "mode": 2,
                            "value": "1"
                        }
                    ],
                    "flags": {
                        "xjzl-system": {
                            "slug": "ganying",
                            "stackable": false
                        }
                    }
                }
            ]
        }
    },
    {
        "name": "授箓（天）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>朝廷对受箓管理极为严格，凡授篆传度唯龙虎山“万法宗坛”方可举行，道士于宗坛授箓后，便受官府承认，可开坛作法，替人看相算命，堪舆风水等，否则便是乡野道士，不值一提，私授法箓更是受到严禁，若被发现，有牢狱之灾。<br>经箓品秩：共分五等，经箓效果均可叠加：<br>初授太上三五都功经箓，升授太上正一盟威经箓，加授上清三洞五雷经箓，加升上清大洞经箓，晋升上清三洞经箓。<br>授箓仪式：每次受箓，受箓者需消耗 1000 修为，且有至少 3 名的道士作为传度之人举行授箓科仪法事，传度之人的品秩需比受箓者高一级别。<br>初授：太上三五都功经箓<br>需求：[道法]等级 2<br>效果：你阅读道士书籍时每月额外增长 100 修为进度。<br>升授：太上正一盟威经箓<br>需求：[道法]等级 4<br>效果：你受人之托使用相术、堪舆时，对方必须且愿意给予你至少 100 两白银的酬劳。<br>加授：上清三洞五雷经箓<br>需求：[道法]等级 6<br>效果：你的[道法]检定结果+1。<br>加升：上清大洞经箓<br>需求：[道法]等级 8<br>效果：你炼制的丹被捧为“仙丹”，画出的符被捧为“仙符”，售价提高原价格的 10%。<br>晋升：上清三洞经箓<br>需求：[道法]等级 10<br>效果：你开设、升级道坛道观时花费的银量减半。</p>",
            "moves": [
                {
                    "name": "授箓",
                    "type": "qi",
                    "actionType": "buff",
                    "range": "自身",
                    "targetInfo": "自身",
                    "description": "<p>每次受箓，受箓者需消耗 1000 修为。<br>1. 初授：太上三五都功经箓 (道法2)：阅读道士书籍额外增长进度。<br>2. 升授：太上正一盟威经箓 (道法4)：看相算命酬劳增加。<br>3. 加授：上清三洞五雷经箓 (道法6)：你的[道法]检定结果+1。<br>4. 加升：上清大洞经箓 (道法8)：炼丹画符售价提高。<br>5. 晋升：上清三洞经箓 (道法10)：开设道观花费减半。</p>",
                    "automationNote": "第3级道法加成自动化。其余手动。",
                    "progression": {
                        "mode": "custom",
                        "customThresholds": [
                            1000,
                            2000,
                            3000,
                            4000,
                            5000
                        ]
                    },
                    "costs": {
                        "mp": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "scripts": [
                        {
                            "label": "被动：道法检定加成",
                            "trigger": "passive",
                            "active": true,
                            "script": "if (move.computedLevel >= 3) {\n    S.arts.daofa.checkMod += 1;\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "止戈帖（天）",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/真武.png",
        "system": {
            "category": "sanshou",
            "sect": "zhenwujiao",
            "tier": 3,
            "description": "<p>真武教祖师练习书法有所感悟创造出来的一套笔法，但也可以以指代笔。<br>需求：匕首-笔/徒手-指法（升级提升笔技能）<br>属性：太极</p>",
            "requirements": "匕首-笔/徒手-指法",
            "moves": [
                {
                    "name": "止戈帖",
                    "type": "real",
                    "element": "taiji",
                    "damageType": "neigong",
                    "weaponType": "special",
                    "weaponSubtype": "笔/指法",
                    "range": "2米",
                    "targetInfo": "单体",
                    "actionCost": "全回合",
                    "description": "<p>全回合动作，气定神闲，物我两忘，笔锋苍劲，对目标造成 0.7 内息点内功伤害，你获得一层“至尊”，至多五层，持续到脱战。<br>至尊：你可以选择移除任意层数来获得额外动作，移除多层时可以叠加获取动作。<br>一层：简要动作<br>二层：次要动作<br>三层：反应动作<br>五层：主要动作<br>·当你存在五层“至尊”时，你不可被招式选中。<br>·你每个回合必须施展此招，否则在回合末移除所有“至尊”。<br>升级：招式伤害+10，内力消耗+4。</p>",
                    "automationNote": "动作兑换、不可被选中、回合末移除手动。",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12,
                            16
                        ],
                        "rage": [
                            0,
                            0,
                            0,
                            0
                        ],
                        "hp": [
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "获得至尊",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "const source = thisItem.effects.getName(\"至尊\");\nif (source) {\n    const effectData = source.toObject();\n    delete effectData._id;\n    await game.xjzl.api.effects.addEffect(attacker, effectData);\n}"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "name": "至尊",
                    "icon": "icons/magic/symbols/runes-star-blue.webp",
                    "description": "移除层数兑换动作。5层不可被选中。",
                    "flags": {
                        "xjzl-system": {
                            "slug": "zhizun",
                            "stackable": true,
                            "maxStacks": 5
                        }
                    }
                }
            ]
        }
    }
]