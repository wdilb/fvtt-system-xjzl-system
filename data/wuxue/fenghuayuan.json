[
    {
        "name": "气上形",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 1,
            "description": "<p>察气之体，观形之状，悟气之道。</p><p>需求：徒手 属性：太极</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "暮景残光",
                    "type": "stance",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>次要动作，四肢凝力，开启架招。格挡成功后，给对方添加一层“残气”，至多五层，持续到脱战。</p><p>残气：每层使你命中-2，闪避-2。</p><p>升级：格挡值+5，内力消耗+1。</p>",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5
                    },
                    "scripts": [
                        {
                            "label": "格挡反制",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.outcome.isHit && !args.config.ignoreStance && Macros.checkStance(actor, args)) {\n    const effectData = thisItem.effects.getName(\"残气\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.attacker, effectData);\n    ui.notifications.info(`${actor.name} 的架招使 ${args.attacker.name} 沾染了残气！`);\n}"
                        }
                    ],
                    "automationNote": "受击且未被破架时，自动给攻击者叠加残气。"
                },
                {
                    "name": "沽名倒海",
                    "type": "feint",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>主要动作，凝气于掌，对目标造成 0.3 内息点内功伤害，击破架招时，击退目标 3 米，并使其陷入“禁足”，持续一回合。</p><p>·若击退过程中目标遭遇障碍物则被添加一层“残气”，至多 5 层，持续到战斗脱离。</p><p>升级：招式伤害+5，虚招值+1，内力消耗+1。</p>",
                    "range": "1",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.3
                            }
                        ]
                    },
                    "baseFeint": 0,
                    "scripts": [
                        {
                            "label": "虚招特效",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    ui.notifications.info(`${args.target.name} 被禁足！(击退和障碍物判定请手动处理)`);\n}"
                        },
                        {
                            "label": "成长修正",
                            "trigger": "calc",
                            "active": true,
                            "script": "const lvl = Math.max(1, args.baseData.level);\noutput.feint += (lvl - 1) * 1;"
                        }
                    ],
                    "automationNote": "击破架招自动施加禁足。击退和障碍物判定需手动。"
                },
                {
                    "name": "静若寒蝉",
                    "type": "counter",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作使用此招，压制虚招，飘掌而出对目标造成 0.5 内息点内功伤害，同时给目标添加“缚身”，持续两回合。</p><p>升级：招式伤害+5，内力消耗+1。</p>",
                    "range": "2",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "反击特效",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const effectData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"fushen\"));\n    effectData.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ],
                    "automationNote": "命中后自动施加缚身。"
                },
                {
                    "name": "破龙击山",
                    "type": "real",
                    "isUltimate": true,
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>主要动作，聚集内力，崩拳对其造成 0.5 内息点内功伤害。同时移除目标身上所有的“残气”，每移除一层，招式伤害+5。</p><p>·若敌人因此招而亡，你获得 2 点怒气。</p><p>升级：招式伤害+10，怒气消耗-1，内力消耗+2。</p>",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "吞噬残气",
                            "trigger": "calc",
                            "active": true,
                            "script": "// 尝试在计算阶段预览伤害（依赖当前选中目标）\nconst targets = Array.from(game.user.targets);\nif (targets.length === 1) {\n    const target = targets[0].actor;\n    const effect = target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"canqi\");\n    if (effect) {\n        const stacks = effect.getFlag(\"xjzl-system\", \"stacks\") || 1;\n        output.damage += stacks * 5;\n        output.bonusDesc.push(`吞噬残气(${stacks}层): +${stacks * 5}`);\n    }\n}"
                        },
                        {
                            "label": "移除残气与击杀回怒",
                            "trigger": "hit",
                            "active": true,
                            "script": "const effect = args.target.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"canqi\");\nif (effect) {\n    await effect.delete();\n    ui.notifications.info(\"已吞噬目标身上的残气。\");\n}\n\nif (args.isDead) {\n    await actor.update({ \"system.resources.rage.value\": actor.system.resources.rage.value + 2 });\n    ui.notifications.info(\"击杀敌人，怒气+2\");\n}"
                        }
                    ],
                    "automationNote": "选中目标时可预览吞噬加成。击杀回怒和移除残气自动。"
                }
            ]
        },
        "effects": [
            {
                "name": "残气",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "transfer": false,
                "description": "命中-2，闪避-2",
                "changes": [
                    {
                        "key": "system.combat.hit_waigong",
                        "mode": 2,
                        "value": "-2"
                    },
                    {
                        "key": "system.combat.hit_neigong",
                        "mode": 2,
                        "value": "-2"
                    },
                    {
                        "key": "system.combat.dodge",
                        "mode": 2,
                        "value": "-2"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "stackable": true,
                        "maxStacks": 5,
                        "slug": "canqi"
                    }
                }
            }
        ]
    },
    {
        "name": "刃下心",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "<p>枫桦院独创凝气刀法，以气驭刀，匪夷所思，外人便是学了，也难发挥效果。</p><p>需求：刀-单刀，静院 属性：太极</p>",
            "requirements": "单刀",
            "moves": [
                {
                    "name": "流光息语",
                    "type": "qi",
                    "actionType": "default",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "none",
                    "element": "taiji",
                    "weaponType": "blade",
                    "description": "<p>自身必须装备“枫桦戒”方能施展此招。</p><p>主要动作，聚气于枫桦戒，化气为刃，自身获得“气刃”，持续到战斗脱离。</p><p>气刃：一柄虚无气刃，凝化于掌中，其武器类型为单刀，伤害格挡特效参照当前装备的枫桦戒效果。</p><p>·手持气刃时，移动速度+2。</p><p>升级：释放动作降低一级（主要-次要-简要）。</p>",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            5,
                            5,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气刃状态",
                            "trigger": "attack",
                            "active": true,
                            "script": "const ring = actor.items.find(i => i.name.includes(\"枫桦戒\") && i.system.equipped);\nif (!ring) return ui.notifications.warn(\"未装备枫桦戒！\");\n\nconst effectData = thisItem.effects.getName(\"气刃\").toObject();\neffectData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effectData);\n\n// 瞬发处理\nargs.flags.autoApplied = true;\nui.notifications.info(\"已化气为刃 (移动速度+2)。请手动创建临时武器以体现武器属性。\");"
                        }
                    ],
                    "automationNote": "检测戒指并赋予速度Buff。武器替换需手动。"
                },
                {
                    "name": "反客为主",
                    "type": "stance",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "blade",
                    "description": "<p>次要动作，刀刃护身，开启架招。格挡成功时，给对方添加一层“失准”，持续到战斗脱离。</p><p>失准：每层使你的命中-5。</p><p>·若自身具有“气刃”，可移除气刃，为目标额外添加一层“失准”，持续到战斗脱离。</p><p>升级：格挡值+10，内力消耗+2。</p>",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "格挡反制",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.outcome.isHit && !args.config.ignoreStance && Macros.checkStance(actor, args)) {\n    let stacks = 1;\n    const qiren = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qiren\");\n    if (qiren) {\n        await qiren.delete();\n        stacks = 2;\n        ui.notifications.info(\"消耗气刃，额外施加失准！\");\n    }\n\n    // 循环叠加系统状态\n    for(let i=0; i<stacks; i++) {\n        await game.xjzl.api.effects.addEffect(args.attacker, \"shizhun\");\n    }\n}"
                        }
                    ],
                    "automationNote": "受击反制添加失准，自动检测并消耗气刃加层。"
                },
                {
                    "name": "玄天引地",
                    "type": "real",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "blade",
                    "description": "<p>主要动作，逆转刀刃，上挑斩敌，造成 0.5 内息点内功伤害，若对方无架招，将其击飞 1 米。</p><p>若有敌人处于半空中，可消耗反应动作释放此招，凌空跃起，向下劈斩，造成伤害并击倒目标。</p><p>·若自身具有“气刃”，招式伤害+10。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "2",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气刃加成",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qiren\")) {\n    output.damage += 10;\n    output.bonusDesc.push(\"气刃加成: +10\");\n}"
                        },
                        {
                            "label": "击倒判定",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    if (!args.target.system.martial.stanceActive) {\n        ui.notifications.info(`${args.target.name} 被击飞 1 米(手动移动)。`);\n    }\n    if (args.isManual) {\n         await game.xjzl.api.effects.addEffect(args.target, \"prone\");\n         ui.notifications.info(\"判定为追击半空敌人，目标被击倒。\");\n    }\n}"
                        }
                    ],
                    "automationNote": "气刃伤害自动。击飞/击倒需手动（手动应用伤害可强制击倒）。"
                },
                {
                    "name": "风卷残云",
                    "type": "real",
                    "isUltimate": true,
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "blade",
                    "description": "<p>主要动作，迅雷之势突刺目标造成 0.7 内息点内功伤害，若敌人因此招而亡，你获得一个次要动作。</p><p>·若自身具有“气刃”，可移除气刃，寸寸碎裂化为尖刺，使招式目标变为周围敌人，且本场战斗中你每闪避一次，招式伤害+10（至多 30）。</p><p>升级：招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "range": "2",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "移除气刃与击杀",
                            "trigger": "hit",
                            "active": true,
                            "script": "const qiren = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qiren\");\nif (qiren) {\n    await qiren.delete();\n    ui.notifications.info(\"气刃碎裂！请手动对周围敌人应用伤害。\");\n}\nif (args.isDead) {\n    ui.notifications.info(\"击杀敌人，获得一个次要动作！\");\n}"
                        }
                    ],
                    "automationNote": "闪避增伤请手动在弹窗中增加数值。AOE需手动选目标多次应用。"
                }
            ]
        },
        "effects": [
            {
                "name": "气刃",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "transfer": false,
                "description": "移动速度+2",
                "changes": [
                    {
                        "key": "system.combat.speed",
                        "mode": 2,
                        "value": "2"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "qiren"
                    }
                }
            }
        ]
    },
    {
        "name": "尘中人",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "<p>枫桦院弟子常以此功御敌，全因彻悟红尘，不愿多造纠葛，亦是劝敌人莫争、莫怒、莫执着。</p><p>需求：棍-短棍，尘院 属性：太极</p>",
            "requirements": "短棍",
            "moves": [
                {
                    "name": "红衰翠减",
                    "type": "qi",
                    "actionType": "default",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "none",
                    "element": "taiji",
                    "weaponType": "staff",
                    "description": "<p>自身必须装备“枫桦戒”方能施展此招。</p><p>主要动作，集气于枫桦戒，化气为枝，自身获得“气枝”，持续到战斗脱离。</p><p>气枝：一根虚无气枝，凝化于掌中，其武器类型为短棍，伤害格挡特效参照当前装备的枫桦戒效果。</p><p>·手持气枝时，招式释放距离+3。</p><p>升级：释放动作降低一级（主要-次要-简要）。</p>",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            5,
                            5,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气枝状态",
                            "trigger": "attack",
                            "active": true,
                            "script": "const ring = actor.items.find(i => i.name.includes(\"枫桦戒\") && i.system.equipped);\nif (!ring) return ui.notifications.warn(\"未装备枫桦戒！\");\nconst effectData = thisItem.effects.getName(\"气枝\").toObject();\neffectData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effectData);\n\n// 瞬发处理\nargs.flags.autoApplied = true;\nui.notifications.info(\"已化气为枝 (距离+3请手动留意)。\");"
                        }
                    ],
                    "automationNote": "赋予状态。距离增加需玩家自行注意。"
                },
                {
                    "name": "红尘滚滚",
                    "type": "real",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "neigong",
                    "element": "taiji",
                    "weaponType": "staff",
                    "description": "<p>主要动作，棍插地面，扫出凡尘，对敌人造成 0.5 内息点内功伤害，并为其添加‘红尘’一回合。</p><p>红尘：回合初，流失等同于自身体魄数值的气血，出招后可消耗反应动作再释放一次同样招式。</p><p>·若自身具有“气枝”，额外添加一回合红尘。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "施加红尘",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    let rounds = 1;\n    if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qizhi\")) rounds = 2;\n\n    const effectData = thisItem.effects.getName(\"红尘\").toObject();\n    effectData.origin = thisItem.uuid;\n    effectData.duration = { rounds: rounds };\n    \n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ],
                    "automationNote": "命中施加红尘，回合初自动扣血。气枝增加持续时间已处理。"
                },
                {
                    "name": "梦破清晓",
                    "type": "feint",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "neigong",
                    "element": "taiji",
                    "weaponType": "staff",
                    "description": "<p>主要动作，吆声清唱，提棍落打，对敌人造成 0.4 内息点内功伤害，击中无架招目标时，为其添加“断尘”，持续三回合。</p><p>断尘：你每回合只能出招一次。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "baseFeint": 0,
                    "scripts": [
                        {
                            "label": "施加断尘",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effectData = thisItem.effects.getName(\"断尘\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n    ui.notifications.info(\"目标陷入断尘。\");\n}"
                        }
                    ],
                    "automationNote": "无架招命中施加状态。状态效果需玩家自觉遵守。"
                },
                {
                    "name": "觉来无知",
                    "type": "real",
                    "isUltimate": true,
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "neigong",
                    "element": "taiji",
                    "weaponType": "staff",
                    "description": "<p>-尘中人自老，天际月常明-</p><p>主要动作，轻喝敌方，舞棍摆击，对其造成 0.7 内息点内功伤害，若他同时具有“断尘”“红尘”，为其添加“走火入魔”一回合。</p><p>·若自身具有“气枝”，可移除气枝，为自身添加“红尘”，持续两回合。</p><p>升级：招式伤害+20，怒气消耗-1，内力消耗+4。</p>",
                    "range": "2",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "走火入魔与自身红尘",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const hasDuan = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"duanchen\");\n    const hasHong = args.target.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"hongchen\");\n    if (hasDuan && hasHong) {\n        await game.xjzl.api.effects.addEffect(args.target, \"rage\");\n        ui.notifications.info(`${args.target.name} 走火入魔！`);\n    }\n}\n\nconst qizhi = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qizhi\");\nif (qizhi) {\n    await qizhi.delete();\n    // 给自己加红尘\n    const effectData = thisItem.effects.getName(\"红尘\").toObject();\n    effectData.origin = thisItem.uuid;\n    effectData.duration = { rounds: 2 };\n    await game.xjzl.api.effects.addEffect(actor, effectData);\n    ui.notifications.info(\"气枝化为红尘缠身。\");\n}"
                        }
                    ],
                    "automationNote": "条件检测施加走火入魔，以及自身的红尘转化。"
                }
            ]
        },
        "effects": [
            {
                "name": "气枝",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "transfer": false,
                "description": "距离+3",
                "flags": {
                    "xjzl-system": {
                        "slug": "qizhi"
                    }
                }
            },
            {
                "name": "红尘",
                "icon": "icons/svg/sand.svg",
                "transfer": false,
                "description": "回合初流失等同于体魄的气血",
                "flags": {
                    "xjzl-system": {
                        "slug": "hongchen",
                        "scripts": [
                            {
                                "label": "红尘流失",
                                "trigger": "turnStart",
                                "active": true,
                                "script": "const dmg = actor.system.stats.tipo.total || 0; await actor.applyDamage({ amount: dmg, type: 'liushi', isHit: true });"
                            }
                        ]
                    }
                }
            },
            {
                "name": "断尘",
                "icon": "icons/svg/silenced.svg",
                "transfer": false,
                "description": "每回合只能出招一次",
                "flags": {
                    "xjzl-system": {
                        "slug": "duanchen"
                    }
                }
            }
        ]
    },
    {
        "name": "曲中意",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "<p>此功以音鉴真，以韵显性，以律明理，便是不通音律者，亦会感同身受，潸然泪下。</p><p>需求：乐器-箫笛，尘院 属性：太极</p>",
            "requirements": "乐器",
            "moves": [
                {
                    "name": "品箫弄笛",
                    "type": "qi",
                    "actionType": "default",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "none",
                    "element": "taiji",
                    "weaponType": "instrument",
                    "description": "<p>自身必须装备“枫桦戒”方能施展此招。</p><p>主要动作，注气于枫桦戒，化气为箫，自身获得“气箫”，持续到战斗脱离。</p><p>气箫：一支虚无气箫，凝化于掌中，其武器类型为箫，伤害格挡特效参照当前装备的枫桦戒效果。</p><p>·手持气箫时[演奏]等级+2。</p><p>升级：释放动作降低一级（主要-次要-简要）。</p>",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            5,
                            5,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气箫状态",
                            "trigger": "attack",
                            "active": true,
                            "script": "const ring = actor.items.find(i => i.name.includes(\"枫桦戒\") && i.system.equipped);\nif (!ring) return ui.notifications.warn(\"未装备枫桦戒！\");\nconst effectData = thisItem.effects.getName(\"气箫\").toObject();\neffectData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effectData);\n\n// 瞬发处理\nargs.flags.autoApplied = true;\nui.notifications.info(\"已化气为箫 (演奏+2)。\");"
                        }
                    ],
                    "automationNote": "赋予演奏加成。武器属性需手动处理。"
                },
                {
                    "name": "曲高和寡",
                    "type": "stance",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "instrument",
                    "description": "<p>次要动作，吹奏高深曲调，开启架招。格挡成功时，若目标的[演奏]等级低于 2，则陷入“耳鸣”，持续一回合。</p><p>·若目标因此招陷入耳鸣时自身具有“气箫”，可不消耗动作施展【知音难觅】，然后移除气箫。</p><p>升级：格挡值+10，需求的演奏等级+1，消耗+2。</p>",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "格挡反制",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.outcome.isHit && !args.config.ignoreStance && Macros.checkStance(actor, args)) {\n    const yanzou = args.attacker.system.arts?.yanzou?.total || 0;\n    if (yanzou < 2) {\n        await game.xjzl.api.effects.addEffect(args.attacker, \"deaf\");\n        ui.notifications.info(`${args.attacker.name} 演奏造诣不足，陷入耳鸣。`);\n        \n        // 追击判定\n        const qixiao = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qixiao\");\n        if (qixiao) {\n            ui.notifications.info(\"触发追击！请手动无消耗施展【知音难觅】。\");\n            await qixiao.delete();\n        }\n    }\n}"
                        }
                    ],
                    "automationNote": "自动检测对方演奏等级施加耳鸣。追击需手动点击。"
                },
                {
                    "name": "知音难觅",
                    "type": "feint",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "instrument",
                    "description": "<p>主要动作，音何所谓，孤傲不群，对目标造成 0.4 内息点内功伤害，命中无架招目标时，为目标添加“惭愧”，持续一回合。</p><p>惭愧：无法以状态添加者为攻击目标。</p><p>·若自身具有“气箫”，招式伤害+10。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "5",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "baseFeint": 0,
                    "scripts": [
                        {
                            "label": "气箫加伤",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qixiao\")) {\n    output.damage += 10;\n    output.bonusDesc.push(\"气箫加成: +10\");\n}"
                        },
                        {
                            "label": "施加惭愧",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    const effectData = thisItem.effects.getName(\"惭愧\").toObject();\n    effectData.origin = thisItem.uuid;\n    effectData.description = `无法攻击 ${actor.name}`;\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ],
                    "automationNote": "伤害修正和状态施加均已自动。"
                },
                {
                    "name": "曲终人散",
                    "type": "real",
                    "isUltimate": true,
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "instrument",
                    "description": "<p>-初闻不知曲中意，再闻已是曲中人-</p><p>蓄力动作，一曲演罢，宾客皆散，对周围敌人造成 0.7 内息点内功伤害。</p><p>·若自身具有“气箫”，可与命中目标进行[演奏]对抗，若对方失败还会陷入“封招”持续一回合。</p><p>升级：招式伤害+20，怒气消耗-1，内力消耗+8。</p>",
                    "range": "10",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "演奏对抗封招",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qixiao\")) {\n    const myArt = actor.system.arts.yanzou.total || 0;\n    ui.notifications.info(`请手动进行演奏对抗 (我方演奏: ${myArt})。若对方失败，请手动施加封招。`);\n}"
                        }
                    ],
                    "automationNote": "提示手动对抗。"
                }
            ]
        },
        "effects": [
            {
                "name": "气箫",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "transfer": false,
                "description": "演奏+2",
                "changes": [
                    {
                        "key": "system.arts.yanzou.mod",
                        "mode": 2,
                        "value": "2"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "qixiao"
                    }
                }
            },
            {
                "name": "惭愧",
                "icon": "icons/svg/daze.svg",
                "transfer": false,
                "description": "无法攻击施法者",
                "flags": {
                    "xjzl-system": {
                        "slug": "cankui"
                    }
                }
            }
        ]
    },
    {
        "name": "身之寸",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "<p>枫桦院绝技，飘逸轻盈，辗转腾挪间制服敌人，加之独特的凝气弓弦，实在让人防不胜防。</p><p>需求：奇门-弓，静院 属性：太极</p>",
            "requirements": "弓",
            "moves": [
                {
                    "name": "若隐若现",
                    "type": "qi",
                    "actionType": "default",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "none",
                    "element": "taiji",
                    "weaponType": "bow",
                    "description": "<p>自身必须装备“枫桦戒”方能施展此招。</p><p>主要动作，凝气于枫桦戒，化气为弓，自身获得“气弓”，持续到战斗脱离。</p><p>气弓：一把虚无弓弦，凝化于掌中，其武器类型为弓，伤害格挡特效参照当前装备的枫桦戒效果。</p><p>·手持气弓时闪避+4。</p><p>升级：释放动作降低一级（主要-次要-简要）。</p>",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            5,
                            5,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气弓状态",
                            "trigger": "attack",
                            "active": true,
                            "script": "const ring = actor.items.find(i => i.name.includes(\"枫桦戒\") && i.system.equipped);\nif (!ring) return ui.notifications.warn(\"未装备枫桦戒！\");\nconst effectData = thisItem.effects.getName(\"气弓\").toObject();\neffectData.origin = thisItem.uuid;\nawait game.xjzl.api.effects.addEffect(actor, effectData);\n\n// 瞬发处理\nargs.flags.autoApplied = true;\nui.notifications.info(\"已化气为弓 (闪避+4)。\");"
                        }
                    ],
                    "automationNote": "闪避加成已处理。"
                },
                {
                    "name": "漫天飞羽",
                    "type": "real",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "bow",
                    "description": "<p>当闪避攻击时，可消耗反应动作释放，腾空跃起（处于半空），散射飞矢，对范围内空格及其周围 2 米内所有敌方造成 0.4 身法点内功伤害。</p><p>·若自身具有“气弓”，可移除气弓，为命中目标添加“禁足”，持续一回合。</p><p>升级：招式伤害+10，内力消耗+4。</p>",
                    "range": "5",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气弓禁足",
                            "trigger": "hit",
                            "active": true,
                            "script": "const qigong = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\");\nif (qigong && args.isHit) {\n    await game.xjzl.api.effects.addEffect(args.target, \"root\");\n    ui.notifications.info(`${args.target.name} 被禁足。`);\n}"
                        },
                        {
                            "label": "移除气弓",
                            "trigger": "hit_once",
                            "active": true,
                            "script": "const qigong = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\");\nif (qigong && args.hitCount > 0) {\n    await qigong.delete();\n    ui.notifications.info(\"气弓已消耗。\");\n}"
                        }
                    ],
                    "automationNote": "禁足和消耗气弓已处理。闪避触发条件需玩家自行把握。"
                },
                {
                    "name": "秋风送寒",
                    "type": "feint",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "bow",
                    "description": "<p>主要动作，轻盈之气，佯射目标，造成 0.4 身法点内功伤害，击破架招时，使目标陷入“下盘不稳”，持续三回合。</p><p>·若自身具有“气弓”，可移除气弓使虚招值+1。</p><p>升级：招式伤害+10，虚招值再+1，内力消耗+2。</p>",
                    "range": "8",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "baseFeint": 0,
                    "scripts": [
                        {
                            "label": "气弓加成",
                            "trigger": "calc",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\")) {\n    output.feint += 1;\n    output.bonusDesc.push(\"气弓加成: 虚招+1\");\n}"
                        },
                        {
                            "label": "击破特效与移除气弓",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isBroken) {\n    await game.xjzl.api.effects.addEffect(args.target, \"unstable\");\n    ui.notifications.info(\"目标下盘不稳。\");\n}\nconst qigong = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\");\nif (qigong) {\n    await qigong.delete();\n    ui.notifications.info(\"气弓已消耗。\");\n}"
                        }
                    ],
                    "automationNote": "加成、状态、消耗均已自动。"
                },
                {
                    "name": "穿龙贯凤",
                    "type": "real",
                    "isUltimate": true,
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "bow",
                    "description": "<p>蓄力动作，调息开步拉弓，射出贯穿气箭，对直线路径上所有敌方造成 0.7 身法点内功伤害，并为他们添加“缚身”，持续一回合。</p><p>·若自身具有“气弓”，招式暴击骰-1，且缚身的持续回合数变为三回合。</p><p>升级：招式伤害+20，暴击骰再-1，怒气消耗-1，内力消耗+8。</p>",
                    "range": "10",
                    "costs": {
                        "mp": [
                            8,
                            16,
                            24
                        ],
                        "rage": [
                            5,
                            4,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 20,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.7
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "气弓暴击修正",
                            "trigger": "attack",
                            "active": true,
                            "script": "if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\")) {\n    args.flags.critThresholdMod += 1;\n    ui.notifications.info(\"气弓修正: 暴击门槛-1\");\n}"
                        },
                        {
                            "label": "施加缚身",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    let rounds = 1;\n    if (actor.effects.some(e => e.getFlag(\"xjzl-system\", \"slug\") === \"qigong\")) rounds = 3;\n    \n    const effectData = foundry.utils.deepClone(CONFIG.statusEffects.find(e => e.id === \"fushen\"));\n    effectData.duration = { rounds: rounds };\n    await game.xjzl.api.effects.addEffect(args.target, effectData);\n}"
                        }
                    ],
                    "automationNote": "暴击修正和加强版缚身均已处理。"
                }
            ]
        },
        "effects": [
            {
                "name": "气弓",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "transfer": false,
                "description": "闪避+4",
                "changes": [
                    {
                        "key": "system.combat.dodge",
                        "mode": 2,
                        "value": "4"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "qigong"
                    }
                }
            }
        ]
    },
    {
        "name": "心之吾",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "wuxue",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "<p>情思难测，爱恨交织，悟透方得此功。</p><p>需求：徒手，尘院 属性：太极</p>",
            "requirements": "徒手",
            "moves": [
                {
                    "name": "喜怒哀乐",
                    "type": "stance",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>次要动作，心情跌宕，却不露声色，格挡成功后自身获得“悟情”，持续一回合或解除架招。</p><p>悟情：在你的每个回合初，可以改变自身性格，在持续结束后，恢复原性格。</p><p>·你不会因本招式而改变原性格给予的技能加成。</p><p>升级：格挡值+10，额外持续一回合，消耗+2。</p>",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10
                    },
                    "scripts": [
                        {
                            "label": "格挡悟情",
                            "trigger": "damaged",
                            "active": true,
                            "script": "if (args.outcome.isHit && !args.config.ignoreStance && Macros.checkStance(actor, args)) {\n    const effectData = thisItem.effects.getName(\"悟情\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effectData);\n}"
                        }
                    ],
                    "automationNote": "格挡获得状态。改性格需玩家手动操作或Roleplay。"
                },
                {
                    "name": "悲欢离合",
                    "type": "real",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>主要动作，十指击额，对目标造成 0.5 内息点内功伤害，然后你可以得知目标的具体性格。</p><p>·若你的性格与目标相同，目标受到伤害后还会大喜大悲，怒气-1 且陷入“迟滞”，持续一回合。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "1",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.5
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "性格判定",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit) {\n    const targetP = args.target.system.info?.personality || \"无\";\n    const myP = actor.system.info?.personality || \"无\";\n    ui.notifications.info(`目标性格: ${targetP}`);\n    \n    if (targetP === myP && targetP !== \"\") {\n        await game.xjzl.api.effects.addEffect(args.target, \"chizhi\");\n        await args.target.update({ \"system.resources.rage.value\": Math.max(0, args.target.system.resources.rage.value - 1) });\n        ui.notifications.info(\"性格共鸣！目标怒气-1，迟滞。\");\n    }\n}"
                        }
                    ],
                    "automationNote": "自动比对性格字段并应用效果。"
                },
                {
                    "name": "酸甜苦辣",
                    "type": "counter",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>当你看破对方虚招时，可消耗反应动作使用此招，压制虚招，拳脚相加，造成 0.6 内息点内功伤害。</p><p>若你的性格与目标相同，你可以选择一个该性格加成的属性技能与对方进行对抗检定，若你获胜，对方受到他的这项属性技能等级*10 的气血流失。</p><p>升级：招式伤害+10，内力消耗+2。</p>",
                    "range": "2",
                    "costs": {
                        "mp": [
                            2,
                            4,
                            6
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 10,
                        "scalings": [
                            {
                                "prop": "neixi",
                                "ratio": 0.6
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "性格对抗",
                            "trigger": "hit",
                            "active": true,
                            "script": "const targetP = args.target.system.info?.personality || \"\";\nconst myP = actor.system.info?.personality || \"\";\nif (args.isHit && targetP === myP && targetP !== \"\") {\n    ui.notifications.info(\"性格相同！请手动发起属性对抗，若获胜请手动应用流失伤害 (技能等级*10)。\");\n}"
                        }
                    ],
                    "automationNote": "性格提示自动，对抗和流失需手动处理。"
                },
                {
                    "name": "幡然悔悟",
                    "type": "qi",
                    "actionType": "default",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "none",
                    "element": "taiji",
                    "weaponType": "unarmed",
                    "description": "<p>次要动作，大彻大悟，获得“悟情”持续到脱战。</p><p>·若自身已有“悟情”，方知真谛，以前所为，白日做梦尔，移除悟情，获得“悟”，持续到脱战。</p><p>悟：你的悟性+5（至多 30），同时你的招式命中和伤害获得等同于自身悟性的加值。</p><p>升级：提供悟性+5，怒气消耗-1，内力消耗+4。</p>",
                    "range": "自身",
                    "costs": {
                        "mp": [
                            4,
                            8,
                            12
                        ],
                        "rage": [
                            7,
                            6,
                            5
                        ]
                    },
                    "scripts": [
                        {
                            "label": "顿悟状态切换",
                            "trigger": "attack",
                            "active": true,
                            "script": "const wuqing = actor.effects.find(e => e.getFlag(\"xjzl-system\", \"slug\") === \"wuqing\");\nif (wuqing) {\n    await wuqing.delete();\n    const wuEffect = thisItem.effects.getName(\"悟\").toObject();\n    wuEffect.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, wuEffect);\n    ui.notifications.info(\"顿悟！获得【悟】状态。\");\n} else {\n    const effectData = thisItem.effects.getName(\"悟情\").toObject();\n    effectData.origin = thisItem.uuid;\n    await game.xjzl.api.effects.addEffect(actor, effectData);\n}\n\n// 瞬发处理\nargs.flags.autoApplied = true;"
                        }
                    ],
                    "automationNote": "状态切换及悟性带来的动态加成均已实现。"
                }
            ]
        },
        "effects": [
            {
                "name": "悟情",
                "icon": "icons/svg/heart.svg",
                "transfer": false,
                "description": "回合初可临时改变性格",
                "flags": {
                    "xjzl-system": {
                        "slug": "wuqing"
                    }
                }
            },
            {
                "name": "悟",
                "icon": "icons/svg/sun.svg",
                "transfer": false,
                "description": "悟性+5，招式命中和伤害获得悟性加值",
                "changes": [
                    {
                        "key": "system.stats.wuxing.mod",
                        "mode": 2,
                        "value": "5"
                    }
                ],
                "flags": {
                    "xjzl-system": {
                        "slug": "wu",
                        "scripts": [
                            {
                                "label": "悟性加持伤害",
                                "trigger": "calc",
                                "active": true,
                                "script": "const wuxing = actor.system.stats.wuxing.total || 0; output.damage += wuxing; output.bonusDesc.push(`悟(+${wuxing})`);"
                            },
                            {
                                "label": "悟性加持命中",
                                "trigger": "attack",
                                "active": true,
                                "script": "args.flags.bonusHit += actor.system.stats.wuxing.total || 0;"
                            }
                        ]
                    }
                }
            }
        ]
    },
    {
        "name": "飞花摘叶",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "sanshou",
            "sect": "fenghuayuan",
            "tier": 1,
            "description": "<p>枫桦院弟子以真气催发事物贯通伤人，克敌制胜。因山中遍植枫桦，常以落叶为暗器而得名。</p><p>需求：暗器 属性：太极</p>",
            "requirements": "暗器",
            "moves": [
                {
                    "name": "飞花摘叶",
                    "type": "real",
                    "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                    "damageType": "waigong",
                    "element": "taiji",
                    "weaponType": "hidden",
                    "description": "<p>消耗：1，暗器*1</p><p>主要动作，拂手飞掷，对目标造成 0.4 身法点内功伤害，若目标无架招，为其添加一层“流血”，持续到战斗脱离。</p><p>·若你掷出的是随手捡到的叶片（伤害 0），招式释放距离翻倍，且暴击骰-1。</p><p>升级：伤害+5，叶片暴击骰再-1，内力消耗+1。</p>",
                    "range": "5",
                    "costs": {
                        "mp": [
                            1,
                            2,
                            3
                        ]
                    },
                    "calculation": {
                        "base": 0,
                        "growth": 5,
                        "scalings": [
                            {
                                "prop": "shenfa",
                                "ratio": 0.4
                            }
                        ]
                    },
                    "scripts": [
                        {
                            "label": "叶片加成",
                            "trigger": "attack",
                            "active": true,
                            "script": "const weapon = actor.itemTypes.weapon.find(w => w.system.equipped && w.system.type === \"hidden\");\nif (weapon && weapon.system.damage === 0) {\n    args.flags.critThresholdMod += 1;\n    ui.notifications.info(\"叶片攻击：暴击门槛-1，距离翻倍(请自行确认距离)\");\n}"
                        },
                        {
                            "label": "流血",
                            "trigger": "hit",
                            "active": true,
                            "script": "if (args.isHit && !args.target.system.martial.stanceActive) {\n    await game.xjzl.api.effects.addEffect(args.target, \"bleed_stack\");\n}"
                        }
                    ],
                    "automationNote": "检测0伤武器触发暴击修正。暗器消耗需手动。"
                }
            ]
        }
    },
    {
        "name": "百业俱兴",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "sanshou",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "自明祖定国以来，边疆安定，国富民安，百姓从事各行各业，空前繁荣。",
            "requirements": "《浮沉功》修炼圆满",
            "moves": [
                {
                    "name": "百业俱兴",
                    "type": "qi",
                    "actionType": "default",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "automationNote": "完全自动化：技艺检定加成已实现（被动生效）。需手动：阅读书籍额外修为需玩家手动调整。",
                    "description": "·你的技艺检定结果+1。<br>你选择一本技艺书籍，阅读该书籍时，每月额外增长 100 修为进度。通读完成可更换其他书籍。<br>升级：技艺检定结果再+1，每月修为进度再+100。",
                    "progression": {
                        "mode": "standard"
                    },
                    "scripts": [
                        {
                            "label": "百业俱兴-被动加值",
                            "trigger": "passive",
                            "active": true,
                            "script": "const moveData = args.move;\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst bonus = lvl;\nconst artKeys = Object.keys(CONFIG.XJZL.arts);\nfor (const key of artKeys) {\n    if (system.arts && system.arts[key]) {\n        system.arts[key].checkMod = (system.arts[key].checkMod || 0) + bonus;\n    }\n}"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "所见所闻",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "sanshou",
            "sect": "fenghuayuan",
            "tier": 2,
            "description": "枫桦院弟子观深山雾海所得，知所见所闻所相者，皆如云气般虚无缥缈，不可得。",
            "requirements": "《彤气蝶影》修炼圆满",
            "moves": [
                {
                    "name": "所见所闻",
                    "type": "qi",
                    "actionType": "default",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "主要动作",
                    "automationNote": "部分自动化：气感技能加成被动生效。闪避挂残气功能需玩家点击招式应用【所见所闻-态】状态后生效。",
                    "description": "你的气感属性技能等级+1。<br>你每次闪避敌方攻击时，为其添加一层“残气”，至多五层，持续到脱战。<br>·残气：每层使你命中-2，闪避-2。<br>升级：气感属性技能等级再+1。",
                    "progression": {
                        "mode": "standard"
                    },
                    "scripts": [
                        {
                            "label": "所见所闻-技能被动",
                            "trigger": "passive",
                            "active": true,
                            "script": "const moveData = args.move;\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst bonus = lvl;\nconst skills = ['dianxue', 'zhuizong', 'tancha', 'dongcha'];\nfor (const sk of skills) {\n    if (system.skills[sk]) {\n        system.skills[sk].mod = (system.skills[sk].mod || 0) + bonus;\n    }\n}"
                        }
                    ]
                }
            ]
        },
        "effects": [
            {
                "name": "所见所闻-态",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "description": "闪避时给攻击者施加残气。",
                "transfer": false,
                "flags": {
                    "xjzl-system": {
                        "slug": "suojiansuowen_buff",
                        "stackable": false,
                        "scripts": [
                            {
                                "label": "所见所闻-闪避触发",
                                "trigger": "avoided",
                                "active": true,
                                "script": "if (!args.attacker) return;\nconst originItem = await fromUuid(thisEffect.origin);\nif (!originItem) return;\nconst sourceEffect = originItem.effects.getName('残气');\nif (!sourceEffect) return ui.notifications.warn('特效模板[残气]缺失');\nconst effectData = sourceEffect.toObject();\ndelete effectData._id;\neffectData.origin = originItem.uuid;\neffectData.disabled = false;\nawait game.xjzl.api.effects.addEffect(args.attacker, effectData);\nif (actor.token?.object) {\n    canvas.interface.createScrollingText(actor.token.object.center, '所见所闻', {\n        fill: '#00FFFF', stroke: '#000000', strokeThickness: 4\n    });\n}"
                            }
                        ]
                    }
                }
            },
            {
                "name": "残气",
                "icon": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
                "description": "每层使你命中-2，闪避-2。",
                "transfer": false,
                "disabled": true,
                "flags": {
                    "xjzl-system": {
                        "slug": "canqi",
                        "stackable": true,
                        "maxStacks": 5
                    }
                },
                "changes": [
                    {
                        "key": "system.combat.hit_waigong",
                        "mode": 2,
                        "value": "-2"
                    },
                    {
                        "key": "system.combat.hit_neigong",
                        "mode": 2,
                        "value": "-2"
                    },
                    {
                        "key": "system.combat.dodge",
                        "mode": 2,
                        "value": "-2"
                    }
                ]
            }
        ]
    },
    {
        "name": "森罗万象",
        "type": "wuxue",
        "img": "systems/xjzl-system/assets/icons/wuxue/枫华.png",
        "system": {
            "category": "sanshou",
            "sect": "fenghuayuan",
            "tier": 3,
            "description": "夫万象森罗，不离两仪所育；百法纷凑，无越三教之境；气深如海，展现万千气象，此妙神之技也。",
            "requirements": "任意一种武器技能的等级达到 8",
            "moves": [
                {
                    "name": "森罗万象",
                    "type": "qi",
                    "actionType": "default",
                    "range": "自身",
                    "targetInfo": "自身",
                    "actionCost": "被动",
                    "automationNote": "部分自动化：着意（被动加上限）已实现。百通（变招换属性）需手动扣除内力并告知GM/对方改变属性。",
                    "description": "着意<br>通过修炼武学，每使一类武器技能等级达到 8 后，你的气血上限和内力上限+10。<br>百通<br>每次施展武器技能等级达到 8 的武学套路招式时，你可以流失 30 点内力，吐气纳新，让本次出招中的伤害属性替换为其他属性。<br>·如果该招式包含多个伤害属性，则无法替换。<br>升级：着意中，气血、内力上限再+10。百通中，流失的内力减少 10 点。",
                    "progression": {
                        "mode": "standard"
                    },
                    "scripts": [
                        {
                            "label": "着意-属性上限加成",
                            "trigger": "passive",
                            "active": true,
                            "script": "const moveData = args.move;\nconst lvl = Math.max(1, moveData?.computedLevel || 1);\nconst bonusPerType = 10 + (lvl - 1) * 10;\nlet count = 0;\nconst ranks = system.combat.weaponRanks || {};\nfor (const key of Object.keys(ranks)) {\n    if (ranks[key].total >= 8) {\n        count++;\n    }\n}\nif (count > 0) {\n    const totalBonus = count * bonusPerType;\n    system.resources.hp.bonus = (system.resources.hp.bonus || 0) + totalBonus;\n    system.resources.mp.bonus = (system.resources.mp.bonus || 0) + totalBonus;\n}"
                        }
                    ]
                }
            ]
        }
    }
]